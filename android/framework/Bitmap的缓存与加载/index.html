<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link href=https://blog.founicy.top/android/framework/Bitmap%E7%9A%84%E7%BC%93%E5%AD%98%E4%B8%8E%E5%8A%A0%E8%BD%BD/ rel=canonical><link rel=icon href=../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.2.3, mkdocs-material-8.1.11"><title>Bitmap的缓存与加载 - wzasd's world</title><link rel=stylesheet href=../../../assets/stylesheets/main.50e68009.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.e6a45f82.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>:root{--md-text-font:"";--md-code-font:"Roboto Mono"}</style><script>__md_scope=new URL("../../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-Q6FXPH6HVX"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&gtag("event","search",{search_term:this.value})}),"undefined"!=typeof location$&&location$.subscribe(function(e){gtag("config","G-Q6FXPH6HVX",{page_path:e.pathname})})})</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-Q6FXPH6HVX"></script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=white data-md-color-accent=blue> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#1-bitmap class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../../.. title="wzasd's world" class="md-header__button md-logo" aria-label="wzasd's world" data-md-component=logo> <img src=../../../assets/images/favicon.webp alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> wzasd's world </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Bitmap的缓存与加载 </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=white data-md-color-accent=blue aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary=black data-md-color-accent=deep-orange aria-label="Switch to light mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3z"/></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../3rd-library/3rd-library-source-code/ class="md-tabs__link md-tabs__link--active"> Android </a> </li> <li class=md-tabs__item> <a href=../../../flutter/flutter_first_project_1/ class=md-tabs__link> Flutter </a> </li> <li class=md-tabs__item> <a href=../../../leetcode/ class=md-tabs__link> LeetCode </a> </li> <li class=md-tabs__item> <a href=../../../design-pattern/design-pattern/ class=md-tabs__link> Books </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../.. title="wzasd's world" class="md-nav__button md-logo" aria-label="wzasd's world" data-md-component=logo> <img src=../../../assets/images/favicon.webp alt=logo> </a> wzasd's world </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1 type=checkbox id=__nav_1 checked> <label class=md-nav__link for=__nav_1> Android <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Android data-md-level=1> <label class=md-nav__title for=__nav_1> <span class="md-nav__icon md-icon"></span> Android </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1_1 type=checkbox id=__nav_1_1> <label class=md-nav__link for=__nav_1_1> 三方库系列 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=三方库系列 data-md-level=2> <label class=md-nav__title for=__nav_1_1> <span class="md-nav__icon md-icon"></span> 三方库系列 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../3rd-library/3rd-library-source-code/ class=md-nav__link> Android三方库源码分析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/matrix/ class=md-nav__link> 微信APM Matrix解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/matrix-trace/ class=md-nav__link> Matrix-TraceCanary解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/matrix-io/ class=md-nav__link> Matrix-IOCanary解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/matrix-resource/ class=md-nav__link> Matrix-ResourceCanary解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/matrix-sqlitelint/ class=md-nav__link> Matrix-SQLiteLint解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/okhttp/ class=md-nav__link> OkHttp3源码解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/retrofit/ class=md-nav__link> Retrofit2源码解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/rxjava%26rxandroid/ class=md-nav__link> RxJava源码解析及使用实例 </a> </li> <li class=md-nav__item> <a href=../../other/RxJava/ class=md-nav__link> RxJava操作符大全 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/glide1/ class=md-nav__link> Glide v4 源码解析（一） </a> </li> <li class=md-nav__item> <a href=../../3rd-library/glide2/ class=md-nav__link> Glide v4 源码解析（二） </a> </li> <li class=md-nav__item> <a href=../../3rd-library/glide3/ class=md-nav__link> Glide v4 源码解析（三） </a> </li> <li class=md-nav__item> <a href=../../3rd-library/glide4/ class=md-nav__link> Glide v4 源码解析（四） </a> </li> <li class=md-nav__item> <a href=../../3rd-library/glide5/ class=md-nav__link> Glide v4 源码解析（五） </a> </li> <li class=md-nav__item> <a href=../../3rd-library/glide6/ class=md-nav__link> Glide v4 源码解析（六） </a> </li> <li class=md-nav__item> <a href=../../3rd-library/glide7/ class=md-nav__link> Glide v4 源码解析（七） </a> </li> <li class=md-nav__item> <a href=../../3rd-library/migrate-to-glide/ class=md-nav__link> 杂记：从Picasso迁移至Glide </a> </li> <li class=md-nav__item> <a href=../../3rd-library/eventbus/ class=md-nav__link> EventBus源码解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/leakcanary/ class=md-nav__link> LeakCanary2源码解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/permissiondispatcher/ class=md-nav__link> PermissionDispatcher源码解析 </a> </li> <li class=md-nav__item> <a href=../../other/constraintlayout/ class=md-nav__link> ConstraintLayout使用大全 </a> </li> <li class=md-nav__item> <a href=../../other/dagger2/ class=md-nav__link> 初学者的Dagger2教程 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/hotfix/ class=md-nav__link> Hotfix方案初探 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1_2 type=checkbox id=__nav_1_2 checked> <label class=md-nav__link for=__nav_1_2> framework系列 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=framework系列 data-md-level=2> <label class=md-nav__title for=__nav_1_2> <span class="md-nav__icon md-icon"></span> framework系列 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../Android%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%281%29/ class=md-nav__link> Activity </a> </li> <li class=md-nav__item> <a href=../Android%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%282%29/ class=md-nav__link> Service </a> </li> <li class=md-nav__item> <a href=../Android%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%283%29/ class=md-nav__link> Broadcasts </a> </li> <li class=md-nav__item> <a href=../Android%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%284%29/ class=md-nav__link> Content Providers与Fragment </a> </li> <li class=md-nav__item> <a href=../IPC%E6%9C%BA%E5%88%B6/ class=md-nav__link> IPC机制 </a> </li> <li class=md-nav__item> <a href=../View%E7%9A%84%E4%BA%8B%E4%BB%B6%E4%BD%93%E7%B3%BB/ class=md-nav__link> View的事件体系 </a> </li> <li class=md-nav__item> <a href=../View%E7%9A%84%E7%BB%98%E5%88%B6%E5%8E%9F%E7%90%86/ class=md-nav__link> View的绘制原理 </a> </li> <li class=md-nav__item> <a href=../RemoteViews/ class=md-nav__link> RemoteViews </a> </li> <li class=md-nav__item> <a href=../Drawable/ class=md-nav__link> Android中的Drawable资源 </a> </li> <li class=md-nav__item> <a href=../Android%E5%8A%A8%E7%94%BB/ class=md-nav__link> Android动画 </a> </li> <li class=md-nav__item> <a href=../Window%E4%B8%8EWindowManager/ class=md-nav__link> Window与WindowManager </a> </li> <li class=md-nav__item> <a href=../%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/ class=md-nav__link> 四大组件启动过程 </a> </li> <li class=md-nav__item> <a href=../Android%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6/ class=md-nav__link> Android消息机制 </a> </li> <li class=md-nav__item> <a href=../Android%E7%BA%BF%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0/ class=md-nav__link> Android线程与线程池 </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Bitmap的缓存与加载 <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> Bitmap的缓存与加载 </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#1-bitmap class=md-nav__link> 1 Bitmap的加载 </a> <nav class=md-nav aria-label="1 Bitmap的加载"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#11 class=md-nav__link> 1.1 采样率压缩 </a> </li> <li class=md-nav__item> <a href=#12 class=md-nav__link> 1.2 封装好的大图片加载类 </a> </li> <li class=md-nav__item> <a href=#13 class=md-nav__link> 1.3 质量压缩 </a> </li> <li class=md-nav__item> <a href=#14 class=md-nav__link> 1.4 尺寸压缩 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#2-bitmap class=md-nav__link> 2 Bitmap的缓存 </a> <nav class=md-nav aria-label="2 Bitmap的缓存"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#21-lrucache class=md-nav__link> 2.1 LruCache </a> </li> <li class=md-nav__item> <a href=#22-disklrucache class=md-nav__link> 2.2 DiskLruCache </a> <nav class=md-nav aria-label="2.2 DiskLruCache"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#221-disklrucache class=md-nav__link> 2.2.1 DiskLruCache的创建 </a> </li> <li class=md-nav__item> <a href=#222-disklrucache class=md-nav__link> 2.2.2 DiskLruCache的写入 </a> </li> <li class=md-nav__item> <a href=#223-disklrucache class=md-nav__link> 2.2.3 DiskLruCache的读取 </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../JNI%E4%B8%8ENDK/ class=md-nav__link> JNI与NDK编程简介 </a> </li> <li class=md-nav__item> <a href=../%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/ class=md-nav__link> Android性能优化 </a> </li> <li class=md-nav__item> <a href=../binder1-mediaservice/ class=md-nav__link> Binder深入理解——以MediaService为例 </a> </li> <li class=md-nav__item> <a href=../binder2/ class=md-nav__link> Binder深入理解——罗老师系列 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1_3 type=checkbox id=__nav_1_3> <label class=md-nav__link for=__nav_1_3> 杂记 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=杂记 data-md-level=2> <label class=md-nav__title for=__nav_1_3> <span class="md-nav__icon md-icon"></span> 杂记 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../other/android-ipc-big-data/ class=md-nav__link> Ashmem简介（Android IPC传输大数据） </a> </li> <li class=md-nav__item> <a href=../../other/LocalSocket%EF%BC%8CSocket%20Websocket%20Http%2CP2P%E7%AD%89%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%28%E6%AD%A5%E9%AA%A4%29%EF%BC%88Demo%EF%BC%89/ class=md-nav__link> LocalSocket，Socket Websocket Http,P2P等网络编程(步骤)（Demo） </a> </li> <li class=md-nav__item> <a href=../../other/commands/ class=md-nav__link> Android开发常见命令 </a> </li> <li class=md-nav__item> <a href=../../other/android-tv/ class=md-nav__link> Android TV 专项 </a> </li> <li class=md-nav__item> <a href=../../other/annotation/ class=md-nav__link> 注解的定义及解析 </a> </li> <li class=md-nav__item> <a href=../../other/best_throttle_in_mvvm/ class=md-nav__link> 这可能是MVVM中最优雅的按键防抖方案 </a> </li> <li class=md-nav__item> <a href=../../other/android-jenkins/ class=md-nav__link> Jenkins for android </a> </li> <li class=md-nav__item> <a href=../../other/SystemProrities/ class=md-nav__link> 普通Android程序使用SystemProrities </a> </li> <li class=md-nav__item> <a href=../../other/recyclerview-cache/ class=md-nav__link> ListView、RecyclerView缓存策略解析 </a> </li> <li class=md-nav__item> <a href=../../other/recyclerview-item-docoration/ class=md-nav__link> RecyclerView高级特性——ItemDecoration </a> </li> <li class=md-nav__item> <a href=../../other/recyclerview-others/ class=md-nav__link> RecyclerView的一些使用细节 </a> </li> <li class=md-nav__item> <a href=../../other/RecyclerView-Sort%26Delete/ class=md-nav__link> RecyclerView高级特性——拖拽排序以及滑动删除 </a> </li> <li class=md-nav__item> <a href=../../other/FAB-Behavior/ class=md-nav__link> FloatingActionButton上滑隐藏下滑显示 </a> </li> <li class=md-nav__item> <a href=../../other/nestedscrolling/ class=md-nav__link> NestedScrolling机制 </a> </li> <li class=md-nav__item> <a href=../../other/porterduff/ class=md-nav__link> 使用Porter-Duff合成数字图像 </a> </li> <li class=md-nav__item> <a href=../../other/runtime/ class=md-nav__link> Android Runtime </a> </li> <li class=md-nav__item> <a href=../../other/android_alias/ class=md-nav__link> Android马甲包的那些事儿 </a> </li> <li class=md-nav__item> <a href=../../other/Android-Development-Tool/ class=md-nav__link> Android神兵利器 </a> </li> <li class=md-nav__item> <a href=../../other/FileProvider/ class=md-nav__link> FileProvider </a> </li> <li class=md-nav__item> <a href=../../other/Android%E5%88%A4%E6%96%AD%E5%AF%BC%E8%88%AA%E6%A0%8F%E9%AB%98%E5%BA%A6/ class=md-nav__link> Android判断虚拟按键(导航栏)显示与否、高度以及获取屏幕实际高度 </a> </li> <li class=md-nav__item> <a href=../../other/Android%E5%9B%BE%E7%89%87%E9%80%89%E6%8B%A9%E5%99%A8/ class=md-nav__link> Android图片选择器 </a> </li> <li class=md-nav__item> <a href=../../other/Android%E5%BA%95%E9%83%A8%E5%AF%BC%E8%88%AA%E6%A0%8F%E6%A1%86%E6%9E%B6/ class=md-nav__link> Android原生底部导航栏 </a> </li> <li class=md-nav__item> <a href=../../other/Android%E6%90%9C%E7%B4%A2%E6%A0%8F%E7%9A%84%E5%AE%9E%E7%8E%B0/ class=md-nav__link> Android搜索栏的实现 </a> </li> <li class=md-nav__item> <a href=../../other/Android%E6%9A%82%E5%81%9C%E9%9F%B3%E4%B9%90%E6%92%AD%E6%94%BE%E5%99%A8%E7%9A%84%E6%92%AD%E6%94%BE/ class=md-nav__link> Android暂停酷狗、网易云音乐等音乐播放器的播放 </a> </li> <li class=md-nav__item> <a href=../../other/Android%E6%BB%91%E5%8A%A8%E8%BF%94%E5%9B%9E%E5%AE%9E%E8%B7%B5/ class=md-nav__link> Android滑动返回实践 </a> </li> <li class=md-nav__item> <a href=../../other/Android%E7%A8%8B%E5%BA%8F%E5%8F%8D%E7%BC%96%E8%AF%91/ class=md-nav__link> MacOS下Android程序反编译 </a> </li> <li class=md-nav__item> <a href=../../other/Android%E9%80%9A%E8%AE%AF%E5%BD%95%E5%BF%AB%E9%80%9F%E8%AF%BB%E5%8F%96/ class=md-nav__link> Android通讯录快速读取 </a> </li> <li class=md-nav__item> <a href=../../other/soft-keyboard-in-app/ class=md-nav__link> App内自定义软键盘 </a> </li> <li class=md-nav__item> <a href=../../other/%E8%85%BE%E8%AE%AFX5%E5%86%85%E6%A0%B8%E5%85%A5%E5%9D%91%E6%8C%87%E5%8D%97/ class=md-nav__link> 腾讯TBS X5浏览器内核入坑指南 </a> </li> <li class=md-nav__item> <a href=../../other/%E7%90%90%E7%A2%8E%E7%9F%A5%E8%AF%86%E7%82%B9/ class=md-nav__link> 琐碎知识点 </a> </li> <li class=md-nav__item> <a href=../../other/%E7%90%90%E7%A2%8E%E7%9F%A5%E8%AF%86%E7%82%B92/ class=md-nav__link> 琐碎知识点2 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week1-synchronized/ class=md-nav__link> 理解Java中synchronized关键词 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week2-service/ class=md-nav__link> 理解Service </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week3-activity/ class=md-nav__link> 理解Activity的启动模式 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week4-startActivityForResult/ class=md-nav__link> 关于startActivityForResult </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week5-view/ class=md-nav__link> 关于View的知识 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week6-gradle/ class=md-nav__link> 关于Gradle的知识 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week7-serialization/ class=md-nav__link> 关于序列化的知识 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week10-classloader/ class=md-nav__link> Android中的ClassLoader </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week11-binder/ class=md-nav__link> Binder简介 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week12-retrofit-okhttp/ class=md-nav__link> OkHttp和Retrofit的作用以及两者之间的联系 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week14-jvm-gc/ class=md-nav__link> JVM中垃圾回收策略 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week16-keep-app-alive/ class=md-nav__link> 进程保活 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week17-android-components/ class=md-nav__link> 四大组件的作用以及多进程 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week20-network-protocol/ class=md-nav__link> 网络协议 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week21-mvc%26mvp%26mvvm/ class=md-nav__link> MVC、MVP和MVVM </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week22-android-studio-build/ class=md-nav__link> Android Studio build过程 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week23-load-large-bitmap/ class=md-nav__link> 大尺寸图片加载问题 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1_4 type=checkbox id=__nav_1_4> <div class="md-nav__link md-nav__link--index "> <a href=../../paid/master/ >Android开发高手课</a> <label for=__nav_1_4> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label=Android开发高手课 data-md-level=2> <label class=md-nav__title for=__nav_1_4> <span class="md-nav__icon md-icon"></span> Android开发高手课 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../paid/master/crash_1/ class=md-nav__link> 01 | 崩溃优化（上）：关于“崩溃”那些事儿 </a> </li> <li class=md-nav__item> <a href=../../paid/master/crash_2/ class=md-nav__link> 02 | 崩溃优化（下）：应用崩溃了，你应该如何去分析？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/memory_1/ class=md-nav__link> 03 | 内存优化（上）：4GB内存时代，再谈内存优化 </a> </li> <li class=md-nav__item> <a href=../../paid/master/memory_2/ class=md-nav__link> 04 | 内存优化（下）：内存优化这件事，应该从哪里着手？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/stuck_1/ class=md-nav__link> 05 | 卡顿优化（上）：你要掌握的卡顿分析方法 </a> </li> <li class=md-nav__item> <a href=../../paid/master/stuck_2/ class=md-nav__link> 06 | 卡顿优化（下）：如何监控应用卡顿？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/stuck_3/ class=md-nav__link> 06补充篇 | 卡顿优化：卡顿现场与卡顿分析 </a> </li> <li class=md-nav__item> <a href=../../paid/master/start_1/ class=md-nav__link> 07 | 启动优化（上）：从启动过程看启动速度优化 </a> </li> <li class=md-nav__item> <a href=../../paid/master/start_2/ class=md-nav__link> 08 | 启动优化（下）：优化启动速度的进阶方法 </a> </li> <li class=md-nav__item> <a href=../../paid/master/io_1/ class=md-nav__link> 09 | I/O优化（上）：开发工程师必备的I/O优化知识 </a> </li> <li class=md-nav__item> <a href=../../paid/master/io_2/ class=md-nav__link> 10 | I/O优化（中）：不同I/O方式的使用场景是什么？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/io_3/ class=md-nav__link> 11 | I/O优化（下）：如何监控线上I/O操作？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/storage_1/ class=md-nav__link> 12 | 存储优化（上）：常见的数据存储方法有哪些？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/storage_2/ class=md-nav__link> 13 | 存储优化（中）：如何优化数据存储？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/storage_3/ class=md-nav__link> 14 | 存储优化（下）：数据库SQLite的使用和优化 </a> </li> <li class=md-nav__item> <a href=../../paid/master/network_1/ class=md-nav__link> 15 | 网络优化（上）：移动开发工程师必备的网络优化知识 </a> </li> <li class=md-nav__item> <a href=../../paid/master/network_2/ class=md-nav__link> 16 | 网络优化（中）：复杂多变的移动网络该如何优化？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/network_3/ class=md-nav__link> 17 | 网络优化（下）：大数据下网络该如何监控？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/battery_1/ class=md-nav__link> 18 | 耗电优化（上）：从电量优化的演进看耗电分析 </a> </li> <li class=md-nav__item> <a href=../../paid/master/battery_2/ class=md-nav__link> 19 | 耗电优化（下）：耗电的优化方法与线上监控 </a> </li> <li class=md-nav__item> <a href=../../paid/master/ui_1/ class=md-nav__link> 20 | UI 优化（上）：UI 渲染的几个关键概念 </a> </li> <li class=md-nav__item> <a href=../../paid/master/ui_2/ class=md-nav__link> 21 | UI 优化（下）：如何优化 UI 渲染？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/package_1/ class=md-nav__link> 22 | 包体积优化（上）：如何减少安装包大小？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/package_2/ class=md-nav__link> 23 | 包体积优化（下）：资源优化的进阶实践 </a> </li> <li class=md-nav__item> <a href=../../paid/master/compile/ class=md-nav__link> 26 | 关于编译，你需要了解什么？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/bytecode/ class=md-nav__link> 27 | 编译插桩的三种方法：AspectJ、ASM、ReDex </a> </li> <li class=md-nav__item> <a href=../../paid/master/native_hook/ class=md-nav__link> 35 | Native Hook 技术，天使还是魔鬼？ </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2 type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2> Flutter <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Flutter data-md-level=1> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Flutter </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_1/ class=md-nav__link> 年轻人的第一个Flutter程序(1) </a> </li> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_2/ class=md-nav__link> 年轻人的第一个Flutter程序(2) </a> </li> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_3/ class=md-nav__link> 年轻人的第一个Flutter程序(3) </a> </li> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_4/ class=md-nav__link> 年轻人的第一个Flutter程序(4) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3 type=checkbox id=__nav_3> <div class="md-nav__link md-nav__link--index "> <a href=../../../leetcode/ >LeetCode</a> <label for=__nav_3> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label=LeetCode data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> LeetCode </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_1/ class=md-nav__link> 数据结构、算法和数据操作 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_3/ class=md-nav__link> 高质量的代码 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_4/ class=md-nav__link> 解决问题的思路 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_5/ class=md-nav__link> 优化时间和空间效率 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_6/ class=md-nav__link> 面试中的各项能力 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/array/ class=md-nav__link> Array </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode1-10/ class=md-nav__link> LeetCode(1-10) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode11-20/ class=md-nav__link> LeetCode(11-20) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode21-30/ class=md-nav__link> LeetCode(21-30) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode31-40/ class=md-nav__link> LeetCode(31-40) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode41-50/ class=md-nav__link> LeetCode(41-50) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode51-60/ class=md-nav__link> LeetCode(51-60) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode61-70/ class=md-nav__link> LeetCode(61-70) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode71-80/ class=md-nav__link> LeetCode(71-80) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode81-90/ class=md-nav__link> LeetCode(81-90) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode91-100/ class=md-nav__link> LeetCode(91-100) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode101-110/ class=md-nav__link> LeetCode(101-110) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode111-120/ class=md-nav__link> LeetCode(111-120) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4 type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4> Books <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Books data-md-level=1> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Books </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_1 type=checkbox id=__nav_4_1> <label class=md-nav__link for=__nav_4_1> Design Pattern <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Design Pattern" data-md-level=2> <label class=md-nav__title for=__nav_4_1> <span class="md-nav__icon md-icon"></span> Design Pattern </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../design-pattern/design-pattern/ class=md-nav__link> 设计模式概述 </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/design-principle/ class=md-nav__link> 面向对象的六大原则 </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/singleton/ class=md-nav__link> 单例模式(Singleton) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/builder/ class=md-nav__link> 建造者模式(Builder) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/prototype/ class=md-nav__link> 原型模式(Prototype) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/factory-method/ class=md-nav__link> 工厂方法模式(Factory method) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/abstract-factory/ class=md-nav__link> 抽象工厂模式(Abstract factory) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/proxy/ class=md-nav__link> 代理模式(Proxy) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/composite/ class=md-nav__link> 组合模式(Composite) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/adapter/ class=md-nav__link> 适配器模式(Adapter) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/decorator/ class=md-nav__link> 装饰模式(Decorator) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/flyweight/ class=md-nav__link> 享元模式(Flyweight) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/facade/ class=md-nav__link> 外观模式(Facade) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/bridge/ class=md-nav__link> 桥接模式(Bridge) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/strategy/ class=md-nav__link> 策略模式(Strategy) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/state/ class=md-nav__link> 状态模式(State) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/chain-of-responsibility/ class=md-nav__link> 责任链模式(Chain of responsibility) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/interpreter/ class=md-nav__link> 解释器模式(Interpreter) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/command/ class=md-nav__link> 命令模式(Command) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/observer/ class=md-nav__link> 观察者模式(Observer) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/memento/ class=md-nav__link> 备忘录模式(Memento) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/iterator/ class=md-nav__link> 迭代器模式(Iterator) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/template-method/ class=md-nav__link> 模版方法模式(Template method) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/visitor/ class=md-nav__link> 访问者模式(Visitor) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/mediator/ class=md-nav__link> 中介者模式(Mediator) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/confusing-design-pattern/ class=md-nav__link> 易混淆的设计模式 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_2 type=checkbox id=__nav_4_2> <label class=md-nav__link for=__nav_4_2> Effective Java <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Effective Java" data-md-level=2> <label class=md-nav__title for=__nav_4_2> <span class="md-nav__icon md-icon"></span> Effective Java </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../effective-java/effective-java/ class=md-nav__link> Effective Java概述 </a> </li> <li class=md-nav__item> <a href=../../../effective-java/chapter1/ class=md-nav__link> 创建和销毁对象 </a> </li> <li class=md-nav__item> <a href=../../../effective-java/chapter2/ class=md-nav__link> 对于所有对象都通用的方法 </a> </li> <li class=md-nav__item> <a href=../../../effective-java/chapter3/ class=md-nav__link> 类和接口 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_3 type=checkbox id=__nav_4_3> <label class=md-nav__link for=__nav_4_3> JVM <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=JVM data-md-level=2> <label class=md-nav__title for=__nav_4_3> <span class="md-nav__icon md-icon"></span> JVM </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../jvm/jvm-content/ class=md-nav__link> 深入理解Java虚拟机 </a> </li> <li class=md-nav__item> <a href=../../../jvm/java-memory-area-oom/ class=md-nav__link> Java内存区域与内存溢出异常 </a> </li> <li class=md-nav__item> <a href=../../../jvm/java-gc/ class=md-nav__link> 垃圾收集器与内存分配策略 </a> </li> <li class=md-nav__item> <a href=../../../jvm/class-struct/ class=md-nav__link> 类文件结构 </a> </li> <li class=md-nav__item> <a href=../../../jvm/load-class/ class=md-nav__link> 虚拟机类加载机制 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_4 type=checkbox id=__nav_4_4> <label class=md-nav__link for=__nav_4_4> Java <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Java data-md-level=2> <label class=md-nav__title for=__nav_4_4> <span class="md-nav__icon md-icon"></span> Java </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../java/generics-java-kotlin/ class=md-nav__link> Java&Kotlin在泛型方面的区别 </a> </li> <li class=md-nav__item> <a href=../../../java/java-collections/ class=md-nav__link> Java集合总结 </a> </li> <li class=md-nav__item> <a href=../../../java/java-foundation/ class=md-nav__link> Java常见概念 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_5 type=checkbox id=__nav_4_5> <label class=md-nav__link for=__nav_4_5> Refactoring <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Refactoring data-md-level=2> <label class=md-nav__title for=__nav_4_5> <span class="md-nav__icon md-icon"></span> Refactoring </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../refactoring/refactoring/ class=md-nav__link> 重构：改善既有代码的设计 </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <span style=float:right;text-align:right;line-height:18px; id=busuanzi_container_page_pv>本文总阅读量<span id=busuanzi_value_page_pv></span>次</span> <h1>Bitmap的缓存与加载</h1> <p>来自官方的建议：<a href=https://developer.android.com/topic/performance/graphics/load-bitmap.html>Loading Large Bitmaps Efficiently</a></p> <blockquote> <p><strong>Note</strong>: There are several libraries that follow best practices for loading images. You can use these libraries in your app to load images in the most optimized manner. We recommend the <a href=https://github.com/bumptech/glide>Glide</a> library, which loads and displays images as quickly and smoothly as possible. Other popular image loading libraries include <a href=http://square.github.io/picasso/ >Picasso</a> from Square and <a href=https://github.com/facebook/fresco>Fresco</a> from Facebook. These libraries simplify most of the complex tasks associated with bitmaps and other types of images on Android.</p> </blockquote> <p>总的来说，就是使用上面这些图片加载库可以最简化你的操作。</p> <blockquote> <p>On Android 2.3.3 (API level 10) and lower, the backing pixel data for a Bitmap is stored in native memory. It is separate from the Bitmap itself, which is stored in the Dalvik heap. The pixel data in native memory is not released in a predictable manner, potentially causing an application to briefly exceed its memory limits and crash. From Android 3.0 (API level 11) through Android 7.1 (API level 25), the pixel data is stored on the Dalvik heap along with the associated Bitmap. In Android 8.0 (API level 26), and higher, the Bitmap pixel data is stored in the native heap.<br> <cite><a href=https://developer.android.google.cn/topic/performance/graphics/manage-memory>Managing Bitmap Memory</a></cite></p> <p>2.3.3 (API level 10)以及更低版本，像素数据存储在native内存上；而Bitmap对象存储在Dalvik堆上。像素数据没有以一种可预测的方式来释放，所以需要我们手动release。<br> 3.0 (API level 11) 到 Android 7.1 (API level 25)，像素数据和Bitmap对象都存储在Dalvik堆上。可以不动手动release了。<br> 8.0 (API level 26)以及更高版本，像素数据存储在native堆上了。</p> </blockquote> <h2 id=1-bitmap>1 Bitmap的加载<a class=headerlink href=#1-bitmap title="Anchor link to this section for reference">&para;</a></h2> <p><code>BitmapFactory</code>提供了一些加载图片的方法(<code>decodeByteArray()</code>、<code>decodeFile()</code>、<code>decodeResource()</code>)从不同类型的文件中加载<code>Bitmap</code>对象。这些方法会尝试申请<code>bitmap</code>所需要的内存，因此容易导致<code>OutOfMemory</code>异常。</p> <blockquote> <p>一张Bitmap在内存中的占用为：图片宽 * 图片高 * 图片格式 </p> <table> <thead> <tr> <th>图片格式 (Bitmap.Config)</th> <th>占用内存</th> <th>100*100图片占用内存大小</th> </tr> </thead> <tbody> <tr> <td>ALPHA_8</td> <td>1 Byte</td> <td>100 * 100 * 1 = 10000 Byte</td> </tr> <tr> <td>ARGB_4444</td> <td>2 Byte</td> <td>100 * 100 * 2 = 20000 Byte</td> </tr> <tr> <td>ARGB_8888</td> <td>4 Byte</td> <td>100 * 100 * 4 = 40000 Byte</td> </tr> <tr> <td>RGB_565</td> <td>2 Byte</td> <td>100 * 100 * 2 = 20000 Byte</td> </tr> </tbody> </table> <p>当然，图片的最终内存占用还与图片所在文件夹(density)以及设备的屏幕密度(targetDensity)相关，缩放比scale = targetDensity / density </p> <p>e.g. <br> 设备屏幕密度为440，以ARGB_8888加载，位于<em>drawable-hdpi</em>中的400*400的图片，内存占用为<br> ((int) (400 * (440 / 240) + 0.5)) ^ 2 * 4 = 2149156 Byte </p> <p>设备屏幕密度为440，以ARGB_8888加载，位于<em>drawable-xhdpi</em>中的400*400的图片，内存占用为<br> ((int) (400 * (440 / 320) + 0.5)) ^ 2 * 4 = 1210000 Byte </p> <p>因此，<strong>图片占用内存大小和手机的密度成正比，所在文件夹密度成反比</strong></p> <p>对应文件夹密度可以查表<a href=/android/framework/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/#513>不同像素密度的配置限定符</a></p> </blockquote> <p>我们可以采用<code>BitmapFactory.Options</code>来设置decode的配置。在decode前将<code>inJustDecodeBounds</code>属性设置为<code>true</code>，虽然将会返回<code>null</code>的<code>bitmap</code>，但是可以得到<code>outWidth</code>、<code>outHeight</code>以及<code>outMimeType</code>。这样我们可以在创建(以及申请内存)前获得图片的像素尺寸和类型。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-0-1 name=__codelineno-0-1></a><a href=#__codelineno-0-1><span class=linenos data-linenos="1 "></span></a><span class=n>BitmapFactory</span><span class=p>.</span><span class=na>Options</span> <span class=n>options</span> <span class=o>=</span> <span class=k>new</span> <span class=n>BitmapFactory</span><span class=p>.</span><span class=na>Options</span><span class=p>();</span>
<a id=__codelineno-0-2 name=__codelineno-0-2></a><a href=#__codelineno-0-2><span class=linenos data-linenos="2 "></span></a><span class=n>options</span><span class=p>.</span><span class=na>inJustDecodeBounds</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
<a id=__codelineno-0-3 name=__codelineno-0-3></a><a href=#__codelineno-0-3><span class=linenos data-linenos="3 "></span></a><span class=n>BitmapFactory</span><span class=p>.</span><span class=na>decodeResource</span><span class=p>(</span><span class=n>getResources</span><span class=p>(),</span> <span class=n>R</span><span class=p>.</span><span class=na>id</span><span class=p>.</span><span class=na>myimage</span><span class=p>,</span> <span class=n>options</span><span class=p>);</span>
<a id=__codelineno-0-4 name=__codelineno-0-4></a><a href=#__codelineno-0-4><span class=linenos data-linenos="4 "></span></a><span class=kt>int</span> <span class=n>imageHeight</span> <span class=o>=</span> <span class=n>options</span><span class=p>.</span><span class=na>outHeight</span><span class=p>;</span>
<a id=__codelineno-0-5 name=__codelineno-0-5></a><a href=#__codelineno-0-5><span class=linenos data-linenos="5 "></span></a><span class=kt>int</span> <span class=n>imageWidth</span> <span class=o>=</span> <span class=n>options</span><span class=p>.</span><span class=na>outWidth</span><span class=p>;</span>
<a id=__codelineno-0-6 name=__codelineno-0-6></a><a href=#__codelineno-0-6><span class=linenos data-linenos="6 "></span></a><span class=n>String</span> <span class=n>imageType</span> <span class=o>=</span> <span class=n>options</span><span class=p>.</span><span class=na>outMimeType</span><span class=p>;</span>
</code></pre></div> <p>除非我们完全相信图片所占用的内存可以满足，在decode之前检查像素可以避免<code>java.lang.OutOfMemory</code>异常。</p> <h3 id=11>1.1 采样率压缩<a class=headerlink href=#11 title="Anchor link to this section for reference">&para;</a></h3> <p>设置<code>BitmapFactory.Options</code>中的<code>inSampleSize</code>可以采样到缩略图。</p> <p><code>inSampleSize</code>的取值应该是2的指数，比如1、2、4等等；少于1，其作用相当于1。如果<code>inSampleSize</code>为2，那么采样后的图片宽高均为原图的&frac12;，也就是占用内存大小为原图的&frac14;。</p> <p>采样率的计算代码如下： <div class=highlight><pre><span></span><code><a id=__codelineno-1-1 name=__codelineno-1-1></a><a href=#__codelineno-1-1><span class=linenos data-linenos=" 1 "></span></a><span class=kd>public</span> <span class=kd>static</span> <span class=kt>int</span> <span class=nf>calculateInSampleSize</span><span class=p>(</span>
<a id=__codelineno-1-2 name=__codelineno-1-2></a><a href=#__codelineno-1-2><span class=linenos data-linenos=" 2 "></span></a>            <span class=n>BitmapFactory</span><span class=p>.</span><span class=na>Options</span> <span class=n>options</span><span class=p>,</span> <span class=kt>int</span> <span class=n>reqWidth</span><span class=p>,</span> <span class=kt>int</span> <span class=n>reqHeight</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-1-3 name=__codelineno-1-3></a><a href=#__codelineno-1-3><span class=linenos data-linenos=" 3 "></span></a>    <span class=c1>// Raw height and width of image</span>
<a id=__codelineno-1-4 name=__codelineno-1-4></a><a href=#__codelineno-1-4><span class=linenos data-linenos=" 4 "></span></a>    <span class=kd>final</span> <span class=kt>int</span> <span class=n>height</span> <span class=o>=</span> <span class=n>options</span><span class=p>.</span><span class=na>outHeight</span><span class=p>;</span>
<a id=__codelineno-1-5 name=__codelineno-1-5></a><a href=#__codelineno-1-5><span class=linenos data-linenos=" 5 "></span></a>    <span class=kd>final</span> <span class=kt>int</span> <span class=n>width</span> <span class=o>=</span> <span class=n>options</span><span class=p>.</span><span class=na>outWidth</span><span class=p>;</span>
<a id=__codelineno-1-6 name=__codelineno-1-6></a><a href=#__codelineno-1-6><span class=linenos data-linenos=" 6 "></span></a>    <span class=kt>int</span> <span class=n>inSampleSize</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
<a id=__codelineno-1-7 name=__codelineno-1-7></a><a href=#__codelineno-1-7><span class=linenos data-linenos=" 7 "></span></a>
<a id=__codelineno-1-8 name=__codelineno-1-8></a><a href=#__codelineno-1-8><span class=linenos data-linenos=" 8 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>height</span> <span class=o>&gt;</span> <span class=n>reqHeight</span> <span class=o>||</span> <span class=n>width</span> <span class=o>&gt;</span> <span class=n>reqWidth</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-1-9 name=__codelineno-1-9></a><a href=#__codelineno-1-9><span class=linenos data-linenos=" 9 "></span></a>
<a id=__codelineno-1-10 name=__codelineno-1-10></a><a href=#__codelineno-1-10><span class=linenos data-linenos="10 "></span></a>        <span class=kd>final</span> <span class=kt>int</span> <span class=n>halfHeight</span> <span class=o>=</span> <span class=n>height</span> <span class=o>/</span> <span class=mi>2</span><span class=p>;</span>
<a id=__codelineno-1-11 name=__codelineno-1-11></a><a href=#__codelineno-1-11><span class=linenos data-linenos="11 "></span></a>        <span class=kd>final</span> <span class=kt>int</span> <span class=n>halfWidth</span> <span class=o>=</span> <span class=n>width</span> <span class=o>/</span> <span class=mi>2</span><span class=p>;</span>
<a id=__codelineno-1-12 name=__codelineno-1-12></a><a href=#__codelineno-1-12><span class=linenos data-linenos="12 "></span></a>
<a id=__codelineno-1-13 name=__codelineno-1-13></a><a href=#__codelineno-1-13><span class=linenos data-linenos="13 "></span></a>        <span class=c1>// Calculate the largest inSampleSize value that is a power of 2 and keeps both</span>
<a id=__codelineno-1-14 name=__codelineno-1-14></a><a href=#__codelineno-1-14><span class=linenos data-linenos="14 "></span></a>        <span class=c1>// height and width larger than the requested height and width.</span>
<a id=__codelineno-1-15 name=__codelineno-1-15></a><a href=#__codelineno-1-15><span class=linenos data-linenos="15 "></span></a>        <span class=k>while</span> <span class=p>((</span><span class=n>halfHeight</span> <span class=o>/</span> <span class=n>inSampleSize</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=n>reqHeight</span>
<a id=__codelineno-1-16 name=__codelineno-1-16></a><a href=#__codelineno-1-16><span class=linenos data-linenos="16 "></span></a>                <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>halfWidth</span> <span class=o>/</span> <span class=n>inSampleSize</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=n>reqWidth</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-1-17 name=__codelineno-1-17></a><a href=#__codelineno-1-17><span class=linenos data-linenos="17 "></span></a>            <span class=n>inSampleSize</span> <span class=o>*=</span> <span class=mi>2</span><span class=p>;</span>
<a id=__codelineno-1-18 name=__codelineno-1-18></a><a href=#__codelineno-1-18><span class=linenos data-linenos="18 "></span></a>        <span class=p>}</span>
<a id=__codelineno-1-19 name=__codelineno-1-19></a><a href=#__codelineno-1-19><span class=linenos data-linenos="19 "></span></a>    <span class=p>}</span>
<a id=__codelineno-1-20 name=__codelineno-1-20></a><a href=#__codelineno-1-20><span class=linenos data-linenos="20 "></span></a>
<a id=__codelineno-1-21 name=__codelineno-1-21></a><a href=#__codelineno-1-21><span class=linenos data-linenos="21 "></span></a>    <span class=k>return</span> <span class=n>inSampleSize</span><span class=p>;</span>
<a id=__codelineno-1-22 name=__codelineno-1-22></a><a href=#__codelineno-1-22><span class=linenos data-linenos="22 "></span></a><span class=p>}</span>
</code></pre></div></p> <p>使用上面的方法时，现将<code>inJustDecodeBounds</code>设置为<code>true</code>计算采样率，然后使用<code>inSampleSize</code>并将<code>inJustDecodeBounds</code>设置为<code>false</code>。 <div class=highlight><pre><span></span><code><a id=__codelineno-2-1 name=__codelineno-2-1></a><a href=#__codelineno-2-1><span class=linenos data-linenos=" 1 "></span></a><span class=kd>public</span> <span class=kd>static</span> <span class=n>Bitmap</span> <span class=nf>decodeSampledBitmapFromResource</span><span class=p>(</span><span class=n>Resources</span> <span class=n>res</span><span class=p>,</span> <span class=kt>int</span> <span class=n>resId</span><span class=p>,</span>
<a id=__codelineno-2-2 name=__codelineno-2-2></a><a href=#__codelineno-2-2><span class=linenos data-linenos=" 2 "></span></a>        <span class=kt>int</span> <span class=n>reqWidth</span><span class=p>,</span> <span class=kt>int</span> <span class=n>reqHeight</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-2-3 name=__codelineno-2-3></a><a href=#__codelineno-2-3><span class=linenos data-linenos=" 3 "></span></a>
<a id=__codelineno-2-4 name=__codelineno-2-4></a><a href=#__codelineno-2-4><span class=linenos data-linenos=" 4 "></span></a>    <span class=c1>// First decode with inJustDecodeBounds=true to check dimensions</span>
<a id=__codelineno-2-5 name=__codelineno-2-5></a><a href=#__codelineno-2-5><span class=linenos data-linenos=" 5 "></span></a>    <span class=kd>final</span> <span class=n>BitmapFactory</span><span class=p>.</span><span class=na>Options</span> <span class=n>options</span> <span class=o>=</span> <span class=k>new</span> <span class=n>BitmapFactory</span><span class=p>.</span><span class=na>Options</span><span class=p>();</span>
<a id=__codelineno-2-6 name=__codelineno-2-6></a><a href=#__codelineno-2-6><span class=linenos data-linenos=" 6 "></span></a>    <span class=n>options</span><span class=p>.</span><span class=na>inJustDecodeBounds</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
<a id=__codelineno-2-7 name=__codelineno-2-7></a><a href=#__codelineno-2-7><span class=linenos data-linenos=" 7 "></span></a>    <span class=n>BitmapFactory</span><span class=p>.</span><span class=na>decodeResource</span><span class=p>(</span><span class=n>res</span><span class=p>,</span> <span class=n>resId</span><span class=p>,</span> <span class=n>options</span><span class=p>);</span>
<a id=__codelineno-2-8 name=__codelineno-2-8></a><a href=#__codelineno-2-8><span class=linenos data-linenos=" 8 "></span></a>
<a id=__codelineno-2-9 name=__codelineno-2-9></a><a href=#__codelineno-2-9><span class=linenos data-linenos=" 9 "></span></a>    <span class=c1>// Calculate inSampleSize</span>
<a id=__codelineno-2-10 name=__codelineno-2-10></a><a href=#__codelineno-2-10><span class=linenos data-linenos="10 "></span></a>    <span class=n>options</span><span class=p>.</span><span class=na>inSampleSize</span> <span class=o>=</span> <span class=n>calculateInSampleSize</span><span class=p>(</span><span class=n>options</span><span class=p>,</span> <span class=n>reqWidth</span><span class=p>,</span> <span class=n>reqHeight</span><span class=p>);</span>
<a id=__codelineno-2-11 name=__codelineno-2-11></a><a href=#__codelineno-2-11><span class=linenos data-linenos="11 "></span></a>
<a id=__codelineno-2-12 name=__codelineno-2-12></a><a href=#__codelineno-2-12><span class=linenos data-linenos="12 "></span></a>    <span class=c1>// Decode bitmap with inSampleSize set</span>
<a id=__codelineno-2-13 name=__codelineno-2-13></a><a href=#__codelineno-2-13><span class=linenos data-linenos="13 "></span></a>    <span class=n>options</span><span class=p>.</span><span class=na>inJustDecodeBounds</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
<a id=__codelineno-2-14 name=__codelineno-2-14></a><a href=#__codelineno-2-14><span class=linenos data-linenos="14 "></span></a>    <span class=k>return</span> <span class=n>BitmapFactory</span><span class=p>.</span><span class=na>decodeResource</span><span class=p>(</span><span class=n>res</span><span class=p>,</span> <span class=n>resId</span><span class=p>,</span> <span class=n>options</span><span class=p>);</span>
<a id=__codelineno-2-15 name=__codelineno-2-15></a><a href=#__codelineno-2-15><span class=linenos data-linenos="15 "></span></a><span class=p>}</span>
</code></pre></div></p> <p>最后，将一个大图加载到100*100大小的ImageView里面可以这么写： <div class=highlight><pre><span></span><code><a id=__codelineno-3-1 name=__codelineno-3-1></a><a href=#__codelineno-3-1><span class=linenos data-linenos="1 "></span></a><span class=n>mImageView</span><span class=p>.</span><span class=na>setImageBitmap</span><span class=p>(</span>
<a id=__codelineno-3-2 name=__codelineno-3-2></a><a href=#__codelineno-3-2><span class=linenos data-linenos="2 "></span></a>    <span class=n>decodeSampledBitmapFromResource</span><span class=p>(</span><span class=n>getResources</span><span class=p>(),</span> <span class=n>R</span><span class=p>.</span><span class=na>drawable</span><span class=p>.</span><span class=na>myimage</span><span class=p>,</span> <span class=mi>100</span><span class=p>,</span> <span class=mi>100</span><span class=p>));</span>
</code></pre></div></p> <h3 id=12>1.2 封装好的大图片加载类<a class=headerlink href=#12 title="Anchor link to this section for reference">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-4-1 name=__codelineno-4-1></a><a href=#__codelineno-4-1><span class=linenos data-linenos=" 1 "></span></a><span class=cm>/**</span>
<a id=__codelineno-4-2 name=__codelineno-4-2></a><a href=#__codelineno-4-2><span class=linenos data-linenos=" 2 "></span></a><span class=cm> * 压缩Image至指定的大小</span>
<a id=__codelineno-4-3 name=__codelineno-4-3></a><a href=#__codelineno-4-3><span class=linenos data-linenos=" 3 "></span></a><span class=cm> * Created by yorek on 5/10/17.</span>
<a id=__codelineno-4-4 name=__codelineno-4-4></a><a href=#__codelineno-4-4><span class=linenos data-linenos=" 4 "></span></a><span class=cm> */</span>
<a id=__codelineno-4-5 name=__codelineno-4-5></a><a href=#__codelineno-4-5><span class=linenos data-linenos=" 5 "></span></a><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ImageSampler</span> <span class=p>{</span>
<a id=__codelineno-4-6 name=__codelineno-4-6></a><a href=#__codelineno-4-6><span class=linenos data-linenos=" 6 "></span></a>
<a id=__codelineno-4-7 name=__codelineno-4-7></a><a href=#__codelineno-4-7><span class=linenos data-linenos=" 7 "></span></a>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>TAG</span> <span class=o>=</span> <span class=s>&quot;ImageSampler&quot;</span><span class=p>;</span>
<a id=__codelineno-4-8 name=__codelineno-4-8></a><a href=#__codelineno-4-8><span class=linenos data-linenos=" 8 "></span></a>
<a id=__codelineno-4-9 name=__codelineno-4-9></a><a href=#__codelineno-4-9><span class=linenos data-linenos=" 9 "></span></a>    <span class=kd>public</span> <span class=kd>static</span> <span class=n>Bitmap</span> <span class=nf>sample</span><span class=p>(</span><span class=n>InputStream</span> <span class=n>input</span><span class=p>,</span> <span class=kt>int</span> <span class=n>reqWidth</span><span class=p>,</span> <span class=kt>int</span> <span class=n>reqHeight</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-4-10 name=__codelineno-4-10></a><a href=#__codelineno-4-10><span class=linenos data-linenos="10 "></span></a>        <span class=kd>final</span> <span class=n>BitmapFactory</span><span class=p>.</span><span class=na>Options</span> <span class=n>options</span> <span class=o>=</span> <span class=k>new</span> <span class=n>BitmapFactory</span><span class=p>.</span><span class=na>Options</span><span class=p>();</span>
<a id=__codelineno-4-11 name=__codelineno-4-11></a><a href=#__codelineno-4-11><span class=linenos data-linenos="11 "></span></a>        <span class=n>options</span><span class=p>.</span><span class=na>inJustDecodeBounds</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
<a id=__codelineno-4-12 name=__codelineno-4-12></a><a href=#__codelineno-4-12><span class=linenos data-linenos="12 "></span></a>
<a id=__codelineno-4-13 name=__codelineno-4-13></a><a href=#__codelineno-4-13><span class=linenos data-linenos="13 "></span></a>        <span class=n>decodeStream</span><span class=p>(</span><span class=n>input</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=n>options</span><span class=p>);</span>
<a id=__codelineno-4-14 name=__codelineno-4-14></a><a href=#__codelineno-4-14><span class=linenos data-linenos="14 "></span></a>
<a id=__codelineno-4-15 name=__codelineno-4-15></a><a href=#__codelineno-4-15><span class=linenos data-linenos="15 "></span></a>        <span class=n>options</span><span class=p>.</span><span class=na>inSampleSize</span> <span class=o>=</span> <span class=n>calcSampleSize</span><span class=p>(</span><span class=n>options</span><span class=p>,</span> <span class=n>reqWidth</span><span class=p>,</span> <span class=n>reqHeight</span><span class=p>);</span>
<a id=__codelineno-4-16 name=__codelineno-4-16></a><a href=#__codelineno-4-16><span class=linenos data-linenos="16 "></span></a>        <span class=n>options</span><span class=p>.</span><span class=na>inJustDecodeBounds</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
<a id=__codelineno-4-17 name=__codelineno-4-17></a><a href=#__codelineno-4-17><span class=linenos data-linenos="17 "></span></a>
<a id=__codelineno-4-18 name=__codelineno-4-18></a><a href=#__codelineno-4-18><span class=linenos data-linenos="18 "></span></a>        <span class=n>Bitmap</span> <span class=n>bitmap</span> <span class=o>=</span> <span class=n>BitmapFactory</span><span class=p>.</span><span class=na>decodeStream</span><span class=p>(</span><span class=n>input</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=n>options</span><span class=p>);</span>
<a id=__codelineno-4-19 name=__codelineno-4-19></a><a href=#__codelineno-4-19><span class=linenos data-linenos="19 "></span></a>
<a id=__codelineno-4-20 name=__codelineno-4-20></a><a href=#__codelineno-4-20><span class=linenos data-linenos="20 "></span></a>        <span class=k>try</span> <span class=p>{</span>
<a id=__codelineno-4-21 name=__codelineno-4-21></a><a href=#__codelineno-4-21><span class=linenos data-linenos="21 "></span></a>            <span class=k>if</span> <span class=p>(</span><span class=n>input</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-4-22 name=__codelineno-4-22></a><a href=#__codelineno-4-22><span class=linenos data-linenos="22 "></span></a>                <span class=n>input</span><span class=p>.</span><span class=na>close</span><span class=p>();</span>
<a id=__codelineno-4-23 name=__codelineno-4-23></a><a href=#__codelineno-4-23><span class=linenos data-linenos="23 "></span></a>            <span class=p>}</span>
<a id=__codelineno-4-24 name=__codelineno-4-24></a><a href=#__codelineno-4-24><span class=linenos data-linenos="24 "></span></a>        <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>IOException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-4-25 name=__codelineno-4-25></a><a href=#__codelineno-4-25><span class=linenos data-linenos="25 "></span></a>            <span class=n>Log</span><span class=p>.</span><span class=na>e</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s>&quot;error in input.close() : &quot;</span> <span class=o>+</span> <span class=n>e</span><span class=p>.</span><span class=na>getMessage</span><span class=p>());</span>
<a id=__codelineno-4-26 name=__codelineno-4-26></a><a href=#__codelineno-4-26><span class=linenos data-linenos="26 "></span></a>            <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-4-27 name=__codelineno-4-27></a><a href=#__codelineno-4-27><span class=linenos data-linenos="27 "></span></a>        <span class=p>}</span>
<a id=__codelineno-4-28 name=__codelineno-4-28></a><a href=#__codelineno-4-28><span class=linenos data-linenos="28 "></span></a>
<a id=__codelineno-4-29 name=__codelineno-4-29></a><a href=#__codelineno-4-29><span class=linenos data-linenos="29 "></span></a>        <span class=k>return</span> <span class=n>bitmap</span><span class=p>;</span>
<a id=__codelineno-4-30 name=__codelineno-4-30></a><a href=#__codelineno-4-30><span class=linenos data-linenos="30 "></span></a>    <span class=p>}</span>
<a id=__codelineno-4-31 name=__codelineno-4-31></a><a href=#__codelineno-4-31><span class=linenos data-linenos="31 "></span></a>
<a id=__codelineno-4-32 name=__codelineno-4-32></a><a href=#__codelineno-4-32><span class=linenos data-linenos="32 "></span></a>    <span class=kd>public</span> <span class=kd>static</span> <span class=n>Bitmap</span> <span class=nf>sample</span><span class=p>(</span><span class=n>String</span> <span class=n>fileName</span><span class=p>,</span> <span class=kt>int</span> <span class=n>reqWidth</span><span class=p>,</span> <span class=kt>int</span> <span class=n>reqHeight</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-4-33 name=__codelineno-4-33></a><a href=#__codelineno-4-33><span class=linenos data-linenos="33 "></span></a>        <span class=kd>final</span> <span class=n>BitmapFactory</span><span class=p>.</span><span class=na>Options</span> <span class=n>options</span> <span class=o>=</span> <span class=k>new</span> <span class=n>BitmapFactory</span><span class=p>.</span><span class=na>Options</span><span class=p>();</span>
<a id=__codelineno-4-34 name=__codelineno-4-34></a><a href=#__codelineno-4-34><span class=linenos data-linenos="34 "></span></a>        <span class=n>options</span><span class=p>.</span><span class=na>inJustDecodeBounds</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
<a id=__codelineno-4-35 name=__codelineno-4-35></a><a href=#__codelineno-4-35><span class=linenos data-linenos="35 "></span></a>
<a id=__codelineno-4-36 name=__codelineno-4-36></a><a href=#__codelineno-4-36><span class=linenos data-linenos="36 "></span></a>        <span class=n>BitmapFactory</span><span class=p>.</span><span class=na>decodeFile</span><span class=p>(</span><span class=n>fileName</span><span class=p>,</span> <span class=n>options</span><span class=p>);</span>
<a id=__codelineno-4-37 name=__codelineno-4-37></a><a href=#__codelineno-4-37><span class=linenos data-linenos="37 "></span></a>
<a id=__codelineno-4-38 name=__codelineno-4-38></a><a href=#__codelineno-4-38><span class=linenos data-linenos="38 "></span></a>        <span class=n>options</span><span class=p>.</span><span class=na>inSampleSize</span> <span class=o>=</span> <span class=n>calcSampleSize</span><span class=p>(</span><span class=n>options</span><span class=p>,</span> <span class=n>reqWidth</span><span class=p>,</span> <span class=n>reqHeight</span><span class=p>);</span>
<a id=__codelineno-4-39 name=__codelineno-4-39></a><a href=#__codelineno-4-39><span class=linenos data-linenos="39 "></span></a>        <span class=n>options</span><span class=p>.</span><span class=na>inJustDecodeBounds</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
<a id=__codelineno-4-40 name=__codelineno-4-40></a><a href=#__codelineno-4-40><span class=linenos data-linenos="40 "></span></a>
<a id=__codelineno-4-41 name=__codelineno-4-41></a><a href=#__codelineno-4-41><span class=linenos data-linenos="41 "></span></a>        <span class=k>return</span> <span class=n>BitmapFactory</span><span class=p>.</span><span class=na>decodeFile</span><span class=p>(</span><span class=n>fileName</span><span class=p>,</span> <span class=n>options</span><span class=p>);</span>
<a id=__codelineno-4-42 name=__codelineno-4-42></a><a href=#__codelineno-4-42><span class=linenos data-linenos="42 "></span></a>    <span class=p>}</span>
<a id=__codelineno-4-43 name=__codelineno-4-43></a><a href=#__codelineno-4-43><span class=linenos data-linenos="43 "></span></a>
<a id=__codelineno-4-44 name=__codelineno-4-44></a><a href=#__codelineno-4-44><span class=linenos data-linenos="44 "></span></a>    <span class=kd>public</span> <span class=kd>static</span> <span class=n>Bitmap</span> <span class=nf>sample</span><span class=p>(</span><span class=n>FileDescriptor</span> <span class=n>fileDescriptor</span><span class=p>,</span> <span class=kt>int</span> <span class=n>reqWidth</span><span class=p>,</span> <span class=kt>int</span> <span class=n>reqHeight</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-4-45 name=__codelineno-4-45></a><a href=#__codelineno-4-45><span class=linenos data-linenos="45 "></span></a>        <span class=kd>final</span> <span class=n>BitmapFactory</span><span class=p>.</span><span class=na>Options</span> <span class=n>options</span> <span class=o>=</span> <span class=k>new</span> <span class=n>BitmapFactory</span><span class=p>.</span><span class=na>Options</span><span class=p>();</span>
<a id=__codelineno-4-46 name=__codelineno-4-46></a><a href=#__codelineno-4-46><span class=linenos data-linenos="46 "></span></a>        <span class=n>options</span><span class=p>.</span><span class=na>inJustDecodeBounds</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
<a id=__codelineno-4-47 name=__codelineno-4-47></a><a href=#__codelineno-4-47><span class=linenos data-linenos="47 "></span></a>
<a id=__codelineno-4-48 name=__codelineno-4-48></a><a href=#__codelineno-4-48><span class=linenos data-linenos="48 "></span></a>        <span class=n>BitmapFactory</span><span class=p>.</span><span class=na>decodeFileDescriptor</span><span class=p>(</span><span class=n>fileDescriptor</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=n>options</span><span class=p>);</span>
<a id=__codelineno-4-49 name=__codelineno-4-49></a><a href=#__codelineno-4-49><span class=linenos data-linenos="49 "></span></a>
<a id=__codelineno-4-50 name=__codelineno-4-50></a><a href=#__codelineno-4-50><span class=linenos data-linenos="50 "></span></a>        <span class=n>options</span><span class=p>.</span><span class=na>inSampleSize</span> <span class=o>=</span> <span class=n>calcSampleSize</span><span class=p>(</span><span class=n>options</span><span class=p>,</span> <span class=n>reqWidth</span><span class=p>,</span> <span class=n>reqHeight</span><span class=p>);</span>
<a id=__codelineno-4-51 name=__codelineno-4-51></a><a href=#__codelineno-4-51><span class=linenos data-linenos="51 "></span></a>        <span class=n>options</span><span class=p>.</span><span class=na>inJustDecodeBounds</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
<a id=__codelineno-4-52 name=__codelineno-4-52></a><a href=#__codelineno-4-52><span class=linenos data-linenos="52 "></span></a>
<a id=__codelineno-4-53 name=__codelineno-4-53></a><a href=#__codelineno-4-53><span class=linenos data-linenos="53 "></span></a>        <span class=k>return</span> <span class=n>BitmapFactory</span><span class=p>.</span><span class=na>decodeFileDescriptor</span><span class=p>(</span><span class=n>fileDescriptor</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=n>options</span><span class=p>);</span>
<a id=__codelineno-4-54 name=__codelineno-4-54></a><a href=#__codelineno-4-54><span class=linenos data-linenos="54 "></span></a>    <span class=p>}</span>
<a id=__codelineno-4-55 name=__codelineno-4-55></a><a href=#__codelineno-4-55><span class=linenos data-linenos="55 "></span></a>
<a id=__codelineno-4-56 name=__codelineno-4-56></a><a href=#__codelineno-4-56><span class=linenos data-linenos="56 "></span></a>    <span class=kd>public</span> <span class=kd>static</span> <span class=n>Bitmap</span> <span class=nf>sample</span><span class=p>(</span><span class=n>Resources</span> <span class=n>resources</span><span class=p>,</span> <span class=kt>int</span> <span class=n>resId</span><span class=p>,</span> <span class=kt>int</span> <span class=n>reqWidth</span><span class=p>,</span> <span class=kt>int</span> <span class=n>reqHeight</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-4-57 name=__codelineno-4-57></a><a href=#__codelineno-4-57><span class=linenos data-linenos="57 "></span></a>        <span class=kd>final</span> <span class=n>BitmapFactory</span><span class=p>.</span><span class=na>Options</span> <span class=n>options</span> <span class=o>=</span> <span class=k>new</span> <span class=n>BitmapFactory</span><span class=p>.</span><span class=na>Options</span><span class=p>();</span>
<a id=__codelineno-4-58 name=__codelineno-4-58></a><a href=#__codelineno-4-58><span class=linenos data-linenos="58 "></span></a>        <span class=n>options</span><span class=p>.</span><span class=na>inJustDecodeBounds</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
<a id=__codelineno-4-59 name=__codelineno-4-59></a><a href=#__codelineno-4-59><span class=linenos data-linenos="59 "></span></a>
<a id=__codelineno-4-60 name=__codelineno-4-60></a><a href=#__codelineno-4-60><span class=linenos data-linenos="60 "></span></a>        <span class=n>BitmapFactory</span><span class=p>.</span><span class=na>decodeResource</span><span class=p>(</span><span class=n>resources</span><span class=p>,</span> <span class=n>resId</span><span class=p>,</span> <span class=n>options</span><span class=p>);</span>
<a id=__codelineno-4-61 name=__codelineno-4-61></a><a href=#__codelineno-4-61><span class=linenos data-linenos="61 "></span></a>
<a id=__codelineno-4-62 name=__codelineno-4-62></a><a href=#__codelineno-4-62><span class=linenos data-linenos="62 "></span></a>        <span class=n>options</span><span class=p>.</span><span class=na>inSampleSize</span> <span class=o>=</span> <span class=n>calcSampleSize</span><span class=p>(</span><span class=n>options</span><span class=p>,</span> <span class=n>reqWidth</span><span class=p>,</span> <span class=n>reqHeight</span><span class=p>);</span>
<a id=__codelineno-4-63 name=__codelineno-4-63></a><a href=#__codelineno-4-63><span class=linenos data-linenos="63 "></span></a>        <span class=n>options</span><span class=p>.</span><span class=na>inJustDecodeBounds</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
<a id=__codelineno-4-64 name=__codelineno-4-64></a><a href=#__codelineno-4-64><span class=linenos data-linenos="64 "></span></a>
<a id=__codelineno-4-65 name=__codelineno-4-65></a><a href=#__codelineno-4-65><span class=linenos data-linenos="65 "></span></a>        <span class=k>return</span> <span class=n>BitmapFactory</span><span class=p>.</span><span class=na>decodeResource</span><span class=p>(</span><span class=n>resources</span><span class=p>,</span> <span class=n>resId</span><span class=p>,</span> <span class=n>options</span><span class=p>);</span>
<a id=__codelineno-4-66 name=__codelineno-4-66></a><a href=#__codelineno-4-66><span class=linenos data-linenos="66 "></span></a>    <span class=p>}</span>
<a id=__codelineno-4-67 name=__codelineno-4-67></a><a href=#__codelineno-4-67><span class=linenos data-linenos="67 "></span></a>
<a id=__codelineno-4-68 name=__codelineno-4-68></a><a href=#__codelineno-4-68><span class=linenos data-linenos="68 "></span></a>    <span class=kd>private</span> <span class=kd>static</span> <span class=kt>int</span> <span class=nf>calcSampleSize</span><span class=p>(</span><span class=n>BitmapFactory</span><span class=p>.</span><span class=na>Options</span> <span class=n>options</span><span class=p>,</span> <span class=kt>int</span> <span class=n>reqWidth</span><span class=p>,</span> <span class=kt>int</span> <span class=n>reqHeight</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-4-69 name=__codelineno-4-69></a><a href=#__codelineno-4-69><span class=linenos data-linenos="69 "></span></a>        <span class=k>if</span> <span class=p>(</span><span class=n>reqWidth</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>||</span> <span class=n>reqHeight</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-4-70 name=__codelineno-4-70></a><a href=#__codelineno-4-70><span class=linenos data-linenos="70 "></span></a>            <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
<a id=__codelineno-4-71 name=__codelineno-4-71></a><a href=#__codelineno-4-71><span class=linenos data-linenos="71 "></span></a>        <span class=p>}</span>
<a id=__codelineno-4-72 name=__codelineno-4-72></a><a href=#__codelineno-4-72><span class=linenos data-linenos="72 "></span></a>
<a id=__codelineno-4-73 name=__codelineno-4-73></a><a href=#__codelineno-4-73><span class=linenos data-linenos="73 "></span></a>        <span class=c1>// Raw height and width of image</span>
<a id=__codelineno-4-74 name=__codelineno-4-74></a><a href=#__codelineno-4-74><span class=linenos data-linenos="74 "></span></a>        <span class=kd>final</span> <span class=kt>int</span> <span class=n>height</span> <span class=o>=</span> <span class=n>options</span><span class=p>.</span><span class=na>outHeight</span><span class=p>;</span>
<a id=__codelineno-4-75 name=__codelineno-4-75></a><a href=#__codelineno-4-75><span class=linenos data-linenos="75 "></span></a>        <span class=kd>final</span> <span class=kt>int</span> <span class=n>width</span> <span class=o>=</span> <span class=n>options</span><span class=p>.</span><span class=na>outWidth</span><span class=p>;</span>
<a id=__codelineno-4-76 name=__codelineno-4-76></a><a href=#__codelineno-4-76><span class=linenos data-linenos="76 "></span></a>        <span class=kt>int</span> <span class=n>inSampleSize</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
<a id=__codelineno-4-77 name=__codelineno-4-77></a><a href=#__codelineno-4-77><span class=linenos data-linenos="77 "></span></a>
<a id=__codelineno-4-78 name=__codelineno-4-78></a><a href=#__codelineno-4-78><span class=linenos data-linenos="78 "></span></a>        <span class=k>if</span> <span class=p>(</span><span class=n>height</span> <span class=o>&gt;</span> <span class=n>reqHeight</span> <span class=o>||</span> <span class=n>width</span> <span class=o>&gt;</span> <span class=n>reqWidth</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-4-79 name=__codelineno-4-79></a><a href=#__codelineno-4-79><span class=linenos data-linenos="79 "></span></a>
<a id=__codelineno-4-80 name=__codelineno-4-80></a><a href=#__codelineno-4-80><span class=linenos data-linenos="80 "></span></a>            <span class=kd>final</span> <span class=kt>int</span> <span class=n>halfHeight</span> <span class=o>=</span> <span class=n>height</span> <span class=o>/</span> <span class=mi>2</span><span class=p>;</span>
<a id=__codelineno-4-81 name=__codelineno-4-81></a><a href=#__codelineno-4-81><span class=linenos data-linenos="81 "></span></a>            <span class=kd>final</span> <span class=kt>int</span> <span class=n>halfWidth</span> <span class=o>=</span> <span class=n>width</span> <span class=o>/</span> <span class=mi>2</span><span class=p>;</span>
<a id=__codelineno-4-82 name=__codelineno-4-82></a><a href=#__codelineno-4-82><span class=linenos data-linenos="82 "></span></a>
<a id=__codelineno-4-83 name=__codelineno-4-83></a><a href=#__codelineno-4-83><span class=linenos data-linenos="83 "></span></a>            <span class=c1>// Calculate the largest inSampleSize value that is a power of 2 and keeps both</span>
<a id=__codelineno-4-84 name=__codelineno-4-84></a><a href=#__codelineno-4-84><span class=linenos data-linenos="84 "></span></a>            <span class=c1>// height and width larger than the requested height and width.</span>
<a id=__codelineno-4-85 name=__codelineno-4-85></a><a href=#__codelineno-4-85><span class=linenos data-linenos="85 "></span></a>            <span class=k>while</span> <span class=p>((</span><span class=n>halfHeight</span> <span class=o>/</span> <span class=n>inSampleSize</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=n>reqHeight</span>
<a id=__codelineno-4-86 name=__codelineno-4-86></a><a href=#__codelineno-4-86><span class=linenos data-linenos="86 "></span></a>                    <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>halfWidth</span> <span class=o>/</span> <span class=n>inSampleSize</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=n>reqWidth</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-4-87 name=__codelineno-4-87></a><a href=#__codelineno-4-87><span class=linenos data-linenos="87 "></span></a>                <span class=n>inSampleSize</span> <span class=o>*=</span> <span class=mi>2</span><span class=p>;</span>
<a id=__codelineno-4-88 name=__codelineno-4-88></a><a href=#__codelineno-4-88><span class=linenos data-linenos="88 "></span></a>            <span class=p>}</span>
<a id=__codelineno-4-89 name=__codelineno-4-89></a><a href=#__codelineno-4-89><span class=linenos data-linenos="89 "></span></a>        <span class=p>}</span>
<a id=__codelineno-4-90 name=__codelineno-4-90></a><a href=#__codelineno-4-90><span class=linenos data-linenos="90 "></span></a>
<a id=__codelineno-4-91 name=__codelineno-4-91></a><a href=#__codelineno-4-91><span class=linenos data-linenos="91 "></span></a>        <span class=n>Log</span><span class=p>.</span><span class=na>i</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s>&quot;inSampleSize = &quot;</span> <span class=o>+</span> <span class=n>inSampleSize</span> <span class=o>+</span><span class=s>&quot;, [outWidth, outHeight] = [&quot;</span>
<a id=__codelineno-4-92 name=__codelineno-4-92></a><a href=#__codelineno-4-92><span class=linenos data-linenos="92 "></span></a>            <span class=o>+</span> <span class=n>height</span> <span class=o>+</span> <span class=s>&quot;, &quot;</span> <span class=o>+</span> <span class=n>width</span> <span class=o>+</span> <span class=s>&quot;], [reqWidth, reqHeight] = [&quot;</span> <span class=o>+</span> <span class=n>reqWidth</span> <span class=o>+</span> <span class=s>&quot;, &quot;</span> <span class=o>+</span> <span class=n>reqHeight</span> <span class=o>+</span> <span class=s>&quot;]&quot;</span><span class=p>);</span>
<a id=__codelineno-4-93 name=__codelineno-4-93></a><a href=#__codelineno-4-93><span class=linenos data-linenos="93 "></span></a>        <span class=k>return</span> <span class=n>inSampleSize</span><span class=p>;</span>
<a id=__codelineno-4-94 name=__codelineno-4-94></a><a href=#__codelineno-4-94><span class=linenos data-linenos="94 "></span></a>    <span class=p>}</span>
<a id=__codelineno-4-95 name=__codelineno-4-95></a><a href=#__codelineno-4-95><span class=linenos data-linenos="95 "></span></a><span class=p>}</span>
</code></pre></div> <h3 id=13>1.3 质量压缩<a class=headerlink href=#13 title="Anchor link to this section for reference">&para;</a></h3> <p>质量压缩只要靠<code>Bitmap.compress(CompressFormat format, int quality, OutputStream stream)</code>这个方法。quality取值为0-100，取值越高表示图片的质量越高。当然，PNG格式时会忽略质量。</p> <p>将Bitmap保存到磁盘中也是使用的该方法。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-5-1 name=__codelineno-5-1></a><a href=#__codelineno-5-1><span class=linenos data-linenos=" 1 "></span></a><span class=nd>@Nullable</span>
<a id=__codelineno-5-2 name=__codelineno-5-2></a><a href=#__codelineno-5-2><span class=linenos data-linenos=" 2 "></span></a><span class=kd>public</span> <span class=kd>static</span> <span class=n>File</span> <span class=nf>saveBitmap</span><span class=p>(</span>
<a id=__codelineno-5-3 name=__codelineno-5-3></a><a href=#__codelineno-5-3><span class=linenos data-linenos=" 3 "></span></a>        <span class=nd>@NonNull</span> <span class=n>Bitmap</span> <span class=n>bitmap</span><span class=p>,</span>
<a id=__codelineno-5-4 name=__codelineno-5-4></a><a href=#__codelineno-5-4><span class=linenos data-linenos=" 4 "></span></a>        <span class=nd>@NonNull</span> <span class=n>Bitmap</span><span class=p>.</span><span class=na>CompressFormat</span> <span class=n>format</span><span class=p>,</span>
<a id=__codelineno-5-5 name=__codelineno-5-5></a><a href=#__codelineno-5-5><span class=linenos data-linenos=" 5 "></span></a>        <span class=nd>@IntRange</span><span class=p>(</span><span class=n>from</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>to</span> <span class=o>=</span> <span class=mi>100</span><span class=p>)</span> <span class=kt>int</span> <span class=n>quality</span><span class=p>,</span>
<a id=__codelineno-5-6 name=__codelineno-5-6></a><a href=#__codelineno-5-6><span class=linenos data-linenos=" 6 "></span></a>        <span class=nd>@NonNull</span> <span class=n>File</span> <span class=n>destFile</span><span class=p>,</span>
<a id=__codelineno-5-7 name=__codelineno-5-7></a><a href=#__codelineno-5-7><span class=linenos data-linenos=" 7 "></span></a>        <span class=kt>boolean</span> <span class=n>recycle</span>
<a id=__codelineno-5-8 name=__codelineno-5-8></a><a href=#__codelineno-5-8><span class=linenos data-linenos=" 8 "></span></a><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-5-9 name=__codelineno-5-9></a><a href=#__codelineno-5-9><span class=linenos data-linenos=" 9 "></span></a>    <span class=n>ByteArrayOutputStream</span> <span class=n>baos</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ByteArrayOutputStream</span><span class=p>();</span>
<a id=__codelineno-5-10 name=__codelineno-5-10></a><a href=#__codelineno-5-10><span class=linenos data-linenos="10 "></span></a>    <span class=n>bitmap</span><span class=p>.</span><span class=na>compress</span><span class=p>(</span><span class=n>format</span><span class=p>,</span> <span class=n>quality</span><span class=p>,</span> <span class=n>baos</span><span class=p>);</span>
<a id=__codelineno-5-11 name=__codelineno-5-11></a><a href=#__codelineno-5-11><span class=linenos data-linenos="11 "></span></a>    <span class=k>try</span> <span class=p>{</span>
<a id=__codelineno-5-12 name=__codelineno-5-12></a><a href=#__codelineno-5-12><span class=linenos data-linenos="12 "></span></a>        <span class=n>FileOutputStream</span> <span class=n>fos</span> <span class=o>=</span> <span class=k>new</span> <span class=n>FileOutputStream</span><span class=p>(</span><span class=n>destFile</span><span class=p>);</span>
<a id=__codelineno-5-13 name=__codelineno-5-13></a><a href=#__codelineno-5-13><span class=linenos data-linenos="13 "></span></a>        <span class=n>fos</span><span class=p>.</span><span class=na>write</span><span class=p>(</span><span class=n>baos</span><span class=p>.</span><span class=na>toByteArray</span><span class=p>());</span>
<a id=__codelineno-5-14 name=__codelineno-5-14></a><a href=#__codelineno-5-14><span class=linenos data-linenos="14 "></span></a>        <span class=n>fos</span><span class=p>.</span><span class=na>flush</span><span class=p>();</span>
<a id=__codelineno-5-15 name=__codelineno-5-15></a><a href=#__codelineno-5-15><span class=linenos data-linenos="15 "></span></a>        <span class=n>fos</span><span class=p>.</span><span class=na>close</span><span class=p>();</span>
<a id=__codelineno-5-16 name=__codelineno-5-16></a><a href=#__codelineno-5-16><span class=linenos data-linenos="16 "></span></a>        <span class=k>if</span> <span class=p>(</span><span class=n>recycle</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>bitmap</span><span class=p>.</span><span class=na>isRecycled</span><span class=p>())</span> <span class=p>{</span>
<a id=__codelineno-5-17 name=__codelineno-5-17></a><a href=#__codelineno-5-17><span class=linenos data-linenos="17 "></span></a>            <span class=n>bitmap</span><span class=p>.</span><span class=na>recycle</span><span class=p>();</span>
<a id=__codelineno-5-18 name=__codelineno-5-18></a><a href=#__codelineno-5-18><span class=linenos data-linenos="18 "></span></a>        <span class=p>}</span>
<a id=__codelineno-5-19 name=__codelineno-5-19></a><a href=#__codelineno-5-19><span class=linenos data-linenos="19 "></span></a>        <span class=k>return</span> <span class=n>destFile</span><span class=p>;</span>
<a id=__codelineno-5-20 name=__codelineno-5-20></a><a href=#__codelineno-5-20><span class=linenos data-linenos="20 "></span></a>    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>IOException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-5-21 name=__codelineno-5-21></a><a href=#__codelineno-5-21><span class=linenos data-linenos="21 "></span></a>        <span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span>
<a id=__codelineno-5-22 name=__codelineno-5-22></a><a href=#__codelineno-5-22><span class=linenos data-linenos="22 "></span></a>    <span class=p>}</span>
<a id=__codelineno-5-23 name=__codelineno-5-23></a><a href=#__codelineno-5-23><span class=linenos data-linenos="23 "></span></a>
<a id=__codelineno-5-24 name=__codelineno-5-24></a><a href=#__codelineno-5-24><span class=linenos data-linenos="24 "></span></a>    <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-5-25 name=__codelineno-5-25></a><a href=#__codelineno-5-25><span class=linenos data-linenos="25 "></span></a><span class=p>}</span>
</code></pre></div> <h3 id=14>1.4 尺寸压缩<a class=headerlink href=#14 title="Anchor link to this section for reference">&para;</a></h3> <p>尺寸压缩就是将一张Bitmap等比缩放，然后Canvas绘制后，先获取二进制数组，然后写入到本地。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-6-1 name=__codelineno-6-1></a><a href=#__codelineno-6-1><span class=linenos data-linenos=" 1 "></span></a><span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>scale</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Bitmap</span> <span class=n>bitmap</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>File</span> <span class=n>file</span><span class=p>,</span> <span class=kt>float</span> <span class=n>scale</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-6-2 name=__codelineno-6-2></a><a href=#__codelineno-6-2><span class=linenos data-linenos=" 2 "></span></a>    <span class=kd>final</span> <span class=kt>int</span> <span class=n>bWidth</span> <span class=o>=</span> <span class=n>bitmap</span><span class=p>.</span><span class=na>getWidth</span><span class=p>();</span>
<a id=__codelineno-6-3 name=__codelineno-6-3></a><a href=#__codelineno-6-3><span class=linenos data-linenos=" 3 "></span></a>    <span class=kd>final</span> <span class=kt>int</span> <span class=n>bHeight</span> <span class=o>=</span> <span class=n>bitmap</span><span class=p>.</span><span class=na>getHeight</span><span class=p>();</span>
<a id=__codelineno-6-4 name=__codelineno-6-4></a><a href=#__codelineno-6-4><span class=linenos data-linenos=" 4 "></span></a>    <span class=kd>final</span> <span class=kt>int</span> <span class=n>newWidth</span> <span class=o>=</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span> <span class=p>(</span><span class=n>bWidth</span> <span class=o>*</span> <span class=n>scale</span><span class=p>);</span>
<a id=__codelineno-6-5 name=__codelineno-6-5></a><a href=#__codelineno-6-5><span class=linenos data-linenos=" 5 "></span></a>    <span class=kd>final</span> <span class=kt>int</span> <span class=n>newHeight</span> <span class=o>=</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span> <span class=p>(</span><span class=n>bHeight</span> <span class=o>*</span> <span class=n>scale</span><span class=p>);</span>
<a id=__codelineno-6-6 name=__codelineno-6-6></a><a href=#__codelineno-6-6><span class=linenos data-linenos=" 6 "></span></a>
<a id=__codelineno-6-7 name=__codelineno-6-7></a><a href=#__codelineno-6-7><span class=linenos data-linenos=" 7 "></span></a>    <span class=n>Bitmap</span> <span class=n>result</span> <span class=o>=</span> <span class=n>Bitmap</span><span class=p>.</span><span class=na>createBitmap</span><span class=p>(</span><span class=n>newWidth</span><span class=p>,</span> <span class=n>newHeight</span><span class=p>,</span> <span class=n>Bitmap</span><span class=p>.</span><span class=na>Config</span><span class=p>.</span><span class=na>ARGB_8888</span><span class=p>);</span>
<a id=__codelineno-6-8 name=__codelineno-6-8></a><a href=#__codelineno-6-8><span class=linenos data-linenos=" 8 "></span></a>    <span class=n>Canvas</span> <span class=n>canvas</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Canvas</span><span class=p>(</span><span class=n>result</span><span class=p>);</span>
<a id=__codelineno-6-9 name=__codelineno-6-9></a><a href=#__codelineno-6-9><span class=linenos data-linenos=" 9 "></span></a>    <span class=n>RectF</span> <span class=n>rect</span> <span class=o>=</span> <span class=k>new</span> <span class=n>RectF</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>newWidth</span><span class=p>,</span> <span class=n>newHeight</span><span class=p>);</span>
<a id=__codelineno-6-10 name=__codelineno-6-10></a><a href=#__codelineno-6-10><span class=linenos data-linenos="10 "></span></a>    <span class=n>canvas</span><span class=p>.</span><span class=na>drawBitmap</span><span class=p>(</span><span class=n>bitmap</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=n>rect</span><span class=p>,</span> <span class=kc>null</span><span class=p>);</span>
<a id=__codelineno-6-11 name=__codelineno-6-11></a><a href=#__codelineno-6-11><span class=linenos data-linenos="11 "></span></a>
<a id=__codelineno-6-12 name=__codelineno-6-12></a><a href=#__codelineno-6-12><span class=linenos data-linenos="12 "></span></a>    <span class=n>saveBitmap</span><span class=p>(</span><span class=n>result</span><span class=p>,</span> <span class=n>Bitmap</span><span class=p>.</span><span class=na>CompressFormat</span><span class=p>.</span><span class=na>JPEG</span><span class=p>,</span> <span class=mi>100</span><span class=p>,</span> <span class=n>file</span><span class=p>,</span> <span class=kc>false</span><span class=p>);</span>
<a id=__codelineno-6-13 name=__codelineno-6-13></a><a href=#__codelineno-6-13><span class=linenos data-linenos="13 "></span></a><span class=p>}</span>
</code></pre></div> <h2 id=2-bitmap>2 Bitmap的缓存<a class=headerlink href=#2-bitmap title="Anchor link to this section for reference">&para;</a></h2> <p>来自官方的建议：<a href=https://developer.android.com/topic/performance/graphics/cache-bitmap.html>https://developer.android.com/topic/performance/graphics/cache-bitmap.html</a></p> <p>Bitmap的加载顺序：内存 -&gt; 磁盘 -&gt; 网络获取<br> Bitmap的写入顺序：网络 -&gt; 内存 -&gt; 磁盘</p> <p>目前常用的缓存算法是LRU(Least Recently Used)，也就是最近最少使用算法。它的核心思想是当缓存满时，会优先淘汰那些最近最少使用的缓存对象。</p> <p>采用LRU算法的缓存有两种：<code>LruCache</code>以及<code>DiskLruCache</code>，前者用于实现内存缓存，后者充当了存储设备缓存。</p> <h3 id=21-lrucache>2.1 LruCache<a class=headerlink href=#21-lrucache title="Anchor link to this section for reference">&para;</a></h3> <p><code>LruCache</code>是Android 3.1提供的一个缓存类，通过v4兼容包可以兼容早期的Android版本。</p> <p><code>LruCache</code>是一个泛类型，它内部采用了一个<a href=/java/java-collections/#4-linkedhashmap>LinkedHashMap</a>以强引用的方式存储外界的缓存对象，其提供了<code>get</code>和<code>put</code>方法来完成缓存的获取和添加操作。当缓存满时，它会按照算法移除缓存对象，然后添加新的缓存对象。</p> <p><code>LruCache</code>的实现比较简单 <div class=highlight><pre><span></span><code><a id=__codelineno-7-1 name=__codelineno-7-1></a><a href=#__codelineno-7-1><span class=linenos data-linenos="  1 "></span></a><span class=kd>public</span> <span class=kd>class</span> <span class=nc>LruCache</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span> <span class=n>V</span><span class=o>&gt;</span> <span class=p>{</span>
<a id=__codelineno-7-2 name=__codelineno-7-2></a><a href=#__codelineno-7-2><span class=linenos data-linenos="  2 "></span></a>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>LinkedHashMap</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span> <span class=n>V</span><span class=o>&gt;</span> <span class=n>map</span><span class=p>;</span>
<a id=__codelineno-7-3 name=__codelineno-7-3></a><a href=#__codelineno-7-3><span class=linenos data-linenos="  3 "></span></a>
<a id=__codelineno-7-4 name=__codelineno-7-4></a><a href=#__codelineno-7-4><span class=linenos data-linenos="  4 "></span></a>    <span class=cm>/** Size of this cache in units. Not necessarily the number of elements. */</span>
<a id=__codelineno-7-5 name=__codelineno-7-5></a><a href=#__codelineno-7-5><span class=linenos data-linenos="  5 "></span></a>    <span class=kd>private</span> <span class=kt>int</span> <span class=n>size</span><span class=p>;</span>
<a id=__codelineno-7-6 name=__codelineno-7-6></a><a href=#__codelineno-7-6><span class=linenos data-linenos="  6 "></span></a>    <span class=kd>private</span> <span class=kt>int</span> <span class=n>maxSize</span><span class=p>;</span>
<a id=__codelineno-7-7 name=__codelineno-7-7></a><a href=#__codelineno-7-7><span class=linenos data-linenos="  7 "></span></a>
<a id=__codelineno-7-8 name=__codelineno-7-8></a><a href=#__codelineno-7-8><span class=linenos data-linenos="  8 "></span></a>    <span class=kd>private</span> <span class=kt>int</span> <span class=n>putCount</span><span class=p>;</span>
<a id=__codelineno-7-9 name=__codelineno-7-9></a><a href=#__codelineno-7-9><span class=linenos data-linenos="  9 "></span></a>    <span class=kd>private</span> <span class=kt>int</span> <span class=n>createCount</span><span class=p>;</span>
<a id=__codelineno-7-10 name=__codelineno-7-10></a><a href=#__codelineno-7-10><span class=linenos data-linenos=" 10 "></span></a>    <span class=kd>private</span> <span class=kt>int</span> <span class=n>evictionCount</span><span class=p>;</span>
<a id=__codelineno-7-11 name=__codelineno-7-11></a><a href=#__codelineno-7-11><span class=linenos data-linenos=" 11 "></span></a>    <span class=kd>private</span> <span class=kt>int</span> <span class=n>hitCount</span><span class=p>;</span>
<a id=__codelineno-7-12 name=__codelineno-7-12></a><a href=#__codelineno-7-12><span class=linenos data-linenos=" 12 "></span></a>    <span class=kd>private</span> <span class=kt>int</span> <span class=n>missCount</span><span class=p>;</span>
<a id=__codelineno-7-13 name=__codelineno-7-13></a><a href=#__codelineno-7-13><span class=linenos data-linenos=" 13 "></span></a>
<a id=__codelineno-7-14 name=__codelineno-7-14></a><a href=#__codelineno-7-14><span class=linenos data-linenos=" 14 "></span></a>    <span class=cm>/**</span>
<a id=__codelineno-7-15 name=__codelineno-7-15></a><a href=#__codelineno-7-15><span class=linenos data-linenos=" 15 "></span></a><span class=cm>     * @param maxSize for caches that do not override {@link #sizeOf}, this is</span>
<a id=__codelineno-7-16 name=__codelineno-7-16></a><a href=#__codelineno-7-16><span class=linenos data-linenos=" 16 "></span></a><span class=cm>     *     the maximum number of entries in the cache. For all other caches,</span>
<a id=__codelineno-7-17 name=__codelineno-7-17></a><a href=#__codelineno-7-17><span class=linenos data-linenos=" 17 "></span></a><span class=cm>     *     this is the maximum sum of the sizes of the entries in this cache.</span>
<a id=__codelineno-7-18 name=__codelineno-7-18></a><a href=#__codelineno-7-18><span class=linenos data-linenos=" 18 "></span></a><span class=cm>     */</span>
<a id=__codelineno-7-19 name=__codelineno-7-19></a><a href=#__codelineno-7-19><span class=linenos data-linenos=" 19 "></span></a>    <span class=kd>public</span> <span class=nf>LruCache</span><span class=p>(</span><span class=kt>int</span> <span class=n>maxSize</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-7-20 name=__codelineno-7-20></a><a href=#__codelineno-7-20><span class=linenos data-linenos=" 20 "></span></a>        <span class=k>if</span> <span class=p>(</span><span class=n>maxSize</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-7-21 name=__codelineno-7-21></a><a href=#__codelineno-7-21><span class=linenos data-linenos=" 21 "></span></a>            <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&quot;maxSize &lt;= 0&quot;</span><span class=p>);</span>
<a id=__codelineno-7-22 name=__codelineno-7-22></a><a href=#__codelineno-7-22><span class=linenos data-linenos=" 22 "></span></a>        <span class=p>}</span>
<a id=__codelineno-7-23 name=__codelineno-7-23></a><a href=#__codelineno-7-23><span class=linenos data-linenos=" 23 "></span></a>        <span class=k>this</span><span class=p>.</span><span class=na>maxSize</span> <span class=o>=</span> <span class=n>maxSize</span><span class=p>;</span>
<a id=__codelineno-7-24 name=__codelineno-7-24></a><a href=#__codelineno-7-24><span class=linenos data-linenos=" 24 "></span></a>        <span class=k>this</span><span class=p>.</span><span class=na>map</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LinkedHashMap</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span> <span class=n>V</span><span class=o>&gt;</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=mf>0.75f</span><span class=p>,</span> <span class=kc>true</span><span class=p>);</span>
<a id=__codelineno-7-25 name=__codelineno-7-25></a><a href=#__codelineno-7-25><span class=linenos data-linenos=" 25 "></span></a>    <span class=p>}</span>
<a id=__codelineno-7-26 name=__codelineno-7-26></a><a href=#__codelineno-7-26><span class=linenos data-linenos=" 26 "></span></a>
<a id=__codelineno-7-27 name=__codelineno-7-27></a><a href=#__codelineno-7-27><span class=linenos data-linenos=" 27 "></span></a>    <span class=cm>/**</span>
<a id=__codelineno-7-28 name=__codelineno-7-28></a><a href=#__codelineno-7-28><span class=linenos data-linenos=" 28 "></span></a><span class=cm>     * Sets the size of the cache.</span>
<a id=__codelineno-7-29 name=__codelineno-7-29></a><a href=#__codelineno-7-29><span class=linenos data-linenos=" 29 "></span></a><span class=cm>     *</span>
<a id=__codelineno-7-30 name=__codelineno-7-30></a><a href=#__codelineno-7-30><span class=linenos data-linenos=" 30 "></span></a><span class=cm>     * @param maxSize The new maximum size.</span>
<a id=__codelineno-7-31 name=__codelineno-7-31></a><a href=#__codelineno-7-31><span class=linenos data-linenos=" 31 "></span></a><span class=cm>     */</span>
<a id=__codelineno-7-32 name=__codelineno-7-32></a><a href=#__codelineno-7-32><span class=linenos data-linenos=" 32 "></span></a>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>resize</span><span class=p>(</span><span class=kt>int</span> <span class=n>maxSize</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-7-33 name=__codelineno-7-33></a><a href=#__codelineno-7-33><span class=linenos data-linenos=" 33 "></span></a>        <span class=k>if</span> <span class=p>(</span><span class=n>maxSize</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-7-34 name=__codelineno-7-34></a><a href=#__codelineno-7-34><span class=linenos data-linenos=" 34 "></span></a>            <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&quot;maxSize &lt;= 0&quot;</span><span class=p>);</span>
<a id=__codelineno-7-35 name=__codelineno-7-35></a><a href=#__codelineno-7-35><span class=linenos data-linenos=" 35 "></span></a>        <span class=p>}</span>
<a id=__codelineno-7-36 name=__codelineno-7-36></a><a href=#__codelineno-7-36><span class=linenos data-linenos=" 36 "></span></a>
<a id=__codelineno-7-37 name=__codelineno-7-37></a><a href=#__codelineno-7-37><span class=linenos data-linenos=" 37 "></span></a>        <span class=kd>synchronized</span> <span class=p>(</span><span class=k>this</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-7-38 name=__codelineno-7-38></a><a href=#__codelineno-7-38><span class=linenos data-linenos=" 38 "></span></a>            <span class=k>this</span><span class=p>.</span><span class=na>maxSize</span> <span class=o>=</span> <span class=n>maxSize</span><span class=p>;</span>
<a id=__codelineno-7-39 name=__codelineno-7-39></a><a href=#__codelineno-7-39><span class=linenos data-linenos=" 39 "></span></a>        <span class=p>}</span>
<a id=__codelineno-7-40 name=__codelineno-7-40></a><a href=#__codelineno-7-40><span class=linenos data-linenos=" 40 "></span></a>        <span class=n>trimToSize</span><span class=p>(</span><span class=n>maxSize</span><span class=p>);</span>
<a id=__codelineno-7-41 name=__codelineno-7-41></a><a href=#__codelineno-7-41><span class=linenos data-linenos=" 41 "></span></a>    <span class=p>}</span>
<a id=__codelineno-7-42 name=__codelineno-7-42></a><a href=#__codelineno-7-42><span class=linenos data-linenos=" 42 "></span></a>
<a id=__codelineno-7-43 name=__codelineno-7-43></a><a href=#__codelineno-7-43><span class=linenos data-linenos=" 43 "></span></a>    <span class=cm>/**</span>
<a id=__codelineno-7-44 name=__codelineno-7-44></a><a href=#__codelineno-7-44><span class=linenos data-linenos=" 44 "></span></a><span class=cm>     * Returns the value for {@code key} if it exists in the cache or can be</span>
<a id=__codelineno-7-45 name=__codelineno-7-45></a><a href=#__codelineno-7-45><span class=linenos data-linenos=" 45 "></span></a><span class=cm>     * created by {@code #create}. If a value was returned, it is moved to the</span>
<a id=__codelineno-7-46 name=__codelineno-7-46></a><a href=#__codelineno-7-46><span class=linenos data-linenos=" 46 "></span></a><span class=cm>     * head of the queue. This returns null if a value is not cached and cannot</span>
<a id=__codelineno-7-47 name=__codelineno-7-47></a><a href=#__codelineno-7-47><span class=linenos data-linenos=" 47 "></span></a><span class=cm>     * be created.</span>
<a id=__codelineno-7-48 name=__codelineno-7-48></a><a href=#__codelineno-7-48><span class=linenos data-linenos=" 48 "></span></a><span class=cm>     */</span>
<a id=__codelineno-7-49 name=__codelineno-7-49></a><a href=#__codelineno-7-49><span class=linenos data-linenos=" 49 "></span></a>    <span class=kd>public</span> <span class=kd>final</span> <span class=n>V</span> <span class=nf>get</span><span class=p>(</span><span class=n>K</span> <span class=n>key</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-7-50 name=__codelineno-7-50></a><a href=#__codelineno-7-50><span class=linenos data-linenos=" 50 "></span></a>        <span class=k>if</span> <span class=p>(</span><span class=n>key</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-7-51 name=__codelineno-7-51></a><a href=#__codelineno-7-51><span class=linenos data-linenos=" 51 "></span></a>            <span class=k>throw</span> <span class=k>new</span> <span class=n>NullPointerException</span><span class=p>(</span><span class=s>&quot;key == null&quot;</span><span class=p>);</span>
<a id=__codelineno-7-52 name=__codelineno-7-52></a><a href=#__codelineno-7-52><span class=linenos data-linenos=" 52 "></span></a>        <span class=p>}</span>
<a id=__codelineno-7-53 name=__codelineno-7-53></a><a href=#__codelineno-7-53><span class=linenos data-linenos=" 53 "></span></a>
<a id=__codelineno-7-54 name=__codelineno-7-54></a><a href=#__codelineno-7-54><span class=linenos data-linenos=" 54 "></span></a>        <span class=n>V</span> <span class=n>mapValue</span><span class=p>;</span>
<a id=__codelineno-7-55 name=__codelineno-7-55></a><a href=#__codelineno-7-55><span class=linenos data-linenos=" 55 "></span></a>        <span class=kd>synchronized</span> <span class=p>(</span><span class=k>this</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-7-56 name=__codelineno-7-56></a><a href=#__codelineno-7-56><span class=linenos data-linenos=" 56 "></span></a>            <span class=n>mapValue</span> <span class=o>=</span> <span class=n>map</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
<a id=__codelineno-7-57 name=__codelineno-7-57></a><a href=#__codelineno-7-57><span class=linenos data-linenos=" 57 "></span></a>            <span class=k>if</span> <span class=p>(</span><span class=n>mapValue</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-7-58 name=__codelineno-7-58></a><a href=#__codelineno-7-58><span class=linenos data-linenos=" 58 "></span></a>                <span class=n>hitCount</span><span class=o>++</span><span class=p>;</span>
<a id=__codelineno-7-59 name=__codelineno-7-59></a><a href=#__codelineno-7-59><span class=linenos data-linenos=" 59 "></span></a>                <span class=k>return</span> <span class=n>mapValue</span><span class=p>;</span>
<a id=__codelineno-7-60 name=__codelineno-7-60></a><a href=#__codelineno-7-60><span class=linenos data-linenos=" 60 "></span></a>            <span class=p>}</span>
<a id=__codelineno-7-61 name=__codelineno-7-61></a><a href=#__codelineno-7-61><span class=linenos data-linenos=" 61 "></span></a>            <span class=n>missCount</span><span class=o>++</span><span class=p>;</span>
<a id=__codelineno-7-62 name=__codelineno-7-62></a><a href=#__codelineno-7-62><span class=linenos data-linenos=" 62 "></span></a>        <span class=p>}</span>
<a id=__codelineno-7-63 name=__codelineno-7-63></a><a href=#__codelineno-7-63><span class=linenos data-linenos=" 63 "></span></a>
<a id=__codelineno-7-64 name=__codelineno-7-64></a><a href=#__codelineno-7-64><span class=linenos data-linenos=" 64 "></span></a>        <span class=cm>/*</span>
<a id=__codelineno-7-65 name=__codelineno-7-65></a><a href=#__codelineno-7-65><span class=linenos data-linenos=" 65 "></span></a><span class=cm>         * Attempt to create a value. This may take a long time, and the map</span>
<a id=__codelineno-7-66 name=__codelineno-7-66></a><a href=#__codelineno-7-66><span class=linenos data-linenos=" 66 "></span></a><span class=cm>         * may be different when create() returns. If a conflicting value was</span>
<a id=__codelineno-7-67 name=__codelineno-7-67></a><a href=#__codelineno-7-67><span class=linenos data-linenos=" 67 "></span></a><span class=cm>         * added to the map while create() was working, we leave that value in</span>
<a id=__codelineno-7-68 name=__codelineno-7-68></a><a href=#__codelineno-7-68><span class=linenos data-linenos=" 68 "></span></a><span class=cm>         * the map and release the created value.</span>
<a id=__codelineno-7-69 name=__codelineno-7-69></a><a href=#__codelineno-7-69><span class=linenos data-linenos=" 69 "></span></a><span class=cm>         */</span>
<a id=__codelineno-7-70 name=__codelineno-7-70></a><a href=#__codelineno-7-70><span class=linenos data-linenos=" 70 "></span></a>
<a id=__codelineno-7-71 name=__codelineno-7-71></a><a href=#__codelineno-7-71><span class=linenos data-linenos=" 71 "></span></a>        <span class=n>V</span> <span class=n>createdValue</span> <span class=o>=</span> <span class=n>create</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
<a id=__codelineno-7-72 name=__codelineno-7-72></a><a href=#__codelineno-7-72><span class=linenos data-linenos=" 72 "></span></a>        <span class=k>if</span> <span class=p>(</span><span class=n>createdValue</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-7-73 name=__codelineno-7-73></a><a href=#__codelineno-7-73><span class=linenos data-linenos=" 73 "></span></a>            <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-7-74 name=__codelineno-7-74></a><a href=#__codelineno-7-74><span class=linenos data-linenos=" 74 "></span></a>        <span class=p>}</span>
<a id=__codelineno-7-75 name=__codelineno-7-75></a><a href=#__codelineno-7-75><span class=linenos data-linenos=" 75 "></span></a>
<a id=__codelineno-7-76 name=__codelineno-7-76></a><a href=#__codelineno-7-76><span class=linenos data-linenos=" 76 "></span></a>        <span class=kd>synchronized</span> <span class=p>(</span><span class=k>this</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-7-77 name=__codelineno-7-77></a><a href=#__codelineno-7-77><span class=linenos data-linenos=" 77 "></span></a>            <span class=n>createCount</span><span class=o>++</span><span class=p>;</span>
<a id=__codelineno-7-78 name=__codelineno-7-78></a><a href=#__codelineno-7-78><span class=linenos data-linenos=" 78 "></span></a>            <span class=n>mapValue</span> <span class=o>=</span> <span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>createdValue</span><span class=p>);</span>
<a id=__codelineno-7-79 name=__codelineno-7-79></a><a href=#__codelineno-7-79><span class=linenos data-linenos=" 79 "></span></a>
<a id=__codelineno-7-80 name=__codelineno-7-80></a><a href=#__codelineno-7-80><span class=linenos data-linenos=" 80 "></span></a>            <span class=k>if</span> <span class=p>(</span><span class=n>mapValue</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-7-81 name=__codelineno-7-81></a><a href=#__codelineno-7-81><span class=linenos data-linenos=" 81 "></span></a>                <span class=c1>// There was a conflict so undo that last put</span>
<a id=__codelineno-7-82 name=__codelineno-7-82></a><a href=#__codelineno-7-82><span class=linenos data-linenos=" 82 "></span></a>                <span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>mapValue</span><span class=p>);</span>
<a id=__codelineno-7-83 name=__codelineno-7-83></a><a href=#__codelineno-7-83><span class=linenos data-linenos=" 83 "></span></a>            <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
<a id=__codelineno-7-84 name=__codelineno-7-84></a><a href=#__codelineno-7-84><span class=linenos data-linenos=" 84 "></span></a>                <span class=n>size</span> <span class=o>+=</span> <span class=n>safeSizeOf</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>createdValue</span><span class=p>);</span>
<a id=__codelineno-7-85 name=__codelineno-7-85></a><a href=#__codelineno-7-85><span class=linenos data-linenos=" 85 "></span></a>            <span class=p>}</span>
<a id=__codelineno-7-86 name=__codelineno-7-86></a><a href=#__codelineno-7-86><span class=linenos data-linenos=" 86 "></span></a>        <span class=p>}</span>
<a id=__codelineno-7-87 name=__codelineno-7-87></a><a href=#__codelineno-7-87><span class=linenos data-linenos=" 87 "></span></a>
<a id=__codelineno-7-88 name=__codelineno-7-88></a><a href=#__codelineno-7-88><span class=linenos data-linenos=" 88 "></span></a>        <span class=k>if</span> <span class=p>(</span><span class=n>mapValue</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-7-89 name=__codelineno-7-89></a><a href=#__codelineno-7-89><span class=linenos data-linenos=" 89 "></span></a>            <span class=n>entryRemoved</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span> <span class=n>key</span><span class=p>,</span> <span class=n>createdValue</span><span class=p>,</span> <span class=n>mapValue</span><span class=p>);</span>
<a id=__codelineno-7-90 name=__codelineno-7-90></a><a href=#__codelineno-7-90><span class=linenos data-linenos=" 90 "></span></a>            <span class=k>return</span> <span class=n>mapValue</span><span class=p>;</span>
<a id=__codelineno-7-91 name=__codelineno-7-91></a><a href=#__codelineno-7-91><span class=linenos data-linenos=" 91 "></span></a>        <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
<a id=__codelineno-7-92 name=__codelineno-7-92></a><a href=#__codelineno-7-92><span class=linenos data-linenos=" 92 "></span></a>            <span class=n>trimToSize</span><span class=p>(</span><span class=n>maxSize</span><span class=p>);</span>
<a id=__codelineno-7-93 name=__codelineno-7-93></a><a href=#__codelineno-7-93><span class=linenos data-linenos=" 93 "></span></a>            <span class=k>return</span> <span class=n>createdValue</span><span class=p>;</span>
<a id=__codelineno-7-94 name=__codelineno-7-94></a><a href=#__codelineno-7-94><span class=linenos data-linenos=" 94 "></span></a>        <span class=p>}</span>
<a id=__codelineno-7-95 name=__codelineno-7-95></a><a href=#__codelineno-7-95><span class=linenos data-linenos=" 95 "></span></a>    <span class=p>}</span>
<a id=__codelineno-7-96 name=__codelineno-7-96></a><a href=#__codelineno-7-96><span class=linenos data-linenos=" 96 "></span></a>
<a id=__codelineno-7-97 name=__codelineno-7-97></a><a href=#__codelineno-7-97><span class=linenos data-linenos=" 97 "></span></a>    <span class=cm>/**</span>
<a id=__codelineno-7-98 name=__codelineno-7-98></a><a href=#__codelineno-7-98><span class=linenos data-linenos=" 98 "></span></a><span class=cm>     * Caches {@code value} for {@code key}. The value is moved to the head of</span>
<a id=__codelineno-7-99 name=__codelineno-7-99></a><a href=#__codelineno-7-99><span class=linenos data-linenos=" 99 "></span></a><span class=cm>     * the queue.</span>
<a id=__codelineno-7-100 name=__codelineno-7-100></a><a href=#__codelineno-7-100><span class=linenos data-linenos="100 "></span></a><span class=cm>     *</span>
<a id=__codelineno-7-101 name=__codelineno-7-101></a><a href=#__codelineno-7-101><span class=linenos data-linenos="101 "></span></a><span class=cm>     * @return the previous value mapped by {@code key}.</span>
<a id=__codelineno-7-102 name=__codelineno-7-102></a><a href=#__codelineno-7-102><span class=linenos data-linenos="102 "></span></a><span class=cm>     */</span>
<a id=__codelineno-7-103 name=__codelineno-7-103></a><a href=#__codelineno-7-103><span class=linenos data-linenos="103 "></span></a>    <span class=kd>public</span> <span class=kd>final</span> <span class=n>V</span> <span class=nf>put</span><span class=p>(</span><span class=n>K</span> <span class=n>key</span><span class=p>,</span> <span class=n>V</span> <span class=n>value</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-7-104 name=__codelineno-7-104></a><a href=#__codelineno-7-104><span class=linenos data-linenos="104 "></span></a>        <span class=k>if</span> <span class=p>(</span><span class=n>key</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=n>value</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-7-105 name=__codelineno-7-105></a><a href=#__codelineno-7-105><span class=linenos data-linenos="105 "></span></a>            <span class=k>throw</span> <span class=k>new</span> <span class=n>NullPointerException</span><span class=p>(</span><span class=s>&quot;key == null || value == null&quot;</span><span class=p>);</span>
<a id=__codelineno-7-106 name=__codelineno-7-106></a><a href=#__codelineno-7-106><span class=linenos data-linenos="106 "></span></a>        <span class=p>}</span>
<a id=__codelineno-7-107 name=__codelineno-7-107></a><a href=#__codelineno-7-107><span class=linenos data-linenos="107 "></span></a>
<a id=__codelineno-7-108 name=__codelineno-7-108></a><a href=#__codelineno-7-108><span class=linenos data-linenos="108 "></span></a>        <span class=n>V</span> <span class=n>previous</span><span class=p>;</span>
<a id=__codelineno-7-109 name=__codelineno-7-109></a><a href=#__codelineno-7-109><span class=linenos data-linenos="109 "></span></a>        <span class=kd>synchronized</span> <span class=p>(</span><span class=k>this</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-7-110 name=__codelineno-7-110></a><a href=#__codelineno-7-110><span class=linenos data-linenos="110 "></span></a>            <span class=n>putCount</span><span class=o>++</span><span class=p>;</span>
<a id=__codelineno-7-111 name=__codelineno-7-111></a><a href=#__codelineno-7-111><span class=linenos data-linenos="111 "></span></a>            <span class=n>size</span> <span class=o>+=</span> <span class=n>safeSizeOf</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>value</span><span class=p>);</span>
<a id=__codelineno-7-112 name=__codelineno-7-112></a><a href=#__codelineno-7-112><span class=linenos data-linenos="112 "></span></a>            <span class=n>previous</span> <span class=o>=</span> <span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>value</span><span class=p>);</span>
<a id=__codelineno-7-113 name=__codelineno-7-113></a><a href=#__codelineno-7-113><span class=linenos data-linenos="113 "></span></a>            <span class=k>if</span> <span class=p>(</span><span class=n>previous</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-7-114 name=__codelineno-7-114></a><a href=#__codelineno-7-114><span class=linenos data-linenos="114 "></span></a>                <span class=n>size</span> <span class=o>-=</span> <span class=n>safeSizeOf</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>previous</span><span class=p>);</span>
<a id=__codelineno-7-115 name=__codelineno-7-115></a><a href=#__codelineno-7-115><span class=linenos data-linenos="115 "></span></a>            <span class=p>}</span>
<a id=__codelineno-7-116 name=__codelineno-7-116></a><a href=#__codelineno-7-116><span class=linenos data-linenos="116 "></span></a>        <span class=p>}</span>
<a id=__codelineno-7-117 name=__codelineno-7-117></a><a href=#__codelineno-7-117><span class=linenos data-linenos="117 "></span></a>
<a id=__codelineno-7-118 name=__codelineno-7-118></a><a href=#__codelineno-7-118><span class=linenos data-linenos="118 "></span></a>        <span class=k>if</span> <span class=p>(</span><span class=n>previous</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-7-119 name=__codelineno-7-119></a><a href=#__codelineno-7-119><span class=linenos data-linenos="119 "></span></a>            <span class=n>entryRemoved</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span> <span class=n>key</span><span class=p>,</span> <span class=n>previous</span><span class=p>,</span> <span class=n>value</span><span class=p>);</span>
<a id=__codelineno-7-120 name=__codelineno-7-120></a><a href=#__codelineno-7-120><span class=linenos data-linenos="120 "></span></a>        <span class=p>}</span>
<a id=__codelineno-7-121 name=__codelineno-7-121></a><a href=#__codelineno-7-121><span class=linenos data-linenos="121 "></span></a>
<a id=__codelineno-7-122 name=__codelineno-7-122></a><a href=#__codelineno-7-122><span class=linenos data-linenos="122 "></span></a>        <span class=n>trimToSize</span><span class=p>(</span><span class=n>maxSize</span><span class=p>);</span>
<a id=__codelineno-7-123 name=__codelineno-7-123></a><a href=#__codelineno-7-123><span class=linenos data-linenos="123 "></span></a>        <span class=k>return</span> <span class=n>previous</span><span class=p>;</span>
<a id=__codelineno-7-124 name=__codelineno-7-124></a><a href=#__codelineno-7-124><span class=linenos data-linenos="124 "></span></a>    <span class=p>}</span>
<a id=__codelineno-7-125 name=__codelineno-7-125></a><a href=#__codelineno-7-125><span class=linenos data-linenos="125 "></span></a>
<a id=__codelineno-7-126 name=__codelineno-7-126></a><a href=#__codelineno-7-126><span class=linenos data-linenos="126 "></span></a>    <span class=cm>/**</span>
<a id=__codelineno-7-127 name=__codelineno-7-127></a><a href=#__codelineno-7-127><span class=linenos data-linenos="127 "></span></a><span class=cm>     * Remove the eldest entries until the total of remaining entries is at or</span>
<a id=__codelineno-7-128 name=__codelineno-7-128></a><a href=#__codelineno-7-128><span class=linenos data-linenos="128 "></span></a><span class=cm>     * below the requested size.</span>
<a id=__codelineno-7-129 name=__codelineno-7-129></a><a href=#__codelineno-7-129><span class=linenos data-linenos="129 "></span></a><span class=cm>     *</span>
<a id=__codelineno-7-130 name=__codelineno-7-130></a><a href=#__codelineno-7-130><span class=linenos data-linenos="130 "></span></a><span class=cm>     * @param maxSize the maximum size of the cache before returning. May be -1</span>
<a id=__codelineno-7-131 name=__codelineno-7-131></a><a href=#__codelineno-7-131><span class=linenos data-linenos="131 "></span></a><span class=cm>     *            to evict even 0-sized elements.</span>
<a id=__codelineno-7-132 name=__codelineno-7-132></a><a href=#__codelineno-7-132><span class=linenos data-linenos="132 "></span></a><span class=cm>     */</span>
<a id=__codelineno-7-133 name=__codelineno-7-133></a><a href=#__codelineno-7-133><span class=linenos data-linenos="133 "></span></a>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>trimToSize</span><span class=p>(</span><span class=kt>int</span> <span class=n>maxSize</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-7-134 name=__codelineno-7-134></a><a href=#__codelineno-7-134><span class=linenos data-linenos="134 "></span></a>        <span class=k>while</span> <span class=p>(</span><span class=kc>true</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-7-135 name=__codelineno-7-135></a><a href=#__codelineno-7-135><span class=linenos data-linenos="135 "></span></a>            <span class=n>K</span> <span class=n>key</span><span class=p>;</span>
<a id=__codelineno-7-136 name=__codelineno-7-136></a><a href=#__codelineno-7-136><span class=linenos data-linenos="136 "></span></a>            <span class=n>V</span> <span class=n>value</span><span class=p>;</span>
<a id=__codelineno-7-137 name=__codelineno-7-137></a><a href=#__codelineno-7-137><span class=linenos data-linenos="137 "></span></a>            <span class=kd>synchronized</span> <span class=p>(</span><span class=k>this</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-7-138 name=__codelineno-7-138></a><a href=#__codelineno-7-138><span class=linenos data-linenos="138 "></span></a>                <span class=k>if</span> <span class=p>(</span><span class=n>size</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=o>||</span> <span class=p>(</span><span class=n>map</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>()</span> <span class=o>&amp;&amp;</span> <span class=n>size</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-7-139 name=__codelineno-7-139></a><a href=#__codelineno-7-139><span class=linenos data-linenos="139 "></span></a>                    <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=p>(</span><span class=n>getClass</span><span class=p>().</span><span class=na>getName</span><span class=p>()</span>
<a id=__codelineno-7-140 name=__codelineno-7-140></a><a href=#__codelineno-7-140><span class=linenos data-linenos="140 "></span></a>                            <span class=o>+</span> <span class=s>&quot;.sizeOf() is reporting inconsistent results!&quot;</span><span class=p>);</span>
<a id=__codelineno-7-141 name=__codelineno-7-141></a><a href=#__codelineno-7-141><span class=linenos data-linenos="141 "></span></a>                <span class=p>}</span>
<a id=__codelineno-7-142 name=__codelineno-7-142></a><a href=#__codelineno-7-142><span class=linenos data-linenos="142 "></span></a>
<a id=__codelineno-7-143 name=__codelineno-7-143></a><a href=#__codelineno-7-143><span class=linenos data-linenos="143 "></span></a>                <span class=k>if</span> <span class=p>(</span><span class=n>size</span> <span class=o>&lt;=</span> <span class=n>maxSize</span> <span class=o>||</span> <span class=n>map</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span> <span class=p>{</span>
<a id=__codelineno-7-144 name=__codelineno-7-144></a><a href=#__codelineno-7-144><span class=linenos data-linenos="144 "></span></a>                    <span class=k>break</span><span class=p>;</span>
<a id=__codelineno-7-145 name=__codelineno-7-145></a><a href=#__codelineno-7-145><span class=linenos data-linenos="145 "></span></a>                <span class=p>}</span>
<a id=__codelineno-7-146 name=__codelineno-7-146></a><a href=#__codelineno-7-146><span class=linenos data-linenos="146 "></span></a>
<a id=__codelineno-7-147 name=__codelineno-7-147></a><a href=#__codelineno-7-147><span class=linenos data-linenos="147 "></span></a>                <span class=n>Map</span><span class=p>.</span><span class=na>Entry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span> <span class=n>V</span><span class=o>&gt;</span> <span class=n>toEvict</span> <span class=o>=</span> <span class=n>map</span><span class=p>.</span><span class=na>entrySet</span><span class=p>().</span><span class=na>iterator</span><span class=p>().</span><span class=na>next</span><span class=p>();</span>
<a id=__codelineno-7-148 name=__codelineno-7-148></a><a href=#__codelineno-7-148><span class=linenos data-linenos="148 "></span></a>                <span class=n>key</span> <span class=o>=</span> <span class=n>toEvict</span><span class=p>.</span><span class=na>getKey</span><span class=p>();</span>
<a id=__codelineno-7-149 name=__codelineno-7-149></a><a href=#__codelineno-7-149><span class=linenos data-linenos="149 "></span></a>                <span class=n>value</span> <span class=o>=</span> <span class=n>toEvict</span><span class=p>.</span><span class=na>getValue</span><span class=p>();</span>
<a id=__codelineno-7-150 name=__codelineno-7-150></a><a href=#__codelineno-7-150><span class=linenos data-linenos="150 "></span></a>                <span class=n>map</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
<a id=__codelineno-7-151 name=__codelineno-7-151></a><a href=#__codelineno-7-151><span class=linenos data-linenos="151 "></span></a>                <span class=n>size</span> <span class=o>-=</span> <span class=n>safeSizeOf</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>value</span><span class=p>);</span>
<a id=__codelineno-7-152 name=__codelineno-7-152></a><a href=#__codelineno-7-152><span class=linenos data-linenos="152 "></span></a>                <span class=n>evictionCount</span><span class=o>++</span><span class=p>;</span>
<a id=__codelineno-7-153 name=__codelineno-7-153></a><a href=#__codelineno-7-153><span class=linenos data-linenos="153 "></span></a>            <span class=p>}</span>
<a id=__codelineno-7-154 name=__codelineno-7-154></a><a href=#__codelineno-7-154><span class=linenos data-linenos="154 "></span></a>
<a id=__codelineno-7-155 name=__codelineno-7-155></a><a href=#__codelineno-7-155><span class=linenos data-linenos="155 "></span></a>            <span class=n>entryRemoved</span><span class=p>(</span><span class=kc>true</span><span class=p>,</span> <span class=n>key</span><span class=p>,</span> <span class=n>value</span><span class=p>,</span> <span class=kc>null</span><span class=p>);</span>
<a id=__codelineno-7-156 name=__codelineno-7-156></a><a href=#__codelineno-7-156><span class=linenos data-linenos="156 "></span></a>        <span class=p>}</span>
<a id=__codelineno-7-157 name=__codelineno-7-157></a><a href=#__codelineno-7-157><span class=linenos data-linenos="157 "></span></a>    <span class=p>}</span>
<a id=__codelineno-7-158 name=__codelineno-7-158></a><a href=#__codelineno-7-158><span class=linenos data-linenos="158 "></span></a>
<a id=__codelineno-7-159 name=__codelineno-7-159></a><a href=#__codelineno-7-159><span class=linenos data-linenos="159 "></span></a>    <span class=cm>/**</span>
<a id=__codelineno-7-160 name=__codelineno-7-160></a><a href=#__codelineno-7-160><span class=linenos data-linenos="160 "></span></a><span class=cm>     * Removes the entry for {@code key} if it exists.</span>
<a id=__codelineno-7-161 name=__codelineno-7-161></a><a href=#__codelineno-7-161><span class=linenos data-linenos="161 "></span></a><span class=cm>     *</span>
<a id=__codelineno-7-162 name=__codelineno-7-162></a><a href=#__codelineno-7-162><span class=linenos data-linenos="162 "></span></a><span class=cm>     * @return the previous value mapped by {@code key}.</span>
<a id=__codelineno-7-163 name=__codelineno-7-163></a><a href=#__codelineno-7-163><span class=linenos data-linenos="163 "></span></a><span class=cm>     */</span>
<a id=__codelineno-7-164 name=__codelineno-7-164></a><a href=#__codelineno-7-164><span class=linenos data-linenos="164 "></span></a>    <span class=kd>public</span> <span class=kd>final</span> <span class=n>V</span> <span class=nf>remove</span><span class=p>(</span><span class=n>K</span> <span class=n>key</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-7-165 name=__codelineno-7-165></a><a href=#__codelineno-7-165><span class=linenos data-linenos="165 "></span></a>        <span class=k>if</span> <span class=p>(</span><span class=n>key</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-7-166 name=__codelineno-7-166></a><a href=#__codelineno-7-166><span class=linenos data-linenos="166 "></span></a>            <span class=k>throw</span> <span class=k>new</span> <span class=n>NullPointerException</span><span class=p>(</span><span class=s>&quot;key == null&quot;</span><span class=p>);</span>
<a id=__codelineno-7-167 name=__codelineno-7-167></a><a href=#__codelineno-7-167><span class=linenos data-linenos="167 "></span></a>        <span class=p>}</span>
<a id=__codelineno-7-168 name=__codelineno-7-168></a><a href=#__codelineno-7-168><span class=linenos data-linenos="168 "></span></a>
<a id=__codelineno-7-169 name=__codelineno-7-169></a><a href=#__codelineno-7-169><span class=linenos data-linenos="169 "></span></a>        <span class=n>V</span> <span class=n>previous</span><span class=p>;</span>
<a id=__codelineno-7-170 name=__codelineno-7-170></a><a href=#__codelineno-7-170><span class=linenos data-linenos="170 "></span></a>        <span class=kd>synchronized</span> <span class=p>(</span><span class=k>this</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-7-171 name=__codelineno-7-171></a><a href=#__codelineno-7-171><span class=linenos data-linenos="171 "></span></a>            <span class=n>previous</span> <span class=o>=</span> <span class=n>map</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
<a id=__codelineno-7-172 name=__codelineno-7-172></a><a href=#__codelineno-7-172><span class=linenos data-linenos="172 "></span></a>            <span class=k>if</span> <span class=p>(</span><span class=n>previous</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-7-173 name=__codelineno-7-173></a><a href=#__codelineno-7-173><span class=linenos data-linenos="173 "></span></a>                <span class=n>size</span> <span class=o>-=</span> <span class=n>safeSizeOf</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>previous</span><span class=p>);</span>
<a id=__codelineno-7-174 name=__codelineno-7-174></a><a href=#__codelineno-7-174><span class=linenos data-linenos="174 "></span></a>            <span class=p>}</span>
<a id=__codelineno-7-175 name=__codelineno-7-175></a><a href=#__codelineno-7-175><span class=linenos data-linenos="175 "></span></a>        <span class=p>}</span>
<a id=__codelineno-7-176 name=__codelineno-7-176></a><a href=#__codelineno-7-176><span class=linenos data-linenos="176 "></span></a>
<a id=__codelineno-7-177 name=__codelineno-7-177></a><a href=#__codelineno-7-177><span class=linenos data-linenos="177 "></span></a>        <span class=k>if</span> <span class=p>(</span><span class=n>previous</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-7-178 name=__codelineno-7-178></a><a href=#__codelineno-7-178><span class=linenos data-linenos="178 "></span></a>            <span class=n>entryRemoved</span><span class=p>(</span><span class=kc>false</span><span class=p>,</span> <span class=n>key</span><span class=p>,</span> <span class=n>previous</span><span class=p>,</span> <span class=kc>null</span><span class=p>);</span>
<a id=__codelineno-7-179 name=__codelineno-7-179></a><a href=#__codelineno-7-179><span class=linenos data-linenos="179 "></span></a>        <span class=p>}</span>
<a id=__codelineno-7-180 name=__codelineno-7-180></a><a href=#__codelineno-7-180><span class=linenos data-linenos="180 "></span></a>
<a id=__codelineno-7-181 name=__codelineno-7-181></a><a href=#__codelineno-7-181><span class=linenos data-linenos="181 "></span></a>        <span class=k>return</span> <span class=n>previous</span><span class=p>;</span>
<a id=__codelineno-7-182 name=__codelineno-7-182></a><a href=#__codelineno-7-182><span class=linenos data-linenos="182 "></span></a>    <span class=p>}</span>
<a id=__codelineno-7-183 name=__codelineno-7-183></a><a href=#__codelineno-7-183><span class=linenos data-linenos="183 "></span></a>
<a id=__codelineno-7-184 name=__codelineno-7-184></a><a href=#__codelineno-7-184><span class=linenos data-linenos="184 "></span></a>    <span class=cm>/**</span>
<a id=__codelineno-7-185 name=__codelineno-7-185></a><a href=#__codelineno-7-185><span class=linenos data-linenos="185 "></span></a><span class=cm>     * Called for entries that have been evicted or removed. This method is</span>
<a id=__codelineno-7-186 name=__codelineno-7-186></a><a href=#__codelineno-7-186><span class=linenos data-linenos="186 "></span></a><span class=cm>     * invoked when a value is evicted to make space, removed by a call to</span>
<a id=__codelineno-7-187 name=__codelineno-7-187></a><a href=#__codelineno-7-187><span class=linenos data-linenos="187 "></span></a><span class=cm>     * {@link #remove}, or replaced by a call to {@link #put}. The default</span>
<a id=__codelineno-7-188 name=__codelineno-7-188></a><a href=#__codelineno-7-188><span class=linenos data-linenos="188 "></span></a><span class=cm>     * implementation does nothing.</span>
<a id=__codelineno-7-189 name=__codelineno-7-189></a><a href=#__codelineno-7-189><span class=linenos data-linenos="189 "></span></a><span class=cm>     *</span>
<a id=__codelineno-7-190 name=__codelineno-7-190></a><a href=#__codelineno-7-190><span class=linenos data-linenos="190 "></span></a><span class=cm>     * &lt;p&gt;The method is called without synchronization: other threads may</span>
<a id=__codelineno-7-191 name=__codelineno-7-191></a><a href=#__codelineno-7-191><span class=linenos data-linenos="191 "></span></a><span class=cm>     * access the cache while this method is executing.</span>
<a id=__codelineno-7-192 name=__codelineno-7-192></a><a href=#__codelineno-7-192><span class=linenos data-linenos="192 "></span></a><span class=cm>     *</span>
<a id=__codelineno-7-193 name=__codelineno-7-193></a><a href=#__codelineno-7-193><span class=linenos data-linenos="193 "></span></a><span class=cm>     * @param evicted true if the entry is being removed to make space, false</span>
<a id=__codelineno-7-194 name=__codelineno-7-194></a><a href=#__codelineno-7-194><span class=linenos data-linenos="194 "></span></a><span class=cm>     *     if the removal was caused by a {@link #put} or {@link #remove}.</span>
<a id=__codelineno-7-195 name=__codelineno-7-195></a><a href=#__codelineno-7-195><span class=linenos data-linenos="195 "></span></a><span class=cm>     * @param newValue the new value for {@code key}, if it exists. If non-null,</span>
<a id=__codelineno-7-196 name=__codelineno-7-196></a><a href=#__codelineno-7-196><span class=linenos data-linenos="196 "></span></a><span class=cm>     *     this removal was caused by a {@link #put}. Otherwise it was caused by</span>
<a id=__codelineno-7-197 name=__codelineno-7-197></a><a href=#__codelineno-7-197><span class=linenos data-linenos="197 "></span></a><span class=cm>     *     an eviction or a {@link #remove}.</span>
<a id=__codelineno-7-198 name=__codelineno-7-198></a><a href=#__codelineno-7-198><span class=linenos data-linenos="198 "></span></a><span class=cm>     */</span>
<a id=__codelineno-7-199 name=__codelineno-7-199></a><a href=#__codelineno-7-199><span class=linenos data-linenos="199 "></span></a>    <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>entryRemoved</span><span class=p>(</span><span class=kt>boolean</span> <span class=n>evicted</span><span class=p>,</span> <span class=n>K</span> <span class=n>key</span><span class=p>,</span> <span class=n>V</span> <span class=n>oldValue</span><span class=p>,</span> <span class=n>V</span> <span class=n>newValue</span><span class=p>)</span> <span class=p>{}</span>
<a id=__codelineno-7-200 name=__codelineno-7-200></a><a href=#__codelineno-7-200><span class=linenos data-linenos="200 "></span></a>
<a id=__codelineno-7-201 name=__codelineno-7-201></a><a href=#__codelineno-7-201><span class=linenos data-linenos="201 "></span></a>    <span class=cm>/**</span>
<a id=__codelineno-7-202 name=__codelineno-7-202></a><a href=#__codelineno-7-202><span class=linenos data-linenos="202 "></span></a><span class=cm>     * Called after a cache miss to compute a value for the corresponding key.</span>
<a id=__codelineno-7-203 name=__codelineno-7-203></a><a href=#__codelineno-7-203><span class=linenos data-linenos="203 "></span></a><span class=cm>     * Returns the computed value or null if no value can be computed. The</span>
<a id=__codelineno-7-204 name=__codelineno-7-204></a><a href=#__codelineno-7-204><span class=linenos data-linenos="204 "></span></a><span class=cm>     * default implementation returns null.</span>
<a id=__codelineno-7-205 name=__codelineno-7-205></a><a href=#__codelineno-7-205><span class=linenos data-linenos="205 "></span></a><span class=cm>     *</span>
<a id=__codelineno-7-206 name=__codelineno-7-206></a><a href=#__codelineno-7-206><span class=linenos data-linenos="206 "></span></a><span class=cm>     * &lt;p&gt;The method is called without synchronization: other threads may</span>
<a id=__codelineno-7-207 name=__codelineno-7-207></a><a href=#__codelineno-7-207><span class=linenos data-linenos="207 "></span></a><span class=cm>     * access the cache while this method is executing.</span>
<a id=__codelineno-7-208 name=__codelineno-7-208></a><a href=#__codelineno-7-208><span class=linenos data-linenos="208 "></span></a><span class=cm>     *</span>
<a id=__codelineno-7-209 name=__codelineno-7-209></a><a href=#__codelineno-7-209><span class=linenos data-linenos="209 "></span></a><span class=cm>     * &lt;p&gt;If a value for {@code key} exists in the cache when this method</span>
<a id=__codelineno-7-210 name=__codelineno-7-210></a><a href=#__codelineno-7-210><span class=linenos data-linenos="210 "></span></a><span class=cm>     * returns, the created value will be released with {@link #entryRemoved}</span>
<a id=__codelineno-7-211 name=__codelineno-7-211></a><a href=#__codelineno-7-211><span class=linenos data-linenos="211 "></span></a><span class=cm>     * and discarded. This can occur when multiple threads request the same key</span>
<a id=__codelineno-7-212 name=__codelineno-7-212></a><a href=#__codelineno-7-212><span class=linenos data-linenos="212 "></span></a><span class=cm>     * at the same time (causing multiple values to be created), or when one</span>
<a id=__codelineno-7-213 name=__codelineno-7-213></a><a href=#__codelineno-7-213><span class=linenos data-linenos="213 "></span></a><span class=cm>     * thread calls {@link #put} while another is creating a value for the same</span>
<a id=__codelineno-7-214 name=__codelineno-7-214></a><a href=#__codelineno-7-214><span class=linenos data-linenos="214 "></span></a><span class=cm>     * key.</span>
<a id=__codelineno-7-215 name=__codelineno-7-215></a><a href=#__codelineno-7-215><span class=linenos data-linenos="215 "></span></a><span class=cm>     */</span>
<a id=__codelineno-7-216 name=__codelineno-7-216></a><a href=#__codelineno-7-216><span class=linenos data-linenos="216 "></span></a>    <span class=kd>protected</span> <span class=n>V</span> <span class=nf>create</span><span class=p>(</span><span class=n>K</span> <span class=n>key</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-7-217 name=__codelineno-7-217></a><a href=#__codelineno-7-217><span class=linenos data-linenos="217 "></span></a>        <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-7-218 name=__codelineno-7-218></a><a href=#__codelineno-7-218><span class=linenos data-linenos="218 "></span></a>    <span class=p>}</span>
<a id=__codelineno-7-219 name=__codelineno-7-219></a><a href=#__codelineno-7-219><span class=linenos data-linenos="219 "></span></a>
<a id=__codelineno-7-220 name=__codelineno-7-220></a><a href=#__codelineno-7-220><span class=linenos data-linenos="220 "></span></a>    <span class=kd>private</span> <span class=kt>int</span> <span class=nf>safeSizeOf</span><span class=p>(</span><span class=n>K</span> <span class=n>key</span><span class=p>,</span> <span class=n>V</span> <span class=n>value</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-7-221 name=__codelineno-7-221></a><a href=#__codelineno-7-221><span class=linenos data-linenos="221 "></span></a>        <span class=kt>int</span> <span class=n>result</span> <span class=o>=</span> <span class=n>sizeOf</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>value</span><span class=p>);</span>
<a id=__codelineno-7-222 name=__codelineno-7-222></a><a href=#__codelineno-7-222><span class=linenos data-linenos="222 "></span></a>        <span class=k>if</span> <span class=p>(</span><span class=n>result</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-7-223 name=__codelineno-7-223></a><a href=#__codelineno-7-223><span class=linenos data-linenos="223 "></span></a>            <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&quot;Negative size: &quot;</span> <span class=o>+</span> <span class=n>key</span> <span class=o>+</span> <span class=s>&quot;=&quot;</span> <span class=o>+</span> <span class=n>value</span><span class=p>);</span>
<a id=__codelineno-7-224 name=__codelineno-7-224></a><a href=#__codelineno-7-224><span class=linenos data-linenos="224 "></span></a>        <span class=p>}</span>
<a id=__codelineno-7-225 name=__codelineno-7-225></a><a href=#__codelineno-7-225><span class=linenos data-linenos="225 "></span></a>        <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
<a id=__codelineno-7-226 name=__codelineno-7-226></a><a href=#__codelineno-7-226><span class=linenos data-linenos="226 "></span></a>    <span class=p>}</span>
<a id=__codelineno-7-227 name=__codelineno-7-227></a><a href=#__codelineno-7-227><span class=linenos data-linenos="227 "></span></a>
<a id=__codelineno-7-228 name=__codelineno-7-228></a><a href=#__codelineno-7-228><span class=linenos data-linenos="228 "></span></a>    <span class=cm>/**</span>
<a id=__codelineno-7-229 name=__codelineno-7-229></a><a href=#__codelineno-7-229><span class=linenos data-linenos="229 "></span></a><span class=cm>     * Returns the size of the entry for {@code key} and {@code value} in</span>
<a id=__codelineno-7-230 name=__codelineno-7-230></a><a href=#__codelineno-7-230><span class=linenos data-linenos="230 "></span></a><span class=cm>     * user-defined units.  The default implementation returns 1 so that size</span>
<a id=__codelineno-7-231 name=__codelineno-7-231></a><a href=#__codelineno-7-231><span class=linenos data-linenos="231 "></span></a><span class=cm>     * is the number of entries and max size is the maximum number of entries.</span>
<a id=__codelineno-7-232 name=__codelineno-7-232></a><a href=#__codelineno-7-232><span class=linenos data-linenos="232 "></span></a><span class=cm>     *</span>
<a id=__codelineno-7-233 name=__codelineno-7-233></a><a href=#__codelineno-7-233><span class=linenos data-linenos="233 "></span></a><span class=cm>     * &lt;p&gt;An entry&#39;s size must not change while it is in the cache.</span>
<a id=__codelineno-7-234 name=__codelineno-7-234></a><a href=#__codelineno-7-234><span class=linenos data-linenos="234 "></span></a><span class=cm>     */</span>
<a id=__codelineno-7-235 name=__codelineno-7-235></a><a href=#__codelineno-7-235><span class=linenos data-linenos="235 "></span></a>    <span class=kd>protected</span> <span class=kt>int</span> <span class=nf>sizeOf</span><span class=p>(</span><span class=n>K</span> <span class=n>key</span><span class=p>,</span> <span class=n>V</span> <span class=n>value</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-7-236 name=__codelineno-7-236></a><a href=#__codelineno-7-236><span class=linenos data-linenos="236 "></span></a>        <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
<a id=__codelineno-7-237 name=__codelineno-7-237></a><a href=#__codelineno-7-237><span class=linenos data-linenos="237 "></span></a>    <span class=p>}</span>
<a id=__codelineno-7-238 name=__codelineno-7-238></a><a href=#__codelineno-7-238><span class=linenos data-linenos="238 "></span></a>
<a id=__codelineno-7-239 name=__codelineno-7-239></a><a href=#__codelineno-7-239><span class=linenos data-linenos="239 "></span></a>    <span class=cm>/**</span>
<a id=__codelineno-7-240 name=__codelineno-7-240></a><a href=#__codelineno-7-240><span class=linenos data-linenos="240 "></span></a><span class=cm>     * Clear the cache, calling {@link #entryRemoved} on each removed entry.</span>
<a id=__codelineno-7-241 name=__codelineno-7-241></a><a href=#__codelineno-7-241><span class=linenos data-linenos="241 "></span></a><span class=cm>     */</span>
<a id=__codelineno-7-242 name=__codelineno-7-242></a><a href=#__codelineno-7-242><span class=linenos data-linenos="242 "></span></a>    <span class=kd>public</span> <span class=kd>final</span> <span class=kt>void</span> <span class=nf>evictAll</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-7-243 name=__codelineno-7-243></a><a href=#__codelineno-7-243><span class=linenos data-linenos="243 "></span></a>        <span class=n>trimToSize</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>);</span> <span class=c1>// -1 will evict 0-sized elements</span>
<a id=__codelineno-7-244 name=__codelineno-7-244></a><a href=#__codelineno-7-244><span class=linenos data-linenos="244 "></span></a>    <span class=p>}</span>
<a id=__codelineno-7-245 name=__codelineno-7-245></a><a href=#__codelineno-7-245><span class=linenos data-linenos="245 "></span></a>
<a id=__codelineno-7-246 name=__codelineno-7-246></a><a href=#__codelineno-7-246><span class=linenos data-linenos="246 "></span></a>    <span class=cm>/**</span>
<a id=__codelineno-7-247 name=__codelineno-7-247></a><a href=#__codelineno-7-247><span class=linenos data-linenos="247 "></span></a><span class=cm>     * For caches that do not override {@link #sizeOf}, this returns the number</span>
<a id=__codelineno-7-248 name=__codelineno-7-248></a><a href=#__codelineno-7-248><span class=linenos data-linenos="248 "></span></a><span class=cm>     * of entries in the cache. For all other caches, this returns the sum of</span>
<a id=__codelineno-7-249 name=__codelineno-7-249></a><a href=#__codelineno-7-249><span class=linenos data-linenos="249 "></span></a><span class=cm>     * the sizes of the entries in this cache.</span>
<a id=__codelineno-7-250 name=__codelineno-7-250></a><a href=#__codelineno-7-250><span class=linenos data-linenos="250 "></span></a><span class=cm>     */</span>
<a id=__codelineno-7-251 name=__codelineno-7-251></a><a href=#__codelineno-7-251><span class=linenos data-linenos="251 "></span></a>    <span class=kd>public</span> <span class=kd>synchronized</span> <span class=kd>final</span> <span class=kt>int</span> <span class=nf>size</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-7-252 name=__codelineno-7-252></a><a href=#__codelineno-7-252><span class=linenos data-linenos="252 "></span></a>        <span class=k>return</span> <span class=n>size</span><span class=p>;</span>
<a id=__codelineno-7-253 name=__codelineno-7-253></a><a href=#__codelineno-7-253><span class=linenos data-linenos="253 "></span></a>    <span class=p>}</span>
<a id=__codelineno-7-254 name=__codelineno-7-254></a><a href=#__codelineno-7-254><span class=linenos data-linenos="254 "></span></a>
<a id=__codelineno-7-255 name=__codelineno-7-255></a><a href=#__codelineno-7-255><span class=linenos data-linenos="255 "></span></a>    <span class=cm>/**</span>
<a id=__codelineno-7-256 name=__codelineno-7-256></a><a href=#__codelineno-7-256><span class=linenos data-linenos="256 "></span></a><span class=cm>     * For caches that do not override {@link #sizeOf}, this returns the maximum</span>
<a id=__codelineno-7-257 name=__codelineno-7-257></a><a href=#__codelineno-7-257><span class=linenos data-linenos="257 "></span></a><span class=cm>     * number of entries in the cache. For all other caches, this returns the</span>
<a id=__codelineno-7-258 name=__codelineno-7-258></a><a href=#__codelineno-7-258><span class=linenos data-linenos="258 "></span></a><span class=cm>     * maximum sum of the sizes of the entries in this cache.</span>
<a id=__codelineno-7-259 name=__codelineno-7-259></a><a href=#__codelineno-7-259><span class=linenos data-linenos="259 "></span></a><span class=cm>     */</span>
<a id=__codelineno-7-260 name=__codelineno-7-260></a><a href=#__codelineno-7-260><span class=linenos data-linenos="260 "></span></a>    <span class=kd>public</span> <span class=kd>synchronized</span> <span class=kd>final</span> <span class=kt>int</span> <span class=nf>maxSize</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-7-261 name=__codelineno-7-261></a><a href=#__codelineno-7-261><span class=linenos data-linenos="261 "></span></a>        <span class=k>return</span> <span class=n>maxSize</span><span class=p>;</span>
<a id=__codelineno-7-262 name=__codelineno-7-262></a><a href=#__codelineno-7-262><span class=linenos data-linenos="262 "></span></a>    <span class=p>}</span>
<a id=__codelineno-7-263 name=__codelineno-7-263></a><a href=#__codelineno-7-263><span class=linenos data-linenos="263 "></span></a>
<a id=__codelineno-7-264 name=__codelineno-7-264></a><a href=#__codelineno-7-264><span class=linenos data-linenos="264 "></span></a>    <span class=cm>/**</span>
<a id=__codelineno-7-265 name=__codelineno-7-265></a><a href=#__codelineno-7-265><span class=linenos data-linenos="265 "></span></a><span class=cm>     * Returns the number of times {@link #get} returned a value that was</span>
<a id=__codelineno-7-266 name=__codelineno-7-266></a><a href=#__codelineno-7-266><span class=linenos data-linenos="266 "></span></a><span class=cm>     * already present in the cache.</span>
<a id=__codelineno-7-267 name=__codelineno-7-267></a><a href=#__codelineno-7-267><span class=linenos data-linenos="267 "></span></a><span class=cm>     */</span>
<a id=__codelineno-7-268 name=__codelineno-7-268></a><a href=#__codelineno-7-268><span class=linenos data-linenos="268 "></span></a>    <span class=kd>public</span> <span class=kd>synchronized</span> <span class=kd>final</span> <span class=kt>int</span> <span class=nf>hitCount</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-7-269 name=__codelineno-7-269></a><a href=#__codelineno-7-269><span class=linenos data-linenos="269 "></span></a>        <span class=k>return</span> <span class=n>hitCount</span><span class=p>;</span>
<a id=__codelineno-7-270 name=__codelineno-7-270></a><a href=#__codelineno-7-270><span class=linenos data-linenos="270 "></span></a>    <span class=p>}</span>
<a id=__codelineno-7-271 name=__codelineno-7-271></a><a href=#__codelineno-7-271><span class=linenos data-linenos="271 "></span></a>
<a id=__codelineno-7-272 name=__codelineno-7-272></a><a href=#__codelineno-7-272><span class=linenos data-linenos="272 "></span></a>    <span class=cm>/**</span>
<a id=__codelineno-7-273 name=__codelineno-7-273></a><a href=#__codelineno-7-273><span class=linenos data-linenos="273 "></span></a><span class=cm>     * Returns the number of times {@link #get} returned null or required a new</span>
<a id=__codelineno-7-274 name=__codelineno-7-274></a><a href=#__codelineno-7-274><span class=linenos data-linenos="274 "></span></a><span class=cm>     * value to be created.</span>
<a id=__codelineno-7-275 name=__codelineno-7-275></a><a href=#__codelineno-7-275><span class=linenos data-linenos="275 "></span></a><span class=cm>     */</span>
<a id=__codelineno-7-276 name=__codelineno-7-276></a><a href=#__codelineno-7-276><span class=linenos data-linenos="276 "></span></a>    <span class=kd>public</span> <span class=kd>synchronized</span> <span class=kd>final</span> <span class=kt>int</span> <span class=nf>missCount</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-7-277 name=__codelineno-7-277></a><a href=#__codelineno-7-277><span class=linenos data-linenos="277 "></span></a>        <span class=k>return</span> <span class=n>missCount</span><span class=p>;</span>
<a id=__codelineno-7-278 name=__codelineno-7-278></a><a href=#__codelineno-7-278><span class=linenos data-linenos="278 "></span></a>    <span class=p>}</span>
<a id=__codelineno-7-279 name=__codelineno-7-279></a><a href=#__codelineno-7-279><span class=linenos data-linenos="279 "></span></a>
<a id=__codelineno-7-280 name=__codelineno-7-280></a><a href=#__codelineno-7-280><span class=linenos data-linenos="280 "></span></a>    <span class=cm>/**</span>
<a id=__codelineno-7-281 name=__codelineno-7-281></a><a href=#__codelineno-7-281><span class=linenos data-linenos="281 "></span></a><span class=cm>     * Returns the number of times {@link #create(Object)} returned a value.</span>
<a id=__codelineno-7-282 name=__codelineno-7-282></a><a href=#__codelineno-7-282><span class=linenos data-linenos="282 "></span></a><span class=cm>     */</span>
<a id=__codelineno-7-283 name=__codelineno-7-283></a><a href=#__codelineno-7-283><span class=linenos data-linenos="283 "></span></a>    <span class=kd>public</span> <span class=kd>synchronized</span> <span class=kd>final</span> <span class=kt>int</span> <span class=nf>createCount</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-7-284 name=__codelineno-7-284></a><a href=#__codelineno-7-284><span class=linenos data-linenos="284 "></span></a>        <span class=k>return</span> <span class=n>createCount</span><span class=p>;</span>
<a id=__codelineno-7-285 name=__codelineno-7-285></a><a href=#__codelineno-7-285><span class=linenos data-linenos="285 "></span></a>    <span class=p>}</span>
<a id=__codelineno-7-286 name=__codelineno-7-286></a><a href=#__codelineno-7-286><span class=linenos data-linenos="286 "></span></a>
<a id=__codelineno-7-287 name=__codelineno-7-287></a><a href=#__codelineno-7-287><span class=linenos data-linenos="287 "></span></a>    <span class=cm>/**</span>
<a id=__codelineno-7-288 name=__codelineno-7-288></a><a href=#__codelineno-7-288><span class=linenos data-linenos="288 "></span></a><span class=cm>     * Returns the number of times {@link #put} was called.</span>
<a id=__codelineno-7-289 name=__codelineno-7-289></a><a href=#__codelineno-7-289><span class=linenos data-linenos="289 "></span></a><span class=cm>     */</span>
<a id=__codelineno-7-290 name=__codelineno-7-290></a><a href=#__codelineno-7-290><span class=linenos data-linenos="290 "></span></a>    <span class=kd>public</span> <span class=kd>synchronized</span> <span class=kd>final</span> <span class=kt>int</span> <span class=nf>putCount</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-7-291 name=__codelineno-7-291></a><a href=#__codelineno-7-291><span class=linenos data-linenos="291 "></span></a>        <span class=k>return</span> <span class=n>putCount</span><span class=p>;</span>
<a id=__codelineno-7-292 name=__codelineno-7-292></a><a href=#__codelineno-7-292><span class=linenos data-linenos="292 "></span></a>    <span class=p>}</span>
<a id=__codelineno-7-293 name=__codelineno-7-293></a><a href=#__codelineno-7-293><span class=linenos data-linenos="293 "></span></a>
<a id=__codelineno-7-294 name=__codelineno-7-294></a><a href=#__codelineno-7-294><span class=linenos data-linenos="294 "></span></a>    <span class=cm>/**</span>
<a id=__codelineno-7-295 name=__codelineno-7-295></a><a href=#__codelineno-7-295><span class=linenos data-linenos="295 "></span></a><span class=cm>     * Returns the number of values that have been evicted.</span>
<a id=__codelineno-7-296 name=__codelineno-7-296></a><a href=#__codelineno-7-296><span class=linenos data-linenos="296 "></span></a><span class=cm>     */</span>
<a id=__codelineno-7-297 name=__codelineno-7-297></a><a href=#__codelineno-7-297><span class=linenos data-linenos="297 "></span></a>    <span class=kd>public</span> <span class=kd>synchronized</span> <span class=kd>final</span> <span class=kt>int</span> <span class=nf>evictionCount</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-7-298 name=__codelineno-7-298></a><a href=#__codelineno-7-298><span class=linenos data-linenos="298 "></span></a>        <span class=k>return</span> <span class=n>evictionCount</span><span class=p>;</span>
<a id=__codelineno-7-299 name=__codelineno-7-299></a><a href=#__codelineno-7-299><span class=linenos data-linenos="299 "></span></a>    <span class=p>}</span>
<a id=__codelineno-7-300 name=__codelineno-7-300></a><a href=#__codelineno-7-300><span class=linenos data-linenos="300 "></span></a>
<a id=__codelineno-7-301 name=__codelineno-7-301></a><a href=#__codelineno-7-301><span class=linenos data-linenos="301 "></span></a>    <span class=cm>/**</span>
<a id=__codelineno-7-302 name=__codelineno-7-302></a><a href=#__codelineno-7-302><span class=linenos data-linenos="302 "></span></a><span class=cm>     * Returns a copy of the current contents of the cache, ordered from least</span>
<a id=__codelineno-7-303 name=__codelineno-7-303></a><a href=#__codelineno-7-303><span class=linenos data-linenos="303 "></span></a><span class=cm>     * recently accessed to most recently accessed.</span>
<a id=__codelineno-7-304 name=__codelineno-7-304></a><a href=#__codelineno-7-304><span class=linenos data-linenos="304 "></span></a><span class=cm>     */</span>
<a id=__codelineno-7-305 name=__codelineno-7-305></a><a href=#__codelineno-7-305><span class=linenos data-linenos="305 "></span></a>    <span class=kd>public</span> <span class=kd>synchronized</span> <span class=kd>final</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span> <span class=n>V</span><span class=o>&gt;</span> <span class=nf>snapshot</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-7-306 name=__codelineno-7-306></a><a href=#__codelineno-7-306><span class=linenos data-linenos="306 "></span></a>        <span class=k>return</span> <span class=k>new</span> <span class=n>LinkedHashMap</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span> <span class=n>V</span><span class=o>&gt;</span><span class=p>(</span><span class=n>map</span><span class=p>);</span>
<a id=__codelineno-7-307 name=__codelineno-7-307></a><a href=#__codelineno-7-307><span class=linenos data-linenos="307 "></span></a>    <span class=p>}</span>
<a id=__codelineno-7-308 name=__codelineno-7-308></a><a href=#__codelineno-7-308><span class=linenos data-linenos="308 "></span></a>
<a id=__codelineno-7-309 name=__codelineno-7-309></a><a href=#__codelineno-7-309><span class=linenos data-linenos="309 "></span></a>    <span class=nd>@Override</span> <span class=kd>public</span> <span class=kd>synchronized</span> <span class=kd>final</span> <span class=n>String</span> <span class=nf>toString</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-7-310 name=__codelineno-7-310></a><a href=#__codelineno-7-310><span class=linenos data-linenos="310 "></span></a>        <span class=kt>int</span> <span class=n>accesses</span> <span class=o>=</span> <span class=n>hitCount</span> <span class=o>+</span> <span class=n>missCount</span><span class=p>;</span>
<a id=__codelineno-7-311 name=__codelineno-7-311></a><a href=#__codelineno-7-311><span class=linenos data-linenos="311 "></span></a>        <span class=kt>int</span> <span class=n>hitPercent</span> <span class=o>=</span> <span class=n>accesses</span> <span class=o>!=</span> <span class=mi>0</span> <span class=o>?</span> <span class=p>(</span><span class=mi>100</span> <span class=o>*</span> <span class=n>hitCount</span> <span class=o>/</span> <span class=n>accesses</span><span class=p>)</span> <span class=p>:</span> <span class=mi>0</span><span class=p>;</span>
<a id=__codelineno-7-312 name=__codelineno-7-312></a><a href=#__codelineno-7-312><span class=linenos data-linenos="312 "></span></a>        <span class=k>return</span> <span class=n>String</span><span class=p>.</span><span class=na>format</span><span class=p>(</span><span class=s>&quot;LruCache[maxSize=%d,hits=%d,misses=%d,hitRate=%d%%]&quot;</span><span class=p>,</span>
<a id=__codelineno-7-313 name=__codelineno-7-313></a><a href=#__codelineno-7-313><span class=linenos data-linenos="313 "></span></a>                <span class=n>maxSize</span><span class=p>,</span> <span class=n>hitCount</span><span class=p>,</span> <span class=n>missCount</span><span class=p>,</span> <span class=n>hitPercent</span><span class=p>);</span>
<a id=__codelineno-7-314 name=__codelineno-7-314></a><a href=#__codelineno-7-314><span class=linenos data-linenos="314 "></span></a>    <span class=p>}</span>
<a id=__codelineno-7-315 name=__codelineno-7-315></a><a href=#__codelineno-7-315><span class=linenos data-linenos="315 "></span></a><span class=p>}</span>
</code></pre></div></p> <p>下面说说<code>LruCache</code>的基本操作: <div class=highlight><pre><span></span><code><a id=__codelineno-8-1 name=__codelineno-8-1></a><a href=#__codelineno-8-1><span class=linenos data-linenos=" 1 "></span></a><span class=c1>// 初始化</span>
<a id=__codelineno-8-2 name=__codelineno-8-2></a><a href=#__codelineno-8-2><span class=linenos data-linenos=" 2 "></span></a><span class=kt>int</span> <span class=n>maxMemory</span> <span class=o>=</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span> <span class=p>(</span><span class=n>Runtime</span><span class=p>.</span><span class=na>getRuntime</span><span class=p>().</span><span class=na>maxMemory</span><span class=p>()</span> <span class=o>/</span> <span class=mi>1024</span><span class=p>);</span>
<a id=__codelineno-8-3 name=__codelineno-8-3></a><a href=#__codelineno-8-3><span class=linenos data-linenos=" 3 "></span></a><span class=kt>int</span> <span class=n>cacheSize</span> <span class=o>=</span> <span class=n>maxMemory</span> <span class=o>/</span> <span class=mi>8</span><span class=p>;</span>
<a id=__codelineno-8-4 name=__codelineno-8-4></a><a href=#__codelineno-8-4><span class=linenos data-linenos=" 4 "></span></a><span class=n>LruCache</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>Bitmap</span><span class=o>&gt;</span> <span class=n>mMemoryCache</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LruCache</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>Bitmap</span><span class=o>&gt;</span><span class=p>(</span><span class=n>cacheSize</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-8-5 name=__codelineno-8-5></a><a href=#__codelineno-8-5><span class=linenos data-linenos=" 5 "></span></a>    <span class=nd>@Override</span>
<a id=__codelineno-8-6 name=__codelineno-8-6></a><a href=#__codelineno-8-6><span class=linenos data-linenos=" 6 "></span></a>    <span class=kd>protected</span> <span class=kt>int</span> <span class=nf>sizeOf</span><span class=p>(</span><span class=n>String</span> <span class=n>key</span><span class=p>,</span> <span class=n>Bitmap</span> <span class=n>bitmap</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-8-7 name=__codelineno-8-7></a><a href=#__codelineno-8-7><span class=linenos data-linenos=" 7 "></span></a>        <span class=k>return</span> <span class=n>bitmap</span><span class=p>.</span><span class=na>getRowBytes</span><span class=p>()</span> <span class=o>*</span> <span class=n>bitmap</span><span class=p>.</span><span class=na>getHeight</span><span class=p>()</span> <span class=o>/</span> <span class=mi>1024</span><span class=p>;</span>
<a id=__codelineno-8-8 name=__codelineno-8-8></a><a href=#__codelineno-8-8><span class=linenos data-linenos=" 8 "></span></a>    <span class=p>}</span>
<a id=__codelineno-8-9 name=__codelineno-8-9></a><a href=#__codelineno-8-9><span class=linenos data-linenos=" 9 "></span></a><span class=p>};</span>
<a id=__codelineno-8-10 name=__codelineno-8-10></a><a href=#__codelineno-8-10><span class=linenos data-linenos="10 "></span></a>
<a id=__codelineno-8-11 name=__codelineno-8-11></a><a href=#__codelineno-8-11><span class=linenos data-linenos="11 "></span></a><span class=c1>// 获取</span>
<a id=__codelineno-8-12 name=__codelineno-8-12></a><a href=#__codelineno-8-12><span class=linenos data-linenos="12 "></span></a><span class=n>mMemoryCache</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
<a id=__codelineno-8-13 name=__codelineno-8-13></a><a href=#__codelineno-8-13><span class=linenos data-linenos="13 "></span></a>
<a id=__codelineno-8-14 name=__codelineno-8-14></a><a href=#__codelineno-8-14><span class=linenos data-linenos="14 "></span></a><span class=c1>// 添加</span>
<a id=__codelineno-8-15 name=__codelineno-8-15></a><a href=#__codelineno-8-15><span class=linenos data-linenos="15 "></span></a><span class=n>mMemoryCache</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>bitmap</span><span class=p>);</span>
<a id=__codelineno-8-16 name=__codelineno-8-16></a><a href=#__codelineno-8-16><span class=linenos data-linenos="16 "></span></a>
<a id=__codelineno-8-17 name=__codelineno-8-17></a><a href=#__codelineno-8-17><span class=linenos data-linenos="17 "></span></a><span class=c1>// 删除</span>
<a id=__codelineno-8-18 name=__codelineno-8-18></a><a href=#__codelineno-8-18><span class=linenos data-linenos="18 "></span></a><span class=n>mMemoryCache</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
</code></pre></div></p> <h3 id=22-disklrucache>2.2 DiskLruCache<a class=headerlink href=#22-disklrucache title="Anchor link to this section for reference">&para;</a></h3> <p><code>DiskLruCache</code>用于实现存储设备缓存，即磁盘缓存，它通过将缓存对象写入文件系统从而实现缓存的效果。<code>DiskLruCache</code>得到了Android官方的支持，但是它不属于Android SDK的一部分。</p> <p><a href=https://android.googlesource.com/platform/libcore/+/jb-mr2-release/luni/src/main/java/libcore/io/DiskLruCache.java>https://android.googlesource.com/platform/libcore/+/jb-mr2-release/luni/src/main/java/libcore/io/DiskLruCache.java</a></p> <h4 id=221-disklrucache>2.2.1 DiskLruCache的创建<a class=headerlink href=#221-disklrucache title="Anchor link to this section for reference">&para;</a></h4> <p>DiskLruCache的创建是通过<code>open</code>方法创建的，下面是其方法签名 <div class=highlight><pre><span></span><code><a id=__codelineno-9-1 name=__codelineno-9-1></a><a href=#__codelineno-9-1><span class=linenos data-linenos="1 "></span></a><span class=kd>public</span> <span class=kd>static</span> <span class=n>DiskLruCache</span> <span class=nf>open</span><span class=p>(</span><span class=n>File</span> <span class=n>directory</span><span class=p>,</span> <span class=kt>int</span> <span class=n>appVersion</span><span class=p>,</span> <span class=kt>int</span> <span class=n>valueCount</span><span class=p>,</span> <span class=kt>long</span> <span class=n>maxSize</span><span class=p>)</span>
</code></pre></div></p> <p>这四个参数的含义如下：</p> <ul> <li>directory<br> 数据的缓存地址</li> <li>appVersion<br> 当前应用程序的版本号，每当版本号改变，缓存路径下存储的所有数据都会被清除掉</li> <li>valueCount<br> 同一个key可以对应多少个缓存文件，基本都是传1</li> <li>maxSize<br> 最多可以缓存多少字节的数据</li> </ul> <p>考虑到如果手机没有SD卡或者SD卡被移除了，我们需要返回内置存储。所以需要一个方法来返回缓存目录： <div class=highlight><pre><span></span><code><a id=__codelineno-10-1 name=__codelineno-10-1></a><a href=#__codelineno-10-1><span class=linenos data-linenos=" 1 "></span></a><span class=c1>// Creates a unique subdirectory of the designated app cache directory. Tries to use external</span>
<a id=__codelineno-10-2 name=__codelineno-10-2></a><a href=#__codelineno-10-2><span class=linenos data-linenos=" 2 "></span></a><span class=c1>// but if not mounted, falls back on internal storage.</span>
<a id=__codelineno-10-3 name=__codelineno-10-3></a><a href=#__codelineno-10-3><span class=linenos data-linenos=" 3 "></span></a><span class=kd>public</span> <span class=kd>static</span> <span class=n>File</span> <span class=nf>getDiskCacheDir</span><span class=p>(</span><span class=n>Context</span> <span class=n>context</span><span class=p>,</span> <span class=n>String</span> <span class=n>uniqueName</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-10-4 name=__codelineno-10-4></a><a href=#__codelineno-10-4><span class=linenos data-linenos=" 4 "></span></a>    <span class=c1>// Check if media is mounted or storage is built-in, if so, try and use external cache dir</span>
<a id=__codelineno-10-5 name=__codelineno-10-5></a><a href=#__codelineno-10-5><span class=linenos data-linenos=" 5 "></span></a>    <span class=c1>// otherwise use internal cache dir</span>
<a id=__codelineno-10-6 name=__codelineno-10-6></a><a href=#__codelineno-10-6><span class=linenos data-linenos=" 6 "></span></a>    <span class=kd>final</span> <span class=n>String</span> <span class=n>cachePath</span> <span class=o>=</span>
<a id=__codelineno-10-7 name=__codelineno-10-7></a><a href=#__codelineno-10-7><span class=linenos data-linenos=" 7 "></span></a>            <span class=n>Environment</span><span class=p>.</span><span class=na>MEDIA_MOUNTED</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>Environment</span><span class=p>.</span><span class=na>getExternalStorageState</span><span class=p>())</span> <span class=o>||</span>
<a id=__codelineno-10-8 name=__codelineno-10-8></a><a href=#__codelineno-10-8><span class=linenos data-linenos=" 8 "></span></a>                    <span class=o>!</span><span class=n>isExternalStorageRemovable</span><span class=p>()</span> <span class=o>?</span> <span class=n>getExternalCacheDir</span><span class=p>(</span><span class=n>context</span><span class=p>).</span><span class=na>getPath</span><span class=p>()</span> <span class=p>:</span>
<a id=__codelineno-10-9 name=__codelineno-10-9></a><a href=#__codelineno-10-9><span class=linenos data-linenos=" 9 "></span></a>                            <span class=n>context</span><span class=p>.</span><span class=na>getCacheDir</span><span class=p>().</span><span class=na>getPath</span><span class=p>();</span>
<a id=__codelineno-10-10 name=__codelineno-10-10></a><a href=#__codelineno-10-10><span class=linenos data-linenos="10 "></span></a>
<a id=__codelineno-10-11 name=__codelineno-10-11></a><a href=#__codelineno-10-11><span class=linenos data-linenos="11 "></span></a>    <span class=k>return</span> <span class=k>new</span> <span class=n>File</span><span class=p>(</span><span class=n>cachePath</span> <span class=o>+</span> <span class=n>File</span><span class=p>.</span><span class=na>separator</span> <span class=o>+</span> <span class=n>uniqueName</span><span class=p>);</span>
<a id=__codelineno-10-12 name=__codelineno-10-12></a><a href=#__codelineno-10-12><span class=linenos data-linenos="12 "></span></a><span class=p>}</span>
</code></pre></div></p> <h4 id=222-disklrucache>2.2.2 DiskLruCache的写入<a class=headerlink href=#222-disklrucache title="Anchor link to this section for reference">&para;</a></h4> <p>写入的操作是借助DiskLruCache.Editor这个类完成的。通过该类的<code>edit</code>方法来获取<code>Editor</code>对象，如果这个缓存正在被编辑，那么<code>edit</code>会返回<code>null</code>。 <div class=highlight><pre><span></span><code><a id=__codelineno-11-1 name=__codelineno-11-1></a><a href=#__codelineno-11-1><span class=linenos data-linenos="1 "></span></a><span class=kd>public</span> <span class=n>Editor</span> <span class=nf>edit</span><span class=p>(</span><span class=n>String</span> <span class=n>key</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>IOException</span>
</code></pre></div></p> <p>当然我们不能直接把url作为key，因为url里面可能有特殊字符，这样可能会出现无法命名文件等问题。因此，我们需要把url进行MD5编码： <div class=highlight><pre><span></span><code><a id=__codelineno-12-1 name=__codelineno-12-1></a><a href=#__codelineno-12-1><span class=linenos data-linenos=" 1 "></span></a><span class=kd>public</span> <span class=n>String</span> <span class=nf>hashKeyFromUrl</span><span class=p>(</span><span class=n>String</span> <span class=n>key</span><span class=p>)</span> <span class=p>{</span>  
<a id=__codelineno-12-2 name=__codelineno-12-2></a><a href=#__codelineno-12-2><span class=linenos data-linenos=" 2 "></span></a>    <span class=n>String</span> <span class=n>cacheKey</span><span class=p>;</span>  
<a id=__codelineno-12-3 name=__codelineno-12-3></a><a href=#__codelineno-12-3><span class=linenos data-linenos=" 3 "></span></a>    <span class=k>try</span> <span class=p>{</span>  
<a id=__codelineno-12-4 name=__codelineno-12-4></a><a href=#__codelineno-12-4><span class=linenos data-linenos=" 4 "></span></a>        <span class=kd>final</span> <span class=n>MessageDigest</span> <span class=n>mDigest</span> <span class=o>=</span> <span class=n>MessageDigest</span><span class=p>.</span><span class=na>getInstance</span><span class=p>(</span><span class=s>&quot;MD5&quot;</span><span class=p>);</span>  
<a id=__codelineno-12-5 name=__codelineno-12-5></a><a href=#__codelineno-12-5><span class=linenos data-linenos=" 5 "></span></a>        <span class=n>mDigest</span><span class=p>.</span><span class=na>update</span><span class=p>(</span><span class=n>key</span><span class=p>.</span><span class=na>getBytes</span><span class=p>());</span>  
<a id=__codelineno-12-6 name=__codelineno-12-6></a><a href=#__codelineno-12-6><span class=linenos data-linenos=" 6 "></span></a>        <span class=n>cacheKey</span> <span class=o>=</span> <span class=n>bytesToHexString</span><span class=p>(</span><span class=n>mDigest</span><span class=p>.</span><span class=na>digest</span><span class=p>());</span>  
<a id=__codelineno-12-7 name=__codelineno-12-7></a><a href=#__codelineno-12-7><span class=linenos data-linenos=" 7 "></span></a>    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>NoSuchAlgorithmException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>  
<a id=__codelineno-12-8 name=__codelineno-12-8></a><a href=#__codelineno-12-8><span class=linenos data-linenos=" 8 "></span></a>        <span class=n>cacheKey</span> <span class=o>=</span> <span class=n>String</span><span class=p>.</span><span class=na>valueOf</span><span class=p>(</span><span class=n>key</span><span class=p>.</span><span class=na>hashCode</span><span class=p>());</span>  
<a id=__codelineno-12-9 name=__codelineno-12-9></a><a href=#__codelineno-12-9><span class=linenos data-linenos=" 9 "></span></a>    <span class=p>}</span>  
<a id=__codelineno-12-10 name=__codelineno-12-10></a><a href=#__codelineno-12-10><span class=linenos data-linenos="10 "></span></a>    <span class=k>return</span> <span class=n>cacheKey</span><span class=p>;</span>  
<a id=__codelineno-12-11 name=__codelineno-12-11></a><a href=#__codelineno-12-11><span class=linenos data-linenos="11 "></span></a><span class=p>}</span>  
<a id=__codelineno-12-12 name=__codelineno-12-12></a><a href=#__codelineno-12-12><span class=linenos data-linenos="12 "></span></a>
<a id=__codelineno-12-13 name=__codelineno-12-13></a><a href=#__codelineno-12-13><span class=linenos data-linenos="13 "></span></a><span class=kd>private</span> <span class=n>String</span> <span class=nf>bytesToHexString</span><span class=p>(</span><span class=kt>byte</span><span class=o>[]</span> <span class=n>bytes</span><span class=p>)</span> <span class=p>{</span>  
<a id=__codelineno-12-14 name=__codelineno-12-14></a><a href=#__codelineno-12-14><span class=linenos data-linenos="14 "></span></a>    <span class=n>StringBuilder</span> <span class=n>sb</span> <span class=o>=</span> <span class=k>new</span> <span class=n>StringBuilder</span><span class=p>();</span>  
<a id=__codelineno-12-15 name=__codelineno-12-15></a><a href=#__codelineno-12-15><span class=linenos data-linenos="15 "></span></a>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>bytes</span><span class=p>.</span><span class=na>length</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>  
<a id=__codelineno-12-16 name=__codelineno-12-16></a><a href=#__codelineno-12-16><span class=linenos data-linenos="16 "></span></a>        <span class=n>String</span> <span class=n>hex</span> <span class=o>=</span> <span class=n>Integer</span><span class=p>.</span><span class=na>toHexString</span><span class=p>(</span><span class=mh>0xFF</span> <span class=o>&amp;</span> <span class=n>bytes</span><span class=o>[</span><span class=n>i</span><span class=o>]</span><span class=p>);</span>  
<a id=__codelineno-12-17 name=__codelineno-12-17></a><a href=#__codelineno-12-17><span class=linenos data-linenos="17 "></span></a>        <span class=k>if</span> <span class=p>(</span><span class=n>hex</span><span class=p>.</span><span class=na>length</span><span class=p>()</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>  
<a id=__codelineno-12-18 name=__codelineno-12-18></a><a href=#__codelineno-12-18><span class=linenos data-linenos="18 "></span></a>            <span class=n>sb</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=sc>&#39;0&#39;</span><span class=p>);</span>  
<a id=__codelineno-12-19 name=__codelineno-12-19></a><a href=#__codelineno-12-19><span class=linenos data-linenos="19 "></span></a>        <span class=p>}</span>  
<a id=__codelineno-12-20 name=__codelineno-12-20></a><a href=#__codelineno-12-20><span class=linenos data-linenos="20 "></span></a>        <span class=n>sb</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>hex</span><span class=p>);</span>  
<a id=__codelineno-12-21 name=__codelineno-12-21></a><a href=#__codelineno-12-21><span class=linenos data-linenos="21 "></span></a>    <span class=p>}</span>  
<a id=__codelineno-12-22 name=__codelineno-12-22></a><a href=#__codelineno-12-22><span class=linenos data-linenos="22 "></span></a>    <span class=k>return</span> <span class=n>sb</span><span class=p>.</span><span class=na>toString</span><span class=p>();</span>  
<a id=__codelineno-12-23 name=__codelineno-12-23></a><a href=#__codelineno-12-23><span class=linenos data-linenos="23 "></span></a><span class=p>}</span>  
</code></pre></div></p> <p>有了<code>DiskLruCache.Editor</code>的实例之后，我们可以调用它的<code>newOutputStream()</code>方法来创建一个输出流，然后把它传入到网络下载图片的流中就能实现下载并写入缓存的功能了。</p> <p>注意<code>newOutputStream()</code>方法接收一个index参数，由于前面在设置valueCount的时候指定的是1，所以这里index传0就可以了。在写入操作执行完之后，我们还需要调用一下commit()方法进行提交才能使写入生效，调用abort()方法的话则表示回退此次操作。</p> <h4 id=223-disklrucache>2.2.3 DiskLruCache的读取<a class=headerlink href=#223-disklrucache title="Anchor link to this section for reference">&para;</a></h4> <p>和写入操作类似，通过<code>DiskLruCache#get</code>操作得到一个<code>Snapshot</code>对象，然后可以获得缓存文件的文件输入流，最后decode成<code>Bitmap</code>。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-13-1 name=__codelineno-13-1></a><a href=#__codelineno-13-1><span class=linenos data-linenos="1 "></span></a><span class=kd>public</span> <span class=kd>synchronized</span> <span class=n>Snapshot</span> <span class=nf>get</span><span class=p>(</span><span class=n>String</span> <span class=n>key</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>IOException</span>
</code></pre></div> <p>下面是<code>DiskLruCache</code>读取<code>Bitmap</code>的例子： <div class=highlight><pre><span></span><code><a id=__codelineno-14-1 name=__codelineno-14-1></a><a href=#__codelineno-14-1><span class=linenos data-linenos="1 "></span></a><span class=n>String</span> <span class=n>key</span> <span class=o>=</span> <span class=n>hashKeyForDisk</span><span class=p>(</span><span class=n>imageUrl</span><span class=p>);</span>  
<a id=__codelineno-14-2 name=__codelineno-14-2></a><a href=#__codelineno-14-2><span class=linenos data-linenos="2 "></span></a><span class=n>DiskLruCache</span><span class=p>.</span><span class=na>Snapshot</span> <span class=n>snapShot</span> <span class=o>=</span> <span class=n>mDiskLruCache</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>  
<a id=__codelineno-14-3 name=__codelineno-14-3></a><a href=#__codelineno-14-3><span class=linenos data-linenos="3 "></span></a><span class=k>if</span> <span class=p>(</span><span class=n>snapShot</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>  
<a id=__codelineno-14-4 name=__codelineno-14-4></a><a href=#__codelineno-14-4><span class=linenos data-linenos="4 "></span></a>    <span class=n>FileInputStream</span> <span class=n>is</span> <span class=o>=</span> <span class=p>(</span><span class=n>FileInputStream</span><span class=p>)</span> <span class=n>snapShot</span><span class=p>.</span><span class=na>getInputStream</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
<a id=__codelineno-14-5 name=__codelineno-14-5></a><a href=#__codelineno-14-5><span class=linenos data-linenos="5 "></span></a>    <span class=n>FileDescriptor</span> <span class=n>fileDescriptor</span> <span class=o>=</span> <span class=n>FileInputStream</span><span class=p>.</span><span class=na>getFD</span><span class=p>();</span>
<a id=__codelineno-14-6 name=__codelineno-14-6></a><a href=#__codelineno-14-6><span class=linenos data-linenos="6 "></span></a>    <span class=n>Bitmap</span> <span class=n>bitmap</span> <span class=o>=</span> <span class=n>ImageResizer</span><span class=p>.</span><span class=na>resize</span><span class=p>(</span><span class=n>fileDescriptor</span><span class=p>,</span> <span class=n>reqWidth</span><span class=p>,</span> <span class=n>reqHeight</span><span class=p>);</span>
<a id=__codelineno-14-7 name=__codelineno-14-7></a><a href=#__codelineno-14-7><span class=linenos data-linenos="7 "></span></a>    <span class=n>mImage</span><span class=p>.</span><span class=na>setImageBitmap</span><span class=p>(</span><span class=n>bitmap</span><span class=p>);</span>  
<a id=__codelineno-14-8 name=__codelineno-14-8></a><a href=#__codelineno-14-8><span class=linenos data-linenos="8 "></span></a><span class=p>}</span>  
</code></pre></div></p> <p><code>DiskLruCache</code>除了上面的方法以外，还有<code>remove</code>和<code>delete</code>方法用于磁盘的缓存的删除操作。<code>remove</code>会移除<code>key</code>对应的缓存，而<code>delete</code>会删除所有的磁盘缓存。 <div class=highlight><pre><span></span><code><a id=__codelineno-15-1 name=__codelineno-15-1></a><a href=#__codelineno-15-1><span class=linenos data-linenos="1 "></span></a><span class=kd>public</span> <span class=kd>synchronized</span> <span class=kt>boolean</span> <span class=nf>remove</span><span class=p>(</span><span class=n>String</span> <span class=n>key</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>IOException</span>
<a id=__codelineno-15-2 name=__codelineno-15-2></a><a href=#__codelineno-15-2><span class=linenos data-linenos="2 "></span></a><span class=kd>public</span> <span class=kt>void</span> <span class=nf>delete</span><span class=p>()</span> <span class=kd>throws</span> <span class=n>IOException</span>
</code></pre></div></p> <hr> <p><strong>参考文献</strong></p> <ul> <li><a href=http://blog.csdn.net/guolin_blog/article/details/28863651>Android DiskLruCache完全解析，硬盘缓存的最佳方案</a></li> </ul> <hr> <div class=md-source-file> <small> Last update: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">February 14, 2022</span> </small> </div> <!-- Giscus --> <h2 id=__comments>Comments</h2> <script src=https://giscus.app/client.js data-repo=wzasd/wzasd.github.io data-repo-id="MDEwOlJlcG9zaXRvcnk2NTQ0MDY0OA==" data-category=General data-category-id=DIC_kwDOA-aLiM4CA5Qt data-mapping=pathname data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=dark data-lang=zh-CN crossorigin=anonymous async>
</script> <!-- Replace with generated snippet --> <!-- Reload on palette change --> <script>
    var palette = __md_get("__palette")
    if (palette && typeof palette.color === "object")
      if (palette.color.scheme === "slate") {
        var giscus = document.querySelector("script[src*=giscus]")
        giscus.setAttribute("data-theme", "dark") // (1)!
      }

    /* Register event handlers after documented loaded */
    document.addEventListener("DOMContentLoaded", function() {
      var ref = document.querySelector("[data-md-component=palette]")
      ref.addEventListener("change", function() {
        var palette = __md_get("__palette")
        if (palette && typeof palette.color === "object") {
          var theme = palette.color.scheme === "slate" ? "dark" : "light"

          /* Instruct Giscus to change theme */
          var frame = document.querySelector(".giscus-frame")
          frame.contentWindow.postMessage(
            { giscus: { setConfig: { theme } } },
            "https://giscus.app"
          )
        }
      })
    })
  </script> <span id=busuanzi_container_site_uv>本站访客数<span id=busuanzi_value_site_uv></span>人次</span> </article> </div> </div> <a href=# class="md-top md-icon" data-md-component=top data-md-state=hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"/></svg> Back to top </a> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../Android%E7%BA%BF%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Android线程与线程池" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> Android线程与线程池 </div> </div> </a> <a href=../JNI%E4%B8%8ENDK/ class="md-footer__link md-footer__link--next" aria-label="Next: JNI与NDK编程简介" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Next </span> JNI与NDK编程简介 </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2015 - 2021 wzasd </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/wzasd target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33.85 0 1.71.11 2.5.33 1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2z"/></svg> </a> <a href=jeffrey@outlook.com target=_blank rel=noopener title class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m20 8-8 5-8-5V6l8 5 8-5m0-2H4c-1.11 0-2 .89-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../..", "features": ["navigation.instant", "navigation.tracking", "navigation.tabs", "navigation.indexes", "navigation.top", "toc.integrate", "search.suggest", "search.highlight"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../../assets/javascripts/workers/search.092fa1f6.min.js"}</script> <script src=../../../assets/javascripts/bundle.5a9542cf.min.js></script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script> <script src=../../../assets/js/busuanzi.pure.mini.js></script> </body> </html>