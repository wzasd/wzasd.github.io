<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content=讨论APP如何能解决IPC传输大数据问题以及原理。><link href=https://blog.founicy.top/android/other/android-ipc-big-data/ rel=canonical><link rel=icon href=../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.2.3, mkdocs-material-8.1.11"><title>Ashmem简介（Android IPC传输大数据） - wzasd's world</title><link rel=stylesheet href=../../../assets/stylesheets/main.50e68009.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.e6a45f82.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>:root{--md-text-font:"";--md-code-font:"Roboto Mono"}</style><script>__md_scope=new URL("../../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-Q6FXPH6HVX"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&gtag("event","search",{search_term:this.value})}),"undefined"!=typeof location$&&location$.subscribe(function(e){gtag("config","G-Q6FXPH6HVX",{page_path:e.pathname})})})</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-Q6FXPH6HVX"></script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=white data-md-color-accent=blue> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#_1 class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../../.. title="wzasd's world" class="md-header__button md-logo" aria-label="wzasd's world" data-md-component=logo> <img src=../../../assets/images/favicon.webp alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> wzasd's world </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Ashmem简介（Android IPC传输大数据） </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=white data-md-color-accent=blue aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary=black data-md-color-accent=deep-orange aria-label="Switch to light mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3z"/></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../../3rd-library/3rd-library-source-code/ class="md-tabs__link md-tabs__link--active"> Android </a> </li> <li class=md-tabs__item> <a href=../../../flutter/flutter_first_project_1/ class=md-tabs__link> Flutter </a> </li> <li class=md-tabs__item> <a href=../../../leetcode/ class=md-tabs__link> LeetCode </a> </li> <li class=md-tabs__item> <a href=../../../design-pattern/design-pattern/ class=md-tabs__link> Books </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../.. title="wzasd's world" class="md-nav__button md-logo" aria-label="wzasd's world" data-md-component=logo> <img src=../../../assets/images/favicon.webp alt=logo> </a> wzasd's world </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1 type=checkbox id=__nav_1 checked> <label class=md-nav__link for=__nav_1> Android <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Android data-md-level=1> <label class=md-nav__title for=__nav_1> <span class="md-nav__icon md-icon"></span> Android </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1_1 type=checkbox id=__nav_1_1> <label class=md-nav__link for=__nav_1_1> 三方库系列 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=三方库系列 data-md-level=2> <label class=md-nav__title for=__nav_1_1> <span class="md-nav__icon md-icon"></span> 三方库系列 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../3rd-library/3rd-library-source-code/ class=md-nav__link> Android三方库源码分析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/matrix/ class=md-nav__link> 微信APM Matrix解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/matrix-trace/ class=md-nav__link> Matrix-TraceCanary解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/matrix-io/ class=md-nav__link> Matrix-IOCanary解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/matrix-resource/ class=md-nav__link> Matrix-ResourceCanary解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/matrix-sqlitelint/ class=md-nav__link> Matrix-SQLiteLint解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/okhttp/ class=md-nav__link> OkHttp3源码解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/retrofit/ class=md-nav__link> Retrofit2源码解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/rxjava%26rxandroid/ class=md-nav__link> RxJava源码解析及使用实例 </a> </li> <li class=md-nav__item> <a href=../RxJava/ class=md-nav__link> RxJava操作符大全 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/glide1/ class=md-nav__link> Glide v4 源码解析（一） </a> </li> <li class=md-nav__item> <a href=../../3rd-library/glide2/ class=md-nav__link> Glide v4 源码解析（二） </a> </li> <li class=md-nav__item> <a href=../../3rd-library/glide3/ class=md-nav__link> Glide v4 源码解析（三） </a> </li> <li class=md-nav__item> <a href=../../3rd-library/glide4/ class=md-nav__link> Glide v4 源码解析（四） </a> </li> <li class=md-nav__item> <a href=../../3rd-library/glide5/ class=md-nav__link> Glide v4 源码解析（五） </a> </li> <li class=md-nav__item> <a href=../../3rd-library/glide6/ class=md-nav__link> Glide v4 源码解析（六） </a> </li> <li class=md-nav__item> <a href=../../3rd-library/glide7/ class=md-nav__link> Glide v4 源码解析（七） </a> </li> <li class=md-nav__item> <a href=../../3rd-library/migrate-to-glide/ class=md-nav__link> 杂记：从Picasso迁移至Glide </a> </li> <li class=md-nav__item> <a href=../../3rd-library/eventbus/ class=md-nav__link> EventBus源码解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/leakcanary/ class=md-nav__link> LeakCanary2源码解析 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/permissiondispatcher/ class=md-nav__link> PermissionDispatcher源码解析 </a> </li> <li class=md-nav__item> <a href=../constraintlayout/ class=md-nav__link> ConstraintLayout使用大全 </a> </li> <li class=md-nav__item> <a href=../dagger2/ class=md-nav__link> 初学者的Dagger2教程 </a> </li> <li class=md-nav__item> <a href=../../3rd-library/hotfix/ class=md-nav__link> Hotfix方案初探 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1_2 type=checkbox id=__nav_1_2> <label class=md-nav__link for=__nav_1_2> framework系列 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=framework系列 data-md-level=2> <label class=md-nav__title for=__nav_1_2> <span class="md-nav__icon md-icon"></span> framework系列 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../framework/Android%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%281%29/ class=md-nav__link> Activity </a> </li> <li class=md-nav__item> <a href=../../framework/Android%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%282%29/ class=md-nav__link> Service </a> </li> <li class=md-nav__item> <a href=../../framework/Android%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%283%29/ class=md-nav__link> Broadcasts </a> </li> <li class=md-nav__item> <a href=../../framework/Android%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%284%29/ class=md-nav__link> Content Providers与Fragment </a> </li> <li class=md-nav__item> <a href=../../framework/IPC%E6%9C%BA%E5%88%B6/ class=md-nav__link> IPC机制 </a> </li> <li class=md-nav__item> <a href=../../framework/View%E7%9A%84%E4%BA%8B%E4%BB%B6%E4%BD%93%E7%B3%BB/ class=md-nav__link> View的事件体系 </a> </li> <li class=md-nav__item> <a href=../../framework/View%E7%9A%84%E7%BB%98%E5%88%B6%E5%8E%9F%E7%90%86/ class=md-nav__link> View的绘制原理 </a> </li> <li class=md-nav__item> <a href=../../framework/RemoteViews/ class=md-nav__link> RemoteViews </a> </li> <li class=md-nav__item> <a href=../../framework/Drawable/ class=md-nav__link> Android中的Drawable资源 </a> </li> <li class=md-nav__item> <a href=../../framework/Android%E5%8A%A8%E7%94%BB/ class=md-nav__link> Android动画 </a> </li> <li class=md-nav__item> <a href=../../framework/Window%E4%B8%8EWindowManager/ class=md-nav__link> Window与WindowManager </a> </li> <li class=md-nav__item> <a href=../../framework/%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/ class=md-nav__link> 四大组件启动过程 </a> </li> <li class=md-nav__item> <a href=../../framework/Android%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6/ class=md-nav__link> Android消息机制 </a> </li> <li class=md-nav__item> <a href=../../framework/Android%E7%BA%BF%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0/ class=md-nav__link> Android线程与线程池 </a> </li> <li class=md-nav__item> <a href=../../framework/Bitmap%E7%9A%84%E7%BC%93%E5%AD%98%E4%B8%8E%E5%8A%A0%E8%BD%BD/ class=md-nav__link> Bitmap的缓存与加载 </a> </li> <li class=md-nav__item> <a href=../../framework/JNI%E4%B8%8ENDK/ class=md-nav__link> JNI与NDK编程简介 </a> </li> <li class=md-nav__item> <a href=../../framework/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/ class=md-nav__link> Android性能优化 </a> </li> <li class=md-nav__item> <a href=../../framework/binder1-mediaservice/ class=md-nav__link> Binder深入理解——以MediaService为例 </a> </li> <li class=md-nav__item> <a href=../../framework/binder2/ class=md-nav__link> Binder深入理解——罗老师系列 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1_3 type=checkbox id=__nav_1_3 checked> <label class=md-nav__link for=__nav_1_3> 杂记 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=杂记 data-md-level=2> <label class=md-nav__title for=__nav_1_3> <span class="md-nav__icon md-icon"></span> 杂记 </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Ashmem简介（Android IPC传输大数据） <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> Ashmem简介（Android IPC传输大数据） </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#ipc class=md-nav__link> IPC 方式 </a> <nav class=md-nav aria-label="IPC 方式"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#activity class=md-nav__link> Activity </a> </li> <li class=md-nav__item> <a href=#content-provider class=md-nav__link> Content Provider </a> </li> <li class=md-nav__item> <a href=#broadcast class=md-nav__link> Broadcast </a> </li> <li class=md-nav__item> <a href=#localsocket class=md-nav__link> LocalSocket </a> <nav class=md-nav aria-label=LocalSocket> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_2 class=md-nav__link> 客户端 </a> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> 服务端 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#aidl-service class=md-nav__link> AIDL Service </a> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> 小结 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#binder class=md-nav__link> Binder限制 </a> </li> <li class=md-nav__item> <a href=#linux class=md-nav__link> Linux共享内存 </a> <nav class=md-nav aria-label=Linux共享内存> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_5 class=md-nav__link> 读取进程 </a> </li> <li class=md-nav__item> <a href=#_6 class=md-nav__link> 写进程 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_7 class=md-nav__link> 思考 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../LocalSocket%EF%BC%8CSocket%20Websocket%20Http%2CP2P%E7%AD%89%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%28%E6%AD%A5%E9%AA%A4%29%EF%BC%88Demo%EF%BC%89/ class=md-nav__link> LocalSocket，Socket Websocket Http,P2P等网络编程(步骤)（Demo） </a> </li> <li class=md-nav__item> <a href=../commands/ class=md-nav__link> Android开发常见命令 </a> </li> <li class=md-nav__item> <a href=../android-tv/ class=md-nav__link> Android TV 专项 </a> </li> <li class=md-nav__item> <a href=../annotation/ class=md-nav__link> 注解的定义及解析 </a> </li> <li class=md-nav__item> <a href=../best_throttle_in_mvvm/ class=md-nav__link> 这可能是MVVM中最优雅的按键防抖方案 </a> </li> <li class=md-nav__item> <a href=../android-jenkins/ class=md-nav__link> Jenkins for android </a> </li> <li class=md-nav__item> <a href=../SystemProrities/ class=md-nav__link> 普通Android程序使用SystemProrities </a> </li> <li class=md-nav__item> <a href=../recyclerview-cache/ class=md-nav__link> ListView、RecyclerView缓存策略解析 </a> </li> <li class=md-nav__item> <a href=../recyclerview-item-docoration/ class=md-nav__link> RecyclerView高级特性——ItemDecoration </a> </li> <li class=md-nav__item> <a href=../recyclerview-others/ class=md-nav__link> RecyclerView的一些使用细节 </a> </li> <li class=md-nav__item> <a href=../RecyclerView-Sort%26Delete/ class=md-nav__link> RecyclerView高级特性——拖拽排序以及滑动删除 </a> </li> <li class=md-nav__item> <a href=../FAB-Behavior/ class=md-nav__link> FloatingActionButton上滑隐藏下滑显示 </a> </li> <li class=md-nav__item> <a href=../nestedscrolling/ class=md-nav__link> NestedScrolling机制 </a> </li> <li class=md-nav__item> <a href=../porterduff/ class=md-nav__link> 使用Porter-Duff合成数字图像 </a> </li> <li class=md-nav__item> <a href=../runtime/ class=md-nav__link> Android Runtime </a> </li> <li class=md-nav__item> <a href=../android_alias/ class=md-nav__link> Android马甲包的那些事儿 </a> </li> <li class=md-nav__item> <a href=../Android-Development-Tool/ class=md-nav__link> Android神兵利器 </a> </li> <li class=md-nav__item> <a href=../FileProvider/ class=md-nav__link> FileProvider </a> </li> <li class=md-nav__item> <a href=../Android%E5%88%A4%E6%96%AD%E5%AF%BC%E8%88%AA%E6%A0%8F%E9%AB%98%E5%BA%A6/ class=md-nav__link> Android判断虚拟按键(导航栏)显示与否、高度以及获取屏幕实际高度 </a> </li> <li class=md-nav__item> <a href=../Android%E5%9B%BE%E7%89%87%E9%80%89%E6%8B%A9%E5%99%A8/ class=md-nav__link> Android图片选择器 </a> </li> <li class=md-nav__item> <a href=../Android%E5%BA%95%E9%83%A8%E5%AF%BC%E8%88%AA%E6%A0%8F%E6%A1%86%E6%9E%B6/ class=md-nav__link> Android原生底部导航栏 </a> </li> <li class=md-nav__item> <a href=../Android%E6%90%9C%E7%B4%A2%E6%A0%8F%E7%9A%84%E5%AE%9E%E7%8E%B0/ class=md-nav__link> Android搜索栏的实现 </a> </li> <li class=md-nav__item> <a href=../Android%E6%9A%82%E5%81%9C%E9%9F%B3%E4%B9%90%E6%92%AD%E6%94%BE%E5%99%A8%E7%9A%84%E6%92%AD%E6%94%BE/ class=md-nav__link> Android暂停酷狗、网易云音乐等音乐播放器的播放 </a> </li> <li class=md-nav__item> <a href=../Android%E6%BB%91%E5%8A%A8%E8%BF%94%E5%9B%9E%E5%AE%9E%E8%B7%B5/ class=md-nav__link> Android滑动返回实践 </a> </li> <li class=md-nav__item> <a href=../Android%E7%A8%8B%E5%BA%8F%E5%8F%8D%E7%BC%96%E8%AF%91/ class=md-nav__link> MacOS下Android程序反编译 </a> </li> <li class=md-nav__item> <a href=../Android%E9%80%9A%E8%AE%AF%E5%BD%95%E5%BF%AB%E9%80%9F%E8%AF%BB%E5%8F%96/ class=md-nav__link> Android通讯录快速读取 </a> </li> <li class=md-nav__item> <a href=../soft-keyboard-in-app/ class=md-nav__link> App内自定义软键盘 </a> </li> <li class=md-nav__item> <a href=../%E8%85%BE%E8%AE%AFX5%E5%86%85%E6%A0%B8%E5%85%A5%E5%9D%91%E6%8C%87%E5%8D%97/ class=md-nav__link> 腾讯TBS X5浏览器内核入坑指南 </a> </li> <li class=md-nav__item> <a href=../%E7%90%90%E7%A2%8E%E7%9F%A5%E8%AF%86%E7%82%B9/ class=md-nav__link> 琐碎知识点 </a> </li> <li class=md-nav__item> <a href=../%E7%90%90%E7%A2%8E%E7%9F%A5%E8%AF%86%E7%82%B92/ class=md-nav__link> 琐碎知识点2 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week1-synchronized/ class=md-nav__link> 理解Java中synchronized关键词 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week2-service/ class=md-nav__link> 理解Service </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week3-activity/ class=md-nav__link> 理解Activity的启动模式 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week4-startActivityForResult/ class=md-nav__link> 关于startActivityForResult </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week5-view/ class=md-nav__link> 关于View的知识 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week6-gradle/ class=md-nav__link> 关于Gradle的知识 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week7-serialization/ class=md-nav__link> 关于序列化的知识 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week10-classloader/ class=md-nav__link> Android中的ClassLoader </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week11-binder/ class=md-nav__link> Binder简介 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week12-retrofit-okhttp/ class=md-nav__link> OkHttp和Retrofit的作用以及两者之间的联系 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week14-jvm-gc/ class=md-nav__link> JVM中垃圾回收策略 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week16-keep-app-alive/ class=md-nav__link> 进程保活 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week17-android-components/ class=md-nav__link> 四大组件的作用以及多进程 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week20-network-protocol/ class=md-nav__link> 网络协议 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week21-mvc%26mvp%26mvvm/ class=md-nav__link> MVC、MVP和MVVM </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week22-android-studio-build/ class=md-nav__link> Android Studio build过程 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week23-load-large-bitmap/ class=md-nav__link> 大尺寸图片加载问题 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1_4 type=checkbox id=__nav_1_4> <div class="md-nav__link md-nav__link--index "> <a href=../../paid/master/ >Android开发高手课</a> <label for=__nav_1_4> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label=Android开发高手课 data-md-level=2> <label class=md-nav__title for=__nav_1_4> <span class="md-nav__icon md-icon"></span> Android开发高手课 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../paid/master/crash_1/ class=md-nav__link> 01 | 崩溃优化（上）：关于“崩溃”那些事儿 </a> </li> <li class=md-nav__item> <a href=../../paid/master/crash_2/ class=md-nav__link> 02 | 崩溃优化（下）：应用崩溃了，你应该如何去分析？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/memory_1/ class=md-nav__link> 03 | 内存优化（上）：4GB内存时代，再谈内存优化 </a> </li> <li class=md-nav__item> <a href=../../paid/master/memory_2/ class=md-nav__link> 04 | 内存优化（下）：内存优化这件事，应该从哪里着手？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/stuck_1/ class=md-nav__link> 05 | 卡顿优化（上）：你要掌握的卡顿分析方法 </a> </li> <li class=md-nav__item> <a href=../../paid/master/stuck_2/ class=md-nav__link> 06 | 卡顿优化（下）：如何监控应用卡顿？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/stuck_3/ class=md-nav__link> 06补充篇 | 卡顿优化：卡顿现场与卡顿分析 </a> </li> <li class=md-nav__item> <a href=../../paid/master/start_1/ class=md-nav__link> 07 | 启动优化（上）：从启动过程看启动速度优化 </a> </li> <li class=md-nav__item> <a href=../../paid/master/start_2/ class=md-nav__link> 08 | 启动优化（下）：优化启动速度的进阶方法 </a> </li> <li class=md-nav__item> <a href=../../paid/master/io_1/ class=md-nav__link> 09 | I/O优化（上）：开发工程师必备的I/O优化知识 </a> </li> <li class=md-nav__item> <a href=../../paid/master/io_2/ class=md-nav__link> 10 | I/O优化（中）：不同I/O方式的使用场景是什么？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/io_3/ class=md-nav__link> 11 | I/O优化（下）：如何监控线上I/O操作？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/storage_1/ class=md-nav__link> 12 | 存储优化（上）：常见的数据存储方法有哪些？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/storage_2/ class=md-nav__link> 13 | 存储优化（中）：如何优化数据存储？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/storage_3/ class=md-nav__link> 14 | 存储优化（下）：数据库SQLite的使用和优化 </a> </li> <li class=md-nav__item> <a href=../../paid/master/network_1/ class=md-nav__link> 15 | 网络优化（上）：移动开发工程师必备的网络优化知识 </a> </li> <li class=md-nav__item> <a href=../../paid/master/network_2/ class=md-nav__link> 16 | 网络优化（中）：复杂多变的移动网络该如何优化？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/network_3/ class=md-nav__link> 17 | 网络优化（下）：大数据下网络该如何监控？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/battery_1/ class=md-nav__link> 18 | 耗电优化（上）：从电量优化的演进看耗电分析 </a> </li> <li class=md-nav__item> <a href=../../paid/master/battery_2/ class=md-nav__link> 19 | 耗电优化（下）：耗电的优化方法与线上监控 </a> </li> <li class=md-nav__item> <a href=../../paid/master/ui_1/ class=md-nav__link> 20 | UI 优化（上）：UI 渲染的几个关键概念 </a> </li> <li class=md-nav__item> <a href=../../paid/master/ui_2/ class=md-nav__link> 21 | UI 优化（下）：如何优化 UI 渲染？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/package_1/ class=md-nav__link> 22 | 包体积优化（上）：如何减少安装包大小？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/package_2/ class=md-nav__link> 23 | 包体积优化（下）：资源优化的进阶实践 </a> </li> <li class=md-nav__item> <a href=../../paid/master/compile/ class=md-nav__link> 26 | 关于编译，你需要了解什么？ </a> </li> <li class=md-nav__item> <a href=../../paid/master/bytecode/ class=md-nav__link> 27 | 编译插桩的三种方法：AspectJ、ASM、ReDex </a> </li> <li class=md-nav__item> <a href=../../paid/master/native_hook/ class=md-nav__link> 35 | Native Hook 技术，天使还是魔鬼？ </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2 type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2> Flutter <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Flutter data-md-level=1> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Flutter </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_1/ class=md-nav__link> 年轻人的第一个Flutter程序(1) </a> </li> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_2/ class=md-nav__link> 年轻人的第一个Flutter程序(2) </a> </li> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_3/ class=md-nav__link> 年轻人的第一个Flutter程序(3) </a> </li> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_4/ class=md-nav__link> 年轻人的第一个Flutter程序(4) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3 type=checkbox id=__nav_3> <div class="md-nav__link md-nav__link--index "> <a href=../../../leetcode/ >LeetCode</a> <label for=__nav_3> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label=LeetCode data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> LeetCode </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_1/ class=md-nav__link> 数据结构、算法和数据操作 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_3/ class=md-nav__link> 高质量的代码 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_4/ class=md-nav__link> 解决问题的思路 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_5/ class=md-nav__link> 优化时间和空间效率 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_6/ class=md-nav__link> 面试中的各项能力 </a> </li> <li class=md-nav__item> <a href=../../../leetcode/array/ class=md-nav__link> Array </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode1-10/ class=md-nav__link> LeetCode(1-10) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode11-20/ class=md-nav__link> LeetCode(11-20) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode21-30/ class=md-nav__link> LeetCode(21-30) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode31-40/ class=md-nav__link> LeetCode(31-40) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode41-50/ class=md-nav__link> LeetCode(41-50) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode51-60/ class=md-nav__link> LeetCode(51-60) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode61-70/ class=md-nav__link> LeetCode(61-70) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode71-80/ class=md-nav__link> LeetCode(71-80) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode81-90/ class=md-nav__link> LeetCode(81-90) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode91-100/ class=md-nav__link> LeetCode(91-100) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode101-110/ class=md-nav__link> LeetCode(101-110) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode111-120/ class=md-nav__link> LeetCode(111-120) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4 type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4> Books <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Books data-md-level=1> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Books </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_1 type=checkbox id=__nav_4_1> <label class=md-nav__link for=__nav_4_1> Design Pattern <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Design Pattern" data-md-level=2> <label class=md-nav__title for=__nav_4_1> <span class="md-nav__icon md-icon"></span> Design Pattern </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../design-pattern/design-pattern/ class=md-nav__link> 设计模式概述 </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/design-principle/ class=md-nav__link> 面向对象的六大原则 </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/singleton/ class=md-nav__link> 单例模式(Singleton) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/builder/ class=md-nav__link> 建造者模式(Builder) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/prototype/ class=md-nav__link> 原型模式(Prototype) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/factory-method/ class=md-nav__link> 工厂方法模式(Factory method) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/abstract-factory/ class=md-nav__link> 抽象工厂模式(Abstract factory) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/proxy/ class=md-nav__link> 代理模式(Proxy) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/composite/ class=md-nav__link> 组合模式(Composite) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/adapter/ class=md-nav__link> 适配器模式(Adapter) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/decorator/ class=md-nav__link> 装饰模式(Decorator) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/flyweight/ class=md-nav__link> 享元模式(Flyweight) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/facade/ class=md-nav__link> 外观模式(Facade) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/bridge/ class=md-nav__link> 桥接模式(Bridge) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/strategy/ class=md-nav__link> 策略模式(Strategy) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/state/ class=md-nav__link> 状态模式(State) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/chain-of-responsibility/ class=md-nav__link> 责任链模式(Chain of responsibility) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/interpreter/ class=md-nav__link> 解释器模式(Interpreter) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/command/ class=md-nav__link> 命令模式(Command) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/observer/ class=md-nav__link> 观察者模式(Observer) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/memento/ class=md-nav__link> 备忘录模式(Memento) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/iterator/ class=md-nav__link> 迭代器模式(Iterator) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/template-method/ class=md-nav__link> 模版方法模式(Template method) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/visitor/ class=md-nav__link> 访问者模式(Visitor) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/mediator/ class=md-nav__link> 中介者模式(Mediator) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/confusing-design-pattern/ class=md-nav__link> 易混淆的设计模式 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_2 type=checkbox id=__nav_4_2> <label class=md-nav__link for=__nav_4_2> Effective Java <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Effective Java" data-md-level=2> <label class=md-nav__title for=__nav_4_2> <span class="md-nav__icon md-icon"></span> Effective Java </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../effective-java/effective-java/ class=md-nav__link> Effective Java概述 </a> </li> <li class=md-nav__item> <a href=../../../effective-java/chapter1/ class=md-nav__link> 创建和销毁对象 </a> </li> <li class=md-nav__item> <a href=../../../effective-java/chapter2/ class=md-nav__link> 对于所有对象都通用的方法 </a> </li> <li class=md-nav__item> <a href=../../../effective-java/chapter3/ class=md-nav__link> 类和接口 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_3 type=checkbox id=__nav_4_3> <label class=md-nav__link for=__nav_4_3> JVM <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=JVM data-md-level=2> <label class=md-nav__title for=__nav_4_3> <span class="md-nav__icon md-icon"></span> JVM </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../jvm/jvm-content/ class=md-nav__link> 深入理解Java虚拟机 </a> </li> <li class=md-nav__item> <a href=../../../jvm/java-memory-area-oom/ class=md-nav__link> Java内存区域与内存溢出异常 </a> </li> <li class=md-nav__item> <a href=../../../jvm/java-gc/ class=md-nav__link> 垃圾收集器与内存分配策略 </a> </li> <li class=md-nav__item> <a href=../../../jvm/class-struct/ class=md-nav__link> 类文件结构 </a> </li> <li class=md-nav__item> <a href=../../../jvm/load-class/ class=md-nav__link> 虚拟机类加载机制 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_4 type=checkbox id=__nav_4_4> <label class=md-nav__link for=__nav_4_4> Java <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Java data-md-level=2> <label class=md-nav__title for=__nav_4_4> <span class="md-nav__icon md-icon"></span> Java </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../java/generics-java-kotlin/ class=md-nav__link> Java&Kotlin在泛型方面的区别 </a> </li> <li class=md-nav__item> <a href=../../../java/java-collections/ class=md-nav__link> Java集合总结 </a> </li> <li class=md-nav__item> <a href=../../../java/java-foundation/ class=md-nav__link> Java常见概念 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_5 type=checkbox id=__nav_4_5> <label class=md-nav__link for=__nav_4_5> Refactoring <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Refactoring data-md-level=2> <label class=md-nav__title for=__nav_4_5> <span class="md-nav__icon md-icon"></span> Refactoring </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../refactoring/refactoring/ class=md-nav__link> 重构：改善既有代码的设计 </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <span style=float:right;text-align:right;line-height:18px; id=busuanzi_container_page_pv>本文总阅读量<span id=busuanzi_value_page_pv></span>次</span> <!--more--> <p><meta name=referrer content=no-referrer></p> <h1 id=_1>前言<a class=headerlink href=#_1 title="Anchor link to this section for reference">&para;</a></h1> <p>Ashmem为什么会诞生？作用是什么？在聊这个问题之前我们先来了解Android的IPC都用那些，还有就是网上传得很火的binder限制1M是怎么回事，如何解决限制1M的问题？</p> <h2 id=ipc>IPC 方式<a class=headerlink href=#ipc title="Anchor link to this section for reference">&para;</a></h2> <h3 id=activity>Activity<a class=headerlink href=#activity title="Anchor link to this section for reference">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-0-1 name=__codelineno-0-1></a><a href=#__codelineno-0-1><span class=linenos data-linenos="1 "></span></a><span class=n>Intent</span> <span class=n>callIntent</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Intent</span><span class=p>(</span><span class=n>Intent</span><span class=p>.</span><span class=na>ACTION_CALL</span><span class=p>,</span> <span class=n>Uri</span><span class=p>.</span><span class=na>parse</span><span class=p>(</span><span class=s>&quot;tel:021-1234567&quot;</span> <span class=p>);</span> 
<a id=__codelineno-0-2 name=__codelineno-0-2></a><a href=#__codelineno-0-2><span class=linenos data-linenos="2 "></span></a><span class=n>mContext</span><span class=p>.</span><span class=na>startActivity</span><span class=p>(</span><span class=n>callIntent</span><span class=p>);</span>
</code></pre></div> <h3 id=content-provider>Content Provider<a class=headerlink href=#content-provider title="Anchor link to this section for reference">&para;</a></h3> <p>Android应用程序可以使用文件或SqlLite数据库来存储数据。 Content Provider提供了一种在多个应用程序之间数据共享的方式（跨进程共享数据），应用程序可以利用Content Provider完成下面的工作：</p> <ul> <li>查询数据</li> <li>修改数据</li> <li>添加数据</li> <li>删除数据</li> </ul> <h3 id=broadcast>Broadcast<a class=headerlink href=#broadcast title="Anchor link to this section for reference">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-1-1 name=__codelineno-1-1></a><a href=#__codelineno-1-1><span class=linenos data-linenos="1 "></span></a><span class=n>Intent</span> <span class=n>intent</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Intent</span><span class=p>(</span><span class=s>&quot;com.android.ACTION_TEST&quot;</span><span class=p>);</span>
<a id=__codelineno-1-2 name=__codelineno-1-2></a><a href=#__codelineno-1-2><span class=linenos data-linenos="2 "></span></a><span class=n>intent</span><span class=p>.</span><span class=na>putExtra</span><span class=p>(</span><span class=s>&quot;value&quot;</span><span class=p>,</span><span class=s>&quot;content&quot;</span><span class=p>);</span>
<a id=__codelineno-1-3 name=__codelineno-1-3></a><a href=#__codelineno-1-3><span class=linenos data-linenos="3 "></span></a><span class=n>mContext</span><span class=p>.</span><span class=na>sendBroadcast</span><span class=p>(</span><span class=n>intent</span><span class=p>);</span>
</code></pre></div> <h3 id=localsocket>LocalSocket<a class=headerlink href=#localsocket title="Anchor link to this section for reference">&para;</a></h3> <h4 id=_2>客户端<a class=headerlink href=#_2 title="Anchor link to this section for reference">&para;</a></h4> <div class=highlight><pre><span></span><code><a id=__codelineno-2-1 name=__codelineno-2-1></a><a href=#__codelineno-2-1><span class=linenos data-linenos=" 1 "></span></a><span class=n>客户端LocalSocket代码</span>
<a id=__codelineno-2-2 name=__codelineno-2-2></a><a href=#__codelineno-2-2><span class=linenos data-linenos=" 2 "></span></a>
<a id=__codelineno-2-3 name=__codelineno-2-3></a><a href=#__codelineno-2-3><span class=linenos data-linenos=" 3 "></span></a><span class=c1>//创建对象</span>
<a id=__codelineno-2-4 name=__codelineno-2-4></a><a href=#__codelineno-2-4><span class=linenos data-linenos=" 4 "></span></a><span class=n>LocalSocket</span> <span class=n>localSocket</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LocalSocket</span><span class=p>();</span>
<a id=__codelineno-2-5 name=__codelineno-2-5></a><a href=#__codelineno-2-5><span class=linenos data-linenos=" 5 "></span></a><span class=c1>//连接socketServerSocket</span>
<a id=__codelineno-2-6 name=__codelineno-2-6></a><a href=#__codelineno-2-6><span class=linenos data-linenos=" 6 "></span></a><span class=n>localSocket</span><span class=p>.</span><span class=na>connect</span><span class=p>(</span><span class=k>new</span> <span class=n>LocalSocketAddress</span><span class=p>(</span><span class=n>String</span> <span class=n>addrStr</span><span class=p>));</span>
<a id=__codelineno-2-7 name=__codelineno-2-7></a><a href=#__codelineno-2-7><span class=linenos data-linenos=" 7 "></span></a><span class=n>获取localSocket的输入输出流</span><span class=err>：</span>
<a id=__codelineno-2-8 name=__codelineno-2-8></a><a href=#__codelineno-2-8><span class=linenos data-linenos=" 8 "></span></a><span class=n>outputStream</span> <span class=o>=</span> <span class=n>localSocket</span><span class=p>.</span><span class=na>getOutputStream</span><span class=p>();</span>
<a id=__codelineno-2-9 name=__codelineno-2-9></a><a href=#__codelineno-2-9><span class=linenos data-linenos=" 9 "></span></a><span class=n>inputStream</span> <span class=o>=</span> <span class=n>localSocket</span><span class=p>.</span><span class=na>getInputStream</span><span class=p>();</span>
<a id=__codelineno-2-10 name=__codelineno-2-10></a><a href=#__codelineno-2-10><span class=linenos data-linenos="10 "></span></a><span class=n>写入数据</span><span class=err>：</span>
<a id=__codelineno-2-11 name=__codelineno-2-11></a><a href=#__codelineno-2-11><span class=linenos data-linenos="11 "></span></a><span class=n>outputStream</span><span class=p>.</span><span class=na>write</span><span class=p>(</span><span class=s>&quot;数据&quot;</span><span class=p>.</span><span class=na>getBytes</span><span class=p>());</span>
<a id=__codelineno-2-12 name=__codelineno-2-12></a><a href=#__codelineno-2-12><span class=linenos data-linenos="12 "></span></a><span class=n>循环接收数据</span><span class=err>：</span>
<a id=__codelineno-2-13 name=__codelineno-2-13></a><a href=#__codelineno-2-13><span class=linenos data-linenos="13 "></span></a><span class=k>try</span> <span class=p>{</span>    
<a id=__codelineno-2-14 name=__codelineno-2-14></a><a href=#__codelineno-2-14><span class=linenos data-linenos="14 "></span></a>    <span class=kt>int</span> <span class=n>readed</span> <span class=o>=</span> <span class=n>inputStream</span><span class=p>.</span><span class=na>read</span><span class=p>();</span>
<a id=__codelineno-2-15 name=__codelineno-2-15></a><a href=#__codelineno-2-15><span class=linenos data-linenos="15 "></span></a>    <span class=kt>int</span> <span class=n>size</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
<a id=__codelineno-2-16 name=__codelineno-2-16></a><a href=#__codelineno-2-16><span class=linenos data-linenos="16 "></span></a>    <span class=kt>byte</span><span class=o>[]</span> <span class=n>bytes</span> <span class=o>=</span> <span class=k>new</span> <span class=kt>byte</span><span class=o>[</span><span class=mi>0</span><span class=o>]</span><span class=p>;</span>
<a id=__codelineno-2-17 name=__codelineno-2-17></a><a href=#__codelineno-2-17><span class=linenos data-linenos="17 "></span></a>    <span class=k>while</span> <span class=p>(</span><span class=n>readed</span> <span class=o>!=</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-2-18 name=__codelineno-2-18></a><a href=#__codelineno-2-18><span class=linenos data-linenos="18 "></span></a>      <span class=kt>byte</span><span class=o>[]</span> <span class=n>copy</span> <span class=o>=</span> <span class=k>new</span> <span class=kt>byte</span><span class=o>[</span><span class=mi>500000</span><span class=o>]</span><span class=p>;</span> 
<a id=__codelineno-2-19 name=__codelineno-2-19></a><a href=#__codelineno-2-19><span class=linenos data-linenos="19 "></span></a>      <span class=n>System</span><span class=p>.</span><span class=na>arraycopy</span><span class=p>(</span><span class=n>bytes</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>copy</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>bytes</span><span class=p>.</span><span class=na>length</span><span class=p>);</span>
<a id=__codelineno-2-20 name=__codelineno-2-20></a><a href=#__codelineno-2-20><span class=linenos data-linenos="20 "></span></a>      <span class=n>bytes</span> <span class=o>=</span> <span class=n>copy</span><span class=p>;</span>
<a id=__codelineno-2-21 name=__codelineno-2-21></a><a href=#__codelineno-2-21><span class=linenos data-linenos="21 "></span></a>      <span class=n>bytes</span><span class=o>[</span><span class=n>size</span><span class=o>++]</span> <span class=o>=</span> <span class=p>(</span><span class=kt>byte</span><span class=p>)</span> <span class=n>readed</span><span class=p>;</span> 
<a id=__codelineno-2-22 name=__codelineno-2-22></a><a href=#__codelineno-2-22><span class=linenos data-linenos="22 "></span></a>      <span class=c1>//以换行符标识成结束</span>
<a id=__codelineno-2-23 name=__codelineno-2-23></a><a href=#__codelineno-2-23><span class=linenos data-linenos="23 "></span></a>      <span class=k>if</span> <span class=p>(</span><span class=sc>&#39;\n&#39;</span> <span class=o>==</span> <span class=p>(</span><span class=kt>byte</span><span class=p>)</span> <span class=n>readed</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-2-24 name=__codelineno-2-24></a><a href=#__codelineno-2-24><span class=linenos data-linenos="24 "></span></a>          <span class=n>String</span> <span class=n>resultStr</span> <span class=o>=</span> <span class=k>new</span> <span class=n>String</span><span class=p>(</span><span class=n>bytes</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>size</span><span class=p>);</span> 
<a id=__codelineno-2-25 name=__codelineno-2-25></a><a href=#__codelineno-2-25><span class=linenos data-linenos="25 "></span></a>          <span class=k>break</span><span class=p>;</span>                                                                             
<a id=__codelineno-2-26 name=__codelineno-2-26></a><a href=#__codelineno-2-26><span class=linenos data-linenos="26 "></span></a>    <span class=p>}</span> 
<a id=__codelineno-2-27 name=__codelineno-2-27></a><a href=#__codelineno-2-27><span class=linenos data-linenos="27 "></span></a>    <span class=n>readed</span> <span class=o>=</span> <span class=n>inputStream</span><span class=p>.</span><span class=na>read</span><span class=p>();</span>
<a id=__codelineno-2-28 name=__codelineno-2-28></a><a href=#__codelineno-2-28><span class=linenos data-linenos="28 "></span></a>    <span class=p>}</span>
<a id=__codelineno-2-29 name=__codelineno-2-29></a><a href=#__codelineno-2-29><span class=linenos data-linenos="29 "></span></a><span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>IOException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-2-30 name=__codelineno-2-30></a><a href=#__codelineno-2-30><span class=linenos data-linenos="30 "></span></a>    <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
<a id=__codelineno-2-31 name=__codelineno-2-31></a><a href=#__codelineno-2-31><span class=linenos data-linenos="31 "></span></a><span class=p>}</span>
</code></pre></div> <h4 id=_3>服务端<a class=headerlink href=#_3 title="Anchor link to this section for reference">&para;</a></h4> <div class=highlight><pre><span></span><code><a id=__codelineno-3-1 name=__codelineno-3-1></a><a href=#__codelineno-3-1><span class=linenos data-linenos=" 1 "></span></a><span class=n>服务端LocalServerSocket代码</span>
<a id=__codelineno-3-2 name=__codelineno-3-2></a><a href=#__codelineno-3-2><span class=linenos data-linenos=" 2 "></span></a>
<a id=__codelineno-3-3 name=__codelineno-3-3></a><a href=#__codelineno-3-3><span class=linenos data-linenos=" 3 "></span></a><span class=c1>//初始化</span>
<a id=__codelineno-3-4 name=__codelineno-3-4></a><a href=#__codelineno-3-4><span class=linenos data-linenos=" 4 "></span></a><span class=k>try</span> <span class=p>{</span>
<a id=__codelineno-3-5 name=__codelineno-3-5></a><a href=#__codelineno-3-5><span class=linenos data-linenos=" 5 "></span></a>    <span class=c1>//socketAddress需跟localSocket地址一致，否则无法连接上</span>
<a id=__codelineno-3-6 name=__codelineno-3-6></a><a href=#__codelineno-3-6><span class=linenos data-linenos=" 6 "></span></a>    <span class=n>serverSocket</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LocalServerSocket</span><span class=p>(</span><span class=n>socketAddress</span><span class=p>);</span>
<a id=__codelineno-3-7 name=__codelineno-3-7></a><a href=#__codelineno-3-7><span class=linenos data-linenos=" 7 "></span></a><span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>IOException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-3-8 name=__codelineno-3-8></a><a href=#__codelineno-3-8><span class=linenos data-linenos=" 8 "></span></a>    <span class=n>LoggerHelper</span><span class=p>.</span><span class=na>e</span><span class=p>(</span><span class=s>&quot;Server to establish connection exception:&quot;</span> <span class=o>+</span> <span class=n>e</span><span class=p>.</span><span class=na>toString</span><span class=p>());</span>
<a id=__codelineno-3-9 name=__codelineno-3-9></a><a href=#__codelineno-3-9><span class=linenos data-linenos=" 9 "></span></a>    <span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span>
<a id=__codelineno-3-10 name=__codelineno-3-10></a><a href=#__codelineno-3-10><span class=linenos data-linenos="10 "></span></a>    <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
<a id=__codelineno-3-11 name=__codelineno-3-11></a><a href=#__codelineno-3-11><span class=linenos data-linenos="11 "></span></a><span class=p>}</span>
<a id=__codelineno-3-12 name=__codelineno-3-12></a><a href=#__codelineno-3-12><span class=linenos data-linenos="12 "></span></a><span class=k>try</span> <span class=p>{</span>
<a id=__codelineno-3-13 name=__codelineno-3-13></a><a href=#__codelineno-3-13><span class=linenos data-linenos="13 "></span></a>    <span class=c1>//获取接收的LocalSocket</span>
<a id=__codelineno-3-14 name=__codelineno-3-14></a><a href=#__codelineno-3-14><span class=linenos data-linenos="14 "></span></a>    <span class=n>localSocket</span> <span class=o>=</span> <span class=n>serverSocket</span><span class=p>.</span><span class=na>accept</span><span class=p>();</span>
<a id=__codelineno-3-15 name=__codelineno-3-15></a><a href=#__codelineno-3-15><span class=linenos data-linenos="15 "></span></a>    <span class=c1>//设置缓冲大小</span>
<a id=__codelineno-3-16 name=__codelineno-3-16></a><a href=#__codelineno-3-16><span class=linenos data-linenos="16 "></span></a>    <span class=n>localSocket</span><span class=p>.</span><span class=na>setReceiveBufferSize</span><span class=p>(</span><span class=n>ConstantConfig</span><span class=p>.</span><span class=na>BUFFER_SIZE</span><span class=p>);</span>
<a id=__codelineno-3-17 name=__codelineno-3-17></a><a href=#__codelineno-3-17><span class=linenos data-linenos="17 "></span></a>    <span class=n>localSocket</span><span class=p>.</span><span class=na>setSendBufferSize</span><span class=p>(</span><span class=n>ConstantConfig</span><span class=p>.</span><span class=na>BUFFER_SIZE</span><span class=p>);</span>
<a id=__codelineno-3-18 name=__codelineno-3-18></a><a href=#__codelineno-3-18><span class=linenos data-linenos="18 "></span></a><span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>IOException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-3-19 name=__codelineno-3-19></a><a href=#__codelineno-3-19><span class=linenos data-linenos="19 "></span></a>    <span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span>
<a id=__codelineno-3-20 name=__codelineno-3-20></a><a href=#__codelineno-3-20><span class=linenos data-linenos="20 "></span></a>    <span class=n>LoggerHelper</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=s>&quot;Waiting to be linked to a bug,error:&quot;</span> <span class=o>+</span> <span class=n>e</span><span class=p>.</span><span class=na>toString</span><span class=p>());</span>
<a id=__codelineno-3-21 name=__codelineno-3-21></a><a href=#__codelineno-3-21><span class=linenos data-linenos="21 "></span></a>    <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
<a id=__codelineno-3-22 name=__codelineno-3-22></a><a href=#__codelineno-3-22><span class=linenos data-linenos="22 "></span></a><span class=p>}</span>
<a id=__codelineno-3-23 name=__codelineno-3-23></a><a href=#__codelineno-3-23><span class=linenos data-linenos="23 "></span></a><span class=n>获取输入输出流一致</span><span class=err>：</span>
<a id=__codelineno-3-24 name=__codelineno-3-24></a><a href=#__codelineno-3-24><span class=linenos data-linenos="24 "></span></a>
<a id=__codelineno-3-25 name=__codelineno-3-25></a><a href=#__codelineno-3-25><span class=linenos data-linenos="25 "></span></a><span class=k>if</span> <span class=p>(</span><span class=n>localSocket</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-3-26 name=__codelineno-3-26></a><a href=#__codelineno-3-26><span class=linenos data-linenos="26 "></span></a>    <span class=k>try</span> <span class=p>{</span>
<a id=__codelineno-3-27 name=__codelineno-3-27></a><a href=#__codelineno-3-27><span class=linenos data-linenos="27 "></span></a>        <span class=n>inputStream</span> <span class=o>=</span> <span class=n>localSocket</span><span class=p>.</span><span class=na>getInputStream</span><span class=p>();</span>
<a id=__codelineno-3-28 name=__codelineno-3-28></a><a href=#__codelineno-3-28><span class=linenos data-linenos="28 "></span></a>        <span class=n>outputStream</span> <span class=o>=</span> <span class=n>localSocket</span><span class=p>.</span><span class=na>getOutputStream</span><span class=p>();</span>
<a id=__codelineno-3-29 name=__codelineno-3-29></a><a href=#__codelineno-3-29><span class=linenos data-linenos="29 "></span></a>        <span class=cm>/** 允许一直接收数据，一直到连接被断开，则认为应用端退出，自己也退出 */</span>
<a id=__codelineno-3-30 name=__codelineno-3-30></a><a href=#__codelineno-3-30><span class=linenos data-linenos="30 "></span></a>        <span class=k>while</span> <span class=p>(</span><span class=n>isLock</span> <span class=o>&amp;&amp;</span> <span class=n>receiveData</span><span class=p>())</span> <span class=p>;</span>
<a id=__codelineno-3-31 name=__codelineno-3-31></a><a href=#__codelineno-3-31><span class=linenos data-linenos="31 "></span></a>    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>IOException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-3-32 name=__codelineno-3-32></a><a href=#__codelineno-3-32><span class=linenos data-linenos="32 "></span></a>        <span class=n>LoggerHelper</span><span class=p>.</span><span class=na>e</span><span class=p>(</span><span class=s>&quot;Get stream exception:&quot;</span> <span class=o>+</span> <span class=n>e</span><span class=p>.</span><span class=na>toString</span><span class=p>());</span>        <span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span>
<a id=__codelineno-3-33 name=__codelineno-3-33></a><a href=#__codelineno-3-33><span class=linenos data-linenos="33 "></span></a>        <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
<a id=__codelineno-3-34 name=__codelineno-3-34></a><a href=#__codelineno-3-34><span class=linenos data-linenos="34 "></span></a>    <span class=p>}</span>
<a id=__codelineno-3-35 name=__codelineno-3-35></a><a href=#__codelineno-3-35><span class=linenos data-linenos="35 "></span></a><span class=p>}</span>
</code></pre></div> <h3 id=aidl-service>AIDL Service<a class=headerlink href=#aidl-service title="Anchor link to this section for reference">&para;</a></h3> <p>aidl的基本用法请自行百度</p> <h3 id=_4>小结<a class=headerlink href=#_4 title="Anchor link to this section for reference">&para;</a></h3> <p>除了scocket的通信方式，其他的通信方式都是基于binder机制，所以肯定也受binder的一些限制，那么binder限制1M是从哪里看出来的呢?</p> <h2 id=binder>Binder限制<a class=headerlink href=#binder title="Anchor link to this section for reference">&para;</a></h2> <p>我们先来看看Binder初始化时候的代码：</p> <p><div class=highlight><pre><span></span><code><a id=__codelineno-4-1 name=__codelineno-4-1></a><a href=#__codelineno-4-1><span class=linenos data-linenos=" 1 "></span></a><span class=nl>http</span><span class=p>:</span><span class=c1>//aospxref.com/android-11.0.0_r21/xref/frameworks/native/libs/binder/ProcessState.cpp</span>
<a id=__codelineno-4-2 name=__codelineno-4-2></a><a href=#__codelineno-4-2><span class=linenos data-linenos=" 2 "></span></a>
<a id=__codelineno-4-3 name=__codelineno-4-3></a><a href=#__codelineno-4-3><span class=linenos data-linenos=" 3 "></span></a><span class=cp>#define BINDER_VM_SIZE ((1 * 1024 * 1024) - sysconf(_SC_PAGE_SIZE) * 2)</span>
<a id=__codelineno-4-4 name=__codelineno-4-4></a><a href=#__codelineno-4-4><span class=linenos data-linenos=" 4 "></span></a>
<a id=__codelineno-4-5 name=__codelineno-4-5></a><a href=#__codelineno-4-5><span class=linenos data-linenos=" 5 "></span></a><span class=n>ProcessState</span><span class=o>::</span><span class=n>ProcessState</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>driver</span><span class=p>)</span><span class=w></span>
<a id=__codelineno-4-6 name=__codelineno-4-6></a><a href=#__codelineno-4-6><span class=linenos data-linenos=" 6 "></span></a><span class=w>    </span><span class=o>:</span><span class=w> </span><span class=n>mDriverName</span><span class=p>(</span><span class=n>String8</span><span class=p>(</span><span class=n>driver</span><span class=p>))</span><span class=w></span>
<a id=__codelineno-4-7 name=__codelineno-4-7></a><a href=#__codelineno-4-7><span class=linenos data-linenos=" 7 "></span></a><span class=w>    </span><span class=p>,</span><span class=w> </span><span class=n>mDriverFD</span><span class=p>(</span><span class=n>open_driver</span><span class=p>(</span><span class=n>driver</span><span class=p>))</span><span class=w></span>
<a id=__codelineno-4-8 name=__codelineno-4-8></a><a href=#__codelineno-4-8><span class=linenos data-linenos=" 8 "></span></a><span class=w>    </span><span class=p>,</span><span class=w> </span><span class=n>mVMStart</span><span class=p>(</span><span class=n>MAP_FAILED</span><span class=p>)</span><span class=w></span>
<a id=__codelineno-4-9 name=__codelineno-4-9></a><a href=#__codelineno-4-9><span class=linenos data-linenos=" 9 "></span></a><span class=w>    </span><span class=p>,</span><span class=w> </span><span class=n>mThreadCountLock</span><span class=p>(</span><span class=n>PTHREAD_MUTEX_INITIALIZER</span><span class=p>)</span><span class=w></span>
<a id=__codelineno-4-10 name=__codelineno-4-10></a><a href=#__codelineno-4-10><span class=linenos data-linenos="10 "></span></a><span class=w>    </span><span class=p>,</span><span class=w> </span><span class=n>mThreadCountDecrement</span><span class=p>(</span><span class=n>PTHREAD_COND_INITIALIZER</span><span class=p>)</span><span class=w></span>
<a id=__codelineno-4-11 name=__codelineno-4-11></a><a href=#__codelineno-4-11><span class=linenos data-linenos="11 "></span></a><span class=w>    </span><span class=p>,</span><span class=w> </span><span class=n>mExecutingThreadsCount</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=w></span>
<a id=__codelineno-4-12 name=__codelineno-4-12></a><a href=#__codelineno-4-12><span class=linenos data-linenos="12 "></span></a><span class=w>    </span><span class=p>,</span><span class=w> </span><span class=n>mMaxThreads</span><span class=p>(</span><span class=n>DEFAULT_MAX_BINDER_THREADS</span><span class=p>)</span><span class=w></span>
<a id=__codelineno-4-13 name=__codelineno-4-13></a><a href=#__codelineno-4-13><span class=linenos data-linenos="13 "></span></a><span class=w>    </span><span class=p>,</span><span class=w> </span><span class=n>mStarvationStartTimeMs</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=w></span>
<a id=__codelineno-4-14 name=__codelineno-4-14></a><a href=#__codelineno-4-14><span class=linenos data-linenos="14 "></span></a><span class=w>    </span><span class=p>,</span><span class=w> </span><span class=n>mBinderContextCheckFunc</span><span class=p>(</span><span class=k>nullptr</span><span class=p>)</span><span class=w></span>
<a id=__codelineno-4-15 name=__codelineno-4-15></a><a href=#__codelineno-4-15><span class=linenos data-linenos="15 "></span></a><span class=w>    </span><span class=p>,</span><span class=w> </span><span class=n>mBinderContextUserData</span><span class=p>(</span><span class=k>nullptr</span><span class=p>)</span><span class=w></span>
<a id=__codelineno-4-16 name=__codelineno-4-16></a><a href=#__codelineno-4-16><span class=linenos data-linenos="16 "></span></a><span class=w>    </span><span class=p>,</span><span class=w> </span><span class=n>mThreadPoolStarted</span><span class=p>(</span><span class=nb>false</span><span class=p>)</span><span class=w></span>
<a id=__codelineno-4-17 name=__codelineno-4-17></a><a href=#__codelineno-4-17><span class=linenos data-linenos="17 "></span></a><span class=w>    </span><span class=p>,</span><span class=w> </span><span class=n>mThreadPoolSeq</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=w></span>
<a id=__codelineno-4-18 name=__codelineno-4-18></a><a href=#__codelineno-4-18><span class=linenos data-linenos="18 "></span></a><span class=w>    </span><span class=p>,</span><span class=w> </span><span class=n>mCallRestriction</span><span class=p>(</span><span class=n>CallRestriction</span><span class=o>::</span><span class=n>NONE</span><span class=p>)</span><span class=w></span>
<a id=__codelineno-4-19 name=__codelineno-4-19></a><a href=#__codelineno-4-19><span class=linenos data-linenos="19 "></span></a><span class=p>{</span><span class=w></span>
<a id=__codelineno-4-20 name=__codelineno-4-20></a><a href=#__codelineno-4-20><span class=linenos data-linenos="20 "></span></a>
<a id=__codelineno-4-21 name=__codelineno-4-21></a><a href=#__codelineno-4-21><span class=linenos data-linenos="21 "></span></a><span class=w>    </span><span class=p>...</span><span class=w></span>
<a id=__codelineno-4-22 name=__codelineno-4-22></a><a href=#__codelineno-4-22><span class=linenos data-linenos="22 "></span></a>
<a id=__codelineno-4-23 name=__codelineno-4-23></a><a href=#__codelineno-4-23><span class=linenos data-linenos="23 "></span></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>mDriverFD</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-4-24 name=__codelineno-4-24></a><a href=#__codelineno-4-24><span class=linenos data-linenos="24 "></span></a><span class=w>        </span><span class=c1>// mmap the binder, providing a chunk of virtual address space to receive transactions.</span>
<a id=__codelineno-4-25 name=__codelineno-4-25></a><a href=#__codelineno-4-25><span class=linenos data-linenos="25 "></span></a><span class=w>        </span><span class=n>mVMStart</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mmap</span><span class=p>(</span><span class=k>nullptr</span><span class=p>,</span><span class=w> </span><span class=n>BINDER_VM_SIZE</span><span class=p>,</span><span class=w> </span><span class=n>PROT_READ</span><span class=p>,</span><span class=w> </span><span class=n>MAP_PRIVATE</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>MAP_NORESERVE</span><span class=p>,</span><span class=w> </span><span class=n>mDriverFD</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-4-26 name=__codelineno-4-26></a><a href=#__codelineno-4-26><span class=linenos data-linenos="26 "></span></a>
<a id=__codelineno-4-27 name=__codelineno-4-27></a><a href=#__codelineno-4-27><span class=linenos data-linenos="27 "></span></a><span class=w>        </span><span class=p>...</span><span class=w></span>
<a id=__codelineno-4-28 name=__codelineno-4-28></a><a href=#__codelineno-4-28><span class=linenos data-linenos="28 "></span></a>
<a id=__codelineno-4-29 name=__codelineno-4-29></a><a href=#__codelineno-4-29><span class=linenos data-linenos="29 "></span></a><span class=w>    </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-4-30 name=__codelineno-4-30></a><a href=#__codelineno-4-30><span class=linenos data-linenos="30 "></span></a>
<a id=__codelineno-4-31 name=__codelineno-4-31></a><a href=#__codelineno-4-31><span class=linenos data-linenos="31 "></span></a><span class=w>    </span><span class=p>...</span><span class=w></span>
<a id=__codelineno-4-32 name=__codelineno-4-32></a><a href=#__codelineno-4-32><span class=linenos data-linenos="32 "></span></a>
<a id=__codelineno-4-33 name=__codelineno-4-33></a><a href=#__codelineno-4-33><span class=linenos data-linenos="33 "></span></a><span class=w> </span><span class=p>}</span><span class=w></span>
</code></pre></div> 能看到应用在初始化Binder的时候，已经限制了大小为1M-2页(1页=4k)的大小也就是1016k大小，所以网上说的限制1M其实不对，应该是1016K。 如果只是传输命令的话还可以，但是要传输图像数据这个大小根本不够。加上Binder内部有对每一个Binder内核缓冲区有自己的调度算法，没办法满足以最快的速度传输到SF进程中。也因此，Android选择使用共享内存的方式传递数据，也就是Ashmem匿名内存。 到这来其实我们还是不知道Ashmem到底是什么，了解Linux的同学应该都知道linux共享内存，那么我们先来了解一下Linux共享内存。</p> <h2 id=linux>Linux共享内存<a class=headerlink href=#linux title="Anchor link to this section for reference">&para;</a></h2> <p>首先看一下两个关键函数，</p> <ul> <li>int shmget(key_t key, size_t size, int shmflg); 该函数用来创建共享内存</li> <li>void *shmat(int shm_id, const void *shm_addr, int shmflg); 要想访问共享内存，必须将其映射到当前进程的地址空间<blockquote> <p>其中key_t是共享内存的唯一标识，可以说，Linux的共享内存其实是<strong>有名</strong>共享内存，而名字就是key，具体用法如下</p> </blockquote> </li> </ul> <h3 id=_5>读取进程<a class=headerlink href=#_5 title="Anchor link to this section for reference">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-5-1 name=__codelineno-5-1></a><a href=#__codelineno-5-1><span class=linenos data-linenos=" 1 "></span></a><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>  
<a id=__codelineno-5-2 name=__codelineno-5-2></a><a href=#__codelineno-5-2><span class=linenos data-linenos=" 2 "></span></a><span class=p>{</span>  
<a id=__codelineno-5-3 name=__codelineno-5-3></a><a href=#__codelineno-5-3><span class=linenos data-linenos=" 3 "></span></a>    <span class=kt>void</span> <span class=o>*</span><span class=n>shm</span> <span class=o>=</span> <span class=n>NULL</span><span class=p>;</span><span class=c1>//分配的共享内存的原始首地址  </span>
<a id=__codelineno-5-4 name=__codelineno-5-4></a><a href=#__codelineno-5-4><span class=linenos data-linenos=" 4 "></span></a>    <span class=n>struct</span> <span class=n>shared_use_st</span> <span class=o>*</span><span class=n>shared</span><span class=p>;</span><span class=c1>//指向shm  </span>
<a id=__codelineno-5-5 name=__codelineno-5-5></a><a href=#__codelineno-5-5><span class=linenos data-linenos=" 5 "></span></a>    <span class=kt>int</span> <span class=n>shmid</span><span class=p>;</span><span class=c1>//共享内存标识符  </span>
<a id=__codelineno-5-6 name=__codelineno-5-6></a><a href=#__codelineno-5-6><span class=linenos data-linenos=" 6 "></span></a>    <span class=c1>//创建共享内存  </span>
<a id=__codelineno-5-7 name=__codelineno-5-7></a><a href=#__codelineno-5-7><span class=linenos data-linenos=" 7 "></span></a>    <span class=n>shmid</span> <span class=o>=</span> <span class=n>shmget</span><span class=p>((</span><span class=n>key_t</span><span class=p>)</span><span class=mi>12345</span><span class=p>,</span> <span class=n>sizeof</span><span class=p>(</span><span class=n>struct</span> <span class=n>shared_use_st</span><span class=p>),</span> <span class=mo>0666</span><span class=o>|</span><span class=n>IPC_CREAT</span><span class=p>);</span>   
<a id=__codelineno-5-8 name=__codelineno-5-8></a><a href=#__codelineno-5-8><span class=linenos data-linenos=" 8 "></span></a>    <span class=c1>//将共享内存映射到当前进程的地址空间  </span>
<a id=__codelineno-5-9 name=__codelineno-5-9></a><a href=#__codelineno-5-9><span class=linenos data-linenos=" 9 "></span></a>    <span class=n>shm</span> <span class=o>=</span> <span class=n>shmat</span><span class=p>(</span><span class=n>shmid</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
<a id=__codelineno-5-10 name=__codelineno-5-10></a><a href=#__codelineno-5-10><span class=linenos data-linenos="10 "></span></a>    <span class=c1>//设置共享内存  </span>
<a id=__codelineno-5-11 name=__codelineno-5-11></a><a href=#__codelineno-5-11><span class=linenos data-linenos="11 "></span></a>    <span class=n>shared</span> <span class=o>=</span> <span class=p>(</span><span class=n>struct</span> <span class=n>shared_use_st</span><span class=o>*</span><span class=p>)</span><span class=n>shm</span><span class=p>;</span>  
<a id=__codelineno-5-12 name=__codelineno-5-12></a><a href=#__codelineno-5-12><span class=linenos data-linenos="12 "></span></a>    <span class=n>shared</span><span class=o>-&gt;</span><span class=n>written</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>  
<a id=__codelineno-5-13 name=__codelineno-5-13></a><a href=#__codelineno-5-13><span class=linenos data-linenos="13 "></span></a>    <span class=c1>//访问共享内存</span>
<a id=__codelineno-5-14 name=__codelineno-5-14></a><a href=#__codelineno-5-14><span class=linenos data-linenos="14 "></span></a>    <span class=k>while</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-5-15 name=__codelineno-5-15></a><a href=#__codelineno-5-15><span class=linenos data-linenos="15 "></span></a>        <span class=k>if</span><span class=p>(</span><span class=n>shared</span><span class=o>-&gt;</span><span class=n>written</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span> 
<a id=__codelineno-5-16 name=__codelineno-5-16></a><a href=#__codelineno-5-16><span class=linenos data-linenos="16 "></span></a>            <span class=n>printf</span><span class=p>(</span><span class=s>&quot;You wrote: %s&quot;</span><span class=p>,</span> <span class=n>shared</span><span class=o>-&gt;</span><span class=n>text</span><span class=p>);</span>
<a id=__codelineno-5-17 name=__codelineno-5-17></a><a href=#__codelineno-5-17><span class=linenos data-linenos="17 "></span></a>             <span class=k>if</span><span class=p>(</span><span class=n>strncmp</span><span class=p>(</span><span class=n>shared</span><span class=o>-&gt;</span><span class=n>text</span><span class=p>,</span> <span class=s>&quot;end&quot;</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>  
<a id=__codelineno-5-18 name=__codelineno-5-18></a><a href=#__codelineno-5-18><span class=linenos data-linenos="18 "></span></a>                <span class=k>break</span><span class=p>;</span>
<a id=__codelineno-5-19 name=__codelineno-5-19></a><a href=#__codelineno-5-19><span class=linenos data-linenos="19 "></span></a>            <span class=p>}}</span>
<a id=__codelineno-5-20 name=__codelineno-5-20></a><a href=#__codelineno-5-20><span class=linenos data-linenos="20 "></span></a>    <span class=c1>//把共享内存从当前进程中分离  </span>
<a id=__codelineno-5-21 name=__codelineno-5-21></a><a href=#__codelineno-5-21><span class=linenos data-linenos="21 "></span></a>    <span class=k>if</span><span class=p>(</span><span class=n>shmdt</span><span class=p>(</span><span class=n>shm</span><span class=p>)</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span> <span class=p>}</span>  
<a id=__codelineno-5-22 name=__codelineno-5-22></a><a href=#__codelineno-5-22><span class=linenos data-linenos="22 "></span></a>    <span class=c1>//删除共享内存  </span>
<a id=__codelineno-5-23 name=__codelineno-5-23></a><a href=#__codelineno-5-23><span class=linenos data-linenos="23 "></span></a>    <span class=k>if</span><span class=p>(</span><span class=n>shmctl</span><span class=p>(</span><span class=n>shmid</span><span class=p>,</span> <span class=n>IPC_RMID</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>  <span class=p>}</span>  
<a id=__codelineno-5-24 name=__codelineno-5-24></a><a href=#__codelineno-5-24><span class=linenos data-linenos="24 "></span></a>    <span class=n>exit</span><span class=p>(</span><span class=n>EXIT_SUCCESS</span><span class=p>);</span>  
<a id=__codelineno-5-25 name=__codelineno-5-25></a><a href=#__codelineno-5-25><span class=linenos data-linenos="25 "></span></a><span class=p>}</span>  
</code></pre></div> <h3 id=_6>写进程<a class=headerlink href=#_6 title="Anchor link to this section for reference">&para;</a></h3> <p><div class=highlight><pre><span></span><code><a id=__codelineno-6-1 name=__codelineno-6-1></a><a href=#__codelineno-6-1><span class=linenos data-linenos=" 1 "></span></a><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span>  
<a id=__codelineno-6-2 name=__codelineno-6-2></a><a href=#__codelineno-6-2><span class=linenos data-linenos=" 2 "></span></a><span class=p>{</span>  
<a id=__codelineno-6-3 name=__codelineno-6-3></a><a href=#__codelineno-6-3><span class=linenos data-linenos=" 3 "></span></a>    <span class=kt>void</span> <span class=o>*</span><span class=n>shm</span> <span class=o>=</span> <span class=n>NULL</span><span class=p>;</span>  
<a id=__codelineno-6-4 name=__codelineno-6-4></a><a href=#__codelineno-6-4><span class=linenos data-linenos=" 4 "></span></a>    <span class=n>struct</span> <span class=n>shared_use_st</span> <span class=o>*</span><span class=n>shared</span> <span class=o>=</span> <span class=n>NULL</span><span class=p>;</span>  
<a id=__codelineno-6-5 name=__codelineno-6-5></a><a href=#__codelineno-6-5><span class=linenos data-linenos=" 5 "></span></a>    <span class=kt>char</span> <span class=n>buffer</span><span class=o>[</span><span class=n>BUFSIZ</span> <span class=o>+</span> <span class=mi>1</span><span class=o>]</span><span class=p>;</span><span class=c1>//用于保存输入的文本  </span>
<a id=__codelineno-6-6 name=__codelineno-6-6></a><a href=#__codelineno-6-6><span class=linenos data-linenos=" 6 "></span></a>    <span class=kt>int</span> <span class=n>shmid</span><span class=p>;</span>  
<a id=__codelineno-6-7 name=__codelineno-6-7></a><a href=#__codelineno-6-7><span class=linenos data-linenos=" 7 "></span></a>    <span class=c1>//创建共享内存  </span>
<a id=__codelineno-6-8 name=__codelineno-6-8></a><a href=#__codelineno-6-8><span class=linenos data-linenos=" 8 "></span></a>    <span class=n>shmid</span> <span class=o>=</span> <span class=n>shmget</span><span class=p>((</span><span class=n>key_t</span><span class=p>)</span> <span class=mi>12345</span><span class=p>,</span> <span class=n>sizeof</span><span class=p>(</span><span class=n>struct</span> <span class=n>shared_use_st</span><span class=p>),</span> <span class=mo>0666</span><span class=o>|</span><span class=n>IPC_CREAT</span><span class=p>);</span>  
<a id=__codelineno-6-9 name=__codelineno-6-9></a><a href=#__codelineno-6-9><span class=linenos data-linenos=" 9 "></span></a>    <span class=c1>//将共享内存连接到当前进程的地址空间  </span>
<a id=__codelineno-6-10 name=__codelineno-6-10></a><a href=#__codelineno-6-10><span class=linenos data-linenos="10 "></span></a>    <span class=n>shm</span> <span class=o>=</span> <span class=n>shmat</span><span class=p>(</span><span class=n>shmid</span><span class=p>,</span> <span class=p>(</span><span class=kt>void</span><span class=o>*</span><span class=p>)</span><span class=mi>0</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>  
<a id=__codelineno-6-11 name=__codelineno-6-11></a><a href=#__codelineno-6-11><span class=linenos data-linenos="11 "></span></a>    <span class=n>printf</span><span class=p>(</span><span class=s>&quot;Memory attached at %X\n&quot;</span><span class=p>,</span> <span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=n>shm</span><span class=p>);</span>  
<a id=__codelineno-6-12 name=__codelineno-6-12></a><a href=#__codelineno-6-12><span class=linenos data-linenos="12 "></span></a>    <span class=c1>//设置共享内存  </span>
<a id=__codelineno-6-13 name=__codelineno-6-13></a><a href=#__codelineno-6-13><span class=linenos data-linenos="13 "></span></a>    <span class=n>shared</span> <span class=o>=</span> <span class=p>(</span><span class=n>struct</span> <span class=n>shared_use_st</span><span class=o>*</span><span class=p>)</span><span class=n>shm</span><span class=p>;</span>  
<a id=__codelineno-6-14 name=__codelineno-6-14></a><a href=#__codelineno-6-14><span class=linenos data-linenos="14 "></span></a>    <span class=k>while</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span><span class=c1>//向共享内存中写数据  </span>
<a id=__codelineno-6-15 name=__codelineno-6-15></a><a href=#__codelineno-6-15><span class=linenos data-linenos="15 "></span></a>    <span class=p>{</span>  
<a id=__codelineno-6-16 name=__codelineno-6-16></a><a href=#__codelineno-6-16><span class=linenos data-linenos="16 "></span></a>        <span class=c1>//数据还没有被读取，则等待数据被读取,不能向共享内存中写入文本  </span>
<a id=__codelineno-6-17 name=__codelineno-6-17></a><a href=#__codelineno-6-17><span class=linenos data-linenos="17 "></span></a>        <span class=k>while</span><span class=p>(</span><span class=n>shared</span><span class=o>-&gt;</span><span class=n>written</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span>  
<a id=__codelineno-6-18 name=__codelineno-6-18></a><a href=#__codelineno-6-18><span class=linenos data-linenos="18 "></span></a>        <span class=p>{</span>  
<a id=__codelineno-6-19 name=__codelineno-6-19></a><a href=#__codelineno-6-19><span class=linenos data-linenos="19 "></span></a>            <span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>  
<a id=__codelineno-6-20 name=__codelineno-6-20></a><a href=#__codelineno-6-20><span class=linenos data-linenos="20 "></span></a>        <span class=p>}</span>  
<a id=__codelineno-6-21 name=__codelineno-6-21></a><a href=#__codelineno-6-21><span class=linenos data-linenos="21 "></span></a>        <span class=c1>//向共享内存中写入数据  </span>
<a id=__codelineno-6-22 name=__codelineno-6-22></a><a href=#__codelineno-6-22><span class=linenos data-linenos="22 "></span></a>        <span class=n>fgets</span><span class=p>(</span><span class=n>buffer</span><span class=p>,</span> <span class=n>BUFSIZ</span><span class=p>,</span> <span class=n>stdin</span><span class=p>);</span>  
<a id=__codelineno-6-23 name=__codelineno-6-23></a><a href=#__codelineno-6-23><span class=linenos data-linenos="23 "></span></a>        <span class=n>strncpy</span><span class=p>(</span><span class=n>shared</span><span class=o>-&gt;</span><span class=n>text</span><span class=p>,</span> <span class=n>buffer</span><span class=p>,</span> <span class=n>TEXT_SZ</span><span class=p>);</span>  
<a id=__codelineno-6-24 name=__codelineno-6-24></a><a href=#__codelineno-6-24><span class=linenos data-linenos="24 "></span></a>        <span class=n>shared</span><span class=o>-&gt;</span><span class=n>written</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>  
<a id=__codelineno-6-25 name=__codelineno-6-25></a><a href=#__codelineno-6-25><span class=linenos data-linenos="25 "></span></a>        <span class=k>if</span><span class=p>(</span><span class=n>strncmp</span><span class=p>(</span><span class=n>buffer</span><span class=p>,</span> <span class=s>&quot;end&quot;</span><span class=p>,</span> <span class=mi>3</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>  
<a id=__codelineno-6-26 name=__codelineno-6-26></a><a href=#__codelineno-6-26><span class=linenos data-linenos="26 "></span></a>            <span class=n>running</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>  
<a id=__codelineno-6-27 name=__codelineno-6-27></a><a href=#__codelineno-6-27><span class=linenos data-linenos="27 "></span></a>    <span class=p>}</span>  
<a id=__codelineno-6-28 name=__codelineno-6-28></a><a href=#__codelineno-6-28><span class=linenos data-linenos="28 "></span></a>    <span class=c1>//把共享内存从当前进程中分离  </span>
<a id=__codelineno-6-29 name=__codelineno-6-29></a><a href=#__codelineno-6-29><span class=linenos data-linenos="29 "></span></a>    <span class=k>if</span><span class=p>(</span><span class=n>shmdt</span><span class=p>(</span><span class=n>shm</span><span class=p>)</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=p>{</span>    <span class=p>}</span>  
<a id=__codelineno-6-30 name=__codelineno-6-30></a><a href=#__codelineno-6-30><span class=linenos data-linenos="30 "></span></a>    <span class=n>sleep</span><span class=p>(</span><span class=mi>2</span><span class=p>);</span>  
<a id=__codelineno-6-31 name=__codelineno-6-31></a><a href=#__codelineno-6-31><span class=linenos data-linenos="31 "></span></a>    <span class=n>exit</span><span class=p>(</span><span class=n>EXIT_SUCCESS</span><span class=p>);</span>  
<a id=__codelineno-6-32 name=__codelineno-6-32></a><a href=#__codelineno-6-32><span class=linenos data-linenos="32 "></span></a><span class=p>}</span> 
</code></pre></div> 可以看到，Linux共享内存通信效率非常高，进程间不需要传递数据，便可以直接访问，缺点也很明显，Linux共享内存没有提供同步的机制，在使用时，要借助其他的手段来处理进程间同步。</p> <h2 id=_7>思考<a class=headerlink href=#_7 title="Anchor link to this section for reference">&para;</a></h2> <p>在Android系统中，APP端View视图的数据是如何传递SurfaceFlinger服务的呢？View绘制的数据最终是按照一帧一帧显示到屏幕的，而每一帧都会占用一定的存储空间，在APP端执行draw的时候，数据很明显是要绘制到APP的进程空间，但是视图窗口要经过SurfaceFlinger图层混排才会生成最终的帧，而SurfaceFlinger又运行在另一个独立的服务进程，那么View视图的数据是如何在两个进程间传递的呢，普通的Binder通信肯定不行，因为Binder不太适合这种数据量较大的通信，那么View数据的通信采用的是什么IPC手段呢？ 答案就是共享内存，更精确的说是匿名共享内存。也就是我们之前一直提到的Ashmem。 Android直接在Linux共享内存机制上做出改进，进而形成了Android的匿名共享内存（Anonymous Shared Memory-Ashmem）。 通过Ashmem，APP进程同SurfaceFlinger共用一块内存，如此，就不需要进行数据拷贝，APP端绘制完毕，通知SurfaceFlinger端合成，再输出到硬件进行显示即可。 <img alt=image.png src="https://cdn.nlark.com/yuque/0/2021/png/1759879/1631929666796-8fbcc6a4-562e-4191-9109-485875386c19.png#clientId=u0b0c0eaa-bd62-4&from=paste&id=u32755f18&margin=%5Bobject%20Object%5D&name=image.png&originHeight=2844&originWidth=4182&originalType=url&ratio=1&size=2248211&status=done&style=none&taskId=u108b0194-0de3-4387-8023-f6d69d19341"> （图片来源于网络）</p> <h1 id=_8>使用<a class=headerlink href=#_8 title="Anchor link to this section for reference">&para;</a></h1> <p>其实Ashmem不仅仅只是内核中能够使用，其实在Java层Android也提供了一个名为MemoryFile的类提供方便使用匿名共享内存，本次就以MemoryFile为切口，来聊聊Ashmem匿名内存的使用。 <div class=highlight><pre><span></span><code><a id=__codelineno-7-1 name=__codelineno-7-1></a><a href=#__codelineno-7-1><span class=linenos data-linenos=" 1 "></span></a><span class=cm>/**</span>
<a id=__codelineno-7-2 name=__codelineno-7-2></a><a href=#__codelineno-7-2><span class=linenos data-linenos=" 2 "></span></a><span class=cm> * IMemoryAidlInterface.aidl</span>
<a id=__codelineno-7-3 name=__codelineno-7-3></a><a href=#__codelineno-7-3><span class=linenos data-linenos=" 3 "></span></a><span class=cm> */</span><span class=w></span>
<a id=__codelineno-7-4 name=__codelineno-7-4></a><a href=#__codelineno-7-4><span class=linenos data-linenos=" 4 "></span></a><span class=n>package</span><span class=w> </span><span class=n>com</span><span class=p>.</span><span class=n>journeyOS</span><span class=p>.</span><span class=n>ipcbigdata</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-7-5 name=__codelineno-7-5></a><a href=#__codelineno-7-5><span class=linenos data-linenos=" 5 "></span></a><span class=k>import</span><span class=w> </span><span class=n>android</span><span class=p>.</span><span class=n>os</span><span class=p>.</span><span class=n>ParcelFileDescriptor</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-7-6 name=__codelineno-7-6></a><a href=#__codelineno-7-6><span class=linenos data-linenos=" 6 "></span></a>
<a id=__codelineno-7-7 name=__codelineno-7-7></a><a href=#__codelineno-7-7><span class=linenos data-linenos=" 7 "></span></a><span class=n>interface</span><span class=w> </span><span class=n>IMemoryAidlInterface</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-7-8 name=__codelineno-7-8></a><a href=#__codelineno-7-8><span class=linenos data-linenos=" 8 "></span></a><span class=w>    </span><span class=n>ParcelFileDescriptor</span><span class=w> </span><span class=nf>getParcelFileDescriptor</span><span class=p>();</span><span class=w></span>
<a id=__codelineno-7-9 name=__codelineno-7-9></a><a href=#__codelineno-7-9><span class=linenos data-linenos=" 9 "></span></a><span class=p>}</span><span class=w></span>
<a id=__codelineno-7-10 name=__codelineno-7-10></a><a href=#__codelineno-7-10><span class=linenos data-linenos="10 "></span></a>
<a id=__codelineno-7-11 name=__codelineno-7-11></a><a href=#__codelineno-7-11><span class=linenos data-linenos="11 "></span></a>
<a id=__codelineno-7-12 name=__codelineno-7-12></a><a href=#__codelineno-7-12><span class=linenos data-linenos="12 "></span></a><span class=cm>/**</span>
<a id=__codelineno-7-13 name=__codelineno-7-13></a><a href=#__codelineno-7-13><span class=linenos data-linenos="13 "></span></a><span class=cm> * MemoryFetchService.java</span>
<a id=__codelineno-7-14 name=__codelineno-7-14></a><a href=#__codelineno-7-14><span class=linenos data-linenos="14 "></span></a><span class=cm> */</span><span class=w></span>
<a id=__codelineno-7-15 name=__codelineno-7-15></a><a href=#__codelineno-7-15><span class=linenos data-linenos="15 "></span></a><span class=k>public</span><span class=w> </span><span class=k>class</span><span class=w> </span><span class=nc>MemoryFetchService</span><span class=w> </span><span class=n>extends</span><span class=w> </span><span class=n>Service</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-7-16 name=__codelineno-7-16></a><a href=#__codelineno-7-16><span class=linenos data-linenos="16 "></span></a><span class=w>    </span><span class=err>@</span><span class=n>Nullable</span><span class=w></span>
<a id=__codelineno-7-17 name=__codelineno-7-17></a><a href=#__codelineno-7-17><span class=linenos data-linenos="17 "></span></a><span class=w>    </span><span class=err>@</span><span class=n>Override</span><span class=w></span>
<a id=__codelineno-7-18 name=__codelineno-7-18></a><a href=#__codelineno-7-18><span class=linenos data-linenos="18 "></span></a><span class=w>    </span><span class=k>public</span><span class=w> </span><span class=n>IBinder</span><span class=w> </span><span class=n>onBind</span><span class=p>(</span><span class=n>Intent</span><span class=w> </span><span class=n>intent</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-7-19 name=__codelineno-7-19></a><a href=#__codelineno-7-19><span class=linenos data-linenos="19 "></span></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>MemoryFetchStub</span><span class=p>();</span><span class=w></span>
<a id=__codelineno-7-20 name=__codelineno-7-20></a><a href=#__codelineno-7-20><span class=linenos data-linenos="20 "></span></a><span class=w>    </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-7-21 name=__codelineno-7-21></a><a href=#__codelineno-7-21><span class=linenos data-linenos="21 "></span></a><span class=w>    </span><span class=k>static</span><span class=w> </span><span class=k>class</span><span class=w> </span><span class=nc>MemoryFetchStub</span><span class=w> </span><span class=n>extends</span><span class=w> </span><span class=n>IMemoryAidlInterface</span><span class=p>.</span><span class=n>Stub</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-7-22 name=__codelineno-7-22></a><a href=#__codelineno-7-22><span class=linenos data-linenos="22 "></span></a><span class=w>        </span><span class=err>@</span><span class=n>Override</span><span class=w></span>
<a id=__codelineno-7-23 name=__codelineno-7-23></a><a href=#__codelineno-7-23><span class=linenos data-linenos="23 "></span></a><span class=w>        </span><span class=k>public</span><span class=w> </span><span class=n>ParcelFileDescriptor</span><span class=w> </span><span class=n>getParcelFileDescriptor</span><span class=p>()</span><span class=w> </span><span class=k>throws</span><span class=w> </span><span class=n>RemoteException</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-7-24 name=__codelineno-7-24></a><a href=#__codelineno-7-24><span class=linenos data-linenos="24 "></span></a><span class=w>            </span><span class=n>MemoryFile</span><span class=w> </span><span class=n>memoryFile</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>null</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-7-25 name=__codelineno-7-25></a><a href=#__codelineno-7-25><span class=linenos data-linenos="25 "></span></a><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-7-26 name=__codelineno-7-26></a><a href=#__codelineno-7-26><span class=linenos data-linenos="26 "></span></a><span class=w>                </span><span class=n>memoryFile</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>MemoryFile</span><span class=p>(</span><span class=s>&quot;test_memory&quot;</span><span class=p>,</span><span class=w> </span><span class=mi>1024</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-7-27 name=__codelineno-7-27></a><a href=#__codelineno-7-27><span class=linenos data-linenos="27 "></span></a><span class=w>                </span><span class=n>memoryFile</span><span class=p>.</span><span class=n>getOutputStream</span><span class=p>().</span><span class=n>write</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>byte</span><span class=p>[]{</span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=mi>3</span><span class=p>,</span><span class=w> </span><span class=mi>4</span><span class=p>,</span><span class=w> </span><span class=mi>5</span><span class=p>});</span><span class=w></span>
<a id=__codelineno-7-28 name=__codelineno-7-28></a><a href=#__codelineno-7-28><span class=linenos data-linenos="28 "></span></a><span class=w>                </span><span class=n>Method</span><span class=w> </span><span class=n>method</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MemoryFile</span><span class=p>.</span><span class=k>class</span><span class=p>.</span><span class=n>getDeclaredMethod</span><span class=p>(</span><span class=s>&quot;getFileDescriptor&quot;</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-7-29 name=__codelineno-7-29></a><a href=#__codelineno-7-29><span class=linenos data-linenos="29 "></span></a><span class=w>                </span><span class=n>FileDescriptor</span><span class=w> </span><span class=n>des</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>FileDescriptor</span><span class=p>)</span><span class=w> </span><span class=n>method</span><span class=p>.</span><span class=n>invoke</span><span class=p>(</span><span class=n>memoryFile</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-7-30 name=__codelineno-7-30></a><a href=#__codelineno-7-30><span class=linenos data-linenos="30 "></span></a><span class=w>                </span><span class=k>return</span><span class=w> </span><span class=n>ParcelFileDescriptor</span><span class=p>.</span><span class=n>dup</span><span class=p>(</span><span class=n>des</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-7-31 name=__codelineno-7-31></a><a href=#__codelineno-7-31><span class=linenos data-linenos="31 "></span></a><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{}</span><span class=w></span>
<a id=__codelineno-7-32 name=__codelineno-7-32></a><a href=#__codelineno-7-32><span class=linenos data-linenos="32 "></span></a><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>null</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-7-33 name=__codelineno-7-33></a><a href=#__codelineno-7-33><span class=linenos data-linenos="33 "></span></a><span class=w>     </span><span class=p>}}}</span><span class=w></span>
<a id=__codelineno-7-34 name=__codelineno-7-34></a><a href=#__codelineno-7-34><span class=linenos data-linenos="34 "></span></a>
<a id=__codelineno-7-35 name=__codelineno-7-35></a><a href=#__codelineno-7-35><span class=linenos data-linenos="35 "></span></a><span class=w>     </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-7-36 name=__codelineno-7-36></a><a href=#__codelineno-7-36><span class=linenos data-linenos="36 "></span></a>
<a id=__codelineno-7-37 name=__codelineno-7-37></a><a href=#__codelineno-7-37><span class=linenos data-linenos="37 "></span></a><span class=cm>/**</span>
<a id=__codelineno-7-38 name=__codelineno-7-38></a><a href=#__codelineno-7-38><span class=linenos data-linenos="38 "></span></a><span class=cm> * TestActivity.java</span>
<a id=__codelineno-7-39 name=__codelineno-7-39></a><a href=#__codelineno-7-39><span class=linenos data-linenos="39 "></span></a><span class=cm> */</span><span class=w></span>
<a id=__codelineno-7-40 name=__codelineno-7-40></a><a href=#__codelineno-7-40><span class=linenos data-linenos="40 "></span></a><span class=n>Intent</span><span class=w> </span><span class=n>intent</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Intent</span><span class=p>(</span><span class=n>MainActivity</span><span class=p>.</span><span class=k>this</span><span class=p>,</span><span class=w> </span><span class=n>MemoryFetchService</span><span class=p>.</span><span class=k>class</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-7-41 name=__codelineno-7-41></a><a href=#__codelineno-7-41><span class=linenos data-linenos="41 "></span></a><span class=n>bindService</span><span class=p>(</span><span class=n>intent</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ServiceConnection</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-7-42 name=__codelineno-7-42></a><a href=#__codelineno-7-42><span class=linenos data-linenos="42 "></span></a><span class=w>    </span><span class=err>@</span><span class=n>Override</span><span class=w></span>
<a id=__codelineno-7-43 name=__codelineno-7-43></a><a href=#__codelineno-7-43><span class=linenos data-linenos="43 "></span></a><span class=w>    </span><span class=k>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=n>onServiceConnected</span><span class=p>(</span><span class=n>ComponentName</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>IBinder</span><span class=w> </span><span class=n>service</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-7-44 name=__codelineno-7-44></a><a href=#__codelineno-7-44><span class=linenos data-linenos="44 "></span></a>
<a id=__codelineno-7-45 name=__codelineno-7-45></a><a href=#__codelineno-7-45><span class=linenos data-linenos="45 "></span></a><span class=w>        </span><span class=n>byte</span><span class=p>[]</span><span class=w> </span><span class=n>content</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>byte</span><span class=p>[</span><span class=mi>10</span><span class=p>];</span><span class=w></span>
<a id=__codelineno-7-46 name=__codelineno-7-46></a><a href=#__codelineno-7-46><span class=linenos data-linenos="46 "></span></a><span class=w>        </span><span class=n>IMemoryAidlInterface</span><span class=w> </span><span class=n>iMemoryAidlInterface</span><span class=w></span>
<a id=__codelineno-7-47 name=__codelineno-7-47></a><a href=#__codelineno-7-47><span class=linenos data-linenos="47 "></span></a><span class=w>                </span><span class=o>=</span><span class=w> </span><span class=n>IMemoryAidlInterface</span><span class=p>.</span><span class=n>Stub</span><span class=p>.</span><span class=n>asInterface</span><span class=p>(</span><span class=n>service</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-7-48 name=__codelineno-7-48></a><a href=#__codelineno-7-48><span class=linenos data-linenos="48 "></span></a><span class=w>        </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-7-49 name=__codelineno-7-49></a><a href=#__codelineno-7-49><span class=linenos data-linenos="49 "></span></a><span class=w>            </span><span class=n>ParcelFileDescriptor</span><span class=w> </span><span class=n>parcelFileDescriptor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>iMemoryAidlInterface</span><span class=p>.</span><span class=n>getParcelFileDescriptor</span><span class=p>();</span><span class=w></span>
<a id=__codelineno-7-50 name=__codelineno-7-50></a><a href=#__codelineno-7-50><span class=linenos data-linenos="50 "></span></a><span class=w>            </span><span class=n>FileDescriptor</span><span class=w> </span><span class=n>descriptor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>parcelFileDescriptor</span><span class=p>.</span><span class=n>getFileDescriptor</span><span class=p>();</span><span class=w></span>
<a id=__codelineno-7-51 name=__codelineno-7-51></a><a href=#__codelineno-7-51><span class=linenos data-linenos="51 "></span></a><span class=w>            </span><span class=n>FileInputStream</span><span class=w> </span><span class=n>fileInputStream</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>FileInputStream</span><span class=p>(</span><span class=n>descriptor</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-7-52 name=__codelineno-7-52></a><a href=#__codelineno-7-52><span class=linenos data-linenos="52 "></span></a><span class=w>            </span><span class=n>fileInputStream</span><span class=p>.</span><span class=n>read</span><span class=p>(</span><span class=n>content</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-7-53 name=__codelineno-7-53></a><a href=#__codelineno-7-53><span class=linenos data-linenos="53 "></span></a><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-7-54 name=__codelineno-7-54></a><a href=#__codelineno-7-54><span class=linenos data-linenos="54 "></span></a><span class=w>        </span><span class=p>}}</span><span class=w></span>
<a id=__codelineno-7-55 name=__codelineno-7-55></a><a href=#__codelineno-7-55><span class=linenos data-linenos="55 "></span></a>
<a id=__codelineno-7-56 name=__codelineno-7-56></a><a href=#__codelineno-7-56><span class=linenos data-linenos="56 "></span></a><span class=w>    </span><span class=err>@</span><span class=n>Override</span><span class=w></span>
<a id=__codelineno-7-57 name=__codelineno-7-57></a><a href=#__codelineno-7-57><span class=linenos data-linenos="57 "></span></a><span class=w>    </span><span class=k>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=n>onServiceDisconnected</span><span class=p>(</span><span class=n>ComponentName</span><span class=w> </span><span class=n>name</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-7-58 name=__codelineno-7-58></a><a href=#__codelineno-7-58><span class=linenos data-linenos="58 "></span></a>
<a id=__codelineno-7-59 name=__codelineno-7-59></a><a href=#__codelineno-7-59><span class=linenos data-linenos="59 "></span></a><span class=w>    </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-7-60 name=__codelineno-7-60></a><a href=#__codelineno-7-60><span class=linenos data-linenos="60 "></span></a><span class=p>},</span><span class=w> </span><span class=n>Service</span><span class=p>.</span><span class=n>BIND_AUTO_CREATE</span><span class=p>);</span><span class=w>   </span>
</code></pre></div> 封装好的或者更详细的代码可以参考：<a href=https://github.com/CCLCM/AndroidSharedMemoryDemo>https://github.com/CCLCM/AndroidSharedMemoryDemo</a> 本文的重心在于分析原理，而不是使用方法。 能看到操作和普通的File操作一模一样，好像根本没有什么区别。File本身也可以作为数据中转站做传递信息。那么MemoryFile比起普通的File优势强在哪里呢？接下来，让我们剖析一下源码，来比较看看匿名内存和File相比有什么区别，和Binder驱动又有什么区别。</p> <h1 id=memoryfile>MemoryFile<a class=headerlink href=#memoryfile title="Anchor link to this section for reference">&para;</a></h1> <p>MemoryFile是android在最开始就引入的一套框架，其内部实际上是封装了android特有的内存共享机制Ashmem匿名共享内存，简单来说Ashmem在Android内核中是被注册成一个特殊的字符设备，Ashmem驱动通过在内核的一个自定义slab缓冲区中初始化一段内存区域，然后通过mmap把申请的内存映射到用户的进程空间中（通过tmpfs），就可以在用户进程中使用这里申请的内存了，另外Ashmem的一个特性就是可以在系统内存不足的时候，回收掉被标记为"unpin"的内存(可自行查看网上资料)，MemoryFile也可以通过Binder跨进程调用来让两个进程共享一段内存区域。由于整个申请内存的过程并不再Java层上，可以很明显的看出使用MemoryFile申请的内存实际上是并不会占用Java堆内存的。</p> <h2 id=memoryfile_1>MemoryFile创建<a class=headerlink href=#memoryfile_1 title="Anchor link to this section for reference">&para;</a></h2> <div class=highlight><pre><span></span><code><a id=__codelineno-8-1 name=__codelineno-8-1></a><a href=#__codelineno-8-1><span class=linenos data-linenos=" 1 "></span></a><span class=nl>http</span><span class=p>:</span><span class=c1>//aospxref.com/android-11.0.0_r21/xref/frameworks/base/core/java/android/os/MemoryFile.java</span>
<a id=__codelineno-8-2 name=__codelineno-8-2></a><a href=#__codelineno-8-2><span class=linenos data-linenos=" 2 "></span></a>
<a id=__codelineno-8-3 name=__codelineno-8-3></a><a href=#__codelineno-8-3><span class=linenos data-linenos=" 3 "></span></a><span class=cm>/**</span>
<a id=__codelineno-8-4 name=__codelineno-8-4></a><a href=#__codelineno-8-4><span class=linenos data-linenos=" 4 "></span></a><span class=cm> * Allocates a new ashmem region. The region is initially not purgable.</span>
<a id=__codelineno-8-5 name=__codelineno-8-5></a><a href=#__codelineno-8-5><span class=linenos data-linenos=" 5 "></span></a><span class=cm> *</span>
<a id=__codelineno-8-6 name=__codelineno-8-6></a><a href=#__codelineno-8-6><span class=linenos data-linenos=" 6 "></span></a><span class=cm> * @param name optional name for the file (can be null).</span>
<a id=__codelineno-8-7 name=__codelineno-8-7></a><a href=#__codelineno-8-7><span class=linenos data-linenos=" 7 "></span></a><span class=cm> * @param length of the memory file in bytes, must be positive.</span>
<a id=__codelineno-8-8 name=__codelineno-8-8></a><a href=#__codelineno-8-8><span class=linenos data-linenos=" 8 "></span></a><span class=cm> * @throws IOException if the memory file could not be created.</span>
<a id=__codelineno-8-9 name=__codelineno-8-9></a><a href=#__codelineno-8-9><span class=linenos data-linenos=" 9 "></span></a><span class=cm> */</span>
<a id=__codelineno-8-10 name=__codelineno-8-10></a><a href=#__codelineno-8-10><span class=linenos data-linenos="10 "></span></a><span class=kd>public</span> <span class=nf>MemoryFile</span><span class=p>(</span><span class=n>String</span> <span class=n>name</span><span class=p>,</span> <span class=kt>int</span> <span class=n>length</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=p>{</span>
<a id=__codelineno-8-11 name=__codelineno-8-11></a><a href=#__codelineno-8-11><span class=linenos data-linenos="11 "></span></a>    <span class=k>try</span> <span class=p>{</span>
<a id=__codelineno-8-12 name=__codelineno-8-12></a><a href=#__codelineno-8-12><span class=linenos data-linenos="12 "></span></a>        <span class=n>mSharedMemory</span> <span class=o>=</span> <span class=n>SharedMemory</span><span class=p>.</span><span class=na>create</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>length</span><span class=p>);</span>
<a id=__codelineno-8-13 name=__codelineno-8-13></a><a href=#__codelineno-8-13><span class=linenos data-linenos="13 "></span></a>        <span class=n>mMapping</span> <span class=o>=</span> <span class=n>mSharedMemory</span><span class=p>.</span><span class=na>mapReadWrite</span><span class=p>();</span>
<a id=__codelineno-8-14 name=__codelineno-8-14></a><a href=#__codelineno-8-14><span class=linenos data-linenos="14 "></span></a>    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>ErrnoException</span> <span class=n>ex</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-8-15 name=__codelineno-8-15></a><a href=#__codelineno-8-15><span class=linenos data-linenos="15 "></span></a>        <span class=n>ex</span><span class=p>.</span><span class=na>rethrowAsIOException</span><span class=p>();</span>
<a id=__codelineno-8-16 name=__codelineno-8-16></a><a href=#__codelineno-8-16><span class=linenos data-linenos="16 "></span></a>    <span class=p>}</span>
<a id=__codelineno-8-17 name=__codelineno-8-17></a><a href=#__codelineno-8-17><span class=linenos data-linenos="17 "></span></a><span class=p>}</span>
</code></pre></div> <h3 id=sharedmemorycreate>SharedMemory.create<a class=headerlink href=#sharedmemorycreate title="Anchor link to this section for reference">&para;</a></h3> <p><div class=highlight><pre><span></span><code><a id=__codelineno-9-1 name=__codelineno-9-1></a><a href=#__codelineno-9-1><span class=linenos data-linenos="1 "></span></a><span class=nl>http</span><span class=p>:</span><span class=c1>//aospxref.com/android-11.0.0_r21/xref/frameworks/base/core/java/android/os/SharedMemory.java</span>
<a id=__codelineno-9-2 name=__codelineno-9-2></a><a href=#__codelineno-9-2><span class=linenos data-linenos="2 "></span></a>
<a id=__codelineno-9-3 name=__codelineno-9-3></a><a href=#__codelineno-9-3><span class=linenos data-linenos="3 "></span></a><span class=kd>public</span> <span class=kd>static</span> <span class=nd>@NonNull</span> <span class=n>SharedMemory</span> <span class=nf>create</span><span class=p>(</span><span class=nd>@Nullable</span> <span class=n>String</span> <span class=n>name</span><span class=p>,</span> <span class=kt>int</span> <span class=n>size</span><span class=p>)</span>
<a id=__codelineno-9-4 name=__codelineno-9-4></a><a href=#__codelineno-9-4><span class=linenos data-linenos="4 "></span></a>        <span class=kd>throws</span> <span class=n>ErrnoException</span> <span class=p>{</span>
<a id=__codelineno-9-5 name=__codelineno-9-5></a><a href=#__codelineno-9-5><span class=linenos data-linenos="5 "></span></a>    <span class=p>...</span>
<a id=__codelineno-9-6 name=__codelineno-9-6></a><a href=#__codelineno-9-6><span class=linenos data-linenos="6 "></span></a>    <span class=k>return</span> <span class=k>new</span> <span class=n>SharedMemory</span><span class=p>(</span><span class=n>nCreate</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>size</span><span class=p>));</span>
<a id=__codelineno-9-7 name=__codelineno-9-7></a><a href=#__codelineno-9-7><span class=linenos data-linenos="7 "></span></a><span class=p>}</span>
</code></pre></div> 能看到实际上MemoryFile内部有一个核心的类SharedMemory作为核心操作类。我们去看看SharedMemory创建了什么。 <div class=highlight><pre><span></span><code><a id=__codelineno-10-1 name=__codelineno-10-1></a><a href=#__codelineno-10-1><span class=linenos data-linenos="1 "></span></a><span class=kd>private</span> <span class=nf>SharedMemory</span><span class=p>(</span><span class=n>FileDescriptor</span> <span class=n>fd</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-10-2 name=__codelineno-10-2></a><a href=#__codelineno-10-2><span class=linenos data-linenos="2 "></span></a>    <span class=p>...</span>
<a id=__codelineno-10-3 name=__codelineno-10-3></a><a href=#__codelineno-10-3><span class=linenos data-linenos="3 "></span></a>    <span class=n>mFileDescriptor</span> <span class=o>=</span> <span class=n>fd</span><span class=p>;</span>
<a id=__codelineno-10-4 name=__codelineno-10-4></a><a href=#__codelineno-10-4><span class=linenos data-linenos="4 "></span></a>    <span class=n>mSize</span> <span class=o>=</span> <span class=n>nGetSize</span><span class=p>(</span><span class=n>mFileDescriptor</span><span class=p>);</span>
<a id=__codelineno-10-5 name=__codelineno-10-5></a><a href=#__codelineno-10-5><span class=linenos data-linenos="5 "></span></a>    <span class=p>...</span>
<a id=__codelineno-10-6 name=__codelineno-10-6></a><a href=#__codelineno-10-6><span class=linenos data-linenos="6 "></span></a>    <span class=n>mMemoryRegistration</span> <span class=o>=</span> <span class=k>new</span> <span class=n>MemoryRegistration</span><span class=p>(</span><span class=n>mSize</span><span class=p>);</span>
<a id=__codelineno-10-7 name=__codelineno-10-7></a><a href=#__codelineno-10-7><span class=linenos data-linenos="7 "></span></a>    <span class=n>mCleaner</span> <span class=o>=</span> <span class=n>Cleaner</span><span class=p>.</span><span class=na>create</span><span class=p>(</span><span class=n>mFileDescriptor</span><span class=p>,</span>
<a id=__codelineno-10-8 name=__codelineno-10-8></a><a href=#__codelineno-10-8><span class=linenos data-linenos="8 "></span></a>            <span class=k>new</span> <span class=n>Closer</span><span class=p>(</span><span class=n>mFileDescriptor</span><span class=p>,</span> <span class=n>mMemoryRegistration</span><span class=p>));</span>
<a id=__codelineno-10-9 name=__codelineno-10-9></a><a href=#__codelineno-10-9><span class=linenos data-linenos="9 "></span></a><span class=p>}</span>
</code></pre></div> SharedMemory构造函数做了以下这么几件事：</p> <ul> <li>通过nCreate在native下创建一个文件描述符，并且关联到到SharedMemory</li> <li>通过nGetSize获取当前共享内存大小</li> <li>通过MemoryRegistration把当前大小注册到Java 虚拟机中的native堆栈大小中</li> <li>初始化Cleaner等到合适的时候通过gc联动Cleaner销毁native下的对象。 <div class=highlight><pre><span></span><code><a id=__codelineno-11-1 name=__codelineno-11-1></a><a href=#__codelineno-11-1><span class=linenos data-linenos=" 1 "></span></a><span class=nl>http</span><span class=p>:</span><span class=c1>//aospxref.com/android-11.0.0_r21/xref/frameworks/base/core/java/android/os/SharedMemory.java#354</span>
<a id=__codelineno-11-2 name=__codelineno-11-2></a><a href=#__codelineno-11-2><span class=linenos data-linenos=" 2 "></span></a>
<a id=__codelineno-11-3 name=__codelineno-11-3></a><a href=#__codelineno-11-3><span class=linenos data-linenos=" 3 "></span></a><span class=cm>/**</span>
<a id=__codelineno-11-4 name=__codelineno-11-4></a><a href=#__codelineno-11-4><span class=linenos data-linenos=" 4 "></span></a><span class=cm> * Helper class that ensures that the native allocation pressure against the VM heap stays</span>
<a id=__codelineno-11-5 name=__codelineno-11-5></a><a href=#__codelineno-11-5><span class=linenos data-linenos=" 5 "></span></a><span class=cm> * active until the FD is closed as well as all mappings from that FD are closed.</span>
<a id=__codelineno-11-6 name=__codelineno-11-6></a><a href=#__codelineno-11-6><span class=linenos data-linenos=" 6 "></span></a><span class=cm> */</span>
<a id=__codelineno-11-7 name=__codelineno-11-7></a><a href=#__codelineno-11-7><span class=linenos data-linenos=" 7 "></span></a><span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>MemoryRegistration</span> <span class=p>{</span>
<a id=__codelineno-11-8 name=__codelineno-11-8></a><a href=#__codelineno-11-8><span class=linenos data-linenos=" 8 "></span></a>    <span class=kd>private</span> <span class=kt>int</span> <span class=n>mSize</span><span class=p>;</span>
<a id=__codelineno-11-9 name=__codelineno-11-9></a><a href=#__codelineno-11-9><span class=linenos data-linenos=" 9 "></span></a>    <span class=kd>private</span> <span class=kt>int</span> <span class=n>mReferenceCount</span><span class=p>;</span>
<a id=__codelineno-11-10 name=__codelineno-11-10></a><a href=#__codelineno-11-10><span class=linenos data-linenos="10 "></span></a>
<a id=__codelineno-11-11 name=__codelineno-11-11></a><a href=#__codelineno-11-11><span class=linenos data-linenos="11 "></span></a>    <span class=kd>private</span> <span class=nf>MemoryRegistration</span><span class=p>(</span><span class=kt>int</span> <span class=n>size</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-11-12 name=__codelineno-11-12></a><a href=#__codelineno-11-12><span class=linenos data-linenos="12 "></span></a>        <span class=n>mSize</span> <span class=o>=</span> <span class=n>size</span><span class=p>;</span>
<a id=__codelineno-11-13 name=__codelineno-11-13></a><a href=#__codelineno-11-13><span class=linenos data-linenos="13 "></span></a>        <span class=n>mReferenceCount</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
<a id=__codelineno-11-14 name=__codelineno-11-14></a><a href=#__codelineno-11-14><span class=linenos data-linenos="14 "></span></a>        <span class=n>VMRuntime</span><span class=p>.</span><span class=na>getRuntime</span><span class=p>().</span><span class=na>registerNativeAllocation</span><span class=p>(</span><span class=n>mSize</span><span class=p>);</span>
<a id=__codelineno-11-15 name=__codelineno-11-15></a><a href=#__codelineno-11-15><span class=linenos data-linenos="15 "></span></a>    <span class=p>}</span>
<a id=__codelineno-11-16 name=__codelineno-11-16></a><a href=#__codelineno-11-16><span class=linenos data-linenos="16 "></span></a>
<a id=__codelineno-11-17 name=__codelineno-11-17></a><a href=#__codelineno-11-17><span class=linenos data-linenos="17 "></span></a>    <span class=kd>public</span> <span class=kd>synchronized</span> <span class=n>MemoryRegistration</span> <span class=nf>acquire</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-11-18 name=__codelineno-11-18></a><a href=#__codelineno-11-18><span class=linenos data-linenos="18 "></span></a>        <span class=n>mReferenceCount</span><span class=o>++</span><span class=p>;</span>
<a id=__codelineno-11-19 name=__codelineno-11-19></a><a href=#__codelineno-11-19><span class=linenos data-linenos="19 "></span></a>        <span class=k>return</span> <span class=k>this</span><span class=p>;</span>
<a id=__codelineno-11-20 name=__codelineno-11-20></a><a href=#__codelineno-11-20><span class=linenos data-linenos="20 "></span></a>    <span class=p>}</span>
<a id=__codelineno-11-21 name=__codelineno-11-21></a><a href=#__codelineno-11-21><span class=linenos data-linenos="21 "></span></a>
<a id=__codelineno-11-22 name=__codelineno-11-22></a><a href=#__codelineno-11-22><span class=linenos data-linenos="22 "></span></a>    <span class=kd>public</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>release</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-11-23 name=__codelineno-11-23></a><a href=#__codelineno-11-23><span class=linenos data-linenos="23 "></span></a>        <span class=n>mReferenceCount</span><span class=o>--</span><span class=p>;</span>
<a id=__codelineno-11-24 name=__codelineno-11-24></a><a href=#__codelineno-11-24><span class=linenos data-linenos="24 "></span></a>        <span class=k>if</span> <span class=p>(</span><span class=n>mReferenceCount</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-11-25 name=__codelineno-11-25></a><a href=#__codelineno-11-25><span class=linenos data-linenos="25 "></span></a>            <span class=n>VMRuntime</span><span class=p>.</span><span class=na>getRuntime</span><span class=p>().</span><span class=na>registerNativeFree</span><span class=p>(</span><span class=n>mSize</span><span class=p>);</span>
<a id=__codelineno-11-26 name=__codelineno-11-26></a><a href=#__codelineno-11-26><span class=linenos data-linenos="26 "></span></a>        <span class=p>}</span>
<a id=__codelineno-11-27 name=__codelineno-11-27></a><a href=#__codelineno-11-27><span class=linenos data-linenos="27 "></span></a>    <span class=p>}</span>
<a id=__codelineno-11-28 name=__codelineno-11-28></a><a href=#__codelineno-11-28><span class=linenos data-linenos="28 "></span></a><span class=p>}</span>
</code></pre></div> MemoryRegistration 本质上就是注册了Java虚拟机中native堆的大小，每一次一个引用都有一次计数，只有减到0才销毁，毕竟这是共享内存，不应该完全由Java虚拟机的GC机制决定。 还记得前面我们提到SharedMemory首先通过nCreate在native下创建一个文件描述符。下面我们就来分析native代码都干些什么。</li> </ul> <h4 id=ncreatename-size>nCreate(name, size)<a class=headerlink href=#ncreatename-size title="Anchor link to this section for reference">&para;</a></h4> <p><div class=highlight><pre><span></span><code><a id=__codelineno-12-1 name=__codelineno-12-1></a><a href=#__codelineno-12-1><span class=linenos data-linenos="1 "></span></a><span class=nl>http</span><span class=p>:</span><span class=c1>//aospxref.com/android-11.0.0_r21/xref/frameworks/base/core/java/android/os/SharedMemory.java#377</span>
<a id=__codelineno-12-2 name=__codelineno-12-2></a><a href=#__codelineno-12-2><span class=linenos data-linenos="2 "></span></a>
<a id=__codelineno-12-3 name=__codelineno-12-3></a><a href=#__codelineno-12-3><span class=linenos data-linenos="3 "></span></a><span class=kd>private</span> <span class=kd>static</span> <span class=kd>native</span> <span class=n>FileDescriptor</span> <span class=nf>nCreate</span><span class=p>(</span><span class=n>String</span> <span class=n>name</span><span class=p>,</span> <span class=kt>int</span> <span class=n>size</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>ErrnoException</span><span class=p>;</span>
</code></pre></div> nCreate在native下创建一个文件描述符。 <div class=highlight><pre><span></span><code><a id=__codelineno-13-1 name=__codelineno-13-1></a><a href=#__codelineno-13-1><span class=linenos data-linenos=" 1 "></span></a><span class=nl>http</span><span class=p>:</span><span class=c1>//aospxref.com/android-11.0.0_r21/xref/frameworks/base/core/jni/android_os_SharedMemory.cpp#53</span>
<a id=__codelineno-13-2 name=__codelineno-13-2></a><a href=#__codelineno-13-2><span class=linenos data-linenos=" 2 "></span></a>
<a id=__codelineno-13-3 name=__codelineno-13-3></a><a href=#__codelineno-13-3><span class=linenos data-linenos=" 3 "></span></a><span class=n>jobject</span><span class=w> </span><span class=nf>SharedMemory_nCreate</span><span class=p>(</span><span class=n>JNIEnv</span><span class=o>*</span><span class=w> </span><span class=n>env</span><span class=p>,</span><span class=w> </span><span class=n>jobject</span><span class=p>,</span><span class=w> </span><span class=n>jstring</span><span class=w> </span><span class=n>jname</span><span class=p>,</span><span class=w> </span><span class=n>jint</span><span class=w> </span><span class=n>size</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-13-4 name=__codelineno-13-4></a><a href=#__codelineno-13-4><span class=linenos data-linenos=" 4 "></span></a>
<a id=__codelineno-13-5 name=__codelineno-13-5></a><a href=#__codelineno-13-5><span class=linenos data-linenos=" 5 "></span></a><span class=w>    </span><span class=c1>// Name is optional so we can&#39;t use ScopedUtfChars for this as it throws NPE on null</span>
<a id=__codelineno-13-6 name=__codelineno-13-6></a><a href=#__codelineno-13-6><span class=linenos data-linenos=" 6 "></span></a><span class=w>    </span><span class=k>const</span><span class=w> </span><span class=kt>char</span><span class=o>*</span><span class=w> </span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>jname</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>env</span><span class=o>-&gt;</span><span class=n>GetStringUTFChars</span><span class=p>(</span><span class=n>jname</span><span class=p>,</span><span class=w> </span><span class=k>nullptr</span><span class=p>)</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=k>nullptr</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-13-7 name=__codelineno-13-7></a><a href=#__codelineno-13-7><span class=linenos data-linenos=" 7 "></span></a>
<a id=__codelineno-13-8 name=__codelineno-13-8></a><a href=#__codelineno-13-8><span class=linenos data-linenos=" 8 "></span></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>fd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ashmem_create_region</span><span class=p>(</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>size</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-13-9 name=__codelineno-13-9></a><a href=#__codelineno-13-9><span class=linenos data-linenos=" 9 "></span></a>
<a id=__codelineno-13-10 name=__codelineno-13-10></a><a href=#__codelineno-13-10><span class=linenos data-linenos="10 "></span></a><span class=w>    </span><span class=c1>// Capture the error, if there is one, before calling ReleaseStringUTFChars</span>
<a id=__codelineno-13-11 name=__codelineno-13-11></a><a href=#__codelineno-13-11><span class=linenos data-linenos="11 "></span></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>err</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>fd</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>errno</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-13-12 name=__codelineno-13-12></a><a href=#__codelineno-13-12><span class=linenos data-linenos="12 "></span></a>
<a id=__codelineno-13-13 name=__codelineno-13-13></a><a href=#__codelineno-13-13><span class=linenos data-linenos="13 "></span></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>name</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-13-14 name=__codelineno-13-14></a><a href=#__codelineno-13-14><span class=linenos data-linenos="14 "></span></a><span class=w>        </span><span class=n>env</span><span class=o>-&gt;</span><span class=n>ReleaseStringUTFChars</span><span class=p>(</span><span class=n>jname</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-13-15 name=__codelineno-13-15></a><a href=#__codelineno-13-15><span class=linenos data-linenos="15 "></span></a><span class=w>    </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-13-16 name=__codelineno-13-16></a><a href=#__codelineno-13-16><span class=linenos data-linenos="16 "></span></a>
<a id=__codelineno-13-17 name=__codelineno-13-17></a><a href=#__codelineno-13-17><span class=linenos data-linenos="17 "></span></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>fd</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-13-18 name=__codelineno-13-18></a><a href=#__codelineno-13-18><span class=linenos data-linenos="18 "></span></a><span class=w>        </span><span class=n>throwErrnoException</span><span class=p>(</span><span class=n>env</span><span class=p>,</span><span class=w> </span><span class=s>&quot;SharedMemory_create&quot;</span><span class=p>,</span><span class=w> </span><span class=n>err</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-13-19 name=__codelineno-13-19></a><a href=#__codelineno-13-19><span class=linenos data-linenos="19 "></span></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>nullptr</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-13-20 name=__codelineno-13-20></a><a href=#__codelineno-13-20><span class=linenos data-linenos="20 "></span></a><span class=w>    </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-13-21 name=__codelineno-13-21></a><a href=#__codelineno-13-21><span class=linenos data-linenos="21 "></span></a>
<a id=__codelineno-13-22 name=__codelineno-13-22></a><a href=#__codelineno-13-22><span class=linenos data-linenos="22 "></span></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>jniCreateFileDescriptor</span><span class=p>(</span><span class=n>env</span><span class=p>,</span><span class=w> </span><span class=n>fd</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-13-23 name=__codelineno-13-23></a><a href=#__codelineno-13-23><span class=linenos data-linenos="23 "></span></a><span class=p>}</span><span class=w></span>
</code></pre></div> 通过ashmem_create_region，创建一个共享内存的区域。还记得Linux中那句话，一切皆为文件，实际上匿名共享内存创建出来也是一个文件，不过因为是在tmpfs临时文件系统才叫做匿名的。</p> <h4 id=ashmem_create_region>ashmem_create_region<a class=headerlink href=#ashmem_create_region title="Anchor link to this section for reference">&para;</a></h4> <p><div class=highlight><pre><span></span><code><a id=__codelineno-14-1 name=__codelineno-14-1></a><a href=#__codelineno-14-1><span class=linenos data-linenos=" 1 "></span></a><span class=nl>http</span><span class=p>:</span><span class=c1>//aospxref.com/android-11.0.0_r21/xref/system/core/libcutils/ashmem-dev.cpp#357</span>
<a id=__codelineno-14-2 name=__codelineno-14-2></a><a href=#__codelineno-14-2><span class=linenos data-linenos=" 2 "></span></a>
<a id=__codelineno-14-3 name=__codelineno-14-3></a><a href=#__codelineno-14-3><span class=linenos data-linenos=" 3 "></span></a><span class=kt>int</span><span class=w> </span><span class=nf>ashmem_create_region</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=kt>size_t</span><span class=w> </span><span class=n>size</span><span class=p>)</span><span class=w></span>
<a id=__codelineno-14-4 name=__codelineno-14-4></a><a href=#__codelineno-14-4><span class=linenos data-linenos=" 4 "></span></a><span class=p>{</span><span class=w></span>
<a id=__codelineno-14-5 name=__codelineno-14-5></a><a href=#__codelineno-14-5><span class=linenos data-linenos=" 5 "></span></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>ret</span><span class=p>,</span><span class=w> </span><span class=n>save_errno</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-14-6 name=__codelineno-14-6></a><a href=#__codelineno-14-6><span class=linenos data-linenos=" 6 "></span></a>
<a id=__codelineno-14-7 name=__codelineno-14-7></a><a href=#__codelineno-14-7><span class=linenos data-linenos=" 7 "></span></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>has_memfd_support</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=c1>//属性sys.use_memfd是否为true</span>
<a id=__codelineno-14-8 name=__codelineno-14-8></a><a href=#__codelineno-14-8><span class=linenos data-linenos=" 8 "></span></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>memfd_create_region</span><span class=p>(</span><span class=n>name</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>name</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=s>&quot;none&quot;</span><span class=p>,</span><span class=w> </span><span class=n>size</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-14-9 name=__codelineno-14-9></a><a href=#__codelineno-14-9><span class=linenos data-linenos=" 9 "></span></a><span class=w>    </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-14-10 name=__codelineno-14-10></a><a href=#__codelineno-14-10><span class=linenos data-linenos="10 "></span></a>
<a id=__codelineno-14-11 name=__codelineno-14-11></a><a href=#__codelineno-14-11><span class=linenos data-linenos="11 "></span></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>fd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>__ashmem_open</span><span class=p>();</span><span class=w></span>
<a id=__codelineno-14-12 name=__codelineno-14-12></a><a href=#__codelineno-14-12><span class=linenos data-linenos="12 "></span></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>fd</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-14-13 name=__codelineno-14-13></a><a href=#__codelineno-14-13><span class=linenos data-linenos="13 "></span></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>fd</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-14-14 name=__codelineno-14-14></a><a href=#__codelineno-14-14><span class=linenos data-linenos="14 "></span></a><span class=w>    </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-14-15 name=__codelineno-14-15></a><a href=#__codelineno-14-15><span class=linenos data-linenos="15 "></span></a>
<a id=__codelineno-14-16 name=__codelineno-14-16></a><a href=#__codelineno-14-16><span class=linenos data-linenos="16 "></span></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>name</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-14-17 name=__codelineno-14-17></a><a href=#__codelineno-14-17><span class=linenos data-linenos="17 "></span></a><span class=w>        </span><span class=kt>char</span><span class=w> </span><span class=n>buf</span><span class=p>[</span><span class=n>ASHMEM_NAME_LEN</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=mi>0</span><span class=p>};</span><span class=w></span>
<a id=__codelineno-14-18 name=__codelineno-14-18></a><a href=#__codelineno-14-18><span class=linenos data-linenos="18 "></span></a>
<a id=__codelineno-14-19 name=__codelineno-14-19></a><a href=#__codelineno-14-19><span class=linenos data-linenos="19 "></span></a><span class=w>        </span><span class=n>strlcpy</span><span class=p>(</span><span class=n>buf</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>buf</span><span class=p>));</span><span class=w></span>
<a id=__codelineno-14-20 name=__codelineno-14-20></a><a href=#__codelineno-14-20><span class=linenos data-linenos="20 "></span></a><span class=w>        </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>TEMP_FAILURE_RETRY</span><span class=p>(</span><span class=n>ioctl</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span><span class=w> </span><span class=n>ASHMEM_SET_NAME</span><span class=p>,</span><span class=w> </span><span class=n>buf</span><span class=p>));</span><span class=w></span>
<a id=__codelineno-14-21 name=__codelineno-14-21></a><a href=#__codelineno-14-21><span class=linenos data-linenos="21 "></span></a><span class=w>        </span><span class=p>...</span><span class=w></span>
<a id=__codelineno-14-22 name=__codelineno-14-22></a><a href=#__codelineno-14-22><span class=linenos data-linenos="22 "></span></a><span class=w>    </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-14-23 name=__codelineno-14-23></a><a href=#__codelineno-14-23><span class=linenos data-linenos="23 "></span></a>
<a id=__codelineno-14-24 name=__codelineno-14-24></a><a href=#__codelineno-14-24><span class=linenos data-linenos="24 "></span></a><span class=w>    </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>TEMP_FAILURE_RETRY</span><span class=p>(</span><span class=n>ioctl</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span><span class=w> </span><span class=n>ASHMEM_SET_SIZE</span><span class=p>,</span><span class=w> </span><span class=n>size</span><span class=p>));</span><span class=w></span>
<a id=__codelineno-14-25 name=__codelineno-14-25></a><a href=#__codelineno-14-25><span class=linenos data-linenos="25 "></span></a><span class=w>    </span><span class=p>...</span><span class=w></span>
<a id=__codelineno-14-26 name=__codelineno-14-26></a><a href=#__codelineno-14-26><span class=linenos data-linenos="26 "></span></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>fd</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-14-27 name=__codelineno-14-27></a><a href=#__codelineno-14-27><span class=linenos data-linenos="27 "></span></a><span class=w>    </span><span class=p>...</span><span class=w></span>
<a id=__codelineno-14-28 name=__codelineno-14-28></a><a href=#__codelineno-14-28><span class=linenos data-linenos="28 "></span></a><span class=p>}</span><span class=w></span>
</code></pre></div> 创建匿名共享内存分为三个步骤:</p> <ul> <li>__ashmem_open 创建匿名共享内存</li> <li>通过ioctl 给匿名共享内存命名，只有命名了才能通过命名找到对应的匿名共享内存</li> <li>ioctl通过ASHMEM_SET_SIZE命令设置匿名共享内存的大小</li> </ul> <h4 id=__ashmem_open>__ashmem_open<a class=headerlink href=#__ashmem_open title="Anchor link to this section for reference">&para;</a></h4> <p><div class=highlight><pre><span></span><code><a id=__codelineno-15-1 name=__codelineno-15-1></a><a href=#__codelineno-15-1><span class=linenos data-linenos=" 1 "></span></a><span class=nl>http</span><span class=p>:</span><span class=c1>//aospxref.com/android-11.0.0_r21/xref/system/core/libcutils/ashmem-dev.cpp</span>
<a id=__codelineno-15-2 name=__codelineno-15-2></a><a href=#__codelineno-15-2><span class=linenos data-linenos=" 2 "></span></a>
<a id=__codelineno-15-3 name=__codelineno-15-3></a><a href=#__codelineno-15-3><span class=linenos data-linenos=" 3 "></span></a><span class=k>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>__ashmem_open</span><span class=p>()</span><span class=w></span>
<a id=__codelineno-15-4 name=__codelineno-15-4></a><a href=#__codelineno-15-4><span class=linenos data-linenos=" 4 "></span></a><span class=p>{</span><span class=w></span>
<a id=__codelineno-15-5 name=__codelineno-15-5></a><a href=#__codelineno-15-5><span class=linenos data-linenos=" 5 "></span></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>fd</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-15-6 name=__codelineno-15-6></a><a href=#__codelineno-15-6><span class=linenos data-linenos=" 6 "></span></a>
<a id=__codelineno-15-7 name=__codelineno-15-7></a><a href=#__codelineno-15-7><span class=linenos data-linenos=" 7 "></span></a><span class=w>    </span><span class=n>pthread_mutex_lock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>__ashmem_lock</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-15-8 name=__codelineno-15-8></a><a href=#__codelineno-15-8><span class=linenos data-linenos=" 8 "></span></a><span class=w>    </span><span class=n>fd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>__ashmem_open_locked</span><span class=p>();</span><span class=w></span>
<a id=__codelineno-15-9 name=__codelineno-15-9></a><a href=#__codelineno-15-9><span class=linenos data-linenos=" 9 "></span></a><span class=w>    </span><span class=n>pthread_mutex_unlock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>__ashmem_lock</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-15-10 name=__codelineno-15-10></a><a href=#__codelineno-15-10><span class=linenos data-linenos="10 "></span></a>
<a id=__codelineno-15-11 name=__codelineno-15-11></a><a href=#__codelineno-15-11><span class=linenos data-linenos="11 "></span></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>fd</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-15-12 name=__codelineno-15-12></a><a href=#__codelineno-15-12><span class=linenos data-linenos="12 "></span></a><span class=p>}</span><span class=w></span>
<a id=__codelineno-15-13 name=__codelineno-15-13></a><a href=#__codelineno-15-13><span class=linenos data-linenos="13 "></span></a>
<a id=__codelineno-15-14 name=__codelineno-15-14></a><a href=#__codelineno-15-14><span class=linenos data-linenos="14 "></span></a><span class=cm>/* logistics of getting file descriptor for ashmem */</span><span class=w></span>
<a id=__codelineno-15-15 name=__codelineno-15-15></a><a href=#__codelineno-15-15><span class=linenos data-linenos="15 "></span></a><span class=k>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>__ashmem_open_locked</span><span class=p>()</span><span class=w></span>
<a id=__codelineno-15-16 name=__codelineno-15-16></a><a href=#__codelineno-15-16><span class=linenos data-linenos="16 "></span></a><span class=p>{</span><span class=w></span>
<a id=__codelineno-15-17 name=__codelineno-15-17></a><a href=#__codelineno-15-17><span class=linenos data-linenos="17 "></span></a><span class=w>    </span><span class=k>static</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>ashmem_device_path</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>get_ashmem_device_path</span><span class=p>();</span><span class=w></span>
<a id=__codelineno-15-18 name=__codelineno-15-18></a><a href=#__codelineno-15-18><span class=linenos data-linenos="18 "></span></a>
<a id=__codelineno-15-19 name=__codelineno-15-19></a><a href=#__codelineno-15-19><span class=linenos data-linenos="19 "></span></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ashmem_device_path</span><span class=p>.</span><span class=n>empty</span><span class=p>())</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-15-20 name=__codelineno-15-20></a><a href=#__codelineno-15-20><span class=linenos data-linenos="20 "></span></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-15-21 name=__codelineno-15-21></a><a href=#__codelineno-15-21><span class=linenos data-linenos="21 "></span></a><span class=w>    </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-15-22 name=__codelineno-15-22></a><a href=#__codelineno-15-22><span class=linenos data-linenos="22 "></span></a>
<a id=__codelineno-15-23 name=__codelineno-15-23></a><a href=#__codelineno-15-23><span class=linenos data-linenos="23 "></span></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>fd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>TEMP_FAILURE_RETRY</span><span class=p>(</span><span class=n>open</span><span class=p>(</span><span class=n>ashmem_device_path</span><span class=p>.</span><span class=n>c_str</span><span class=p>(),</span><span class=w> </span><span class=n>O_RDWR</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>O_CLOEXEC</span><span class=p>));</span><span class=w></span>
<a id=__codelineno-15-24 name=__codelineno-15-24></a><a href=#__codelineno-15-24><span class=linenos data-linenos="24 "></span></a>
<a id=__codelineno-15-25 name=__codelineno-15-25></a><a href=#__codelineno-15-25><span class=linenos data-linenos="25 "></span></a><span class=w>    </span><span class=c1>// fallback for APEX w/ use_vendor on Q, which would have still used /dev/ashmem</span>
<a id=__codelineno-15-26 name=__codelineno-15-26></a><a href=#__codelineno-15-26><span class=linenos data-linenos="26 "></span></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>fd</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-15-27 name=__codelineno-15-27></a><a href=#__codelineno-15-27><span class=linenos data-linenos="27 "></span></a><span class=w>        </span><span class=n>fd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>TEMP_FAILURE_RETRY</span><span class=p>(</span><span class=n>open</span><span class=p>(</span><span class=s>&quot;/dev/ashmem&quot;</span><span class=p>,</span><span class=w> </span><span class=n>O_RDWR</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>O_CLOEXEC</span><span class=p>));</span><span class=w></span>
<a id=__codelineno-15-28 name=__codelineno-15-28></a><a href=#__codelineno-15-28><span class=linenos data-linenos="28 "></span></a><span class=w>    </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-15-29 name=__codelineno-15-29></a><a href=#__codelineno-15-29><span class=linenos data-linenos="29 "></span></a>
<a id=__codelineno-15-30 name=__codelineno-15-30></a><a href=#__codelineno-15-30><span class=linenos data-linenos="30 "></span></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>fd</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-15-31 name=__codelineno-15-31></a><a href=#__codelineno-15-31><span class=linenos data-linenos="31 "></span></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>fd</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-15-32 name=__codelineno-15-32></a><a href=#__codelineno-15-32><span class=linenos data-linenos="32 "></span></a><span class=w>    </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-15-33 name=__codelineno-15-33></a><a href=#__codelineno-15-33><span class=linenos data-linenos="33 "></span></a>
<a id=__codelineno-15-34 name=__codelineno-15-34></a><a href=#__codelineno-15-34><span class=linenos data-linenos="34 "></span></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>stat</span><span class=w> </span><span class=n>st</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-15-35 name=__codelineno-15-35></a><a href=#__codelineno-15-35><span class=linenos data-linenos="35 "></span></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>TEMP_FAILURE_RETRY</span><span class=p>(</span><span class=n>fstat</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>st</span><span class=p>));</span><span class=w></span>
<a id=__codelineno-15-36 name=__codelineno-15-36></a><a href=#__codelineno-15-36><span class=linenos data-linenos="36 "></span></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ret</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-15-37 name=__codelineno-15-37></a><a href=#__codelineno-15-37><span class=linenos data-linenos="37 "></span></a><span class=w>        </span><span class=kt>int</span><span class=w> </span><span class=n>save_errno</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>errno</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-15-38 name=__codelineno-15-38></a><a href=#__codelineno-15-38><span class=linenos data-linenos="38 "></span></a><span class=w>        </span><span class=n>close</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-15-39 name=__codelineno-15-39></a><a href=#__codelineno-15-39><span class=linenos data-linenos="39 "></span></a><span class=w>        </span><span class=n>errno</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>save_errno</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-15-40 name=__codelineno-15-40></a><a href=#__codelineno-15-40><span class=linenos data-linenos="40 "></span></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ret</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-15-41 name=__codelineno-15-41></a><a href=#__codelineno-15-41><span class=linenos data-linenos="41 "></span></a><span class=w>    </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-15-42 name=__codelineno-15-42></a><a href=#__codelineno-15-42><span class=linenos data-linenos="42 "></span></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>S_ISCHR</span><span class=p>(</span><span class=n>st</span><span class=p>.</span><span class=n>st_mode</span><span class=p>)</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=n>st</span><span class=p>.</span><span class=n>st_rdev</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-15-43 name=__codelineno-15-43></a><a href=#__codelineno-15-43><span class=linenos data-linenos="43 "></span></a><span class=w>        </span><span class=n>close</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-15-44 name=__codelineno-15-44></a><a href=#__codelineno-15-44><span class=linenos data-linenos="44 "></span></a><span class=w>        </span><span class=n>errno</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ENOTTY</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-15-45 name=__codelineno-15-45></a><a href=#__codelineno-15-45><span class=linenos data-linenos="45 "></span></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>-1</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-15-46 name=__codelineno-15-46></a><a href=#__codelineno-15-46><span class=linenos data-linenos="46 "></span></a><span class=w>    </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-15-47 name=__codelineno-15-47></a><a href=#__codelineno-15-47><span class=linenos data-linenos="47 "></span></a>
<a id=__codelineno-15-48 name=__codelineno-15-48></a><a href=#__codelineno-15-48><span class=linenos data-linenos="48 "></span></a><span class=w>    </span><span class=n>__ashmem_rdev</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>st</span><span class=p>.</span><span class=n>st_rdev</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-15-49 name=__codelineno-15-49></a><a href=#__codelineno-15-49><span class=linenos data-linenos="49 "></span></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>fd</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-15-50 name=__codelineno-15-50></a><a href=#__codelineno-15-50><span class=linenos data-linenos="50 "></span></a><span class=p>}</span><span class=w></span>
</code></pre></div> 终于看到了，类似于Binder驱动的打开方式一样，通过/dev/ashmem的方式访问ashmem驱动的file_operation的open方法，最后获得对应的文件描述符fd。 驱动相关的内容我们放到最后一节来分析。</p> <h3 id=sharedmemorymapreadwrite>SharedMemory.mapReadWrite<a class=headerlink href=#sharedmemorymapreadwrite title="Anchor link to this section for reference">&para;</a></h3> <p>ShareMemory当创建好ashmem匿名共享内存之后，将会调用mapReadWrite。 <div class=highlight><pre><span></span><code><a id=__codelineno-16-1 name=__codelineno-16-1></a><a href=#__codelineno-16-1><span class=linenos data-linenos=" 1 "></span></a><span class=nl>http</span><span class=p>:</span><span class=c1>//aospxref.com/android-11.0.0_r21/xref/frameworks/base/core/java/android/os/SharedMemory.java</span>
<a id=__codelineno-16-2 name=__codelineno-16-2></a><a href=#__codelineno-16-2><span class=linenos data-linenos=" 2 "></span></a>
<a id=__codelineno-16-3 name=__codelineno-16-3></a><a href=#__codelineno-16-3><span class=linenos data-linenos=" 3 "></span></a><span class=kd>public</span> <span class=nd>@NonNull</span> <span class=n>ByteBuffer</span> <span class=nf>mapReadWrite</span><span class=p>()</span> <span class=kd>throws</span> <span class=n>ErrnoException</span> <span class=p>{</span>
<a id=__codelineno-16-4 name=__codelineno-16-4></a><a href=#__codelineno-16-4><span class=linenos data-linenos=" 4 "></span></a>    <span class=k>return</span> <span class=n>map</span><span class=p>(</span><span class=n>OsConstants</span><span class=p>.</span><span class=na>PROT_READ</span> <span class=o>|</span> <span class=n>OsConstants</span><span class=p>.</span><span class=na>PROT_WRITE</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>mSize</span><span class=p>);</span>
<a id=__codelineno-16-5 name=__codelineno-16-5></a><a href=#__codelineno-16-5><span class=linenos data-linenos=" 5 "></span></a><span class=p>}</span>
<a id=__codelineno-16-6 name=__codelineno-16-6></a><a href=#__codelineno-16-6><span class=linenos data-linenos=" 6 "></span></a>
<a id=__codelineno-16-7 name=__codelineno-16-7></a><a href=#__codelineno-16-7><span class=linenos data-linenos=" 7 "></span></a> <span class=kd>public</span> <span class=nd>@NonNull</span> <span class=n>ByteBuffer</span> <span class=nf>map</span><span class=p>(</span><span class=kt>int</span> <span class=n>prot</span><span class=p>,</span> <span class=kt>int</span> <span class=n>offset</span><span class=p>,</span> <span class=kt>int</span> <span class=n>length</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>ErrnoException</span> <span class=p>{</span>
<a id=__codelineno-16-8 name=__codelineno-16-8></a><a href=#__codelineno-16-8><span class=linenos data-linenos=" 8 "></span></a>    <span class=n>checkOpen</span><span class=p>();</span>
<a id=__codelineno-16-9 name=__codelineno-16-9></a><a href=#__codelineno-16-9><span class=linenos data-linenos=" 9 "></span></a>    <span class=n>validateProt</span><span class=p>(</span><span class=n>prot</span><span class=p>);</span>
<a id=__codelineno-16-10 name=__codelineno-16-10></a><a href=#__codelineno-16-10><span class=linenos data-linenos="10 "></span></a>    <span class=p>...</span>
<a id=__codelineno-16-11 name=__codelineno-16-11></a><a href=#__codelineno-16-11><span class=linenos data-linenos="11 "></span></a>    <span class=kt>long</span> <span class=n>address</span> <span class=o>=</span> <span class=n>Os</span><span class=p>.</span><span class=na>mmap</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>length</span><span class=p>,</span> <span class=n>prot</span><span class=p>,</span> <span class=n>OsConstants</span><span class=p>.</span><span class=na>MAP_SHARED</span><span class=p>,</span> <span class=n>mFileDescriptor</span><span class=p>,</span> <span class=n>offset</span><span class=p>);</span>
<a id=__codelineno-16-12 name=__codelineno-16-12></a><a href=#__codelineno-16-12><span class=linenos data-linenos="12 "></span></a>    <span class=kt>boolean</span> <span class=n>readOnly</span> <span class=o>=</span> <span class=p>(</span><span class=n>prot</span> <span class=o>&amp;</span> <span class=n>OsConstants</span><span class=p>.</span><span class=na>PROT_WRITE</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>;</span>
<a id=__codelineno-16-13 name=__codelineno-16-13></a><a href=#__codelineno-16-13><span class=linenos data-linenos="13 "></span></a>    <span class=n>Runnable</span> <span class=n>unmapper</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Unmapper</span><span class=p>(</span><span class=n>address</span><span class=p>,</span> <span class=n>length</span><span class=p>,</span> <span class=n>mMemoryRegistration</span><span class=p>.</span><span class=na>acquire</span><span class=p>());</span>
<a id=__codelineno-16-14 name=__codelineno-16-14></a><a href=#__codelineno-16-14><span class=linenos data-linenos="14 "></span></a>    <span class=k>return</span> <span class=k>new</span> <span class=n>DirectByteBuffer</span><span class=p>(</span><span class=n>length</span><span class=p>,</span> <span class=n>address</span><span class=p>,</span> <span class=n>mFileDescriptor</span><span class=p>,</span> <span class=n>unmapper</span><span class=p>,</span> <span class=n>readOnly</span><span class=p>);</span>
<a id=__codelineno-16-15 name=__codelineno-16-15></a><a href=#__codelineno-16-15><span class=linenos data-linenos="15 "></span></a><span class=p>}</span>
</code></pre></div></p> <ul> <li>map调用 Os.mmap。其实这个方法的本质就是调用系统调用mmap。这里面的意思就是调用Ashmem对应的文件描述符mmap方法，也就是下午在讲驱动的时候提到的ashmem_mmap。通过这种常规的mmap，让用户态的虚拟内存直接和物理内存映射起来，就能通过0次拷贝的方式映射起来。</li> <li>直接映射一段逻辑上的虚拟内存和文件file关联起来。当系统正式访问这一段虚拟内存，如果找不到就会触发缺页中断(或者尝试的从磁盘执行物理页的换入换出)，此时就会把这一段逻辑绑定的虚拟内存和file正式映射到物理内存。</li> </ul> <h4 id=osmmap>Os.mmap<a class=headerlink href=#osmmap title="Anchor link to this section for reference">&para;</a></h4> <p>这个Os.mmap就比较有意思了，特别是对于没怎么接触过Android源码的同学看到这个，就很难找到原函数在哪个地方。那么这一小节我们就简单聊一聊看到一个陌生的方法，如何找到其原函数的。</p> <ul> <li>找到这个类的位置</li> </ul> <p><img alt=image.png src="https://cdn.nlark.com/yuque/0/2021/png/1759879/1631939050162-56af4a9a-5f00-46fa-b3ae-129a6e9b0c31.png#clientId=ua831b86f-6d5e-4&from=paste&height=361&id=u939ba81b&margin=%5Bobject%20Object%5D&name=image.png&originHeight=721&originWidth=1888&originalType=binary&ratio=1&size=147849&status=done&style=none&taskId=u7a644786-e66b-46a6-acea-ea2ee662104&width=944"></p> <ul> <li>因为我们不知道是在哪里，所以选择了所有文件夹都搜索。但是熟悉Android源码的同学都知道，基本上常用到的java代码都是在framework、system、libcore等目录下。</li> <li>File Path输入：Os.java。搜索出来有非常多并且是一些“乱七八糟”的类。那我们换一个思路，既然是File Path那我们把包名也加上好了。如android/system/Os.java。好的，现在搜索结果只有两个，那么这个结果显然就是<a href=http://aospxref.com/android-11.0.0_r21/xref/libcore/luni/src/main/java/android/system/ >/libcore/luni/src/main/java/android/system/</a><a href=http://aospxref.com/android-11.0.0_r21/xref/libcore/luni/src/main/java/android/system/Os.java>Os.java</a>。这个也跟我们之前猜测的目录相符合。</li> <li> <p>找到类里实现的方法 <div class=highlight><pre><span></span><code><a id=__codelineno-17-1 name=__codelineno-17-1></a><a href=#__codelineno-17-1><span class=linenos data-linenos="1 "></span></a><span class=nl>http</span><span class=p>:</span><span class=c1>//aospxref.com/android-11.0.0_r21/xref/libcore/luni/src/main/java/android/system/Os.java#392</span>
<a id=__codelineno-17-2 name=__codelineno-17-2></a><a href=#__codelineno-17-2><span class=linenos data-linenos="2 "></span></a>
<a id=__codelineno-17-3 name=__codelineno-17-3></a><a href=#__codelineno-17-3><span class=linenos data-linenos="3 "></span></a><span class=cm>/**</span>
<a id=__codelineno-17-4 name=__codelineno-17-4></a><a href=#__codelineno-17-4><span class=linenos data-linenos="4 "></span></a><span class=cm>  * See &lt;a href=&quot;http://man7.org/linux/man-pages/man2/mmap.2.html&quot;&gt;mmap(2)&lt;/a&gt;.</span>
<a id=__codelineno-17-5 name=__codelineno-17-5></a><a href=#__codelineno-17-5><span class=linenos data-linenos="5 "></span></a><span class=cm>  */</span>
<a id=__codelineno-17-6 name=__codelineno-17-6></a><a href=#__codelineno-17-6><span class=linenos data-linenos="6 "></span></a><span class=kd>public</span> <span class=kd>static</span> <span class=kt>long</span> <span class=nf>mmap</span><span class=p>(</span><span class=kt>long</span> <span class=n>address</span><span class=p>,</span> <span class=kt>long</span> <span class=n>byteCount</span><span class=p>,</span> <span class=kt>int</span> <span class=n>prot</span><span class=p>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=p>,</span> <span class=n>FileDescriptor</span> <span class=n>fd</span><span class=p>,</span> <span class=kt>long</span> <span class=n>offset</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>ErrnoException</span> <span class=p>{</span> <span class=k>return</span> <span class=n>Libcore</span><span class=p>.</span><span class=na>os</span><span class=p>.</span><span class=na>mmap</span><span class=p>(</span><span class=n>address</span><span class=p>,</span> <span class=n>byteCount</span><span class=p>,</span> <span class=n>prot</span><span class=p>,</span> <span class=n>flags</span><span class=p>,</span> <span class=n>fd</span><span class=p>,</span> <span class=n>offset</span><span class=p>);</span> <span class=p>}</span>
</code></pre></div> 好家伙，这里又调 <a href="http://aospxref.com/android-11.0.0_r21/s?defs=Libcore&project=libcore">Libcore</a>.<a href="http://aospxref.com/android-11.0.0_r21/s?defs=os&project=libcore">os</a>.<a href=http://aospxref.com/android-11.0.0_r21/xref/libcore/luni/src/main/java/android/system/Os.java#mmap>mmap</a>。那么现在我们就不停的重复上面两个步骤。</p> </li> <li> <p>Libcore <div class=highlight><pre><span></span><code><a id=__codelineno-18-1 name=__codelineno-18-1></a><a href=#__codelineno-18-1><span class=linenos data-linenos="1 "></span></a><span class=nl>http</span><span class=p>:</span><span class=c1>//aospxref.com/android-11.0.0_r21/xref/libcore/luni/src/main/java/libcore/io/Libcore.java</span>
<a id=__codelineno-18-2 name=__codelineno-18-2></a><a href=#__codelineno-18-2><span class=linenos data-linenos="2 "></span></a>
<a id=__codelineno-18-3 name=__codelineno-18-3></a><a href=#__codelineno-18-3><span class=linenos data-linenos="3 "></span></a><span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>Os</span> <span class=n>rawOs</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Linux</span><span class=p>();</span>
<a id=__codelineno-18-4 name=__codelineno-18-4></a><a href=#__codelineno-18-4><span class=linenos data-linenos="4 "></span></a>
<a id=__codelineno-18-5 name=__codelineno-18-5></a><a href=#__codelineno-18-5><span class=linenos data-linenos="5 "></span></a><span class=kd>public</span> <span class=kd>static</span> <span class=kd>volatile</span> <span class=n>Os</span> <span class=n>os</span> <span class=o>=</span> <span class=k>new</span> <span class=n>BlockGuardOs</span><span class=p>(</span><span class=n>rawOs</span><span class=p>);</span>
</code></pre></div></p> </li> <li> <p>BlockGuardOs <div class=highlight><pre><span></span><code><a id=__codelineno-19-1 name=__codelineno-19-1></a><a href=#__codelineno-19-1><span class=linenos data-linenos="1 "></span></a><span class=nl>http</span><span class=p>:</span><span class=c1>//aospxref.com/android-11.0.0_r21/xref/libcore/luni/src/main/java/libcore/io/BlockGuardOs.java#49</span>
<a id=__codelineno-19-2 name=__codelineno-19-2></a><a href=#__codelineno-19-2><span class=linenos data-linenos="2 "></span></a>
<a id=__codelineno-19-3 name=__codelineno-19-3></a><a href=#__codelineno-19-3><span class=linenos data-linenos="3 "></span></a><span class=kd>public</span> <span class=kd>class</span> <span class=nc>BlockGuardOs</span> <span class=kd>extends</span> <span class=n>ForwardingOs</span> <span class=p>{</span>
<a id=__codelineno-19-4 name=__codelineno-19-4></a><a href=#__codelineno-19-4><span class=linenos data-linenos="4 "></span></a>    <span class=nd>@UnsupportedAppUsage</span>
<a id=__codelineno-19-5 name=__codelineno-19-5></a><a href=#__codelineno-19-5><span class=linenos data-linenos="5 "></span></a>    <span class=kd>public</span> <span class=nf>BlockGuardOs</span><span class=p>(</span><span class=n>Os</span> <span class=n>os</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-19-6 name=__codelineno-19-6></a><a href=#__codelineno-19-6><span class=linenos data-linenos="6 "></span></a>        <span class=kd>super</span><span class=p>(</span><span class=n>os</span><span class=p>);</span>
<a id=__codelineno-19-7 name=__codelineno-19-7></a><a href=#__codelineno-19-7><span class=linenos data-linenos="7 "></span></a>    <span class=p>}</span>
<a id=__codelineno-19-8 name=__codelineno-19-8></a><a href=#__codelineno-19-8><span class=linenos data-linenos="8 "></span></a><span class=p>}</span>
</code></pre></div></p> </li> <li> <p>ForwardingOs <div class=highlight><pre><span></span><code><a id=__codelineno-20-1 name=__codelineno-20-1></a><a href=#__codelineno-20-1><span class=linenos data-linenos=" 1 "></span></a><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ForwardingOs</span> <span class=kd>implements</span> <span class=n>Os</span> <span class=p>{</span>
<a id=__codelineno-20-2 name=__codelineno-20-2></a><a href=#__codelineno-20-2><span class=linenos data-linenos=" 2 "></span></a>    <span class=nd>@UnsupportedAppUsage</span>
<a id=__codelineno-20-3 name=__codelineno-20-3></a><a href=#__codelineno-20-3><span class=linenos data-linenos=" 3 "></span></a>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>Os</span> <span class=n>os</span><span class=p>;</span>
<a id=__codelineno-20-4 name=__codelineno-20-4></a><a href=#__codelineno-20-4><span class=linenos data-linenos=" 4 "></span></a>
<a id=__codelineno-20-5 name=__codelineno-20-5></a><a href=#__codelineno-20-5><span class=linenos data-linenos=" 5 "></span></a>    <span class=nd>@UnsupportedAppUsage</span>
<a id=__codelineno-20-6 name=__codelineno-20-6></a><a href=#__codelineno-20-6><span class=linenos data-linenos=" 6 "></span></a>    <span class=nd>@libcore.api.CorePlatformApi</span>
<a id=__codelineno-20-7 name=__codelineno-20-7></a><a href=#__codelineno-20-7><span class=linenos data-linenos=" 7 "></span></a>    <span class=kd>protected</span> <span class=nf>ForwardingOs</span><span class=p>(</span><span class=n>Os</span> <span class=n>os</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-20-8 name=__codelineno-20-8></a><a href=#__codelineno-20-8><span class=linenos data-linenos=" 8 "></span></a>        <span class=k>this</span><span class=p>.</span><span class=na>os</span> <span class=o>=</span> <span class=n>Objects</span><span class=p>.</span><span class=na>requireNonNull</span><span class=p>(</span><span class=n>os</span><span class=p>);</span>
<a id=__codelineno-20-9 name=__codelineno-20-9></a><a href=#__codelineno-20-9><span class=linenos data-linenos=" 9 "></span></a>    <span class=p>}</span>
<a id=__codelineno-20-10 name=__codelineno-20-10></a><a href=#__codelineno-20-10><span class=linenos data-linenos="10 "></span></a>
<a id=__codelineno-20-11 name=__codelineno-20-11></a><a href=#__codelineno-20-11><span class=linenos data-linenos="11 "></span></a>    <span class=kd>public</span> <span class=kt>long</span> <span class=nf>mmap</span><span class=p>(</span><span class=kt>long</span> <span class=n>address</span><span class=p>,</span> <span class=kt>long</span> <span class=n>byteCount</span><span class=p>,</span> <span class=kt>int</span> <span class=n>prot</span><span class=p>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=p>,</span> <span class=n>FileDescriptor</span> <span class=n>fd</span><span class=p>,</span> <span class=kt>long</span> <span class=n>offset</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>ErrnoException</span> <span class=p>{</span> <span class=k>return</span> <span class=n>os</span><span class=p>.</span><span class=na>mmap</span><span class=p>(</span><span class=n>address</span><span class=p>,</span> <span class=n>byteCount</span><span class=p>,</span> <span class=n>prot</span><span class=p>,</span> <span class=n>flags</span><span class=p>,</span> <span class=n>fd</span><span class=p>,</span> <span class=n>offset</span><span class=p>);</span> <span class=p>}</span>
<a id=__codelineno-20-12 name=__codelineno-20-12></a><a href=#__codelineno-20-12><span class=linenos data-linenos="12 "></span></a><span class=p>}</span>
</code></pre></div></p> </li> <li> <p>Os <div class=highlight><pre><span></span><code><a id=__codelineno-21-1 name=__codelineno-21-1></a><a href=#__codelineno-21-1><span class=linenos data-linenos="1 "></span></a><span class=nl>http</span><span class=p>:</span><span class=c1>//aospxref.com/android-11.0.0_r21/xref/libcore/luni/src/main/java/libcore/io/Os.java#132</span>
<a id=__codelineno-21-2 name=__codelineno-21-2></a><a href=#__codelineno-21-2><span class=linenos data-linenos="2 "></span></a>
<a id=__codelineno-21-3 name=__codelineno-21-3></a><a href=#__codelineno-21-3><span class=linenos data-linenos="3 "></span></a><span class=nd>@UnsupportedAppUsage</span>
<a id=__codelineno-21-4 name=__codelineno-21-4></a><a href=#__codelineno-21-4><span class=linenos data-linenos="4 "></span></a><span class=kd>public</span> <span class=kt>long</span> <span class=nf>mmap</span><span class=p>(</span><span class=kt>long</span> <span class=n>address</span><span class=p>,</span> <span class=kt>long</span> <span class=n>byteCount</span><span class=p>,</span> <span class=kt>int</span> <span class=n>prot</span><span class=p>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=p>,</span> <span class=n>FileDescriptor</span> <span class=n>fd</span><span class=p>,</span> <span class=kt>long</span> <span class=n>offset</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>ErrnoException</span><span class=p>;</span>
</code></pre></div> 看到这发现我们走远了，其实真正调用的是Libcore中的Linux。</p> </li> <li> <p>Linux <div class=highlight><pre><span></span><code><a id=__codelineno-22-1 name=__codelineno-22-1></a><a href=#__codelineno-22-1><span class=linenos data-linenos="1 "></span></a><span class=nl>http</span><span class=p>:</span><span class=c1>//aospxref.com/android-11.0.0_r21/xref/libcore/luni/src/main/java/libcore/io/Linux.java#129</span>
<a id=__codelineno-22-2 name=__codelineno-22-2></a><a href=#__codelineno-22-2><span class=linenos data-linenos="2 "></span></a>
<a id=__codelineno-22-3 name=__codelineno-22-3></a><a href=#__codelineno-22-3><span class=linenos data-linenos="3 "></span></a><span class=kd>public</span> <span class=kd>native</span> <span class=kt>long</span> <span class=nf>mmap</span><span class=p>(</span><span class=kt>long</span> <span class=n>address</span><span class=p>,</span> <span class=kt>long</span> <span class=n>byteCount</span><span class=p>,</span> <span class=kt>int</span> <span class=n>prot</span><span class=p>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=p>,</span> <span class=n>FileDescriptor</span> <span class=n>fd</span><span class=p>,</span> <span class=kt>long</span> <span class=n>offset</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>ErrnoException</span><span class=p>;</span>
</code></pre></div> 好，发现调用native。不要慌，其实写过JNI的同学都知道，全局搜索一下看JNINativeMethod里java的mmap方法对应cpp的哪个方法就好了。 当然如果现在直接在源码下这么搜索，出来的结果可想而知，我们换一种更简单的方式。</p> </li> </ul> <h5 id=native>查找native方法<a class=headerlink href=#native title="Anchor link to this section for reference">&para;</a></h5> <p><a href=http://gityuan.com/2016/05/28/android-jni/ >参考gityuan的Android JNI原理分析</a></p> <ul> <li>找到文件</li> </ul> <p>Linux.java的包是libcore.io，那么我们写成libcore_io_Linux.c或者libcore_io_Linux.cpp在搜索，发现是可以搜到libcore_io_Linux.cpp的。并且也是libcore目录下，那看到是它没错了。</p> <ul> <li>找到方法名 <div class=highlight><pre><span></span><code><a id=__codelineno-23-1 name=__codelineno-23-1></a><a href=#__codelineno-23-1><span class=linenos data-linenos="1 "></span></a><span class=nl>http</span><span class=p>:</span><span class=c1>//aospxref.com/android-11.0.0_r21/xref/libcore/luni/src/main/native/libcore_io_Linux.cpp</span>
<a id=__codelineno-23-2 name=__codelineno-23-2></a><a href=#__codelineno-23-2><span class=linenos data-linenos="2 "></span></a>
<a id=__codelineno-23-3 name=__codelineno-23-3></a><a href=#__codelineno-23-3><span class=linenos data-linenos="3 "></span></a><span class=k>static</span><span class=w> </span><span class=n>JNINativeMethod</span><span class=w> </span><span class=n>gMethods</span><span class=p>[]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-23-4 name=__codelineno-23-4></a><a href=#__codelineno-23-4><span class=linenos data-linenos="4 "></span></a><span class=w>    </span><span class=n>NATIVE_METHOD</span><span class=p>(</span><span class=n>Linux</span><span class=p>,</span><span class=w> </span><span class=n>mmap</span><span class=p>,</span><span class=w> </span><span class=s>&quot;(JJIILjava/io/FileDescriptor;J)J&quot;</span><span class=p>),</span><span class=w></span>
<a id=__codelineno-23-5 name=__codelineno-23-5></a><a href=#__codelineno-23-5><span class=linenos data-linenos="5 "></span></a><span class=p>}</span><span class=w></span>
<a id=__codelineno-23-6 name=__codelineno-23-6></a><a href=#__codelineno-23-6><span class=linenos data-linenos="6 "></span></a>
<a id=__codelineno-23-7 name=__codelineno-23-7></a><a href=#__codelineno-23-7><span class=linenos data-linenos="7 "></span></a><span class=n>jniRegisterNativeMethods</span><span class=p>(</span><span class=n>env</span><span class=p>,</span><span class=w> </span><span class=s>&quot;libcore/io/Linux&quot;</span><span class=p>,</span><span class=w> </span><span class=n>gMethods</span><span class=p>,</span><span class=w> </span><span class=n>NELEM</span><span class=p>(</span><span class=n>gMethods</span><span class=p>));</span><span class=w></span>
</code></pre></div> 看到了 <div class=highlight><pre><span></span><code><a id=__codelineno-24-1 name=__codelineno-24-1></a><a href=#__codelineno-24-1><span class=linenos data-linenos=" 1 "></span></a><span class=nl>http</span><span class=p>:</span><span class=c1>//aospxref.com/android-11.0.0_r21/xref/libcore/luni/src/main/native/libcore_io_Linux.cpp</span>
<a id=__codelineno-24-2 name=__codelineno-24-2></a><a href=#__codelineno-24-2><span class=linenos data-linenos=" 2 "></span></a>
<a id=__codelineno-24-3 name=__codelineno-24-3></a><a href=#__codelineno-24-3><span class=linenos data-linenos=" 3 "></span></a><span class=k>static</span><span class=w> </span><span class=n>jlong</span><span class=w> </span><span class=nf>Linux_mmap</span><span class=p>(</span><span class=n>JNIEnv</span><span class=o>*</span><span class=w> </span><span class=n>env</span><span class=p>,</span><span class=w> </span><span class=n>jobject</span><span class=p>,</span><span class=w> </span><span class=n>jlong</span><span class=w> </span><span class=n>address</span><span class=p>,</span><span class=w> </span><span class=n>jlong</span><span class=w> </span><span class=n>byteCount</span><span class=p>,</span><span class=w> </span><span class=n>jint</span><span class=w> </span><span class=n>prot</span><span class=p>,</span><span class=w> </span><span class=n>jint</span><span class=w> </span><span class=n>flags</span><span class=p>,</span><span class=w> </span><span class=n>jobject</span><span class=w> </span><span class=n>javaFd</span><span class=p>,</span><span class=w> </span><span class=n>jlong</span><span class=w> </span><span class=n>offset</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-24-4 name=__codelineno-24-4></a><a href=#__codelineno-24-4><span class=linenos data-linenos=" 4 "></span></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>fd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>jniGetFDFromFileDescriptor</span><span class=p>(</span><span class=n>env</span><span class=p>,</span><span class=w> </span><span class=n>javaFd</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-24-5 name=__codelineno-24-5></a><a href=#__codelineno-24-5><span class=linenos data-linenos=" 5 "></span></a><span class=w>    </span><span class=kt>void</span><span class=o>*</span><span class=w> </span><span class=n>suggestedPtr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>reinterpret_cast</span><span class=o>&lt;</span><span class=kt>void</span><span class=o>*&gt;</span><span class=p>(</span><span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>uintptr_t</span><span class=o>&gt;</span><span class=p>(</span><span class=n>address</span><span class=p>));</span><span class=w></span>
<a id=__codelineno-24-6 name=__codelineno-24-6></a><a href=#__codelineno-24-6><span class=linenos data-linenos=" 6 "></span></a><span class=w>    </span><span class=kt>void</span><span class=o>*</span><span class=w> </span><span class=n>ptr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mmap64</span><span class=p>(</span><span class=n>suggestedPtr</span><span class=p>,</span><span class=w> </span><span class=n>byteCount</span><span class=p>,</span><span class=w> </span><span class=n>prot</span><span class=p>,</span><span class=w> </span><span class=n>flags</span><span class=p>,</span><span class=w> </span><span class=n>fd</span><span class=p>,</span><span class=w> </span><span class=n>offset</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-24-7 name=__codelineno-24-7></a><a href=#__codelineno-24-7><span class=linenos data-linenos=" 7 "></span></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ptr</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>MAP_FAILED</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-24-8 name=__codelineno-24-8></a><a href=#__codelineno-24-8><span class=linenos data-linenos=" 8 "></span></a><span class=w>        </span><span class=n>throwErrnoException</span><span class=p>(</span><span class=n>env</span><span class=p>,</span><span class=w> </span><span class=s>&quot;mmap&quot;</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-24-9 name=__codelineno-24-9></a><a href=#__codelineno-24-9><span class=linenos data-linenos=" 9 "></span></a><span class=w>    </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-24-10 name=__codelineno-24-10></a><a href=#__codelineno-24-10><span class=linenos data-linenos="10 "></span></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=k>static_cast</span><span class=o>&lt;</span><span class=n>jlong</span><span class=o>&gt;</span><span class=p>(</span><span class=k>reinterpret_cast</span><span class=o>&lt;</span><span class=kt>uintptr_t</span><span class=o>&gt;</span><span class=p>(</span><span class=n>ptr</span><span class=p>));</span><span class=w></span>
<a id=__codelineno-24-11 name=__codelineno-24-11></a><a href=#__codelineno-24-11><span class=linenos data-linenos="11 "></span></a><span class=p>}</span><span class=w></span>
</code></pre></div> 到这里我们就可以明确Os.mmap最终就是调用系统调用mmap。 那么我们现在也知道了如何通过OpenGrok搜索我们不熟悉的java类、java函数、native方法等等。</li> </ul> <h4 id=unmapper>Unmapper<a class=headerlink href=#unmapper title="Anchor link to this section for reference">&para;</a></h4> <p><div class=highlight><pre><span></span><code><a id=__codelineno-25-1 name=__codelineno-25-1></a><a href=#__codelineno-25-1><span class=linenos data-linenos=" 1 "></span></a><span class=nl>http</span><span class=p>:</span><span class=c1>//aospxref.com/android-11.0.0_r21/xref/frameworks/base/core/java/android/os/SharedMemory.java</span>
<a id=__codelineno-25-2 name=__codelineno-25-2></a><a href=#__codelineno-25-2><span class=linenos data-linenos=" 2 "></span></a>
<a id=__codelineno-25-3 name=__codelineno-25-3></a><a href=#__codelineno-25-3><span class=linenos data-linenos=" 3 "></span></a><span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>Unmapper</span> <span class=kd>implements</span> <span class=n>Runnable</span> <span class=p>{</span>
<a id=__codelineno-25-4 name=__codelineno-25-4></a><a href=#__codelineno-25-4><span class=linenos data-linenos=" 4 "></span></a>    <span class=kd>private</span> <span class=kt>long</span> <span class=n>mAddress</span><span class=p>;</span>
<a id=__codelineno-25-5 name=__codelineno-25-5></a><a href=#__codelineno-25-5><span class=linenos data-linenos=" 5 "></span></a>    <span class=kd>private</span> <span class=kt>int</span> <span class=n>mSize</span><span class=p>;</span>
<a id=__codelineno-25-6 name=__codelineno-25-6></a><a href=#__codelineno-25-6><span class=linenos data-linenos=" 6 "></span></a>    <span class=kd>private</span> <span class=n>MemoryRegistration</span> <span class=n>mMemoryReference</span><span class=p>;</span>
<a id=__codelineno-25-7 name=__codelineno-25-7></a><a href=#__codelineno-25-7><span class=linenos data-linenos=" 7 "></span></a>
<a id=__codelineno-25-8 name=__codelineno-25-8></a><a href=#__codelineno-25-8><span class=linenos data-linenos=" 8 "></span></a>    <span class=kd>private</span> <span class=nf>Unmapper</span><span class=p>(</span><span class=kt>long</span> <span class=n>address</span><span class=p>,</span> <span class=kt>int</span> <span class=n>size</span><span class=p>,</span> <span class=n>MemoryRegistration</span> <span class=n>memoryReference</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-25-9 name=__codelineno-25-9></a><a href=#__codelineno-25-9><span class=linenos data-linenos=" 9 "></span></a>        <span class=n>mAddress</span> <span class=o>=</span> <span class=n>address</span><span class=p>;</span>
<a id=__codelineno-25-10 name=__codelineno-25-10></a><a href=#__codelineno-25-10><span class=linenos data-linenos="10 "></span></a>        <span class=n>mSize</span> <span class=o>=</span> <span class=n>size</span><span class=p>;</span>
<a id=__codelineno-25-11 name=__codelineno-25-11></a><a href=#__codelineno-25-11><span class=linenos data-linenos="11 "></span></a>        <span class=n>mMemoryReference</span> <span class=o>=</span> <span class=n>memoryReference</span><span class=p>;</span>
<a id=__codelineno-25-12 name=__codelineno-25-12></a><a href=#__codelineno-25-12><span class=linenos data-linenos="12 "></span></a>    <span class=p>}</span>
<a id=__codelineno-25-13 name=__codelineno-25-13></a><a href=#__codelineno-25-13><span class=linenos data-linenos="13 "></span></a>
<a id=__codelineno-25-14 name=__codelineno-25-14></a><a href=#__codelineno-25-14><span class=linenos data-linenos="14 "></span></a>    <span class=nd>@Override</span>
<a id=__codelineno-25-15 name=__codelineno-25-15></a><a href=#__codelineno-25-15><span class=linenos data-linenos="15 "></span></a>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-25-16 name=__codelineno-25-16></a><a href=#__codelineno-25-16><span class=linenos data-linenos="16 "></span></a>        <span class=k>try</span> <span class=p>{</span>
<a id=__codelineno-25-17 name=__codelineno-25-17></a><a href=#__codelineno-25-17><span class=linenos data-linenos="17 "></span></a>            <span class=n>Os</span><span class=p>.</span><span class=na>munmap</span><span class=p>(</span><span class=n>mAddress</span><span class=p>,</span> <span class=n>mSize</span><span class=p>);</span>
<a id=__codelineno-25-18 name=__codelineno-25-18></a><a href=#__codelineno-25-18><span class=linenos data-linenos="18 "></span></a>        <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>ErrnoException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span> <span class=cm>/* swallow exception */</span> <span class=p>}</span>
<a id=__codelineno-25-19 name=__codelineno-25-19></a><a href=#__codelineno-25-19><span class=linenos data-linenos="19 "></span></a>        <span class=n>mMemoryReference</span><span class=p>.</span><span class=na>release</span><span class=p>();</span>
<a id=__codelineno-25-20 name=__codelineno-25-20></a><a href=#__codelineno-25-20><span class=linenos data-linenos="20 "></span></a>        <span class=n>mMemoryReference</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-25-21 name=__codelineno-25-21></a><a href=#__codelineno-25-21><span class=linenos data-linenos="21 "></span></a>    <span class=p>}</span>
<a id=__codelineno-25-22 name=__codelineno-25-22></a><a href=#__codelineno-25-22><span class=linenos data-linenos="22 "></span></a><span class=p>}</span>
</code></pre></div> 在DirectByteBuffer设置解开映射的回调Unmapper，如果通过mMemoryRegistration察觉到引用计数为0，就会调用munmap解映射。因此我们可以推敲出，MemoryFile将会以mapReadWrite产生出来的mMapping为基准，不断的从这一段虚拟内存读写。接下来让我们来看看MemoryFile的读写方法。</p> <h2 id=memoryfile_2>MemoryFile写数据<a class=headerlink href=#memoryfile_2 title="Anchor link to this section for reference">&para;</a></h2> <p><div class=highlight><pre><span></span><code><a id=__codelineno-26-1 name=__codelineno-26-1></a><a href=#__codelineno-26-1><span class=linenos data-linenos=" 1 "></span></a><span class=nl>http</span><span class=p>:</span><span class=c1>//aospxref.com/android-11.0.0_r21/xref/frameworks/base/core/java/android/os/MemoryFile.java</span>
<a id=__codelineno-26-2 name=__codelineno-26-2></a><a href=#__codelineno-26-2><span class=linenos data-linenos=" 2 "></span></a>
<a id=__codelineno-26-3 name=__codelineno-26-3></a><a href=#__codelineno-26-3><span class=linenos data-linenos=" 3 "></span></a><span class=kd>private</span> <span class=kd>class</span> <span class=nc>MemoryOutputStream</span> <span class=kd>extends</span> <span class=n>OutputStream</span> <span class=p>{</span>
<a id=__codelineno-26-4 name=__codelineno-26-4></a><a href=#__codelineno-26-4><span class=linenos data-linenos=" 4 "></span></a>
<a id=__codelineno-26-5 name=__codelineno-26-5></a><a href=#__codelineno-26-5><span class=linenos data-linenos=" 5 "></span></a>    <span class=kd>private</span> <span class=kt>int</span> <span class=n>mOffset</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
<a id=__codelineno-26-6 name=__codelineno-26-6></a><a href=#__codelineno-26-6><span class=linenos data-linenos=" 6 "></span></a>    <span class=kd>private</span> <span class=kt>byte</span><span class=o>[]</span> <span class=n>mSingleByte</span><span class=p>;</span>
<a id=__codelineno-26-7 name=__codelineno-26-7></a><a href=#__codelineno-26-7><span class=linenos data-linenos=" 7 "></span></a>
<a id=__codelineno-26-8 name=__codelineno-26-8></a><a href=#__codelineno-26-8><span class=linenos data-linenos=" 8 "></span></a>    <span class=nd>@Override</span>
<a id=__codelineno-26-9 name=__codelineno-26-9></a><a href=#__codelineno-26-9><span class=linenos data-linenos=" 9 "></span></a>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>write</span><span class=p>(</span><span class=kt>byte</span> <span class=n>buffer</span><span class=o>[]</span><span class=p>,</span> <span class=kt>int</span> <span class=n>offset</span><span class=p>,</span> <span class=kt>int</span> <span class=n>count</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=p>{</span>
<a id=__codelineno-26-10 name=__codelineno-26-10></a><a href=#__codelineno-26-10><span class=linenos data-linenos="10 "></span></a>        <span class=n>writeBytes</span><span class=p>(</span><span class=n>buffer</span><span class=p>,</span> <span class=n>offset</span><span class=p>,</span> <span class=n>mOffset</span><span class=p>,</span> <span class=n>count</span><span class=p>);</span>
<a id=__codelineno-26-11 name=__codelineno-26-11></a><a href=#__codelineno-26-11><span class=linenos data-linenos="11 "></span></a>        <span class=n>mOffset</span> <span class=o>+=</span> <span class=n>count</span><span class=p>;</span>
<a id=__codelineno-26-12 name=__codelineno-26-12></a><a href=#__codelineno-26-12><span class=linenos data-linenos="12 "></span></a>    <span class=p>}</span>
<a id=__codelineno-26-13 name=__codelineno-26-13></a><a href=#__codelineno-26-13><span class=linenos data-linenos="13 "></span></a>
<a id=__codelineno-26-14 name=__codelineno-26-14></a><a href=#__codelineno-26-14><span class=linenos data-linenos="14 "></span></a>    <span class=nd>@Override</span>
<a id=__codelineno-26-15 name=__codelineno-26-15></a><a href=#__codelineno-26-15><span class=linenos data-linenos="15 "></span></a>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>write</span><span class=p>(</span><span class=kt>int</span> <span class=n>oneByte</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=p>{</span>
<a id=__codelineno-26-16 name=__codelineno-26-16></a><a href=#__codelineno-26-16><span class=linenos data-linenos="16 "></span></a>        <span class=k>if</span> <span class=p>(</span><span class=n>mSingleByte</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-26-17 name=__codelineno-26-17></a><a href=#__codelineno-26-17><span class=linenos data-linenos="17 "></span></a>            <span class=n>mSingleByte</span> <span class=o>=</span> <span class=k>new</span> <span class=kt>byte</span><span class=o>[</span><span class=mi>1</span><span class=o>]</span><span class=p>;</span>
<a id=__codelineno-26-18 name=__codelineno-26-18></a><a href=#__codelineno-26-18><span class=linenos data-linenos="18 "></span></a>        <span class=p>}</span>
<a id=__codelineno-26-19 name=__codelineno-26-19></a><a href=#__codelineno-26-19><span class=linenos data-linenos="19 "></span></a>        <span class=n>mSingleByte</span><span class=o>[</span><span class=mi>0</span><span class=o>]</span> <span class=o>=</span> <span class=p>(</span><span class=kt>byte</span><span class=p>)</span><span class=n>oneByte</span><span class=p>;</span>
<a id=__codelineno-26-20 name=__codelineno-26-20></a><a href=#__codelineno-26-20><span class=linenos data-linenos="20 "></span></a>        <span class=n>write</span><span class=p>(</span><span class=n>mSingleByte</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
<a id=__codelineno-26-21 name=__codelineno-26-21></a><a href=#__codelineno-26-21><span class=linenos data-linenos="21 "></span></a>    <span class=p>}</span>
<a id=__codelineno-26-22 name=__codelineno-26-22></a><a href=#__codelineno-26-22><span class=linenos data-linenos="22 "></span></a><span class=p>}</span>
</code></pre></div> 写入操作能看到就是获取MemoryFile的OutputStream对象进行操作。能看到在write方法中，本质上还是调用writeBytes作为核心写入方法。</p> <h3 id=writebytes>writeBytes<a class=headerlink href=#writebytes title="Anchor link to this section for reference">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-27-1 name=__codelineno-27-1></a><a href=#__codelineno-27-1><span class=linenos data-linenos=" 1 "></span></a><span class=nl>http</span><span class=p>:</span><span class=c1>//aospxref.com/android-11.0.0_r21/xref/frameworks/base/core/java/android/os/MemoryFile.java</span>
<a id=__codelineno-27-2 name=__codelineno-27-2></a><a href=#__codelineno-27-2><span class=linenos data-linenos=" 2 "></span></a>
<a id=__codelineno-27-3 name=__codelineno-27-3></a><a href=#__codelineno-27-3><span class=linenos data-linenos=" 3 "></span></a><span class=kd>public</span> <span class=kt>void</span> <span class=nf>writeBytes</span><span class=p>(</span><span class=kt>byte</span><span class=o>[]</span> <span class=n>buffer</span><span class=p>,</span> <span class=kt>int</span> <span class=n>srcOffset</span><span class=p>,</span> <span class=kt>int</span> <span class=n>destOffset</span><span class=p>,</span> <span class=kt>int</span> <span class=n>count</span><span class=p>)</span>
<a id=__codelineno-27-4 name=__codelineno-27-4></a><a href=#__codelineno-27-4><span class=linenos data-linenos=" 4 "></span></a>            <span class=kd>throws</span> <span class=n>IOException</span> <span class=p>{</span>
<a id=__codelineno-27-5 name=__codelineno-27-5></a><a href=#__codelineno-27-5><span class=linenos data-linenos=" 5 "></span></a>    <span class=n>beginAccess</span><span class=p>();</span>
<a id=__codelineno-27-6 name=__codelineno-27-6></a><a href=#__codelineno-27-6><span class=linenos data-linenos=" 6 "></span></a>    <span class=k>try</span> <span class=p>{</span>
<a id=__codelineno-27-7 name=__codelineno-27-7></a><a href=#__codelineno-27-7><span class=linenos data-linenos=" 7 "></span></a>        <span class=n>mMapping</span><span class=p>.</span><span class=na>position</span><span class=p>(</span><span class=n>destOffset</span><span class=p>);</span>
<a id=__codelineno-27-8 name=__codelineno-27-8></a><a href=#__codelineno-27-8><span class=linenos data-linenos=" 8 "></span></a>        <span class=n>mMapping</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>buffer</span><span class=p>,</span> <span class=n>srcOffset</span><span class=p>,</span> <span class=n>count</span><span class=p>);</span>
<a id=__codelineno-27-9 name=__codelineno-27-9></a><a href=#__codelineno-27-9><span class=linenos data-linenos=" 9 "></span></a>    <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
<a id=__codelineno-27-10 name=__codelineno-27-10></a><a href=#__codelineno-27-10><span class=linenos data-linenos="10 "></span></a>        <span class=n>endAccess</span><span class=p>();</span>
<a id=__codelineno-27-11 name=__codelineno-27-11></a><a href=#__codelineno-27-11><span class=linenos data-linenos="11 "></span></a>    <span class=p>}</span>
<a id=__codelineno-27-12 name=__codelineno-27-12></a><a href=#__codelineno-27-12><span class=linenos data-linenos="12 "></span></a><span class=p>}</span>
<a id=__codelineno-27-13 name=__codelineno-27-13></a><a href=#__codelineno-27-13><span class=linenos data-linenos="13 "></span></a>
<a id=__codelineno-27-14 name=__codelineno-27-14></a><a href=#__codelineno-27-14><span class=linenos data-linenos="14 "></span></a><span class=kd>private</span> <span class=kt>void</span> <span class=nf>beginAccess</span><span class=p>()</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=p>{</span>
<a id=__codelineno-27-15 name=__codelineno-27-15></a><a href=#__codelineno-27-15><span class=linenos data-linenos="15 "></span></a>    <span class=n>checkActive</span><span class=p>();</span>
<a id=__codelineno-27-16 name=__codelineno-27-16></a><a href=#__codelineno-27-16><span class=linenos data-linenos="16 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>mAllowPurging</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-27-17 name=__codelineno-27-17></a><a href=#__codelineno-27-17><span class=linenos data-linenos="17 "></span></a>        <span class=k>if</span> <span class=p>(</span><span class=n>native_pin</span><span class=p>(</span><span class=n>mSharedMemory</span><span class=p>.</span><span class=na>getFileDescriptor</span><span class=p>(),</span> <span class=kc>true</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-27-18 name=__codelineno-27-18></a><a href=#__codelineno-27-18><span class=linenos data-linenos="18 "></span></a>            <span class=k>throw</span> <span class=k>new</span> <span class=n>IOException</span><span class=p>(</span><span class=s>&quot;MemoryFile has been purged&quot;</span><span class=p>);</span>
<a id=__codelineno-27-19 name=__codelineno-27-19></a><a href=#__codelineno-27-19><span class=linenos data-linenos="19 "></span></a>        <span class=p>}</span>
<a id=__codelineno-27-20 name=__codelineno-27-20></a><a href=#__codelineno-27-20><span class=linenos data-linenos="20 "></span></a>    <span class=p>}</span>
<a id=__codelineno-27-21 name=__codelineno-27-21></a><a href=#__codelineno-27-21><span class=linenos data-linenos="21 "></span></a><span class=p>}</span>
</code></pre></div> <ul> <li>native_pin</li> </ul> <p>调用native_pin进行锁定这一块大小的虚拟内存，避免被系统回收。</p> <ul> <li>mMapping.position</li> </ul> <p>记录写完后的位置。</p> <ul> <li>mMapping.put</li> </ul> <p>把buffer数据写入到mMapping中。</p> <h3 id=directbytebufferput>DirectByteBuffer.put<a class=headerlink href=#directbytebufferput title="Anchor link to this section for reference">&para;</a></h3> <p>这里稍微不注意就会出错，从代码里看到： <div class=highlight><pre><span></span><code><a id=__codelineno-28-1 name=__codelineno-28-1></a><a href=#__codelineno-28-1><span class=linenos data-linenos="1 "></span></a><span class=nl>http</span><span class=p>:</span><span class=c1>//aospxref.com/android-11.0.0_r21/xref/frameworks/base/core/java/android/os/MemoryFile.java</span>
<a id=__codelineno-28-2 name=__codelineno-28-2></a><a href=#__codelineno-28-2><span class=linenos data-linenos="2 "></span></a>
<a id=__codelineno-28-3 name=__codelineno-28-3></a><a href=#__codelineno-28-3><span class=linenos data-linenos="3 "></span></a><span class=kd>private</span> <span class=n>ByteBuffer</span> <span class=n>mMapping</span><span class=p>;</span>
</code></pre></div> 但是大家还记得赋值的地方吗，也就是： <div class=highlight><pre><span></span><code><a id=__codelineno-29-1 name=__codelineno-29-1></a><a href=#__codelineno-29-1><span class=linenos data-linenos="1 "></span></a><span class=nl>http</span><span class=p>:</span><span class=c1>//aospxref.com/android-11.0.0_r21/xref/frameworks/base/core/java/android/os/MemoryFile.java</span>
<a id=__codelineno-29-2 name=__codelineno-29-2></a><a href=#__codelineno-29-2><span class=linenos data-linenos="2 "></span></a>
<a id=__codelineno-29-3 name=__codelineno-29-3></a><a href=#__codelineno-29-3><span class=linenos data-linenos="3 "></span></a><span class=n>mMapping</span> <span class=o>=</span> <span class=n>mSharedMemory</span><span class=p>.</span><span class=na>mapReadWrite</span><span class=p>();</span>
</code></pre></div> <div class=highlight><pre><span></span><code><a id=__codelineno-30-1 name=__codelineno-30-1></a><a href=#__codelineno-30-1><span class=linenos data-linenos=" 1 "></span></a><span class=nl>http</span><span class=p>:</span><span class=c1>//aospxref.com/android-11.0.0_r21/xref/frameworks/base/core/java/android/os/SharedMemory.java#map</span>
<a id=__codelineno-30-2 name=__codelineno-30-2></a><a href=#__codelineno-30-2><span class=linenos data-linenos=" 2 "></span></a>
<a id=__codelineno-30-3 name=__codelineno-30-3></a><a href=#__codelineno-30-3><span class=linenos data-linenos=" 3 "></span></a><span class=kd>public</span> <span class=nd>@NonNull</span> <span class=n>ByteBuffer</span> <span class=nf>mapReadWrite</span><span class=p>()</span> <span class=kd>throws</span> <span class=n>ErrnoException</span> <span class=p>{</span>
<a id=__codelineno-30-4 name=__codelineno-30-4></a><a href=#__codelineno-30-4><span class=linenos data-linenos=" 4 "></span></a>    <span class=k>return</span> <span class=n>map</span><span class=p>(</span><span class=n>OsConstants</span><span class=p>.</span><span class=na>PROT_READ</span> <span class=o>|</span> <span class=n>OsConstants</span><span class=p>.</span><span class=na>PROT_WRITE</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=n>mSize</span><span class=p>);</span>
<a id=__codelineno-30-5 name=__codelineno-30-5></a><a href=#__codelineno-30-5><span class=linenos data-linenos=" 5 "></span></a><span class=p>}</span>
<a id=__codelineno-30-6 name=__codelineno-30-6></a><a href=#__codelineno-30-6><span class=linenos data-linenos=" 6 "></span></a>
<a id=__codelineno-30-7 name=__codelineno-30-7></a><a href=#__codelineno-30-7><span class=linenos data-linenos=" 7 "></span></a><span class=kd>public</span> <span class=nd>@NonNull</span> <span class=n>ByteBuffer</span> <span class=nf>map</span><span class=p>(</span><span class=kt>int</span> <span class=n>prot</span><span class=p>,</span> <span class=kt>int</span> <span class=n>offset</span><span class=p>,</span> <span class=kt>int</span> <span class=n>length</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>ErrnoException</span> <span class=p>{</span>
<a id=__codelineno-30-8 name=__codelineno-30-8></a><a href=#__codelineno-30-8><span class=linenos data-linenos=" 8 "></span></a>    <span class=p>...</span>
<a id=__codelineno-30-9 name=__codelineno-30-9></a><a href=#__codelineno-30-9><span class=linenos data-linenos=" 9 "></span></a>    <span class=k>return</span> <span class=k>new</span> <span class=n>DirectByteBuffer</span><span class=p>(</span><span class=n>length</span><span class=p>,</span> <span class=n>address</span><span class=p>,</span> <span class=n>mFileDescriptor</span><span class=p>,</span> <span class=n>unmapper</span><span class=p>,</span> <span class=n>readOnly</span><span class=p>);</span>
<a id=__codelineno-30-10 name=__codelineno-30-10></a><a href=#__codelineno-30-10><span class=linenos data-linenos="10 "></span></a><span class=p>}</span>
</code></pre></div> 好家伙，看到了吧，最终是DirectByteBuffer。 所以现在我们有一个问题，什么不直接用我们常见的write函数而是改用DirectByteBuffer.put呢，这其中有什么深意吗？ <div class=highlight><pre><span></span><code><a id=__codelineno-31-1 name=__codelineno-31-1></a><a href=#__codelineno-31-1><span class=linenos data-linenos=" 1 "></span></a><span class=nl>http</span><span class=p>:</span><span class=c1>//aospxref.com/android-11.0.0_r21/xref/libcore/ojluni/src/main/java/java/nio/DirectByteBuffer.java#285</span>
<a id=__codelineno-31-2 name=__codelineno-31-2></a><a href=#__codelineno-31-2><span class=linenos data-linenos=" 2 "></span></a>
<a id=__codelineno-31-3 name=__codelineno-31-3></a><a href=#__codelineno-31-3><span class=linenos data-linenos=" 3 "></span></a><span class=kd>public</span> <span class=n>ByteBuffer</span> <span class=nf>put</span><span class=p>(</span><span class=kt>byte</span><span class=o>[]</span> <span class=n>src</span><span class=p>,</span> <span class=kt>int</span> <span class=n>srcOffset</span><span class=p>,</span> <span class=kt>int</span> <span class=n>length</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-31-4 name=__codelineno-31-4></a><a href=#__codelineno-31-4><span class=linenos data-linenos=" 4 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>memoryRef</span><span class=p>.</span><span class=na>isAccessible</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-31-5 name=__codelineno-31-5></a><a href=#__codelineno-31-5><span class=linenos data-linenos=" 5 "></span></a>        <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&quot;buffer is inaccessible&quot;</span><span class=p>);</span>
<a id=__codelineno-31-6 name=__codelineno-31-6></a><a href=#__codelineno-31-6><span class=linenos data-linenos=" 6 "></span></a>    <span class=p>}</span>
<a id=__codelineno-31-7 name=__codelineno-31-7></a><a href=#__codelineno-31-7><span class=linenos data-linenos=" 7 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>isReadOnly</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-31-8 name=__codelineno-31-8></a><a href=#__codelineno-31-8><span class=linenos data-linenos=" 8 "></span></a>        <span class=k>throw</span> <span class=k>new</span> <span class=n>ReadOnlyBufferException</span><span class=p>();</span>
<a id=__codelineno-31-9 name=__codelineno-31-9></a><a href=#__codelineno-31-9><span class=linenos data-linenos=" 9 "></span></a>    <span class=p>}</span>
<a id=__codelineno-31-10 name=__codelineno-31-10></a><a href=#__codelineno-31-10><span class=linenos data-linenos="10 "></span></a>    <span class=n>checkBounds</span><span class=p>(</span><span class=n>srcOffset</span><span class=p>,</span> <span class=n>length</span><span class=p>,</span> <span class=n>src</span><span class=p>.</span><span class=na>length</span><span class=p>);</span>
<a id=__codelineno-31-11 name=__codelineno-31-11></a><a href=#__codelineno-31-11><span class=linenos data-linenos="11 "></span></a>    <span class=kt>int</span> <span class=n>pos</span> <span class=o>=</span> <span class=n>position</span><span class=p>();</span>
<a id=__codelineno-31-12 name=__codelineno-31-12></a><a href=#__codelineno-31-12><span class=linenos data-linenos="12 "></span></a>    <span class=kt>int</span> <span class=n>lim</span> <span class=o>=</span> <span class=n>limit</span><span class=p>();</span>
<a id=__codelineno-31-13 name=__codelineno-31-13></a><a href=#__codelineno-31-13><span class=linenos data-linenos="13 "></span></a>    <span class=k>assert</span> <span class=p>(</span><span class=n>pos</span> <span class=o>&lt;=</span> <span class=n>lim</span><span class=p>);</span>
<a id=__codelineno-31-14 name=__codelineno-31-14></a><a href=#__codelineno-31-14><span class=linenos data-linenos="14 "></span></a>    <span class=kt>int</span> <span class=n>rem</span> <span class=o>=</span> <span class=p>(</span><span class=n>pos</span> <span class=o>&lt;=</span> <span class=n>lim</span> <span class=o>?</span> <span class=n>lim</span> <span class=o>-</span> <span class=n>pos</span> <span class=p>:</span> <span class=mi>0</span><span class=p>);</span>
<a id=__codelineno-31-15 name=__codelineno-31-15></a><a href=#__codelineno-31-15><span class=linenos data-linenos="15 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>length</span> <span class=o>&gt;</span> <span class=n>rem</span><span class=p>)</span>
<a id=__codelineno-31-16 name=__codelineno-31-16></a><a href=#__codelineno-31-16><span class=linenos data-linenos="16 "></span></a>        <span class=k>throw</span> <span class=k>new</span> <span class=n>BufferOverflowException</span><span class=p>();</span>
<a id=__codelineno-31-17 name=__codelineno-31-17></a><a href=#__codelineno-31-17><span class=linenos data-linenos="17 "></span></a>    <span class=n>Memory</span><span class=p>.</span><span class=na>pokeByteArray</span><span class=p>(</span><span class=n>ix</span><span class=p>(</span><span class=n>pos</span><span class=p>),</span>
<a id=__codelineno-31-18 name=__codelineno-31-18></a><a href=#__codelineno-31-18><span class=linenos data-linenos="18 "></span></a>            <span class=n>src</span><span class=p>,</span> <span class=n>srcOffset</span><span class=p>,</span> <span class=n>length</span><span class=p>);</span>
<a id=__codelineno-31-19 name=__codelineno-31-19></a><a href=#__codelineno-31-19><span class=linenos data-linenos="19 "></span></a>    <span class=n>position</span> <span class=o>=</span> <span class=n>pos</span> <span class=o>+</span> <span class=n>length</span><span class=p>;</span>
<a id=__codelineno-31-20 name=__codelineno-31-20></a><a href=#__codelineno-31-20><span class=linenos data-linenos="20 "></span></a>    <span class=k>return</span> <span class=k>this</span><span class=p>;</span>
<a id=__codelineno-31-21 name=__codelineno-31-21></a><a href=#__codelineno-31-21><span class=linenos data-linenos="21 "></span></a><span class=p>}</span>
</code></pre></div></p> <ul> <li>根据设置进来的position设定已经写入了多少数据，从哪里开始写入。接着会通过传进来的数据长度以及要写入的偏移量来确定要写入哪一块内存。</li> <li>调用Memory.pokeByteArray方法，把内容写到虚拟地址偏移量的起点到数据长度结束中，也就是写入到对应位置的物理页中。</li> </ul> <p>那么现在能理解为什么不用write而是用DirectByteBuffer.put了，因为mmap的核心原理就是把物理页和虚拟内存页映射起来。 我们接着看Memory.pokeByteArray，看看是不是我们猜想的那样。</p> <h3 id=memorypokebytearray>Memory.pokeByteArray<a class=headerlink href=#memorypokebytearray title="Anchor link to this section for reference">&para;</a></h3> <p><div class=highlight><pre><span></span><code><a id=__codelineno-32-1 name=__codelineno-32-1></a><a href=#__codelineno-32-1><span class=linenos data-linenos="1 "></span></a><span class=nl>http</span><span class=p>:</span><span class=c1>//aospxref.com/android-11.0.0_r21/xref/libcore/luni/src/main/java/libcore/io/Memory.java#242</span>
<a id=__codelineno-32-2 name=__codelineno-32-2></a><a href=#__codelineno-32-2><span class=linenos data-linenos="2 "></span></a>
<a id=__codelineno-32-3 name=__codelineno-32-3></a><a href=#__codelineno-32-3><span class=linenos data-linenos="3 "></span></a><span class=kd>public</span> <span class=kd>static</span> <span class=kd>native</span> <span class=kt>void</span> <span class=nf>pokeByteArray</span><span class=p>(</span><span class=kt>long</span> <span class=n>address</span><span class=p>,</span> <span class=kt>byte</span><span class=o>[]</span> <span class=n>src</span><span class=p>,</span> <span class=kt>int</span> <span class=n>offset</span><span class=p>,</span> <span class=kt>int</span> <span class=n>count</span><span class=p>);</span>
</code></pre></div> native方法，那么还是像上文提到的方法一样找到其真正的native方法。 <div class=highlight><pre><span></span><code><a id=__codelineno-33-1 name=__codelineno-33-1></a><a href=#__codelineno-33-1><span class=linenos data-linenos="1 "></span></a><span class=nl>http</span><span class=p>:</span><span class=c1>//aospxref.com/android-11.0.0_r21/xref/libcore/luni/src/main/native/libcore_io_Memory.cpp#111</span>
<a id=__codelineno-33-2 name=__codelineno-33-2></a><a href=#__codelineno-33-2><span class=linenos data-linenos="2 "></span></a>
<a id=__codelineno-33-3 name=__codelineno-33-3></a><a href=#__codelineno-33-3><span class=linenos data-linenos="3 "></span></a><span class=kd>static</span> <span class=kt>void</span> <span class=nf>Memory_peekByteArray</span><span class=p>(</span><span class=n>JNIEnv</span><span class=o>*</span> <span class=n>env</span><span class=p>,</span> <span class=n>jclass</span><span class=p>,</span> <span class=n>jlong</span> <span class=n>srcAddress</span><span class=p>,</span> <span class=n>jbyteArray</span> <span class=n>dst</span><span class=p>,</span> <span class=n>jint</span> <span class=n>dstOffset</span><span class=p>,</span> <span class=n>jint</span> <span class=n>byteCount</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-33-4 name=__codelineno-33-4></a><a href=#__codelineno-33-4><span class=linenos data-linenos="4 "></span></a>    <span class=n>env</span><span class=o>-&gt;</span><span class=n>SetByteArrayRegion</span><span class=p>(</span><span class=n>dst</span><span class=p>,</span> <span class=n>dstOffset</span><span class=p>,</span> <span class=n>byteCount</span><span class=p>,</span> <span class=n>cast</span><span class=o>&lt;</span><span class=kd>const</span> <span class=n>jbyte</span><span class=o>*&gt;</span><span class=p>(</span><span class=n>srcAddress</span><span class=p>));</span>
<a id=__codelineno-33-5 name=__codelineno-33-5></a><a href=#__codelineno-33-5><span class=linenos data-linenos="5 "></span></a><span class=p>}</span>
</code></pre></div> <img alt=image.png src="https://cdn.nlark.com/yuque/0/2021/png/1759879/1631944067239-ab3e365b-38eb-4bee-a895-abb2e2b3a505.png#clientId=ua831b86f-6d5e-4&from=paste&id=u1a9f819c&margin=%5Bobject%20Object%5D&name=image.png&originHeight=234&originWidth=561&originalType=url&ratio=1&size=18222&status=done&style=none&taskId=u5f2c0676-fac7-4cbb-afe3-7cd1c3aced8"></p> <h2 id=memoryfile_3>MemoryFile读数据<a class=headerlink href=#memoryfile_3 title="Anchor link to this section for reference">&para;</a></h2> <p><div class=highlight><pre><span></span><code><a id=__codelineno-34-1 name=__codelineno-34-1></a><a href=#__codelineno-34-1><span class=linenos data-linenos=" 1 "></span></a><span class=nl>http</span><span class=p>:</span><span class=c1>//aospxref.com/android-11.0.0_r21/xref/frameworks/base/core/java/android/os/MemoryFile.java#247</span>
<a id=__codelineno-34-2 name=__codelineno-34-2></a><a href=#__codelineno-34-2><span class=linenos data-linenos=" 2 "></span></a>
<a id=__codelineno-34-3 name=__codelineno-34-3></a><a href=#__codelineno-34-3><span class=linenos data-linenos=" 3 "></span></a><span class=kd>private</span> <span class=kd>class</span> <span class=nc>MemoryInputStream</span> <span class=kd>extends</span> <span class=n>InputStream</span> <span class=p>{</span>
<a id=__codelineno-34-4 name=__codelineno-34-4></a><a href=#__codelineno-34-4><span class=linenos data-linenos=" 4 "></span></a>
<a id=__codelineno-34-5 name=__codelineno-34-5></a><a href=#__codelineno-34-5><span class=linenos data-linenos=" 5 "></span></a>    <span class=kd>private</span> <span class=kt>int</span> <span class=n>mMark</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
<a id=__codelineno-34-6 name=__codelineno-34-6></a><a href=#__codelineno-34-6><span class=linenos data-linenos=" 6 "></span></a>    <span class=kd>private</span> <span class=kt>int</span> <span class=n>mOffset</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
<a id=__codelineno-34-7 name=__codelineno-34-7></a><a href=#__codelineno-34-7><span class=linenos data-linenos=" 7 "></span></a>    <span class=kd>private</span> <span class=kt>byte</span><span class=o>[]</span> <span class=n>mSingleByte</span><span class=p>;</span>
<a id=__codelineno-34-8 name=__codelineno-34-8></a><a href=#__codelineno-34-8><span class=linenos data-linenos=" 8 "></span></a>
<a id=__codelineno-34-9 name=__codelineno-34-9></a><a href=#__codelineno-34-9><span class=linenos data-linenos=" 9 "></span></a>    <span class=p>...</span>
<a id=__codelineno-34-10 name=__codelineno-34-10></a><a href=#__codelineno-34-10><span class=linenos data-linenos="10 "></span></a>
<a id=__codelineno-34-11 name=__codelineno-34-11></a><a href=#__codelineno-34-11><span class=linenos data-linenos="11 "></span></a>    <span class=nd>@Override</span>
<a id=__codelineno-34-12 name=__codelineno-34-12></a><a href=#__codelineno-34-12><span class=linenos data-linenos="12 "></span></a>    <span class=kd>public</span> <span class=kt>int</span> <span class=nf>read</span><span class=p>()</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=p>{</span>
<a id=__codelineno-34-13 name=__codelineno-34-13></a><a href=#__codelineno-34-13><span class=linenos data-linenos="13 "></span></a>        <span class=k>if</span> <span class=p>(</span><span class=n>mSingleByte</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-34-14 name=__codelineno-34-14></a><a href=#__codelineno-34-14><span class=linenos data-linenos="14 "></span></a>            <span class=n>mSingleByte</span> <span class=o>=</span> <span class=k>new</span> <span class=kt>byte</span><span class=o>[</span><span class=mi>1</span><span class=o>]</span><span class=p>;</span>
<a id=__codelineno-34-15 name=__codelineno-34-15></a><a href=#__codelineno-34-15><span class=linenos data-linenos="15 "></span></a>        <span class=p>}</span>
<a id=__codelineno-34-16 name=__codelineno-34-16></a><a href=#__codelineno-34-16><span class=linenos data-linenos="16 "></span></a>        <span class=kt>int</span> <span class=n>result</span> <span class=o>=</span> <span class=n>read</span><span class=p>(</span><span class=n>mSingleByte</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>1</span><span class=p>);</span>
<a id=__codelineno-34-17 name=__codelineno-34-17></a><a href=#__codelineno-34-17><span class=linenos data-linenos="17 "></span></a>        <span class=k>if</span> <span class=p>(</span><span class=n>result</span> <span class=o>!=</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-34-18 name=__codelineno-34-18></a><a href=#__codelineno-34-18><span class=linenos data-linenos="18 "></span></a>            <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
<a id=__codelineno-34-19 name=__codelineno-34-19></a><a href=#__codelineno-34-19><span class=linenos data-linenos="19 "></span></a>        <span class=p>}</span>
<a id=__codelineno-34-20 name=__codelineno-34-20></a><a href=#__codelineno-34-20><span class=linenos data-linenos="20 "></span></a>        <span class=k>return</span> <span class=n>mSingleByte</span><span class=o>[</span><span class=mi>0</span><span class=o>]</span><span class=p>;</span>
<a id=__codelineno-34-21 name=__codelineno-34-21></a><a href=#__codelineno-34-21><span class=linenos data-linenos="21 "></span></a>    <span class=p>}</span>
<a id=__codelineno-34-22 name=__codelineno-34-22></a><a href=#__codelineno-34-22><span class=linenos data-linenos="22 "></span></a>
<a id=__codelineno-34-23 name=__codelineno-34-23></a><a href=#__codelineno-34-23><span class=linenos data-linenos="23 "></span></a>    <span class=nd>@Override</span>
<a id=__codelineno-34-24 name=__codelineno-34-24></a><a href=#__codelineno-34-24><span class=linenos data-linenos="24 "></span></a>    <span class=kd>public</span> <span class=kt>int</span> <span class=nf>read</span><span class=p>(</span><span class=kt>byte</span> <span class=n>buffer</span><span class=o>[]</span><span class=p>,</span> <span class=kt>int</span> <span class=n>offset</span><span class=p>,</span> <span class=kt>int</span> <span class=n>count</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=p>{</span>
<a id=__codelineno-34-25 name=__codelineno-34-25></a><a href=#__codelineno-34-25><span class=linenos data-linenos="25 "></span></a>        <span class=k>if</span> <span class=p>(</span><span class=n>offset</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=o>||</span> <span class=n>count</span> <span class=o>&lt;</span> <span class=mi>0</span> <span class=o>||</span> <span class=n>offset</span> <span class=o>+</span> <span class=n>count</span> <span class=o>&gt;</span> <span class=n>buffer</span><span class=p>.</span><span class=na>length</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-34-26 name=__codelineno-34-26></a><a href=#__codelineno-34-26><span class=linenos data-linenos="26 "></span></a>            <span class=c1>// readBytes() also does this check, but we need to do it before</span>
<a id=__codelineno-34-27 name=__codelineno-34-27></a><a href=#__codelineno-34-27><span class=linenos data-linenos="27 "></span></a>            <span class=c1>// changing count.</span>
<a id=__codelineno-34-28 name=__codelineno-34-28></a><a href=#__codelineno-34-28><span class=linenos data-linenos="28 "></span></a>            <span class=k>throw</span> <span class=k>new</span> <span class=n>IndexOutOfBoundsException</span><span class=p>();</span>
<a id=__codelineno-34-29 name=__codelineno-34-29></a><a href=#__codelineno-34-29><span class=linenos data-linenos="29 "></span></a>        <span class=p>}</span>
<a id=__codelineno-34-30 name=__codelineno-34-30></a><a href=#__codelineno-34-30><span class=linenos data-linenos="30 "></span></a>        <span class=n>count</span> <span class=o>=</span> <span class=n>Math</span><span class=p>.</span><span class=na>min</span><span class=p>(</span><span class=n>count</span><span class=p>,</span> <span class=n>available</span><span class=p>());</span>
<a id=__codelineno-34-31 name=__codelineno-34-31></a><a href=#__codelineno-34-31><span class=linenos data-linenos="31 "></span></a>        <span class=k>if</span> <span class=p>(</span><span class=n>count</span> <span class=o>&lt;</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-34-32 name=__codelineno-34-32></a><a href=#__codelineno-34-32><span class=linenos data-linenos="32 "></span></a>            <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
<a id=__codelineno-34-33 name=__codelineno-34-33></a><a href=#__codelineno-34-33><span class=linenos data-linenos="33 "></span></a>        <span class=p>}</span>
<a id=__codelineno-34-34 name=__codelineno-34-34></a><a href=#__codelineno-34-34><span class=linenos data-linenos="34 "></span></a>        <span class=kt>int</span> <span class=n>result</span> <span class=o>=</span> <span class=n>readBytes</span><span class=p>(</span><span class=n>buffer</span><span class=p>,</span> <span class=n>mOffset</span><span class=p>,</span> <span class=n>offset</span><span class=p>,</span> <span class=n>count</span><span class=p>);</span>
<a id=__codelineno-34-35 name=__codelineno-34-35></a><a href=#__codelineno-34-35><span class=linenos data-linenos="35 "></span></a>        <span class=k>if</span> <span class=p>(</span><span class=n>result</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-34-36 name=__codelineno-34-36></a><a href=#__codelineno-34-36><span class=linenos data-linenos="36 "></span></a>            <span class=n>mOffset</span> <span class=o>+=</span> <span class=n>result</span><span class=p>;</span>
<a id=__codelineno-34-37 name=__codelineno-34-37></a><a href=#__codelineno-34-37><span class=linenos data-linenos="37 "></span></a>        <span class=p>}</span>
<a id=__codelineno-34-38 name=__codelineno-34-38></a><a href=#__codelineno-34-38><span class=linenos data-linenos="38 "></span></a>        <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
<a id=__codelineno-34-39 name=__codelineno-34-39></a><a href=#__codelineno-34-39><span class=linenos data-linenos="39 "></span></a>    <span class=p>}</span>
<a id=__codelineno-34-40 name=__codelineno-34-40></a><a href=#__codelineno-34-40><span class=linenos data-linenos="40 "></span></a>
<a id=__codelineno-34-41 name=__codelineno-34-41></a><a href=#__codelineno-34-41><span class=linenos data-linenos="41 "></span></a>    <span class=p>...</span>
<a id=__codelineno-34-42 name=__codelineno-34-42></a><a href=#__codelineno-34-42><span class=linenos data-linenos="42 "></span></a><span class=p>}</span>
</code></pre></div> 写入操作能看到就是获取MemoryFile的InputStream对象进行操作。能看到在read方法中，本质上还是调用readBytes作为核心写入方法。</p> <h3 id=readbytes>readBytes<a class=headerlink href=#readbytes title="Anchor link to this section for reference">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-35-1 name=__codelineno-35-1></a><a href=#__codelineno-35-1><span class=linenos data-linenos=" 1 "></span></a><span class=nl>http</span><span class=p>:</span><span class=c1>//aospxref.com/android-11.0.0_r21/xref/frameworks/base/core/java/android/os/MemoryFile.java</span>
<a id=__codelineno-35-2 name=__codelineno-35-2></a><a href=#__codelineno-35-2><span class=linenos data-linenos=" 2 "></span></a>
<a id=__codelineno-35-3 name=__codelineno-35-3></a><a href=#__codelineno-35-3><span class=linenos data-linenos=" 3 "></span></a><span class=kd>public</span> <span class=kt>int</span> <span class=nf>readBytes</span><span class=p>(</span><span class=kt>byte</span><span class=o>[]</span> <span class=n>buffer</span><span class=p>,</span> <span class=kt>int</span> <span class=n>srcOffset</span><span class=p>,</span> <span class=kt>int</span> <span class=n>destOffset</span><span class=p>,</span> <span class=kt>int</span> <span class=n>count</span><span class=p>)</span>
<a id=__codelineno-35-4 name=__codelineno-35-4></a><a href=#__codelineno-35-4><span class=linenos data-linenos=" 4 "></span></a>            <span class=kd>throws</span> <span class=n>IOException</span> <span class=p>{</span>
<a id=__codelineno-35-5 name=__codelineno-35-5></a><a href=#__codelineno-35-5><span class=linenos data-linenos=" 5 "></span></a>    <span class=n>beginAccess</span><span class=p>();</span>
<a id=__codelineno-35-6 name=__codelineno-35-6></a><a href=#__codelineno-35-6><span class=linenos data-linenos=" 6 "></span></a>    <span class=k>try</span> <span class=p>{</span>
<a id=__codelineno-35-7 name=__codelineno-35-7></a><a href=#__codelineno-35-7><span class=linenos data-linenos=" 7 "></span></a>        <span class=n>mMapping</span><span class=p>.</span><span class=na>position</span><span class=p>(</span><span class=n>srcOffset</span><span class=p>);</span>
<a id=__codelineno-35-8 name=__codelineno-35-8></a><a href=#__codelineno-35-8><span class=linenos data-linenos=" 8 "></span></a>        <span class=n>mMapping</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>buffer</span><span class=p>,</span> <span class=n>destOffset</span><span class=p>,</span> <span class=n>count</span><span class=p>);</span>
<a id=__codelineno-35-9 name=__codelineno-35-9></a><a href=#__codelineno-35-9><span class=linenos data-linenos=" 9 "></span></a>    <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
<a id=__codelineno-35-10 name=__codelineno-35-10></a><a href=#__codelineno-35-10><span class=linenos data-linenos="10 "></span></a>        <span class=n>endAccess</span><span class=p>();</span>
<a id=__codelineno-35-11 name=__codelineno-35-11></a><a href=#__codelineno-35-11><span class=linenos data-linenos="11 "></span></a>    <span class=p>}</span>
<a id=__codelineno-35-12 name=__codelineno-35-12></a><a href=#__codelineno-35-12><span class=linenos data-linenos="12 "></span></a>    <span class=k>return</span> <span class=n>count</span><span class=p>;</span>
<a id=__codelineno-35-13 name=__codelineno-35-13></a><a href=#__codelineno-35-13><span class=linenos data-linenos="13 "></span></a><span class=p>}</span>
</code></pre></div> <ul> <li>native_pin</li> </ul> <p>调用native_pin进行锁定这一块大小的虚拟内存，避免被系统回收。</p> <ul> <li>mMapping.position</li> </ul> <p>记录位置。</p> <ul> <li>mMapping.get</li> </ul> <p>把buffer数据读到mMapping中。</p> <h3 id=directbytebufferget>DirectByteBuffer.get<a class=headerlink href=#directbytebufferget title="Anchor link to this section for reference">&para;</a></h3> <p>在DirectByteBuffer.put已经分析过，所以我们直接看原函数： <div class=highlight><pre><span></span><code><a id=__codelineno-36-1 name=__codelineno-36-1></a><a href=#__codelineno-36-1><span class=linenos data-linenos=" 1 "></span></a><span class=nl>http</span><span class=p>:</span><span class=c1>//aospxref.com/android-11.0.0_r21/xref/libcore/ojluni/src/main/java/java/nio/DirectByteBuffer.java#229</span>
<a id=__codelineno-36-2 name=__codelineno-36-2></a><a href=#__codelineno-36-2><span class=linenos data-linenos=" 2 "></span></a>
<a id=__codelineno-36-3 name=__codelineno-36-3></a><a href=#__codelineno-36-3><span class=linenos data-linenos=" 3 "></span></a><span class=kd>public</span> <span class=n>ByteBuffer</span> <span class=nf>get</span><span class=p>(</span><span class=kt>byte</span><span class=o>[]</span> <span class=n>dst</span><span class=p>,</span> <span class=kt>int</span> <span class=n>dstOffset</span><span class=p>,</span> <span class=kt>int</span> <span class=n>length</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-36-4 name=__codelineno-36-4></a><a href=#__codelineno-36-4><span class=linenos data-linenos=" 4 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>memoryRef</span><span class=p>.</span><span class=na>isAccessible</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-36-5 name=__codelineno-36-5></a><a href=#__codelineno-36-5><span class=linenos data-linenos=" 5 "></span></a>        <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&quot;buffer is inaccessible&quot;</span><span class=p>);</span>
<a id=__codelineno-36-6 name=__codelineno-36-6></a><a href=#__codelineno-36-6><span class=linenos data-linenos=" 6 "></span></a>    <span class=p>}</span>
<a id=__codelineno-36-7 name=__codelineno-36-7></a><a href=#__codelineno-36-7><span class=linenos data-linenos=" 7 "></span></a>    <span class=n>checkBounds</span><span class=p>(</span><span class=n>dstOffset</span><span class=p>,</span> <span class=n>length</span><span class=p>,</span> <span class=n>dst</span><span class=p>.</span><span class=na>length</span><span class=p>);</span>
<a id=__codelineno-36-8 name=__codelineno-36-8></a><a href=#__codelineno-36-8><span class=linenos data-linenos=" 8 "></span></a>    <span class=kt>int</span> <span class=n>pos</span> <span class=o>=</span> <span class=n>position</span><span class=p>();</span>
<a id=__codelineno-36-9 name=__codelineno-36-9></a><a href=#__codelineno-36-9><span class=linenos data-linenos=" 9 "></span></a>    <span class=kt>int</span> <span class=n>lim</span> <span class=o>=</span> <span class=n>limit</span><span class=p>();</span>
<a id=__codelineno-36-10 name=__codelineno-36-10></a><a href=#__codelineno-36-10><span class=linenos data-linenos="10 "></span></a>    <span class=k>assert</span> <span class=p>(</span><span class=n>pos</span> <span class=o>&lt;=</span> <span class=n>lim</span><span class=p>);</span>
<a id=__codelineno-36-11 name=__codelineno-36-11></a><a href=#__codelineno-36-11><span class=linenos data-linenos="11 "></span></a>    <span class=kt>int</span> <span class=n>rem</span> <span class=o>=</span> <span class=p>(</span><span class=n>pos</span> <span class=o>&lt;=</span> <span class=n>lim</span> <span class=o>?</span> <span class=n>lim</span> <span class=o>-</span> <span class=n>pos</span> <span class=p>:</span> <span class=mi>0</span><span class=p>);</span>
<a id=__codelineno-36-12 name=__codelineno-36-12></a><a href=#__codelineno-36-12><span class=linenos data-linenos="12 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>length</span> <span class=o>&gt;</span> <span class=n>rem</span><span class=p>)</span>
<a id=__codelineno-36-13 name=__codelineno-36-13></a><a href=#__codelineno-36-13><span class=linenos data-linenos="13 "></span></a>        <span class=k>throw</span> <span class=k>new</span> <span class=n>BufferUnderflowException</span><span class=p>();</span>
<a id=__codelineno-36-14 name=__codelineno-36-14></a><a href=#__codelineno-36-14><span class=linenos data-linenos="14 "></span></a>    <span class=n>Memory</span><span class=p>.</span><span class=na>peekByteArray</span><span class=p>(</span><span class=n>ix</span><span class=p>(</span><span class=n>pos</span><span class=p>),</span>
<a id=__codelineno-36-15 name=__codelineno-36-15></a><a href=#__codelineno-36-15><span class=linenos data-linenos="15 "></span></a>            <span class=n>dst</span><span class=p>,</span> <span class=n>dstOffset</span><span class=p>,</span> <span class=n>length</span><span class=p>);</span>
<a id=__codelineno-36-16 name=__codelineno-36-16></a><a href=#__codelineno-36-16><span class=linenos data-linenos="16 "></span></a>    <span class=n>position</span> <span class=o>=</span> <span class=n>pos</span> <span class=o>+</span> <span class=n>length</span><span class=p>;</span>
<a id=__codelineno-36-17 name=__codelineno-36-17></a><a href=#__codelineno-36-17><span class=linenos data-linenos="17 "></span></a>    <span class=k>return</span> <span class=k>this</span><span class=p>;</span>
<a id=__codelineno-36-18 name=__codelineno-36-18></a><a href=#__codelineno-36-18><span class=linenos data-linenos="18 "></span></a><span class=p>}</span>
</code></pre></div> 一样也是获取当前已经写入的位置，从该位置+偏移量作为读取数据的起点，读取数据的长度即为所得。</p> <h3 id=memorypeekbytearray>Memory.peekByteArray<a class=headerlink href=#memorypeekbytearray title="Anchor link to this section for reference">&para;</a></h3> <p><div class=highlight><pre><span></span><code><a id=__codelineno-37-1 name=__codelineno-37-1></a><a href=#__codelineno-37-1><span class=linenos data-linenos="1 "></span></a><span class=nl>http</span><span class=p>:</span><span class=c1>//aospxref.com/android-11.0.0_r21/xref/libcore/luni/src/main/native/libcore_io_Memory.cpp#111</span>
<a id=__codelineno-37-2 name=__codelineno-37-2></a><a href=#__codelineno-37-2><span class=linenos data-linenos="2 "></span></a>
<a id=__codelineno-37-3 name=__codelineno-37-3></a><a href=#__codelineno-37-3><span class=linenos data-linenos="3 "></span></a><span class=kd>static</span> <span class=kt>void</span> <span class=nf>Memory_peekByteArray</span><span class=p>(</span><span class=n>JNIEnv</span><span class=o>*</span> <span class=n>env</span><span class=p>,</span> <span class=n>jclass</span><span class=p>,</span> <span class=n>jlong</span> <span class=n>srcAddress</span><span class=p>,</span> <span class=n>jbyteArray</span> <span class=n>dst</span><span class=p>,</span> <span class=n>jint</span> <span class=n>dstOffset</span><span class=p>,</span> <span class=n>jint</span> <span class=n>byteCount</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-37-4 name=__codelineno-37-4></a><a href=#__codelineno-37-4><span class=linenos data-linenos="4 "></span></a>    <span class=n>env</span><span class=o>-&gt;</span><span class=n>SetByteArrayRegion</span><span class=p>(</span><span class=n>dst</span><span class=p>,</span> <span class=n>dstOffset</span><span class=p>,</span> <span class=n>byteCount</span><span class=p>,</span> <span class=n>cast</span><span class=o>&lt;</span><span class=kd>const</span> <span class=n>jbyte</span><span class=o>*&gt;</span><span class=p>(</span><span class=n>srcAddress</span><span class=p>));</span>
<a id=__codelineno-37-5 name=__codelineno-37-5></a><a href=#__codelineno-37-5><span class=linenos data-linenos="5 "></span></a><span class=p>}</span>
</code></pre></div> 能看到此时就是获取目标区域内存的数据，设置到srcAddress中。</p> <h2 id=_9>总结<a class=headerlink href=#_9 title="Anchor link to this section for reference">&para;</a></h2> <p>Ashmem匿名共享内存使用的步骤可以分以下几步： - open ashmem驱动 - ioctl 发送ASHMEM_SET_NAME命令为该ashmem创建名字 - ioctl 发送ASHMEM_SET_SIZE命令为ashmem设置大小 - mmap - 对该文件描述符进行读写</p> <h1 id=ashmem>Ashmem驱动<a class=headerlink href=#ashmem title="Anchor link to this section for reference">&para;</a></h1> <p>本人没做过驱动，所有的驱动知识都是通过网上学习或者RTFSC，有讲错之处请指点。也望驱动大佬多多海涵。 ASHMEM_DEVICE其实就是抽象的共享内存设备，它是一个杂项设备（字符设备的一种），在驱动加载之后，就会在/dev下穿件ashem文件，之后用户就能够访问该设备文件，同一般的设备文件不同，它仅仅是通过内存抽象的，同普通的磁盘设备文件、串行端口字段设备文件不一样：</p> <blockquote> <p>aospxref网站没有收录kernel代码，googlesource需要自行科学上网。 <a href=https://android.googlesource.com/kernel>https://android.googlesource.com/kernel</a></p> </blockquote> <h2 id=ashmem_init>初始化（ashmem_init）<a class=headerlink href=#ashmem_init title="Anchor link to this section for reference">&para;</a></h2> <div class=highlight><pre><span></span><code><a id=__codelineno-38-1 name=__codelineno-38-1></a><a href=#__codelineno-38-1><span class=linenos data-linenos=" 1 "></span></a><span class=nl>https</span><span class=p>:</span><span class=c1>//android.googlesource.com/kernel/common/+/refs/tags/5.4-android11-0/drivers/staging/android/ashmem.c</span>
<a id=__codelineno-38-2 name=__codelineno-38-2></a><a href=#__codelineno-38-2><span class=linenos data-linenos=" 2 "></span></a>
<a id=__codelineno-38-3 name=__codelineno-38-3></a><a href=#__codelineno-38-3><span class=linenos data-linenos=" 3 "></span></a><span class=k>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>__init</span><span class=w> </span><span class=nf>ashmem_init</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=w></span>
<a id=__codelineno-38-4 name=__codelineno-38-4></a><a href=#__codelineno-38-4><span class=linenos data-linenos=" 4 "></span></a><span class=p>{</span><span class=w></span>
<a id=__codelineno-38-5 name=__codelineno-38-5></a><a href=#__codelineno-38-5><span class=linenos data-linenos=" 5 "></span></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>-</span><span class=n>ENOMEM</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-38-6 name=__codelineno-38-6></a><a href=#__codelineno-38-6><span class=linenos data-linenos=" 6 "></span></a>
<a id=__codelineno-38-7 name=__codelineno-38-7></a><a href=#__codelineno-38-7><span class=linenos data-linenos=" 7 "></span></a><span class=w>    </span><span class=n>ashmem_area_cachep</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>kmem_cache_create</span><span class=p>(</span><span class=s>&quot;ashmem_area_cache&quot;</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-38-8 name=__codelineno-38-8></a><a href=#__codelineno-38-8><span class=linenos data-linenos=" 8 "></span></a><span class=w>                           </span><span class=k>sizeof</span><span class=p>(</span><span class=k>struct</span><span class=w> </span><span class=nc>ashmem_area</span><span class=p>),</span><span class=w></span>
<a id=__codelineno-38-9 name=__codelineno-38-9></a><a href=#__codelineno-38-9><span class=linenos data-linenos=" 9 "></span></a><span class=w>                           </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=nb>NULL</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-38-10 name=__codelineno-38-10></a><a href=#__codelineno-38-10><span class=linenos data-linenos="10 "></span></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>ashmem_area_cachep</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-38-11 name=__codelineno-38-11></a><a href=#__codelineno-38-11><span class=linenos data-linenos="11 "></span></a><span class=w>        </span><span class=n>pr_err</span><span class=p>(</span><span class=s>&quot;failed to create slab cache</span><span class=se>\n</span><span class=s>&quot;</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-38-12 name=__codelineno-38-12></a><a href=#__codelineno-38-12><span class=linenos data-linenos="12 "></span></a><span class=w>        </span><span class=k>goto</span><span class=w> </span><span class=n>out</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-38-13 name=__codelineno-38-13></a><a href=#__codelineno-38-13><span class=linenos data-linenos="13 "></span></a><span class=w>    </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-38-14 name=__codelineno-38-14></a><a href=#__codelineno-38-14><span class=linenos data-linenos="14 "></span></a>
<a id=__codelineno-38-15 name=__codelineno-38-15></a><a href=#__codelineno-38-15><span class=linenos data-linenos="15 "></span></a><span class=w>    </span><span class=n>ashmem_range_cachep</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>kmem_cache_create</span><span class=p>(</span><span class=s>&quot;ashmem_range_cache&quot;</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-38-16 name=__codelineno-38-16></a><a href=#__codelineno-38-16><span class=linenos data-linenos="16 "></span></a><span class=w>                        </span><span class=k>sizeof</span><span class=p>(</span><span class=k>struct</span><span class=w> </span><span class=nc>ashmem_range</span><span class=p>),</span><span class=w></span>
<a id=__codelineno-38-17 name=__codelineno-38-17></a><a href=#__codelineno-38-17><span class=linenos data-linenos="17 "></span></a><span class=w>                        </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=nb>NULL</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-38-18 name=__codelineno-38-18></a><a href=#__codelineno-38-18><span class=linenos data-linenos="18 "></span></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>ashmem_range_cachep</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-38-19 name=__codelineno-38-19></a><a href=#__codelineno-38-19><span class=linenos data-linenos="19 "></span></a><span class=w>        </span><span class=n>pr_err</span><span class=p>(</span><span class=s>&quot;failed to create slab cache</span><span class=se>\n</span><span class=s>&quot;</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-38-20 name=__codelineno-38-20></a><a href=#__codelineno-38-20><span class=linenos data-linenos="20 "></span></a><span class=w>        </span><span class=k>goto</span><span class=w> </span><span class=n>out_free1</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-38-21 name=__codelineno-38-21></a><a href=#__codelineno-38-21><span class=linenos data-linenos="21 "></span></a><span class=w>    </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-38-22 name=__codelineno-38-22></a><a href=#__codelineno-38-22><span class=linenos data-linenos="22 "></span></a>
<a id=__codelineno-38-23 name=__codelineno-38-23></a><a href=#__codelineno-38-23><span class=linenos data-linenos="23 "></span></a><span class=w>    </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>misc_register</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ashmem_misc</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-38-24 name=__codelineno-38-24></a><a href=#__codelineno-38-24><span class=linenos data-linenos="24 "></span></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ret</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-38-25 name=__codelineno-38-25></a><a href=#__codelineno-38-25><span class=linenos data-linenos="25 "></span></a><span class=w>        </span><span class=n>pr_err</span><span class=p>(</span><span class=s>&quot;failed to register misc device!</span><span class=se>\n</span><span class=s>&quot;</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-38-26 name=__codelineno-38-26></a><a href=#__codelineno-38-26><span class=linenos data-linenos="26 "></span></a><span class=w>        </span><span class=k>goto</span><span class=w> </span><span class=n>out_free2</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-38-27 name=__codelineno-38-27></a><a href=#__codelineno-38-27><span class=linenos data-linenos="27 "></span></a><span class=w>    </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-38-28 name=__codelineno-38-28></a><a href=#__codelineno-38-28><span class=linenos data-linenos="28 "></span></a>
<a id=__codelineno-38-29 name=__codelineno-38-29></a><a href=#__codelineno-38-29><span class=linenos data-linenos="29 "></span></a><span class=w>    </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>register_shrinker</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ashmem_shrinker</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-38-30 name=__codelineno-38-30></a><a href=#__codelineno-38-30><span class=linenos data-linenos="30 "></span></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ret</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-38-31 name=__codelineno-38-31></a><a href=#__codelineno-38-31><span class=linenos data-linenos="31 "></span></a><span class=w>        </span><span class=n>pr_err</span><span class=p>(</span><span class=s>&quot;failed to register shrinker!</span><span class=se>\n</span><span class=s>&quot;</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-38-32 name=__codelineno-38-32></a><a href=#__codelineno-38-32><span class=linenos data-linenos="32 "></span></a><span class=w>        </span><span class=k>goto</span><span class=w> </span><span class=n>out_demisc</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-38-33 name=__codelineno-38-33></a><a href=#__codelineno-38-33><span class=linenos data-linenos="33 "></span></a><span class=w>    </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-38-34 name=__codelineno-38-34></a><a href=#__codelineno-38-34><span class=linenos data-linenos="34 "></span></a>
<a id=__codelineno-38-35 name=__codelineno-38-35></a><a href=#__codelineno-38-35><span class=linenos data-linenos="35 "></span></a><span class=w>    </span><span class=n>pr_info</span><span class=p>(</span><span class=s>&quot;initialized</span><span class=se>\n</span><span class=s>&quot;</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-38-36 name=__codelineno-38-36></a><a href=#__codelineno-38-36><span class=linenos data-linenos="36 "></span></a>
<a id=__codelineno-38-37 name=__codelineno-38-37></a><a href=#__codelineno-38-37><span class=linenos data-linenos="37 "></span></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-38-38 name=__codelineno-38-38></a><a href=#__codelineno-38-38><span class=linenos data-linenos="38 "></span></a>
<a id=__codelineno-38-39 name=__codelineno-38-39></a><a href=#__codelineno-38-39><span class=linenos data-linenos="39 "></span></a><span class=nl>out_demisc</span><span class=p>:</span><span class=w></span>
<a id=__codelineno-38-40 name=__codelineno-38-40></a><a href=#__codelineno-38-40><span class=linenos data-linenos="40 "></span></a><span class=w>    </span><span class=n>misc_deregister</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ashmem_misc</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-38-41 name=__codelineno-38-41></a><a href=#__codelineno-38-41><span class=linenos data-linenos="41 "></span></a><span class=nl>out_free2</span><span class=p>:</span><span class=w></span>
<a id=__codelineno-38-42 name=__codelineno-38-42></a><a href=#__codelineno-38-42><span class=linenos data-linenos="42 "></span></a><span class=w>    </span><span class=n>kmem_cache_destroy</span><span class=p>(</span><span class=n>ashmem_range_cachep</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-38-43 name=__codelineno-38-43></a><a href=#__codelineno-38-43><span class=linenos data-linenos="43 "></span></a><span class=nl>out_free1</span><span class=p>:</span><span class=w></span>
<a id=__codelineno-38-44 name=__codelineno-38-44></a><a href=#__codelineno-38-44><span class=linenos data-linenos="44 "></span></a><span class=w>    </span><span class=n>kmem_cache_destroy</span><span class=p>(</span><span class=n>ashmem_area_cachep</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-38-45 name=__codelineno-38-45></a><a href=#__codelineno-38-45><span class=linenos data-linenos="45 "></span></a><span class=nl>out</span><span class=p>:</span><span class=w></span>
<a id=__codelineno-38-46 name=__codelineno-38-46></a><a href=#__codelineno-38-46><span class=linenos data-linenos="46 "></span></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>ret</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-38-47 name=__codelineno-38-47></a><a href=#__codelineno-38-47><span class=linenos data-linenos="47 "></span></a><span class=p>}</span><span class=w></span>
<a id=__codelineno-38-48 name=__codelineno-38-48></a><a href=#__codelineno-38-48><span class=linenos data-linenos="48 "></span></a>
<a id=__codelineno-38-49 name=__codelineno-38-49></a><a href=#__codelineno-38-49><span class=linenos data-linenos="49 "></span></a><span class=n>device_initcall</span><span class=p>(</span><span class=n>ashmem_init</span><span class=p>);</span><span class=w></span>
</code></pre></div> <ul> <li>在slab高速缓存开辟了ashmem_area</li> <li>ashmem_range两个结构体的cache</li> <li>通过register_shrinker向内存管理系统注册Ashmem回收函数<blockquote> <p>如果Linux内存管理slab是什么可以浏览以下文章：</p> </blockquote> </li> </ul> <blockquote> <p><a href=https://zhuanlan.zhihu.com/p/105582468>Linux中的Slab</a> <a href=https://blog.csdn.net/rockrockwu/article/details/79976833>Linux内存管理之SLAB原理浅析</a></p> </blockquote> <h2 id=file_operations>file_operations<a class=headerlink href=#file_operations title="Anchor link to this section for reference">&para;</a></h2> <p><div class=highlight><pre><span></span><code><a id=__codelineno-39-1 name=__codelineno-39-1></a><a href=#__codelineno-39-1><span class=linenos data-linenos=" 1 "></span></a><span class=nl>https</span><span class=p>:</span><span class=c1>//android.googlesource.com/kernel/common/+/refs/tags/5.4-android11-0/drivers/staging/android/ashmem.c</span>
<a id=__codelineno-39-2 name=__codelineno-39-2></a><a href=#__codelineno-39-2><span class=linenos data-linenos=" 2 "></span></a>
<a id=__codelineno-39-3 name=__codelineno-39-3></a><a href=#__codelineno-39-3><span class=linenos data-linenos=" 3 "></span></a><span class=k>static</span><span class=w> </span><span class=k>struct</span><span class=w> </span><span class=nc>miscdevice</span><span class=w> </span><span class=n>ashmem_misc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-39-4 name=__codelineno-39-4></a><a href=#__codelineno-39-4><span class=linenos data-linenos=" 4 "></span></a><span class=w>    </span><span class=p>.</span><span class=n>minor</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MISC_DYNAMIC_MINOR</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-39-5 name=__codelineno-39-5></a><a href=#__codelineno-39-5><span class=linenos data-linenos=" 5 "></span></a><span class=w>    </span><span class=p>.</span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;ashmem&quot;</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-39-6 name=__codelineno-39-6></a><a href=#__codelineno-39-6><span class=linenos data-linenos=" 6 "></span></a><span class=w>    </span><span class=p>.</span><span class=n>fops</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&amp;</span><span class=n>ashmem_fops</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-39-7 name=__codelineno-39-7></a><a href=#__codelineno-39-7><span class=linenos data-linenos=" 7 "></span></a><span class=p>};</span><span class=w></span>
<a id=__codelineno-39-8 name=__codelineno-39-8></a><a href=#__codelineno-39-8><span class=linenos data-linenos=" 8 "></span></a>
<a id=__codelineno-39-9 name=__codelineno-39-9></a><a href=#__codelineno-39-9><span class=linenos data-linenos=" 9 "></span></a><span class=k>static</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=k>struct</span><span class=w> </span><span class=nc>file_operations</span><span class=w> </span><span class=n>ashmem_fops</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-39-10 name=__codelineno-39-10></a><a href=#__codelineno-39-10><span class=linenos data-linenos="10 "></span></a><span class=w>    </span><span class=p>.</span><span class=n>owner</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>THIS_MODULE</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-39-11 name=__codelineno-39-11></a><a href=#__codelineno-39-11><span class=linenos data-linenos="11 "></span></a><span class=w>    </span><span class=p>.</span><span class=n>open</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ashmem_open</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-39-12 name=__codelineno-39-12></a><a href=#__codelineno-39-12><span class=linenos data-linenos="12 "></span></a><span class=w>    </span><span class=p>.</span><span class=n>release</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ashmem_release</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-39-13 name=__codelineno-39-13></a><a href=#__codelineno-39-13><span class=linenos data-linenos="13 "></span></a><span class=w>    </span><span class=p>.</span><span class=n>read_iter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ashmem_read_iter</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-39-14 name=__codelineno-39-14></a><a href=#__codelineno-39-14><span class=linenos data-linenos="14 "></span></a><span class=w>    </span><span class=p>.</span><span class=n>llseek</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ashmem_llseek</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-39-15 name=__codelineno-39-15></a><a href=#__codelineno-39-15><span class=linenos data-linenos="15 "></span></a><span class=w>    </span><span class=p>.</span><span class=n>mmap</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ashmem_mmap</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-39-16 name=__codelineno-39-16></a><a href=#__codelineno-39-16><span class=linenos data-linenos="16 "></span></a><span class=w>    </span><span class=p>.</span><span class=n>unlocked_ioctl</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ashmem_ioctl</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-39-17 name=__codelineno-39-17></a><a href=#__codelineno-39-17><span class=linenos data-linenos="17 "></span></a><span class=cp>#ifdef CONFIG_COMPAT</span>
<a id=__codelineno-39-18 name=__codelineno-39-18></a><a href=#__codelineno-39-18><span class=linenos data-linenos="18 "></span></a><span class=w>    </span><span class=p>.</span><span class=n>compat_ioctl</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>compat_ashmem_ioctl</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-39-19 name=__codelineno-39-19></a><a href=#__codelineno-39-19><span class=linenos data-linenos="19 "></span></a><span class=cp>#endif</span>
<a id=__codelineno-39-20 name=__codelineno-39-20></a><a href=#__codelineno-39-20><span class=linenos data-linenos="20 "></span></a><span class=cp>#ifdef CONFIG_PROC_FS</span>
<a id=__codelineno-39-21 name=__codelineno-39-21></a><a href=#__codelineno-39-21><span class=linenos data-linenos="21 "></span></a><span class=w>    </span><span class=p>.</span><span class=n>show_fdinfo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ashmem_show_fdinfo</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-39-22 name=__codelineno-39-22></a><a href=#__codelineno-39-22><span class=linenos data-linenos="22 "></span></a><span class=cp>#endif</span>
<a id=__codelineno-39-23 name=__codelineno-39-23></a><a href=#__codelineno-39-23><span class=linenos data-linenos="23 "></span></a><span class=p>};</span><span class=w></span>
</code></pre></div> 结构体file_operations在头文件 linux/fs.h中定义，用来存储驱动内核模块提供的对设备进行各种操作的函数的指针。 能看到里面有open，read_iter，mmap，unlocked_ioctl这四个核心的方法。</p> <h2 id=ashmem_open>ashmem_open<a class=headerlink href=#ashmem_open title="Anchor link to this section for reference">&para;</a></h2> <p><div class=highlight><pre><span></span><code><a id=__codelineno-40-1 name=__codelineno-40-1></a><a href=#__codelineno-40-1><span class=linenos data-linenos=" 1 "></span></a><span class=nl>https</span><span class=p>:</span><span class=c1>//android.googlesource.com/kernel/common/+/refs/tags/5.4-android11-0/drivers/staging/android/ashmem.c</span>
<a id=__codelineno-40-2 name=__codelineno-40-2></a><a href=#__codelineno-40-2><span class=linenos data-linenos=" 2 "></span></a>
<a id=__codelineno-40-3 name=__codelineno-40-3></a><a href=#__codelineno-40-3><span class=linenos data-linenos=" 3 "></span></a><span class=k>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>ashmem_open</span><span class=p>(</span><span class=k>struct</span><span class=w> </span><span class=nc>inode</span><span class=w> </span><span class=o>*</span><span class=n>inode</span><span class=p>,</span><span class=w> </span><span class=k>struct</span><span class=w> </span><span class=nc>file</span><span class=w> </span><span class=o>*</span><span class=n>file</span><span class=p>)</span><span class=w></span>
<a id=__codelineno-40-4 name=__codelineno-40-4></a><a href=#__codelineno-40-4><span class=linenos data-linenos=" 4 "></span></a><span class=p>{</span><span class=w></span>
<a id=__codelineno-40-5 name=__codelineno-40-5></a><a href=#__codelineno-40-5><span class=linenos data-linenos=" 5 "></span></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>ashmem_area</span><span class=w> </span><span class=o>*</span><span class=n>asma</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-40-6 name=__codelineno-40-6></a><a href=#__codelineno-40-6><span class=linenos data-linenos=" 6 "></span></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>ret</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-40-7 name=__codelineno-40-7></a><a href=#__codelineno-40-7><span class=linenos data-linenos=" 7 "></span></a>
<a id=__codelineno-40-8 name=__codelineno-40-8></a><a href=#__codelineno-40-8><span class=linenos data-linenos=" 8 "></span></a><span class=w>    </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>generic_file_open</span><span class=p>(</span><span class=n>inode</span><span class=p>,</span><span class=w> </span><span class=n>file</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-40-9 name=__codelineno-40-9></a><a href=#__codelineno-40-9><span class=linenos data-linenos=" 9 "></span></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ret</span><span class=p>)</span><span class=w></span>
<a id=__codelineno-40-10 name=__codelineno-40-10></a><a href=#__codelineno-40-10><span class=linenos data-linenos="10 "></span></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ret</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-40-11 name=__codelineno-40-11></a><a href=#__codelineno-40-11><span class=linenos data-linenos="11 "></span></a>
<a id=__codelineno-40-12 name=__codelineno-40-12></a><a href=#__codelineno-40-12><span class=linenos data-linenos="12 "></span></a><span class=w>    </span><span class=n>asma</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>kmem_cache_zalloc</span><span class=p>(</span><span class=n>ashmem_area_cachep</span><span class=p>,</span><span class=w> </span><span class=n>GFP_KERNEL</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-40-13 name=__codelineno-40-13></a><a href=#__codelineno-40-13><span class=linenos data-linenos="13 "></span></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>asma</span><span class=p>)</span><span class=w></span>
<a id=__codelineno-40-14 name=__codelineno-40-14></a><a href=#__codelineno-40-14><span class=linenos data-linenos="14 "></span></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=o>-</span><span class=n>ENOMEM</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-40-15 name=__codelineno-40-15></a><a href=#__codelineno-40-15><span class=linenos data-linenos="15 "></span></a>
<a id=__codelineno-40-16 name=__codelineno-40-16></a><a href=#__codelineno-40-16><span class=linenos data-linenos="16 "></span></a><span class=w>    </span><span class=n>INIT_LIST_HEAD</span><span class=p>(</span><span class=o>&amp;</span><span class=n>asma</span><span class=o>-&gt;</span><span class=n>unpinned_list</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-40-17 name=__codelineno-40-17></a><a href=#__codelineno-40-17><span class=linenos data-linenos="17 "></span></a><span class=w>    </span><span class=n>memcpy</span><span class=p>(</span><span class=n>asma</span><span class=o>-&gt;</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>ASHMEM_NAME_PREFIX</span><span class=p>,</span><span class=w> </span><span class=n>ASHMEM_NAME_PREFIX_LEN</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-40-18 name=__codelineno-40-18></a><a href=#__codelineno-40-18><span class=linenos data-linenos="18 "></span></a><span class=w>    </span><span class=n>asma</span><span class=o>-&gt;</span><span class=n>prot_mask</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>PROT_MASK</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-40-19 name=__codelineno-40-19></a><a href=#__codelineno-40-19><span class=linenos data-linenos="19 "></span></a><span class=w>    </span><span class=n>file</span><span class=o>-&gt;</span><span class=n>private_data</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>asma</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-40-20 name=__codelineno-40-20></a><a href=#__codelineno-40-20><span class=linenos data-linenos="20 "></span></a>
<a id=__codelineno-40-21 name=__codelineno-40-21></a><a href=#__codelineno-40-21><span class=linenos data-linenos="21 "></span></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-40-22 name=__codelineno-40-22></a><a href=#__codelineno-40-22><span class=linenos data-linenos="22 "></span></a><span class=p>}</span><span class=w></span>
</code></pre></div> open函数很普通，创建一块ashmem共享内存时，其实是在内核层打开了一个ashmem file，而且这个file的private_data里记录了一块ashmem_area。</p> <h2 id=ashmem_ioctl>ashmem_ioctl<a class=headerlink href=#ashmem_ioctl title="Anchor link to this section for reference">&para;</a></h2> <p>ashmem_open()之后，紧接着要设置刚打开的共享内存文件的一些属性，于是调用到ioctl()对应的ashmem_ioctl()。主要的设置动作其实就是向ashmem_area里写入一些数据。ashmem_ioctl()函数的定义如下： <div class=highlight><pre><span></span><code><a id=__codelineno-41-1 name=__codelineno-41-1></a><a href=#__codelineno-41-1><span class=linenos data-linenos=" 1 "></span></a><span class=nl>https</span><span class=p>:</span><span class=c1>//android.googlesource.com/kernel/common/+/refs/tags/5.4-android11-0/drivers/staging/android/ashmem.c</span>
<a id=__codelineno-41-2 name=__codelineno-41-2></a><a href=#__codelineno-41-2><span class=linenos data-linenos=" 2 "></span></a>
<a id=__codelineno-41-3 name=__codelineno-41-3></a><a href=#__codelineno-41-3><span class=linenos data-linenos=" 3 "></span></a><span class=k>static</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=nf>ashmem_ioctl</span><span class=p>(</span><span class=k>struct</span><span class=w> </span><span class=nc>file</span><span class=w> </span><span class=o>*</span><span class=n>file</span><span class=p>,</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>cmd</span><span class=p>,</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>arg</span><span class=p>)</span><span class=w></span>
<a id=__codelineno-41-4 name=__codelineno-41-4></a><a href=#__codelineno-41-4><span class=linenos data-linenos=" 4 "></span></a><span class=p>{</span><span class=w></span>
<a id=__codelineno-41-5 name=__codelineno-41-5></a><a href=#__codelineno-41-5><span class=linenos data-linenos=" 5 "></span></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>ashmem_area</span><span class=w> </span><span class=o>*</span><span class=n>asma</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>file</span><span class=o>-&gt;</span><span class=n>private_data</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-41-6 name=__codelineno-41-6></a><a href=#__codelineno-41-6><span class=linenos data-linenos=" 6 "></span></a><span class=w>    </span><span class=kt>long</span><span class=w> </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>-</span><span class=n>ENOTTY</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-41-7 name=__codelineno-41-7></a><a href=#__codelineno-41-7><span class=linenos data-linenos=" 7 "></span></a>
<a id=__codelineno-41-8 name=__codelineno-41-8></a><a href=#__codelineno-41-8><span class=linenos data-linenos=" 8 "></span></a><span class=w>    </span><span class=k>switch</span><span class=w> </span><span class=p>(</span><span class=n>cmd</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-41-9 name=__codelineno-41-9></a><a href=#__codelineno-41-9><span class=linenos data-linenos=" 9 "></span></a><span class=w>    </span><span class=p>...</span><span class=w></span>
<a id=__codelineno-41-10 name=__codelineno-41-10></a><a href=#__codelineno-41-10><span class=linenos data-linenos="10 "></span></a><span class=w>    </span><span class=k>case</span><span class=w> </span><span class=nl>ASHMEM_SET_SIZE</span><span class=p>:</span><span class=w></span>
<a id=__codelineno-41-11 name=__codelineno-41-11></a><a href=#__codelineno-41-11><span class=linenos data-linenos="11 "></span></a><span class=w>        </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>-</span><span class=n>EINVAL</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-41-12 name=__codelineno-41-12></a><a href=#__codelineno-41-12><span class=linenos data-linenos="12 "></span></a><span class=w>        </span><span class=n>mutex_lock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ashmem_mutex</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-41-13 name=__codelineno-41-13></a><a href=#__codelineno-41-13><span class=linenos data-linenos="13 "></span></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>asma</span><span class=o>-&gt;</span><span class=n>file</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-41-14 name=__codelineno-41-14></a><a href=#__codelineno-41-14><span class=linenos data-linenos="14 "></span></a><span class=w>            </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-41-15 name=__codelineno-41-15></a><a href=#__codelineno-41-15><span class=linenos data-linenos="15 "></span></a><span class=w>            </span><span class=n>asma</span><span class=o>-&gt;</span><span class=n>size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=kt>size_t</span><span class=p>)</span><span class=n>arg</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-41-16 name=__codelineno-41-16></a><a href=#__codelineno-41-16><span class=linenos data-linenos="16 "></span></a><span class=w>        </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-41-17 name=__codelineno-41-17></a><a href=#__codelineno-41-17><span class=linenos data-linenos="17 "></span></a><span class=w>        </span><span class=n>mutex_unlock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ashmem_mutex</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-41-18 name=__codelineno-41-18></a><a href=#__codelineno-41-18><span class=linenos data-linenos="18 "></span></a><span class=w>        </span><span class=k>break</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-41-19 name=__codelineno-41-19></a><a href=#__codelineno-41-19><span class=linenos data-linenos="19 "></span></a><span class=w>    </span><span class=p>...</span><span class=w></span>
<a id=__codelineno-41-20 name=__codelineno-41-20></a><a href=#__codelineno-41-20><span class=linenos data-linenos="20 "></span></a><span class=w>    </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-41-21 name=__codelineno-41-21></a><a href=#__codelineno-41-21><span class=linenos data-linenos="21 "></span></a>
<a id=__codelineno-41-22 name=__codelineno-41-22></a><a href=#__codelineno-41-22><span class=linenos data-linenos="22 "></span></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>ret</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-41-23 name=__codelineno-41-23></a><a href=#__codelineno-41-23><span class=linenos data-linenos="23 "></span></a><span class=p>}</span><span class=w></span>
</code></pre></div> 设置共享内存的大小。可以看到，其实并未真正的分配内存，这也符合Linux的风格，只有等到真正的使用的时候，才会通过缺页中断分配内存。</p> <h2 id=ashmem_mmap>ashmem_mmap<a class=headerlink href=#ashmem_mmap title="Anchor link to this section for reference">&para;</a></h2> <div class=highlight><pre><span></span><code><a id=__codelineno-42-1 name=__codelineno-42-1></a><a href=#__codelineno-42-1><span class=linenos data-linenos=" 1 "></span></a><span class=nl>https</span><span class=p>:</span><span class=c1>//android.googlesource.com/kernel/common/+/refs/tags/5.4-android11-0/drivers/staging/android/ashmem.c</span>
<a id=__codelineno-42-2 name=__codelineno-42-2></a><a href=#__codelineno-42-2><span class=linenos data-linenos=" 2 "></span></a>
<a id=__codelineno-42-3 name=__codelineno-42-3></a><a href=#__codelineno-42-3><span class=linenos data-linenos=" 3 "></span></a><span class=k>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=nf>ashmem_mmap</span><span class=p>(</span><span class=k>struct</span><span class=w> </span><span class=nc>file</span><span class=w> </span><span class=o>*</span><span class=n>file</span><span class=p>,</span><span class=w> </span><span class=k>struct</span><span class=w> </span><span class=nc>vm_area_struct</span><span class=w> </span><span class=o>*</span><span class=n>vma</span><span class=p>)</span><span class=w></span>
<a id=__codelineno-42-4 name=__codelineno-42-4></a><a href=#__codelineno-42-4><span class=linenos data-linenos=" 4 "></span></a><span class=p>{</span><span class=w></span>
<a id=__codelineno-42-5 name=__codelineno-42-5></a><a href=#__codelineno-42-5><span class=linenos data-linenos=" 5 "></span></a><span class=w>    </span><span class=k>static</span><span class=w> </span><span class=k>struct</span><span class=w> </span><span class=nc>file_operations</span><span class=w> </span><span class=n>vmfile_fops</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-42-6 name=__codelineno-42-6></a><a href=#__codelineno-42-6><span class=linenos data-linenos=" 6 "></span></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>ashmem_area</span><span class=w> </span><span class=o>*</span><span class=n>asma</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>file</span><span class=o>-&gt;</span><span class=n>private_data</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-42-7 name=__codelineno-42-7></a><a href=#__codelineno-42-7><span class=linenos data-linenos=" 7 "></span></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-42-8 name=__codelineno-42-8></a><a href=#__codelineno-42-8><span class=linenos data-linenos=" 8 "></span></a>
<a id=__codelineno-42-9 name=__codelineno-42-9></a><a href=#__codelineno-42-9><span class=linenos data-linenos=" 9 "></span></a><span class=w>    </span><span class=n>mutex_lock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ashmem_mutex</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-42-10 name=__codelineno-42-10></a><a href=#__codelineno-42-10><span class=linenos data-linenos="10 "></span></a>
<a id=__codelineno-42-11 name=__codelineno-42-11></a><a href=#__codelineno-42-11><span class=linenos data-linenos="11 "></span></a><span class=w>    </span><span class=cm>/* user needs to SET_SIZE before mapping */</span><span class=w></span>
<a id=__codelineno-42-12 name=__codelineno-42-12></a><a href=#__codelineno-42-12><span class=linenos data-linenos="12 "></span></a><span class=w>    </span><span class=c1>//1. 设置asma的size，不然会抛异常。</span>
<a id=__codelineno-42-13 name=__codelineno-42-13></a><a href=#__codelineno-42-13><span class=linenos data-linenos="13 "></span></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>asma</span><span class=o>-&gt;</span><span class=n>size</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-42-14 name=__codelineno-42-14></a><a href=#__codelineno-42-14><span class=linenos data-linenos="14 "></span></a><span class=w>        </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>-</span><span class=n>EINVAL</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-42-15 name=__codelineno-42-15></a><a href=#__codelineno-42-15><span class=linenos data-linenos="15 "></span></a><span class=w>        </span><span class=k>goto</span><span class=w> </span><span class=n>out</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-42-16 name=__codelineno-42-16></a><a href=#__codelineno-42-16><span class=linenos data-linenos="16 "></span></a><span class=w>    </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-42-17 name=__codelineno-42-17></a><a href=#__codelineno-42-17><span class=linenos data-linenos="17 "></span></a>
<a id=__codelineno-42-18 name=__codelineno-42-18></a><a href=#__codelineno-42-18><span class=linenos data-linenos="18 "></span></a><span class=w>    </span><span class=cm>/* requested mapping size larger than object size */</span><span class=w></span>
<a id=__codelineno-42-19 name=__codelineno-42-19></a><a href=#__codelineno-42-19><span class=linenos data-linenos="19 "></span></a><span class=w>    </span><span class=c1>//2. 检测需要映射的vma虚拟内存是否符合权限，否则抛异常。</span>
<a id=__codelineno-42-20 name=__codelineno-42-20></a><a href=#__codelineno-42-20><span class=linenos data-linenos="20 "></span></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>vma</span><span class=o>-&gt;</span><span class=n>vm_end</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>vma</span><span class=o>-&gt;</span><span class=n>vm_start</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>PAGE_ALIGN</span><span class=p>(</span><span class=n>asma</span><span class=o>-&gt;</span><span class=n>size</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-42-21 name=__codelineno-42-21></a><a href=#__codelineno-42-21><span class=linenos data-linenos="21 "></span></a><span class=w>        </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>-</span><span class=n>EINVAL</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-42-22 name=__codelineno-42-22></a><a href=#__codelineno-42-22><span class=linenos data-linenos="22 "></span></a><span class=w>        </span><span class=k>goto</span><span class=w> </span><span class=n>out</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-42-23 name=__codelineno-42-23></a><a href=#__codelineno-42-23><span class=linenos data-linenos="23 "></span></a><span class=w>    </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-42-24 name=__codelineno-42-24></a><a href=#__codelineno-42-24><span class=linenos data-linenos="24 "></span></a>
<a id=__codelineno-42-25 name=__codelineno-42-25></a><a href=#__codelineno-42-25><span class=linenos data-linenos="25 "></span></a><span class=w>    </span><span class=cm>/* requested protection bits must match our allowed protection mask */</span><span class=w></span>
<a id=__codelineno-42-26 name=__codelineno-42-26></a><a href=#__codelineno-42-26><span class=linenos data-linenos="26 "></span></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>((</span><span class=n>vma</span><span class=o>-&gt;</span><span class=n>vm_flags</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=o>~</span><span class=n>calc_vm_prot_bits</span><span class=p>(</span><span class=n>asma</span><span class=o>-&gt;</span><span class=n>prot_mask</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>))</span><span class=w> </span><span class=o>&amp;</span><span class=w></span>
<a id=__codelineno-42-27 name=__codelineno-42-27></a><a href=#__codelineno-42-27><span class=linenos data-linenos="27 "></span></a><span class=w>        </span><span class=n>calc_vm_prot_bits</span><span class=p>(</span><span class=n>PROT_MASK</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-42-28 name=__codelineno-42-28></a><a href=#__codelineno-42-28><span class=linenos data-linenos="28 "></span></a><span class=w>        </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>-</span><span class=n>EPERM</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-42-29 name=__codelineno-42-29></a><a href=#__codelineno-42-29><span class=linenos data-linenos="29 "></span></a><span class=w>        </span><span class=k>goto</span><span class=w> </span><span class=n>out</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-42-30 name=__codelineno-42-30></a><a href=#__codelineno-42-30><span class=linenos data-linenos="30 "></span></a><span class=w>    </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-42-31 name=__codelineno-42-31></a><a href=#__codelineno-42-31><span class=linenos data-linenos="31 "></span></a><span class=w>    </span><span class=n>vma</span><span class=o>-&gt;</span><span class=n>vm_flags</span><span class=w> </span><span class=o>&amp;=</span><span class=w> </span><span class=o>~</span><span class=n>calc_vm_may_flags</span><span class=p>(</span><span class=o>~</span><span class=n>asma</span><span class=o>-&gt;</span><span class=n>prot_mask</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-42-32 name=__codelineno-42-32></a><a href=#__codelineno-42-32><span class=linenos data-linenos="32 "></span></a>
<a id=__codelineno-42-33 name=__codelineno-42-33></a><a href=#__codelineno-42-33><span class=linenos data-linenos="33 "></span></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>asma</span><span class=o>-&gt;</span><span class=n>file</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-42-34 name=__codelineno-42-34></a><a href=#__codelineno-42-34><span class=linenos data-linenos="34 "></span></a><span class=w>        </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ASHMEM_NAME_DEF</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-42-35 name=__codelineno-42-35></a><a href=#__codelineno-42-35><span class=linenos data-linenos="35 "></span></a><span class=w>        </span><span class=k>struct</span><span class=w> </span><span class=nc>file</span><span class=w> </span><span class=o>*</span><span class=n>vmfile</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-42-36 name=__codelineno-42-36></a><a href=#__codelineno-42-36><span class=linenos data-linenos="36 "></span></a><span class=w>        </span><span class=k>struct</span><span class=w> </span><span class=nc>inode</span><span class=w> </span><span class=o>*</span><span class=n>inode</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-42-37 name=__codelineno-42-37></a><a href=#__codelineno-42-37><span class=linenos data-linenos="37 "></span></a>
<a id=__codelineno-42-38 name=__codelineno-42-38></a><a href=#__codelineno-42-38><span class=linenos data-linenos="38 "></span></a><span class=w>        </span><span class=c1>//3. 检查asma中的file文件结构体是否创建</span>
<a id=__codelineno-42-39 name=__codelineno-42-39></a><a href=#__codelineno-42-39><span class=linenos data-linenos="39 "></span></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>asma</span><span class=o>-&gt;</span><span class=n>name</span><span class=p>[</span><span class=n>ASHMEM_NAME_PREFIX_LEN</span><span class=p>]</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=sc>&#39;\0&#39;</span><span class=p>)</span><span class=w></span>
<a id=__codelineno-42-40 name=__codelineno-42-40></a><a href=#__codelineno-42-40><span class=linenos data-linenos="40 "></span></a><span class=w>            </span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>asma</span><span class=o>-&gt;</span><span class=n>name</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-42-41 name=__codelineno-42-41></a><a href=#__codelineno-42-41><span class=linenos data-linenos="41 "></span></a>
<a id=__codelineno-42-42 name=__codelineno-42-42></a><a href=#__codelineno-42-42><span class=linenos data-linenos="42 "></span></a><span class=w>        </span><span class=cm>/* ... and allocate the backing shmem file */</span><span class=w></span>
<a id=__codelineno-42-43 name=__codelineno-42-43></a><a href=#__codelineno-42-43><span class=linenos data-linenos="43 "></span></a><span class=w>        </span><span class=c1>//4. </span>
<a id=__codelineno-42-44 name=__codelineno-42-44></a><a href=#__codelineno-42-44><span class=linenos data-linenos="44 "></span></a><span class=w>        </span><span class=n>vmfile</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>shmem_file_setup</span><span class=p>(</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>asma</span><span class=o>-&gt;</span><span class=n>size</span><span class=p>,</span><span class=w> </span><span class=n>vma</span><span class=o>-&gt;</span><span class=n>vm_flags</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-42-45 name=__codelineno-42-45></a><a href=#__codelineno-42-45><span class=linenos data-linenos="45 "></span></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>IS_ERR</span><span class=p>(</span><span class=n>vmfile</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-42-46 name=__codelineno-42-46></a><a href=#__codelineno-42-46><span class=linenos data-linenos="46 "></span></a><span class=w>            </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>PTR_ERR</span><span class=p>(</span><span class=n>vmfile</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-42-47 name=__codelineno-42-47></a><a href=#__codelineno-42-47><span class=linenos data-linenos="47 "></span></a><span class=w>            </span><span class=k>goto</span><span class=w> </span><span class=n>out</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-42-48 name=__codelineno-42-48></a><a href=#__codelineno-42-48><span class=linenos data-linenos="48 "></span></a><span class=w>        </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-42-49 name=__codelineno-42-49></a><a href=#__codelineno-42-49><span class=linenos data-linenos="49 "></span></a><span class=w>        </span><span class=n>vmfile</span><span class=o>-&gt;</span><span class=n>f_mode</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>FMODE_LSEEK</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-42-50 name=__codelineno-42-50></a><a href=#__codelineno-42-50><span class=linenos data-linenos="50 "></span></a><span class=w>        </span><span class=n>inode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>file_inode</span><span class=p>(</span><span class=n>vmfile</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-42-51 name=__codelineno-42-51></a><a href=#__codelineno-42-51><span class=linenos data-linenos="51 "></span></a><span class=w>        </span><span class=n>lockdep_set_class</span><span class=p>(</span><span class=o>&amp;</span><span class=n>inode</span><span class=o>-&gt;</span><span class=n>i_rwsem</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>backing_shmem_inode_class</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-42-52 name=__codelineno-42-52></a><a href=#__codelineno-42-52><span class=linenos data-linenos="52 "></span></a><span class=w>        </span><span class=n>asma</span><span class=o>-&gt;</span><span class=n>file</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>vmfile</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-42-53 name=__codelineno-42-53></a><a href=#__codelineno-42-53><span class=linenos data-linenos="53 "></span></a><span class=w>        </span><span class=cm>/*</span>
<a id=__codelineno-42-54 name=__codelineno-42-54></a><a href=#__codelineno-42-54><span class=linenos data-linenos="54 "></span></a><span class=cm>         * override mmap operation of the vmfile so that it can&#39;t be</span>
<a id=__codelineno-42-55 name=__codelineno-42-55></a><a href=#__codelineno-42-55><span class=linenos data-linenos="55 "></span></a><span class=cm>         * remapped which would lead to creation of a new vma with no</span>
<a id=__codelineno-42-56 name=__codelineno-42-56></a><a href=#__codelineno-42-56><span class=linenos data-linenos="56 "></span></a><span class=cm>         * asma permission checks. Have to override get_unmapped_area</span>
<a id=__codelineno-42-57 name=__codelineno-42-57></a><a href=#__codelineno-42-57><span class=linenos data-linenos="57 "></span></a><span class=cm>         * as well to prevent VM_BUG_ON check for f_ops modification.</span>
<a id=__codelineno-42-58 name=__codelineno-42-58></a><a href=#__codelineno-42-58><span class=linenos data-linenos="58 "></span></a><span class=cm>         */</span><span class=w></span>
<a id=__codelineno-42-59 name=__codelineno-42-59></a><a href=#__codelineno-42-59><span class=linenos data-linenos="59 "></span></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>vmfile_fops</span><span class=p>.</span><span class=n>mmap</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-42-60 name=__codelineno-42-60></a><a href=#__codelineno-42-60><span class=linenos data-linenos="60 "></span></a><span class=w>            </span><span class=n>vmfile_fops</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>*</span><span class=n>vmfile</span><span class=o>-&gt;</span><span class=n>f_op</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-42-61 name=__codelineno-42-61></a><a href=#__codelineno-42-61><span class=linenos data-linenos="61 "></span></a><span class=w>            </span><span class=n>vmfile_fops</span><span class=p>.</span><span class=n>mmap</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ashmem_vmfile_mmap</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-42-62 name=__codelineno-42-62></a><a href=#__codelineno-42-62><span class=linenos data-linenos="62 "></span></a><span class=w>            </span><span class=n>vmfile_fops</span><span class=p>.</span><span class=n>get_unmapped_area</span><span class=w> </span><span class=o>=</span><span class=w></span>
<a id=__codelineno-42-63 name=__codelineno-42-63></a><a href=#__codelineno-42-63><span class=linenos data-linenos="63 "></span></a><span class=w>                    </span><span class=n>ashmem_vmfile_get_unmapped_area</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-42-64 name=__codelineno-42-64></a><a href=#__codelineno-42-64><span class=linenos data-linenos="64 "></span></a><span class=w>        </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-42-65 name=__codelineno-42-65></a><a href=#__codelineno-42-65><span class=linenos data-linenos="65 "></span></a><span class=w>        </span><span class=n>vmfile</span><span class=o>-&gt;</span><span class=n>f_op</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&amp;</span><span class=n>vmfile_fops</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-42-66 name=__codelineno-42-66></a><a href=#__codelineno-42-66><span class=linenos data-linenos="66 "></span></a><span class=w>    </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-42-67 name=__codelineno-42-67></a><a href=#__codelineno-42-67><span class=linenos data-linenos="67 "></span></a><span class=w>    </span><span class=n>get_file</span><span class=p>(</span><span class=n>asma</span><span class=o>-&gt;</span><span class=n>file</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-42-68 name=__codelineno-42-68></a><a href=#__codelineno-42-68><span class=linenos data-linenos="68 "></span></a>
<a id=__codelineno-42-69 name=__codelineno-42-69></a><a href=#__codelineno-42-69><span class=linenos data-linenos="69 "></span></a><span class=w>    </span><span class=cm>/*</span>
<a id=__codelineno-42-70 name=__codelineno-42-70></a><a href=#__codelineno-42-70><span class=linenos data-linenos="70 "></span></a><span class=cm>     * XXX - Reworked to use shmem_zero_setup() instead of</span>
<a id=__codelineno-42-71 name=__codelineno-42-71></a><a href=#__codelineno-42-71><span class=linenos data-linenos="71 "></span></a><span class=cm>     * shmem_set_file while we&#39;re in staging. -jstultz</span>
<a id=__codelineno-42-72 name=__codelineno-42-72></a><a href=#__codelineno-42-72><span class=linenos data-linenos="72 "></span></a><span class=cm>     */</span><span class=w></span>
<a id=__codelineno-42-73 name=__codelineno-42-73></a><a href=#__codelineno-42-73><span class=linenos data-linenos="73 "></span></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>vma</span><span class=o>-&gt;</span><span class=n>vm_flags</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>VM_SHARED</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-42-74 name=__codelineno-42-74></a><a href=#__codelineno-42-74><span class=linenos data-linenos="74 "></span></a><span class=w>        </span><span class=c1>//5. 检查如果当前的vma虚拟内存允许共享则调用shmem_zero_setup映射文件</span>
<a id=__codelineno-42-75 name=__codelineno-42-75></a><a href=#__codelineno-42-75><span class=linenos data-linenos="75 "></span></a><span class=w>        </span><span class=n>ret</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>shmem_zero_setup</span><span class=p>(</span><span class=n>vma</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-42-76 name=__codelineno-42-76></a><a href=#__codelineno-42-76><span class=linenos data-linenos="76 "></span></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ret</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-42-77 name=__codelineno-42-77></a><a href=#__codelineno-42-77><span class=linenos data-linenos="77 "></span></a><span class=w>            </span><span class=n>fput</span><span class=p>(</span><span class=n>asma</span><span class=o>-&gt;</span><span class=n>file</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-42-78 name=__codelineno-42-78></a><a href=#__codelineno-42-78><span class=linenos data-linenos="78 "></span></a><span class=w>            </span><span class=k>goto</span><span class=w> </span><span class=n>out</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-42-79 name=__codelineno-42-79></a><a href=#__codelineno-42-79><span class=linenos data-linenos="79 "></span></a><span class=w>        </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-42-80 name=__codelineno-42-80></a><a href=#__codelineno-42-80><span class=linenos data-linenos="80 "></span></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-42-81 name=__codelineno-42-81></a><a href=#__codelineno-42-81><span class=linenos data-linenos="81 "></span></a><span class=w>        </span><span class=n>vma_set_anonymous</span><span class=p>(</span><span class=n>vma</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-42-82 name=__codelineno-42-82></a><a href=#__codelineno-42-82><span class=linenos data-linenos="82 "></span></a><span class=w>    </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-42-83 name=__codelineno-42-83></a><a href=#__codelineno-42-83><span class=linenos data-linenos="83 "></span></a>
<a id=__codelineno-42-84 name=__codelineno-42-84></a><a href=#__codelineno-42-84><span class=linenos data-linenos="84 "></span></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>vma</span><span class=o>-&gt;</span><span class=n>vm_file</span><span class=p>)</span><span class=w></span>
<a id=__codelineno-42-85 name=__codelineno-42-85></a><a href=#__codelineno-42-85><span class=linenos data-linenos="85 "></span></a><span class=w>        </span><span class=n>fput</span><span class=p>(</span><span class=n>vma</span><span class=o>-&gt;</span><span class=n>vm_file</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-42-86 name=__codelineno-42-86></a><a href=#__codelineno-42-86><span class=linenos data-linenos="86 "></span></a><span class=w>    </span><span class=n>vma</span><span class=o>-&gt;</span><span class=n>vm_file</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>asma</span><span class=o>-&gt;</span><span class=n>file</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-42-87 name=__codelineno-42-87></a><a href=#__codelineno-42-87><span class=linenos data-linenos="87 "></span></a>
<a id=__codelineno-42-88 name=__codelineno-42-88></a><a href=#__codelineno-42-88><span class=linenos data-linenos="88 "></span></a><span class=nl>out</span><span class=p>:</span><span class=w></span>
<a id=__codelineno-42-89 name=__codelineno-42-89></a><a href=#__codelineno-42-89><span class=linenos data-linenos="89 "></span></a><span class=w>    </span><span class=n>mutex_unlock</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ashmem_mutex</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-42-90 name=__codelineno-42-90></a><a href=#__codelineno-42-90><span class=linenos data-linenos="90 "></span></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>ret</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-42-91 name=__codelineno-42-91></a><a href=#__codelineno-42-91><span class=linenos data-linenos="91 "></span></a><span class=p>}</span><span class=w></span>
</code></pre></div> <ul> <li>设置asma的size，不然会抛异常</li> <li>检测需要映射的vma虚拟内存是否符合权限，否则抛异常</li> <li>检查asma中的file文件结构体是否创建</li> <li>没有则获取asma名字和大小通过shmem_file_setup创建一个文件描述符</li> <li>检查如果当前的vma虚拟内存允许共享则调用shmem_zero_setup映射文件</li> </ul> <h3 id=shmem_file_setup>shmem_file_setup<a class=headerlink href=#shmem_file_setup title="Anchor link to this section for reference">&para;</a></h3> <p><div class=highlight><pre><span></span><code><a id=__codelineno-43-1 name=__codelineno-43-1></a><a href=#__codelineno-43-1><span class=linenos data-linenos=" 1 "></span></a><span class=nl>https</span><span class=p>:</span><span class=c1>//android.googlesource.com/kernel/common/+/refs/tags/5.4-android11-0/mm/shmem.c</span>
<a id=__codelineno-43-2 name=__codelineno-43-2></a><a href=#__codelineno-43-2><span class=linenos data-linenos=" 2 "></span></a>
<a id=__codelineno-43-3 name=__codelineno-43-3></a><a href=#__codelineno-43-3><span class=linenos data-linenos=" 3 "></span></a><span class=k>static</span><span class=w> </span><span class=k>struct</span><span class=w> </span><span class=nc>file</span><span class=w> </span><span class=o>*</span><span class=n>__shmem_file_setup</span><span class=p>(</span><span class=k>struct</span><span class=w> </span><span class=nc>vfsmount</span><span class=w> </span><span class=o>*</span><span class=n>mnt</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>loff_t</span><span class=w> </span><span class=n>size</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-43-4 name=__codelineno-43-4></a><a href=#__codelineno-43-4><span class=linenos data-linenos=" 4 "></span></a><span class=w>                       </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>flags</span><span class=p>,</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>i_flags</span><span class=p>)</span><span class=w></span>
<a id=__codelineno-43-5 name=__codelineno-43-5></a><a href=#__codelineno-43-5><span class=linenos data-linenos=" 5 "></span></a><span class=p>{</span><span class=w></span>
<a id=__codelineno-43-6 name=__codelineno-43-6></a><a href=#__codelineno-43-6><span class=linenos data-linenos=" 6 "></span></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>inode</span><span class=w> </span><span class=o>*</span><span class=n>inode</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-43-7 name=__codelineno-43-7></a><a href=#__codelineno-43-7><span class=linenos data-linenos=" 7 "></span></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>file</span><span class=w> </span><span class=o>*</span><span class=n>res</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-43-8 name=__codelineno-43-8></a><a href=#__codelineno-43-8><span class=linenos data-linenos=" 8 "></span></a>
<a id=__codelineno-43-9 name=__codelineno-43-9></a><a href=#__codelineno-43-9><span class=linenos data-linenos=" 9 "></span></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>IS_ERR</span><span class=p>(</span><span class=n>mnt</span><span class=p>))</span><span class=w></span>
<a id=__codelineno-43-10 name=__codelineno-43-10></a><a href=#__codelineno-43-10><span class=linenos data-linenos="10 "></span></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ERR_CAST</span><span class=p>(</span><span class=n>mnt</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-43-11 name=__codelineno-43-11></a><a href=#__codelineno-43-11><span class=linenos data-linenos="11 "></span></a>
<a id=__codelineno-43-12 name=__codelineno-43-12></a><a href=#__codelineno-43-12><span class=linenos data-linenos="12 "></span></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>size</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>size</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>MAX_LFS_FILESIZE</span><span class=p>)</span><span class=w></span>
<a id=__codelineno-43-13 name=__codelineno-43-13></a><a href=#__codelineno-43-13><span class=linenos data-linenos="13 "></span></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ERR_PTR</span><span class=p>(</span><span class=o>-</span><span class=n>EINVAL</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-43-14 name=__codelineno-43-14></a><a href=#__codelineno-43-14><span class=linenos data-linenos="14 "></span></a>
<a id=__codelineno-43-15 name=__codelineno-43-15></a><a href=#__codelineno-43-15><span class=linenos data-linenos="15 "></span></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>shmem_acct_size</span><span class=p>(</span><span class=n>flags</span><span class=p>,</span><span class=w> </span><span class=n>size</span><span class=p>))</span><span class=w></span>
<a id=__codelineno-43-16 name=__codelineno-43-16></a><a href=#__codelineno-43-16><span class=linenos data-linenos="16 "></span></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ERR_PTR</span><span class=p>(</span><span class=o>-</span><span class=n>ENOMEM</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-43-17 name=__codelineno-43-17></a><a href=#__codelineno-43-17><span class=linenos data-linenos="17 "></span></a><span class=w>    </span><span class=c1>//分配inode，分配成功就好比建立了文件，也许并未存在真实文件映射</span>
<a id=__codelineno-43-18 name=__codelineno-43-18></a><a href=#__codelineno-43-18><span class=linenos data-linenos="18 "></span></a><span class=w>    </span><span class=n>inode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>shmem_get_inode</span><span class=p>(</span><span class=n>mnt</span><span class=o>-&gt;</span><span class=n>mnt_sb</span><span class=p>,</span><span class=w> </span><span class=nb>NULL</span><span class=p>,</span><span class=w> </span><span class=n>S_IFREG</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>S_IRWXUGO</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-43-19 name=__codelineno-43-19></a><a href=#__codelineno-43-19><span class=linenos data-linenos="19 "></span></a><span class=w>                </span><span class=n>flags</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-43-20 name=__codelineno-43-20></a><a href=#__codelineno-43-20><span class=linenos data-linenos="20 "></span></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>unlikely</span><span class=p>(</span><span class=o>!</span><span class=n>inode</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-43-21 name=__codelineno-43-21></a><a href=#__codelineno-43-21><span class=linenos data-linenos="21 "></span></a><span class=w>        </span><span class=n>shmem_unacct_size</span><span class=p>(</span><span class=n>flags</span><span class=p>,</span><span class=w> </span><span class=n>size</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-43-22 name=__codelineno-43-22></a><a href=#__codelineno-43-22><span class=linenos data-linenos="22 "></span></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ERR_PTR</span><span class=p>(</span><span class=o>-</span><span class=n>ENOSPC</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-43-23 name=__codelineno-43-23></a><a href=#__codelineno-43-23><span class=linenos data-linenos="23 "></span></a><span class=w>    </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-43-24 name=__codelineno-43-24></a><a href=#__codelineno-43-24><span class=linenos data-linenos="24 "></span></a><span class=w>    </span><span class=n>inode</span><span class=o>-&gt;</span><span class=n>i_flags</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>i_flags</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-43-25 name=__codelineno-43-25></a><a href=#__codelineno-43-25><span class=linenos data-linenos="25 "></span></a><span class=w>    </span><span class=n>inode</span><span class=o>-&gt;</span><span class=n>i_size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>size</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-43-26 name=__codelineno-43-26></a><a href=#__codelineno-43-26><span class=linenos data-linenos="26 "></span></a><span class=w>    </span><span class=n>clear_nlink</span><span class=p>(</span><span class=n>inode</span><span class=p>);</span><span class=w> </span><span class=cm>/* It is unlinked */</span><span class=w></span>
<a id=__codelineno-43-27 name=__codelineno-43-27></a><a href=#__codelineno-43-27><span class=linenos data-linenos="27 "></span></a><span class=w>    </span><span class=n>res</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ERR_PTR</span><span class=p>(</span><span class=n>ramfs_nommu_expand_for_mapping</span><span class=p>(</span><span class=n>inode</span><span class=p>,</span><span class=w> </span><span class=n>size</span><span class=p>));</span><span class=w></span>
<a id=__codelineno-43-28 name=__codelineno-43-28></a><a href=#__codelineno-43-28><span class=linenos data-linenos="28 "></span></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>IS_ERR</span><span class=p>(</span><span class=n>res</span><span class=p>))</span><span class=w></span>
<a id=__codelineno-43-29 name=__codelineno-43-29></a><a href=#__codelineno-43-29><span class=linenos data-linenos="29 "></span></a><span class=w>        </span><span class=n>res</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>alloc_file_pseudo</span><span class=p>(</span><span class=n>inode</span><span class=p>,</span><span class=w> </span><span class=n>mnt</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>O_RDWR</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-43-30 name=__codelineno-43-30></a><a href=#__codelineno-43-30><span class=linenos data-linenos="30 "></span></a><span class=w>                </span><span class=o>&amp;</span><span class=n>shmem_file_operations</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-43-31 name=__codelineno-43-31></a><a href=#__codelineno-43-31><span class=linenos data-linenos="31 "></span></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>IS_ERR</span><span class=p>(</span><span class=n>res</span><span class=p>))</span><span class=w></span>
<a id=__codelineno-43-32 name=__codelineno-43-32></a><a href=#__codelineno-43-32><span class=linenos data-linenos="32 "></span></a><span class=w>        </span><span class=n>iput</span><span class=p>(</span><span class=n>inode</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-43-33 name=__codelineno-43-33></a><a href=#__codelineno-43-33><span class=linenos data-linenos="33 "></span></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>res</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-43-34 name=__codelineno-43-34></a><a href=#__codelineno-43-34><span class=linenos data-linenos="34 "></span></a><span class=p>}</span><span class=w></span>
</code></pre></div> 通过shmem_file_setup在tmpfs临时文件系统中创建一个临时文件（也许只是内核中的一个inode节点），该文件与Ashmem驱动程序创建的匿名共享内存对应，不过用户态并不能看到该临时文件。</p> <h3 id=shmem_zero_setup>shmem_zero_setup<a class=headerlink href=#shmem_zero_setup title="Anchor link to this section for reference">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-44-1 name=__codelineno-44-1></a><a href=#__codelineno-44-1><span class=linenos data-linenos=" 1 "></span></a><span class=nl>https</span><span class=p>:</span><span class=c1>//android.googlesource.com/kernel/common/+/refs/tags/5.4-android11-0/mm/shmem.c</span>
<a id=__codelineno-44-2 name=__codelineno-44-2></a><a href=#__codelineno-44-2><span class=linenos data-linenos=" 2 "></span></a>
<a id=__codelineno-44-3 name=__codelineno-44-3></a><a href=#__codelineno-44-3><span class=linenos data-linenos=" 3 "></span></a><span class=kt>int</span><span class=w> </span><span class=nf>shmem_zero_setup</span><span class=p>(</span><span class=k>struct</span><span class=w> </span><span class=nc>vm_area_struct</span><span class=w> </span><span class=o>*</span><span class=n>vma</span><span class=p>)</span><span class=w></span>
<a id=__codelineno-44-4 name=__codelineno-44-4></a><a href=#__codelineno-44-4><span class=linenos data-linenos=" 4 "></span></a><span class=p>{</span><span class=w></span>
<a id=__codelineno-44-5 name=__codelineno-44-5></a><a href=#__codelineno-44-5><span class=linenos data-linenos=" 5 "></span></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>file</span><span class=w> </span><span class=o>*</span><span class=n>file</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-44-6 name=__codelineno-44-6></a><a href=#__codelineno-44-6><span class=linenos data-linenos=" 6 "></span></a><span class=w>    </span><span class=n>loff_t</span><span class=w> </span><span class=n>size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>vma</span><span class=o>-&gt;</span><span class=n>vm_end</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>vma</span><span class=o>-&gt;</span><span class=n>vm_start</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-44-7 name=__codelineno-44-7></a><a href=#__codelineno-44-7><span class=linenos data-linenos=" 7 "></span></a>
<a id=__codelineno-44-8 name=__codelineno-44-8></a><a href=#__codelineno-44-8><span class=linenos data-linenos=" 8 "></span></a><span class=w>    </span><span class=cm>/*</span>
<a id=__codelineno-44-9 name=__codelineno-44-9></a><a href=#__codelineno-44-9><span class=linenos data-linenos=" 9 "></span></a><span class=cm>     * Cloning a new file under mmap_sem leads to a lock ordering conflict</span>
<a id=__codelineno-44-10 name=__codelineno-44-10></a><a href=#__codelineno-44-10><span class=linenos data-linenos="10 "></span></a><span class=cm>     * between XFS directory reading and selinux: since this file is only</span>
<a id=__codelineno-44-11 name=__codelineno-44-11></a><a href=#__codelineno-44-11><span class=linenos data-linenos="11 "></span></a><span class=cm>     * accessible to the user through its mapping, use S_PRIVATE flag to</span>
<a id=__codelineno-44-12 name=__codelineno-44-12></a><a href=#__codelineno-44-12><span class=linenos data-linenos="12 "></span></a><span class=cm>     * bypass file security, in the same way as shmem_kernel_file_setup().</span>
<a id=__codelineno-44-13 name=__codelineno-44-13></a><a href=#__codelineno-44-13><span class=linenos data-linenos="13 "></span></a><span class=cm>     */</span><span class=w></span>
<a id=__codelineno-44-14 name=__codelineno-44-14></a><a href=#__codelineno-44-14><span class=linenos data-linenos="14 "></span></a><span class=w>    </span><span class=n>file</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>shmem_kernel_file_setup</span><span class=p>(</span><span class=s>&quot;dev/zero&quot;</span><span class=p>,</span><span class=w> </span><span class=n>size</span><span class=p>,</span><span class=w> </span><span class=n>vma</span><span class=o>-&gt;</span><span class=n>vm_flags</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-44-15 name=__codelineno-44-15></a><a href=#__codelineno-44-15><span class=linenos data-linenos="15 "></span></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>IS_ERR</span><span class=p>(</span><span class=n>file</span><span class=p>))</span><span class=w></span>
<a id=__codelineno-44-16 name=__codelineno-44-16></a><a href=#__codelineno-44-16><span class=linenos data-linenos="16 "></span></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>PTR_ERR</span><span class=p>(</span><span class=n>file</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-44-17 name=__codelineno-44-17></a><a href=#__codelineno-44-17><span class=linenos data-linenos="17 "></span></a>
<a id=__codelineno-44-18 name=__codelineno-44-18></a><a href=#__codelineno-44-18><span class=linenos data-linenos="18 "></span></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>vma</span><span class=o>-&gt;</span><span class=n>vm_file</span><span class=p>)</span><span class=w></span>
<a id=__codelineno-44-19 name=__codelineno-44-19></a><a href=#__codelineno-44-19><span class=linenos data-linenos="19 "></span></a><span class=w>        </span><span class=n>fput</span><span class=p>(</span><span class=n>vma</span><span class=o>-&gt;</span><span class=n>vm_file</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-44-20 name=__codelineno-44-20></a><a href=#__codelineno-44-20><span class=linenos data-linenos="20 "></span></a><span class=w>    </span><span class=n>vma</span><span class=o>-&gt;</span><span class=n>vm_file</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>file</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-44-21 name=__codelineno-44-21></a><a href=#__codelineno-44-21><span class=linenos data-linenos="21 "></span></a><span class=w>    </span><span class=n>vma</span><span class=o>-&gt;</span><span class=n>vm_ops</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&amp;</span><span class=n>shmem_vm_ops</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-44-22 name=__codelineno-44-22></a><a href=#__codelineno-44-22><span class=linenos data-linenos="22 "></span></a>
<a id=__codelineno-44-23 name=__codelineno-44-23></a><a href=#__codelineno-44-23><span class=linenos data-linenos="23 "></span></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>IS_ENABLED</span><span class=p>(</span><span class=n>CONFIG_TRANSPARENT_HUGE_PAGECACHE</span><span class=p>)</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w></span>
<a id=__codelineno-44-24 name=__codelineno-44-24></a><a href=#__codelineno-44-24><span class=linenos data-linenos="24 "></span></a><span class=w>            </span><span class=p>((</span><span class=n>vma</span><span class=o>-&gt;</span><span class=n>vm_start</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=o>~</span><span class=n>HPAGE_PMD_MASK</span><span class=p>)</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>HPAGE_PMD_MASK</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=w></span>
<a id=__codelineno-44-25 name=__codelineno-44-25></a><a href=#__codelineno-44-25><span class=linenos data-linenos="25 "></span></a><span class=w>            </span><span class=p>(</span><span class=n>vma</span><span class=o>-&gt;</span><span class=n>vm_end</span><span class=w> </span><span class=o>&amp;</span><span class=w> </span><span class=n>HPAGE_PMD_MASK</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-44-26 name=__codelineno-44-26></a><a href=#__codelineno-44-26><span class=linenos data-linenos="26 "></span></a><span class=w>        </span><span class=n>khugepaged_enter</span><span class=p>(</span><span class=n>vma</span><span class=p>,</span><span class=w> </span><span class=n>vma</span><span class=o>-&gt;</span><span class=n>vm_flags</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-44-27 name=__codelineno-44-27></a><a href=#__codelineno-44-27><span class=linenos data-linenos="27 "></span></a><span class=w>    </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-44-28 name=__codelineno-44-28></a><a href=#__codelineno-44-28><span class=linenos data-linenos="28 "></span></a>
<a id=__codelineno-44-29 name=__codelineno-44-29></a><a href=#__codelineno-44-29><span class=linenos data-linenos="29 "></span></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-44-30 name=__codelineno-44-30></a><a href=#__codelineno-44-30><span class=linenos data-linenos="30 "></span></a><span class=p>}</span><span class=w></span>
<a id=__codelineno-44-31 name=__codelineno-44-31></a><a href=#__codelineno-44-31><span class=linenos data-linenos="31 "></span></a>
<a id=__codelineno-44-32 name=__codelineno-44-32></a><a href=#__codelineno-44-32><span class=linenos data-linenos="32 "></span></a>
<a id=__codelineno-44-33 name=__codelineno-44-33></a><a href=#__codelineno-44-33><span class=linenos data-linenos="33 "></span></a><span class=k>struct</span><span class=w> </span><span class=nc>file</span><span class=w> </span><span class=o>*</span><span class=n>shmem_kernel_file_setup</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>loff_t</span><span class=w> </span><span class=n>size</span><span class=p>,</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>flags</span><span class=p>)</span><span class=w></span>
<a id=__codelineno-44-34 name=__codelineno-44-34></a><a href=#__codelineno-44-34><span class=linenos data-linenos="34 "></span></a><span class=p>{</span><span class=w></span>
<a id=__codelineno-44-35 name=__codelineno-44-35></a><a href=#__codelineno-44-35><span class=linenos data-linenos="35 "></span></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>__shmem_file_setup</span><span class=p>(</span><span class=n>shm_mnt</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>size</span><span class=p>,</span><span class=w> </span><span class=n>flags</span><span class=p>,</span><span class=w> </span><span class=n>S_PRIVATE</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-44-36 name=__codelineno-44-36></a><a href=#__codelineno-44-36><span class=linenos data-linenos="36 "></span></a><span class=p>}</span><span class=w></span>
<a id=__codelineno-44-37 name=__codelineno-44-37></a><a href=#__codelineno-44-37><span class=linenos data-linenos="37 "></span></a>
<a id=__codelineno-44-38 name=__codelineno-44-38></a><a href=#__codelineno-44-38><span class=linenos data-linenos="38 "></span></a>
<a id=__codelineno-44-39 name=__codelineno-44-39></a><a href=#__codelineno-44-39><span class=linenos data-linenos="39 "></span></a><span class=k>static</span><span class=w> </span><span class=k>struct</span><span class=w> </span><span class=nc>file</span><span class=w> </span><span class=o>*</span><span class=n>__shmem_file_setup</span><span class=p>(</span><span class=k>struct</span><span class=w> </span><span class=nc>vfsmount</span><span class=w> </span><span class=o>*</span><span class=n>mnt</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=o>*</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>loff_t</span><span class=w> </span><span class=n>size</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-44-40 name=__codelineno-44-40></a><a href=#__codelineno-44-40><span class=linenos data-linenos="40 "></span></a><span class=w>                       </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>long</span><span class=w> </span><span class=n>flags</span><span class=p>,</span><span class=w> </span><span class=kt>unsigned</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>i_flags</span><span class=p>)</span><span class=w></span>
<a id=__codelineno-44-41 name=__codelineno-44-41></a><a href=#__codelineno-44-41><span class=linenos data-linenos="41 "></span></a><span class=p>{</span><span class=w></span>
<a id=__codelineno-44-42 name=__codelineno-44-42></a><a href=#__codelineno-44-42><span class=linenos data-linenos="42 "></span></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>inode</span><span class=w> </span><span class=o>*</span><span class=n>inode</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-44-43 name=__codelineno-44-43></a><a href=#__codelineno-44-43><span class=linenos data-linenos="43 "></span></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=nc>file</span><span class=w> </span><span class=o>*</span><span class=n>res</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-44-44 name=__codelineno-44-44></a><a href=#__codelineno-44-44><span class=linenos data-linenos="44 "></span></a>
<a id=__codelineno-44-45 name=__codelineno-44-45></a><a href=#__codelineno-44-45><span class=linenos data-linenos="45 "></span></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>IS_ERR</span><span class=p>(</span><span class=n>mnt</span><span class=p>))</span><span class=w></span>
<a id=__codelineno-44-46 name=__codelineno-44-46></a><a href=#__codelineno-44-46><span class=linenos data-linenos="46 "></span></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ERR_CAST</span><span class=p>(</span><span class=n>mnt</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-44-47 name=__codelineno-44-47></a><a href=#__codelineno-44-47><span class=linenos data-linenos="47 "></span></a>
<a id=__codelineno-44-48 name=__codelineno-44-48></a><a href=#__codelineno-44-48><span class=linenos data-linenos="48 "></span></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>size</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>size</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>MAX_LFS_FILESIZE</span><span class=p>)</span><span class=w></span>
<a id=__codelineno-44-49 name=__codelineno-44-49></a><a href=#__codelineno-44-49><span class=linenos data-linenos="49 "></span></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ERR_PTR</span><span class=p>(</span><span class=o>-</span><span class=n>EINVAL</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-44-50 name=__codelineno-44-50></a><a href=#__codelineno-44-50><span class=linenos data-linenos="50 "></span></a>
<a id=__codelineno-44-51 name=__codelineno-44-51></a><a href=#__codelineno-44-51><span class=linenos data-linenos="51 "></span></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>shmem_acct_size</span><span class=p>(</span><span class=n>flags</span><span class=p>,</span><span class=w> </span><span class=n>size</span><span class=p>))</span><span class=w></span>
<a id=__codelineno-44-52 name=__codelineno-44-52></a><a href=#__codelineno-44-52><span class=linenos data-linenos="52 "></span></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ERR_PTR</span><span class=p>(</span><span class=o>-</span><span class=n>ENOMEM</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-44-53 name=__codelineno-44-53></a><a href=#__codelineno-44-53><span class=linenos data-linenos="53 "></span></a>
<a id=__codelineno-44-54 name=__codelineno-44-54></a><a href=#__codelineno-44-54><span class=linenos data-linenos="54 "></span></a><span class=w>    </span><span class=n>inode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>shmem_get_inode</span><span class=p>(</span><span class=n>mnt</span><span class=o>-&gt;</span><span class=n>mnt_sb</span><span class=p>,</span><span class=w> </span><span class=nb>NULL</span><span class=p>,</span><span class=w> </span><span class=n>S_IFREG</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>S_IRWXUGO</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-44-55 name=__codelineno-44-55></a><a href=#__codelineno-44-55><span class=linenos data-linenos="55 "></span></a><span class=w>                </span><span class=n>flags</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-44-56 name=__codelineno-44-56></a><a href=#__codelineno-44-56><span class=linenos data-linenos="56 "></span></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>unlikely</span><span class=p>(</span><span class=o>!</span><span class=n>inode</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-44-57 name=__codelineno-44-57></a><a href=#__codelineno-44-57><span class=linenos data-linenos="57 "></span></a><span class=w>        </span><span class=n>shmem_unacct_size</span><span class=p>(</span><span class=n>flags</span><span class=p>,</span><span class=w> </span><span class=n>size</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-44-58 name=__codelineno-44-58></a><a href=#__codelineno-44-58><span class=linenos data-linenos="58 "></span></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>ERR_PTR</span><span class=p>(</span><span class=o>-</span><span class=n>ENOSPC</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-44-59 name=__codelineno-44-59></a><a href=#__codelineno-44-59><span class=linenos data-linenos="59 "></span></a><span class=w>    </span><span class=p>}</span><span class=w></span>
<a id=__codelineno-44-60 name=__codelineno-44-60></a><a href=#__codelineno-44-60><span class=linenos data-linenos="60 "></span></a><span class=w>    </span><span class=n>inode</span><span class=o>-&gt;</span><span class=n>i_flags</span><span class=w> </span><span class=o>|=</span><span class=w> </span><span class=n>i_flags</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-44-61 name=__codelineno-44-61></a><a href=#__codelineno-44-61><span class=linenos data-linenos="61 "></span></a><span class=w>    </span><span class=n>inode</span><span class=o>-&gt;</span><span class=n>i_size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>size</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-44-62 name=__codelineno-44-62></a><a href=#__codelineno-44-62><span class=linenos data-linenos="62 "></span></a><span class=w>    </span><span class=n>clear_nlink</span><span class=p>(</span><span class=n>inode</span><span class=p>);</span><span class=w> </span><span class=cm>/* It is unlinked */</span><span class=w></span>
<a id=__codelineno-44-63 name=__codelineno-44-63></a><a href=#__codelineno-44-63><span class=linenos data-linenos="63 "></span></a><span class=w>    </span><span class=n>res</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ERR_PTR</span><span class=p>(</span><span class=n>ramfs_nommu_expand_for_mapping</span><span class=p>(</span><span class=n>inode</span><span class=p>,</span><span class=w> </span><span class=n>size</span><span class=p>));</span><span class=w></span>
<a id=__codelineno-44-64 name=__codelineno-44-64></a><a href=#__codelineno-44-64><span class=linenos data-linenos="64 "></span></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=o>!</span><span class=n>IS_ERR</span><span class=p>(</span><span class=n>res</span><span class=p>))</span><span class=w></span>
<a id=__codelineno-44-65 name=__codelineno-44-65></a><a href=#__codelineno-44-65><span class=linenos data-linenos="65 "></span></a><span class=w>        </span><span class=n>res</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>alloc_file_pseudo</span><span class=p>(</span><span class=n>inode</span><span class=p>,</span><span class=w> </span><span class=n>mnt</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>O_RDWR</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-44-66 name=__codelineno-44-66></a><a href=#__codelineno-44-66><span class=linenos data-linenos="66 "></span></a><span class=w>                </span><span class=o>&amp;</span><span class=n>shmem_file_operations</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-44-67 name=__codelineno-44-67></a><a href=#__codelineno-44-67><span class=linenos data-linenos="67 "></span></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>IS_ERR</span><span class=p>(</span><span class=n>res</span><span class=p>))</span><span class=w></span>
<a id=__codelineno-44-68 name=__codelineno-44-68></a><a href=#__codelineno-44-68><span class=linenos data-linenos="68 "></span></a><span class=w>        </span><span class=n>iput</span><span class=p>(</span><span class=n>inode</span><span class=p>);</span><span class=w></span>
<a id=__codelineno-44-69 name=__codelineno-44-69></a><a href=#__codelineno-44-69><span class=linenos data-linenos="69 "></span></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>res</span><span class=p>;</span><span class=w></span>
<a id=__codelineno-44-70 name=__codelineno-44-70></a><a href=#__codelineno-44-70><span class=linenos data-linenos="70 "></span></a><span class=p>}</span><span class=w></span>
</code></pre></div> <ul> <li>通过shmem_get_inode设置共享的inode，inode是Linux访问硬盘文件系统的基本单位，里面包含如superblock等元数据。</li> <li>alloc_file_pseudo申请一个file结构体，同时复写file的结构中的file_operation文件操作</li> </ul> <p>继续看file_operations有哪些操作 <div class=highlight><pre><span></span><code><a id=__codelineno-45-1 name=__codelineno-45-1></a><a href=#__codelineno-45-1><span class=linenos data-linenos=" 1 "></span></a><span class=nl>https</span><span class=p>:</span><span class=c1>//android.googlesource.com/kernel/common/+/refs/tags/5.4-android11-0/mm/shmem.c</span>
<a id=__codelineno-45-2 name=__codelineno-45-2></a><a href=#__codelineno-45-2><span class=linenos data-linenos=" 2 "></span></a>
<a id=__codelineno-45-3 name=__codelineno-45-3></a><a href=#__codelineno-45-3><span class=linenos data-linenos=" 3 "></span></a><span class=k>static</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=k>struct</span><span class=w> </span><span class=nc>file_operations</span><span class=w> </span><span class=n>shmem_file_operations</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=w></span>
<a id=__codelineno-45-4 name=__codelineno-45-4></a><a href=#__codelineno-45-4><span class=linenos data-linenos=" 4 "></span></a><span class=w>    </span><span class=p>.</span><span class=n>mmap</span><span class=w>       </span><span class=o>=</span><span class=w> </span><span class=n>shmem_mmap</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-45-5 name=__codelineno-45-5></a><a href=#__codelineno-45-5><span class=linenos data-linenos=" 5 "></span></a><span class=w>    </span><span class=p>.</span><span class=n>get_unmapped_area</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>shmem_get_unmapped_area</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-45-6 name=__codelineno-45-6></a><a href=#__codelineno-45-6><span class=linenos data-linenos=" 6 "></span></a><span class=cp>#ifdef CONFIG_TMPFS</span>
<a id=__codelineno-45-7 name=__codelineno-45-7></a><a href=#__codelineno-45-7><span class=linenos data-linenos=" 7 "></span></a><span class=w>    </span><span class=p>.</span><span class=n>llseek</span><span class=w>     </span><span class=o>=</span><span class=w> </span><span class=n>shmem_file_llseek</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-45-8 name=__codelineno-45-8></a><a href=#__codelineno-45-8><span class=linenos data-linenos=" 8 "></span></a><span class=w>    </span><span class=p>.</span><span class=n>read_iter</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=n>shmem_file_read_iter</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-45-9 name=__codelineno-45-9></a><a href=#__codelineno-45-9><span class=linenos data-linenos=" 9 "></span></a><span class=w>    </span><span class=p>.</span><span class=n>write_iter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>generic_file_write_iter</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-45-10 name=__codelineno-45-10></a><a href=#__codelineno-45-10><span class=linenos data-linenos="10 "></span></a><span class=w>    </span><span class=p>.</span><span class=n>fsync</span><span class=w>      </span><span class=o>=</span><span class=w> </span><span class=n>noop_fsync</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-45-11 name=__codelineno-45-11></a><a href=#__codelineno-45-11><span class=linenos data-linenos="11 "></span></a><span class=w>    </span><span class=p>.</span><span class=n>splice_read</span><span class=w>    </span><span class=o>=</span><span class=w> </span><span class=n>generic_file_splice_read</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-45-12 name=__codelineno-45-12></a><a href=#__codelineno-45-12><span class=linenos data-linenos="12 "></span></a><span class=w>    </span><span class=p>.</span><span class=n>splice_write</span><span class=w>   </span><span class=o>=</span><span class=w> </span><span class=n>iter_file_splice_write</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-45-13 name=__codelineno-45-13></a><a href=#__codelineno-45-13><span class=linenos data-linenos="13 "></span></a><span class=w>    </span><span class=p>.</span><span class=n>fallocate</span><span class=w>  </span><span class=o>=</span><span class=w> </span><span class=n>shmem_fallocate</span><span class=p>,</span><span class=w></span>
<a id=__codelineno-45-14 name=__codelineno-45-14></a><a href=#__codelineno-45-14><span class=linenos data-linenos="14 "></span></a><span class=cp>#endif</span>
<a id=__codelineno-45-15 name=__codelineno-45-15></a><a href=#__codelineno-45-15><span class=linenos data-linenos="15 "></span></a><span class=p>};</span><span class=w></span>
</code></pre></div> 通过shmem_file_setup，ashmem驱动程序就把vma中的file文件结构体转化为共享内存了。 不过看到shmem这个名字就应该知道其实这就是Linux中的共享内存。</p> <p>共享内存机制真正使用map的对象其实是这个临时文件，而不是ashmem设备文件，这里之所以是一次mmap，主要是通过vma-&gt;vm_file = asma-&gt;file完成map对象的替换，当映射的内存引起缺页中断的时候，就会调用shmem_file_setup创建的对象的函数，而不是ashmem的。</p> <h1 id=filedescriptor>FileDescriptor<a class=headerlink href=#filedescriptor title="Anchor link to this section for reference">&para;</a></h1> <p>文章有点长，看完MemoryFile和Ashmen的分析。可能就已经懵了，啥啊这是。那么到现在为止我们还不知道如何传输大数据。 原生Linux共享内存是通过传递已知的key来处理的，但是Android中不存在这种机制，Android是怎么处理的呢？那就是通过Binder传递文件描述符来处理，Android的Binder对于fd的传递也做了适配，原理其实就是<strong>在内核层为要传递的目标进程转换fd</strong>，因为在linux中fd只是对本进程是有效、且唯一，进程A打开一个文件得到一个fd，不能直接为进程B使用，因为B中那个fd可能压根无效、或者对应其他文件。虽然同一个文件可以有多个文件描述符，但是文件只有一个，在内核层也只会对应一个inode节点与file对象，这也是内核层可以传递fd的基础，Binder驱动通过当前进程的fd找到对应的文件，然后为目标进程新建fd，并传递给目标进程，核心就是把进程A中的fd转化成进程B中的fd。 在MemoryFile的构造函数里，会创建出一块共享内存，并用一个FileDescriptor文件描述符记录它，这个在前文。 <div class=highlight><pre><span></span><code><a id=__codelineno-46-1 name=__codelineno-46-1></a><a href=#__codelineno-46-1><span class=linenos data-linenos="1 "></span></a><span class=nl>http</span><span class=p>:</span><span class=c1>//aospxref.com/android-11.0.0_r21/xref/frameworks/base/core/java/android/os/SharedMemory.java#377</span>
<a id=__codelineno-46-2 name=__codelineno-46-2></a><a href=#__codelineno-46-2><span class=linenos data-linenos="2 "></span></a>
<a id=__codelineno-46-3 name=__codelineno-46-3></a><a href=#__codelineno-46-3><span class=linenos data-linenos="3 "></span></a><span class=n>private</span><span class=w> </span><span class=k>static</span><span class=w> </span><span class=n>native</span><span class=w> </span><span class=n>FileDescriptor</span><span class=w> </span><span class=n>nCreate</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>size</span><span class=p>)</span><span class=w> </span><span class=n>throws</span><span class=w> </span><span class=n>ErrnoException</span><span class=p>;</span><span class=w></span>
</code></pre></div> 那么很明显，MemoryFile内部最核心的东西，也就来源于这个文件描述符。 在“使用”这一节了其实也用到了fd。</p> <h1 id=qa>QA<a class=headerlink href=#qa title="Anchor link to this section for reference">&para;</a></h1> <ul> <li>为了减少Java堆中的大小而把部分数据通过匿名共享内存传递，这样的内存优化方案是否可行？</li> </ul> <p>从前面的分析，我们知道匿名共享内存不会占用Dalvik Heap与Native Heap，不会导致OOM。但是如果说匿名共享内存是内存优化方案就是大错特错了。这种方式只是Android版本检测内存的漏洞而已。 <img alt=image.png src="https://cdn.nlark.com/yuque/0/2021/png/1759879/1631953107698-2b5672f4-f6be-4a73-9b9e-c4b8f9c44e9a.png#clientId=ua831b86f-6d5e-4&from=paste&id=u1c8426b1&margin=%5Bobject%20Object%5D&name=image.png&originHeight=739&originWidth=749&originalType=url&ratio=1&size=374025&status=done&style=none&taskId=ua095e2b5-fef1-433f-b7e8-0c8e1c5b46d"> （网上图片） 另外共享存占用空间的计算，只会计算到第一个创建它的进程中，其他进程不将ashmem计算在内。</p> <h1 id=putbinder>putBinder<a class=headerlink href=#putbinder title="Anchor link to this section for reference">&para;</a></h1> <p>现在我们继续分析网上传得很神奇的putBinder可以传输大图片到底是为何。</p> <h2 id=_10>代码<a class=headerlink href=#_10 title="Anchor link to this section for reference">&para;</a></h2> <div class=highlight><pre><span></span><code><a id=__codelineno-47-1 name=__codelineno-47-1></a><a href=#__codelineno-47-1><span class=linenos data-linenos=" 1 "></span></a><span class=c1>//发送端</span>
<a id=__codelineno-47-2 name=__codelineno-47-2></a><a href=#__codelineno-47-2><span class=linenos data-linenos=" 2 "></span></a><span class=n>Intent</span> <span class=n>intent</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Intent</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=n>SecondActivity</span><span class=p>.</span><span class=na>class</span><span class=p>);</span>
<a id=__codelineno-47-3 name=__codelineno-47-3></a><a href=#__codelineno-47-3><span class=linenos data-linenos=" 3 "></span></a><span class=n>Bundle</span> <span class=n>bundle</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Bundle</span><span class=p>();</span>
<a id=__codelineno-47-4 name=__codelineno-47-4></a><a href=#__codelineno-47-4><span class=linenos data-linenos=" 4 "></span></a><span class=k>if</span> <span class=p>(</span><span class=n>Build</span><span class=p>.</span><span class=na>VERSION</span><span class=p>.</span><span class=na>SDK_INT</span> <span class=o>&gt;=</span> <span class=n>Build</span><span class=p>.</span><span class=na>VERSION_CODES</span><span class=p>.</span><span class=na>JELLY_BEAN_MR2</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-47-5 name=__codelineno-47-5></a><a href=#__codelineno-47-5><span class=linenos data-linenos=" 5 "></span></a>    <span class=n>bundle</span><span class=p>.</span><span class=na>putBinder</span><span class=p>(</span><span class=s>&quot;bitmap&quot;</span><span class=p>,</span> <span class=k>new</span> <span class=n>ImageBinder</span><span class=p>(</span><span class=n>mBitmap</span><span class=p>));</span>
<a id=__codelineno-47-6 name=__codelineno-47-6></a><a href=#__codelineno-47-6><span class=linenos data-linenos=" 6 "></span></a><span class=p>}</span>
<a id=__codelineno-47-7 name=__codelineno-47-7></a><a href=#__codelineno-47-7><span class=linenos data-linenos=" 7 "></span></a><span class=n>intent</span><span class=p>.</span><span class=na>putExtras</span><span class=p>(</span><span class=n>bundle</span><span class=p>);</span>
<a id=__codelineno-47-8 name=__codelineno-47-8></a><a href=#__codelineno-47-8><span class=linenos data-linenos=" 8 "></span></a><span class=n>startActivity</span><span class=p>(</span><span class=n>intent</span><span class=p>);</span>
<a id=__codelineno-47-9 name=__codelineno-47-9></a><a href=#__codelineno-47-9><span class=linenos data-linenos=" 9 "></span></a>
<a id=__codelineno-47-10 name=__codelineno-47-10></a><a href=#__codelineno-47-10><span class=linenos data-linenos="10 "></span></a><span class=c1>//接收端</span>
<a id=__codelineno-47-11 name=__codelineno-47-11></a><a href=#__codelineno-47-11><span class=linenos data-linenos="11 "></span></a><span class=n>Bundle</span> <span class=n>bundle</span> <span class=o>=</span> <span class=n>getIntent</span><span class=p>().</span><span class=na>getExtras</span><span class=p>();</span>
<a id=__codelineno-47-12 name=__codelineno-47-12></a><a href=#__codelineno-47-12><span class=linenos data-linenos="12 "></span></a><span class=k>if</span> <span class=p>(</span><span class=n>bundle</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-47-13 name=__codelineno-47-13></a><a href=#__codelineno-47-13><span class=linenos data-linenos="13 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>Build</span><span class=p>.</span><span class=na>VERSION</span><span class=p>.</span><span class=na>SDK_INT</span> <span class=o>&gt;=</span> <span class=n>Build</span><span class=p>.</span><span class=na>VERSION_CODES</span><span class=p>.</span><span class=na>JELLY_BEAN_MR2</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-47-14 name=__codelineno-47-14></a><a href=#__codelineno-47-14><span class=linenos data-linenos="14 "></span></a>        <span class=n>ImageBinder</span> <span class=n>imageBinder</span> <span class=o>=</span> <span class=p>(</span><span class=n>ImageBinder</span><span class=p>)</span> <span class=n>bundle</span><span class=p>.</span><span class=na>getBinder</span><span class=p>(</span><span class=s>&quot;bitmap&quot;</span><span class=p>);</span>
<a id=__codelineno-47-15 name=__codelineno-47-15></a><a href=#__codelineno-47-15><span class=linenos data-linenos="15 "></span></a>        <span class=n>Bitmap</span> <span class=n>bitmap</span> <span class=o>=</span> <span class=n>imageBinder</span><span class=p>.</span><span class=na>getBitmap</span><span class=p>();</span>
<a id=__codelineno-47-16 name=__codelineno-47-16></a><a href=#__codelineno-47-16><span class=linenos data-linenos="16 "></span></a>        <span class=n>mTv</span><span class=p>.</span><span class=na>setText</span><span class=p>(</span><span class=n>String</span><span class=p>.</span><span class=na>format</span><span class=p>((</span><span class=s>&quot;bitmap大小为%dkB&quot;</span><span class=p>),</span> <span class=n>bitmap</span><span class=p>.</span><span class=na>getByteCount</span><span class=p>()</span> <span class=o>/</span> <span class=mi>1024</span><span class=p>));</span>
<a id=__codelineno-47-17 name=__codelineno-47-17></a><a href=#__codelineno-47-17><span class=linenos data-linenos="17 "></span></a>        <span class=n>mIv</span><span class=p>.</span><span class=na>setImageBitmap</span><span class=p>(</span><span class=n>bitmap</span><span class=p>);</span>
<a id=__codelineno-47-18 name=__codelineno-47-18></a><a href=#__codelineno-47-18><span class=linenos data-linenos="18 "></span></a>    <span class=p>}</span>
<a id=__codelineno-47-19 name=__codelineno-47-19></a><a href=#__codelineno-47-19><span class=linenos data-linenos="19 "></span></a><span class=p>}</span>
</code></pre></div> <h2 id=_11>源码<a class=headerlink href=#_11 title="Anchor link to this section for reference">&para;</a></h2> <p>startActivity的流程请阅读Activity启动分析，这里只贴出关键代码片段。</p> <h3 id=writetoparcel>writeToParcel<a class=headerlink href=#writetoparcel title="Anchor link to this section for reference">&para;</a></h3> <p><div class=highlight><pre><span></span><code><a id=__codelineno-48-1 name=__codelineno-48-1></a><a href=#__codelineno-48-1><span class=linenos data-linenos=" 1 "></span></a><span class=kt>int</span> <span class=nf>startActivity</span><span class=p>(...,</span> <span class=n>Intent</span> <span class=n>intent</span><span class=p>,</span> <span class=p>...)</span> <span class=p>{</span>
<a id=__codelineno-48-2 name=__codelineno-48-2></a><a href=#__codelineno-48-2><span class=linenos data-linenos=" 2 "></span></a>    <span class=n>Parcel</span> <span class=n>data</span> <span class=o>=</span> <span class=n>Parcel</span><span class=p>.</span><span class=na>obtain</span><span class=p>();</span>
<a id=__codelineno-48-3 name=__codelineno-48-3></a><a href=#__codelineno-48-3><span class=linenos data-linenos=" 3 "></span></a>    <span class=p>......</span>  
<a id=__codelineno-48-4 name=__codelineno-48-4></a><a href=#__codelineno-48-4><span class=linenos data-linenos=" 4 "></span></a>    <span class=n>intent</span><span class=p>.</span><span class=na>writeToParcel</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>    
<a id=__codelineno-48-5 name=__codelineno-48-5></a><a href=#__codelineno-48-5><span class=linenos data-linenos=" 5 "></span></a>    <span class=p>......</span>
<a id=__codelineno-48-6 name=__codelineno-48-6></a><a href=#__codelineno-48-6><span class=linenos data-linenos=" 6 "></span></a>    <span class=n>mRemote</span><span class=p>.</span><span class=na>transact</span><span class=p>(</span><span class=n>START_ACTIVITY_TRANSACTION</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>reply</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>  
<a id=__codelineno-48-7 name=__codelineno-48-7></a><a href=#__codelineno-48-7><span class=linenos data-linenos=" 7 "></span></a>    <span class=p>......</span>
<a id=__codelineno-48-8 name=__codelineno-48-8></a><a href=#__codelineno-48-8><span class=linenos data-linenos=" 8 "></span></a><span class=p>}</span>
<a id=__codelineno-48-9 name=__codelineno-48-9></a><a href=#__codelineno-48-9><span class=linenos data-linenos=" 9 "></span></a>
<a id=__codelineno-48-10 name=__codelineno-48-10></a><a href=#__codelineno-48-10><span class=linenos data-linenos="10 "></span></a><span class=kd>public</span> <span class=kt>void</span> <span class=nf>writeToParcel</span><span class=p>(</span><span class=n>Parcel</span> <span class=n>out</span><span class=p>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-48-11 name=__codelineno-48-11></a><a href=#__codelineno-48-11><span class=linenos data-linenos="11 "></span></a>    <span class=p>......</span>    
<a id=__codelineno-48-12 name=__codelineno-48-12></a><a href=#__codelineno-48-12><span class=linenos data-linenos="12 "></span></a>    <span class=n>out</span><span class=p>.</span><span class=na>writeBundle</span><span class=p>(</span><span class=n>mExtras</span><span class=p>);</span>
<a id=__codelineno-48-13 name=__codelineno-48-13></a><a href=#__codelineno-48-13><span class=linenos data-linenos="13 "></span></a><span class=p>}</span>
<a id=__codelineno-48-14 name=__codelineno-48-14></a><a href=#__codelineno-48-14><span class=linenos data-linenos="14 "></span></a>
<a id=__codelineno-48-15 name=__codelineno-48-15></a><a href=#__codelineno-48-15><span class=linenos data-linenos="15 "></span></a><span class=kd>public</span> <span class=kt>void</span> <span class=nf>writeToParcel</span><span class=p>(</span><span class=n>Parcel</span> <span class=n>out</span><span class=p>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=p>)</span> <span class=p>{</span>    
<a id=__codelineno-48-16 name=__codelineno-48-16></a><a href=#__codelineno-48-16><span class=linenos data-linenos="16 "></span></a>    <span class=p>......</span>    
<a id=__codelineno-48-17 name=__codelineno-48-17></a><a href=#__codelineno-48-17><span class=linenos data-linenos="17 "></span></a>    <span class=n>out</span><span class=p>.</span><span class=na>writeBundle</span><span class=p>(</span><span class=n>mExtras</span><span class=p>);</span>
<a id=__codelineno-48-18 name=__codelineno-48-18></a><a href=#__codelineno-48-18><span class=linenos data-linenos="18 "></span></a><span class=p>}</span>
</code></pre></div> writeToParcel函数，其实就是给Intent里的Bundle写到Parcel了。</p> <h3 id=writebundle>writeBundle<a class=headerlink href=#writebundle title="Anchor link to this section for reference">&para;</a></h3> <p>继续往下走，看Bundle怎么写到Parcel的，原来是调到了Bundle的writeToParcel函数。 <div class=highlight><pre><span></span><code><a id=__codelineno-49-1 name=__codelineno-49-1></a><a href=#__codelineno-49-1><span class=linenos data-linenos="1 "></span></a><span class=kd>public</span> <span class=kd>final</span> <span class=kt>void</span> <span class=nf>writeBundle</span><span class=p>(</span><span class=n>Bundle</span> <span class=n>val</span><span class=p>)</span> <span class=p>{</span>    
<a id=__codelineno-49-2 name=__codelineno-49-2></a><a href=#__codelineno-49-2><span class=linenos data-linenos="2 "></span></a>    <span class=n>val</span><span class=p>.</span><span class=na>writeToParcel</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
<a id=__codelineno-49-3 name=__codelineno-49-3></a><a href=#__codelineno-49-3><span class=linenos data-linenos="3 "></span></a><span class=p>}</span>
</code></pre></div></p> <h3 id=writetoparcelinner>writeToParcelInner<a class=headerlink href=#writetoparcelinner title="Anchor link to this section for reference">&para;</a></h3> <p>继续往下走，又调到了writeToParcelInner。 <div class=highlight><pre><span></span><code><a id=__codelineno-50-1 name=__codelineno-50-1></a><a href=#__codelineno-50-1><span class=linenos data-linenos="1 "></span></a><span class=kd>public</span> <span class=kt>void</span> <span class=nf>writeToParcel</span><span class=p>(</span><span class=n>Parcel</span> <span class=n>parcel</span><span class=p>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=p>)</span> <span class=p>{</span>    
<a id=__codelineno-50-2 name=__codelineno-50-2></a><a href=#__codelineno-50-2><span class=linenos data-linenos="2 "></span></a>    <span class=kd>final</span> <span class=kt>boolean</span> <span class=n>oldAllowFds</span> <span class=o>=</span> <span class=n>parcel</span><span class=p>.</span><span class=na>pushAllowFds</span><span class=p>(</span><span class=n>mAllowFds</span><span class=p>);</span> 
<a id=__codelineno-50-3 name=__codelineno-50-3></a><a href=#__codelineno-50-3><span class=linenos data-linenos="3 "></span></a>    <span class=kd>super</span><span class=p>.</span><span class=na>writeToParcelInner</span><span class=p>(</span><span class=n>parcel</span><span class=p>,</span> <span class=n>flags</span><span class=p>);</span>    
<a id=__codelineno-50-4 name=__codelineno-50-4></a><a href=#__codelineno-50-4><span class=linenos data-linenos="4 "></span></a>    <span class=n>parcel</span><span class=p>.</span><span class=na>restoreAllowFds</span><span class=p>(</span><span class=n>oldAllowFds</span><span class=p>);</span>
<a id=__codelineno-50-5 name=__codelineno-50-5></a><a href=#__codelineno-50-5><span class=linenos data-linenos="5 "></span></a><span class=p>}</span>
</code></pre></div></p> <h3 id=pushallowfds>pushAllowFds<a class=headerlink href=#pushallowfds title="Anchor link to this section for reference">&para;</a></h3> <p>这不就是上文我们提到的fd吗，继续往下看。 <div class=highlight><pre><span></span><code><a id=__codelineno-51-1 name=__codelineno-51-1></a><a href=#__codelineno-51-1><span class=linenos data-linenos="1 "></span></a><span class=n>bool</span> <span class=n>Parcel</span><span class=p>::</span><span class=n>pushAllowFds</span><span class=p>(</span><span class=n>bool</span> <span class=n>allowFds</span><span class=p>)</span> <span class=p>{</span>    
<a id=__codelineno-51-2 name=__codelineno-51-2></a><a href=#__codelineno-51-2><span class=linenos data-linenos="2 "></span></a>    <span class=kd>const</span> <span class=n>bool</span> <span class=n>origValue</span> <span class=o>=</span> <span class=n>mAllowFds</span><span class=p>;</span>    
<a id=__codelineno-51-3 name=__codelineno-51-3></a><a href=#__codelineno-51-3><span class=linenos data-linenos="3 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>allowFds</span><span class=p>)</span> <span class=p>{</span>        
<a id=__codelineno-51-4 name=__codelineno-51-4></a><a href=#__codelineno-51-4><span class=linenos data-linenos="4 "></span></a>        <span class=n>mAllowFds</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>    
<a id=__codelineno-51-5 name=__codelineno-51-5></a><a href=#__codelineno-51-5><span class=linenos data-linenos="5 "></span></a>    <span class=p>}</span>    
<a id=__codelineno-51-6 name=__codelineno-51-6></a><a href=#__codelineno-51-6><span class=linenos data-linenos="6 "></span></a>    <span class=k>return</span> <span class=n>origValue</span><span class=p>;</span>
<a id=__codelineno-51-7 name=__codelineno-51-7></a><a href=#__codelineno-51-7><span class=linenos data-linenos="7 "></span></a><span class=p>}</span>
</code></pre></div></p> <blockquote> <p>返回true，不再深入分析</p> </blockquote> <h3 id=writetoparcelinner_1>writeToParcelInner<a class=headerlink href=#writetoparcelinner_1 title="Anchor link to this section for reference">&para;</a></h3> <p><div class=highlight><pre><span></span><code><a id=__codelineno-52-1 name=__codelineno-52-1></a><a href=#__codelineno-52-1><span class=linenos data-linenos=" 1 "></span></a><span class=kt>void</span> <span class=nf>writeToParcelInner</span><span class=p>(</span><span class=n>Parcel</span> <span class=n>parcel</span><span class=p>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=p>)</span> <span class=p>{</span>    
<a id=__codelineno-52-2 name=__codelineno-52-2></a><a href=#__codelineno-52-2><span class=linenos data-linenos=" 2 "></span></a>    <span class=p>......</span>    
<a id=__codelineno-52-3 name=__codelineno-52-3></a><a href=#__codelineno-52-3><span class=linenos data-linenos=" 3 "></span></a>    <span class=n>parcel</span><span class=p>.</span><span class=na>writeArrayMapInternal</span><span class=p>(</span><span class=n>mMap</span><span class=p>);</span>
<a id=__codelineno-52-4 name=__codelineno-52-4></a><a href=#__codelineno-52-4><span class=linenos data-linenos=" 4 "></span></a><span class=p>}</span>
<a id=__codelineno-52-5 name=__codelineno-52-5></a><a href=#__codelineno-52-5><span class=linenos data-linenos=" 5 "></span></a>
<a id=__codelineno-52-6 name=__codelineno-52-6></a><a href=#__codelineno-52-6><span class=linenos data-linenos=" 6 "></span></a><span class=kt>void</span> <span class=nf>writeArrayMapInternal</span><span class=p>(</span><span class=n>ArrayMap</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>Object</span><span class=o>&gt;</span> <span class=n>val</span><span class=p>)</span> <span class=p>{</span>      
<a id=__codelineno-52-7 name=__codelineno-52-7></a><a href=#__codelineno-52-7><span class=linenos data-linenos=" 7 "></span></a>    <span class=kd>final</span> <span class=kt>int</span> <span class=n>N</span> <span class=o>=</span> <span class=n>val</span><span class=p>.</span><span class=na>size</span><span class=p>();</span>   
<a id=__codelineno-52-8 name=__codelineno-52-8></a><a href=#__codelineno-52-8><span class=linenos data-linenos=" 8 "></span></a>    <span class=n>writeInt</span><span class=p>(</span><span class=n>N</span><span class=p>);</span>    
<a id=__codelineno-52-9 name=__codelineno-52-9></a><a href=#__codelineno-52-9><span class=linenos data-linenos=" 9 "></span></a>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>N</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>        
<a id=__codelineno-52-10 name=__codelineno-52-10></a><a href=#__codelineno-52-10><span class=linenos data-linenos="10 "></span></a>        <span class=n>writeString</span><span class=p>(</span><span class=n>val</span><span class=p>.</span><span class=na>keyAt</span><span class=p>(</span><span class=n>i</span><span class=p>));</span>        
<a id=__codelineno-52-11 name=__codelineno-52-11></a><a href=#__codelineno-52-11><span class=linenos data-linenos="11 "></span></a>        <span class=n>writeValue</span><span class=p>(</span><span class=n>val</span><span class=p>.</span><span class=na>valueAt</span><span class=p>(</span><span class=n>i</span><span class=p>));</span>    
<a id=__codelineno-52-12 name=__codelineno-52-12></a><a href=#__codelineno-52-12><span class=linenos data-linenos="12 "></span></a>    <span class=p>}</span>
<a id=__codelineno-52-13 name=__codelineno-52-13></a><a href=#__codelineno-52-13><span class=linenos data-linenos="13 "></span></a><span class=p>}</span>
<a id=__codelineno-52-14 name=__codelineno-52-14></a><a href=#__codelineno-52-14><span class=linenos data-linenos="14 "></span></a>
<a id=__codelineno-52-15 name=__codelineno-52-15></a><a href=#__codelineno-52-15><span class=linenos data-linenos="15 "></span></a><span class=kd>public</span> <span class=kd>final</span> <span class=kt>void</span> <span class=nf>writeValue</span><span class=p>(</span><span class=n>Object</span> <span class=n>v</span><span class=p>)</span> <span class=p>{</span>    
<a id=__codelineno-52-16 name=__codelineno-52-16></a><a href=#__codelineno-52-16><span class=linenos data-linenos="16 "></span></a>    <span class=p>......</span>     
<a id=__codelineno-52-17 name=__codelineno-52-17></a><a href=#__codelineno-52-17><span class=linenos data-linenos="17 "></span></a>    <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>v</span> <span class=k>instanceof</span> <span class=n>Parcelable</span><span class=p>)</span> <span class=p>{</span>        
<a id=__codelineno-52-18 name=__codelineno-52-18></a><a href=#__codelineno-52-18><span class=linenos data-linenos="18 "></span></a>        <span class=n>writeInt</span><span class=p>(</span><span class=n>VAL_PARCELABLE</span><span class=p>);</span>        
<a id=__codelineno-52-19 name=__codelineno-52-19></a><a href=#__codelineno-52-19><span class=linenos data-linenos="19 "></span></a>        <span class=n>writeParcelable</span><span class=p>((</span><span class=n>Parcelable</span><span class=p>)</span> <span class=n>v</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>    
<a id=__codelineno-52-20 name=__codelineno-52-20></a><a href=#__codelineno-52-20><span class=linenos data-linenos="20 "></span></a>    <span class=p>}</span>     
<a id=__codelineno-52-21 name=__codelineno-52-21></a><a href=#__codelineno-52-21><span class=linenos data-linenos="21 "></span></a>    <span class=p>......</span>
<a id=__codelineno-52-22 name=__codelineno-52-22></a><a href=#__codelineno-52-22><span class=linenos data-linenos="22 "></span></a><span class=p>}</span>
<a id=__codelineno-52-23 name=__codelineno-52-23></a><a href=#__codelineno-52-23><span class=linenos data-linenos="23 "></span></a>
<a id=__codelineno-52-24 name=__codelineno-52-24></a><a href=#__codelineno-52-24><span class=linenos data-linenos="24 "></span></a><span class=kt>void</span> <span class=nf>writeParcelable</span><span class=p>(</span><span class=n>Parcelable</span> <span class=n>p</span><span class=p>,</span> <span class=kt>int</span> <span class=n>parcelableFlags</span><span class=p>)</span> <span class=p>{</span>    
<a id=__codelineno-52-25 name=__codelineno-52-25></a><a href=#__codelineno-52-25><span class=linenos data-linenos="25 "></span></a>    <span class=n>writeParcelableCreator</span><span class=p>(</span><span class=n>p</span><span class=p>);</span>    
<a id=__codelineno-52-26 name=__codelineno-52-26></a><a href=#__codelineno-52-26><span class=linenos data-linenos="26 "></span></a>    <span class=n>p</span><span class=p>.</span><span class=na>writeToParcel</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=n>parcelableFlags</span><span class=p>);</span>
<a id=__codelineno-52-27 name=__codelineno-52-27></a><a href=#__codelineno-52-27><span class=linenos data-linenos="27 "></span></a><span class=p>}</span>
</code></pre></div> 就是在一个for循环里给map的key和value依次写到parcel。因为Bitmap是Parcelable的，所以我们只关注这个分支，这又调到了Bitmap的writeToParcel函数。 <div class=highlight><pre><span></span><code><a id=__codelineno-53-1 name=__codelineno-53-1></a><a href=#__codelineno-53-1><span class=linenos data-linenos="1 "></span></a><span class=kt>void</span> <span class=nf>writeParcelable</span><span class=p>(</span><span class=n>Parcelable</span> <span class=n>p</span><span class=p>,</span> <span class=kt>int</span> <span class=n>parcelableFlags</span><span class=p>)</span> <span class=p>{</span>    
<a id=__codelineno-53-2 name=__codelineno-53-2></a><a href=#__codelineno-53-2><span class=linenos data-linenos="2 "></span></a>    <span class=n>writeParcelableCreator</span><span class=p>(</span><span class=n>p</span><span class=p>);</span>    
<a id=__codelineno-53-3 name=__codelineno-53-3></a><a href=#__codelineno-53-3><span class=linenos data-linenos="3 "></span></a>    <span class=n>p</span><span class=p>.</span><span class=na>writeToParcel</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=n>parcelableFlags</span><span class=p>);</span>
<a id=__codelineno-53-4 name=__codelineno-53-4></a><a href=#__codelineno-53-4><span class=linenos data-linenos="4 "></span></a><span class=p>}</span>
</code></pre></div> 进入了native层 <div class=highlight><pre><span></span><code><a id=__codelineno-54-1 name=__codelineno-54-1></a><a href=#__codelineno-54-1><span class=linenos data-linenos=" 1 "></span></a><span class=n>jboolean</span> <span class=nf>Bitmap_writeToParcel</span><span class=p>(</span><span class=n>JNIEnv</span><span class=o>*</span> <span class=n>env</span><span class=p>,</span> <span class=n>jobject</span><span class=p>,</span> <span class=p>...)</span> <span class=p>{</span>    
<a id=__codelineno-54-2 name=__codelineno-54-2></a><a href=#__codelineno-54-2><span class=linenos data-linenos=" 2 "></span></a>    <span class=n>android</span><span class=p>::</span><span class=n>Bitmap</span><span class=o>*</span> <span class=n>androidBitmap</span> <span class=o>=</span> <span class=n>reinterpret_cast</span><span class=o>&lt;</span><span class=n>Bitmap</span><span class=o>*&gt;</span><span class=p>(</span><span class=n>bitmapHandle</span><span class=p>);</span>    
<a id=__codelineno-54-3 name=__codelineno-54-3></a><a href=#__codelineno-54-3><span class=linenos data-linenos=" 3 "></span></a>    <span class=n>androidBitmap</span><span class=o>-&gt;</span><span class=n>getSkBitmap</span><span class=p>(</span><span class=o>&amp;</span><span class=n>bitmap</span><span class=p>);</span>  
<a id=__codelineno-54-4 name=__codelineno-54-4></a><a href=#__codelineno-54-4><span class=linenos data-linenos=" 4 "></span></a>
<a id=__codelineno-54-5 name=__codelineno-54-5></a><a href=#__codelineno-54-5><span class=linenos data-linenos=" 5 "></span></a>    <span class=c1>// 往parcel里写Bitmap的各种配置参数    </span>
<a id=__codelineno-54-6 name=__codelineno-54-6></a><a href=#__codelineno-54-6><span class=linenos data-linenos=" 6 "></span></a>    <span class=kt>int</span> <span class=n>fd</span> <span class=o>=</span> <span class=n>androidBitmap</span><span class=o>-&gt;</span><span class=n>getAshmemFd</span><span class=p>();</span>    
<a id=__codelineno-54-7 name=__codelineno-54-7></a><a href=#__codelineno-54-7><span class=linenos data-linenos=" 7 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>fd</span> <span class=o>&gt;=</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>isMutable</span> <span class=o>&amp;&amp;</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>allowFds</span><span class=p>())</span> <span class=p>{</span>        
<a id=__codelineno-54-8 name=__codelineno-54-8></a><a href=#__codelineno-54-8><span class=linenos data-linenos=" 8 "></span></a>        <span class=n>status</span> <span class=o>=</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>writeDupImmutableBlobFileDescriptor</span><span class=p>(</span><span class=n>fd</span><span class=p>);</span>        
<a id=__codelineno-54-9 name=__codelineno-54-9></a><a href=#__codelineno-54-9><span class=linenos data-linenos=" 9 "></span></a>        <span class=k>return</span> <span class=n>JNI_TRUE</span><span class=p>;</span>    
<a id=__codelineno-54-10 name=__codelineno-54-10></a><a href=#__codelineno-54-10><span class=linenos data-linenos="10 "></span></a>    <span class=p>}</span>    
<a id=__codelineno-54-11 name=__codelineno-54-11></a><a href=#__codelineno-54-11><span class=linenos data-linenos="11 "></span></a>
<a id=__codelineno-54-12 name=__codelineno-54-12></a><a href=#__codelineno-54-12><span class=linenos data-linenos="12 "></span></a>    <span class=nl>android</span><span class=p>::</span><span class=n>Parcel</span><span class=p>::</span><span class=n>WritableBlob</span> <span class=n>blob</span><span class=p>;</span>    
<a id=__codelineno-54-13 name=__codelineno-54-13></a><a href=#__codelineno-54-13><span class=linenos data-linenos="13 "></span></a>    <span class=n>status</span> <span class=o>=</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>writeBlob</span><span class=p>(</span><span class=n>size</span><span class=p>,</span> <span class=n>mutableCopy</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>blob</span><span class=p>);</span>    
<a id=__codelineno-54-14 name=__codelineno-54-14></a><a href=#__codelineno-54-14><span class=linenos data-linenos="14 "></span></a>    <span class=kd>const</span> <span class=kt>void</span><span class=o>*</span> <span class=n>pSrc</span> <span class=o>=</span>  <span class=n>bitmap</span><span class=p>.</span><span class=na>getPixels</span><span class=p>();</span>    
<a id=__codelineno-54-15 name=__codelineno-54-15></a><a href=#__codelineno-54-15><span class=linenos data-linenos="15 "></span></a>    <span class=n>memcpy</span><span class=p>(</span><span class=n>blob</span><span class=p>.</span><span class=na>data</span><span class=p>(),</span> <span class=n>pSrc</span><span class=p>,</span> <span class=n>size</span><span class=p>);</span>
<a id=__codelineno-54-16 name=__codelineno-54-16></a><a href=#__codelineno-54-16><span class=linenos data-linenos="16 "></span></a><span class=p>}</span>
</code></pre></div> 这里首先拿到native层的Bitmap对象，叫androidBitmap，然后拿到对应的SkBitmap。先看bitmap里带不带ashmemFd，如果带，并且这个Bitmap不能改，并且Parcel是允许带fd的话，就给fd写到parcel里，然后返回。否则的话继续往下，先有个WriteBlob对象，通过writeBlob函数给这个blob在parcel里分配了一块空间，然后给bitmap拷贝到这块空间里。我们看这个writeBlob函数。 <div class=highlight><pre><span></span><code><a id=__codelineno-55-1 name=__codelineno-55-1></a><a href=#__codelineno-55-1><span class=linenos data-linenos=" 1 "></span></a><span class=n>status_t</span> <span class=n>Parcel</span><span class=p>::</span><span class=n>writeBlob</span><span class=p>(</span><span class=n>size_t</span> <span class=n>len</span><span class=p>,</span> <span class=n>bool</span> <span class=n>mutableCopy</span><span class=p>,</span> <span class=n>WritableBlob</span><span class=o>*</span> <span class=n>outBlob</span><span class=p>)</span> <span class=p>{</span>    
<a id=__codelineno-55-2 name=__codelineno-55-2></a><a href=#__codelineno-55-2><span class=linenos data-linenos=" 2 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>mAllowFds</span> <span class=o>||</span> <span class=n>len</span> <span class=o>&lt;=</span> <span class=n>BLOB_INPLACE_LIMIT</span><span class=p>)</span> <span class=p>{</span>        
<a id=__codelineno-55-3 name=__codelineno-55-3></a><a href=#__codelineno-55-3><span class=linenos data-linenos=" 3 "></span></a>        <span class=n>status</span> <span class=o>=</span> <span class=n>writeInt32</span><span class=p>(</span><span class=n>BLOB_INPLACE</span><span class=p>);</span>        
<a id=__codelineno-55-4 name=__codelineno-55-4></a><a href=#__codelineno-55-4><span class=linenos data-linenos=" 4 "></span></a>        <span class=kt>void</span><span class=o>*</span> <span class=n>ptr</span> <span class=o>=</span> <span class=n>writeInplace</span><span class=p>(</span><span class=n>len</span><span class=p>);</span>        
<a id=__codelineno-55-5 name=__codelineno-55-5></a><a href=#__codelineno-55-5><span class=linenos data-linenos=" 5 "></span></a>        <span class=n>outBlob</span><span class=o>-&gt;</span><span class=n>init</span><span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=n>ptr</span><span class=p>,</span> <span class=n>len</span><span class=p>,</span> <span class=kc>false</span><span class=p>);</span>        
<a id=__codelineno-55-6 name=__codelineno-55-6></a><a href=#__codelineno-55-6><span class=linenos data-linenos=" 6 "></span></a>        <span class=k>return</span> <span class=n>NO_ERROR</span><span class=p>;</span>    
<a id=__codelineno-55-7 name=__codelineno-55-7></a><a href=#__codelineno-55-7><span class=linenos data-linenos=" 7 "></span></a>    <span class=p>}</span>    
<a id=__codelineno-55-8 name=__codelineno-55-8></a><a href=#__codelineno-55-8><span class=linenos data-linenos=" 8 "></span></a>    <span class=kt>int</span> <span class=n>fd</span> <span class=o>=</span> <span class=n>ashmem_create_region</span><span class=p>(</span><span class=s>&quot;Parcel Blob&quot;</span><span class=p>,</span> <span class=n>len</span><span class=p>);</span>    
<a id=__codelineno-55-9 name=__codelineno-55-9></a><a href=#__codelineno-55-9><span class=linenos data-linenos=" 9 "></span></a>    <span class=kt>void</span><span class=o>*</span> <span class=n>ptr</span> <span class=o>=</span> <span class=n>mmap</span><span class=p>(</span><span class=n>NULL</span><span class=p>,</span> <span class=n>len</span><span class=p>,</span> <span class=p>...,</span> <span class=n>MAP_SHARED</span><span class=p>,</span> <span class=n>fd</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>    
<a id=__codelineno-55-10 name=__codelineno-55-10></a><a href=#__codelineno-55-10><span class=linenos data-linenos="10 "></span></a>    <span class=p>......</span>    
<a id=__codelineno-55-11 name=__codelineno-55-11></a><a href=#__codelineno-55-11><span class=linenos data-linenos="11 "></span></a>    <span class=n>status</span> <span class=o>=</span> <span class=n>writeFileDescriptor</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=kc>true</span><span class=p>);</span>    
<a id=__codelineno-55-12 name=__codelineno-55-12></a><a href=#__codelineno-55-12><span class=linenos data-linenos="12 "></span></a>    <span class=n>outBlob</span><span class=o>-&gt;</span><span class=n>init</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>ptr</span><span class=p>,</span> <span class=n>len</span><span class=p>,</span> <span class=n>mutableCopy</span><span class=p>);</span>    
<a id=__codelineno-55-13 name=__codelineno-55-13></a><a href=#__codelineno-55-13><span class=linenos data-linenos="13 "></span></a>    <span class=k>return</span> <span class=n>NO_ERROR</span><span class=p>;</span>
<a id=__codelineno-55-14 name=__codelineno-55-14></a><a href=#__codelineno-55-14><span class=linenos data-linenos="14 "></span></a><span class=p>}</span>
</code></pre></div> 这个writeBlob函数，首先看如果不允许带fd，或者这个数据小于16K，就直接在parcel的缓冲区里分配一块空间来保存这个数据。不然的话呢，就另外开辟一个ashmem，映射出一块内存，数据就保存在ashmem的内存里，parcel里只写个fd就好了，这样就算数据量很大，parcel自己的缓冲区也不用很大。</p> <p>看到这里就明白了，其实还有用了Ashmen机制。</p> <h1 id=_12>参考<a class=headerlink href=#_12 title="Anchor link to this section for reference">&para;</a></h1> <p><a href=https://my.oschina.net/youranhongcha/blog/3075518>Ashmem机制讲解</a> <a href=https://www.jianshu.com/p/d9bc9c668ba6>Android匿名共享内存（Ashmem）原理</a></p> <hr> <div class=md-source-file> <small> Last update: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">February 14, 2022</span> </small> </div> <!-- Giscus --> <h2 id=__comments>Comments</h2> <script src=https://giscus.app/client.js data-repo=wzasd/wzasd.github.io data-repo-id="MDEwOlJlcG9zaXRvcnk2NTQ0MDY0OA==" data-category=General data-category-id=DIC_kwDOA-aLiM4CA5Qt data-mapping=pathname data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=dark data-lang=zh-CN crossorigin=anonymous async>
</script> <!-- Replace with generated snippet --> <!-- Reload on palette change --> <script>
    var palette = __md_get("__palette")
    if (palette && typeof palette.color === "object")
      if (palette.color.scheme === "slate") {
        var giscus = document.querySelector("script[src*=giscus]")
        giscus.setAttribute("data-theme", "dark") // (1)!
      }

    /* Register event handlers after documented loaded */
    document.addEventListener("DOMContentLoaded", function() {
      var ref = document.querySelector("[data-md-component=palette]")
      ref.addEventListener("change", function() {
        var palette = __md_get("__palette")
        if (palette && typeof palette.color === "object") {
          var theme = palette.color.scheme === "slate" ? "dark" : "light"

          /* Instruct Giscus to change theme */
          var frame = document.querySelector(".giscus-frame")
          frame.contentWindow.postMessage(
            { giscus: { setConfig: { theme } } },
            "https://giscus.app"
          )
        }
      })
    })
  </script> <span id=busuanzi_container_site_uv>本站访客数<span id=busuanzi_value_site_uv></span>人次</span> </article> </div> </div> <a href=# class="md-top md-icon" data-md-component=top data-md-state=hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"/></svg> Back to top </a> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../../framework/binder2/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Binder深入理解——罗老师系列" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> Binder深入理解——罗老师系列 </div> </div> </a> <a href=../LocalSocket%EF%BC%8CSocket%20Websocket%20Http%2CP2P%E7%AD%89%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%28%E6%AD%A5%E9%AA%A4%29%EF%BC%88Demo%EF%BC%89/ class="md-footer__link md-footer__link--next" aria-label="Next: LocalSocket，Socket Websocket Http,P2P等网络编程(步骤)（Demo）" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Next </span> LocalSocket，Socket Websocket Http,P2P等网络编程(步骤)（Demo） </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2015 - 2021 wzasd </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/wzasd target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33.85 0 1.71.11 2.5.33 1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2z"/></svg> </a> <a href=jeffrey@outlook.com target=_blank rel=noopener title class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m20 8-8 5-8-5V6l8 5 8-5m0-2H4c-1.11 0-2 .89-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../..", "features": ["navigation.instant", "navigation.tracking", "navigation.tabs", "navigation.indexes", "navigation.top", "toc.integrate", "search.suggest", "search.highlight"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../../assets/javascripts/workers/search.092fa1f6.min.js"}</script> <script src=../../../assets/javascripts/bundle.5a9542cf.min.js></script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script> <script src=../../../assets/js/busuanzi.pure.mini.js></script> </body> </html>