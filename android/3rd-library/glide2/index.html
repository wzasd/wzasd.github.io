<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link href=https://blog.founicy.top/android/3rd-library/glide2/ rel=canonical><link rel=icon href=../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.2.3, mkdocs-material-8.1.11"><title>Glide v4 æºç è§£æï¼ˆäºŒï¼‰ - wzasd's world</title><link rel=stylesheet href=../../../assets/stylesheets/main.50e68009.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.e6a45f82.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>:root{--md-text-font:"";--md-code-font:"Roboto Mono"}</style><script>__md_scope=new URL("../../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-Q6FXPH6HVX"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&gtag("event","search",{search_term:this.value})}),"undefined"!=typeof location$&&location$.subscribe(function(e){gtag("config","G-Q6FXPH6HVX",{page_path:e.pathname})})})</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-Q6FXPH6HVX"></script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=white data-md-color-accent=blue> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#1-glidewith class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../../.. title="wzasd's world" class="md-header__button md-logo" aria-label="wzasd's world" data-md-component=logo> <img src=../../../assets/images/favicon.webp alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> wzasd's world </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Glide v4 æºç è§£æï¼ˆäºŒï¼‰ </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=white data-md-color-accent=blue aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary=black data-md-color-accent=deep-orange aria-label="Switch to light mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3z"/></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../3rd-library-source-code/ class="md-tabs__link md-tabs__link--active"> Android </a> </li> <li class=md-tabs__item> <a href=../../../flutter/flutter_first_project_1/ class=md-tabs__link> Flutter </a> </li> <li class=md-tabs__item> <a href=../../../leetcode/ class=md-tabs__link> LeetCode </a> </li> <li class=md-tabs__item> <a href=../../../design-pattern/design-pattern/ class=md-tabs__link> Books </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../.. title="wzasd's world" class="md-nav__button md-logo" aria-label="wzasd's world" data-md-component=logo> <img src=../../../assets/images/favicon.webp alt=logo> </a> wzasd's world </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1 type=checkbox id=__nav_1 checked> <label class=md-nav__link for=__nav_1> Android <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Android data-md-level=1> <label class=md-nav__title for=__nav_1> <span class="md-nav__icon md-icon"></span> Android </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1_1 type=checkbox id=__nav_1_1 checked> <label class=md-nav__link for=__nav_1_1> ä¸‰æ–¹åº“ç³»åˆ— <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=ä¸‰æ–¹åº“ç³»åˆ— data-md-level=2> <label class=md-nav__title for=__nav_1_1> <span class="md-nav__icon md-icon"></span> ä¸‰æ–¹åº“ç³»åˆ— </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../3rd-library-source-code/ class=md-nav__link> Androidä¸‰æ–¹åº“æºç åˆ†æ </a> </li> <li class=md-nav__item> <a href=../matrix/ class=md-nav__link> å¾®ä¿¡APM Matrixè§£æ </a> </li> <li class=md-nav__item> <a href=../matrix-trace/ class=md-nav__link> Matrix-TraceCanaryè§£æ </a> </li> <li class=md-nav__item> <a href=../matrix-io/ class=md-nav__link> Matrix-IOCanaryè§£æ </a> </li> <li class=md-nav__item> <a href=../matrix-resource/ class=md-nav__link> Matrix-ResourceCanaryè§£æ </a> </li> <li class=md-nav__item> <a href=../matrix-sqlitelint/ class=md-nav__link> Matrix-SQLiteLintè§£æ </a> </li> <li class=md-nav__item> <a href=../okhttp/ class=md-nav__link> OkHttp3æºç è§£æ </a> </li> <li class=md-nav__item> <a href=../retrofit/ class=md-nav__link> Retrofit2æºç è§£æ </a> </li> <li class=md-nav__item> <a href=../rxjava%26rxandroid/ class=md-nav__link> RxJavaæºç è§£æåŠä½¿ç”¨å®ä¾‹ </a> </li> <li class=md-nav__item> <a href=../../other/RxJava/ class=md-nav__link> RxJavaæ“ä½œç¬¦å¤§å…¨ </a> </li> <li class=md-nav__item> <a href=../glide1/ class=md-nav__link> Glide v4 æºç è§£æï¼ˆä¸€ï¼‰ </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Glide v4 æºç è§£æï¼ˆäºŒï¼‰ <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> Glide v4 æºç è§£æï¼ˆäºŒï¼‰ </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#1-glidewith class=md-nav__link> 1. Glide.with </a> <nav class=md-nav aria-label="1. Glide.with"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#11-getretrievercontext class=md-nav__link> 1.1 getRetriever(Context) </a> </li> <li class=md-nav__item> <a href=#12-requestmanagerretrieverget class=md-nav__link> 1.2 RequestManagerRetriever.get </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#2-requestmanagerload class=md-nav__link> 2. RequestManager.load </a> <nav class=md-nav aria-label="2. RequestManager.load"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#21-requestmanagerasxxx class=md-nav__link> 2.1 RequestManager.asXxx </a> </li> <li class=md-nav__item> <a href=#22-requestbuilderload class=md-nav__link> 2.2 RequestBuilder.load </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#3-requestbuilderinto class=md-nav__link> 3. RequestBuilder.into </a> <nav class=md-nav aria-label="3. RequestBuilder.into"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#31-buildrequest class=md-nav__link> 3.1 buildRequest </a> </li> <li class=md-nav__item> <a href=#32-requestmanagertrack class=md-nav__link> 3.2 RequestManager.track </a> </li> <li class=md-nav__item> <a href=#33-engineload class=md-nav__link> 3.3 Engine.load </a> </li> <li class=md-nav__item> <a href=#34-decodejobrun class=md-nav__link> 3.4 DecodeJob.run </a> </li> <li class=md-nav__item> <a href=#35-registry class=md-nav__link> 3.5 Registry </a> </li> <li class=md-nav__item> <a href=#36-resourcecachegenerator class=md-nav__link> 3.6 ResourceCacheGenerator </a> <nav class=md-nav aria-label="3.6 ResourceCacheGenerator"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#361-helpergetcachekeys class=md-nav__link> 3.6.1 helper.getCacheKeys </a> </li> <li class=md-nav__item> <a href=#362-dhgetregisteredresourceclasses class=md-nav__link> 3.6.2 DH.getRegisteredResourceClasses </a> </li> <li class=md-nav__item> <a href=#363 class=md-nav__link> 3.6.3 å¯»æ‰¾ç¼“å­˜æ–‡ä»¶å¹¶åŠ è½½ </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#37-datacachegenerator class=md-nav__link> 3.7 DataCacheGenerator </a> </li> <li class=md-nav__item> <a href=#38-sourcegenerator class=md-nav__link> 3.8 SourceGenerator </a> </li> <li class=md-nav__item> <a href=#39-decodejobfetcherreadycallback class=md-nav__link> 3.9 DecodeJob.FetcherReadyCallback </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../glide3/ class=md-nav__link> Glide v4 æºç è§£æï¼ˆä¸‰ï¼‰ </a> </li> <li class=md-nav__item> <a href=../glide4/ class=md-nav__link> Glide v4 æºç è§£æï¼ˆå››ï¼‰ </a> </li> <li class=md-nav__item> <a href=../glide5/ class=md-nav__link> Glide v4 æºç è§£æï¼ˆäº”ï¼‰ </a> </li> <li class=md-nav__item> <a href=../glide6/ class=md-nav__link> Glide v4 æºç è§£æï¼ˆå…­ï¼‰ </a> </li> <li class=md-nav__item> <a href=../glide7/ class=md-nav__link> Glide v4 æºç è§£æï¼ˆä¸ƒï¼‰ </a> </li> <li class=md-nav__item> <a href=../migrate-to-glide/ class=md-nav__link> æ‚è®°ï¼šä»Picassoè¿ç§»è‡³Glide </a> </li> <li class=md-nav__item> <a href=../eventbus/ class=md-nav__link> EventBusæºç è§£æ </a> </li> <li class=md-nav__item> <a href=../leakcanary/ class=md-nav__link> LeakCanary2æºç è§£æ </a> </li> <li class=md-nav__item> <a href=../permissiondispatcher/ class=md-nav__link> PermissionDispatcheræºç è§£æ </a> </li> <li class=md-nav__item> <a href=../../other/constraintlayout/ class=md-nav__link> ConstraintLayoutä½¿ç”¨å¤§å…¨ </a> </li> <li class=md-nav__item> <a href=../../other/dagger2/ class=md-nav__link> åˆå­¦è€…çš„Dagger2æ•™ç¨‹ </a> </li> <li class=md-nav__item> <a href=../hotfix/ class=md-nav__link> Hotfixæ–¹æ¡ˆåˆæ¢ </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1_2 type=checkbox id=__nav_1_2> <label class=md-nav__link for=__nav_1_2> frameworkç³»åˆ— <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=frameworkç³»åˆ— data-md-level=2> <label class=md-nav__title for=__nav_1_2> <span class="md-nav__icon md-icon"></span> frameworkç³»åˆ— </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../framework/Android%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%281%29/ class=md-nav__link> Activity </a> </li> <li class=md-nav__item> <a href=../../framework/Android%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%282%29/ class=md-nav__link> Service </a> </li> <li class=md-nav__item> <a href=../../framework/Android%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%283%29/ class=md-nav__link> Broadcasts </a> </li> <li class=md-nav__item> <a href=../../framework/Android%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%284%29/ class=md-nav__link> Content Providersä¸Fragment </a> </li> <li class=md-nav__item> <a href=../../framework/IPC%E6%9C%BA%E5%88%B6/ class=md-nav__link> IPCæœºåˆ¶ </a> </li> <li class=md-nav__item> <a href=../../framework/View%E7%9A%84%E4%BA%8B%E4%BB%B6%E4%BD%93%E7%B3%BB/ class=md-nav__link> Viewçš„äº‹ä»¶ä½“ç³» </a> </li> <li class=md-nav__item> <a href=../../framework/View%E7%9A%84%E7%BB%98%E5%88%B6%E5%8E%9F%E7%90%86/ class=md-nav__link> Viewçš„ç»˜åˆ¶åŸç† </a> </li> <li class=md-nav__item> <a href=../../framework/RemoteViews/ class=md-nav__link> RemoteViews </a> </li> <li class=md-nav__item> <a href=../../framework/Drawable/ class=md-nav__link> Androidä¸­çš„Drawableèµ„æº </a> </li> <li class=md-nav__item> <a href=../../framework/Android%E5%8A%A8%E7%94%BB/ class=md-nav__link> AndroidåŠ¨ç”» </a> </li> <li class=md-nav__item> <a href=../../framework/Window%E4%B8%8EWindowManager/ class=md-nav__link> Windowä¸WindowManager </a> </li> <li class=md-nav__item> <a href=../../framework/%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/ class=md-nav__link> å››å¤§ç»„ä»¶å¯åŠ¨è¿‡ç¨‹ </a> </li> <li class=md-nav__item> <a href=../../framework/Android%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6/ class=md-nav__link> Androidæ¶ˆæ¯æœºåˆ¶ </a> </li> <li class=md-nav__item> <a href=../../framework/Android%E7%BA%BF%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0/ class=md-nav__link> Androidçº¿ç¨‹ä¸çº¿ç¨‹æ±  </a> </li> <li class=md-nav__item> <a href=../../framework/Bitmap%E7%9A%84%E7%BC%93%E5%AD%98%E4%B8%8E%E5%8A%A0%E8%BD%BD/ class=md-nav__link> Bitmapçš„ç¼“å­˜ä¸åŠ è½½ </a> </li> <li class=md-nav__item> <a href=../../framework/JNI%E4%B8%8ENDK/ class=md-nav__link> JNIä¸NDKç¼–ç¨‹ç®€ä»‹ </a> </li> <li class=md-nav__item> <a href=../../framework/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/ class=md-nav__link> Androidæ€§èƒ½ä¼˜åŒ– </a> </li> <li class=md-nav__item> <a href=../../framework/binder1-mediaservice/ class=md-nav__link> Binderæ·±å…¥ç†è§£â€”â€”ä»¥MediaServiceä¸ºä¾‹ </a> </li> <li class=md-nav__item> <a href=../../framework/binder2/ class=md-nav__link> Binderæ·±å…¥ç†è§£â€”â€”ç½—è€å¸ˆç³»åˆ— </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1_3 type=checkbox id=__nav_1_3> <label class=md-nav__link for=__nav_1_3> æ‚è®° <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=æ‚è®° data-md-level=2> <label class=md-nav__title for=__nav_1_3> <span class="md-nav__icon md-icon"></span> æ‚è®° </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../other/android-ipc-big-data/ class=md-nav__link> Ashmemç®€ä»‹ï¼ˆAndroid IPCä¼ è¾“å¤§æ•°æ®ï¼‰ </a> </li> <li class=md-nav__item> <a href=../../other/LocalSocket%EF%BC%8CSocket%20Websocket%20Http%2CP2P%E7%AD%89%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%28%E6%AD%A5%E9%AA%A4%29%EF%BC%88Demo%EF%BC%89/ class=md-nav__link> LocalSocketï¼ŒSocket Websocket Http,P2Pç­‰ç½‘ç»œç¼–ç¨‹(æ­¥éª¤)ï¼ˆDemoï¼‰ </a> </li> <li class=md-nav__item> <a href=../../other/commands/ class=md-nav__link> Androidå¼€å‘å¸¸è§å‘½ä»¤ </a> </li> <li class=md-nav__item> <a href=../../other/android-tv/ class=md-nav__link> Android TV ä¸“é¡¹ </a> </li> <li class=md-nav__item> <a href=../../other/annotation/ class=md-nav__link> æ³¨è§£çš„å®šä¹‰åŠè§£æ </a> </li> <li class=md-nav__item> <a href=../../other/best_throttle_in_mvvm/ class=md-nav__link> è¿™å¯èƒ½æ˜¯MVVMä¸­æœ€ä¼˜é›…çš„æŒ‰é”®é˜²æŠ–æ–¹æ¡ˆ </a> </li> <li class=md-nav__item> <a href=../../other/android-jenkins/ class=md-nav__link> Jenkins for android </a> </li> <li class=md-nav__item> <a href=../../other/SystemProrities/ class=md-nav__link> æ™®é€šAndroidç¨‹åºä½¿ç”¨SystemProrities </a> </li> <li class=md-nav__item> <a href=../../other/recyclerview-cache/ class=md-nav__link> ListViewã€RecyclerViewç¼“å­˜ç­–ç•¥è§£æ </a> </li> <li class=md-nav__item> <a href=../../other/recyclerview-item-docoration/ class=md-nav__link> RecyclerViewé«˜çº§ç‰¹æ€§â€”â€”ItemDecoration </a> </li> <li class=md-nav__item> <a href=../../other/recyclerview-others/ class=md-nav__link> RecyclerViewçš„ä¸€äº›ä½¿ç”¨ç»†èŠ‚ </a> </li> <li class=md-nav__item> <a href=../../other/RecyclerView-Sort%26Delete/ class=md-nav__link> RecyclerViewé«˜çº§ç‰¹æ€§â€”â€”æ‹–æ‹½æ’åºä»¥åŠæ»‘åŠ¨åˆ é™¤ </a> </li> <li class=md-nav__item> <a href=../../other/FAB-Behavior/ class=md-nav__link> FloatingActionButtonä¸Šæ»‘éšè—ä¸‹æ»‘æ˜¾ç¤º </a> </li> <li class=md-nav__item> <a href=../../other/nestedscrolling/ class=md-nav__link> NestedScrollingæœºåˆ¶ </a> </li> <li class=md-nav__item> <a href=../../other/porterduff/ class=md-nav__link> ä½¿ç”¨Porter-Duffåˆæˆæ•°å­—å›¾åƒ </a> </li> <li class=md-nav__item> <a href=../../other/runtime/ class=md-nav__link> Android Runtime </a> </li> <li class=md-nav__item> <a href=../../other/android_alias/ class=md-nav__link> Androidé©¬ç”²åŒ…çš„é‚£äº›äº‹å„¿ </a> </li> <li class=md-nav__item> <a href=../../other/Android-Development-Tool/ class=md-nav__link> Androidç¥å…µåˆ©å™¨ </a> </li> <li class=md-nav__item> <a href=../../other/FileProvider/ class=md-nav__link> FileProvider </a> </li> <li class=md-nav__item> <a href=../../other/Android%E5%88%A4%E6%96%AD%E5%AF%BC%E8%88%AA%E6%A0%8F%E9%AB%98%E5%BA%A6/ class=md-nav__link> Androidåˆ¤æ–­è™šæ‹ŸæŒ‰é”®(å¯¼èˆªæ )æ˜¾ç¤ºä¸å¦ã€é«˜åº¦ä»¥åŠè·å–å±å¹•å®é™…é«˜åº¦ </a> </li> <li class=md-nav__item> <a href=../../other/Android%E5%9B%BE%E7%89%87%E9%80%89%E6%8B%A9%E5%99%A8/ class=md-nav__link> Androidå›¾ç‰‡é€‰æ‹©å™¨ </a> </li> <li class=md-nav__item> <a href=../../other/Android%E5%BA%95%E9%83%A8%E5%AF%BC%E8%88%AA%E6%A0%8F%E6%A1%86%E6%9E%B6/ class=md-nav__link> AndroidåŸç”Ÿåº•éƒ¨å¯¼èˆªæ  </a> </li> <li class=md-nav__item> <a href=../../other/Android%E6%90%9C%E7%B4%A2%E6%A0%8F%E7%9A%84%E5%AE%9E%E7%8E%B0/ class=md-nav__link> Androidæœç´¢æ çš„å®ç° </a> </li> <li class=md-nav__item> <a href=../../other/Android%E6%9A%82%E5%81%9C%E9%9F%B3%E4%B9%90%E6%92%AD%E6%94%BE%E5%99%A8%E7%9A%84%E6%92%AD%E6%94%BE/ class=md-nav__link> Androidæš‚åœé…·ç‹—ã€ç½‘æ˜“äº‘éŸ³ä¹ç­‰éŸ³ä¹æ’­æ”¾å™¨çš„æ’­æ”¾ </a> </li> <li class=md-nav__item> <a href=../../other/Android%E6%BB%91%E5%8A%A8%E8%BF%94%E5%9B%9E%E5%AE%9E%E8%B7%B5/ class=md-nav__link> Androidæ»‘åŠ¨è¿”å›å®è·µ </a> </li> <li class=md-nav__item> <a href=../../other/Android%E7%A8%8B%E5%BA%8F%E5%8F%8D%E7%BC%96%E8%AF%91/ class=md-nav__link> MacOSä¸‹Androidç¨‹åºåç¼–è¯‘ </a> </li> <li class=md-nav__item> <a href=../../other/Android%E9%80%9A%E8%AE%AF%E5%BD%95%E5%BF%AB%E9%80%9F%E8%AF%BB%E5%8F%96/ class=md-nav__link> Androidé€šè®¯å½•å¿«é€Ÿè¯»å– </a> </li> <li class=md-nav__item> <a href=../../other/soft-keyboard-in-app/ class=md-nav__link> Appå†…è‡ªå®šä¹‰è½¯é”®ç›˜ </a> </li> <li class=md-nav__item> <a href=../../other/%E8%85%BE%E8%AE%AFX5%E5%86%85%E6%A0%B8%E5%85%A5%E5%9D%91%E6%8C%87%E5%8D%97/ class=md-nav__link> è…¾è®¯TBS X5æµè§ˆå™¨å†…æ ¸å…¥å‘æŒ‡å— </a> </li> <li class=md-nav__item> <a href=../../other/%E7%90%90%E7%A2%8E%E7%9F%A5%E8%AF%86%E7%82%B9/ class=md-nav__link> çç¢çŸ¥è¯†ç‚¹ </a> </li> <li class=md-nav__item> <a href=../../other/%E7%90%90%E7%A2%8E%E7%9F%A5%E8%AF%86%E7%82%B92/ class=md-nav__link> çç¢çŸ¥è¯†ç‚¹2 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week1-synchronized/ class=md-nav__link> ç†è§£Javaä¸­synchronizedå…³é”®è¯ </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week2-service/ class=md-nav__link> ç†è§£Service </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week3-activity/ class=md-nav__link> ç†è§£Activityçš„å¯åŠ¨æ¨¡å¼ </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week4-startActivityForResult/ class=md-nav__link> å…³äºstartActivityForResult </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week5-view/ class=md-nav__link> å…³äºViewçš„çŸ¥è¯† </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week6-gradle/ class=md-nav__link> å…³äºGradleçš„çŸ¥è¯† </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week7-serialization/ class=md-nav__link> å…³äºåºåˆ—åŒ–çš„çŸ¥è¯† </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week10-classloader/ class=md-nav__link> Androidä¸­çš„ClassLoader </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week11-binder/ class=md-nav__link> Binderç®€ä»‹ </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week12-retrofit-okhttp/ class=md-nav__link> OkHttpå’ŒRetrofitçš„ä½œç”¨ä»¥åŠä¸¤è€…ä¹‹é—´çš„è”ç³» </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week14-jvm-gc/ class=md-nav__link> JVMä¸­åƒåœ¾å›æ”¶ç­–ç•¥ </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week16-keep-app-alive/ class=md-nav__link> è¿›ç¨‹ä¿æ´» </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week17-android-components/ class=md-nav__link> å››å¤§ç»„ä»¶çš„ä½œç”¨ä»¥åŠå¤šè¿›ç¨‹ </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week20-network-protocol/ class=md-nav__link> ç½‘ç»œåè®® </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week21-mvc%26mvp%26mvvm/ class=md-nav__link> MVCã€MVPå’ŒMVVM </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week22-android-studio-build/ class=md-nav__link> Android Studio buildè¿‡ç¨‹ </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week23-load-large-bitmap/ class=md-nav__link> å¤§å°ºå¯¸å›¾ç‰‡åŠ è½½é—®é¢˜ </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1_4 type=checkbox id=__nav_1_4> <div class="md-nav__link md-nav__link--index "> <a href=../../paid/master/ >Androidå¼€å‘é«˜æ‰‹è¯¾</a> <label for=__nav_1_4> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label=Androidå¼€å‘é«˜æ‰‹è¯¾ data-md-level=2> <label class=md-nav__title for=__nav_1_4> <span class="md-nav__icon md-icon"></span> Androidå¼€å‘é«˜æ‰‹è¯¾ </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../paid/master/crash_1/ class=md-nav__link> 01 | å´©æºƒä¼˜åŒ–ï¼ˆä¸Šï¼‰ï¼šå…³äºâ€œå´©æºƒâ€é‚£äº›äº‹å„¿ </a> </li> <li class=md-nav__item> <a href=../../paid/master/crash_2/ class=md-nav__link> 02 | å´©æºƒä¼˜åŒ–ï¼ˆä¸‹ï¼‰ï¼šåº”ç”¨å´©æºƒäº†ï¼Œä½ åº”è¯¥å¦‚ä½•å»åˆ†æï¼Ÿ </a> </li> <li class=md-nav__item> <a href=../../paid/master/memory_1/ class=md-nav__link> 03 | å†…å­˜ä¼˜åŒ–ï¼ˆä¸Šï¼‰ï¼š4GBå†…å­˜æ—¶ä»£ï¼Œå†è°ˆå†…å­˜ä¼˜åŒ– </a> </li> <li class=md-nav__item> <a href=../../paid/master/memory_2/ class=md-nav__link> 04 | å†…å­˜ä¼˜åŒ–ï¼ˆä¸‹ï¼‰ï¼šå†…å­˜ä¼˜åŒ–è¿™ä»¶äº‹ï¼Œåº”è¯¥ä»å“ªé‡Œç€æ‰‹ï¼Ÿ </a> </li> <li class=md-nav__item> <a href=../../paid/master/stuck_1/ class=md-nav__link> 05 | å¡é¡¿ä¼˜åŒ–ï¼ˆä¸Šï¼‰ï¼šä½ è¦æŒæ¡çš„å¡é¡¿åˆ†ææ–¹æ³• </a> </li> <li class=md-nav__item> <a href=../../paid/master/stuck_2/ class=md-nav__link> 06 | å¡é¡¿ä¼˜åŒ–ï¼ˆä¸‹ï¼‰ï¼šå¦‚ä½•ç›‘æ§åº”ç”¨å¡é¡¿ï¼Ÿ </a> </li> <li class=md-nav__item> <a href=../../paid/master/stuck_3/ class=md-nav__link> 06è¡¥å……ç¯‡ | å¡é¡¿ä¼˜åŒ–ï¼šå¡é¡¿ç°åœºä¸å¡é¡¿åˆ†æ </a> </li> <li class=md-nav__item> <a href=../../paid/master/start_1/ class=md-nav__link> 07 | å¯åŠ¨ä¼˜åŒ–ï¼ˆä¸Šï¼‰ï¼šä»å¯åŠ¨è¿‡ç¨‹çœ‹å¯åŠ¨é€Ÿåº¦ä¼˜åŒ– </a> </li> <li class=md-nav__item> <a href=../../paid/master/start_2/ class=md-nav__link> 08 | å¯åŠ¨ä¼˜åŒ–ï¼ˆä¸‹ï¼‰ï¼šä¼˜åŒ–å¯åŠ¨é€Ÿåº¦çš„è¿›é˜¶æ–¹æ³• </a> </li> <li class=md-nav__item> <a href=../../paid/master/io_1/ class=md-nav__link> 09 | I/Oä¼˜åŒ–ï¼ˆä¸Šï¼‰ï¼šå¼€å‘å·¥ç¨‹å¸ˆå¿…å¤‡çš„I/Oä¼˜åŒ–çŸ¥è¯† </a> </li> <li class=md-nav__item> <a href=../../paid/master/io_2/ class=md-nav__link> 10 | I/Oä¼˜åŒ–ï¼ˆä¸­ï¼‰ï¼šä¸åŒI/Oæ–¹å¼çš„ä½¿ç”¨åœºæ™¯æ˜¯ä»€ä¹ˆï¼Ÿ </a> </li> <li class=md-nav__item> <a href=../../paid/master/io_3/ class=md-nav__link> 11 | I/Oä¼˜åŒ–ï¼ˆä¸‹ï¼‰ï¼šå¦‚ä½•ç›‘æ§çº¿ä¸ŠI/Oæ“ä½œï¼Ÿ </a> </li> <li class=md-nav__item> <a href=../../paid/master/storage_1/ class=md-nav__link> 12 | å­˜å‚¨ä¼˜åŒ–ï¼ˆä¸Šï¼‰ï¼šå¸¸è§çš„æ•°æ®å­˜å‚¨æ–¹æ³•æœ‰å“ªäº›ï¼Ÿ </a> </li> <li class=md-nav__item> <a href=../../paid/master/storage_2/ class=md-nav__link> 13 | å­˜å‚¨ä¼˜åŒ–ï¼ˆä¸­ï¼‰ï¼šå¦‚ä½•ä¼˜åŒ–æ•°æ®å­˜å‚¨ï¼Ÿ </a> </li> <li class=md-nav__item> <a href=../../paid/master/storage_3/ class=md-nav__link> 14 | å­˜å‚¨ä¼˜åŒ–ï¼ˆä¸‹ï¼‰ï¼šæ•°æ®åº“SQLiteçš„ä½¿ç”¨å’Œä¼˜åŒ– </a> </li> <li class=md-nav__item> <a href=../../paid/master/network_1/ class=md-nav__link> 15 | ç½‘ç»œä¼˜åŒ–ï¼ˆä¸Šï¼‰ï¼šç§»åŠ¨å¼€å‘å·¥ç¨‹å¸ˆå¿…å¤‡çš„ç½‘ç»œä¼˜åŒ–çŸ¥è¯† </a> </li> <li class=md-nav__item> <a href=../../paid/master/network_2/ class=md-nav__link> 16 | ç½‘ç»œä¼˜åŒ–ï¼ˆä¸­ï¼‰ï¼šå¤æ‚å¤šå˜çš„ç§»åŠ¨ç½‘ç»œè¯¥å¦‚ä½•ä¼˜åŒ–ï¼Ÿ </a> </li> <li class=md-nav__item> <a href=../../paid/master/network_3/ class=md-nav__link> 17 | ç½‘ç»œä¼˜åŒ–ï¼ˆä¸‹ï¼‰ï¼šå¤§æ•°æ®ä¸‹ç½‘ç»œè¯¥å¦‚ä½•ç›‘æ§ï¼Ÿ </a> </li> <li class=md-nav__item> <a href=../../paid/master/battery_1/ class=md-nav__link> 18 | è€—ç”µä¼˜åŒ–ï¼ˆä¸Šï¼‰ï¼šä»ç”µé‡ä¼˜åŒ–çš„æ¼”è¿›çœ‹è€—ç”µåˆ†æ </a> </li> <li class=md-nav__item> <a href=../../paid/master/battery_2/ class=md-nav__link> 19 | è€—ç”µä¼˜åŒ–ï¼ˆä¸‹ï¼‰ï¼šè€—ç”µçš„ä¼˜åŒ–æ–¹æ³•ä¸çº¿ä¸Šç›‘æ§ </a> </li> <li class=md-nav__item> <a href=../../paid/master/ui_1/ class=md-nav__link> 20 | UI ä¼˜åŒ–ï¼ˆä¸Šï¼‰ï¼šUI æ¸²æŸ“çš„å‡ ä¸ªå…³é”®æ¦‚å¿µ </a> </li> <li class=md-nav__item> <a href=../../paid/master/ui_2/ class=md-nav__link> 21 | UI ä¼˜åŒ–ï¼ˆä¸‹ï¼‰ï¼šå¦‚ä½•ä¼˜åŒ– UI æ¸²æŸ“ï¼Ÿ </a> </li> <li class=md-nav__item> <a href=../../paid/master/package_1/ class=md-nav__link> 22 | åŒ…ä½“ç§¯ä¼˜åŒ–ï¼ˆä¸Šï¼‰ï¼šå¦‚ä½•å‡å°‘å®‰è£…åŒ…å¤§å°ï¼Ÿ </a> </li> <li class=md-nav__item> <a href=../../paid/master/package_2/ class=md-nav__link> 23 | åŒ…ä½“ç§¯ä¼˜åŒ–ï¼ˆä¸‹ï¼‰ï¼šèµ„æºä¼˜åŒ–çš„è¿›é˜¶å®è·µ </a> </li> <li class=md-nav__item> <a href=../../paid/master/compile/ class=md-nav__link> 26 | å…³äºç¼–è¯‘ï¼Œä½ éœ€è¦äº†è§£ä»€ä¹ˆï¼Ÿ </a> </li> <li class=md-nav__item> <a href=../../paid/master/bytecode/ class=md-nav__link> 27 | ç¼–è¯‘æ’æ¡©çš„ä¸‰ç§æ–¹æ³•ï¼šAspectJã€ASMã€ReDex </a> </li> <li class=md-nav__item> <a href=../../paid/master/native_hook/ class=md-nav__link> 35 | Native Hook æŠ€æœ¯ï¼Œå¤©ä½¿è¿˜æ˜¯é­”é¬¼ï¼Ÿ </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2 type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2> Flutter <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Flutter data-md-level=1> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Flutter </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_1/ class=md-nav__link> å¹´è½»äººçš„ç¬¬ä¸€ä¸ªFlutterç¨‹åº(1) </a> </li> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_2/ class=md-nav__link> å¹´è½»äººçš„ç¬¬ä¸€ä¸ªFlutterç¨‹åº(2) </a> </li> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_3/ class=md-nav__link> å¹´è½»äººçš„ç¬¬ä¸€ä¸ªFlutterç¨‹åº(3) </a> </li> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_4/ class=md-nav__link> å¹´è½»äººçš„ç¬¬ä¸€ä¸ªFlutterç¨‹åº(4) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3 type=checkbox id=__nav_3> <div class="md-nav__link md-nav__link--index "> <a href=../../../leetcode/ >LeetCode</a> <label for=__nav_3> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label=LeetCode data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> LeetCode </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_1/ class=md-nav__link> æ•°æ®ç»“æ„ã€ç®—æ³•å’Œæ•°æ®æ“ä½œ </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_3/ class=md-nav__link> é«˜è´¨é‡çš„ä»£ç  </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_4/ class=md-nav__link> è§£å†³é—®é¢˜çš„æ€è·¯ </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_5/ class=md-nav__link> ä¼˜åŒ–æ—¶é—´å’Œç©ºé—´æ•ˆç‡ </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_6/ class=md-nav__link> é¢è¯•ä¸­çš„å„é¡¹èƒ½åŠ› </a> </li> <li class=md-nav__item> <a href=../../../leetcode/array/ class=md-nav__link> Array </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode1-10/ class=md-nav__link> LeetCode(1-10) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode11-20/ class=md-nav__link> LeetCode(11-20) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode21-30/ class=md-nav__link> LeetCode(21-30) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode31-40/ class=md-nav__link> LeetCode(31-40) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode41-50/ class=md-nav__link> LeetCode(41-50) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode51-60/ class=md-nav__link> LeetCode(51-60) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode61-70/ class=md-nav__link> LeetCode(61-70) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode71-80/ class=md-nav__link> LeetCode(71-80) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode81-90/ class=md-nav__link> LeetCode(81-90) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode91-100/ class=md-nav__link> LeetCode(91-100) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode101-110/ class=md-nav__link> LeetCode(101-110) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode111-120/ class=md-nav__link> LeetCode(111-120) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4 type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4> Books <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Books data-md-level=1> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Books </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_1 type=checkbox id=__nav_4_1> <label class=md-nav__link for=__nav_4_1> Design Pattern <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Design Pattern" data-md-level=2> <label class=md-nav__title for=__nav_4_1> <span class="md-nav__icon md-icon"></span> Design Pattern </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../design-pattern/design-pattern/ class=md-nav__link> è®¾è®¡æ¨¡å¼æ¦‚è¿° </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/design-principle/ class=md-nav__link> é¢å‘å¯¹è±¡çš„å…­å¤§åŸåˆ™ </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/singleton/ class=md-nav__link> å•ä¾‹æ¨¡å¼(Singleton) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/builder/ class=md-nav__link> å»ºé€ è€…æ¨¡å¼(Builder) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/prototype/ class=md-nav__link> åŸå‹æ¨¡å¼(Prototype) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/factory-method/ class=md-nav__link> å·¥å‚æ–¹æ³•æ¨¡å¼(Factory method) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/abstract-factory/ class=md-nav__link> æŠ½è±¡å·¥å‚æ¨¡å¼(Abstract factory) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/proxy/ class=md-nav__link> ä»£ç†æ¨¡å¼(Proxy) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/composite/ class=md-nav__link> ç»„åˆæ¨¡å¼(Composite) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/adapter/ class=md-nav__link> é€‚é…å™¨æ¨¡å¼(Adapter) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/decorator/ class=md-nav__link> è£…é¥°æ¨¡å¼(Decorator) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/flyweight/ class=md-nav__link> äº«å…ƒæ¨¡å¼(Flyweight) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/facade/ class=md-nav__link> å¤–è§‚æ¨¡å¼(Facade) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/bridge/ class=md-nav__link> æ¡¥æ¥æ¨¡å¼(Bridge) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/strategy/ class=md-nav__link> ç­–ç•¥æ¨¡å¼(Strategy) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/state/ class=md-nav__link> çŠ¶æ€æ¨¡å¼(State) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/chain-of-responsibility/ class=md-nav__link> è´£ä»»é“¾æ¨¡å¼(Chain of responsibility) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/interpreter/ class=md-nav__link> è§£é‡Šå™¨æ¨¡å¼(Interpreter) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/command/ class=md-nav__link> å‘½ä»¤æ¨¡å¼(Command) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/observer/ class=md-nav__link> è§‚å¯Ÿè€…æ¨¡å¼(Observer) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/memento/ class=md-nav__link> å¤‡å¿˜å½•æ¨¡å¼(Memento) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/iterator/ class=md-nav__link> è¿­ä»£å™¨æ¨¡å¼(Iterator) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/template-method/ class=md-nav__link> æ¨¡ç‰ˆæ–¹æ³•æ¨¡å¼(Template method) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/visitor/ class=md-nav__link> è®¿é—®è€…æ¨¡å¼(Visitor) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/mediator/ class=md-nav__link> ä¸­ä»‹è€…æ¨¡å¼(Mediator) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/confusing-design-pattern/ class=md-nav__link> æ˜“æ··æ·†çš„è®¾è®¡æ¨¡å¼ </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_2 type=checkbox id=__nav_4_2> <label class=md-nav__link for=__nav_4_2> Effective Java <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Effective Java" data-md-level=2> <label class=md-nav__title for=__nav_4_2> <span class="md-nav__icon md-icon"></span> Effective Java </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../effective-java/effective-java/ class=md-nav__link> Effective Javaæ¦‚è¿° </a> </li> <li class=md-nav__item> <a href=../../../effective-java/chapter1/ class=md-nav__link> åˆ›å»ºå’Œé”€æ¯å¯¹è±¡ </a> </li> <li class=md-nav__item> <a href=../../../effective-java/chapter2/ class=md-nav__link> å¯¹äºæ‰€æœ‰å¯¹è±¡éƒ½é€šç”¨çš„æ–¹æ³• </a> </li> <li class=md-nav__item> <a href=../../../effective-java/chapter3/ class=md-nav__link> ç±»å’Œæ¥å£ </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_3 type=checkbox id=__nav_4_3> <label class=md-nav__link for=__nav_4_3> JVM <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=JVM data-md-level=2> <label class=md-nav__title for=__nav_4_3> <span class="md-nav__icon md-icon"></span> JVM </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../jvm/jvm-content/ class=md-nav__link> æ·±å…¥ç†è§£Javaè™šæ‹Ÿæœº </a> </li> <li class=md-nav__item> <a href=../../../jvm/java-memory-area-oom/ class=md-nav__link> Javaå†…å­˜åŒºåŸŸä¸å†…å­˜æº¢å‡ºå¼‚å¸¸ </a> </li> <li class=md-nav__item> <a href=../../../jvm/java-gc/ class=md-nav__link> åƒåœ¾æ”¶é›†å™¨ä¸å†…å­˜åˆ†é…ç­–ç•¥ </a> </li> <li class=md-nav__item> <a href=../../../jvm/class-struct/ class=md-nav__link> ç±»æ–‡ä»¶ç»“æ„ </a> </li> <li class=md-nav__item> <a href=../../../jvm/load-class/ class=md-nav__link> è™šæ‹Ÿæœºç±»åŠ è½½æœºåˆ¶ </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_4 type=checkbox id=__nav_4_4> <label class=md-nav__link for=__nav_4_4> Java <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Java data-md-level=2> <label class=md-nav__title for=__nav_4_4> <span class="md-nav__icon md-icon"></span> Java </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../java/generics-java-kotlin/ class=md-nav__link> Java&Kotlinåœ¨æ³›å‹æ–¹é¢çš„åŒºåˆ« </a> </li> <li class=md-nav__item> <a href=../../../java/java-collections/ class=md-nav__link> Javaé›†åˆæ€»ç»“ </a> </li> <li class=md-nav__item> <a href=../../../java/java-foundation/ class=md-nav__link> Javaå¸¸è§æ¦‚å¿µ </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_5 type=checkbox id=__nav_4_5> <label class=md-nav__link for=__nav_4_5> Refactoring <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Refactoring data-md-level=2> <label class=md-nav__title for=__nav_4_5> <span class="md-nav__icon md-icon"></span> Refactoring </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../refactoring/refactoring/ class=md-nav__link> é‡æ„ï¼šæ”¹å–„æ—¢æœ‰ä»£ç çš„è®¾è®¡ </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <span style=float:right;text-align:right;line-height:18px; id=busuanzi_container_page_pv>æœ¬æ–‡æ€»é˜…è¯»é‡<span id=busuanzi_value_page_pv></span>æ¬¡</span> <h1>Glide v4 æºç è§£æï¼ˆäºŒï¼‰</h1> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>æœ¬ç³»åˆ—æ–‡ç« å‚è€ƒ3.7.0ç‰ˆæœ¬çš„<a href=https://blog.csdn.net/sinyu890807/column/info/15318>guolin - Glideæœ€å…¨è§£æ</a>ï¼Œå¹¶æŒ‰æ­¤æ€è·¯ç»“åˆ4.9.0ç‰ˆæœ¬æºç ä»¥åŠä½¿ç”¨æ–‡æ¡£è¿›è¡Œæ›´æ–°ã€‚<br> âŸ <a href=https://github.com/bumptech/glide/tree/v4.9.0>Glide v4.9.0</a><br> âŸ <a href=https://muyangmin.github.io/glide-docs-cn/ >ä¸­æ–‡æ–‡æ¡£</a><br> âŸ <a href=https://bumptech.github.io/glide/ >è‹±æ–‡æ–‡æ¡£</a>ğŸš€ğŸš€ </p> </div> <div class="admonition note"> <p class=admonition-title>Glideç³»åˆ—æ–‡ç« ç›®å½•</p> <ul> <li><a href=/android/3rd-library/glide1/ >Glide1â€”â€”Glide v4 çš„åŸºæœ¬ä½¿ç”¨</a></li> <li><a href=/android/3rd-library/glide2/ >Glide2â€”â€”ä»æºç çš„è§’åº¦ç†è§£Glideä¸‰æ­¥çš„æ‰§è¡Œæµç¨‹</a></li> <li><a href=/android/3rd-library/glide3/ >Glide3â€”â€”æ·±å…¥æ¢ç©¶Glideç¼“å­˜æœºåˆ¶</a></li> <li><a href=/android/3rd-library/glide4/ >Glide4â€”â€”RequestBuilderä¸­é«˜çº§ç‚¹çš„APIä»¥åŠTarget</a></li> <li><a href=/android/3rd-library/glide5/ >Glide5â€”â€”Glideå†…ç½®çš„transformä»¥åŠè‡ªå®šä¹‰BitmapTransformation</a></li> <li><a href=/android/3rd-library/glide6/ >Glide6â€”â€”Glideåˆ©ç”¨AppGlideModuleã€LibraryGlideModuleæ›´æ”¹é»˜è®¤é…ç½®ã€æ‰©å±•GlideåŠŸèƒ½ï¼›GlideAppä¸Glideçš„åŒºåˆ«åœ¨å“ªï¼Ÿ</a></li> <li><a href=/android/3rd-library/glide7/ >Glide7â€”â€”åˆ©ç”¨OkHttpã€è‡ªå®šä¹‰Drawableã€è‡ªå®šä¹‰ViewTargetå®ç°å¸¦è¿›åº¦çš„å›¾ç‰‡åŠ è½½åŠŸèƒ½</a></li> <li><a href=/android/3rd-library/migrate-to-glide/ >æ‚è®°ï¼šä»Picassoè¿ç§»è‡³Glide</a></li> </ul> </div> <hr> <p>æœ¬ç« ä¸»è¦å†…å®¹ä¸ºä»æºç çš„è§’åº¦ç†è§£Glideä¸‰æ­¥çš„æ‰§è¡Œæµç¨‹ã€‚</p> <p>ç”±äºä¸Šä¸€ç« ä¸­æˆ‘ä»¬å·²ç»å¯¼å…¥äº†Glideåº“ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥åœ¨Android Studioä¸­æŸ¥çœ‹Glideçš„æºç ã€‚ç›¸æ¯”clone GitHubä¸Šçš„æºç ï¼Œä½¿ç”¨Android StudioæŸ¥çœ‹Glideæºç çš„å¥½å¤„æ˜¯ï¼Œè¿™æ˜¯åªè¯»çš„ï¼Œé˜²æ­¢æˆ‘ä»¬è¯¯æ“ä½œã€‚è€Œä¸”è¿˜èƒ½ç›´æ¥ä¸Šåœ¨æºç å¯¹åº”çš„ä¸Šæ–­ç‚¹ï¼ŒçœŸæ˜¯å¤ªæ–¹ä¾¿äº†ã€‚</p> <p>è¿˜æ˜¯ä»¥<code>Glide.with(this).load(URL).into(ivGlide)</code>ä¸ºä¾‹ï¼Œçœ‹çœ‹è¿™èƒŒåéšè—äº†ä»€ä¹ˆç§˜å¯†ã€‚</p> <h2 id=1-glidewith>1. Glide.with<a class=headerlink href=#1-glidewith title="Anchor link to this section for reference">&para;</a></h2> <p><code>Glide.with</code>æœ‰å¾ˆå¤šé‡è½½æ–¹æ³•ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-0-1 name=__codelineno-0-1></a><a href=#__codelineno-0-1><span class=linenos data-linenos=" 1 "></span></a><span class=kd>public</span> <span class=kd>class</span> <span class=nc>Glide</span> <span class=kd>implements</span> <span class=n>ComponentCallbacks2</span> <span class=p>{</span>
<a id=__codelineno-0-2 name=__codelineno-0-2></a><a href=#__codelineno-0-2><span class=linenos data-linenos=" 2 "></span></a>    <span class=p>...</span>
<a id=__codelineno-0-3 name=__codelineno-0-3></a><a href=#__codelineno-0-3><span class=linenos data-linenos=" 3 "></span></a>    <span class=nd>@NonNull</span>
<a id=__codelineno-0-4 name=__codelineno-0-4></a><a href=#__codelineno-0-4><span class=linenos data-linenos=" 4 "></span></a>    <span class=kd>public</span> <span class=kd>static</span> <span class=n>RequestManager</span> <span class=nf>with</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-0-5 name=__codelineno-0-5></a><a href=#__codelineno-0-5><span class=linenos data-linenos=" 5 "></span></a>        <span class=k>return</span> <span class=n>getRetriever</span><span class=p>(</span><span class=n>context</span><span class=p>).</span><span class=na>get</span><span class=p>(</span><span class=n>context</span><span class=p>);</span>
<a id=__codelineno-0-6 name=__codelineno-0-6></a><a href=#__codelineno-0-6><span class=linenos data-linenos=" 6 "></span></a>    <span class=p>}</span>
<a id=__codelineno-0-7 name=__codelineno-0-7></a><a href=#__codelineno-0-7><span class=linenos data-linenos=" 7 "></span></a>
<a id=__codelineno-0-8 name=__codelineno-0-8></a><a href=#__codelineno-0-8><span class=linenos data-linenos=" 8 "></span></a>    <span class=nd>@NonNull</span>
<a id=__codelineno-0-9 name=__codelineno-0-9></a><a href=#__codelineno-0-9><span class=linenos data-linenos=" 9 "></span></a>    <span class=kd>public</span> <span class=kd>static</span> <span class=n>RequestManager</span> <span class=nf>with</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Activity</span> <span class=n>activity</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-0-10 name=__codelineno-0-10></a><a href=#__codelineno-0-10><span class=linenos data-linenos="10 "></span></a>        <span class=k>return</span> <span class=n>getRetriever</span><span class=p>(</span><span class=n>activity</span><span class=p>).</span><span class=na>get</span><span class=p>(</span><span class=n>activity</span><span class=p>);</span>
<a id=__codelineno-0-11 name=__codelineno-0-11></a><a href=#__codelineno-0-11><span class=linenos data-linenos="11 "></span></a>    <span class=p>}</span>
<a id=__codelineno-0-12 name=__codelineno-0-12></a><a href=#__codelineno-0-12><span class=linenos data-linenos="12 "></span></a>
<a id=__codelineno-0-13 name=__codelineno-0-13></a><a href=#__codelineno-0-13><span class=linenos data-linenos="13 "></span></a>    <span class=nd>@NonNull</span>
<a id=__codelineno-0-14 name=__codelineno-0-14></a><a href=#__codelineno-0-14><span class=linenos data-linenos="14 "></span></a>    <span class=kd>public</span> <span class=kd>static</span> <span class=n>RequestManager</span> <span class=nf>with</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>FragmentActivity</span> <span class=n>activity</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-0-15 name=__codelineno-0-15></a><a href=#__codelineno-0-15><span class=linenos data-linenos="15 "></span></a>        <span class=k>return</span> <span class=n>getRetriever</span><span class=p>(</span><span class=n>activity</span><span class=p>).</span><span class=na>get</span><span class=p>(</span><span class=n>activity</span><span class=p>);</span>
<a id=__codelineno-0-16 name=__codelineno-0-16></a><a href=#__codelineno-0-16><span class=linenos data-linenos="16 "></span></a>    <span class=p>}</span>
<a id=__codelineno-0-17 name=__codelineno-0-17></a><a href=#__codelineno-0-17><span class=linenos data-linenos="17 "></span></a>
<a id=__codelineno-0-18 name=__codelineno-0-18></a><a href=#__codelineno-0-18><span class=linenos data-linenos="18 "></span></a>    <span class=nd>@NonNull</span>
<a id=__codelineno-0-19 name=__codelineno-0-19></a><a href=#__codelineno-0-19><span class=linenos data-linenos="19 "></span></a>    <span class=kd>public</span> <span class=kd>static</span> <span class=n>RequestManager</span> <span class=nf>with</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Fragment</span> <span class=n>fragment</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-0-20 name=__codelineno-0-20></a><a href=#__codelineno-0-20><span class=linenos data-linenos="20 "></span></a>        <span class=k>return</span> <span class=n>getRetriever</span><span class=p>(</span><span class=n>fragment</span><span class=p>.</span><span class=na>getActivity</span><span class=p>()).</span><span class=na>get</span><span class=p>(</span><span class=n>fragment</span><span class=p>);</span>
<a id=__codelineno-0-21 name=__codelineno-0-21></a><a href=#__codelineno-0-21><span class=linenos data-linenos="21 "></span></a>    <span class=p>}</span>
<a id=__codelineno-0-22 name=__codelineno-0-22></a><a href=#__codelineno-0-22><span class=linenos data-linenos="22 "></span></a>
<a id=__codelineno-0-23 name=__codelineno-0-23></a><a href=#__codelineno-0-23><span class=linenos data-linenos="23 "></span></a>    <span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;deprecation&quot;</span><span class=p>)</span>
<a id=__codelineno-0-24 name=__codelineno-0-24></a><a href=#__codelineno-0-24><span class=linenos data-linenos="24 "></span></a>    <span class=nd>@Deprecated</span>
<a id=__codelineno-0-25 name=__codelineno-0-25></a><a href=#__codelineno-0-25><span class=linenos data-linenos="25 "></span></a>    <span class=nd>@NonNull</span>
<a id=__codelineno-0-26 name=__codelineno-0-26></a><a href=#__codelineno-0-26><span class=linenos data-linenos="26 "></span></a>    <span class=kd>public</span> <span class=kd>static</span> <span class=n>RequestManager</span> <span class=nf>with</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>android</span><span class=p>.</span><span class=na>app</span><span class=p>.</span><span class=na>Fragment</span> <span class=n>fragment</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-0-27 name=__codelineno-0-27></a><a href=#__codelineno-0-27><span class=linenos data-linenos="27 "></span></a>        <span class=k>return</span> <span class=n>getRetriever</span><span class=p>(</span><span class=n>fragment</span><span class=p>.</span><span class=na>getActivity</span><span class=p>()).</span><span class=na>get</span><span class=p>(</span><span class=n>fragment</span><span class=p>);</span>
<a id=__codelineno-0-28 name=__codelineno-0-28></a><a href=#__codelineno-0-28><span class=linenos data-linenos="28 "></span></a>    <span class=p>}</span>
<a id=__codelineno-0-29 name=__codelineno-0-29></a><a href=#__codelineno-0-29><span class=linenos data-linenos="29 "></span></a>
<a id=__codelineno-0-30 name=__codelineno-0-30></a><a href=#__codelineno-0-30><span class=linenos data-linenos="30 "></span></a>    <span class=nd>@NonNull</span>
<a id=__codelineno-0-31 name=__codelineno-0-31></a><a href=#__codelineno-0-31><span class=linenos data-linenos="31 "></span></a>    <span class=kd>public</span> <span class=kd>static</span> <span class=n>RequestManager</span> <span class=nf>with</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>View</span> <span class=n>view</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-0-32 name=__codelineno-0-32></a><a href=#__codelineno-0-32><span class=linenos data-linenos="32 "></span></a>        <span class=k>return</span> <span class=n>getRetriever</span><span class=p>(</span><span class=n>view</span><span class=p>.</span><span class=na>getContext</span><span class=p>()).</span><span class=na>get</span><span class=p>(</span><span class=n>view</span><span class=p>);</span>
<a id=__codelineno-0-33 name=__codelineno-0-33></a><a href=#__codelineno-0-33><span class=linenos data-linenos="33 "></span></a>    <span class=p>}</span>
<a id=__codelineno-0-34 name=__codelineno-0-34></a><a href=#__codelineno-0-34><span class=linenos data-linenos="34 "></span></a><span class=p>}</span>
</code></pre></div> <p>å¯ä»¥çœ‹åˆ°ï¼Œæ¯ä¸ªé‡è½½æ–¹æ³•å†…éƒ¨éƒ½é¦–å…ˆè°ƒç”¨<code>getRetriever(@Nullable Context context)</code>æ–¹æ³•è·å–ä¸€ä¸ª<code>RequestManagerRetriever</code>å¯¹è±¡ï¼Œç„¶åè°ƒç”¨å…¶<code>get</code>æ–¹æ³•æ¥è¿”å›<code>RequestManager</code>ã€‚<br> ä¼ å…¥<code>getRetriever</code>çš„å‚æ•°éƒ½æ˜¯<code>Context</code>ï¼Œè€Œ<code>RequestManagerRetriever.get</code>æ–¹æ³•ä¼ å…¥çš„å‚æ•°å„ä¸ç›¸åŒï¼Œæ‰€ä»¥ç”Ÿå‘½å‘¨æœŸçš„ç»‘å®šè‚¯å®šå‘ç”Ÿåœ¨<code>get</code>æ–¹æ³•ä¸­ã€‚</p> <p>æˆ‘ä»¬æŠŠ<code>Glide.with</code>æ–¹æ³•é‡Œé¢çš„ä»£ç åˆ†æˆä¸¤éƒ¨åˆ†æ¥åˆ†æã€‚</p> <h3 id=11-getretrievercontext>1.1 getRetriever(Context)<a class=headerlink href=#11-getretrievercontext title="Anchor link to this section for reference">&para;</a></h3> <p><code>getRetriever(Context)</code>æ–¹æ³•ä¼šæ ¹æ®<code>@GlideModule</code>æ³¨è§£çš„ç±»ä»¥åŠ<code>AndroidManifest.xml</code>æ–‡ä»¶ä¸­meta-dataé…ç½®çš„<code>GlideModule</code>æ¥åˆ›å»ºä¸€ä¸ª<code>Glide</code>å®ä¾‹ï¼Œç„¶åè¿”å›è¯¥å®ä¾‹çš„<code>requestManagerRetriever</code>ã€‚ </p> <p>æˆ‘ä»¬è·Ÿç€æºç è¿‡ä¸€è¾¹ï¼Œé¦–å…ˆä»<code>getRetriever(Context)</code>å¼€å§‹ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-1-1 name=__codelineno-1-1></a><a href=#__codelineno-1-1><span class=linenos data-linenos=" 1 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-1-2 name=__codelineno-1-2></a><a href=#__codelineno-1-2><span class=linenos data-linenos=" 2 "></span></a><span class=kd>private</span> <span class=kd>static</span> <span class=n>RequestManagerRetriever</span> <span class=nf>getRetriever</span><span class=p>(</span><span class=nd>@Nullable</span> <span class=n>Context</span> <span class=n>context</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-1-3 name=__codelineno-1-3></a><a href=#__codelineno-1-3><span class=linenos data-linenos=" 3 "></span></a>  <span class=c1>// Context could be null for other reasons (ie the user passes in null), but in practice it will</span>
<a id=__codelineno-1-4 name=__codelineno-1-4></a><a href=#__codelineno-1-4><span class=linenos data-linenos=" 4 "></span></a>  <span class=c1>// only occur due to errors with the Fragment lifecycle.</span>
<a id=__codelineno-1-5 name=__codelineno-1-5></a><a href=#__codelineno-1-5><span class=linenos data-linenos=" 5 "></span></a>  <span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span>
<a id=__codelineno-1-6 name=__codelineno-1-6></a><a href=#__codelineno-1-6><span class=linenos data-linenos=" 6 "></span></a>      <span class=n>context</span><span class=p>,</span>
<a id=__codelineno-1-7 name=__codelineno-1-7></a><a href=#__codelineno-1-7><span class=linenos data-linenos=" 7 "></span></a>      <span class=s>&quot;You cannot start a load on a not yet attached View or a Fragment where getActivity() &quot;</span>
<a id=__codelineno-1-8 name=__codelineno-1-8></a><a href=#__codelineno-1-8><span class=linenos data-linenos=" 8 "></span></a>          <span class=o>+</span> <span class=s>&quot;returns null (which usually occurs when getActivity() is called before the Fragment &quot;</span>
<a id=__codelineno-1-9 name=__codelineno-1-9></a><a href=#__codelineno-1-9><span class=linenos data-linenos=" 9 "></span></a>          <span class=o>+</span> <span class=s>&quot;is attached or after the Fragment is destroyed).&quot;</span><span class=p>);</span>
<a id=__codelineno-1-10 name=__codelineno-1-10></a><a href=#__codelineno-1-10><span class=linenos data-linenos="10 "></span></a>  <span class=k>return</span> <span class=n>Glide</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>context</span><span class=p>).</span><span class=na>getRequestManagerRetriever</span><span class=p>();</span>
<a id=__codelineno-1-11 name=__codelineno-1-11></a><a href=#__codelineno-1-11><span class=linenos data-linenos="11 "></span></a><span class=p>}</span>
</code></pre></div> <p>å› å…¥å‚<code>context</code>ä¸º<code>fragment.getActivity()</code>æ—¶ï¼Œ<code>context</code>å¯èƒ½ä¸ºç©ºï¼Œæ‰€ä»¥è¿™é‡Œè¿›è¡Œäº†ä¸€æ¬¡åˆ¤æ–­ã€‚ç„¶åå°±è°ƒç”¨äº†<code>Glide.get(context)</code>åˆ›å»ºäº†ä¸€ä¸ªGlideï¼Œæœ€åå°†<code>requestManagerRetriever</code>è¿”å›å³å¯ã€‚ </p> <p>æˆ‘ä»¬çœ‹ä¸€ä¸‹<code>Glide</code>çš„åˆ›å»ºè¿‡ç¨‹ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-2-1 name=__codelineno-2-1></a><a href=#__codelineno-2-1><span class=linenos data-linenos=" 1 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-2-2 name=__codelineno-2-2></a><a href=#__codelineno-2-2><span class=linenos data-linenos=" 2 "></span></a><span class=kd>public</span> <span class=kd>static</span> <span class=n>Glide</span> <span class=nf>get</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-2-3 name=__codelineno-2-3></a><a href=#__codelineno-2-3><span class=linenos data-linenos=" 3 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>glide</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-2-4 name=__codelineno-2-4></a><a href=#__codelineno-2-4><span class=linenos data-linenos=" 4 "></span></a>    <span class=kd>synchronized</span> <span class=p>(</span><span class=n>Glide</span><span class=p>.</span><span class=na>class</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-2-5 name=__codelineno-2-5></a><a href=#__codelineno-2-5><span class=linenos data-linenos=" 5 "></span></a>      <span class=k>if</span> <span class=p>(</span><span class=n>glide</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-2-6 name=__codelineno-2-6></a><a href=#__codelineno-2-6><span class=linenos data-linenos=" 6 "></span></a>        <span class=n>checkAndInitializeGlide</span><span class=p>(</span><span class=n>context</span><span class=p>);</span>
<a id=__codelineno-2-7 name=__codelineno-2-7></a><a href=#__codelineno-2-7><span class=linenos data-linenos=" 7 "></span></a>      <span class=p>}</span>
<a id=__codelineno-2-8 name=__codelineno-2-8></a><a href=#__codelineno-2-8><span class=linenos data-linenos=" 8 "></span></a>    <span class=p>}</span>
<a id=__codelineno-2-9 name=__codelineno-2-9></a><a href=#__codelineno-2-9><span class=linenos data-linenos=" 9 "></span></a>  <span class=p>}</span>
<a id=__codelineno-2-10 name=__codelineno-2-10></a><a href=#__codelineno-2-10><span class=linenos data-linenos="10 "></span></a>
<a id=__codelineno-2-11 name=__codelineno-2-11></a><a href=#__codelineno-2-11><span class=linenos data-linenos="11 "></span></a>  <span class=k>return</span> <span class=n>glide</span><span class=p>;</span>
<a id=__codelineno-2-12 name=__codelineno-2-12></a><a href=#__codelineno-2-12><span class=linenos data-linenos="12 "></span></a><span class=p>}</span>
<a id=__codelineno-2-13 name=__codelineno-2-13></a><a href=#__codelineno-2-13><span class=linenos data-linenos="13 "></span></a>
<a id=__codelineno-2-14 name=__codelineno-2-14></a><a href=#__codelineno-2-14><span class=linenos data-linenos="14 "></span></a><span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>checkAndInitializeGlide</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-2-15 name=__codelineno-2-15></a><a href=#__codelineno-2-15><span class=linenos data-linenos="15 "></span></a>  <span class=c1>// In the thread running initGlide(), one or more classes may call Glide.get(context).</span>
<a id=__codelineno-2-16 name=__codelineno-2-16></a><a href=#__codelineno-2-16><span class=linenos data-linenos="16 "></span></a>  <span class=c1>// Without this check, those calls could trigger infinite recursion.</span>
<a id=__codelineno-2-17 name=__codelineno-2-17></a><a href=#__codelineno-2-17><span class=linenos data-linenos="17 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>isInitializing</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-2-18 name=__codelineno-2-18></a><a href=#__codelineno-2-18><span class=linenos data-linenos="18 "></span></a>    <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&quot;You cannot call Glide.get() in registerComponents(),&quot;</span>
<a id=__codelineno-2-19 name=__codelineno-2-19></a><a href=#__codelineno-2-19><span class=linenos data-linenos="19 "></span></a>        <span class=o>+</span> <span class=s>&quot; use the provided Glide instance instead&quot;</span><span class=p>);</span>
<a id=__codelineno-2-20 name=__codelineno-2-20></a><a href=#__codelineno-2-20><span class=linenos data-linenos="20 "></span></a>  <span class=p>}</span>
<a id=__codelineno-2-21 name=__codelineno-2-21></a><a href=#__codelineno-2-21><span class=linenos data-linenos="21 "></span></a>  <span class=n>isInitializing</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
<a id=__codelineno-2-22 name=__codelineno-2-22></a><a href=#__codelineno-2-22><span class=linenos data-linenos="22 "></span></a>  <span class=n>initializeGlide</span><span class=p>(</span><span class=n>context</span><span class=p>);</span>
<a id=__codelineno-2-23 name=__codelineno-2-23></a><a href=#__codelineno-2-23><span class=linenos data-linenos="23 "></span></a>  <span class=n>isInitializing</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
<a id=__codelineno-2-24 name=__codelineno-2-24></a><a href=#__codelineno-2-24><span class=linenos data-linenos="24 "></span></a><span class=p>}</span>
<a id=__codelineno-2-25 name=__codelineno-2-25></a><a href=#__codelineno-2-25><span class=linenos data-linenos="25 "></span></a>
<a id=__codelineno-2-26 name=__codelineno-2-26></a><a href=#__codelineno-2-26><span class=linenos data-linenos="26 "></span></a><span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>initializeGlide</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-2-27 name=__codelineno-2-27></a><a href=#__codelineno-2-27><span class=linenos data-linenos="27 "></span></a>  <span class=n>initializeGlide</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=k>new</span> <span class=n>GlideBuilder</span><span class=p>());</span>
<a id=__codelineno-2-28 name=__codelineno-2-28></a><a href=#__codelineno-2-28><span class=linenos data-linenos="28 "></span></a><span class=p>}</span>
</code></pre></div> <p>ä¸Šé¢è¿™æ®µä»£ç æ²¡æœ‰ä»€ä¹ˆå¯è¯´çš„ï¼Œä¸‹é¢çœ‹çœ‹<code>initializeGlide</code>æ—¶å¦‚ä½•åˆ›å»º<code>Glide</code>å®ä¾‹çš„ã€‚</p> <div class=highlight><pre><span></span><code><a id=__codelineno-3-1 name=__codelineno-3-1></a><a href=#__codelineno-3-1><span class=linenos data-linenos=" 1 "></span></a><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;deprecation&quot;</span><span class=p>)</span>
<a id=__codelineno-3-2 name=__codelineno-3-2></a><a href=#__codelineno-3-2><span class=linenos data-linenos=" 2 "></span></a><span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>initializeGlide</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>GlideBuilder</span> <span class=n>builder</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-3-3 name=__codelineno-3-3></a><a href=#__codelineno-3-3><span class=linenos data-linenos=" 3 "></span></a>  <span class=n>Context</span> <span class=n>applicationContext</span> <span class=o>=</span> <span class=n>context</span><span class=p>.</span><span class=na>getApplicationContext</span><span class=p>();</span>
<a id=__codelineno-3-4 name=__codelineno-3-4></a><a href=#__codelineno-3-4><span class=linenos data-linenos=" 4 "></span></a>  <span class=c1>// å¦‚æœæœ‰é…ç½®@GlideModuleæ³¨è§£ï¼Œé‚£ä¹ˆä¼šåå°„æ„é€ kaptç”Ÿæˆçš„GeneratedAppGlideModuleImplç±»</span>
<a id=__codelineno-3-5 name=__codelineno-3-5></a><a href=#__codelineno-3-5><span class=linenos data-linenos=" 5 "></span></a>  <span class=n>GeneratedAppGlideModule</span> <span class=n>annotationGeneratedModule</span> <span class=o>=</span> <span class=n>getAnnotationGeneratedGlideModules</span><span class=p>();</span>
<a id=__codelineno-3-6 name=__codelineno-3-6></a><a href=#__codelineno-3-6><span class=linenos data-linenos=" 6 "></span></a>  <span class=c1>// å¦‚æœImplå­˜åœ¨ï¼Œä¸”å…è®¸è§£æmanifestæ–‡ä»¶</span>
<a id=__codelineno-3-7 name=__codelineno-3-7></a><a href=#__codelineno-3-7><span class=linenos data-linenos=" 7 "></span></a>  <span class=c1>// åˆ™éå†manifestä¸­çš„meta-dataï¼Œè§£æå‡ºæ‰€æœ‰çš„GlideModuleç±»</span>
<a id=__codelineno-3-8 name=__codelineno-3-8></a><a href=#__codelineno-3-8><span class=linenos data-linenos=" 8 "></span></a>  <span class=n>List</span><span class=o>&lt;</span><span class=n>com</span><span class=p>.</span><span class=na>bumptech</span><span class=p>.</span><span class=na>glide</span><span class=p>.</span><span class=na>module</span><span class=p>.</span><span class=na>GlideModule</span><span class=o>&gt;</span> <span class=n>manifestModules</span> <span class=o>=</span> <span class=n>Collections</span><span class=p>.</span><span class=na>emptyList</span><span class=p>();</span>
<a id=__codelineno-3-9 name=__codelineno-3-9></a><a href=#__codelineno-3-9><span class=linenos data-linenos=" 9 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>annotationGeneratedModule</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=n>annotationGeneratedModule</span><span class=p>.</span><span class=na>isManifestParsingEnabled</span><span class=p>())</span> <span class=p>{</span>
<a id=__codelineno-3-10 name=__codelineno-3-10></a><a href=#__codelineno-3-10><span class=linenos data-linenos="10 "></span></a>    <span class=n>manifestModules</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ManifestParser</span><span class=p>(</span><span class=n>applicationContext</span><span class=p>).</span><span class=na>parse</span><span class=p>();</span>
<a id=__codelineno-3-11 name=__codelineno-3-11></a><a href=#__codelineno-3-11><span class=linenos data-linenos="11 "></span></a>  <span class=p>}</span>
<a id=__codelineno-3-12 name=__codelineno-3-12></a><a href=#__codelineno-3-12><span class=linenos data-linenos="12 "></span></a>
<a id=__codelineno-3-13 name=__codelineno-3-13></a><a href=#__codelineno-3-13><span class=linenos data-linenos="13 "></span></a>  <span class=c1>// æ ¹æ®Implçš„é»‘åå•ï¼Œå‰”é™¤manifestä¸­çš„GlideModuleç±»</span>
<a id=__codelineno-3-14 name=__codelineno-3-14></a><a href=#__codelineno-3-14><span class=linenos data-linenos="14 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>annotationGeneratedModule</span> <span class=o>!=</span> <span class=kc>null</span>
<a id=__codelineno-3-15 name=__codelineno-3-15></a><a href=#__codelineno-3-15><span class=linenos data-linenos="15 "></span></a>      <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>annotationGeneratedModule</span><span class=p>.</span><span class=na>getExcludedModuleClasses</span><span class=p>().</span><span class=na>isEmpty</span><span class=p>())</span> <span class=p>{</span>
<a id=__codelineno-3-16 name=__codelineno-3-16></a><a href=#__codelineno-3-16><span class=linenos data-linenos="16 "></span></a>    <span class=n>Set</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>excludedModuleClasses</span> <span class=o>=</span>
<a id=__codelineno-3-17 name=__codelineno-3-17></a><a href=#__codelineno-3-17><span class=linenos data-linenos="17 "></span></a>        <span class=n>annotationGeneratedModule</span><span class=p>.</span><span class=na>getExcludedModuleClasses</span><span class=p>();</span>
<a id=__codelineno-3-18 name=__codelineno-3-18></a><a href=#__codelineno-3-18><span class=linenos data-linenos="18 "></span></a>    <span class=n>Iterator</span><span class=o>&lt;</span><span class=n>com</span><span class=p>.</span><span class=na>bumptech</span><span class=p>.</span><span class=na>glide</span><span class=p>.</span><span class=na>module</span><span class=p>.</span><span class=na>GlideModule</span><span class=o>&gt;</span> <span class=n>iterator</span> <span class=o>=</span> <span class=n>manifestModules</span><span class=p>.</span><span class=na>iterator</span><span class=p>();</span>
<a id=__codelineno-3-19 name=__codelineno-3-19></a><a href=#__codelineno-3-19><span class=linenos data-linenos="19 "></span></a>    <span class=k>while</span> <span class=p>(</span><span class=n>iterator</span><span class=p>.</span><span class=na>hasNext</span><span class=p>())</span> <span class=p>{</span>
<a id=__codelineno-3-20 name=__codelineno-3-20></a><a href=#__codelineno-3-20><span class=linenos data-linenos="20 "></span></a>      <span class=n>com</span><span class=p>.</span><span class=na>bumptech</span><span class=p>.</span><span class=na>glide</span><span class=p>.</span><span class=na>module</span><span class=p>.</span><span class=na>GlideModule</span> <span class=n>current</span> <span class=o>=</span> <span class=n>iterator</span><span class=p>.</span><span class=na>next</span><span class=p>();</span>
<a id=__codelineno-3-21 name=__codelineno-3-21></a><a href=#__codelineno-3-21><span class=linenos data-linenos="21 "></span></a>      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>excludedModuleClasses</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>current</span><span class=p>.</span><span class=na>getClass</span><span class=p>()))</span> <span class=p>{</span>
<a id=__codelineno-3-22 name=__codelineno-3-22></a><a href=#__codelineno-3-22><span class=linenos data-linenos="22 "></span></a>        <span class=k>continue</span><span class=p>;</span>
<a id=__codelineno-3-23 name=__codelineno-3-23></a><a href=#__codelineno-3-23><span class=linenos data-linenos="23 "></span></a>      <span class=p>}</span>
<a id=__codelineno-3-24 name=__codelineno-3-24></a><a href=#__codelineno-3-24><span class=linenos data-linenos="24 "></span></a>      <span class=k>if</span> <span class=p>(</span><span class=n>Log</span><span class=p>.</span><span class=na>isLoggable</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=n>Log</span><span class=p>.</span><span class=na>DEBUG</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-3-25 name=__codelineno-3-25></a><a href=#__codelineno-3-25><span class=linenos data-linenos="25 "></span></a>        <span class=n>Log</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s>&quot;AppGlideModule excludes manifest GlideModule: &quot;</span> <span class=o>+</span> <span class=n>current</span><span class=p>);</span>
<a id=__codelineno-3-26 name=__codelineno-3-26></a><a href=#__codelineno-3-26><span class=linenos data-linenos="26 "></span></a>      <span class=p>}</span>
<a id=__codelineno-3-27 name=__codelineno-3-27></a><a href=#__codelineno-3-27><span class=linenos data-linenos="27 "></span></a>      <span class=n>iterator</span><span class=p>.</span><span class=na>remove</span><span class=p>();</span>
<a id=__codelineno-3-28 name=__codelineno-3-28></a><a href=#__codelineno-3-28><span class=linenos data-linenos="28 "></span></a>    <span class=p>}</span>
<a id=__codelineno-3-29 name=__codelineno-3-29></a><a href=#__codelineno-3-29><span class=linenos data-linenos="29 "></span></a>  <span class=p>}</span>
<a id=__codelineno-3-30 name=__codelineno-3-30></a><a href=#__codelineno-3-30><span class=linenos data-linenos="30 "></span></a>
<a id=__codelineno-3-31 name=__codelineno-3-31></a><a href=#__codelineno-3-31><span class=linenos data-linenos="31 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>Log</span><span class=p>.</span><span class=na>isLoggable</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=n>Log</span><span class=p>.</span><span class=na>DEBUG</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-3-32 name=__codelineno-3-32></a><a href=#__codelineno-3-32><span class=linenos data-linenos="32 "></span></a>    <span class=k>for</span> <span class=p>(</span><span class=n>com</span><span class=p>.</span><span class=na>bumptech</span><span class=p>.</span><span class=na>glide</span><span class=p>.</span><span class=na>module</span><span class=p>.</span><span class=na>GlideModule</span> <span class=n>glideModule</span> <span class=p>:</span> <span class=n>manifestModules</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-3-33 name=__codelineno-3-33></a><a href=#__codelineno-3-33><span class=linenos data-linenos="33 "></span></a>      <span class=n>Log</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s>&quot;Discovered GlideModule from manifest: &quot;</span> <span class=o>+</span> <span class=n>glideModule</span><span class=p>.</span><span class=na>getClass</span><span class=p>());</span>
<a id=__codelineno-3-34 name=__codelineno-3-34></a><a href=#__codelineno-3-34><span class=linenos data-linenos="34 "></span></a>    <span class=p>}</span>
<a id=__codelineno-3-35 name=__codelineno-3-35></a><a href=#__codelineno-3-35><span class=linenos data-linenos="35 "></span></a>  <span class=p>}</span>
<a id=__codelineno-3-36 name=__codelineno-3-36></a><a href=#__codelineno-3-36><span class=linenos data-linenos="36 "></span></a>
<a id=__codelineno-3-37 name=__codelineno-3-37></a><a href=#__codelineno-3-37><span class=linenos data-linenos="37 "></span></a>  <span class=c1>// å¦‚æœImplå­˜åœ¨ï¼Œé‚£ä¹ˆè®¾ç½®ä¸ºè¯¥ç±»çš„RequestManagerFactoryï¼› å¦åˆ™ï¼Œè®¾ç½®ä¸ºnull</span>
<a id=__codelineno-3-38 name=__codelineno-3-38></a><a href=#__codelineno-3-38><span class=linenos data-linenos="38 "></span></a>  <span class=n>RequestManagerRetriever</span><span class=p>.</span><span class=na>RequestManagerFactory</span> <span class=n>factory</span> <span class=o>=</span>
<a id=__codelineno-3-39 name=__codelineno-3-39></a><a href=#__codelineno-3-39><span class=linenos data-linenos="39 "></span></a>      <span class=n>annotationGeneratedModule</span> <span class=o>!=</span> <span class=kc>null</span>
<a id=__codelineno-3-40 name=__codelineno-3-40></a><a href=#__codelineno-3-40><span class=linenos data-linenos="40 "></span></a>          <span class=o>?</span> <span class=n>annotationGeneratedModule</span><span class=p>.</span><span class=na>getRequestManagerFactory</span><span class=p>()</span> <span class=p>:</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-3-41 name=__codelineno-3-41></a><a href=#__codelineno-3-41><span class=linenos data-linenos="41 "></span></a>  <span class=n>builder</span><span class=p>.</span><span class=na>setRequestManagerFactory</span><span class=p>(</span><span class=n>factory</span><span class=p>);</span>
<a id=__codelineno-3-42 name=__codelineno-3-42></a><a href=#__codelineno-3-42><span class=linenos data-linenos="42 "></span></a>  <span class=c1>// ä¾æ¬¡è°ƒç”¨manifestä¸­GlideModuleç±»çš„applyOptionsæ–¹æ³•ï¼Œå°†é…ç½®å†™åˆ°builderé‡Œ</span>
<a id=__codelineno-3-43 name=__codelineno-3-43></a><a href=#__codelineno-3-43><span class=linenos data-linenos="43 "></span></a>  <span class=k>for</span> <span class=p>(</span><span class=n>com</span><span class=p>.</span><span class=na>bumptech</span><span class=p>.</span><span class=na>glide</span><span class=p>.</span><span class=na>module</span><span class=p>.</span><span class=na>GlideModule</span> <span class=n>module</span> <span class=p>:</span> <span class=n>manifestModules</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-3-44 name=__codelineno-3-44></a><a href=#__codelineno-3-44><span class=linenos data-linenos="44 "></span></a>    <span class=n>module</span><span class=p>.</span><span class=na>applyOptions</span><span class=p>(</span><span class=n>applicationContext</span><span class=p>,</span> <span class=n>builder</span><span class=p>);</span>
<a id=__codelineno-3-45 name=__codelineno-3-45></a><a href=#__codelineno-3-45><span class=linenos data-linenos="45 "></span></a>  <span class=p>}</span>
<a id=__codelineno-3-46 name=__codelineno-3-46></a><a href=#__codelineno-3-46><span class=linenos data-linenos="46 "></span></a>  <span class=c1>// å†™å…¥Implçš„é…ç½®</span>
<a id=__codelineno-3-47 name=__codelineno-3-47></a><a href=#__codelineno-3-47><span class=linenos data-linenos="47 "></span></a>  <span class=c1>// ä¹Ÿå°±æ˜¯è¯´Implé…ç½®çš„ä¼˜å…ˆçº§æ›´é«˜ï¼Œå¦‚æœæœ‰å†²çªçš„è¯</span>
<a id=__codelineno-3-48 name=__codelineno-3-48></a><a href=#__codelineno-3-48><span class=linenos data-linenos="48 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>annotationGeneratedModule</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-3-49 name=__codelineno-3-49></a><a href=#__codelineno-3-49><span class=linenos data-linenos="49 "></span></a>    <span class=n>annotationGeneratedModule</span><span class=p>.</span><span class=na>applyOptions</span><span class=p>(</span><span class=n>applicationContext</span><span class=p>,</span> <span class=n>builder</span><span class=p>);</span>
<a id=__codelineno-3-50 name=__codelineno-3-50></a><a href=#__codelineno-3-50><span class=linenos data-linenos="50 "></span></a>  <span class=p>}</span>
<a id=__codelineno-3-51 name=__codelineno-3-51></a><a href=#__codelineno-3-51><span class=linenos data-linenos="51 "></span></a>  <span class=c1>// ğŸ”¥ğŸ”¥ğŸ”¥è°ƒç”¨GlideBuilder.buildæ–¹æ³•åˆ›å»ºGlide</span>
<a id=__codelineno-3-52 name=__codelineno-3-52></a><a href=#__codelineno-3-52><span class=linenos data-linenos="52 "></span></a>  <span class=n>Glide</span> <span class=n>glide</span> <span class=o>=</span> <span class=n>builder</span><span class=p>.</span><span class=na>build</span><span class=p>(</span><span class=n>applicationContext</span><span class=p>);</span>
<a id=__codelineno-3-53 name=__codelineno-3-53></a><a href=#__codelineno-3-53><span class=linenos data-linenos="53 "></span></a>  <span class=c1>// ä¾æ¬¡è°ƒç”¨manifestä¸­GlideModuleç±»çš„registerComponentsæ–¹æ³•ï¼Œæ¥æ›¿æ¢Glideçš„é»˜è®¤é…ç½®</span>
<a id=__codelineno-3-54 name=__codelineno-3-54></a><a href=#__codelineno-3-54><span class=linenos data-linenos="54 "></span></a>  <span class=k>for</span> <span class=p>(</span><span class=n>com</span><span class=p>.</span><span class=na>bumptech</span><span class=p>.</span><span class=na>glide</span><span class=p>.</span><span class=na>module</span><span class=p>.</span><span class=na>GlideModule</span> <span class=n>module</span> <span class=p>:</span> <span class=n>manifestModules</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-3-55 name=__codelineno-3-55></a><a href=#__codelineno-3-55><span class=linenos data-linenos="55 "></span></a>    <span class=n>module</span><span class=p>.</span><span class=na>registerComponents</span><span class=p>(</span><span class=n>applicationContext</span><span class=p>,</span> <span class=n>glide</span><span class=p>,</span> <span class=n>glide</span><span class=p>.</span><span class=na>registry</span><span class=p>);</span>
<a id=__codelineno-3-56 name=__codelineno-3-56></a><a href=#__codelineno-3-56><span class=linenos data-linenos="56 "></span></a>  <span class=p>}</span>
<a id=__codelineno-3-57 name=__codelineno-3-57></a><a href=#__codelineno-3-57><span class=linenos data-linenos="57 "></span></a>  <span class=c1>// è°ƒç”¨Implä¸­æ›¿æ¢Glideé…ç½®çš„æ–¹æ³•</span>
<a id=__codelineno-3-58 name=__codelineno-3-58></a><a href=#__codelineno-3-58><span class=linenos data-linenos="58 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>annotationGeneratedModule</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-3-59 name=__codelineno-3-59></a><a href=#__codelineno-3-59><span class=linenos data-linenos="59 "></span></a>    <span class=n>annotationGeneratedModule</span><span class=p>.</span><span class=na>registerComponents</span><span class=p>(</span><span class=n>applicationContext</span><span class=p>,</span> <span class=n>glide</span><span class=p>,</span> <span class=n>glide</span><span class=p>.</span><span class=na>registry</span><span class=p>);</span>
<a id=__codelineno-3-60 name=__codelineno-3-60></a><a href=#__codelineno-3-60><span class=linenos data-linenos="60 "></span></a>  <span class=p>}</span>
<a id=__codelineno-3-61 name=__codelineno-3-61></a><a href=#__codelineno-3-61><span class=linenos data-linenos="61 "></span></a>  <span class=c1>// æ³¨å†Œå†…å­˜ç®¡ç†çš„å›è°ƒï¼Œå› ä¸ºGlideå®ç°äº†ComponentCallbacks2æ¥å£</span>
<a id=__codelineno-3-62 name=__codelineno-3-62></a><a href=#__codelineno-3-62><span class=linenos data-linenos="62 "></span></a>  <span class=n>applicationContext</span><span class=p>.</span><span class=na>registerComponentCallbacks</span><span class=p>(</span><span class=n>glide</span><span class=p>);</span>
<a id=__codelineno-3-63 name=__codelineno-3-63></a><a href=#__codelineno-3-63><span class=linenos data-linenos="63 "></span></a>  <span class=c1>// ä¿å­˜glideå®ä¾‹åˆ°é™æ€å˜é‡ä¸­</span>
<a id=__codelineno-3-64 name=__codelineno-3-64></a><a href=#__codelineno-3-64><span class=linenos data-linenos="64 "></span></a>  <span class=n>Glide</span><span class=p>.</span><span class=na>glide</span> <span class=o>=</span> <span class=n>glide</span><span class=p>;</span>
<a id=__codelineno-3-65 name=__codelineno-3-65></a><a href=#__codelineno-3-65><span class=linenos data-linenos="65 "></span></a><span class=p>}</span>
</code></pre></div> <blockquote> <p><code>applyOptions</code>ã€<code>registerComponents</code>è¿™ä¸¤ä¸ªæ–¹æ³•åé¢ä¼šè¯¦ç»†è®¨è®ºï¼Œè¿™é‡Œåªæ˜¯ç®€å•è¯´æ˜ä¸€ä¸‹ã€‚</p> </blockquote> <p>åœ¨æˆ‘ä»¬æœ¬èŠ‚çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬<code>AndroidManifest</code>å’Œ<code>@GlideModule</code>æ³¨è§£ä¸­éƒ½æ²¡æœ‰è¿›è¡Œè¿‡é…ç½®ï¼Œæ‰€ä»¥ä¸Šé¢çš„ä»£ç å¯ä»¥ç®€åŒ–ä¸ºï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-4-1 name=__codelineno-4-1></a><a href=#__codelineno-4-1><span class=linenos data-linenos=" 1 "></span></a><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;deprecation&quot;</span><span class=p>)</span>
<a id=__codelineno-4-2 name=__codelineno-4-2></a><a href=#__codelineno-4-2><span class=linenos data-linenos=" 2 "></span></a><span class=kd>private</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>initializeGlide</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>GlideBuilder</span> <span class=n>builder</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-4-3 name=__codelineno-4-3></a><a href=#__codelineno-4-3><span class=linenos data-linenos=" 3 "></span></a>  <span class=n>Context</span> <span class=n>applicationContext</span> <span class=o>=</span> <span class=n>context</span><span class=p>.</span><span class=na>getApplicationContext</span><span class=p>();</span>
<a id=__codelineno-4-4 name=__codelineno-4-4></a><a href=#__codelineno-4-4><span class=linenos data-linenos=" 4 "></span></a>  <span class=c1>// ğŸ”¥ğŸ”¥ğŸ”¥è°ƒç”¨GlideBuilder.buildæ–¹æ³•åˆ›å»ºGlide</span>
<a id=__codelineno-4-5 name=__codelineno-4-5></a><a href=#__codelineno-4-5><span class=linenos data-linenos=" 5 "></span></a>  <span class=n>Glide</span> <span class=n>glide</span> <span class=o>=</span> <span class=n>builder</span><span class=p>.</span><span class=na>build</span><span class=p>(</span><span class=n>applicationContext</span><span class=p>);</span>
<a id=__codelineno-4-6 name=__codelineno-4-6></a><a href=#__codelineno-4-6><span class=linenos data-linenos=" 6 "></span></a>  <span class=c1>// æ³¨å†Œå†…å­˜ç®¡ç†çš„å›è°ƒï¼Œå› ä¸ºGlideå®ç°äº†ComponentCallbacks2æ¥å£</span>
<a id=__codelineno-4-7 name=__codelineno-4-7></a><a href=#__codelineno-4-7><span class=linenos data-linenos=" 7 "></span></a>  <span class=n>applicationContext</span><span class=p>.</span><span class=na>registerComponentCallbacks</span><span class=p>(</span><span class=n>glide</span><span class=p>);</span>
<a id=__codelineno-4-8 name=__codelineno-4-8></a><a href=#__codelineno-4-8><span class=linenos data-linenos=" 8 "></span></a>  <span class=c1>// ä¿å­˜glideå®ä¾‹åˆ°é™æ€å˜é‡ä¸­</span>
<a id=__codelineno-4-9 name=__codelineno-4-9></a><a href=#__codelineno-4-9><span class=linenos data-linenos=" 9 "></span></a>  <span class=n>Glide</span><span class=p>.</span><span class=na>glide</span> <span class=o>=</span> <span class=n>glide</span><span class=p>;</span>
<a id=__codelineno-4-10 name=__codelineno-4-10></a><a href=#__codelineno-4-10><span class=linenos data-linenos="10 "></span></a><span class=p>}</span>
</code></pre></div> <p>ğŸ”¥ğŸ”¥ğŸ”¥æˆ‘ä»¬çœ‹ä¸€ä¸‹<code>GlideBuilder.build</code>æ–¹æ³•ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-5-1 name=__codelineno-5-1></a><a href=#__codelineno-5-1><span class=linenos data-linenos=" 1 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-5-2 name=__codelineno-5-2></a><a href=#__codelineno-5-2><span class=linenos data-linenos=" 2 "></span></a><span class=n>Glide</span> <span class=nf>build</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-5-3 name=__codelineno-5-3></a><a href=#__codelineno-5-3><span class=linenos data-linenos=" 3 "></span></a>  <span class=p>...</span>
<a id=__codelineno-5-4 name=__codelineno-5-4></a><a href=#__codelineno-5-4><span class=linenos data-linenos=" 4 "></span></a>
<a id=__codelineno-5-5 name=__codelineno-5-5></a><a href=#__codelineno-5-5><span class=linenos data-linenos=" 5 "></span></a>  <span class=n>RequestManagerRetriever</span> <span class=n>requestManagerRetriever</span> <span class=o>=</span>
<a id=__codelineno-5-6 name=__codelineno-5-6></a><a href=#__codelineno-5-6><span class=linenos data-linenos=" 6 "></span></a>      <span class=k>new</span> <span class=n>RequestManagerRetriever</span><span class=p>(</span><span class=n>requestManagerFactory</span><span class=p>);</span>
<a id=__codelineno-5-7 name=__codelineno-5-7></a><a href=#__codelineno-5-7><span class=linenos data-linenos=" 7 "></span></a>
<a id=__codelineno-5-8 name=__codelineno-5-8></a><a href=#__codelineno-5-8><span class=linenos data-linenos=" 8 "></span></a>  <span class=k>return</span> <span class=k>new</span> <span class=n>Glide</span><span class=p>(</span>
<a id=__codelineno-5-9 name=__codelineno-5-9></a><a href=#__codelineno-5-9><span class=linenos data-linenos=" 9 "></span></a>      <span class=n>context</span><span class=p>,</span>
<a id=__codelineno-5-10 name=__codelineno-5-10></a><a href=#__codelineno-5-10><span class=linenos data-linenos="10 "></span></a>      <span class=n>engine</span><span class=p>,</span>
<a id=__codelineno-5-11 name=__codelineno-5-11></a><a href=#__codelineno-5-11><span class=linenos data-linenos="11 "></span></a>      <span class=n>memoryCache</span><span class=p>,</span>
<a id=__codelineno-5-12 name=__codelineno-5-12></a><a href=#__codelineno-5-12><span class=linenos data-linenos="12 "></span></a>      <span class=n>bitmapPool</span><span class=p>,</span>
<a id=__codelineno-5-13 name=__codelineno-5-13></a><a href=#__codelineno-5-13><span class=linenos data-linenos="13 "></span></a>      <span class=n>arrayPool</span><span class=p>,</span>
<a id=__codelineno-5-14 name=__codelineno-5-14></a><a href=#__codelineno-5-14><span class=linenos data-linenos="14 "></span></a>      <span class=n>requestManagerRetriever</span><span class=p>,</span>
<a id=__codelineno-5-15 name=__codelineno-5-15></a><a href=#__codelineno-5-15><span class=linenos data-linenos="15 "></span></a>      <span class=n>connectivityMonitorFactory</span><span class=p>,</span>
<a id=__codelineno-5-16 name=__codelineno-5-16></a><a href=#__codelineno-5-16><span class=linenos data-linenos="16 "></span></a>      <span class=n>logLevel</span><span class=p>,</span>
<a id=__codelineno-5-17 name=__codelineno-5-17></a><a href=#__codelineno-5-17><span class=linenos data-linenos="17 "></span></a>      <span class=n>defaultRequestOptions</span><span class=p>.</span><span class=na>lock</span><span class=p>(),</span>
<a id=__codelineno-5-18 name=__codelineno-5-18></a><a href=#__codelineno-5-18><span class=linenos data-linenos="18 "></span></a>      <span class=n>defaultTransitionOptions</span><span class=p>,</span>
<a id=__codelineno-5-19 name=__codelineno-5-19></a><a href=#__codelineno-5-19><span class=linenos data-linenos="19 "></span></a>      <span class=n>defaultRequestListeners</span><span class=p>,</span>
<a id=__codelineno-5-20 name=__codelineno-5-20></a><a href=#__codelineno-5-20><span class=linenos data-linenos="20 "></span></a>      <span class=n>isLoggingRequestOriginsEnabled</span><span class=p>);</span>
<a id=__codelineno-5-21 name=__codelineno-5-21></a><a href=#__codelineno-5-21><span class=linenos data-linenos="21 "></span></a><span class=p>}</span>
</code></pre></div> <p>è¿™é‡Œçš„<code>requestManagerRetriever</code>ç›´æ¥è°ƒç”¨äº†æ„é€ å™¨ï¼Œä¸”ä¼ å…¥å‚æ•°å®é™…ä¸Šä¸ºnullï¼Œåœ¨<code>RequestManagerRetriever</code>çš„æ„é€ å™¨æ–¹æ³•ä¸­ä¼šä¸ºæ­¤åˆ›å»ºä¸€ä¸ªé»˜è®¤çš„<code>DEFAULT_FACTORY</code>ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-6-1 name=__codelineno-6-1></a><a href=#__codelineno-6-1><span class=linenos data-linenos=" 1 "></span></a><span class=kd>public</span> <span class=kd>class</span> <span class=nc>RequestManagerRetriever</span> <span class=kd>implements</span> <span class=n>Handler</span><span class=p>.</span><span class=na>Callback</span> <span class=p>{</span>
<a id=__codelineno-6-2 name=__codelineno-6-2></a><a href=#__codelineno-6-2><span class=linenos data-linenos=" 2 "></span></a>
<a id=__codelineno-6-3 name=__codelineno-6-3></a><a href=#__codelineno-6-3><span class=linenos data-linenos=" 3 "></span></a>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>Handler</span> <span class=n>handler</span><span class=p>;</span>
<a id=__codelineno-6-4 name=__codelineno-6-4></a><a href=#__codelineno-6-4><span class=linenos data-linenos=" 4 "></span></a>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>RequestManagerFactory</span> <span class=n>factory</span><span class=p>;</span>
<a id=__codelineno-6-5 name=__codelineno-6-5></a><a href=#__codelineno-6-5><span class=linenos data-linenos=" 5 "></span></a>
<a id=__codelineno-6-6 name=__codelineno-6-6></a><a href=#__codelineno-6-6><span class=linenos data-linenos=" 6 "></span></a>  <span class=kd>public</span> <span class=nf>RequestManagerRetriever</span><span class=p>(</span><span class=nd>@Nullable</span> <span class=n>RequestManagerFactory</span> <span class=n>factory</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-6-7 name=__codelineno-6-7></a><a href=#__codelineno-6-7><span class=linenos data-linenos=" 7 "></span></a>    <span class=k>this</span><span class=p>.</span><span class=na>factory</span> <span class=o>=</span> <span class=n>factory</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>?</span> <span class=n>factory</span> <span class=p>:</span> <span class=n>DEFAULT_FACTORY</span><span class=p>;</span>
<a id=__codelineno-6-8 name=__codelineno-6-8></a><a href=#__codelineno-6-8><span class=linenos data-linenos=" 8 "></span></a>    <span class=n>handler</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Handler</span><span class=p>(</span><span class=n>Looper</span><span class=p>.</span><span class=na>getMainLooper</span><span class=p>(),</span> <span class=k>this</span> <span class=cm>/* Callback */</span><span class=p>);</span>
<a id=__codelineno-6-9 name=__codelineno-6-9></a><a href=#__codelineno-6-9><span class=linenos data-linenos=" 9 "></span></a>  <span class=p>}</span>
<a id=__codelineno-6-10 name=__codelineno-6-10></a><a href=#__codelineno-6-10><span class=linenos data-linenos="10 "></span></a>
<a id=__codelineno-6-11 name=__codelineno-6-11></a><a href=#__codelineno-6-11><span class=linenos data-linenos="11 "></span></a>  <span class=cm>/**</span>
<a id=__codelineno-6-12 name=__codelineno-6-12></a><a href=#__codelineno-6-12><span class=linenos data-linenos="12 "></span></a><span class=cm>   * Used internally to create {@link RequestManager}s.</span>
<a id=__codelineno-6-13 name=__codelineno-6-13></a><a href=#__codelineno-6-13><span class=linenos data-linenos="13 "></span></a><span class=cm>   */</span>
<a id=__codelineno-6-14 name=__codelineno-6-14></a><a href=#__codelineno-6-14><span class=linenos data-linenos="14 "></span></a>  <span class=kd>public</span> <span class=kd>interface</span> <span class=nc>RequestManagerFactory</span> <span class=p>{</span>
<a id=__codelineno-6-15 name=__codelineno-6-15></a><a href=#__codelineno-6-15><span class=linenos data-linenos="15 "></span></a>    <span class=nd>@NonNull</span>
<a id=__codelineno-6-16 name=__codelineno-6-16></a><a href=#__codelineno-6-16><span class=linenos data-linenos="16 "></span></a>    <span class=n>RequestManager</span> <span class=nf>build</span><span class=p>(</span>
<a id=__codelineno-6-17 name=__codelineno-6-17></a><a href=#__codelineno-6-17><span class=linenos data-linenos="17 "></span></a>        <span class=nd>@NonNull</span> <span class=n>Glide</span> <span class=n>glide</span><span class=p>,</span>
<a id=__codelineno-6-18 name=__codelineno-6-18></a><a href=#__codelineno-6-18><span class=linenos data-linenos="18 "></span></a>        <span class=nd>@NonNull</span> <span class=n>Lifecycle</span> <span class=n>lifecycle</span><span class=p>,</span>
<a id=__codelineno-6-19 name=__codelineno-6-19></a><a href=#__codelineno-6-19><span class=linenos data-linenos="19 "></span></a>        <span class=nd>@NonNull</span> <span class=n>RequestManagerTreeNode</span> <span class=n>requestManagerTreeNode</span><span class=p>,</span>
<a id=__codelineno-6-20 name=__codelineno-6-20></a><a href=#__codelineno-6-20><span class=linenos data-linenos="20 "></span></a>        <span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=p>);</span>
<a id=__codelineno-6-21 name=__codelineno-6-21></a><a href=#__codelineno-6-21><span class=linenos data-linenos="21 "></span></a>  <span class=p>}</span>
<a id=__codelineno-6-22 name=__codelineno-6-22></a><a href=#__codelineno-6-22><span class=linenos data-linenos="22 "></span></a>
<a id=__codelineno-6-23 name=__codelineno-6-23></a><a href=#__codelineno-6-23><span class=linenos data-linenos="23 "></span></a>  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>RequestManagerFactory</span> <span class=n>DEFAULT_FACTORY</span> <span class=o>=</span> <span class=k>new</span> <span class=n>RequestManagerFactory</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-6-24 name=__codelineno-6-24></a><a href=#__codelineno-6-24><span class=linenos data-linenos="24 "></span></a>    <span class=nd>@NonNull</span>
<a id=__codelineno-6-25 name=__codelineno-6-25></a><a href=#__codelineno-6-25><span class=linenos data-linenos="25 "></span></a>    <span class=nd>@Override</span>
<a id=__codelineno-6-26 name=__codelineno-6-26></a><a href=#__codelineno-6-26><span class=linenos data-linenos="26 "></span></a>    <span class=kd>public</span> <span class=n>RequestManager</span> <span class=nf>build</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Glide</span> <span class=n>glide</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Lifecycle</span> <span class=n>lifecycle</span><span class=p>,</span>
<a id=__codelineno-6-27 name=__codelineno-6-27></a><a href=#__codelineno-6-27><span class=linenos data-linenos="27 "></span></a>        <span class=nd>@NonNull</span> <span class=n>RequestManagerTreeNode</span> <span class=n>requestManagerTreeNode</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-6-28 name=__codelineno-6-28></a><a href=#__codelineno-6-28><span class=linenos data-linenos="28 "></span></a>      <span class=k>return</span> <span class=k>new</span> <span class=n>RequestManager</span><span class=p>(</span><span class=n>glide</span><span class=p>,</span> <span class=n>lifecycle</span><span class=p>,</span> <span class=n>requestManagerTreeNode</span><span class=p>,</span> <span class=n>context</span><span class=p>);</span>
<a id=__codelineno-6-29 name=__codelineno-6-29></a><a href=#__codelineno-6-29><span class=linenos data-linenos="29 "></span></a>    <span class=p>}</span>
<a id=__codelineno-6-30 name=__codelineno-6-30></a><a href=#__codelineno-6-30><span class=linenos data-linenos="30 "></span></a>  <span class=p>};</span>
<a id=__codelineno-6-31 name=__codelineno-6-31></a><a href=#__codelineno-6-31><span class=linenos data-linenos="31 "></span></a><span class=p>}</span>
</code></pre></div> <p>ç›®å‰ä¸ºæ­¢ï¼Œ<code>Glide</code><strong>å•ä¾‹å·²ç»è¢«åˆ›å»ºå‡ºæ¥äº†</strong>ï¼Œå…¶<code>requestManagerRetriever</code>ä¼šä½œä¸º<code>getRetriever(Context)</code>çš„è¿”å›å€¼è¿”å›ã€‚</p> <p>æ¥ä¸‹æ¥å›åˆ°<code>Glide.with</code>æ–¹æ³•ä¸­ï¼Œæ¥ç€æ‰§è¡Œçš„æ˜¯<code>RequestManagerRetriever.get</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æ ¹æ®å…¥å‚æ˜¯å¯¹ç”Ÿå‘½å‘¨æœŸå¯æ„Ÿçš„ã€‚</p> <h3 id=12-requestmanagerretrieverget>1.2 RequestManagerRetriever.get<a class=headerlink href=#12-requestmanagerretrieverget title="Anchor link to this section for reference">&para;</a></h3> <p><code>RequestManagerRetriever.get</code>æ–¹æ³•ä¸<code>Glide.with</code>ä¸€æ ·ï¼Œä¹Ÿæœ‰å¾ˆå¤šé‡è½½æ–¹æ³•ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-7-1 name=__codelineno-7-1></a><a href=#__codelineno-7-1><span class=linenos data-linenos="  1 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-7-2 name=__codelineno-7-2></a><a href=#__codelineno-7-2><span class=linenos data-linenos="  2 "></span></a><span class=kd>private</span> <span class=n>RequestManager</span> <span class=nf>getApplicationManager</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-7-3 name=__codelineno-7-3></a><a href=#__codelineno-7-3><span class=linenos data-linenos="  3 "></span></a>  <span class=c1>// Either an application context or we&#39;re on a background thread.</span>
<a id=__codelineno-7-4 name=__codelineno-7-4></a><a href=#__codelineno-7-4><span class=linenos data-linenos="  4 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>applicationManager</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-7-5 name=__codelineno-7-5></a><a href=#__codelineno-7-5><span class=linenos data-linenos="  5 "></span></a>    <span class=kd>synchronized</span> <span class=p>(</span><span class=k>this</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-7-6 name=__codelineno-7-6></a><a href=#__codelineno-7-6><span class=linenos data-linenos="  6 "></span></a>      <span class=k>if</span> <span class=p>(</span><span class=n>applicationManager</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-7-7 name=__codelineno-7-7></a><a href=#__codelineno-7-7><span class=linenos data-linenos="  7 "></span></a>        <span class=c1>// Normally pause/resume is taken care of by the fragment we add to the fragment or</span>
<a id=__codelineno-7-8 name=__codelineno-7-8></a><a href=#__codelineno-7-8><span class=linenos data-linenos="  8 "></span></a>        <span class=c1>// activity. However, in this case since the manager attached to the application will not</span>
<a id=__codelineno-7-9 name=__codelineno-7-9></a><a href=#__codelineno-7-9><span class=linenos data-linenos="  9 "></span></a>        <span class=c1>// receive lifecycle events, we must force the manager to start resumed using</span>
<a id=__codelineno-7-10 name=__codelineno-7-10></a><a href=#__codelineno-7-10><span class=linenos data-linenos=" 10 "></span></a>        <span class=c1>// ApplicationLifecycle.</span>
<a id=__codelineno-7-11 name=__codelineno-7-11></a><a href=#__codelineno-7-11><span class=linenos data-linenos=" 11 "></span></a>
<a id=__codelineno-7-12 name=__codelineno-7-12></a><a href=#__codelineno-7-12><span class=linenos data-linenos=" 12 "></span></a>        <span class=c1>// TODO(b/27524013): Factor out this Glide.get() call.</span>
<a id=__codelineno-7-13 name=__codelineno-7-13></a><a href=#__codelineno-7-13><span class=linenos data-linenos=" 13 "></span></a>        <span class=n>Glide</span> <span class=n>glide</span> <span class=o>=</span> <span class=n>Glide</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>context</span><span class=p>.</span><span class=na>getApplicationContext</span><span class=p>());</span>
<a id=__codelineno-7-14 name=__codelineno-7-14></a><a href=#__codelineno-7-14><span class=linenos data-linenos=" 14 "></span></a>        <span class=n>applicationManager</span> <span class=o>=</span>
<a id=__codelineno-7-15 name=__codelineno-7-15></a><a href=#__codelineno-7-15><span class=linenos data-linenos=" 15 "></span></a>            <span class=n>factory</span><span class=p>.</span><span class=na>build</span><span class=p>(</span>
<a id=__codelineno-7-16 name=__codelineno-7-16></a><a href=#__codelineno-7-16><span class=linenos data-linenos=" 16 "></span></a>                <span class=n>glide</span><span class=p>,</span>
<a id=__codelineno-7-17 name=__codelineno-7-17></a><a href=#__codelineno-7-17><span class=linenos data-linenos=" 17 "></span></a>                <span class=k>new</span> <span class=n>ApplicationLifecycle</span><span class=p>(),</span>
<a id=__codelineno-7-18 name=__codelineno-7-18></a><a href=#__codelineno-7-18><span class=linenos data-linenos=" 18 "></span></a>                <span class=k>new</span> <span class=n>EmptyRequestManagerTreeNode</span><span class=p>(),</span>
<a id=__codelineno-7-19 name=__codelineno-7-19></a><a href=#__codelineno-7-19><span class=linenos data-linenos=" 19 "></span></a>                <span class=n>context</span><span class=p>.</span><span class=na>getApplicationContext</span><span class=p>());</span>
<a id=__codelineno-7-20 name=__codelineno-7-20></a><a href=#__codelineno-7-20><span class=linenos data-linenos=" 20 "></span></a>      <span class=p>}</span>
<a id=__codelineno-7-21 name=__codelineno-7-21></a><a href=#__codelineno-7-21><span class=linenos data-linenos=" 21 "></span></a>    <span class=p>}</span>
<a id=__codelineno-7-22 name=__codelineno-7-22></a><a href=#__codelineno-7-22><span class=linenos data-linenos=" 22 "></span></a>  <span class=p>}</span>
<a id=__codelineno-7-23 name=__codelineno-7-23></a><a href=#__codelineno-7-23><span class=linenos data-linenos=" 23 "></span></a>
<a id=__codelineno-7-24 name=__codelineno-7-24></a><a href=#__codelineno-7-24><span class=linenos data-linenos=" 24 "></span></a>  <span class=k>return</span> <span class=n>applicationManager</span><span class=p>;</span>
<a id=__codelineno-7-25 name=__codelineno-7-25></a><a href=#__codelineno-7-25><span class=linenos data-linenos=" 25 "></span></a><span class=p>}</span>
<a id=__codelineno-7-26 name=__codelineno-7-26></a><a href=#__codelineno-7-26><span class=linenos data-linenos=" 26 "></span></a>
<a id=__codelineno-7-27 name=__codelineno-7-27></a><a href=#__codelineno-7-27><span class=linenos data-linenos=" 27 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-7-28 name=__codelineno-7-28></a><a href=#__codelineno-7-28><span class=linenos data-linenos=" 28 "></span></a><span class=kd>public</span> <span class=n>RequestManager</span> <span class=nf>get</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-7-29 name=__codelineno-7-29></a><a href=#__codelineno-7-29><span class=linenos data-linenos=" 29 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>context</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-7-30 name=__codelineno-7-30></a><a href=#__codelineno-7-30><span class=linenos data-linenos=" 30 "></span></a>    <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&quot;You cannot start a load on a null Context&quot;</span><span class=p>);</span>
<a id=__codelineno-7-31 name=__codelineno-7-31></a><a href=#__codelineno-7-31><span class=linenos data-linenos=" 31 "></span></a>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>Util</span><span class=p>.</span><span class=na>isOnMainThread</span><span class=p>()</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=p>(</span><span class=n>context</span> <span class=k>instanceof</span> <span class=n>Application</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-7-32 name=__codelineno-7-32></a><a href=#__codelineno-7-32><span class=linenos data-linenos=" 32 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>context</span> <span class=k>instanceof</span> <span class=n>FragmentActivity</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-7-33 name=__codelineno-7-33></a><a href=#__codelineno-7-33><span class=linenos data-linenos=" 33 "></span></a>      <span class=k>return</span> <span class=n>get</span><span class=p>((</span><span class=n>FragmentActivity</span><span class=p>)</span> <span class=n>context</span><span class=p>);</span>
<a id=__codelineno-7-34 name=__codelineno-7-34></a><a href=#__codelineno-7-34><span class=linenos data-linenos=" 34 "></span></a>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>context</span> <span class=k>instanceof</span> <span class=n>Activity</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-7-35 name=__codelineno-7-35></a><a href=#__codelineno-7-35><span class=linenos data-linenos=" 35 "></span></a>      <span class=k>return</span> <span class=n>get</span><span class=p>((</span><span class=n>Activity</span><span class=p>)</span> <span class=n>context</span><span class=p>);</span>
<a id=__codelineno-7-36 name=__codelineno-7-36></a><a href=#__codelineno-7-36><span class=linenos data-linenos=" 36 "></span></a>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>context</span> <span class=k>instanceof</span> <span class=n>ContextWrapper</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-7-37 name=__codelineno-7-37></a><a href=#__codelineno-7-37><span class=linenos data-linenos=" 37 "></span></a>      <span class=k>return</span> <span class=n>get</span><span class=p>(((</span><span class=n>ContextWrapper</span><span class=p>)</span> <span class=n>context</span><span class=p>).</span><span class=na>getBaseContext</span><span class=p>());</span>
<a id=__codelineno-7-38 name=__codelineno-7-38></a><a href=#__codelineno-7-38><span class=linenos data-linenos=" 38 "></span></a>    <span class=p>}</span>
<a id=__codelineno-7-39 name=__codelineno-7-39></a><a href=#__codelineno-7-39><span class=linenos data-linenos=" 39 "></span></a>  <span class=p>}</span>
<a id=__codelineno-7-40 name=__codelineno-7-40></a><a href=#__codelineno-7-40><span class=linenos data-linenos=" 40 "></span></a>
<a id=__codelineno-7-41 name=__codelineno-7-41></a><a href=#__codelineno-7-41><span class=linenos data-linenos=" 41 "></span></a>  <span class=k>return</span> <span class=n>getApplicationManager</span><span class=p>(</span><span class=n>context</span><span class=p>);</span>
<a id=__codelineno-7-42 name=__codelineno-7-42></a><a href=#__codelineno-7-42><span class=linenos data-linenos=" 42 "></span></a><span class=p>}</span>
<a id=__codelineno-7-43 name=__codelineno-7-43></a><a href=#__codelineno-7-43><span class=linenos data-linenos=" 43 "></span></a>
<a id=__codelineno-7-44 name=__codelineno-7-44></a><a href=#__codelineno-7-44><span class=linenos data-linenos=" 44 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-7-45 name=__codelineno-7-45></a><a href=#__codelineno-7-45><span class=linenos data-linenos=" 45 "></span></a><span class=kd>public</span> <span class=n>RequestManager</span> <span class=nf>get</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>FragmentActivity</span> <span class=n>activity</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-7-46 name=__codelineno-7-46></a><a href=#__codelineno-7-46><span class=linenos data-linenos=" 46 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>Util</span><span class=p>.</span><span class=na>isOnBackgroundThread</span><span class=p>())</span> <span class=p>{</span>
<a id=__codelineno-7-47 name=__codelineno-7-47></a><a href=#__codelineno-7-47><span class=linenos data-linenos=" 47 "></span></a>    <span class=k>return</span> <span class=n>get</span><span class=p>(</span><span class=n>activity</span><span class=p>.</span><span class=na>getApplicationContext</span><span class=p>());</span>
<a id=__codelineno-7-48 name=__codelineno-7-48></a><a href=#__codelineno-7-48><span class=linenos data-linenos=" 48 "></span></a>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
<a id=__codelineno-7-49 name=__codelineno-7-49></a><a href=#__codelineno-7-49><span class=linenos data-linenos=" 49 "></span></a>    <span class=n>assertNotDestroyed</span><span class=p>(</span><span class=n>activity</span><span class=p>);</span>
<a id=__codelineno-7-50 name=__codelineno-7-50></a><a href=#__codelineno-7-50><span class=linenos data-linenos=" 50 "></span></a>    <span class=n>FragmentManager</span> <span class=n>fm</span> <span class=o>=</span> <span class=n>activity</span><span class=p>.</span><span class=na>getSupportFragmentManager</span><span class=p>();</span>
<a id=__codelineno-7-51 name=__codelineno-7-51></a><a href=#__codelineno-7-51><span class=linenos data-linenos=" 51 "></span></a>    <span class=k>return</span> <span class=n>supportFragmentGet</span><span class=p>(</span>
<a id=__codelineno-7-52 name=__codelineno-7-52></a><a href=#__codelineno-7-52><span class=linenos data-linenos=" 52 "></span></a>        <span class=n>activity</span><span class=p>,</span> <span class=n>fm</span><span class=p>,</span> <span class=cm>/*parentHint=*/</span> <span class=kc>null</span><span class=p>,</span> <span class=n>isActivityVisible</span><span class=p>(</span><span class=n>activity</span><span class=p>));</span>
<a id=__codelineno-7-53 name=__codelineno-7-53></a><a href=#__codelineno-7-53><span class=linenos data-linenos=" 53 "></span></a>  <span class=p>}</span>
<a id=__codelineno-7-54 name=__codelineno-7-54></a><a href=#__codelineno-7-54><span class=linenos data-linenos=" 54 "></span></a><span class=p>}</span>
<a id=__codelineno-7-55 name=__codelineno-7-55></a><a href=#__codelineno-7-55><span class=linenos data-linenos=" 55 "></span></a>
<a id=__codelineno-7-56 name=__codelineno-7-56></a><a href=#__codelineno-7-56><span class=linenos data-linenos=" 56 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-7-57 name=__codelineno-7-57></a><a href=#__codelineno-7-57><span class=linenos data-linenos=" 57 "></span></a><span class=kd>public</span> <span class=n>RequestManager</span> <span class=nf>get</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Fragment</span> <span class=n>fragment</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-7-58 name=__codelineno-7-58></a><a href=#__codelineno-7-58><span class=linenos data-linenos=" 58 "></span></a>  <span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>fragment</span><span class=p>.</span><span class=na>getActivity</span><span class=p>(),</span>
<a id=__codelineno-7-59 name=__codelineno-7-59></a><a href=#__codelineno-7-59><span class=linenos data-linenos=" 59 "></span></a>        <span class=s>&quot;You cannot start a load on a fragment before it is attached or after it is destroyed&quot;</span><span class=p>);</span>
<a id=__codelineno-7-60 name=__codelineno-7-60></a><a href=#__codelineno-7-60><span class=linenos data-linenos=" 60 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>Util</span><span class=p>.</span><span class=na>isOnBackgroundThread</span><span class=p>())</span> <span class=p>{</span>
<a id=__codelineno-7-61 name=__codelineno-7-61></a><a href=#__codelineno-7-61><span class=linenos data-linenos=" 61 "></span></a>    <span class=k>return</span> <span class=n>get</span><span class=p>(</span><span class=n>fragment</span><span class=p>.</span><span class=na>getActivity</span><span class=p>().</span><span class=na>getApplicationContext</span><span class=p>());</span>
<a id=__codelineno-7-62 name=__codelineno-7-62></a><a href=#__codelineno-7-62><span class=linenos data-linenos=" 62 "></span></a>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
<a id=__codelineno-7-63 name=__codelineno-7-63></a><a href=#__codelineno-7-63><span class=linenos data-linenos=" 63 "></span></a>    <span class=n>FragmentManager</span> <span class=n>fm</span> <span class=o>=</span> <span class=n>fragment</span><span class=p>.</span><span class=na>getChildFragmentManager</span><span class=p>();</span>
<a id=__codelineno-7-64 name=__codelineno-7-64></a><a href=#__codelineno-7-64><span class=linenos data-linenos=" 64 "></span></a>    <span class=k>return</span> <span class=n>supportFragmentGet</span><span class=p>(</span><span class=n>fragment</span><span class=p>.</span><span class=na>getActivity</span><span class=p>(),</span> <span class=n>fm</span><span class=p>,</span> <span class=n>fragment</span><span class=p>,</span> <span class=n>fragment</span><span class=p>.</span><span class=na>isVisible</span><span class=p>());</span>
<a id=__codelineno-7-65 name=__codelineno-7-65></a><a href=#__codelineno-7-65><span class=linenos data-linenos=" 65 "></span></a>  <span class=p>}</span>
<a id=__codelineno-7-66 name=__codelineno-7-66></a><a href=#__codelineno-7-66><span class=linenos data-linenos=" 66 "></span></a><span class=p>}</span>
<a id=__codelineno-7-67 name=__codelineno-7-67></a><a href=#__codelineno-7-67><span class=linenos data-linenos=" 67 "></span></a>
<a id=__codelineno-7-68 name=__codelineno-7-68></a><a href=#__codelineno-7-68><span class=linenos data-linenos=" 68 "></span></a><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;deprecation&quot;</span><span class=p>)</span>
<a id=__codelineno-7-69 name=__codelineno-7-69></a><a href=#__codelineno-7-69><span class=linenos data-linenos=" 69 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-7-70 name=__codelineno-7-70></a><a href=#__codelineno-7-70><span class=linenos data-linenos=" 70 "></span></a><span class=kd>public</span> <span class=n>RequestManager</span> <span class=nf>get</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Activity</span> <span class=n>activity</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-7-71 name=__codelineno-7-71></a><a href=#__codelineno-7-71><span class=linenos data-linenos=" 71 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>Util</span><span class=p>.</span><span class=na>isOnBackgroundThread</span><span class=p>())</span> <span class=p>{</span>
<a id=__codelineno-7-72 name=__codelineno-7-72></a><a href=#__codelineno-7-72><span class=linenos data-linenos=" 72 "></span></a>    <span class=k>return</span> <span class=n>get</span><span class=p>(</span><span class=n>activity</span><span class=p>.</span><span class=na>getApplicationContext</span><span class=p>());</span>
<a id=__codelineno-7-73 name=__codelineno-7-73></a><a href=#__codelineno-7-73><span class=linenos data-linenos=" 73 "></span></a>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
<a id=__codelineno-7-74 name=__codelineno-7-74></a><a href=#__codelineno-7-74><span class=linenos data-linenos=" 74 "></span></a>    <span class=n>assertNotDestroyed</span><span class=p>(</span><span class=n>activity</span><span class=p>);</span>
<a id=__codelineno-7-75 name=__codelineno-7-75></a><a href=#__codelineno-7-75><span class=linenos data-linenos=" 75 "></span></a>    <span class=n>android</span><span class=p>.</span><span class=na>app</span><span class=p>.</span><span class=na>FragmentManager</span> <span class=n>fm</span> <span class=o>=</span> <span class=n>activity</span><span class=p>.</span><span class=na>getFragmentManager</span><span class=p>();</span>
<a id=__codelineno-7-76 name=__codelineno-7-76></a><a href=#__codelineno-7-76><span class=linenos data-linenos=" 76 "></span></a>    <span class=k>return</span> <span class=n>fragmentGet</span><span class=p>(</span>
<a id=__codelineno-7-77 name=__codelineno-7-77></a><a href=#__codelineno-7-77><span class=linenos data-linenos=" 77 "></span></a>        <span class=n>activity</span><span class=p>,</span> <span class=n>fm</span><span class=p>,</span> <span class=cm>/*parentHint=*/</span> <span class=kc>null</span><span class=p>,</span> <span class=n>isActivityVisible</span><span class=p>(</span><span class=n>activity</span><span class=p>));</span>
<a id=__codelineno-7-78 name=__codelineno-7-78></a><a href=#__codelineno-7-78><span class=linenos data-linenos=" 78 "></span></a>  <span class=p>}</span>
<a id=__codelineno-7-79 name=__codelineno-7-79></a><a href=#__codelineno-7-79><span class=linenos data-linenos=" 79 "></span></a><span class=p>}</span>
<a id=__codelineno-7-80 name=__codelineno-7-80></a><a href=#__codelineno-7-80><span class=linenos data-linenos=" 80 "></span></a>
<a id=__codelineno-7-81 name=__codelineno-7-81></a><a href=#__codelineno-7-81><span class=linenos data-linenos=" 81 "></span></a><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;deprecation&quot;</span><span class=p>)</span>
<a id=__codelineno-7-82 name=__codelineno-7-82></a><a href=#__codelineno-7-82><span class=linenos data-linenos=" 82 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-7-83 name=__codelineno-7-83></a><a href=#__codelineno-7-83><span class=linenos data-linenos=" 83 "></span></a><span class=kd>public</span> <span class=n>RequestManager</span> <span class=nf>get</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>View</span> <span class=n>view</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-7-84 name=__codelineno-7-84></a><a href=#__codelineno-7-84><span class=linenos data-linenos=" 84 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>Util</span><span class=p>.</span><span class=na>isOnBackgroundThread</span><span class=p>())</span> <span class=p>{</span>
<a id=__codelineno-7-85 name=__codelineno-7-85></a><a href=#__codelineno-7-85><span class=linenos data-linenos=" 85 "></span></a>    <span class=k>return</span> <span class=n>get</span><span class=p>(</span><span class=n>view</span><span class=p>.</span><span class=na>getContext</span><span class=p>().</span><span class=na>getApplicationContext</span><span class=p>());</span>
<a id=__codelineno-7-86 name=__codelineno-7-86></a><a href=#__codelineno-7-86><span class=linenos data-linenos=" 86 "></span></a>  <span class=p>}</span>
<a id=__codelineno-7-87 name=__codelineno-7-87></a><a href=#__codelineno-7-87><span class=linenos data-linenos=" 87 "></span></a>
<a id=__codelineno-7-88 name=__codelineno-7-88></a><a href=#__codelineno-7-88><span class=linenos data-linenos=" 88 "></span></a>  <span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>view</span><span class=p>);</span>
<a id=__codelineno-7-89 name=__codelineno-7-89></a><a href=#__codelineno-7-89><span class=linenos data-linenos=" 89 "></span></a>  <span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>view</span><span class=p>.</span><span class=na>getContext</span><span class=p>(),</span>
<a id=__codelineno-7-90 name=__codelineno-7-90></a><a href=#__codelineno-7-90><span class=linenos data-linenos=" 90 "></span></a>      <span class=s>&quot;Unable to obtain a request manager for a view without a Context&quot;</span><span class=p>);</span>
<a id=__codelineno-7-91 name=__codelineno-7-91></a><a href=#__codelineno-7-91><span class=linenos data-linenos=" 91 "></span></a>  <span class=n>Activity</span> <span class=n>activity</span> <span class=o>=</span> <span class=n>findActivity</span><span class=p>(</span><span class=n>view</span><span class=p>.</span><span class=na>getContext</span><span class=p>());</span>
<a id=__codelineno-7-92 name=__codelineno-7-92></a><a href=#__codelineno-7-92><span class=linenos data-linenos=" 92 "></span></a>  <span class=c1>// The view might be somewhere else, like a service.</span>
<a id=__codelineno-7-93 name=__codelineno-7-93></a><a href=#__codelineno-7-93><span class=linenos data-linenos=" 93 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>activity</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-7-94 name=__codelineno-7-94></a><a href=#__codelineno-7-94><span class=linenos data-linenos=" 94 "></span></a>    <span class=k>return</span> <span class=n>get</span><span class=p>(</span><span class=n>view</span><span class=p>.</span><span class=na>getContext</span><span class=p>().</span><span class=na>getApplicationContext</span><span class=p>());</span>
<a id=__codelineno-7-95 name=__codelineno-7-95></a><a href=#__codelineno-7-95><span class=linenos data-linenos=" 95 "></span></a>  <span class=p>}</span>
<a id=__codelineno-7-96 name=__codelineno-7-96></a><a href=#__codelineno-7-96><span class=linenos data-linenos=" 96 "></span></a>
<a id=__codelineno-7-97 name=__codelineno-7-97></a><a href=#__codelineno-7-97><span class=linenos data-linenos=" 97 "></span></a>  <span class=c1>// Support Fragments.</span>
<a id=__codelineno-7-98 name=__codelineno-7-98></a><a href=#__codelineno-7-98><span class=linenos data-linenos=" 98 "></span></a>  <span class=c1>// Although the user might have non-support Fragments attached to FragmentActivity, searching</span>
<a id=__codelineno-7-99 name=__codelineno-7-99></a><a href=#__codelineno-7-99><span class=linenos data-linenos=" 99 "></span></a>  <span class=c1>// for non-support Fragments is so expensive pre O and that should be rare enough that we</span>
<a id=__codelineno-7-100 name=__codelineno-7-100></a><a href=#__codelineno-7-100><span class=linenos data-linenos="100 "></span></a>  <span class=c1>// prefer to just fall back to the Activity directly.</span>
<a id=__codelineno-7-101 name=__codelineno-7-101></a><a href=#__codelineno-7-101><span class=linenos data-linenos="101 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>activity</span> <span class=k>instanceof</span> <span class=n>FragmentActivity</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-7-102 name=__codelineno-7-102></a><a href=#__codelineno-7-102><span class=linenos data-linenos="102 "></span></a>    <span class=n>Fragment</span> <span class=n>fragment</span> <span class=o>=</span> <span class=n>findSupportFragment</span><span class=p>(</span><span class=n>view</span><span class=p>,</span> <span class=p>(</span><span class=n>FragmentActivity</span><span class=p>)</span> <span class=n>activity</span><span class=p>);</span>
<a id=__codelineno-7-103 name=__codelineno-7-103></a><a href=#__codelineno-7-103><span class=linenos data-linenos="103 "></span></a>    <span class=k>return</span> <span class=n>fragment</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>?</span> <span class=n>get</span><span class=p>(</span><span class=n>fragment</span><span class=p>)</span> <span class=p>:</span> <span class=n>get</span><span class=p>(</span><span class=n>activity</span><span class=p>);</span>
<a id=__codelineno-7-104 name=__codelineno-7-104></a><a href=#__codelineno-7-104><span class=linenos data-linenos="104 "></span></a>  <span class=p>}</span>
<a id=__codelineno-7-105 name=__codelineno-7-105></a><a href=#__codelineno-7-105><span class=linenos data-linenos="105 "></span></a>
<a id=__codelineno-7-106 name=__codelineno-7-106></a><a href=#__codelineno-7-106><span class=linenos data-linenos="106 "></span></a>  <span class=c1>// Standard Fragments.</span>
<a id=__codelineno-7-107 name=__codelineno-7-107></a><a href=#__codelineno-7-107><span class=linenos data-linenos="107 "></span></a>  <span class=n>android</span><span class=p>.</span><span class=na>app</span><span class=p>.</span><span class=na>Fragment</span> <span class=n>fragment</span> <span class=o>=</span> <span class=n>findFragment</span><span class=p>(</span><span class=n>view</span><span class=p>,</span> <span class=n>activity</span><span class=p>);</span>
<a id=__codelineno-7-108 name=__codelineno-7-108></a><a href=#__codelineno-7-108><span class=linenos data-linenos="108 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>fragment</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-7-109 name=__codelineno-7-109></a><a href=#__codelineno-7-109><span class=linenos data-linenos="109 "></span></a>    <span class=k>return</span> <span class=n>get</span><span class=p>(</span><span class=n>activity</span><span class=p>);</span>
<a id=__codelineno-7-110 name=__codelineno-7-110></a><a href=#__codelineno-7-110><span class=linenos data-linenos="110 "></span></a>  <span class=p>}</span>
<a id=__codelineno-7-111 name=__codelineno-7-111></a><a href=#__codelineno-7-111><span class=linenos data-linenos="111 "></span></a>  <span class=k>return</span> <span class=n>get</span><span class=p>(</span><span class=n>fragment</span><span class=p>);</span>
<a id=__codelineno-7-112 name=__codelineno-7-112></a><a href=#__codelineno-7-112><span class=linenos data-linenos="112 "></span></a><span class=p>}</span>
</code></pre></div> <p>åœ¨è¿™äº›<code>get</code>æ–¹æ³•ä¸­ï¼Œ<strong>é¦–å…ˆåˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯ä¸æ˜¯åå°çº¿ç¨‹</strong>ï¼Œå¦‚æœæ˜¯åå°çº¿ç¨‹é‚£ä¹ˆå°±ä¼šè°ƒç”¨<code>getApplicationManager</code>æ–¹æ³•è¿”å›ä¸€ä¸ª<code>RequestManager</code>ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-8-1 name=__codelineno-8-1></a><a href=#__codelineno-8-1><span class=linenos data-linenos="1 "></span></a><span class=n>Glide</span> <span class=n>glide</span> <span class=o>=</span> <span class=n>Glide</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>context</span><span class=p>.</span><span class=na>getApplicationContext</span><span class=p>());</span>
<a id=__codelineno-8-2 name=__codelineno-8-2></a><a href=#__codelineno-8-2><span class=linenos data-linenos="2 "></span></a><span class=n>applicationManager</span> <span class=o>=</span>
<a id=__codelineno-8-3 name=__codelineno-8-3></a><a href=#__codelineno-8-3><span class=linenos data-linenos="3 "></span></a>    <span class=n>factory</span><span class=p>.</span><span class=na>build</span><span class=p>(</span>
<a id=__codelineno-8-4 name=__codelineno-8-4></a><a href=#__codelineno-8-4><span class=linenos data-linenos="4 "></span></a>        <span class=n>glide</span><span class=p>,</span>
<a id=__codelineno-8-5 name=__codelineno-8-5></a><a href=#__codelineno-8-5><span class=linenos data-linenos="5 "></span></a>        <span class=k>new</span> <span class=n>ApplicationLifecycle</span><span class=p>(),</span>
<a id=__codelineno-8-6 name=__codelineno-8-6></a><a href=#__codelineno-8-6><span class=linenos data-linenos="6 "></span></a>        <span class=k>new</span> <span class=n>EmptyRequestManagerTreeNode</span><span class=p>(),</span>
<a id=__codelineno-8-7 name=__codelineno-8-7></a><a href=#__codelineno-8-7><span class=linenos data-linenos="7 "></span></a>        <span class=n>context</span><span class=p>.</span><span class=na>getApplicationContext</span><span class=p>());</span>
</code></pre></div> <p>ç”±äºæ­¤å¤„<code>factory</code>æ˜¯<code>DEFAULT_FACTORY</code>ï¼Œæ‰€ä»¥<code>RequestManager</code>å°±æ˜¯ä¸‹é¢çš„å€¼ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-9-1 name=__codelineno-9-1></a><a href=#__codelineno-9-1><span class=linenos data-linenos="1 "></span></a><span class=n>RequestManager</span><span class=p>(</span><span class=n>glide</span><span class=p>,</span>
<a id=__codelineno-9-2 name=__codelineno-9-2></a><a href=#__codelineno-9-2><span class=linenos data-linenos="2 "></span></a>        <span class=k>new</span> <span class=n>ApplicationLifecycle</span><span class=p>(),</span>
<a id=__codelineno-9-3 name=__codelineno-9-3></a><a href=#__codelineno-9-3><span class=linenos data-linenos="3 "></span></a>        <span class=k>new</span> <span class=n>EmptyRequestManagerTreeNode</span><span class=p>(),</span>
<a id=__codelineno-9-4 name=__codelineno-9-4></a><a href=#__codelineno-9-4><span class=linenos data-linenos="4 "></span></a>        <span class=n>context</span><span class=p>.</span><span class=na>getApplicationContext</span><span class=p>());</span>
</code></pre></div> <p><strong>å¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯åå°çº¿ç¨‹</strong>ï¼Œ<code>get(View)</code>å’Œ<code>get(Context)</code>ä¼šæ ¹æ®æƒ…å†µè°ƒç”¨<code>get(Fragment)</code>æˆ–<code>get(FragmentActivity)</code>ã€‚å…¶ä¸­<code>get(View)</code>ä¸ºäº†æ‰¾åˆ°ä¸€ä¸ªåˆé€‚çš„<code>Fragment</code>æˆ–fallback <code>Activity</code>ï¼Œå†…éƒ¨æ“ä½œæ¯”è¾ƒå¤šï¼Œå¼€é”€æ¯”è¾ƒå¤§ï¼Œä¸è¦è½»æ˜“ä½¿ç”¨ã€‚</p> <p><code>get(Fragment)</code>å’Œ<code>get(FragmentActivity)</code>æ–¹æ³•éƒ½ä¼šè°ƒç”¨<code>supportFragmentGet</code>æ–¹æ³•ï¼Œåªæ˜¯ä¼ å…¥å‚æ•°ä¸åŒï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-10-1 name=__codelineno-10-1></a><a href=#__codelineno-10-1><span class=linenos data-linenos="1 "></span></a><span class=c1>// FragmentActivity activity</span>
<a id=__codelineno-10-2 name=__codelineno-10-2></a><a href=#__codelineno-10-2><span class=linenos data-linenos="2 "></span></a><span class=n>FragmentManager</span> <span class=n>fm</span> <span class=o>=</span> <span class=n>activity</span><span class=p>.</span><span class=na>getSupportFragmentManager</span><span class=p>();</span>
<a id=__codelineno-10-3 name=__codelineno-10-3></a><a href=#__codelineno-10-3><span class=linenos data-linenos="3 "></span></a><span class=n>supportFragmentGet</span><span class=p>(</span><span class=n>activity</span><span class=p>,</span> <span class=n>fm</span><span class=p>,</span> <span class=cm>/*parentHint=*/</span> <span class=kc>null</span><span class=p>,</span> <span class=n>isActivityVisible</span><span class=p>(</span><span class=n>activity</span><span class=p>));</span>
<a id=__codelineno-10-4 name=__codelineno-10-4></a><a href=#__codelineno-10-4><span class=linenos data-linenos="4 "></span></a>
<a id=__codelineno-10-5 name=__codelineno-10-5></a><a href=#__codelineno-10-5><span class=linenos data-linenos="5 "></span></a><span class=c1>// Fragment fragment</span>
<a id=__codelineno-10-6 name=__codelineno-10-6></a><a href=#__codelineno-10-6><span class=linenos data-linenos="6 "></span></a><span class=n>FragmentManager</span> <span class=n>fm</span> <span class=o>=</span> <span class=n>fragment</span><span class=p>.</span><span class=na>getChildFragmentManager</span><span class=p>();</span>
<a id=__codelineno-10-7 name=__codelineno-10-7></a><a href=#__codelineno-10-7><span class=linenos data-linenos="7 "></span></a><span class=n>supportFragmentGet</span><span class=p>(</span><span class=n>fragment</span><span class=p>.</span><span class=na>getActivity</span><span class=p>(),</span> <span class=n>fm</span><span class=p>,</span> <span class=n>fragment</span><span class=p>,</span> <span class=n>fragment</span><span class=p>.</span><span class=na>isVisible</span><span class=p>());</span>
</code></pre></div> <blockquote> <p>Glideä¼šä½¿ç”¨ä¸€ä¸ªåŠ è½½ç›®æ ‡æ‰€åœ¨çš„å®¿ä¸»Activityæˆ–Fragmentçš„å­<code>Fragment</code>æ¥å®‰å…¨ä¿å­˜ä¸€ä¸ª<code>RequestManager</code>ï¼Œè€Œ<code>RequestManager</code>è¢«Glideç”¨æ¥å¼€å§‹ã€åœæ­¢ã€ç®¡ç†Glideè¯·æ±‚ã€‚</p> </blockquote> <p>è€Œ<code>supportFragmentGet</code>å°±æ˜¯åˆ›å»º/è·å–è¿™ä¸ª<code>SupportRequestManagerFragment</code>ï¼Œå¹¶è¿”å›å…¶æŒæœ‰çš„<code>RequestManager</code>çš„æ–¹æ³•ã€‚</p> <div class=highlight><pre><span></span><code><a id=__codelineno-11-1 name=__codelineno-11-1></a><a href=#__codelineno-11-1><span class=linenos data-linenos=" 1 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-11-2 name=__codelineno-11-2></a><a href=#__codelineno-11-2><span class=linenos data-linenos=" 2 "></span></a><span class=kd>private</span> <span class=n>RequestManager</span> <span class=nf>supportFragmentGet</span><span class=p>(</span>
<a id=__codelineno-11-3 name=__codelineno-11-3></a><a href=#__codelineno-11-3><span class=linenos data-linenos=" 3 "></span></a>    <span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=p>,</span>
<a id=__codelineno-11-4 name=__codelineno-11-4></a><a href=#__codelineno-11-4><span class=linenos data-linenos=" 4 "></span></a>    <span class=nd>@NonNull</span> <span class=n>FragmentManager</span> <span class=n>fm</span><span class=p>,</span>
<a id=__codelineno-11-5 name=__codelineno-11-5></a><a href=#__codelineno-11-5><span class=linenos data-linenos=" 5 "></span></a>    <span class=nd>@Nullable</span> <span class=n>Fragment</span> <span class=n>parentHint</span><span class=p>,</span>
<a id=__codelineno-11-6 name=__codelineno-11-6></a><a href=#__codelineno-11-6><span class=linenos data-linenos=" 6 "></span></a>    <span class=kt>boolean</span> <span class=n>isParentVisible</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-11-7 name=__codelineno-11-7></a><a href=#__codelineno-11-7><span class=linenos data-linenos=" 7 "></span></a>  <span class=c1>// ğŸŸğŸŸğŸŸè·å–ä¸€ä¸ªSupportRequestManagerFragment</span>
<a id=__codelineno-11-8 name=__codelineno-11-8></a><a href=#__codelineno-11-8><span class=linenos data-linenos=" 8 "></span></a>  <span class=n>SupportRequestManagerFragment</span> <span class=n>current</span> <span class=o>=</span>
<a id=__codelineno-11-9 name=__codelineno-11-9></a><a href=#__codelineno-11-9><span class=linenos data-linenos=" 9 "></span></a>      <span class=n>getSupportRequestManagerFragment</span><span class=p>(</span><span class=n>fm</span><span class=p>,</span> <span class=n>parentHint</span><span class=p>,</span> <span class=n>isParentVisible</span><span class=p>);</span>
<a id=__codelineno-11-10 name=__codelineno-11-10></a><a href=#__codelineno-11-10><span class=linenos data-linenos="10 "></span></a>  <span class=c1>// è·å–é‡Œé¢çš„RequestManagerå¯¹è±¡</span>
<a id=__codelineno-11-11 name=__codelineno-11-11></a><a href=#__codelineno-11-11><span class=linenos data-linenos="11 "></span></a>  <span class=n>RequestManager</span> <span class=n>requestManager</span> <span class=o>=</span> <span class=n>current</span><span class=p>.</span><span class=na>getRequestManager</span><span class=p>();</span>
<a id=__codelineno-11-12 name=__codelineno-11-12></a><a href=#__codelineno-11-12><span class=linenos data-linenos="12 "></span></a>  <span class=c1>// è‹¥æ²¡æœ‰ï¼Œåˆ™åˆ›å»ºä¸€ä¸ª</span>
<a id=__codelineno-11-13 name=__codelineno-11-13></a><a href=#__codelineno-11-13><span class=linenos data-linenos="13 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>requestManager</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-11-14 name=__codelineno-11-14></a><a href=#__codelineno-11-14><span class=linenos data-linenos="14 "></span></a>    <span class=c1>// TODO(b/27524013): Factor out this Glide.get() call.</span>
<a id=__codelineno-11-15 name=__codelineno-11-15></a><a href=#__codelineno-11-15><span class=linenos data-linenos="15 "></span></a>    <span class=n>Glide</span> <span class=n>glide</span> <span class=o>=</span> <span class=n>Glide</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>context</span><span class=p>);</span>
<a id=__codelineno-11-16 name=__codelineno-11-16></a><a href=#__codelineno-11-16><span class=linenos data-linenos="16 "></span></a>    <span class=c1>// ğŸ”¥ğŸ”¥ğŸ”¥</span>
<a id=__codelineno-11-17 name=__codelineno-11-17></a><a href=#__codelineno-11-17><span class=linenos data-linenos="17 "></span></a>    <span class=n>requestManager</span> <span class=o>=</span>
<a id=__codelineno-11-18 name=__codelineno-11-18></a><a href=#__codelineno-11-18><span class=linenos data-linenos="18 "></span></a>        <span class=n>factory</span><span class=p>.</span><span class=na>build</span><span class=p>(</span>
<a id=__codelineno-11-19 name=__codelineno-11-19></a><a href=#__codelineno-11-19><span class=linenos data-linenos="19 "></span></a>            <span class=n>glide</span><span class=p>,</span> <span class=n>current</span><span class=p>.</span><span class=na>getGlideLifecycle</span><span class=p>(),</span> <span class=n>current</span><span class=p>.</span><span class=na>getRequestManagerTreeNode</span><span class=p>(),</span> <span class=n>context</span><span class=p>);</span>
<a id=__codelineno-11-20 name=__codelineno-11-20></a><a href=#__codelineno-11-20><span class=linenos data-linenos="20 "></span></a>    <span class=c1>// è®¾ç½®åˆ°SupportRequestManagerFragmenté‡Œé¢ï¼Œä¸‹æ¬¡å°±ä¸éœ€è¦åˆ›å»ºäº†</span>
<a id=__codelineno-11-21 name=__codelineno-11-21></a><a href=#__codelineno-11-21><span class=linenos data-linenos="21 "></span></a>    <span class=n>current</span><span class=p>.</span><span class=na>setRequestManager</span><span class=p>(</span><span class=n>requestManager</span><span class=p>);</span>
<a id=__codelineno-11-22 name=__codelineno-11-22></a><a href=#__codelineno-11-22><span class=linenos data-linenos="22 "></span></a>  <span class=p>}</span>
<a id=__codelineno-11-23 name=__codelineno-11-23></a><a href=#__codelineno-11-23><span class=linenos data-linenos="23 "></span></a>  <span class=k>return</span> <span class=n>requestManager</span><span class=p>;</span>
<a id=__codelineno-11-24 name=__codelineno-11-24></a><a href=#__codelineno-11-24><span class=linenos data-linenos="24 "></span></a><span class=p>}</span>
<a id=__codelineno-11-25 name=__codelineno-11-25></a><a href=#__codelineno-11-25><span class=linenos data-linenos="25 "></span></a>
<a id=__codelineno-11-26 name=__codelineno-11-26></a><a href=#__codelineno-11-26><span class=linenos data-linenos="26 "></span></a><span class=c1>// ğŸŸğŸŸğŸŸçœ‹çœ‹Fragmentæ€ä¹ˆæ‰èƒ½é«˜æ•ˆ</span>
<a id=__codelineno-11-27 name=__codelineno-11-27></a><a href=#__codelineno-11-27><span class=linenos data-linenos="27 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-11-28 name=__codelineno-11-28></a><a href=#__codelineno-11-28><span class=linenos data-linenos="28 "></span></a><span class=kd>private</span> <span class=n>SupportRequestManagerFragment</span> <span class=nf>getSupportRequestManagerFragment</span><span class=p>(</span>
<a id=__codelineno-11-29 name=__codelineno-11-29></a><a href=#__codelineno-11-29><span class=linenos data-linenos="29 "></span></a>    <span class=nd>@NonNull</span> <span class=kd>final</span> <span class=n>FragmentManager</span> <span class=n>fm</span><span class=p>,</span> <span class=nd>@Nullable</span> <span class=n>Fragment</span> <span class=n>parentHint</span><span class=p>,</span> <span class=kt>boolean</span> <span class=n>isParentVisible</span><span class=p>)</span> <span class=p>{</span>      
<a id=__codelineno-11-30 name=__codelineno-11-30></a><a href=#__codelineno-11-30><span class=linenos data-linenos="30 "></span></a>  <span class=c1>// å·²ç»æ·»åŠ è¿‡äº†ï¼Œå¯ä»¥ç›´æ¥è¿”å›</span>
<a id=__codelineno-11-31 name=__codelineno-11-31></a><a href=#__codelineno-11-31><span class=linenos data-linenos="31 "></span></a>  <span class=n>SupportRequestManagerFragment</span> <span class=n>current</span> <span class=o>=</span>
<a id=__codelineno-11-32 name=__codelineno-11-32></a><a href=#__codelineno-11-32><span class=linenos data-linenos="32 "></span></a>      <span class=p>(</span><span class=n>SupportRequestManagerFragment</span><span class=p>)</span> <span class=n>fm</span><span class=p>.</span><span class=na>findFragmentByTag</span><span class=p>(</span><span class=n>FRAGMENT_TAG</span><span class=p>);</span>
<a id=__codelineno-11-33 name=__codelineno-11-33></a><a href=#__codelineno-11-33><span class=linenos data-linenos="33 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>current</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-11-34 name=__codelineno-11-34></a><a href=#__codelineno-11-34><span class=linenos data-linenos="34 "></span></a>    <span class=c1>// ä»mapä¸­è·å–ï¼Œå–åˆ°ä¹Ÿå¯ä»¥è¿”å›äº†</span>
<a id=__codelineno-11-35 name=__codelineno-11-35></a><a href=#__codelineno-11-35><span class=linenos data-linenos="35 "></span></a>    <span class=n>current</span> <span class=o>=</span> <span class=n>pendingSupportRequestManagerFragments</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>fm</span><span class=p>);</span>
<a id=__codelineno-11-36 name=__codelineno-11-36></a><a href=#__codelineno-11-36><span class=linenos data-linenos="36 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>current</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-11-37 name=__codelineno-11-37></a><a href=#__codelineno-11-37><span class=linenos data-linenos="37 "></span></a>      <span class=c1>// éƒ½æ²¡æœ‰ï¼Œé‚£ä¹ˆå°±åˆ›å»ºä¸€ä¸ªï¼Œæ­¤æ—¶lifecycleé»˜è®¤ä¸ºActivityFragmentLifecycle</span>
<a id=__codelineno-11-38 name=__codelineno-11-38></a><a href=#__codelineno-11-38><span class=linenos data-linenos="38 "></span></a>      <span class=n>current</span> <span class=o>=</span> <span class=k>new</span> <span class=n>SupportRequestManagerFragment</span><span class=p>();</span>
<a id=__codelineno-11-39 name=__codelineno-11-39></a><a href=#__codelineno-11-39><span class=linenos data-linenos="39 "></span></a>      <span class=c1>// å¯¹äºfragmentæ¥è¯´ï¼Œæ­¤æ–¹æ³•ä¼šä»¥Activityä¸ºhoståˆ›å»ºå¦å¤–ä¸€ä¸ªSupportRequestManagerFragment</span>
<a id=__codelineno-11-40 name=__codelineno-11-40></a><a href=#__codelineno-11-40><span class=linenos data-linenos="40 "></span></a>      <span class=c1>// ä½œä¸ºrootRequestManagerFragment</span>
<a id=__codelineno-11-41 name=__codelineno-11-41></a><a href=#__codelineno-11-41><span class=linenos data-linenos="41 "></span></a>      <span class=c1>// å¹¶ä¼šå°†currentåŠ å…¥åˆ°rootRequestManagerFragmentçš„childRequestManagerFragmentsä¸­</span>
<a id=__codelineno-11-42 name=__codelineno-11-42></a><a href=#__codelineno-11-42><span class=linenos data-linenos="42 "></span></a>      <span class=c1>// åœ¨RequestManageré€’å½’ç®¡ç†è¯·æ±‚æ—¶ä¼šä½¿ç”¨åˆ°</span>
<a id=__codelineno-11-43 name=__codelineno-11-43></a><a href=#__codelineno-11-43><span class=linenos data-linenos="43 "></span></a>      <span class=n>current</span><span class=p>.</span><span class=na>setParentFragmentHint</span><span class=p>(</span><span class=n>parentHint</span><span class=p>);</span>
<a id=__codelineno-11-44 name=__codelineno-11-44></a><a href=#__codelineno-11-44><span class=linenos data-linenos="44 "></span></a>      <span class=c1>// å¦‚æœå½“å‰é¡µé¢æ˜¯å¯è§çš„ï¼Œé‚£ä¹ˆè°ƒç”¨å…¶lifecycleçš„onStartæ–¹æ³•</span>
<a id=__codelineno-11-45 name=__codelineno-11-45></a><a href=#__codelineno-11-45><span class=linenos data-linenos="45 "></span></a>      <span class=k>if</span> <span class=p>(</span><span class=n>isParentVisible</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-11-46 name=__codelineno-11-46></a><a href=#__codelineno-11-46><span class=linenos data-linenos="46 "></span></a>        <span class=n>current</span><span class=p>.</span><span class=na>getGlideLifecycle</span><span class=p>().</span><span class=na>onStart</span><span class=p>();</span>
<a id=__codelineno-11-47 name=__codelineno-11-47></a><a href=#__codelineno-11-47><span class=linenos data-linenos="47 "></span></a>      <span class=p>}</span>
<a id=__codelineno-11-48 name=__codelineno-11-48></a><a href=#__codelineno-11-48><span class=linenos data-linenos="48 "></span></a>      <span class=c1>// å°†åˆšåˆ›å»ºçš„fragmentç¼“å­˜èµ·æ¥</span>
<a id=__codelineno-11-49 name=__codelineno-11-49></a><a href=#__codelineno-11-49><span class=linenos data-linenos="49 "></span></a>      <span class=n>pendingSupportRequestManagerFragments</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>fm</span><span class=p>,</span> <span class=n>current</span><span class=p>);</span>
<a id=__codelineno-11-50 name=__codelineno-11-50></a><a href=#__codelineno-11-50><span class=linenos data-linenos="50 "></span></a>      <span class=c1>// å°†fragmentæ·»åŠ åˆ°é¡µé¢ä¸­</span>
<a id=__codelineno-11-51 name=__codelineno-11-51></a><a href=#__codelineno-11-51><span class=linenos data-linenos="51 "></span></a>      <span class=n>fm</span><span class=p>.</span><span class=na>beginTransaction</span><span class=p>().</span><span class=na>add</span><span class=p>(</span><span class=n>current</span><span class=p>,</span> <span class=n>FRAGMENT_TAG</span><span class=p>).</span><span class=na>commitAllowingStateLoss</span><span class=p>();</span>
<a id=__codelineno-11-52 name=__codelineno-11-52></a><a href=#__codelineno-11-52><span class=linenos data-linenos="52 "></span></a>      <span class=c1>// ä»¥fmä¸ºkeyä»pendingSupportRequestManagerFragmentsä¸­åˆ é™¤</span>
<a id=__codelineno-11-53 name=__codelineno-11-53></a><a href=#__codelineno-11-53><span class=linenos data-linenos="53 "></span></a>      <span class=n>handler</span><span class=p>.</span><span class=na>obtainMessage</span><span class=p>(</span><span class=n>ID_REMOVE_SUPPORT_FRAGMENT_MANAGER</span><span class=p>,</span> <span class=n>fm</span><span class=p>).</span><span class=na>sendToTarget</span><span class=p>();</span>
<a id=__codelineno-11-54 name=__codelineno-11-54></a><a href=#__codelineno-11-54><span class=linenos data-linenos="54 "></span></a>    <span class=p>}</span>
<a id=__codelineno-11-55 name=__codelineno-11-55></a><a href=#__codelineno-11-55><span class=linenos data-linenos="55 "></span></a>  <span class=p>}</span>
<a id=__codelineno-11-56 name=__codelineno-11-56></a><a href=#__codelineno-11-56><span class=linenos data-linenos="56 "></span></a>  <span class=k>return</span> <span class=n>current</span><span class=p>;</span>
<a id=__codelineno-11-57 name=__codelineno-11-57></a><a href=#__codelineno-11-57><span class=linenos data-linenos="57 "></span></a><span class=p>}</span>
</code></pre></div> <p>ğŸ”¥ğŸ”¥ğŸ”¥åœ¨ä¸Šé¢çš„<code>supportFragmentGet</code>æ–¹æ³•ä¸­ï¼ŒæˆåŠŸåˆ›å»ºäº†ä¸€ä¸ª<code>RequestManager</code>å¯¹è±¡ï¼Œç”±äº<code>factory</code>æ˜¯<code>DEFAULT_FACTORY</code>ï¼Œæ‰€ä»¥å°±æ˜¯ä¸‹é¢çš„å€¼ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-12-1 name=__codelineno-12-1></a><a href=#__codelineno-12-1><span class=linenos data-linenos="1 "></span></a><span class=n>RequestManager</span><span class=p>(</span><span class=n>glide</span><span class=p>,</span>
<a id=__codelineno-12-2 name=__codelineno-12-2></a><a href=#__codelineno-12-2><span class=linenos data-linenos="2 "></span></a>  <span class=n>current</span><span class=p>.</span><span class=na>getGlideLifecycle</span><span class=p>(),</span>          <span class=c1>// ActivityFragmentLifecycle()</span>
<a id=__codelineno-12-3 name=__codelineno-12-3></a><a href=#__codelineno-12-3><span class=linenos data-linenos="3 "></span></a>  <span class=n>current</span><span class=p>.</span><span class=na>getRequestManagerTreeNode</span><span class=p>(),</span>  <span class=c1>// SupportFragmentRequestManagerTreeNode()</span>
<a id=__codelineno-12-4 name=__codelineno-12-4></a><a href=#__codelineno-12-4><span class=linenos data-linenos="4 "></span></a>  <span class=n>context</span><span class=p>);</span>
</code></pre></div> <p>å¥½ğŸ‘ğŸ‘ğŸ‘ï¼Œåœ¨ä¸Šä¸€æ­¥ä¸­<code>Glide</code>å•ä¾‹å®Œæˆäº†åˆå§‹åŒ–ï¼Œè¿™ä¸€æ­¥ä¸­æˆåŠŸçš„åˆ›å»ºå¹¶è¿”å›äº†ä¸€ä¸ª<code>RequestManager</code>ã€‚<code>Glide.with</code>å·²ç»åˆ†æå®Œæ¯•ã€‚</p> <h2 id=2-requestmanagerload>2. RequestManager.load<a class=headerlink href=#2-requestmanagerload title="Anchor link to this section for reference">&para;</a></h2> <p><code>RequestManager.load</code>æ–¹æ³•çš„é‡è½½ä¹Ÿå¾ˆå¤šï¼Œä½†è¯¥æ–¹æ³•åªæ˜¯è®¾ç½®äº†ä¸€äº›å€¼è€Œå·²ï¼Œå¹¶æ²¡æœ‰åšä¸€äº›å¾ˆé‡çš„å·¥ä½œã€‚</p> <p>å› ä¸ºè¿™é‡Œæ¶‰åŠåˆ°ç±»æœ‰ç‚¹ç»•ï¼Œæ‰€ä»¥åœ¨æ­£å¼æ¢ç´¢ä¹‹å‰ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ç›¸å…³çš„ç±»çš„UMLå›¾ï¼š</p> <figure style="width: 66%" class=align-center> <img src=/assets/images/android/glide-request-options-uml.png> <figcaption>RequestOptionsç›¸å…³UMLå›¾</figcaption> </figure> <p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºæ¥<code>RequestBuilder</code>å’Œ<code>RequestOptions</code>éƒ½æ´¾ç”Ÿè‡ªæŠ½è±¡ç±»<code>BaseRequestOptions</code>ã€‚</p> <p>ä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸‹<code>RequestManager</code>çš„ä¸€äº›æ–¹æ³•ï¼Œå…ˆçœ‹<code>load</code>çš„ä¸€äº›é‡è½½æ–¹æ³•ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-13-1 name=__codelineno-13-1></a><a href=#__codelineno-13-1><span class=linenos data-linenos=" 1 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-13-2 name=__codelineno-13-2></a><a href=#__codelineno-13-2><span class=linenos data-linenos=" 2 "></span></a><span class=nd>@CheckResult</span>
<a id=__codelineno-13-3 name=__codelineno-13-3></a><a href=#__codelineno-13-3><span class=linenos data-linenos=" 3 "></span></a><span class=nd>@Override</span>
<a id=__codelineno-13-4 name=__codelineno-13-4></a><a href=#__codelineno-13-4><span class=linenos data-linenos=" 4 "></span></a><span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Drawable</span><span class=o>&gt;</span> <span class=nf>load</span><span class=p>(</span><span class=nd>@Nullable</span> <span class=n>Bitmap</span> <span class=n>bitmap</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-13-5 name=__codelineno-13-5></a><a href=#__codelineno-13-5><span class=linenos data-linenos=" 5 "></span></a>  <span class=k>return</span> <span class=n>asDrawable</span><span class=p>().</span><span class=na>load</span><span class=p>(</span><span class=n>bitmap</span><span class=p>);</span>
<a id=__codelineno-13-6 name=__codelineno-13-6></a><a href=#__codelineno-13-6><span class=linenos data-linenos=" 6 "></span></a><span class=p>}</span>
<a id=__codelineno-13-7 name=__codelineno-13-7></a><a href=#__codelineno-13-7><span class=linenos data-linenos=" 7 "></span></a>
<a id=__codelineno-13-8 name=__codelineno-13-8></a><a href=#__codelineno-13-8><span class=linenos data-linenos=" 8 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-13-9 name=__codelineno-13-9></a><a href=#__codelineno-13-9><span class=linenos data-linenos=" 9 "></span></a><span class=nd>@CheckResult</span>
<a id=__codelineno-13-10 name=__codelineno-13-10></a><a href=#__codelineno-13-10><span class=linenos data-linenos="10 "></span></a><span class=nd>@Override</span>
<a id=__codelineno-13-11 name=__codelineno-13-11></a><a href=#__codelineno-13-11><span class=linenos data-linenos="11 "></span></a><span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Drawable</span><span class=o>&gt;</span> <span class=nf>load</span><span class=p>(</span><span class=nd>@Nullable</span> <span class=n>Drawable</span> <span class=n>drawable</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-13-12 name=__codelineno-13-12></a><a href=#__codelineno-13-12><span class=linenos data-linenos="12 "></span></a>  <span class=k>return</span> <span class=n>asDrawable</span><span class=p>().</span><span class=na>load</span><span class=p>(</span><span class=n>drawable</span><span class=p>);</span>
<a id=__codelineno-13-13 name=__codelineno-13-13></a><a href=#__codelineno-13-13><span class=linenos data-linenos="13 "></span></a><span class=p>}</span>
<a id=__codelineno-13-14 name=__codelineno-13-14></a><a href=#__codelineno-13-14><span class=linenos data-linenos="14 "></span></a>
<a id=__codelineno-13-15 name=__codelineno-13-15></a><a href=#__codelineno-13-15><span class=linenos data-linenos="15 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-13-16 name=__codelineno-13-16></a><a href=#__codelineno-13-16><span class=linenos data-linenos="16 "></span></a><span class=nd>@CheckResult</span>
<a id=__codelineno-13-17 name=__codelineno-13-17></a><a href=#__codelineno-13-17><span class=linenos data-linenos="17 "></span></a><span class=nd>@Override</span>
<a id=__codelineno-13-18 name=__codelineno-13-18></a><a href=#__codelineno-13-18><span class=linenos data-linenos="18 "></span></a><span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Drawable</span><span class=o>&gt;</span> <span class=nf>load</span><span class=p>(</span><span class=nd>@Nullable</span> <span class=n>String</span> <span class=n>string</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-13-19 name=__codelineno-13-19></a><a href=#__codelineno-13-19><span class=linenos data-linenos="19 "></span></a>  <span class=k>return</span> <span class=n>asDrawable</span><span class=p>().</span><span class=na>load</span><span class=p>(</span><span class=n>string</span><span class=p>);</span>
<a id=__codelineno-13-20 name=__codelineno-13-20></a><a href=#__codelineno-13-20><span class=linenos data-linenos="20 "></span></a><span class=p>}</span>
<a id=__codelineno-13-21 name=__codelineno-13-21></a><a href=#__codelineno-13-21><span class=linenos data-linenos="21 "></span></a>
<a id=__codelineno-13-22 name=__codelineno-13-22></a><a href=#__codelineno-13-22><span class=linenos data-linenos="22 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-13-23 name=__codelineno-13-23></a><a href=#__codelineno-13-23><span class=linenos data-linenos="23 "></span></a><span class=nd>@CheckResult</span>
<a id=__codelineno-13-24 name=__codelineno-13-24></a><a href=#__codelineno-13-24><span class=linenos data-linenos="24 "></span></a><span class=nd>@Override</span>
<a id=__codelineno-13-25 name=__codelineno-13-25></a><a href=#__codelineno-13-25><span class=linenos data-linenos="25 "></span></a><span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Drawable</span><span class=o>&gt;</span> <span class=nf>load</span><span class=p>(</span><span class=nd>@Nullable</span> <span class=n>Uri</span> <span class=n>uri</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-13-26 name=__codelineno-13-26></a><a href=#__codelineno-13-26><span class=linenos data-linenos="26 "></span></a>  <span class=k>return</span> <span class=n>asDrawable</span><span class=p>().</span><span class=na>load</span><span class=p>(</span><span class=n>uri</span><span class=p>);</span>
<a id=__codelineno-13-27 name=__codelineno-13-27></a><a href=#__codelineno-13-27><span class=linenos data-linenos="27 "></span></a><span class=p>}</span>
<a id=__codelineno-13-28 name=__codelineno-13-28></a><a href=#__codelineno-13-28><span class=linenos data-linenos="28 "></span></a>
<a id=__codelineno-13-29 name=__codelineno-13-29></a><a href=#__codelineno-13-29><span class=linenos data-linenos="29 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-13-30 name=__codelineno-13-30></a><a href=#__codelineno-13-30><span class=linenos data-linenos="30 "></span></a><span class=nd>@CheckResult</span>
<a id=__codelineno-13-31 name=__codelineno-13-31></a><a href=#__codelineno-13-31><span class=linenos data-linenos="31 "></span></a><span class=nd>@Override</span>
<a id=__codelineno-13-32 name=__codelineno-13-32></a><a href=#__codelineno-13-32><span class=linenos data-linenos="32 "></span></a><span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Drawable</span><span class=o>&gt;</span> <span class=nf>load</span><span class=p>(</span><span class=nd>@Nullable</span> <span class=n>File</span> <span class=n>file</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-13-33 name=__codelineno-13-33></a><a href=#__codelineno-13-33><span class=linenos data-linenos="33 "></span></a>  <span class=k>return</span> <span class=n>asDrawable</span><span class=p>().</span><span class=na>load</span><span class=p>(</span><span class=n>file</span><span class=p>);</span>
<a id=__codelineno-13-34 name=__codelineno-13-34></a><a href=#__codelineno-13-34><span class=linenos data-linenos="34 "></span></a><span class=p>}</span>
<a id=__codelineno-13-35 name=__codelineno-13-35></a><a href=#__codelineno-13-35><span class=linenos data-linenos="35 "></span></a>
<a id=__codelineno-13-36 name=__codelineno-13-36></a><a href=#__codelineno-13-36><span class=linenos data-linenos="36 "></span></a><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;deprecation&quot;</span><span class=p>)</span>
<a id=__codelineno-13-37 name=__codelineno-13-37></a><a href=#__codelineno-13-37><span class=linenos data-linenos="37 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-13-38 name=__codelineno-13-38></a><a href=#__codelineno-13-38><span class=linenos data-linenos="38 "></span></a><span class=nd>@CheckResult</span>
<a id=__codelineno-13-39 name=__codelineno-13-39></a><a href=#__codelineno-13-39><span class=linenos data-linenos="39 "></span></a><span class=nd>@Override</span>
<a id=__codelineno-13-40 name=__codelineno-13-40></a><a href=#__codelineno-13-40><span class=linenos data-linenos="40 "></span></a><span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Drawable</span><span class=o>&gt;</span> <span class=nf>load</span><span class=p>(</span><span class=nd>@RawRes</span> <span class=nd>@DrawableRes</span> <span class=nd>@Nullable</span> <span class=n>Integer</span> <span class=n>resourceId</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-13-41 name=__codelineno-13-41></a><a href=#__codelineno-13-41><span class=linenos data-linenos="41 "></span></a>  <span class=k>return</span> <span class=n>asDrawable</span><span class=p>().</span><span class=na>load</span><span class=p>(</span><span class=n>resourceId</span><span class=p>);</span>
<a id=__codelineno-13-42 name=__codelineno-13-42></a><a href=#__codelineno-13-42><span class=linenos data-linenos="42 "></span></a><span class=p>}</span>
<a id=__codelineno-13-43 name=__codelineno-13-43></a><a href=#__codelineno-13-43><span class=linenos data-linenos="43 "></span></a>
<a id=__codelineno-13-44 name=__codelineno-13-44></a><a href=#__codelineno-13-44><span class=linenos data-linenos="44 "></span></a><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;deprecation&quot;</span><span class=p>)</span>
<a id=__codelineno-13-45 name=__codelineno-13-45></a><a href=#__codelineno-13-45><span class=linenos data-linenos="45 "></span></a><span class=nd>@CheckResult</span>
<a id=__codelineno-13-46 name=__codelineno-13-46></a><a href=#__codelineno-13-46><span class=linenos data-linenos="46 "></span></a><span class=nd>@Override</span>
<a id=__codelineno-13-47 name=__codelineno-13-47></a><a href=#__codelineno-13-47><span class=linenos data-linenos="47 "></span></a><span class=nd>@Deprecated</span>
<a id=__codelineno-13-48 name=__codelineno-13-48></a><a href=#__codelineno-13-48><span class=linenos data-linenos="48 "></span></a><span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Drawable</span><span class=o>&gt;</span> <span class=nf>load</span><span class=p>(</span><span class=nd>@Nullable</span> <span class=n>URL</span> <span class=n>url</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-13-49 name=__codelineno-13-49></a><a href=#__codelineno-13-49><span class=linenos data-linenos="49 "></span></a>  <span class=k>return</span> <span class=n>asDrawable</span><span class=p>().</span><span class=na>load</span><span class=p>(</span><span class=n>url</span><span class=p>);</span>
<a id=__codelineno-13-50 name=__codelineno-13-50></a><a href=#__codelineno-13-50><span class=linenos data-linenos="50 "></span></a><span class=p>}</span>
<a id=__codelineno-13-51 name=__codelineno-13-51></a><a href=#__codelineno-13-51><span class=linenos data-linenos="51 "></span></a>
<a id=__codelineno-13-52 name=__codelineno-13-52></a><a href=#__codelineno-13-52><span class=linenos data-linenos="52 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-13-53 name=__codelineno-13-53></a><a href=#__codelineno-13-53><span class=linenos data-linenos="53 "></span></a><span class=nd>@CheckResult</span>
<a id=__codelineno-13-54 name=__codelineno-13-54></a><a href=#__codelineno-13-54><span class=linenos data-linenos="54 "></span></a><span class=nd>@Override</span>
<a id=__codelineno-13-55 name=__codelineno-13-55></a><a href=#__codelineno-13-55><span class=linenos data-linenos="55 "></span></a><span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Drawable</span><span class=o>&gt;</span> <span class=nf>load</span><span class=p>(</span><span class=nd>@Nullable</span> <span class=kt>byte</span><span class=o>[]</span> <span class=n>model</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-13-56 name=__codelineno-13-56></a><a href=#__codelineno-13-56><span class=linenos data-linenos="56 "></span></a>  <span class=k>return</span> <span class=n>asDrawable</span><span class=p>().</span><span class=na>load</span><span class=p>(</span><span class=n>model</span><span class=p>);</span>
<a id=__codelineno-13-57 name=__codelineno-13-57></a><a href=#__codelineno-13-57><span class=linenos data-linenos="57 "></span></a><span class=p>}</span>
<a id=__codelineno-13-58 name=__codelineno-13-58></a><a href=#__codelineno-13-58><span class=linenos data-linenos="58 "></span></a>
<a id=__codelineno-13-59 name=__codelineno-13-59></a><a href=#__codelineno-13-59><span class=linenos data-linenos="59 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-13-60 name=__codelineno-13-60></a><a href=#__codelineno-13-60><span class=linenos data-linenos="60 "></span></a><span class=nd>@CheckResult</span>
<a id=__codelineno-13-61 name=__codelineno-13-61></a><a href=#__codelineno-13-61><span class=linenos data-linenos="61 "></span></a><span class=nd>@Override</span>
<a id=__codelineno-13-62 name=__codelineno-13-62></a><a href=#__codelineno-13-62><span class=linenos data-linenos="62 "></span></a><span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Drawable</span><span class=o>&gt;</span> <span class=nf>load</span><span class=p>(</span><span class=nd>@Nullable</span> <span class=n>Object</span> <span class=n>model</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-13-63 name=__codelineno-13-63></a><a href=#__codelineno-13-63><span class=linenos data-linenos="63 "></span></a>  <span class=k>return</span> <span class=n>asDrawable</span><span class=p>().</span><span class=na>load</span><span class=p>(</span><span class=n>model</span><span class=p>);</span>
<a id=__codelineno-13-64 name=__codelineno-13-64></a><a href=#__codelineno-13-64><span class=linenos data-linenos="64 "></span></a><span class=p>}</span>
</code></pre></div> <p>åœ¨æ‰€æœ‰çš„<code>RequestManager.load</code>æ–¹æ³•ä¸­éƒ½ä¼šå…ˆè°ƒç”¨<code>asDrawable()</code>æ–¹æ³•å¾—åˆ°ä¸€ä¸ª<code>RequestBuilder</code>å¯¹è±¡ï¼Œç„¶åå†è°ƒç”¨<code>RequestBuilder.load</code>æ–¹æ³•ã€‚ </p> <h3 id=21-requestmanagerasxxx>2.1 RequestManager.asXxx<a class=headerlink href=#21-requestmanagerasxxx title="Anchor link to this section for reference">&para;</a></h3> <p><code>asDrawable</code>æ–¹æ³•åŒå…¶ä»–asæ–¹æ³•ï¼ˆ<code>asGif</code>ã€<code>asBitmap</code>ã€<code>asFile</code>ï¼‰ä¸€æ ·ï¼Œéƒ½ä¼šå…ˆè°ƒç”¨<code>RequestManager.as</code>æ–¹æ³•ç”Ÿæˆä¸€ä¸ª<code>RequestBuilder&lt;ResourceType&gt;</code>å¯¹è±¡ï¼Œç„¶åå„ä¸ªasæ–¹æ³•ä¼šé™„åŠ ä¸€äº›ä¸åŒçš„optionsï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-14-1 name=__codelineno-14-1></a><a href=#__codelineno-14-1><span class=linenos data-linenos=" 1 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-14-2 name=__codelineno-14-2></a><a href=#__codelineno-14-2><span class=linenos data-linenos=" 2 "></span></a><span class=nd>@CheckResult</span>
<a id=__codelineno-14-3 name=__codelineno-14-3></a><a href=#__codelineno-14-3><span class=linenos data-linenos=" 3 "></span></a><span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Bitmap</span><span class=o>&gt;</span> <span class=nf>asBitmap</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-14-4 name=__codelineno-14-4></a><a href=#__codelineno-14-4><span class=linenos data-linenos=" 4 "></span></a>  <span class=k>return</span> <span class=n>as</span><span class=p>(</span><span class=n>Bitmap</span><span class=p>.</span><span class=na>class</span><span class=p>).</span><span class=na>apply</span><span class=p>(</span><span class=n>DECODE_TYPE_BITMAP</span><span class=p>);</span>
<a id=__codelineno-14-5 name=__codelineno-14-5></a><a href=#__codelineno-14-5><span class=linenos data-linenos=" 5 "></span></a><span class=p>}</span>
<a id=__codelineno-14-6 name=__codelineno-14-6></a><a href=#__codelineno-14-6><span class=linenos data-linenos=" 6 "></span></a>
<a id=__codelineno-14-7 name=__codelineno-14-7></a><a href=#__codelineno-14-7><span class=linenos data-linenos=" 7 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-14-8 name=__codelineno-14-8></a><a href=#__codelineno-14-8><span class=linenos data-linenos=" 8 "></span></a><span class=nd>@CheckResult</span>
<a id=__codelineno-14-9 name=__codelineno-14-9></a><a href=#__codelineno-14-9><span class=linenos data-linenos=" 9 "></span></a><span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>GifDrawable</span><span class=o>&gt;</span> <span class=nf>asGif</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-14-10 name=__codelineno-14-10></a><a href=#__codelineno-14-10><span class=linenos data-linenos="10 "></span></a>  <span class=k>return</span> <span class=n>as</span><span class=p>(</span><span class=n>GifDrawable</span><span class=p>.</span><span class=na>class</span><span class=p>).</span><span class=na>apply</span><span class=p>(</span><span class=n>DECODE_TYPE_GIF</span><span class=p>);</span>
<a id=__codelineno-14-11 name=__codelineno-14-11></a><a href=#__codelineno-14-11><span class=linenos data-linenos="11 "></span></a><span class=p>}</span>  
<a id=__codelineno-14-12 name=__codelineno-14-12></a><a href=#__codelineno-14-12><span class=linenos data-linenos="12 "></span></a>
<a id=__codelineno-14-13 name=__codelineno-14-13></a><a href=#__codelineno-14-13><span class=linenos data-linenos="13 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-14-14 name=__codelineno-14-14></a><a href=#__codelineno-14-14><span class=linenos data-linenos="14 "></span></a><span class=nd>@CheckResult</span>
<a id=__codelineno-14-15 name=__codelineno-14-15></a><a href=#__codelineno-14-15><span class=linenos data-linenos="15 "></span></a><span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>Drawable</span><span class=o>&gt;</span> <span class=nf>asDrawable</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-14-16 name=__codelineno-14-16></a><a href=#__codelineno-14-16><span class=linenos data-linenos="16 "></span></a>  <span class=k>return</span> <span class=n>as</span><span class=p>(</span><span class=n>Drawable</span><span class=p>.</span><span class=na>class</span><span class=p>);</span>
<a id=__codelineno-14-17 name=__codelineno-14-17></a><a href=#__codelineno-14-17><span class=linenos data-linenos="17 "></span></a><span class=p>}</span>
<a id=__codelineno-14-18 name=__codelineno-14-18></a><a href=#__codelineno-14-18><span class=linenos data-linenos="18 "></span></a>
<a id=__codelineno-14-19 name=__codelineno-14-19></a><a href=#__codelineno-14-19><span class=linenos data-linenos="19 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-14-20 name=__codelineno-14-20></a><a href=#__codelineno-14-20><span class=linenos data-linenos="20 "></span></a><span class=nd>@CheckResult</span>
<a id=__codelineno-14-21 name=__codelineno-14-21></a><a href=#__codelineno-14-21><span class=linenos data-linenos="21 "></span></a><span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>File</span><span class=o>&gt;</span> <span class=nf>asFile</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-14-22 name=__codelineno-14-22></a><a href=#__codelineno-14-22><span class=linenos data-linenos="22 "></span></a>  <span class=k>return</span> <span class=n>as</span><span class=p>(</span><span class=n>File</span><span class=p>.</span><span class=na>class</span><span class=p>).</span><span class=na>apply</span><span class=p>(</span><span class=n>skipMemoryCacheOf</span><span class=p>(</span><span class=kc>true</span><span class=p>));</span>
<a id=__codelineno-14-23 name=__codelineno-14-23></a><a href=#__codelineno-14-23><span class=linenos data-linenos="23 "></span></a><span class=p>}</span>
<a id=__codelineno-14-24 name=__codelineno-14-24></a><a href=#__codelineno-14-24><span class=linenos data-linenos="24 "></span></a>
<a id=__codelineno-14-25 name=__codelineno-14-25></a><a href=#__codelineno-14-25><span class=linenos data-linenos="25 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-14-26 name=__codelineno-14-26></a><a href=#__codelineno-14-26><span class=linenos data-linenos="26 "></span></a><span class=nd>@CheckResult</span>
<a id=__codelineno-14-27 name=__codelineno-14-27></a><a href=#__codelineno-14-27><span class=linenos data-linenos="27 "></span></a><span class=kd>public</span> <span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span> <span class=nf>as</span><span class=p>(</span>
<a id=__codelineno-14-28 name=__codelineno-14-28></a><a href=#__codelineno-14-28><span class=linenos data-linenos="28 "></span></a>    <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span> <span class=n>resourceClass</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-14-29 name=__codelineno-14-29></a><a href=#__codelineno-14-29><span class=linenos data-linenos="29 "></span></a>  <span class=k>return</span> <span class=k>new</span> <span class=n>RequestBuilder</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>glide</span><span class=p>,</span> <span class=k>this</span><span class=p>,</span> <span class=n>resourceClass</span><span class=p>,</span> <span class=n>context</span><span class=p>);</span>
<a id=__codelineno-14-30 name=__codelineno-14-30></a><a href=#__codelineno-14-30><span class=linenos data-linenos="30 "></span></a><span class=p>}</span>
</code></pre></div> <p>åœ¨<code>RequestBuilder</code>çš„æ„é€ å™¨æ–¹æ³•æ–¹æ³•ä¸­å°†<code>Drawable.class</code>è¿™æ ·çš„å…¥å‚ä¿å­˜åˆ°äº†<code>transcodeClass</code>å˜é‡ä¸­ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-15-1 name=__codelineno-15-1></a><a href=#__codelineno-15-1><span class=linenos data-linenos=" 1 "></span></a><span class=nd>@SuppressLint</span><span class=p>(</span><span class=s>&quot;CheckResult&quot;</span><span class=p>)</span>
<a id=__codelineno-15-2 name=__codelineno-15-2></a><a href=#__codelineno-15-2><span class=linenos data-linenos=" 2 "></span></a><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;PMD.ConstructorCallsOverridableMethod&quot;</span><span class=p>)</span>
<a id=__codelineno-15-3 name=__codelineno-15-3></a><a href=#__codelineno-15-3><span class=linenos data-linenos=" 3 "></span></a><span class=kd>protected</span> <span class=nf>RequestBuilder</span><span class=p>(</span>
<a id=__codelineno-15-4 name=__codelineno-15-4></a><a href=#__codelineno-15-4><span class=linenos data-linenos=" 4 "></span></a>    <span class=nd>@NonNull</span> <span class=n>Glide</span> <span class=n>glide</span><span class=p>,</span>
<a id=__codelineno-15-5 name=__codelineno-15-5></a><a href=#__codelineno-15-5><span class=linenos data-linenos=" 5 "></span></a>    <span class=n>RequestManager</span> <span class=n>requestManager</span><span class=p>,</span>
<a id=__codelineno-15-6 name=__codelineno-15-6></a><a href=#__codelineno-15-6><span class=linenos data-linenos=" 6 "></span></a>    <span class=n>Class</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=n>transcodeClass</span><span class=p>,</span>
<a id=__codelineno-15-7 name=__codelineno-15-7></a><a href=#__codelineno-15-7><span class=linenos data-linenos=" 7 "></span></a>    <span class=n>Context</span> <span class=n>context</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-15-8 name=__codelineno-15-8></a><a href=#__codelineno-15-8><span class=linenos data-linenos=" 8 "></span></a>  <span class=k>this</span><span class=p>.</span><span class=na>glide</span> <span class=o>=</span> <span class=n>glide</span><span class=p>;</span>
<a id=__codelineno-15-9 name=__codelineno-15-9></a><a href=#__codelineno-15-9><span class=linenos data-linenos=" 9 "></span></a>  <span class=k>this</span><span class=p>.</span><span class=na>requestManager</span> <span class=o>=</span> <span class=n>requestManager</span><span class=p>;</span>
<a id=__codelineno-15-10 name=__codelineno-15-10></a><a href=#__codelineno-15-10><span class=linenos data-linenos="10 "></span></a>  <span class=k>this</span><span class=p>.</span><span class=na>transcodeClass</span> <span class=o>=</span> <span class=n>transcodeClass</span><span class=p>;</span>
<a id=__codelineno-15-11 name=__codelineno-15-11></a><a href=#__codelineno-15-11><span class=linenos data-linenos="11 "></span></a>  <span class=k>this</span><span class=p>.</span><span class=na>context</span> <span class=o>=</span> <span class=n>context</span><span class=p>;</span>
<a id=__codelineno-15-12 name=__codelineno-15-12></a><a href=#__codelineno-15-12><span class=linenos data-linenos="12 "></span></a>  <span class=k>this</span><span class=p>.</span><span class=na>transitionOptions</span> <span class=o>=</span> <span class=n>requestManager</span><span class=p>.</span><span class=na>getDefaultTransitionOptions</span><span class=p>(</span><span class=n>transcodeClass</span><span class=p>);</span>
<a id=__codelineno-15-13 name=__codelineno-15-13></a><a href=#__codelineno-15-13><span class=linenos data-linenos="13 "></span></a>  <span class=k>this</span><span class=p>.</span><span class=na>glideContext</span> <span class=o>=</span> <span class=n>glide</span><span class=p>.</span><span class=na>getGlideContext</span><span class=p>();</span>
<a id=__codelineno-15-14 name=__codelineno-15-14></a><a href=#__codelineno-15-14><span class=linenos data-linenos="14 "></span></a>
<a id=__codelineno-15-15 name=__codelineno-15-15></a><a href=#__codelineno-15-15><span class=linenos data-linenos="15 "></span></a>  <span class=n>initRequestListeners</span><span class=p>(</span><span class=n>requestManager</span><span class=p>.</span><span class=na>getDefaultRequestListeners</span><span class=p>());</span>
<a id=__codelineno-15-16 name=__codelineno-15-16></a><a href=#__codelineno-15-16><span class=linenos data-linenos="16 "></span></a>  <span class=n>apply</span><span class=p>(</span><span class=n>requestManager</span><span class=p>.</span><span class=na>getDefaultRequestOptions</span><span class=p>());</span>
<a id=__codelineno-15-17 name=__codelineno-15-17></a><a href=#__codelineno-15-17><span class=linenos data-linenos="17 "></span></a><span class=p>}</span>
</code></pre></div> <p>ç„¶åå›åˆ°ä¹‹å‰çš„<code>asGif</code>æ–¹æ³•ä¸­ï¼Œçœ‹çœ‹<code>apply(DECODE_TYPE_BITMAP)</code>å¹²äº†äº›ä»€ä¹ˆï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-16-1 name=__codelineno-16-1></a><a href=#__codelineno-16-1><span class=linenos data-linenos=" 1 "></span></a><span class=c1>// RequestManager</span>
<a id=__codelineno-16-2 name=__codelineno-16-2></a><a href=#__codelineno-16-2><span class=linenos data-linenos=" 2 "></span></a><span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>RequestOptions</span> <span class=n>DECODE_TYPE_GIF</span> <span class=o>=</span> <span class=n>RequestOptions</span><span class=p>.</span><span class=na>decodeTypeOf</span><span class=p>(</span><span class=n>GifDrawable</span><span class=p>.</span><span class=na>class</span><span class=p>).</span><span class=na>lock</span><span class=p>();</span>
<a id=__codelineno-16-3 name=__codelineno-16-3></a><a href=#__codelineno-16-3><span class=linenos data-linenos=" 3 "></span></a>
<a id=__codelineno-16-4 name=__codelineno-16-4></a><a href=#__codelineno-16-4><span class=linenos data-linenos=" 4 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-16-5 name=__codelineno-16-5></a><a href=#__codelineno-16-5><span class=linenos data-linenos=" 5 "></span></a><span class=nd>@CheckResult</span>
<a id=__codelineno-16-6 name=__codelineno-16-6></a><a href=#__codelineno-16-6><span class=linenos data-linenos=" 6 "></span></a><span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>GifDrawable</span><span class=o>&gt;</span> <span class=nf>asGif</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-16-7 name=__codelineno-16-7></a><a href=#__codelineno-16-7><span class=linenos data-linenos=" 7 "></span></a>  <span class=k>return</span> <span class=n>as</span><span class=p>(</span><span class=n>GifDrawable</span><span class=p>.</span><span class=na>class</span><span class=p>).</span><span class=na>apply</span><span class=p>(</span><span class=n>DECODE_TYPE_GIF</span><span class=p>);</span>
<a id=__codelineno-16-8 name=__codelineno-16-8></a><a href=#__codelineno-16-8><span class=linenos data-linenos=" 8 "></span></a><span class=p>}</span>
<a id=__codelineno-16-9 name=__codelineno-16-9></a><a href=#__codelineno-16-9><span class=linenos data-linenos=" 9 "></span></a>
<a id=__codelineno-16-10 name=__codelineno-16-10></a><a href=#__codelineno-16-10><span class=linenos data-linenos="10 "></span></a><span class=c1>// RequestOptions</span>
<a id=__codelineno-16-11 name=__codelineno-16-11></a><a href=#__codelineno-16-11><span class=linenos data-linenos="11 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-16-12 name=__codelineno-16-12></a><a href=#__codelineno-16-12><span class=linenos data-linenos="12 "></span></a><span class=nd>@CheckResult</span>
<a id=__codelineno-16-13 name=__codelineno-16-13></a><a href=#__codelineno-16-13><span class=linenos data-linenos="13 "></span></a><span class=kd>public</span> <span class=kd>static</span> <span class=n>RequestOptions</span> <span class=nf>decodeTypeOf</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>resourceClass</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-16-14 name=__codelineno-16-14></a><a href=#__codelineno-16-14><span class=linenos data-linenos="14 "></span></a>  <span class=k>return</span> <span class=k>new</span> <span class=n>RequestOptions</span><span class=p>().</span><span class=na>decode</span><span class=p>(</span><span class=n>resourceClass</span><span class=p>);</span>
<a id=__codelineno-16-15 name=__codelineno-16-15></a><a href=#__codelineno-16-15><span class=linenos data-linenos="15 "></span></a><span class=p>}</span>
<a id=__codelineno-16-16 name=__codelineno-16-16></a><a href=#__codelineno-16-16><span class=linenos data-linenos="16 "></span></a>
<a id=__codelineno-16-17 name=__codelineno-16-17></a><a href=#__codelineno-16-17><span class=linenos data-linenos="17 "></span></a><span class=c1>// BaseRequestOptions</span>
<a id=__codelineno-16-18 name=__codelineno-16-18></a><a href=#__codelineno-16-18><span class=linenos data-linenos="18 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-16-19 name=__codelineno-16-19></a><a href=#__codelineno-16-19><span class=linenos data-linenos="19 "></span></a><span class=nd>@CheckResult</span>
<a id=__codelineno-16-20 name=__codelineno-16-20></a><a href=#__codelineno-16-20><span class=linenos data-linenos="20 "></span></a><span class=kd>public</span> <span class=n>T</span> <span class=nf>decode</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>resourceClass</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-16-21 name=__codelineno-16-21></a><a href=#__codelineno-16-21><span class=linenos data-linenos="21 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>isAutoCloneEnabled</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-16-22 name=__codelineno-16-22></a><a href=#__codelineno-16-22><span class=linenos data-linenos="22 "></span></a>    <span class=k>return</span> <span class=n>clone</span><span class=p>().</span><span class=na>decode</span><span class=p>(</span><span class=n>resourceClass</span><span class=p>);</span>
<a id=__codelineno-16-23 name=__codelineno-16-23></a><a href=#__codelineno-16-23><span class=linenos data-linenos="23 "></span></a>  <span class=p>}</span>
<a id=__codelineno-16-24 name=__codelineno-16-24></a><a href=#__codelineno-16-24><span class=linenos data-linenos="24 "></span></a>
<a id=__codelineno-16-25 name=__codelineno-16-25></a><a href=#__codelineno-16-25><span class=linenos data-linenos="25 "></span></a>  <span class=k>this</span><span class=p>.</span><span class=na>resourceClass</span> <span class=o>=</span> <span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>resourceClass</span><span class=p>);</span>
<a id=__codelineno-16-26 name=__codelineno-16-26></a><a href=#__codelineno-16-26><span class=linenos data-linenos="26 "></span></a>  <span class=n>fields</span> <span class=o>|=</span> <span class=n>RESOURCE_CLASS</span><span class=p>;</span>
<a id=__codelineno-16-27 name=__codelineno-16-27></a><a href=#__codelineno-16-27><span class=linenos data-linenos="27 "></span></a>  <span class=k>return</span> <span class=n>selfOrThrowIfLocked</span><span class=p>();</span>
<a id=__codelineno-16-28 name=__codelineno-16-28></a><a href=#__codelineno-16-28><span class=linenos data-linenos="28 "></span></a><span class=p>}</span>
<a id=__codelineno-16-29 name=__codelineno-16-29></a><a href=#__codelineno-16-29><span class=linenos data-linenos="29 "></span></a>
<a id=__codelineno-16-30 name=__codelineno-16-30></a><a href=#__codelineno-16-30><span class=linenos data-linenos="30 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-16-31 name=__codelineno-16-31></a><a href=#__codelineno-16-31><span class=linenos data-linenos="31 "></span></a><span class=nd>@CheckResult</span>
<a id=__codelineno-16-32 name=__codelineno-16-32></a><a href=#__codelineno-16-32><span class=linenos data-linenos="32 "></span></a><span class=kd>public</span> <span class=n>T</span> <span class=nf>apply</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>BaseRequestOptions</span><span class=o>&lt;?&gt;</span> <span class=n>o</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-16-33 name=__codelineno-16-33></a><a href=#__codelineno-16-33><span class=linenos data-linenos="33 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>isAutoCloneEnabled</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-16-34 name=__codelineno-16-34></a><a href=#__codelineno-16-34><span class=linenos data-linenos="34 "></span></a>    <span class=k>return</span> <span class=n>clone</span><span class=p>().</span><span class=na>apply</span><span class=p>(</span><span class=n>o</span><span class=p>);</span>
<a id=__codelineno-16-35 name=__codelineno-16-35></a><a href=#__codelineno-16-35><span class=linenos data-linenos="35 "></span></a>  <span class=p>}</span>
<a id=__codelineno-16-36 name=__codelineno-16-36></a><a href=#__codelineno-16-36><span class=linenos data-linenos="36 "></span></a>  <span class=n>BaseRequestOptions</span><span class=o>&lt;?&gt;</span> <span class=n>other</span> <span class=o>=</span> <span class=n>o</span><span class=p>;</span>
<a id=__codelineno-16-37 name=__codelineno-16-37></a><a href=#__codelineno-16-37><span class=linenos data-linenos="37 "></span></a>  <span class=p>...</span>
<a id=__codelineno-16-38 name=__codelineno-16-38></a><a href=#__codelineno-16-38><span class=linenos data-linenos="38 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>isSet</span><span class=p>(</span><span class=n>other</span><span class=p>.</span><span class=na>fields</span><span class=p>,</span> <span class=n>RESOURCE_CLASS</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-16-39 name=__codelineno-16-39></a><a href=#__codelineno-16-39><span class=linenos data-linenos="39 "></span></a>    <span class=n>resourceClass</span> <span class=o>=</span> <span class=n>other</span><span class=p>.</span><span class=na>resourceClass</span><span class=p>;</span>
<a id=__codelineno-16-40 name=__codelineno-16-40></a><a href=#__codelineno-16-40><span class=linenos data-linenos="40 "></span></a>  <span class=p>}</span>
<a id=__codelineno-16-41 name=__codelineno-16-41></a><a href=#__codelineno-16-41><span class=linenos data-linenos="41 "></span></a>  <span class=p>...</span>
<a id=__codelineno-16-42 name=__codelineno-16-42></a><a href=#__codelineno-16-42><span class=linenos data-linenos="42 "></span></a>  <span class=k>return</span> <span class=n>selfOrThrowIfLocked</span><span class=p>();</span>
<a id=__codelineno-16-43 name=__codelineno-16-43></a><a href=#__codelineno-16-43><span class=linenos data-linenos="43 "></span></a><span class=p>}</span>
<a id=__codelineno-16-44 name=__codelineno-16-44></a><a href=#__codelineno-16-44><span class=linenos data-linenos="44 "></span></a>
<a id=__codelineno-16-45 name=__codelineno-16-45></a><a href=#__codelineno-16-45><span class=linenos data-linenos="45 "></span></a><span class=c1>// RequestBuilder</span>
<a id=__codelineno-16-46 name=__codelineno-16-46></a><a href=#__codelineno-16-46><span class=linenos data-linenos="46 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-16-47 name=__codelineno-16-47></a><a href=#__codelineno-16-47><span class=linenos data-linenos="47 "></span></a><span class=nd>@CheckResult</span>
<a id=__codelineno-16-48 name=__codelineno-16-48></a><a href=#__codelineno-16-48><span class=linenos data-linenos="48 "></span></a><span class=nd>@Override</span>
<a id=__codelineno-16-49 name=__codelineno-16-49></a><a href=#__codelineno-16-49><span class=linenos data-linenos="49 "></span></a><span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=nf>apply</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>BaseRequestOptions</span><span class=o>&lt;?&gt;</span> <span class=n>requestOptions</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-16-50 name=__codelineno-16-50></a><a href=#__codelineno-16-50><span class=linenos data-linenos="50 "></span></a>  <span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>requestOptions</span><span class=p>);</span>
<a id=__codelineno-16-51 name=__codelineno-16-51></a><a href=#__codelineno-16-51><span class=linenos data-linenos="51 "></span></a>  <span class=k>return</span> <span class=kd>super</span><span class=p>.</span><span class=na>apply</span><span class=p>(</span><span class=n>requestOptions</span><span class=p>);</span>
<a id=__codelineno-16-52 name=__codelineno-16-52></a><a href=#__codelineno-16-52><span class=linenos data-linenos="52 "></span></a><span class=p>}</span>
</code></pre></div> <p>ä¸éš¾å‘ç°ï¼Œ<code>apply(DECODE_TYPE_BITMAP)</code>å°±æ˜¯å°†<code>BaseRequestOptions.resourceClass</code>è®¾ç½®ä¸ºäº†<code>GifDrawable.class</code>ï¼›å¯¹äº<code>asBitmap()</code>æ¥è¯´ï¼Œ<code>resourceClass</code>ä¸º<code>Bitmap.class</code>ï¼›è€Œå¯¹äº<code>asDrawable()</code>å’Œ<code>asFile()</code>æ¥è¯´ï¼Œ<code>resourceClass</code>æ²¡æœ‰è¿›è¡Œè¿‡è®¾ç½®ï¼Œæ‰€ä»¥ä¸ºé»˜è®¤å€¼<code>Object.class</code>ã€‚</p> <p>ç°åœ¨<code>RequestBuilder</code>å·²ç»ç”±asç³»åˆ—æ–¹æ³•ç”Ÿæˆï¼Œç°åœ¨æ¥ç€ä¼šè°ƒç”¨<code>RequestBuilder.load</code>æ–¹æ³•</p> <h3 id=22-requestbuilderload>2.2 RequestBuilder.load<a class=headerlink href=#22-requestbuilderload title="Anchor link to this section for reference">&para;</a></h3> <p><code>RequestManager.load</code>æ–¹æ³•éƒ½ä¼šè°ƒç”¨å¯¹åº”çš„<code>RequestBuilder.load</code>é‡è½½æ–¹æ³•ï¼›<code>RequestBuilder.load</code>çš„å„ä¸ªæ–¹æ³•åŸºæœ¬ä¸Šéƒ½ä¼šç›´æ¥è½¬å‘ç»™<code>loadGeneric</code>æ–¹æ³•ï¼Œåªæœ‰å°‘æ•°çš„æ–¹æ³•æ‰ä¼šapplyé¢å¤–çš„optionsã€‚</p> <p><code>loadGeneric</code>æ–¹æ³•ä¹Ÿåªæ˜¯ä¿å­˜ä¸€ä¸‹å‚æ•°è€Œå·²ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-17-1 name=__codelineno-17-1></a><a href=#__codelineno-17-1><span class=linenos data-linenos=" 1 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-17-2 name=__codelineno-17-2></a><a href=#__codelineno-17-2><span class=linenos data-linenos=" 2 "></span></a><span class=nd>@CheckResult</span>
<a id=__codelineno-17-3 name=__codelineno-17-3></a><a href=#__codelineno-17-3><span class=linenos data-linenos=" 3 "></span></a><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;unchecked&quot;</span><span class=p>)</span>
<a id=__codelineno-17-4 name=__codelineno-17-4></a><a href=#__codelineno-17-4><span class=linenos data-linenos=" 4 "></span></a><span class=nd>@Override</span>
<a id=__codelineno-17-5 name=__codelineno-17-5></a><a href=#__codelineno-17-5><span class=linenos data-linenos=" 5 "></span></a><span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=nf>load</span><span class=p>(</span><span class=nd>@Nullable</span> <span class=n>Object</span> <span class=n>model</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-17-6 name=__codelineno-17-6></a><a href=#__codelineno-17-6><span class=linenos data-linenos=" 6 "></span></a>  <span class=k>return</span> <span class=n>loadGeneric</span><span class=p>(</span><span class=n>model</span><span class=p>);</span>
<a id=__codelineno-17-7 name=__codelineno-17-7></a><a href=#__codelineno-17-7><span class=linenos data-linenos=" 7 "></span></a><span class=p>}</span>
<a id=__codelineno-17-8 name=__codelineno-17-8></a><a href=#__codelineno-17-8><span class=linenos data-linenos=" 8 "></span></a>
<a id=__codelineno-17-9 name=__codelineno-17-9></a><a href=#__codelineno-17-9><span class=linenos data-linenos=" 9 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-17-10 name=__codelineno-17-10></a><a href=#__codelineno-17-10><span class=linenos data-linenos="10 "></span></a><span class=nd>@CheckResult</span>
<a id=__codelineno-17-11 name=__codelineno-17-11></a><a href=#__codelineno-17-11><span class=linenos data-linenos="11 "></span></a><span class=nd>@Override</span>
<a id=__codelineno-17-12 name=__codelineno-17-12></a><a href=#__codelineno-17-12><span class=linenos data-linenos="12 "></span></a><span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=nf>load</span><span class=p>(</span><span class=nd>@Nullable</span> <span class=n>Bitmap</span> <span class=n>bitmap</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-17-13 name=__codelineno-17-13></a><a href=#__codelineno-17-13><span class=linenos data-linenos="13 "></span></a>  <span class=k>return</span> <span class=n>loadGeneric</span><span class=p>(</span><span class=n>bitmap</span><span class=p>)</span>
<a id=__codelineno-17-14 name=__codelineno-17-14></a><a href=#__codelineno-17-14><span class=linenos data-linenos="14 "></span></a>      <span class=p>.</span><span class=na>apply</span><span class=p>(</span><span class=n>diskCacheStrategyOf</span><span class=p>(</span><span class=n>DiskCacheStrategy</span><span class=p>.</span><span class=na>NONE</span><span class=p>));</span>
<a id=__codelineno-17-15 name=__codelineno-17-15></a><a href=#__codelineno-17-15><span class=linenos data-linenos="15 "></span></a><span class=p>}</span>
<a id=__codelineno-17-16 name=__codelineno-17-16></a><a href=#__codelineno-17-16><span class=linenos data-linenos="16 "></span></a>
<a id=__codelineno-17-17 name=__codelineno-17-17></a><a href=#__codelineno-17-17><span class=linenos data-linenos="17 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-17-18 name=__codelineno-17-18></a><a href=#__codelineno-17-18><span class=linenos data-linenos="18 "></span></a><span class=nd>@CheckResult</span>
<a id=__codelineno-17-19 name=__codelineno-17-19></a><a href=#__codelineno-17-19><span class=linenos data-linenos="19 "></span></a><span class=nd>@Override</span>
<a id=__codelineno-17-20 name=__codelineno-17-20></a><a href=#__codelineno-17-20><span class=linenos data-linenos="20 "></span></a><span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=nf>load</span><span class=p>(</span><span class=nd>@Nullable</span> <span class=n>Drawable</span> <span class=n>drawable</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-17-21 name=__codelineno-17-21></a><a href=#__codelineno-17-21><span class=linenos data-linenos="21 "></span></a>  <span class=k>return</span> <span class=n>loadGeneric</span><span class=p>(</span><span class=n>drawable</span><span class=p>)</span>
<a id=__codelineno-17-22 name=__codelineno-17-22></a><a href=#__codelineno-17-22><span class=linenos data-linenos="22 "></span></a>      <span class=p>.</span><span class=na>apply</span><span class=p>(</span><span class=n>diskCacheStrategyOf</span><span class=p>(</span><span class=n>DiskCacheStrategy</span><span class=p>.</span><span class=na>NONE</span><span class=p>));</span>
<a id=__codelineno-17-23 name=__codelineno-17-23></a><a href=#__codelineno-17-23><span class=linenos data-linenos="23 "></span></a><span class=p>}</span>
<a id=__codelineno-17-24 name=__codelineno-17-24></a><a href=#__codelineno-17-24><span class=linenos data-linenos="24 "></span></a>
<a id=__codelineno-17-25 name=__codelineno-17-25></a><a href=#__codelineno-17-25><span class=linenos data-linenos="25 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-17-26 name=__codelineno-17-26></a><a href=#__codelineno-17-26><span class=linenos data-linenos="26 "></span></a><span class=nd>@CheckResult</span>
<a id=__codelineno-17-27 name=__codelineno-17-27></a><a href=#__codelineno-17-27><span class=linenos data-linenos="27 "></span></a><span class=nd>@Override</span>
<a id=__codelineno-17-28 name=__codelineno-17-28></a><a href=#__codelineno-17-28><span class=linenos data-linenos="28 "></span></a><span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=nf>load</span><span class=p>(</span><span class=nd>@Nullable</span> <span class=n>Uri</span> <span class=n>uri</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-17-29 name=__codelineno-17-29></a><a href=#__codelineno-17-29><span class=linenos data-linenos="29 "></span></a>  <span class=k>return</span> <span class=n>loadGeneric</span><span class=p>(</span><span class=n>uri</span><span class=p>);</span>
<a id=__codelineno-17-30 name=__codelineno-17-30></a><a href=#__codelineno-17-30><span class=linenos data-linenos="30 "></span></a><span class=p>}</span>
<a id=__codelineno-17-31 name=__codelineno-17-31></a><a href=#__codelineno-17-31><span class=linenos data-linenos="31 "></span></a>
<a id=__codelineno-17-32 name=__codelineno-17-32></a><a href=#__codelineno-17-32><span class=linenos data-linenos="32 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-17-33 name=__codelineno-17-33></a><a href=#__codelineno-17-33><span class=linenos data-linenos="33 "></span></a><span class=nd>@CheckResult</span>
<a id=__codelineno-17-34 name=__codelineno-17-34></a><a href=#__codelineno-17-34><span class=linenos data-linenos="34 "></span></a><span class=nd>@Override</span>
<a id=__codelineno-17-35 name=__codelineno-17-35></a><a href=#__codelineno-17-35><span class=linenos data-linenos="35 "></span></a><span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=nf>load</span><span class=p>(</span><span class=nd>@Nullable</span> <span class=n>File</span> <span class=n>file</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-17-36 name=__codelineno-17-36></a><a href=#__codelineno-17-36><span class=linenos data-linenos="36 "></span></a>  <span class=k>return</span> <span class=n>loadGeneric</span><span class=p>(</span><span class=n>file</span><span class=p>);</span>
<a id=__codelineno-17-37 name=__codelineno-17-37></a><a href=#__codelineno-17-37><span class=linenos data-linenos="37 "></span></a><span class=p>}</span>
<a id=__codelineno-17-38 name=__codelineno-17-38></a><a href=#__codelineno-17-38><span class=linenos data-linenos="38 "></span></a>
<a id=__codelineno-17-39 name=__codelineno-17-39></a><a href=#__codelineno-17-39><span class=linenos data-linenos="39 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-17-40 name=__codelineno-17-40></a><a href=#__codelineno-17-40><span class=linenos data-linenos="40 "></span></a><span class=nd>@CheckResult</span>
<a id=__codelineno-17-41 name=__codelineno-17-41></a><a href=#__codelineno-17-41><span class=linenos data-linenos="41 "></span></a><span class=nd>@Override</span>
<a id=__codelineno-17-42 name=__codelineno-17-42></a><a href=#__codelineno-17-42><span class=linenos data-linenos="42 "></span></a><span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=nf>load</span><span class=p>(</span><span class=nd>@RawRes</span> <span class=nd>@DrawableRes</span> <span class=nd>@Nullable</span> <span class=n>Integer</span> <span class=n>resourceId</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-17-43 name=__codelineno-17-43></a><a href=#__codelineno-17-43><span class=linenos data-linenos="43 "></span></a>  <span class=k>return</span> <span class=n>loadGeneric</span><span class=p>(</span><span class=n>resourceId</span><span class=p>).</span><span class=na>apply</span><span class=p>(</span><span class=n>signatureOf</span><span class=p>(</span><span class=n>ApplicationVersionSignature</span><span class=p>.</span><span class=na>obtain</span><span class=p>(</span><span class=n>context</span><span class=p>)));</span>
<a id=__codelineno-17-44 name=__codelineno-17-44></a><a href=#__codelineno-17-44><span class=linenos data-linenos="44 "></span></a><span class=p>}</span>
<a id=__codelineno-17-45 name=__codelineno-17-45></a><a href=#__codelineno-17-45><span class=linenos data-linenos="45 "></span></a>
<a id=__codelineno-17-46 name=__codelineno-17-46></a><a href=#__codelineno-17-46><span class=linenos data-linenos="46 "></span></a><span class=nd>@Deprecated</span>
<a id=__codelineno-17-47 name=__codelineno-17-47></a><a href=#__codelineno-17-47><span class=linenos data-linenos="47 "></span></a><span class=nd>@CheckResult</span>
<a id=__codelineno-17-48 name=__codelineno-17-48></a><a href=#__codelineno-17-48><span class=linenos data-linenos="48 "></span></a><span class=nd>@Override</span>
<a id=__codelineno-17-49 name=__codelineno-17-49></a><a href=#__codelineno-17-49><span class=linenos data-linenos="49 "></span></a><span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=nf>load</span><span class=p>(</span><span class=nd>@Nullable</span> <span class=n>URL</span> <span class=n>url</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-17-50 name=__codelineno-17-50></a><a href=#__codelineno-17-50><span class=linenos data-linenos="50 "></span></a>  <span class=k>return</span> <span class=n>loadGeneric</span><span class=p>(</span><span class=n>url</span><span class=p>);</span>
<a id=__codelineno-17-51 name=__codelineno-17-51></a><a href=#__codelineno-17-51><span class=linenos data-linenos="51 "></span></a><span class=p>}</span>
<a id=__codelineno-17-52 name=__codelineno-17-52></a><a href=#__codelineno-17-52><span class=linenos data-linenos="52 "></span></a>
<a id=__codelineno-17-53 name=__codelineno-17-53></a><a href=#__codelineno-17-53><span class=linenos data-linenos="53 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-17-54 name=__codelineno-17-54></a><a href=#__codelineno-17-54><span class=linenos data-linenos="54 "></span></a><span class=nd>@CheckResult</span>
<a id=__codelineno-17-55 name=__codelineno-17-55></a><a href=#__codelineno-17-55><span class=linenos data-linenos="55 "></span></a><span class=nd>@Override</span>
<a id=__codelineno-17-56 name=__codelineno-17-56></a><a href=#__codelineno-17-56><span class=linenos data-linenos="56 "></span></a><span class=kd>public</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=nf>load</span><span class=p>(</span><span class=nd>@Nullable</span> <span class=kt>byte</span><span class=o>[]</span> <span class=n>model</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-17-57 name=__codelineno-17-57></a><a href=#__codelineno-17-57><span class=linenos data-linenos="57 "></span></a>  <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=n>loadGeneric</span><span class=p>(</span><span class=n>model</span><span class=p>);</span>
<a id=__codelineno-17-58 name=__codelineno-17-58></a><a href=#__codelineno-17-58><span class=linenos data-linenos="58 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>result</span><span class=p>.</span><span class=na>isDiskCacheStrategySet</span><span class=p>())</span> <span class=p>{</span>
<a id=__codelineno-17-59 name=__codelineno-17-59></a><a href=#__codelineno-17-59><span class=linenos data-linenos="59 "></span></a>      <span class=n>result</span> <span class=o>=</span> <span class=n>result</span><span class=p>.</span><span class=na>apply</span><span class=p>(</span><span class=n>diskCacheStrategyOf</span><span class=p>(</span><span class=n>DiskCacheStrategy</span><span class=p>.</span><span class=na>NONE</span><span class=p>));</span>
<a id=__codelineno-17-60 name=__codelineno-17-60></a><a href=#__codelineno-17-60><span class=linenos data-linenos="60 "></span></a>  <span class=p>}</span>
<a id=__codelineno-17-61 name=__codelineno-17-61></a><a href=#__codelineno-17-61><span class=linenos data-linenos="61 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>result</span><span class=p>.</span><span class=na>isSkipMemoryCacheSet</span><span class=p>())</span> <span class=p>{</span>
<a id=__codelineno-17-62 name=__codelineno-17-62></a><a href=#__codelineno-17-62><span class=linenos data-linenos="62 "></span></a>    <span class=n>result</span> <span class=o>=</span> <span class=n>result</span><span class=p>.</span><span class=na>apply</span><span class=p>(</span><span class=n>skipMemoryCacheOf</span><span class=p>(</span><span class=kc>true</span> <span class=cm>/*skipMemoryCache*/</span><span class=p>));</span>
<a id=__codelineno-17-63 name=__codelineno-17-63></a><a href=#__codelineno-17-63><span class=linenos data-linenos="63 "></span></a>  <span class=p>}</span>
<a id=__codelineno-17-64 name=__codelineno-17-64></a><a href=#__codelineno-17-64><span class=linenos data-linenos="64 "></span></a>  <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
<a id=__codelineno-17-65 name=__codelineno-17-65></a><a href=#__codelineno-17-65><span class=linenos data-linenos="65 "></span></a><span class=p>}</span>
<a id=__codelineno-17-66 name=__codelineno-17-66></a><a href=#__codelineno-17-66><span class=linenos data-linenos="66 "></span></a>
<a id=__codelineno-17-67 name=__codelineno-17-67></a><a href=#__codelineno-17-67><span class=linenos data-linenos="67 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-17-68 name=__codelineno-17-68></a><a href=#__codelineno-17-68><span class=linenos data-linenos="68 "></span></a><span class=kd>private</span> <span class=n>RequestBuilder</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=nf>loadGeneric</span><span class=p>(</span><span class=nd>@Nullable</span> <span class=n>Object</span> <span class=n>model</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-17-69 name=__codelineno-17-69></a><a href=#__codelineno-17-69><span class=linenos data-linenos="69 "></span></a>  <span class=k>this</span><span class=p>.</span><span class=na>model</span> <span class=o>=</span> <span class=n>model</span><span class=p>;</span>
<a id=__codelineno-17-70 name=__codelineno-17-70></a><a href=#__codelineno-17-70><span class=linenos data-linenos="70 "></span></a>  <span class=n>isModelSet</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
<a id=__codelineno-17-71 name=__codelineno-17-71></a><a href=#__codelineno-17-71><span class=linenos data-linenos="71 "></span></a>  <span class=k>return</span> <span class=k>this</span><span class=p>;</span>
<a id=__codelineno-17-72 name=__codelineno-17-72></a><a href=#__codelineno-17-72><span class=linenos data-linenos="72 "></span></a><span class=p>}</span>
</code></pre></div> <p>å¦‚ä¸Šé¢æœ€åçš„æ–¹æ³•<code>loadGeneric</code>ï¼Œè¿™é‡Œåªæ˜¯å°†å‚æ•°ä¿å­˜åœ¨<code>model</code>ä¸­å¹¶è®¾ç½®<code>isModelSet=true</code>å°±å®Œäº†ï¼Œçœ‹æ¥Glideè¿›è¡Œå›¾ç‰‡åŠ è½½çš„æœ€æ ¸å¿ƒçš„æ­¥éª¤åº”è¯¥å°±æ˜¯<code>RequestBuilder.into</code>æ–¹æ³•äº†ã€‚</p> <h2 id=3-requestbuilderinto>3. RequestBuilder.into<a class=headerlink href=#3-requestbuilderinto title="Anchor link to this section for reference">&para;</a></h2> <p>Glideä¸‰æ­¥ä¸­å‰ä¸¤æ­¥è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼ŒçœŸæ­£ä»¤äººå¤´å¤§çš„ä½ç½®å°±æ˜¯æœ¬èŠ‚è¦æ·±å…¥æ¢ç´¢çš„<code>into</code>æ–¹æ³•äº†ã€‚å› ä¸ºGlideå„ç§é…ç½®ç›¸å½“å¤šï¼Œå„ç§åˆ†æ”¯å…¨éƒ¨åˆ—å‡ºæ¥è¿˜æ˜¯ç›¸å½“ç¹ççš„ï¼Œè€Œä¸”ä¸€æ¬¡æ€§å…¨éƒ¨çœ‹å®Œä¹Ÿæ˜¯ä¸å¯èƒ½çš„ã€‚æ‰€ä»¥æ­¤å¤„åªæ¢ç´¢æœ€åŸºæœ¬çš„æºç ã€‚</p> <p><code>RequestBuilder.into</code>æœ‰å››ä¸ªé‡è½½æ–¹æ³•ï¼Œæœ€ç»ˆéƒ½è°ƒç”¨äº†å‚æ•°æœ€å¤šçš„ä¸€ä¸ªï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-18-1 name=__codelineno-18-1></a><a href=#__codelineno-18-1><span class=linenos data-linenos=" 1 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-18-2 name=__codelineno-18-2></a><a href=#__codelineno-18-2><span class=linenos data-linenos=" 2 "></span></a><span class=kd>public</span> <span class=o>&lt;</span><span class=n>Y</span> <span class=kd>extends</span> <span class=n>Target</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;&gt;</span> <span class=n>Y</span> <span class=nf>into</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Y</span> <span class=n>target</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-18-3 name=__codelineno-18-3></a><a href=#__codelineno-18-3><span class=linenos data-linenos=" 3 "></span></a>  <span class=k>return</span> <span class=n>into</span><span class=p>(</span><span class=n>target</span><span class=p>,</span> <span class=cm>/*targetListener=*/</span> <span class=kc>null</span><span class=p>,</span> <span class=n>Executors</span><span class=p>.</span><span class=na>mainThreadExecutor</span><span class=p>());</span>
<a id=__codelineno-18-4 name=__codelineno-18-4></a><a href=#__codelineno-18-4><span class=linenos data-linenos=" 4 "></span></a><span class=p>}</span>
<a id=__codelineno-18-5 name=__codelineno-18-5></a><a href=#__codelineno-18-5><span class=linenos data-linenos=" 5 "></span></a>
<a id=__codelineno-18-6 name=__codelineno-18-6></a><a href=#__codelineno-18-6><span class=linenos data-linenos=" 6 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-18-7 name=__codelineno-18-7></a><a href=#__codelineno-18-7><span class=linenos data-linenos=" 7 "></span></a><span class=nd>@Synthetic</span>
<a id=__codelineno-18-8 name=__codelineno-18-8></a><a href=#__codelineno-18-8><span class=linenos data-linenos=" 8 "></span></a><span class=o>&lt;</span><span class=n>Y</span> <span class=kd>extends</span> <span class=n>Target</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;&gt;</span> <span class=n>Y</span> <span class=nf>into</span><span class=p>(</span>
<a id=__codelineno-18-9 name=__codelineno-18-9></a><a href=#__codelineno-18-9><span class=linenos data-linenos=" 9 "></span></a>    <span class=nd>@NonNull</span> <span class=n>Y</span> <span class=n>target</span><span class=p>,</span>
<a id=__codelineno-18-10 name=__codelineno-18-10></a><a href=#__codelineno-18-10><span class=linenos data-linenos="10 "></span></a>    <span class=nd>@Nullable</span> <span class=n>RequestListener</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=n>targetListener</span><span class=p>,</span>
<a id=__codelineno-18-11 name=__codelineno-18-11></a><a href=#__codelineno-18-11><span class=linenos data-linenos="11 "></span></a>    <span class=n>Executor</span> <span class=n>callbackExecutor</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-18-12 name=__codelineno-18-12></a><a href=#__codelineno-18-12><span class=linenos data-linenos="12 "></span></a>  <span class=k>return</span> <span class=n>into</span><span class=p>(</span><span class=n>target</span><span class=p>,</span> <span class=n>targetListener</span><span class=p>,</span> <span class=cm>/*options=*/</span> <span class=k>this</span><span class=p>,</span> <span class=n>callbackExecutor</span><span class=p>);</span>
<a id=__codelineno-18-13 name=__codelineno-18-13></a><a href=#__codelineno-18-13><span class=linenos data-linenos="13 "></span></a><span class=p>}</span>
<a id=__codelineno-18-14 name=__codelineno-18-14></a><a href=#__codelineno-18-14><span class=linenos data-linenos="14 "></span></a>
<a id=__codelineno-18-15 name=__codelineno-18-15></a><a href=#__codelineno-18-15><span class=linenos data-linenos="15 "></span></a><span class=kd>private</span> <span class=o>&lt;</span><span class=n>Y</span> <span class=kd>extends</span> <span class=n>Target</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;&gt;</span> <span class=n>Y</span> <span class=nf>into</span><span class=p>(</span>
<a id=__codelineno-18-16 name=__codelineno-18-16></a><a href=#__codelineno-18-16><span class=linenos data-linenos="16 "></span></a>    <span class=nd>@NonNull</span> <span class=n>Y</span> <span class=n>target</span><span class=p>,</span>
<a id=__codelineno-18-17 name=__codelineno-18-17></a><a href=#__codelineno-18-17><span class=linenos data-linenos="17 "></span></a>    <span class=nd>@Nullable</span> <span class=n>RequestListener</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=n>targetListener</span><span class=p>,</span>
<a id=__codelineno-18-18 name=__codelineno-18-18></a><a href=#__codelineno-18-18><span class=linenos data-linenos="18 "></span></a>    <span class=n>BaseRequestOptions</span><span class=o>&lt;?&gt;</span> <span class=n>options</span><span class=p>,</span>
<a id=__codelineno-18-19 name=__codelineno-18-19></a><a href=#__codelineno-18-19><span class=linenos data-linenos="19 "></span></a>    <span class=n>Executor</span> <span class=n>callbackExecutor</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-18-20 name=__codelineno-18-20></a><a href=#__codelineno-18-20><span class=linenos data-linenos="20 "></span></a>  <span class=p>...</span> <span class=c1>//è§åæ–‡åˆ†è§£</span>
<a id=__codelineno-18-21 name=__codelineno-18-21></a><a href=#__codelineno-18-21><span class=linenos data-linenos="21 "></span></a><span class=p>}</span>
<a id=__codelineno-18-22 name=__codelineno-18-22></a><a href=#__codelineno-18-22><span class=linenos data-linenos="22 "></span></a>
<a id=__codelineno-18-23 name=__codelineno-18-23></a><a href=#__codelineno-18-23><span class=linenos data-linenos="23 "></span></a><span class=c1>// ğŸ¤šğŸ¤šğŸ¤š è¿™æ˜¯æˆ‘ä»¬æœ€å¸¸ç”¨çš„ä¸€ä¸ªé‡è½½</span>
<a id=__codelineno-18-24 name=__codelineno-18-24></a><a href=#__codelineno-18-24><span class=linenos data-linenos="24 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-18-25 name=__codelineno-18-25></a><a href=#__codelineno-18-25><span class=linenos data-linenos="25 "></span></a><span class=kd>public</span> <span class=n>ViewTarget</span><span class=o>&lt;</span><span class=n>ImageView</span><span class=p>,</span> <span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=nf>into</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>ImageView</span> <span class=n>view</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-18-26 name=__codelineno-18-26></a><a href=#__codelineno-18-26><span class=linenos data-linenos="26 "></span></a>  <span class=c1>// sanity check</span>
<a id=__codelineno-18-27 name=__codelineno-18-27></a><a href=#__codelineno-18-27><span class=linenos data-linenos="27 "></span></a>  <span class=n>Util</span><span class=p>.</span><span class=na>assertMainThread</span><span class=p>();</span>
<a id=__codelineno-18-28 name=__codelineno-18-28></a><a href=#__codelineno-18-28><span class=linenos data-linenos="28 "></span></a>  <span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>view</span><span class=p>);</span>
<a id=__codelineno-18-29 name=__codelineno-18-29></a><a href=#__codelineno-18-29><span class=linenos data-linenos="29 "></span></a>
<a id=__codelineno-18-30 name=__codelineno-18-30></a><a href=#__codelineno-18-30><span class=linenos data-linenos="30 "></span></a>  <span class=n>BaseRequestOptions</span><span class=o>&lt;?&gt;</span> <span class=n>requestOptions</span> <span class=o>=</span> <span class=k>this</span><span class=p>;</span>
<a id=__codelineno-18-31 name=__codelineno-18-31></a><a href=#__codelineno-18-31><span class=linenos data-linenos="31 "></span></a>  <span class=c1>// è‹¥æ²¡æœ‰æŒ‡å®štransformï¼ŒisTransformationSet()ä¸ºfalse</span>
<a id=__codelineno-18-32 name=__codelineno-18-32></a><a href=#__codelineno-18-32><span class=linenos data-linenos="32 "></span></a>  <span class=c1>// isTransformationAllowed()ä¸€èˆ¬ä¸ºtrueï¼Œé™¤éä¸»åŠ¨è°ƒç”¨äº†dontTransform()æ–¹æ³•</span>
<a id=__codelineno-18-33 name=__codelineno-18-33></a><a href=#__codelineno-18-33><span class=linenos data-linenos="33 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>requestOptions</span><span class=p>.</span><span class=na>isTransformationSet</span><span class=p>()</span>
<a id=__codelineno-18-34 name=__codelineno-18-34></a><a href=#__codelineno-18-34><span class=linenos data-linenos="34 "></span></a>      <span class=o>&amp;&amp;</span> <span class=n>requestOptions</span><span class=p>.</span><span class=na>isTransformationAllowed</span><span class=p>()</span>
<a id=__codelineno-18-35 name=__codelineno-18-35></a><a href=#__codelineno-18-35><span class=linenos data-linenos="35 "></span></a>      <span class=o>&amp;&amp;</span> <span class=n>view</span><span class=p>.</span><span class=na>getScaleType</span><span class=p>()</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-18-36 name=__codelineno-18-36></a><a href=#__codelineno-18-36><span class=linenos data-linenos="36 "></span></a>    <span class=c1>// Clone in this method so that if we use this RequestBuilder to load into a View and then</span>
<a id=__codelineno-18-37 name=__codelineno-18-37></a><a href=#__codelineno-18-37><span class=linenos data-linenos="37 "></span></a>    <span class=c1>// into a different target, we don&#39;t retain the transformation applied based on the previous</span>
<a id=__codelineno-18-38 name=__codelineno-18-38></a><a href=#__codelineno-18-38><span class=linenos data-linenos="38 "></span></a>    <span class=c1>// View&#39;s scale type.</span>
<a id=__codelineno-18-39 name=__codelineno-18-39></a><a href=#__codelineno-18-39><span class=linenos data-linenos="39 "></span></a>    <span class=c1>//</span>
<a id=__codelineno-18-40 name=__codelineno-18-40></a><a href=#__codelineno-18-40><span class=linenos data-linenos="40 "></span></a>    <span class=c1>// æ ¹æ®ImageViewçš„ScaleTypeè®¾ç½®ä¸åŒçš„down sampleå’Œtransformé€‰é¡¹</span>
<a id=__codelineno-18-41 name=__codelineno-18-41></a><a href=#__codelineno-18-41><span class=linenos data-linenos="41 "></span></a>    <span class=k>switch</span> <span class=p>(</span><span class=n>view</span><span class=p>.</span><span class=na>getScaleType</span><span class=p>())</span> <span class=p>{</span>
<a id=__codelineno-18-42 name=__codelineno-18-42></a><a href=#__codelineno-18-42><span class=linenos data-linenos="42 "></span></a>      <span class=k>case</span> <span class=n>CENTER_CROP</span><span class=p>:</span>
<a id=__codelineno-18-43 name=__codelineno-18-43></a><a href=#__codelineno-18-43><span class=linenos data-linenos="43 "></span></a>        <span class=n>requestOptions</span> <span class=o>=</span> <span class=n>requestOptions</span><span class=p>.</span><span class=na>clone</span><span class=p>().</span><span class=na>optionalCenterCrop</span><span class=p>();</span>
<a id=__codelineno-18-44 name=__codelineno-18-44></a><a href=#__codelineno-18-44><span class=linenos data-linenos="44 "></span></a>        <span class=k>break</span><span class=p>;</span>
<a id=__codelineno-18-45 name=__codelineno-18-45></a><a href=#__codelineno-18-45><span class=linenos data-linenos="45 "></span></a>      <span class=k>case</span> <span class=n>CENTER_INSIDE</span><span class=p>:</span>
<a id=__codelineno-18-46 name=__codelineno-18-46></a><a href=#__codelineno-18-46><span class=linenos data-linenos="46 "></span></a>        <span class=n>requestOptions</span> <span class=o>=</span> <span class=n>requestOptions</span><span class=p>.</span><span class=na>clone</span><span class=p>().</span><span class=na>optionalCenterInside</span><span class=p>();</span>
<a id=__codelineno-18-47 name=__codelineno-18-47></a><a href=#__codelineno-18-47><span class=linenos data-linenos="47 "></span></a>        <span class=k>break</span><span class=p>;</span>
<a id=__codelineno-18-48 name=__codelineno-18-48></a><a href=#__codelineno-18-48><span class=linenos data-linenos="48 "></span></a>      <span class=k>case</span> <span class=n>FIT_CENTER</span><span class=p>:</span>  <span class=c1>// é»˜è®¤å€¼</span>
<a id=__codelineno-18-49 name=__codelineno-18-49></a><a href=#__codelineno-18-49><span class=linenos data-linenos="49 "></span></a>      <span class=k>case</span> <span class=n>FIT_START</span><span class=p>:</span>
<a id=__codelineno-18-50 name=__codelineno-18-50></a><a href=#__codelineno-18-50><span class=linenos data-linenos="50 "></span></a>      <span class=k>case</span> <span class=n>FIT_END</span><span class=p>:</span>
<a id=__codelineno-18-51 name=__codelineno-18-51></a><a href=#__codelineno-18-51><span class=linenos data-linenos="51 "></span></a>        <span class=n>requestOptions</span> <span class=o>=</span> <span class=n>requestOptions</span><span class=p>.</span><span class=na>clone</span><span class=p>().</span><span class=na>optionalFitCenter</span><span class=p>();</span>
<a id=__codelineno-18-52 name=__codelineno-18-52></a><a href=#__codelineno-18-52><span class=linenos data-linenos="52 "></span></a>        <span class=k>break</span><span class=p>;</span>
<a id=__codelineno-18-53 name=__codelineno-18-53></a><a href=#__codelineno-18-53><span class=linenos data-linenos="53 "></span></a>      <span class=k>case</span> <span class=n>FIT_XY</span><span class=p>:</span>
<a id=__codelineno-18-54 name=__codelineno-18-54></a><a href=#__codelineno-18-54><span class=linenos data-linenos="54 "></span></a>        <span class=n>requestOptions</span> <span class=o>=</span> <span class=n>requestOptions</span><span class=p>.</span><span class=na>clone</span><span class=p>().</span><span class=na>optionalCenterInside</span><span class=p>();</span>
<a id=__codelineno-18-55 name=__codelineno-18-55></a><a href=#__codelineno-18-55><span class=linenos data-linenos="55 "></span></a>        <span class=k>break</span><span class=p>;</span>
<a id=__codelineno-18-56 name=__codelineno-18-56></a><a href=#__codelineno-18-56><span class=linenos data-linenos="56 "></span></a>      <span class=k>case</span> <span class=n>CENTER</span><span class=p>:</span>
<a id=__codelineno-18-57 name=__codelineno-18-57></a><a href=#__codelineno-18-57><span class=linenos data-linenos="57 "></span></a>      <span class=k>case</span> <span class=n>MATRIX</span><span class=p>:</span>
<a id=__codelineno-18-58 name=__codelineno-18-58></a><a href=#__codelineno-18-58><span class=linenos data-linenos="58 "></span></a>      <span class=k>default</span><span class=p>:</span>
<a id=__codelineno-18-59 name=__codelineno-18-59></a><a href=#__codelineno-18-59><span class=linenos data-linenos="59 "></span></a>        <span class=c1>// Do nothing.</span>
<a id=__codelineno-18-60 name=__codelineno-18-60></a><a href=#__codelineno-18-60><span class=linenos data-linenos="60 "></span></a>    <span class=p>}</span>
<a id=__codelineno-18-61 name=__codelineno-18-61></a><a href=#__codelineno-18-61><span class=linenos data-linenos="61 "></span></a>  <span class=p>}</span>
<a id=__codelineno-18-62 name=__codelineno-18-62></a><a href=#__codelineno-18-62><span class=linenos data-linenos="62 "></span></a>
<a id=__codelineno-18-63 name=__codelineno-18-63></a><a href=#__codelineno-18-63><span class=linenos data-linenos="63 "></span></a>  <span class=c1>// è°ƒç”¨ä¸Šé¢çš„é‡è½½æ–¹æ³•</span>
<a id=__codelineno-18-64 name=__codelineno-18-64></a><a href=#__codelineno-18-64><span class=linenos data-linenos="64 "></span></a>  <span class=k>return</span> <span class=n>into</span><span class=p>(</span>
<a id=__codelineno-18-65 name=__codelineno-18-65></a><a href=#__codelineno-18-65><span class=linenos data-linenos="65 "></span></a>      <span class=n>glideContext</span><span class=p>.</span><span class=na>buildImageViewTarget</span><span class=p>(</span><span class=n>view</span><span class=p>,</span> <span class=n>transcodeClass</span><span class=p>),</span>
<a id=__codelineno-18-66 name=__codelineno-18-66></a><a href=#__codelineno-18-66><span class=linenos data-linenos="66 "></span></a>      <span class=cm>/*targetListener=*/</span> <span class=kc>null</span><span class=p>,</span>
<a id=__codelineno-18-67 name=__codelineno-18-67></a><a href=#__codelineno-18-67><span class=linenos data-linenos="67 "></span></a>      <span class=n>requestOptions</span><span class=p>,</span>
<a id=__codelineno-18-68 name=__codelineno-18-68></a><a href=#__codelineno-18-68><span class=linenos data-linenos="68 "></span></a>      <span class=n>Executors</span><span class=p>.</span><span class=na>mainThreadExecutor</span><span class=p>());</span>
<a id=__codelineno-18-69 name=__codelineno-18-69></a><a href=#__codelineno-18-69><span class=linenos data-linenos="69 "></span></a><span class=p>}</span>
</code></pre></div> <p>æˆ‘ä»¬çœ‹çœ‹<code>into(ImageView)</code>æ–¹æ³•çš„å®ç°ï¼Œé‡Œé¢ä¼šå…ˆåˆ¤æ–­éœ€ä¸éœ€è¦å¯¹å›¾ç‰‡è¿›è¡Œè£åˆ‡ï¼Œç„¶åè°ƒç”¨åˆ«çš„<code>into</code>é‡è½½æ–¹æ³•ã€‚é‡è½½æ–¹æ³•æˆ‘ä»¬ç¨ååœ¨è¯´ï¼Œå…ˆçœ‹çœ‹caseä¸ºé»˜è®¤å€¼<code>FIT_CENTER</code>æ—¶çš„æƒ…å†µï¼š</p> <p>é¦–å…ˆä¼šè°ƒç”¨<code>requestOptions.clone()</code>å¯¹åŸå§‹çš„RequestOptionsè¿›è¡Œå¤åˆ¶ï¼Œå…¶ç›®çš„æºç ä¸­å†™äº†ï¼šå½“ä½¿ç”¨æ­¤RequestOptionsåŠ è½½åˆ°ä¸€ä¸ªViewï¼Œç„¶ååŠ è½½åˆ°å¦å¤–ä¸€ä¸ªç›®æ ‡æ—¶ï¼Œä¸è¦ä¿ç•™åŸºäºä¸Šä¸€ä¸ªViewçš„scale typeæ‰€äº§ç”Ÿçš„transformationã€‚ </p> <p>å¤åˆ¶å®Œæˆä¹‹åï¼Œç„¶åä¼šæ¥ç€è°ƒç”¨<code>optionalFitCenter()</code>æ–¹æ³•ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-19-1 name=__codelineno-19-1></a><a href=#__codelineno-19-1><span class=linenos data-linenos="  1 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-19-2 name=__codelineno-19-2></a><a href=#__codelineno-19-2><span class=linenos data-linenos="  2 "></span></a><span class=nd>@CheckResult</span>
<a id=__codelineno-19-3 name=__codelineno-19-3></a><a href=#__codelineno-19-3><span class=linenos data-linenos="  3 "></span></a><span class=kd>public</span> <span class=n>T</span> <span class=nf>optionalFitCenter</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-19-4 name=__codelineno-19-4></a><a href=#__codelineno-19-4><span class=linenos data-linenos="  4 "></span></a>  <span class=k>return</span> <span class=n>optionalScaleOnlyTransform</span><span class=p>(</span><span class=n>DownsampleStrategy</span><span class=p>.</span><span class=na>FIT_CENTER</span><span class=p>,</span> <span class=k>new</span> <span class=n>FitCenter</span><span class=p>());</span>
<a id=__codelineno-19-5 name=__codelineno-19-5></a><a href=#__codelineno-19-5><span class=linenos data-linenos="  5 "></span></a><span class=p>}</span>
<a id=__codelineno-19-6 name=__codelineno-19-6></a><a href=#__codelineno-19-6><span class=linenos data-linenos="  6 "></span></a>
<a id=__codelineno-19-7 name=__codelineno-19-7></a><a href=#__codelineno-19-7><span class=linenos data-linenos="  7 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-19-8 name=__codelineno-19-8></a><a href=#__codelineno-19-8><span class=linenos data-linenos="  8 "></span></a><span class=kd>private</span> <span class=n>T</span> <span class=nf>optionalScaleOnlyTransform</span><span class=p>(</span>
<a id=__codelineno-19-9 name=__codelineno-19-9></a><a href=#__codelineno-19-9><span class=linenos data-linenos="  9 "></span></a>    <span class=nd>@NonNull</span> <span class=n>DownsampleStrategy</span> <span class=n>strategy</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Transformation</span><span class=o>&lt;</span><span class=n>Bitmap</span><span class=o>&gt;</span> <span class=n>transformation</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-19-10 name=__codelineno-19-10></a><a href=#__codelineno-19-10><span class=linenos data-linenos=" 10 "></span></a>  <span class=k>return</span> <span class=n>scaleOnlyTransform</span><span class=p>(</span><span class=n>strategy</span><span class=p>,</span> <span class=n>transformation</span><span class=p>,</span> <span class=kc>false</span> <span class=cm>/*isTransformationRequired*/</span><span class=p>);</span>
<a id=__codelineno-19-11 name=__codelineno-19-11></a><a href=#__codelineno-19-11><span class=linenos data-linenos=" 11 "></span></a><span class=p>}</span>
<a id=__codelineno-19-12 name=__codelineno-19-12></a><a href=#__codelineno-19-12><span class=linenos data-linenos=" 12 "></span></a>
<a id=__codelineno-19-13 name=__codelineno-19-13></a><a href=#__codelineno-19-13><span class=linenos data-linenos=" 13 "></span></a><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;unchecked&quot;</span><span class=p>)</span>
<a id=__codelineno-19-14 name=__codelineno-19-14></a><a href=#__codelineno-19-14><span class=linenos data-linenos=" 14 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-19-15 name=__codelineno-19-15></a><a href=#__codelineno-19-15><span class=linenos data-linenos=" 15 "></span></a><span class=kd>private</span> <span class=n>T</span> <span class=nf>scaleOnlyTransform</span><span class=p>(</span>
<a id=__codelineno-19-16 name=__codelineno-19-16></a><a href=#__codelineno-19-16><span class=linenos data-linenos=" 16 "></span></a>    <span class=nd>@NonNull</span> <span class=n>DownsampleStrategy</span> <span class=n>strategy</span><span class=p>,</span>
<a id=__codelineno-19-17 name=__codelineno-19-17></a><a href=#__codelineno-19-17><span class=linenos data-linenos=" 17 "></span></a>    <span class=nd>@NonNull</span> <span class=n>Transformation</span><span class=o>&lt;</span><span class=n>Bitmap</span><span class=o>&gt;</span> <span class=n>transformation</span><span class=p>,</span>
<a id=__codelineno-19-18 name=__codelineno-19-18></a><a href=#__codelineno-19-18><span class=linenos data-linenos=" 18 "></span></a>    <span class=kt>boolean</span> <span class=n>isTransformationRequired</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-19-19 name=__codelineno-19-19></a><a href=#__codelineno-19-19><span class=linenos data-linenos=" 19 "></span></a>  <span class=n>BaseRequestOptions</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=n>isTransformationRequired</span>
<a id=__codelineno-19-20 name=__codelineno-19-20></a><a href=#__codelineno-19-20><span class=linenos data-linenos=" 20 "></span></a>        <span class=o>?</span> <span class=n>transform</span><span class=p>(</span><span class=n>strategy</span><span class=p>,</span> <span class=n>transformation</span><span class=p>)</span> <span class=p>:</span> <span class=n>optionalTransform</span><span class=p>(</span><span class=n>strategy</span><span class=p>,</span> <span class=n>transformation</span><span class=p>);</span>
<a id=__codelineno-19-21 name=__codelineno-19-21></a><a href=#__codelineno-19-21><span class=linenos data-linenos=" 21 "></span></a>  <span class=n>result</span><span class=p>.</span><span class=na>isScaleOnlyOrNoTransform</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
<a id=__codelineno-19-22 name=__codelineno-19-22></a><a href=#__codelineno-19-22><span class=linenos data-linenos=" 22 "></span></a>  <span class=k>return</span> <span class=p>(</span><span class=n>T</span><span class=p>)</span> <span class=n>result</span><span class=p>;</span>
<a id=__codelineno-19-23 name=__codelineno-19-23></a><a href=#__codelineno-19-23><span class=linenos data-linenos=" 23 "></span></a><span class=p>}</span>
<a id=__codelineno-19-24 name=__codelineno-19-24></a><a href=#__codelineno-19-24><span class=linenos data-linenos=" 24 "></span></a>
<a id=__codelineno-19-25 name=__codelineno-19-25></a><a href=#__codelineno-19-25><span class=linenos data-linenos=" 25 "></span></a><span class=nd>@SuppressWarnings</span><span class=p>({</span><span class=s>&quot;WeakerAccess&quot;</span><span class=p>,</span> <span class=s>&quot;CheckResult&quot;</span><span class=p>})</span>
<a id=__codelineno-19-26 name=__codelineno-19-26></a><a href=#__codelineno-19-26><span class=linenos data-linenos=" 26 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-19-27 name=__codelineno-19-27></a><a href=#__codelineno-19-27><span class=linenos data-linenos=" 27 "></span></a><span class=kd>final</span> <span class=n>T</span> <span class=nf>optionalTransform</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>DownsampleStrategy</span> <span class=n>downsampleStrategy</span><span class=p>,</span>
<a id=__codelineno-19-28 name=__codelineno-19-28></a><a href=#__codelineno-19-28><span class=linenos data-linenos=" 28 "></span></a>    <span class=nd>@NonNull</span> <span class=n>Transformation</span><span class=o>&lt;</span><span class=n>Bitmap</span><span class=o>&gt;</span> <span class=n>transformation</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-19-29 name=__codelineno-19-29></a><a href=#__codelineno-19-29><span class=linenos data-linenos=" 29 "></span></a>  <span class=c1>// isAutoCloneEnabledé»˜è®¤ä¸ºfalseï¼Œåªæœ‰åœ¨ä¸»åŠ¨è°ƒç”¨äº†autoClone()æ–¹æ³•ä¹‹åæ‰ä¼šä¸ºtrue</span>
<a id=__codelineno-19-30 name=__codelineno-19-30></a><a href=#__codelineno-19-30><span class=linenos data-linenos=" 30 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>isAutoCloneEnabled</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-19-31 name=__codelineno-19-31></a><a href=#__codelineno-19-31><span class=linenos data-linenos=" 31 "></span></a>    <span class=k>return</span> <span class=n>clone</span><span class=p>().</span><span class=na>optionalTransform</span><span class=p>(</span><span class=n>downsampleStrategy</span><span class=p>,</span> <span class=n>transformation</span><span class=p>);</span>
<a id=__codelineno-19-32 name=__codelineno-19-32></a><a href=#__codelineno-19-32><span class=linenos data-linenos=" 32 "></span></a>  <span class=p>}</span>
<a id=__codelineno-19-33 name=__codelineno-19-33></a><a href=#__codelineno-19-33><span class=linenos data-linenos=" 33 "></span></a>
<a id=__codelineno-19-34 name=__codelineno-19-34></a><a href=#__codelineno-19-34><span class=linenos data-linenos=" 34 "></span></a>  <span class=n>downsample</span><span class=p>(</span><span class=n>downsampleStrategy</span><span class=p>);</span>
<a id=__codelineno-19-35 name=__codelineno-19-35></a><a href=#__codelineno-19-35><span class=linenos data-linenos=" 35 "></span></a>  <span class=k>return</span> <span class=n>transform</span><span class=p>(</span><span class=n>transformation</span><span class=p>,</span> <span class=cm>/*isRequired=*/</span> <span class=kc>false</span><span class=p>);</span>
<a id=__codelineno-19-36 name=__codelineno-19-36></a><a href=#__codelineno-19-36><span class=linenos data-linenos=" 36 "></span></a><span class=p>}</span>
<a id=__codelineno-19-37 name=__codelineno-19-37></a><a href=#__codelineno-19-37><span class=linenos data-linenos=" 37 "></span></a>
<a id=__codelineno-19-38 name=__codelineno-19-38></a><a href=#__codelineno-19-38><span class=linenos data-linenos=" 38 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-19-39 name=__codelineno-19-39></a><a href=#__codelineno-19-39><span class=linenos data-linenos=" 39 "></span></a><span class=nd>@CheckResult</span>
<a id=__codelineno-19-40 name=__codelineno-19-40></a><a href=#__codelineno-19-40><span class=linenos data-linenos=" 40 "></span></a><span class=kd>public</span> <span class=n>T</span> <span class=nf>downsample</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>DownsampleStrategy</span> <span class=n>strategy</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-19-41 name=__codelineno-19-41></a><a href=#__codelineno-19-41><span class=linenos data-linenos=" 41 "></span></a>  <span class=k>return</span> <span class=n>set</span><span class=p>(</span><span class=n>DownsampleStrategy</span><span class=p>.</span><span class=na>OPTION</span><span class=p>,</span> <span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>strategy</span><span class=p>));</span>
<a id=__codelineno-19-42 name=__codelineno-19-42></a><a href=#__codelineno-19-42><span class=linenos data-linenos=" 42 "></span></a><span class=p>}</span>
<a id=__codelineno-19-43 name=__codelineno-19-43></a><a href=#__codelineno-19-43><span class=linenos data-linenos=" 43 "></span></a>
<a id=__codelineno-19-44 name=__codelineno-19-44></a><a href=#__codelineno-19-44><span class=linenos data-linenos=" 44 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-19-45 name=__codelineno-19-45></a><a href=#__codelineno-19-45><span class=linenos data-linenos=" 45 "></span></a><span class=nd>@CheckResult</span>
<a id=__codelineno-19-46 name=__codelineno-19-46></a><a href=#__codelineno-19-46><span class=linenos data-linenos=" 46 "></span></a><span class=kd>public</span> <span class=o>&lt;</span><span class=n>Y</span><span class=o>&gt;</span> <span class=n>T</span> <span class=nf>set</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Option</span><span class=o>&lt;</span><span class=n>Y</span><span class=o>&gt;</span> <span class=n>option</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Y</span> <span class=n>value</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-19-47 name=__codelineno-19-47></a><a href=#__codelineno-19-47><span class=linenos data-linenos=" 47 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>isAutoCloneEnabled</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-19-48 name=__codelineno-19-48></a><a href=#__codelineno-19-48><span class=linenos data-linenos=" 48 "></span></a>    <span class=k>return</span> <span class=n>clone</span><span class=p>().</span><span class=na>set</span><span class=p>(</span><span class=n>option</span><span class=p>,</span> <span class=n>value</span><span class=p>);</span>
<a id=__codelineno-19-49 name=__codelineno-19-49></a><a href=#__codelineno-19-49><span class=linenos data-linenos=" 49 "></span></a>  <span class=p>}</span>
<a id=__codelineno-19-50 name=__codelineno-19-50></a><a href=#__codelineno-19-50><span class=linenos data-linenos=" 50 "></span></a>
<a id=__codelineno-19-51 name=__codelineno-19-51></a><a href=#__codelineno-19-51><span class=linenos data-linenos=" 51 "></span></a>  <span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>option</span><span class=p>);</span>
<a id=__codelineno-19-52 name=__codelineno-19-52></a><a href=#__codelineno-19-52><span class=linenos data-linenos=" 52 "></span></a>  <span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>value</span><span class=p>);</span>
<a id=__codelineno-19-53 name=__codelineno-19-53></a><a href=#__codelineno-19-53><span class=linenos data-linenos=" 53 "></span></a>  <span class=n>options</span><span class=p>.</span><span class=na>set</span><span class=p>(</span><span class=n>option</span><span class=p>,</span> <span class=n>value</span><span class=p>);</span>
<a id=__codelineno-19-54 name=__codelineno-19-54></a><a href=#__codelineno-19-54><span class=linenos data-linenos=" 54 "></span></a>  <span class=k>return</span> <span class=n>selfOrThrowIfLocked</span><span class=p>();</span>
<a id=__codelineno-19-55 name=__codelineno-19-55></a><a href=#__codelineno-19-55><span class=linenos data-linenos=" 55 "></span></a><span class=p>}</span>
<a id=__codelineno-19-56 name=__codelineno-19-56></a><a href=#__codelineno-19-56><span class=linenos data-linenos=" 56 "></span></a>
<a id=__codelineno-19-57 name=__codelineno-19-57></a><a href=#__codelineno-19-57><span class=linenos data-linenos=" 57 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-19-58 name=__codelineno-19-58></a><a href=#__codelineno-19-58><span class=linenos data-linenos=" 58 "></span></a><span class=n>T</span> <span class=nf>transform</span><span class=p>(</span>
<a id=__codelineno-19-59 name=__codelineno-19-59></a><a href=#__codelineno-19-59><span class=linenos data-linenos=" 59 "></span></a>    <span class=nd>@NonNull</span> <span class=n>Transformation</span><span class=o>&lt;</span><span class=n>Bitmap</span><span class=o>&gt;</span> <span class=n>transformation</span><span class=p>,</span> <span class=kt>boolean</span> <span class=n>isRequired</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-19-60 name=__codelineno-19-60></a><a href=#__codelineno-19-60><span class=linenos data-linenos=" 60 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>isAutoCloneEnabled</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-19-61 name=__codelineno-19-61></a><a href=#__codelineno-19-61><span class=linenos data-linenos=" 61 "></span></a>    <span class=k>return</span> <span class=n>clone</span><span class=p>().</span><span class=na>transform</span><span class=p>(</span><span class=n>transformation</span><span class=p>,</span> <span class=n>isRequired</span><span class=p>);</span>
<a id=__codelineno-19-62 name=__codelineno-19-62></a><a href=#__codelineno-19-62><span class=linenos data-linenos=" 62 "></span></a>  <span class=p>}</span>
<a id=__codelineno-19-63 name=__codelineno-19-63></a><a href=#__codelineno-19-63><span class=linenos data-linenos=" 63 "></span></a>
<a id=__codelineno-19-64 name=__codelineno-19-64></a><a href=#__codelineno-19-64><span class=linenos data-linenos=" 64 "></span></a>  <span class=n>DrawableTransformation</span> <span class=n>drawableTransformation</span> <span class=o>=</span>
<a id=__codelineno-19-65 name=__codelineno-19-65></a><a href=#__codelineno-19-65><span class=linenos data-linenos=" 65 "></span></a>      <span class=k>new</span> <span class=n>DrawableTransformation</span><span class=p>(</span><span class=n>transformation</span><span class=p>,</span> <span class=n>isRequired</span><span class=p>);</span>
<a id=__codelineno-19-66 name=__codelineno-19-66></a><a href=#__codelineno-19-66><span class=linenos data-linenos=" 66 "></span></a>  <span class=n>transform</span><span class=p>(</span><span class=n>Bitmap</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>transformation</span><span class=p>,</span> <span class=n>isRequired</span><span class=p>);</span>
<a id=__codelineno-19-67 name=__codelineno-19-67></a><a href=#__codelineno-19-67><span class=linenos data-linenos=" 67 "></span></a>  <span class=n>transform</span><span class=p>(</span><span class=n>Drawable</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>drawableTransformation</span><span class=p>,</span> <span class=n>isRequired</span><span class=p>);</span>
<a id=__codelineno-19-68 name=__codelineno-19-68></a><a href=#__codelineno-19-68><span class=linenos data-linenos=" 68 "></span></a>  <span class=c1>// TODO: remove BitmapDrawable decoder and this transformation.</span>
<a id=__codelineno-19-69 name=__codelineno-19-69></a><a href=#__codelineno-19-69><span class=linenos data-linenos=" 69 "></span></a>  <span class=c1>// Registering as BitmapDrawable is simply an optimization to avoid some iteration and</span>
<a id=__codelineno-19-70 name=__codelineno-19-70></a><a href=#__codelineno-19-70><span class=linenos data-linenos=" 70 "></span></a>  <span class=c1>// isAssignableFrom checks when obtaining the transformation later on. It can be removed without</span>
<a id=__codelineno-19-71 name=__codelineno-19-71></a><a href=#__codelineno-19-71><span class=linenos data-linenos=" 71 "></span></a>  <span class=c1>// affecting the functionality.</span>
<a id=__codelineno-19-72 name=__codelineno-19-72></a><a href=#__codelineno-19-72><span class=linenos data-linenos=" 72 "></span></a>  <span class=n>transform</span><span class=p>(</span><span class=n>BitmapDrawable</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>drawableTransformation</span><span class=p>.</span><span class=na>asBitmapDrawable</span><span class=p>(),</span> <span class=n>isRequired</span><span class=p>);</span>
<a id=__codelineno-19-73 name=__codelineno-19-73></a><a href=#__codelineno-19-73><span class=linenos data-linenos=" 73 "></span></a>  <span class=n>transform</span><span class=p>(</span><span class=n>GifDrawable</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=k>new</span> <span class=n>GifDrawableTransformation</span><span class=p>(</span><span class=n>transformation</span><span class=p>),</span> <span class=n>isRequired</span><span class=p>);</span>
<a id=__codelineno-19-74 name=__codelineno-19-74></a><a href=#__codelineno-19-74><span class=linenos data-linenos=" 74 "></span></a>  <span class=k>return</span> <span class=n>selfOrThrowIfLocked</span><span class=p>();</span>
<a id=__codelineno-19-75 name=__codelineno-19-75></a><a href=#__codelineno-19-75><span class=linenos data-linenos=" 75 "></span></a><span class=p>}</span>
<a id=__codelineno-19-76 name=__codelineno-19-76></a><a href=#__codelineno-19-76><span class=linenos data-linenos=" 76 "></span></a>
<a id=__codelineno-19-77 name=__codelineno-19-77></a><a href=#__codelineno-19-77><span class=linenos data-linenos=" 77 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-19-78 name=__codelineno-19-78></a><a href=#__codelineno-19-78><span class=linenos data-linenos=" 78 "></span></a><span class=o>&lt;</span><span class=n>Y</span><span class=o>&gt;</span> <span class=n>T</span> <span class=nf>transform</span><span class=p>(</span>
<a id=__codelineno-19-79 name=__codelineno-19-79></a><a href=#__codelineno-19-79><span class=linenos data-linenos=" 79 "></span></a>    <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Y</span><span class=o>&gt;</span> <span class=n>resourceClass</span><span class=p>,</span>
<a id=__codelineno-19-80 name=__codelineno-19-80></a><a href=#__codelineno-19-80><span class=linenos data-linenos=" 80 "></span></a>    <span class=nd>@NonNull</span> <span class=n>Transformation</span><span class=o>&lt;</span><span class=n>Y</span><span class=o>&gt;</span> <span class=n>transformation</span><span class=p>,</span>
<a id=__codelineno-19-81 name=__codelineno-19-81></a><a href=#__codelineno-19-81><span class=linenos data-linenos=" 81 "></span></a>    <span class=kt>boolean</span> <span class=n>isRequired</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-19-82 name=__codelineno-19-82></a><a href=#__codelineno-19-82><span class=linenos data-linenos=" 82 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>isAutoCloneEnabled</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-19-83 name=__codelineno-19-83></a><a href=#__codelineno-19-83><span class=linenos data-linenos=" 83 "></span></a>    <span class=k>return</span> <span class=n>clone</span><span class=p>().</span><span class=na>transform</span><span class=p>(</span><span class=n>resourceClass</span><span class=p>,</span> <span class=n>transformation</span><span class=p>,</span> <span class=n>isRequired</span><span class=p>);</span>
<a id=__codelineno-19-84 name=__codelineno-19-84></a><a href=#__codelineno-19-84><span class=linenos data-linenos=" 84 "></span></a>  <span class=p>}</span>
<a id=__codelineno-19-85 name=__codelineno-19-85></a><a href=#__codelineno-19-85><span class=linenos data-linenos=" 85 "></span></a>
<a id=__codelineno-19-86 name=__codelineno-19-86></a><a href=#__codelineno-19-86><span class=linenos data-linenos=" 86 "></span></a>  <span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>resourceClass</span><span class=p>);</span>
<a id=__codelineno-19-87 name=__codelineno-19-87></a><a href=#__codelineno-19-87><span class=linenos data-linenos=" 87 "></span></a>  <span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>transformation</span><span class=p>);</span>
<a id=__codelineno-19-88 name=__codelineno-19-88></a><a href=#__codelineno-19-88><span class=linenos data-linenos=" 88 "></span></a>  <span class=n>transformations</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>resourceClass</span><span class=p>,</span> <span class=n>transformation</span><span class=p>);</span>
<a id=__codelineno-19-89 name=__codelineno-19-89></a><a href=#__codelineno-19-89><span class=linenos data-linenos=" 89 "></span></a>  <span class=n>fields</span> <span class=o>|=</span> <span class=n>TRANSFORMATION</span><span class=p>;</span>
<a id=__codelineno-19-90 name=__codelineno-19-90></a><a href=#__codelineno-19-90><span class=linenos data-linenos=" 90 "></span></a>  <span class=n>isTransformationAllowed</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
<a id=__codelineno-19-91 name=__codelineno-19-91></a><a href=#__codelineno-19-91><span class=linenos data-linenos=" 91 "></span></a>  <span class=n>fields</span> <span class=o>|=</span> <span class=n>TRANSFORMATION_ALLOWED</span><span class=p>;</span>
<a id=__codelineno-19-92 name=__codelineno-19-92></a><a href=#__codelineno-19-92><span class=linenos data-linenos=" 92 "></span></a>  <span class=c1>// Always set to false here. Known scale only transformations will call this method and then</span>
<a id=__codelineno-19-93 name=__codelineno-19-93></a><a href=#__codelineno-19-93><span class=linenos data-linenos=" 93 "></span></a>  <span class=c1>// set isScaleOnlyOrNoTransform to true immediately after.</span>
<a id=__codelineno-19-94 name=__codelineno-19-94></a><a href=#__codelineno-19-94><span class=linenos data-linenos=" 94 "></span></a>  <span class=n>isScaleOnlyOrNoTransform</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
<a id=__codelineno-19-95 name=__codelineno-19-95></a><a href=#__codelineno-19-95><span class=linenos data-linenos=" 95 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>isRequired</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-19-96 name=__codelineno-19-96></a><a href=#__codelineno-19-96><span class=linenos data-linenos=" 96 "></span></a>    <span class=n>fields</span> <span class=o>|=</span> <span class=n>TRANSFORMATION_REQUIRED</span><span class=p>;</span>
<a id=__codelineno-19-97 name=__codelineno-19-97></a><a href=#__codelineno-19-97><span class=linenos data-linenos=" 97 "></span></a>    <span class=n>isTransformationRequired</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
<a id=__codelineno-19-98 name=__codelineno-19-98></a><a href=#__codelineno-19-98><span class=linenos data-linenos=" 98 "></span></a>  <span class=p>}</span>
<a id=__codelineno-19-99 name=__codelineno-19-99></a><a href=#__codelineno-19-99><span class=linenos data-linenos=" 99 "></span></a>  <span class=k>return</span> <span class=n>selfOrThrowIfLocked</span><span class=p>();</span>
<a id=__codelineno-19-100 name=__codelineno-19-100></a><a href=#__codelineno-19-100><span class=linenos data-linenos="100 "></span></a><span class=p>}</span>
</code></pre></div> <p>ä¸Šé¢è¿™äº›æ“ä½œå®é™…ä¸Šåªæ˜¯å‡ ä¸ªå€¼ä¿å­˜åˆ°<code>BaseRequestOptions</code>å†…éƒ¨çš„ä¸¤ä¸ª<code>CachedHashCodeArrayMap</code>é‡Œé¢ï¼Œå…¶ä¸­é”®å€¼å¯¹ä»¥åŠä¿å­˜åˆ°çš„ä½ç½®å¦‚ä¸‹ï¼š</p> <figcaption>optionalFitCenter()è¿‡ç¨‹ä¿å­˜çš„KV</figcaption> <table> <thead> <tr> <th>ä¿å­˜çš„ä½ç½®</th> <th>K</th> <th>V</th> </tr> </thead> <tbody> <tr> <td>Options.values</td> <td>DownsampleStrategy.OPTION</td> <td>DownsampleStrategy.FitCenter()</td> </tr> <tr> <td>transformations</td> <td>Bitmap.class</td> <td>FitCenter()</td> </tr> <tr> <td>transformations</td> <td>Drawable.class</td> <td>DrawableTransformation(FitCenter(), false)</td> </tr> <tr> <td>transformations</td> <td>BitmapDrawable.class</td> <td>DrawableTransformation(FitCenter(), false).asBitmapDrawable()</td> </tr> <tr> <td>transformations</td> <td>GifDrawable.class</td> <td>GifDrawableTransformation(FitCenter())</td> </tr> </tbody> </table> <p>å°†KVä¿å­˜å¥½äº†ä¹‹åï¼Œå°±å‡†å¤‡è°ƒç”¨æœ€ç»ˆçš„<code>into</code>æ–¹æ³•äº†ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹å…¥å‚ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-20-1 name=__codelineno-20-1></a><a href=#__codelineno-20-1><span class=linenos data-linenos="1 "></span></a><span class=n>into</span><span class=p>(</span>
<a id=__codelineno-20-2 name=__codelineno-20-2></a><a href=#__codelineno-20-2><span class=linenos data-linenos="2 "></span></a>    <span class=n>glideContext</span><span class=p>.</span><span class=na>buildImageViewTarget</span><span class=p>(</span><span class=n>view</span><span class=p>,</span> <span class=n>transcodeClass</span><span class=p>),</span>
<a id=__codelineno-20-3 name=__codelineno-20-3></a><a href=#__codelineno-20-3><span class=linenos data-linenos="3 "></span></a>    <span class=cm>/*targetListener=*/</span> <span class=kc>null</span><span class=p>,</span>
<a id=__codelineno-20-4 name=__codelineno-20-4></a><a href=#__codelineno-20-4><span class=linenos data-linenos="4 "></span></a>    <span class=n>requestOptions</span><span class=p>,</span>
<a id=__codelineno-20-5 name=__codelineno-20-5></a><a href=#__codelineno-20-5><span class=linenos data-linenos="5 "></span></a>    <span class=n>Executors</span><span class=p>.</span><span class=na>mainThreadExecutor</span><span class=p>());</span>
</code></pre></div> <p>ç¬¬ä¸€ä¸ªå‚æ•°ç­‰äº<code>(ViewTarget&lt;ImageView, Drawable&gt;) new DrawableImageViewTarget(view)</code>ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-21-1 name=__codelineno-21-1></a><a href=#__codelineno-21-1><span class=linenos data-linenos=" 1 "></span></a><span class=c1>// GlideContext</span>
<a id=__codelineno-21-2 name=__codelineno-21-2></a><a href=#__codelineno-21-2><span class=linenos data-linenos=" 2 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-21-3 name=__codelineno-21-3></a><a href=#__codelineno-21-3><span class=linenos data-linenos=" 3 "></span></a><span class=kd>public</span> <span class=o>&lt;</span><span class=n>X</span><span class=o>&gt;</span> <span class=n>ViewTarget</span><span class=o>&lt;</span><span class=n>ImageView</span><span class=p>,</span> <span class=n>X</span><span class=o>&gt;</span> <span class=nf>buildImageViewTarget</span><span class=p>(</span>
<a id=__codelineno-21-4 name=__codelineno-21-4></a><a href=#__codelineno-21-4><span class=linenos data-linenos=" 4 "></span></a>    <span class=nd>@NonNull</span> <span class=n>ImageView</span> <span class=n>imageView</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>X</span><span class=o>&gt;</span> <span class=n>transcodeClass</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-21-5 name=__codelineno-21-5></a><a href=#__codelineno-21-5><span class=linenos data-linenos=" 5 "></span></a>  <span class=c1>// imageViewTargetFactoryæ˜¯ImageViewTargetFactoryçš„ä¸€ä¸ªå®ä¾‹</span>
<a id=__codelineno-21-6 name=__codelineno-21-6></a><a href=#__codelineno-21-6><span class=linenos data-linenos=" 6 "></span></a>  <span class=c1>// transcodeClassåœ¨RequestManager.loadæ–¹æ³•ä¸­ç¡®å®šäº†ï¼Œå°±æ˜¯Drawable.class</span>
<a id=__codelineno-21-7 name=__codelineno-21-7></a><a href=#__codelineno-21-7><span class=linenos data-linenos=" 7 "></span></a>  <span class=k>return</span> <span class=n>imageViewTargetFactory</span><span class=p>.</span><span class=na>buildTarget</span><span class=p>(</span><span class=n>imageView</span><span class=p>,</span> <span class=n>transcodeClass</span><span class=p>);</span>
<a id=__codelineno-21-8 name=__codelineno-21-8></a><a href=#__codelineno-21-8><span class=linenos data-linenos=" 8 "></span></a><span class=p>}</span>
<a id=__codelineno-21-9 name=__codelineno-21-9></a><a href=#__codelineno-21-9><span class=linenos data-linenos=" 9 "></span></a>
<a id=__codelineno-21-10 name=__codelineno-21-10></a><a href=#__codelineno-21-10><span class=linenos data-linenos="10 "></span></a><span class=c1>// ImageViewTargetFactory</span>
<a id=__codelineno-21-11 name=__codelineno-21-11></a><a href=#__codelineno-21-11><span class=linenos data-linenos="11 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-21-12 name=__codelineno-21-12></a><a href=#__codelineno-21-12><span class=linenos data-linenos="12 "></span></a><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;unchecked&quot;</span><span class=p>)</span>
<a id=__codelineno-21-13 name=__codelineno-21-13></a><a href=#__codelineno-21-13><span class=linenos data-linenos="13 "></span></a><span class=kd>public</span> <span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>ViewTarget</span><span class=o>&lt;</span><span class=n>ImageView</span><span class=p>,</span> <span class=n>Z</span><span class=o>&gt;</span> <span class=nf>buildTarget</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>ImageView</span> <span class=n>view</span><span class=p>,</span>
<a id=__codelineno-21-14 name=__codelineno-21-14></a><a href=#__codelineno-21-14><span class=linenos data-linenos="14 "></span></a>    <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>clazz</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-21-15 name=__codelineno-21-15></a><a href=#__codelineno-21-15><span class=linenos data-linenos="15 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>Bitmap</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>clazz</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-21-16 name=__codelineno-21-16></a><a href=#__codelineno-21-16><span class=linenos data-linenos="16 "></span></a>    <span class=k>return</span> <span class=p>(</span><span class=n>ViewTarget</span><span class=o>&lt;</span><span class=n>ImageView</span><span class=p>,</span> <span class=n>Z</span><span class=o>&gt;</span><span class=p>)</span> <span class=k>new</span> <span class=n>BitmapImageViewTarget</span><span class=p>(</span><span class=n>view</span><span class=p>);</span>
<a id=__codelineno-21-17 name=__codelineno-21-17></a><a href=#__codelineno-21-17><span class=linenos data-linenos="17 "></span></a>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>Drawable</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>clazz</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-21-18 name=__codelineno-21-18></a><a href=#__codelineno-21-18><span class=linenos data-linenos="18 "></span></a>    <span class=c1>// è¿”å›çš„æ˜¯(ViewTarget&lt;ImageView, Drawable&gt;) new DrawableImageViewTarget(view);</span>
<a id=__codelineno-21-19 name=__codelineno-21-19></a><a href=#__codelineno-21-19><span class=linenos data-linenos="19 "></span></a>    <span class=k>return</span> <span class=p>(</span><span class=n>ViewTarget</span><span class=o>&lt;</span><span class=n>ImageView</span><span class=p>,</span> <span class=n>Z</span><span class=o>&gt;</span><span class=p>)</span> <span class=k>new</span> <span class=n>DrawableImageViewTarget</span><span class=p>(</span><span class=n>view</span><span class=p>);</span>
<a id=__codelineno-21-20 name=__codelineno-21-20></a><a href=#__codelineno-21-20><span class=linenos data-linenos="20 "></span></a>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
<a id=__codelineno-21-21 name=__codelineno-21-21></a><a href=#__codelineno-21-21><span class=linenos data-linenos="21 "></span></a>    <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=p>(</span>
<a id=__codelineno-21-22 name=__codelineno-21-22></a><a href=#__codelineno-21-22><span class=linenos data-linenos="22 "></span></a>        <span class=s>&quot;Unhandled class: &quot;</span> <span class=o>+</span> <span class=n>clazz</span> <span class=o>+</span> <span class=s>&quot;, try .as*(Class).transcode(ResourceTranscoder)&quot;</span><span class=p>);</span>
<a id=__codelineno-21-23 name=__codelineno-21-23></a><a href=#__codelineno-21-23><span class=linenos data-linenos="23 "></span></a>  <span class=p>}</span>
<a id=__codelineno-21-24 name=__codelineno-21-24></a><a href=#__codelineno-21-24><span class=linenos data-linenos="24 "></span></a><span class=p>}</span>
</code></pre></div> <p><code>Executors.mainThreadExecutor()</code>å°±æ˜¯ä¸€ä¸ªä½¿ç”¨MainLooperçš„Handlerï¼Œåœ¨execute Runnableæ—¶ä½¿ç”¨æ­¤Handler postå‡ºå»ã€‚</p> <div class=highlight><pre><span></span><code><a id=__codelineno-22-1 name=__codelineno-22-1></a><a href=#__codelineno-22-1><span class=linenos data-linenos=" 1 "></span></a>  <span class=cm>/** Posts executions to the main thread. */</span>
<a id=__codelineno-22-2 name=__codelineno-22-2></a><a href=#__codelineno-22-2><span class=linenos data-linenos=" 2 "></span></a>  <span class=kd>public</span> <span class=kd>static</span> <span class=n>Executor</span> <span class=nf>mainThreadExecutor</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-22-3 name=__codelineno-22-3></a><a href=#__codelineno-22-3><span class=linenos data-linenos=" 3 "></span></a>    <span class=k>return</span> <span class=n>MAIN_THREAD_EXECUTOR</span><span class=p>;</span>
<a id=__codelineno-22-4 name=__codelineno-22-4></a><a href=#__codelineno-22-4><span class=linenos data-linenos=" 4 "></span></a>  <span class=p>}</span>
<a id=__codelineno-22-5 name=__codelineno-22-5></a><a href=#__codelineno-22-5><span class=linenos data-linenos=" 5 "></span></a>
<a id=__codelineno-22-6 name=__codelineno-22-6></a><a href=#__codelineno-22-6><span class=linenos data-linenos=" 6 "></span></a>  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>Executor</span> <span class=n>MAIN_THREAD_EXECUTOR</span> <span class=o>=</span>
<a id=__codelineno-22-7 name=__codelineno-22-7></a><a href=#__codelineno-22-7><span class=linenos data-linenos=" 7 "></span></a>      <span class=k>new</span> <span class=n>Executor</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-22-8 name=__codelineno-22-8></a><a href=#__codelineno-22-8><span class=linenos data-linenos=" 8 "></span></a>        <span class=kd>private</span> <span class=kd>final</span> <span class=n>Handler</span> <span class=n>handler</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Handler</span><span class=p>(</span><span class=n>Looper</span><span class=p>.</span><span class=na>getMainLooper</span><span class=p>());</span>
<a id=__codelineno-22-9 name=__codelineno-22-9></a><a href=#__codelineno-22-9><span class=linenos data-linenos=" 9 "></span></a>
<a id=__codelineno-22-10 name=__codelineno-22-10></a><a href=#__codelineno-22-10><span class=linenos data-linenos="10 "></span></a>        <span class=nd>@Override</span>
<a id=__codelineno-22-11 name=__codelineno-22-11></a><a href=#__codelineno-22-11><span class=linenos data-linenos="11 "></span></a>        <span class=kd>public</span> <span class=kt>void</span> <span class=nf>execute</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Runnable</span> <span class=n>command</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-22-12 name=__codelineno-22-12></a><a href=#__codelineno-22-12><span class=linenos data-linenos="12 "></span></a>          <span class=n>handler</span><span class=p>.</span><span class=na>post</span><span class=p>(</span><span class=n>command</span><span class=p>);</span>
<a id=__codelineno-22-13 name=__codelineno-22-13></a><a href=#__codelineno-22-13><span class=linenos data-linenos="13 "></span></a>        <span class=p>}</span>
<a id=__codelineno-22-14 name=__codelineno-22-14></a><a href=#__codelineno-22-14><span class=linenos data-linenos="14 "></span></a>      <span class=p>};</span>
</code></pre></div> <p>ç°åœ¨æˆ‘ä»¬ç»ˆäºå›åˆ°äº†æœ€ç»ˆçš„<code>load</code>é‡è½½æ–¹æ³•ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-23-1 name=__codelineno-23-1></a><a href=#__codelineno-23-1><span class=linenos data-linenos=" 1 "></span></a><span class=kd>private</span> <span class=o>&lt;</span><span class=n>Y</span> <span class=kd>extends</span> <span class=n>Target</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;&gt;</span> <span class=n>Y</span> <span class=nf>into</span><span class=p>(</span>
<a id=__codelineno-23-2 name=__codelineno-23-2></a><a href=#__codelineno-23-2><span class=linenos data-linenos=" 2 "></span></a>    <span class=nd>@NonNull</span> <span class=n>Y</span> <span class=n>target</span><span class=p>,</span>
<a id=__codelineno-23-3 name=__codelineno-23-3></a><a href=#__codelineno-23-3><span class=linenos data-linenos=" 3 "></span></a>    <span class=nd>@Nullable</span> <span class=n>RequestListener</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=n>targetListener</span><span class=p>,</span>
<a id=__codelineno-23-4 name=__codelineno-23-4></a><a href=#__codelineno-23-4><span class=linenos data-linenos=" 4 "></span></a>    <span class=n>BaseRequestOptions</span><span class=o>&lt;?&gt;</span> <span class=n>options</span><span class=p>,</span>
<a id=__codelineno-23-5 name=__codelineno-23-5></a><a href=#__codelineno-23-5><span class=linenos data-linenos=" 5 "></span></a>    <span class=n>Executor</span> <span class=n>callbackExecutor</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-23-6 name=__codelineno-23-6></a><a href=#__codelineno-23-6><span class=linenos data-linenos=" 6 "></span></a>  <span class=c1>// sanity check</span>
<a id=__codelineno-23-7 name=__codelineno-23-7></a><a href=#__codelineno-23-7><span class=linenos data-linenos=" 7 "></span></a>  <span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>target</span><span class=p>);</span>
<a id=__codelineno-23-8 name=__codelineno-23-8></a><a href=#__codelineno-23-8><span class=linenos data-linenos=" 8 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>isModelSet</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-23-9 name=__codelineno-23-9></a><a href=#__codelineno-23-9><span class=linenos data-linenos=" 9 "></span></a>    <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&quot;You must call #load() before calling #into()&quot;</span><span class=p>);</span>
<a id=__codelineno-23-10 name=__codelineno-23-10></a><a href=#__codelineno-23-10><span class=linenos data-linenos="10 "></span></a>  <span class=p>}</span>
<a id=__codelineno-23-11 name=__codelineno-23-11></a><a href=#__codelineno-23-11><span class=linenos data-linenos="11 "></span></a>
<a id=__codelineno-23-12 name=__codelineno-23-12></a><a href=#__codelineno-23-12><span class=linenos data-linenos="12 "></span></a>  <span class=c1>// åˆ›å»ºäº†ä¸€ä¸ªSingleRequestï¼Œè§åé¢ï¸â›°ï¸â›°ï¸â›°ï¸</span>
<a id=__codelineno-23-13 name=__codelineno-23-13></a><a href=#__codelineno-23-13><span class=linenos data-linenos="13 "></span></a>  <span class=n>Request</span> <span class=n>request</span> <span class=o>=</span> <span class=n>buildRequest</span><span class=p>(</span><span class=n>target</span><span class=p>,</span> <span class=n>targetListener</span><span class=p>,</span> <span class=n>options</span><span class=p>,</span> <span class=n>callbackExecutor</span><span class=p>);</span>
<a id=__codelineno-23-14 name=__codelineno-23-14></a><a href=#__codelineno-23-14><span class=linenos data-linenos="14 "></span></a>
<a id=__codelineno-23-15 name=__codelineno-23-15></a><a href=#__codelineno-23-15><span class=linenos data-linenos="15 "></span></a>  <span class=c1>// è¿™é‡Œä¼šåˆ¤æ–­éœ€ä¸éœ€è¦é‡æ–°å¼€å§‹ä»»åŠ¡</span>
<a id=__codelineno-23-16 name=__codelineno-23-16></a><a href=#__codelineno-23-16><span class=linenos data-linenos="16 "></span></a>  <span class=c1>// å¦‚æœå½“å‰requestå’Œtargetä¸Šä¹‹å‰çš„request previousç›¸ç­‰</span>
<a id=__codelineno-23-17 name=__codelineno-23-17></a><a href=#__codelineno-23-17><span class=linenos data-linenos="17 "></span></a>  <span class=c1>// ä¸”è®¾ç½®äº†å¿½ç•¥å†…å­˜ç¼“å­˜æˆ–previousè¿˜æ²¡æœ‰å®Œæˆ</span>
<a id=__codelineno-23-18 name=__codelineno-23-18></a><a href=#__codelineno-23-18><span class=linenos data-linenos="18 "></span></a>  <span class=c1>// é‚£ä¹ˆä¼šè¿›å…¥ifåˆ†æ”¯ï¼Œæ— éœ€è¿›è¡Œä¸€äº›ç›¸å…³è®¾ç½®ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ä¼˜åŒ–</span>
<a id=__codelineno-23-19 name=__codelineno-23-19></a><a href=#__codelineno-23-19><span class=linenos data-linenos="19 "></span></a>  <span class=n>Request</span> <span class=n>previous</span> <span class=o>=</span> <span class=n>target</span><span class=p>.</span><span class=na>getRequest</span><span class=p>();</span>
<a id=__codelineno-23-20 name=__codelineno-23-20></a><a href=#__codelineno-23-20><span class=linenos data-linenos="20 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>request</span><span class=p>.</span><span class=na>isEquivalentTo</span><span class=p>(</span><span class=n>previous</span><span class=p>)</span>
<a id=__codelineno-23-21 name=__codelineno-23-21></a><a href=#__codelineno-23-21><span class=linenos data-linenos="21 "></span></a>      <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>isSkipMemoryCacheWithCompletePreviousRequest</span><span class=p>(</span><span class=n>options</span><span class=p>,</span> <span class=n>previous</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-23-22 name=__codelineno-23-22></a><a href=#__codelineno-23-22><span class=linenos data-linenos="22 "></span></a>    <span class=n>request</span><span class=p>.</span><span class=na>recycle</span><span class=p>();</span>
<a id=__codelineno-23-23 name=__codelineno-23-23></a><a href=#__codelineno-23-23><span class=linenos data-linenos="23 "></span></a>    <span class=c1>// If the request is completed, beginning again will ensure the result is re-delivered,</span>
<a id=__codelineno-23-24 name=__codelineno-23-24></a><a href=#__codelineno-23-24><span class=linenos data-linenos="24 "></span></a>    <span class=c1>// triggering RequestListeners and Targets. If the request is failed, beginning again will</span>
<a id=__codelineno-23-25 name=__codelineno-23-25></a><a href=#__codelineno-23-25><span class=linenos data-linenos="25 "></span></a>    <span class=c1>// restart the request, giving it another chance to complete. If the request is already</span>
<a id=__codelineno-23-26 name=__codelineno-23-26></a><a href=#__codelineno-23-26><span class=linenos data-linenos="26 "></span></a>    <span class=c1>// running, we can let it continue running without interruption.</span>
<a id=__codelineno-23-27 name=__codelineno-23-27></a><a href=#__codelineno-23-27><span class=linenos data-linenos="27 "></span></a>    <span class=c1>// å¦‚æœæ­£åœ¨è¿è¡Œï¼Œå°±ä¸ç®¡å®ƒï¼›å¦‚æœå·²ç»å¤±è´¥äº†ï¼Œå°±é‡æ–°å¼€å§‹</span>
<a id=__codelineno-23-28 name=__codelineno-23-28></a><a href=#__codelineno-23-28><span class=linenos data-linenos="28 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>previous</span><span class=p>).</span><span class=na>isRunning</span><span class=p>())</span> <span class=p>{</span>
<a id=__codelineno-23-29 name=__codelineno-23-29></a><a href=#__codelineno-23-29><span class=linenos data-linenos="29 "></span></a>      <span class=c1>// Use the previous request rather than the new one to allow for optimizations like skipping</span>
<a id=__codelineno-23-30 name=__codelineno-23-30></a><a href=#__codelineno-23-30><span class=linenos data-linenos="30 "></span></a>      <span class=c1>// setting placeholders, tracking and un-tracking Targets, and obtaining View dimensions</span>
<a id=__codelineno-23-31 name=__codelineno-23-31></a><a href=#__codelineno-23-31><span class=linenos data-linenos="31 "></span></a>      <span class=c1>// that are done in the individual Request.</span>
<a id=__codelineno-23-32 name=__codelineno-23-32></a><a href=#__codelineno-23-32><span class=linenos data-linenos="32 "></span></a>      <span class=n>previous</span><span class=p>.</span><span class=na>begin</span><span class=p>();</span>
<a id=__codelineno-23-33 name=__codelineno-23-33></a><a href=#__codelineno-23-33><span class=linenos data-linenos="33 "></span></a>    <span class=p>}</span>
<a id=__codelineno-23-34 name=__codelineno-23-34></a><a href=#__codelineno-23-34><span class=linenos data-linenos="34 "></span></a>    <span class=k>return</span> <span class=n>target</span><span class=p>;</span>
<a id=__codelineno-23-35 name=__codelineno-23-35></a><a href=#__codelineno-23-35><span class=linenos data-linenos="35 "></span></a>  <span class=p>}</span>
<a id=__codelineno-23-36 name=__codelineno-23-36></a><a href=#__codelineno-23-36><span class=linenos data-linenos="36 "></span></a>
<a id=__codelineno-23-37 name=__codelineno-23-37></a><a href=#__codelineno-23-37><span class=linenos data-linenos="37 "></span></a>  <span class=c1>// å¦‚æœä¸èƒ½å¤ç”¨previous</span>
<a id=__codelineno-23-38 name=__codelineno-23-38></a><a href=#__codelineno-23-38><span class=linenos data-linenos="38 "></span></a>  <span class=c1>// å…ˆæ¸…é™¤targetä¸Šä¹‹å‰çš„Request</span>
<a id=__codelineno-23-39 name=__codelineno-23-39></a><a href=#__codelineno-23-39><span class=linenos data-linenos="39 "></span></a>  <span class=n>requestManager</span><span class=p>.</span><span class=na>clear</span><span class=p>(</span><span class=n>target</span><span class=p>);</span>
<a id=__codelineno-23-40 name=__codelineno-23-40></a><a href=#__codelineno-23-40><span class=linenos data-linenos="40 "></span></a>  <span class=c1>// å°†Requestä½œä¸ºtagè®¾ç½®åˆ°viewä¸­</span>
<a id=__codelineno-23-41 name=__codelineno-23-41></a><a href=#__codelineno-23-41><span class=linenos data-linenos="41 "></span></a>  <span class=n>target</span><span class=p>.</span><span class=na>setRequest</span><span class=p>(</span><span class=n>request</span><span class=p>);</span>
<a id=__codelineno-23-42 name=__codelineno-23-42></a><a href=#__codelineno-23-42><span class=linenos data-linenos="42 "></span></a>  <span class=c1>// ğŸ˜·ğŸ˜·ğŸ˜· çœŸæ­£å¼€å§‹ç½‘ç»œå›¾ç‰‡çš„åŠ è½½</span>
<a id=__codelineno-23-43 name=__codelineno-23-43></a><a href=#__codelineno-23-43><span class=linenos data-linenos="43 "></span></a>  <span class=n>requestManager</span><span class=p>.</span><span class=na>track</span><span class=p>(</span><span class=n>target</span><span class=p>,</span> <span class=n>request</span><span class=p>);</span>
<a id=__codelineno-23-44 name=__codelineno-23-44></a><a href=#__codelineno-23-44><span class=linenos data-linenos="44 "></span></a>
<a id=__codelineno-23-45 name=__codelineno-23-45></a><a href=#__codelineno-23-45><span class=linenos data-linenos="45 "></span></a>  <span class=k>return</span> <span class=n>target</span><span class=p>;</span>
<a id=__codelineno-23-46 name=__codelineno-23-46></a><a href=#__codelineno-23-46><span class=linenos data-linenos="46 "></span></a><span class=p>}</span>
</code></pre></div> <h3 id=31-buildrequest>3.1 buildRequest<a class=headerlink href=#31-buildrequest title="Anchor link to this section for reference">&para;</a></h3> <p>â›°ï¸â›°ï¸â›°ï¸ è¿™é‡Œè·Ÿè¸ªä¸€ä¸‹<code>buildRequest</code>çš„æµç¨‹ï¼Œçœ‹çœ‹æ˜¯å¦‚ä½•åˆ›å»ºå‡º<code>SingleRequest</code>çš„ã€‚</p> <div class=highlight><pre><span></span><code><a id=__codelineno-24-1 name=__codelineno-24-1></a><a href=#__codelineno-24-1><span class=linenos data-linenos="  1 "></span></a><span class=kd>private</span> <span class=n>Request</span> <span class=nf>buildRequest</span><span class=p>(</span>
<a id=__codelineno-24-2 name=__codelineno-24-2></a><a href=#__codelineno-24-2><span class=linenos data-linenos="  2 "></span></a>    <span class=n>Target</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=n>target</span><span class=p>,</span>
<a id=__codelineno-24-3 name=__codelineno-24-3></a><a href=#__codelineno-24-3><span class=linenos data-linenos="  3 "></span></a>    <span class=nd>@Nullable</span> <span class=n>RequestListener</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=n>targetListener</span><span class=p>,</span>
<a id=__codelineno-24-4 name=__codelineno-24-4></a><a href=#__codelineno-24-4><span class=linenos data-linenos="  4 "></span></a>    <span class=n>BaseRequestOptions</span><span class=o>&lt;?&gt;</span> <span class=n>requestOptions</span><span class=p>,</span>
<a id=__codelineno-24-5 name=__codelineno-24-5></a><a href=#__codelineno-24-5><span class=linenos data-linenos="  5 "></span></a>    <span class=n>Executor</span> <span class=n>callbackExecutor</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-24-6 name=__codelineno-24-6></a><a href=#__codelineno-24-6><span class=linenos data-linenos="  6 "></span></a>  <span class=k>return</span> <span class=n>buildRequestRecursive</span><span class=p>(</span>
<a id=__codelineno-24-7 name=__codelineno-24-7></a><a href=#__codelineno-24-7><span class=linenos data-linenos="  7 "></span></a>      <span class=n>target</span><span class=p>,</span>
<a id=__codelineno-24-8 name=__codelineno-24-8></a><a href=#__codelineno-24-8><span class=linenos data-linenos="  8 "></span></a>      <span class=n>targetListener</span><span class=p>,</span>                       <span class=c1>// null</span>
<a id=__codelineno-24-9 name=__codelineno-24-9></a><a href=#__codelineno-24-9><span class=linenos data-linenos="  9 "></span></a>      <span class=cm>/*parentCoordinator=*/</span> <span class=kc>null</span><span class=p>,</span>
<a id=__codelineno-24-10 name=__codelineno-24-10></a><a href=#__codelineno-24-10><span class=linenos data-linenos=" 10 "></span></a>      <span class=n>transitionOptions</span><span class=p>,</span>
<a id=__codelineno-24-11 name=__codelineno-24-11></a><a href=#__codelineno-24-11><span class=linenos data-linenos=" 11 "></span></a>      <span class=n>requestOptions</span><span class=p>.</span><span class=na>getPriority</span><span class=p>(),</span>         <span class=c1>// Priority.NORMAL</span>
<a id=__codelineno-24-12 name=__codelineno-24-12></a><a href=#__codelineno-24-12><span class=linenos data-linenos=" 12 "></span></a>      <span class=n>requestOptions</span><span class=p>.</span><span class=na>getOverrideWidth</span><span class=p>(),</span>    <span class=c1>// UNSET</span>
<a id=__codelineno-24-13 name=__codelineno-24-13></a><a href=#__codelineno-24-13><span class=linenos data-linenos=" 13 "></span></a>      <span class=n>requestOptions</span><span class=p>.</span><span class=na>getOverrideHeight</span><span class=p>(),</span>   <span class=c1>// UNSET</span>
<a id=__codelineno-24-14 name=__codelineno-24-14></a><a href=#__codelineno-24-14><span class=linenos data-linenos=" 14 "></span></a>      <span class=n>requestOptions</span><span class=p>,</span>
<a id=__codelineno-24-15 name=__codelineno-24-15></a><a href=#__codelineno-24-15><span class=linenos data-linenos=" 15 "></span></a>      <span class=n>callbackExecutor</span><span class=p>);</span>                    <span class=c1>// Executors.mainThreadExecutor()</span>
<a id=__codelineno-24-16 name=__codelineno-24-16></a><a href=#__codelineno-24-16><span class=linenos data-linenos=" 16 "></span></a><span class=p>}</span>
<a id=__codelineno-24-17 name=__codelineno-24-17></a><a href=#__codelineno-24-17><span class=linenos data-linenos=" 17 "></span></a>
<a id=__codelineno-24-18 name=__codelineno-24-18></a><a href=#__codelineno-24-18><span class=linenos data-linenos=" 18 "></span></a><span class=kd>private</span> <span class=n>Request</span> <span class=nf>buildRequestRecursive</span><span class=p>(</span>
<a id=__codelineno-24-19 name=__codelineno-24-19></a><a href=#__codelineno-24-19><span class=linenos data-linenos=" 19 "></span></a>    <span class=n>Target</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=n>target</span><span class=p>,</span>
<a id=__codelineno-24-20 name=__codelineno-24-20></a><a href=#__codelineno-24-20><span class=linenos data-linenos=" 20 "></span></a>    <span class=nd>@Nullable</span> <span class=n>RequestListener</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=n>targetListener</span><span class=p>,</span>
<a id=__codelineno-24-21 name=__codelineno-24-21></a><a href=#__codelineno-24-21><span class=linenos data-linenos=" 21 "></span></a>    <span class=nd>@Nullable</span> <span class=n>RequestCoordinator</span> <span class=n>parentCoordinator</span><span class=p>,</span>
<a id=__codelineno-24-22 name=__codelineno-24-22></a><a href=#__codelineno-24-22><span class=linenos data-linenos=" 22 "></span></a>    <span class=n>TransitionOptions</span><span class=o>&lt;?</span><span class=p>,</span> <span class=o>?</span> <span class=kd>super</span> <span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=n>transitionOptions</span><span class=p>,</span>
<a id=__codelineno-24-23 name=__codelineno-24-23></a><a href=#__codelineno-24-23><span class=linenos data-linenos=" 23 "></span></a>    <span class=n>Priority</span> <span class=n>priority</span><span class=p>,</span>
<a id=__codelineno-24-24 name=__codelineno-24-24></a><a href=#__codelineno-24-24><span class=linenos data-linenos=" 24 "></span></a>    <span class=kt>int</span> <span class=n>overrideWidth</span><span class=p>,</span>
<a id=__codelineno-24-25 name=__codelineno-24-25></a><a href=#__codelineno-24-25><span class=linenos data-linenos=" 25 "></span></a>    <span class=kt>int</span> <span class=n>overrideHeight</span><span class=p>,</span>
<a id=__codelineno-24-26 name=__codelineno-24-26></a><a href=#__codelineno-24-26><span class=linenos data-linenos=" 26 "></span></a>    <span class=n>BaseRequestOptions</span><span class=o>&lt;?&gt;</span> <span class=n>requestOptions</span><span class=p>,</span>
<a id=__codelineno-24-27 name=__codelineno-24-27></a><a href=#__codelineno-24-27><span class=linenos data-linenos=" 27 "></span></a>    <span class=n>Executor</span> <span class=n>callbackExecutor</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-24-28 name=__codelineno-24-28></a><a href=#__codelineno-24-28><span class=linenos data-linenos=" 28 "></span></a>
<a id=__codelineno-24-29 name=__codelineno-24-29></a><a href=#__codelineno-24-29><span class=linenos data-linenos=" 29 "></span></a>  <span class=c1>// Build the ErrorRequestCoordinator first if necessary so we can update parentCoordinator.</span>
<a id=__codelineno-24-30 name=__codelineno-24-30></a><a href=#__codelineno-24-30><span class=linenos data-linenos=" 30 "></span></a>  <span class=n>ErrorRequestCoordinator</span> <span class=n>errorRequestCoordinator</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-24-31 name=__codelineno-24-31></a><a href=#__codelineno-24-31><span class=linenos data-linenos=" 31 "></span></a>  <span class=c1>// errorBuilderä¸ºnull, skip</span>
<a id=__codelineno-24-32 name=__codelineno-24-32></a><a href=#__codelineno-24-32><span class=linenos data-linenos=" 32 "></span></a>  <span class=c1>// å› æ­¤errorRequestCoordinatorä¸ºnull</span>
<a id=__codelineno-24-33 name=__codelineno-24-33></a><a href=#__codelineno-24-33><span class=linenos data-linenos=" 33 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>errorBuilder</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-24-34 name=__codelineno-24-34></a><a href=#__codelineno-24-34><span class=linenos data-linenos=" 34 "></span></a>    <span class=n>errorRequestCoordinator</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ErrorRequestCoordinator</span><span class=p>(</span><span class=n>parentCoordinator</span><span class=p>);</span>
<a id=__codelineno-24-35 name=__codelineno-24-35></a><a href=#__codelineno-24-35><span class=linenos data-linenos=" 35 "></span></a>    <span class=n>parentCoordinator</span> <span class=o>=</span> <span class=n>errorRequestCoordinator</span><span class=p>;</span>
<a id=__codelineno-24-36 name=__codelineno-24-36></a><a href=#__codelineno-24-36><span class=linenos data-linenos=" 36 "></span></a>  <span class=p>}</span>
<a id=__codelineno-24-37 name=__codelineno-24-37></a><a href=#__codelineno-24-37><span class=linenos data-linenos=" 37 "></span></a>
<a id=__codelineno-24-38 name=__codelineno-24-38></a><a href=#__codelineno-24-38><span class=linenos data-linenos=" 38 "></span></a>  <span class=c1>// å¦‚ä½•è·å¾—SingleRequest</span>
<a id=__codelineno-24-39 name=__codelineno-24-39></a><a href=#__codelineno-24-39><span class=linenos data-linenos=" 39 "></span></a>  <span class=n>Request</span> <span class=n>mainRequest</span> <span class=o>=</span>
<a id=__codelineno-24-40 name=__codelineno-24-40></a><a href=#__codelineno-24-40><span class=linenos data-linenos=" 40 "></span></a>      <span class=n>buildThumbnailRequestRecursive</span><span class=p>(</span>
<a id=__codelineno-24-41 name=__codelineno-24-41></a><a href=#__codelineno-24-41><span class=linenos data-linenos=" 41 "></span></a>          <span class=n>target</span><span class=p>,</span>
<a id=__codelineno-24-42 name=__codelineno-24-42></a><a href=#__codelineno-24-42><span class=linenos data-linenos=" 42 "></span></a>          <span class=n>targetListener</span><span class=p>,</span>       <span class=c1>// null</span>
<a id=__codelineno-24-43 name=__codelineno-24-43></a><a href=#__codelineno-24-43><span class=linenos data-linenos=" 43 "></span></a>          <span class=n>parentCoordinator</span><span class=p>,</span>    <span class=c1>// null</span>
<a id=__codelineno-24-44 name=__codelineno-24-44></a><a href=#__codelineno-24-44><span class=linenos data-linenos=" 44 "></span></a>          <span class=n>transitionOptions</span><span class=p>,</span>
<a id=__codelineno-24-45 name=__codelineno-24-45></a><a href=#__codelineno-24-45><span class=linenos data-linenos=" 45 "></span></a>          <span class=n>priority</span><span class=p>,</span>
<a id=__codelineno-24-46 name=__codelineno-24-46></a><a href=#__codelineno-24-46><span class=linenos data-linenos=" 46 "></span></a>          <span class=n>overrideWidth</span><span class=p>,</span>
<a id=__codelineno-24-47 name=__codelineno-24-47></a><a href=#__codelineno-24-47><span class=linenos data-linenos=" 47 "></span></a>          <span class=n>overrideHeight</span><span class=p>,</span>
<a id=__codelineno-24-48 name=__codelineno-24-48></a><a href=#__codelineno-24-48><span class=linenos data-linenos=" 48 "></span></a>          <span class=n>requestOptions</span><span class=p>,</span>
<a id=__codelineno-24-49 name=__codelineno-24-49></a><a href=#__codelineno-24-49><span class=linenos data-linenos=" 49 "></span></a>          <span class=n>callbackExecutor</span><span class=p>);</span>
<a id=__codelineno-24-50 name=__codelineno-24-50></a><a href=#__codelineno-24-50><span class=linenos data-linenos=" 50 "></span></a>
<a id=__codelineno-24-51 name=__codelineno-24-51></a><a href=#__codelineno-24-51><span class=linenos data-linenos=" 51 "></span></a>  <span class=c1>// errorRequestCoordinatorä¸ºnull</span>
<a id=__codelineno-24-52 name=__codelineno-24-52></a><a href=#__codelineno-24-52><span class=linenos data-linenos=" 52 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>errorRequestCoordinator</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-24-53 name=__codelineno-24-53></a><a href=#__codelineno-24-53><span class=linenos data-linenos=" 53 "></span></a>    <span class=k>return</span> <span class=n>mainRequest</span><span class=p>;</span>
<a id=__codelineno-24-54 name=__codelineno-24-54></a><a href=#__codelineno-24-54><span class=linenos data-linenos=" 54 "></span></a>  <span class=p>}</span>
<a id=__codelineno-24-55 name=__codelineno-24-55></a><a href=#__codelineno-24-55><span class=linenos data-linenos=" 55 "></span></a>  <span class=p>...</span>
<a id=__codelineno-24-56 name=__codelineno-24-56></a><a href=#__codelineno-24-56><span class=linenos data-linenos=" 56 "></span></a><span class=p>}</span>
<a id=__codelineno-24-57 name=__codelineno-24-57></a><a href=#__codelineno-24-57><span class=linenos data-linenos=" 57 "></span></a>
<a id=__codelineno-24-58 name=__codelineno-24-58></a><a href=#__codelineno-24-58><span class=linenos data-linenos=" 58 "></span></a><span class=kd>private</span> <span class=n>Request</span> <span class=nf>buildThumbnailRequestRecursive</span><span class=p>(</span>
<a id=__codelineno-24-59 name=__codelineno-24-59></a><a href=#__codelineno-24-59><span class=linenos data-linenos=" 59 "></span></a>    <span class=n>Target</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=n>target</span><span class=p>,</span>
<a id=__codelineno-24-60 name=__codelineno-24-60></a><a href=#__codelineno-24-60><span class=linenos data-linenos=" 60 "></span></a>    <span class=n>RequestListener</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=n>targetListener</span><span class=p>,</span>
<a id=__codelineno-24-61 name=__codelineno-24-61></a><a href=#__codelineno-24-61><span class=linenos data-linenos=" 61 "></span></a>    <span class=nd>@Nullable</span> <span class=n>RequestCoordinator</span> <span class=n>parentCoordinator</span><span class=p>,</span>
<a id=__codelineno-24-62 name=__codelineno-24-62></a><a href=#__codelineno-24-62><span class=linenos data-linenos=" 62 "></span></a>    <span class=n>TransitionOptions</span><span class=o>&lt;?</span><span class=p>,</span> <span class=o>?</span> <span class=kd>super</span> <span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=n>transitionOptions</span><span class=p>,</span>
<a id=__codelineno-24-63 name=__codelineno-24-63></a><a href=#__codelineno-24-63><span class=linenos data-linenos=" 63 "></span></a>    <span class=n>Priority</span> <span class=n>priority</span><span class=p>,</span>
<a id=__codelineno-24-64 name=__codelineno-24-64></a><a href=#__codelineno-24-64><span class=linenos data-linenos=" 64 "></span></a>    <span class=kt>int</span> <span class=n>overrideWidth</span><span class=p>,</span>
<a id=__codelineno-24-65 name=__codelineno-24-65></a><a href=#__codelineno-24-65><span class=linenos data-linenos=" 65 "></span></a>    <span class=kt>int</span> <span class=n>overrideHeight</span><span class=p>,</span>
<a id=__codelineno-24-66 name=__codelineno-24-66></a><a href=#__codelineno-24-66><span class=linenos data-linenos=" 66 "></span></a>    <span class=n>BaseRequestOptions</span><span class=o>&lt;?&gt;</span> <span class=n>requestOptions</span><span class=p>,</span>
<a id=__codelineno-24-67 name=__codelineno-24-67></a><a href=#__codelineno-24-67><span class=linenos data-linenos=" 67 "></span></a>    <span class=n>Executor</span> <span class=n>callbackExecutor</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-24-68 name=__codelineno-24-68></a><a href=#__codelineno-24-68><span class=linenos data-linenos=" 68 "></span></a>  <span class=c1>// thumbnailé‡è½½æ–¹æ³•æ²¡æœ‰è°ƒç”¨è¿‡ï¼Œæ‰€ä»¥ä¼šèµ°æœ€åçš„else case</span>
<a id=__codelineno-24-69 name=__codelineno-24-69></a><a href=#__codelineno-24-69><span class=linenos data-linenos=" 69 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>thumbnailBuilder</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-24-70 name=__codelineno-24-70></a><a href=#__codelineno-24-70><span class=linenos data-linenos=" 70 "></span></a>    <span class=p>...</span>
<a id=__codelineno-24-71 name=__codelineno-24-71></a><a href=#__codelineno-24-71><span class=linenos data-linenos=" 71 "></span></a>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>thumbSizeMultiplier</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-24-72 name=__codelineno-24-72></a><a href=#__codelineno-24-72><span class=linenos data-linenos=" 72 "></span></a>    <span class=p>...</span>
<a id=__codelineno-24-73 name=__codelineno-24-73></a><a href=#__codelineno-24-73><span class=linenos data-linenos=" 73 "></span></a>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
<a id=__codelineno-24-74 name=__codelineno-24-74></a><a href=#__codelineno-24-74><span class=linenos data-linenos=" 74 "></span></a>    <span class=c1>// Base case: no thumbnail.</span>
<a id=__codelineno-24-75 name=__codelineno-24-75></a><a href=#__codelineno-24-75><span class=linenos data-linenos=" 75 "></span></a>    <span class=k>return</span> <span class=n>obtainRequest</span><span class=p>(</span>
<a id=__codelineno-24-76 name=__codelineno-24-76></a><a href=#__codelineno-24-76><span class=linenos data-linenos=" 76 "></span></a>        <span class=n>target</span><span class=p>,</span>
<a id=__codelineno-24-77 name=__codelineno-24-77></a><a href=#__codelineno-24-77><span class=linenos data-linenos=" 77 "></span></a>        <span class=n>targetListener</span><span class=p>,</span>
<a id=__codelineno-24-78 name=__codelineno-24-78></a><a href=#__codelineno-24-78><span class=linenos data-linenos=" 78 "></span></a>        <span class=n>requestOptions</span><span class=p>,</span>
<a id=__codelineno-24-79 name=__codelineno-24-79></a><a href=#__codelineno-24-79><span class=linenos data-linenos=" 79 "></span></a>        <span class=n>parentCoordinator</span><span class=p>,</span>
<a id=__codelineno-24-80 name=__codelineno-24-80></a><a href=#__codelineno-24-80><span class=linenos data-linenos=" 80 "></span></a>        <span class=n>transitionOptions</span><span class=p>,</span>
<a id=__codelineno-24-81 name=__codelineno-24-81></a><a href=#__codelineno-24-81><span class=linenos data-linenos=" 81 "></span></a>        <span class=n>priority</span><span class=p>,</span>
<a id=__codelineno-24-82 name=__codelineno-24-82></a><a href=#__codelineno-24-82><span class=linenos data-linenos=" 82 "></span></a>        <span class=n>overrideWidth</span><span class=p>,</span>
<a id=__codelineno-24-83 name=__codelineno-24-83></a><a href=#__codelineno-24-83><span class=linenos data-linenos=" 83 "></span></a>        <span class=n>overrideHeight</span><span class=p>,</span>
<a id=__codelineno-24-84 name=__codelineno-24-84></a><a href=#__codelineno-24-84><span class=linenos data-linenos=" 84 "></span></a>        <span class=n>callbackExecutor</span><span class=p>);</span>
<a id=__codelineno-24-85 name=__codelineno-24-85></a><a href=#__codelineno-24-85><span class=linenos data-linenos=" 85 "></span></a>  <span class=p>}</span>
<a id=__codelineno-24-86 name=__codelineno-24-86></a><a href=#__codelineno-24-86><span class=linenos data-linenos=" 86 "></span></a><span class=p>}</span>
<a id=__codelineno-24-87 name=__codelineno-24-87></a><a href=#__codelineno-24-87><span class=linenos data-linenos=" 87 "></span></a>
<a id=__codelineno-24-88 name=__codelineno-24-88></a><a href=#__codelineno-24-88><span class=linenos data-linenos=" 88 "></span></a><span class=kd>private</span> <span class=n>Request</span> <span class=nf>obtainRequest</span><span class=p>(</span>
<a id=__codelineno-24-89 name=__codelineno-24-89></a><a href=#__codelineno-24-89><span class=linenos data-linenos=" 89 "></span></a>    <span class=n>Target</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=n>target</span><span class=p>,</span>
<a id=__codelineno-24-90 name=__codelineno-24-90></a><a href=#__codelineno-24-90><span class=linenos data-linenos=" 90 "></span></a>    <span class=n>RequestListener</span><span class=o>&lt;</span><span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=n>targetListener</span><span class=p>,</span>
<a id=__codelineno-24-91 name=__codelineno-24-91></a><a href=#__codelineno-24-91><span class=linenos data-linenos=" 91 "></span></a>    <span class=n>BaseRequestOptions</span><span class=o>&lt;?&gt;</span> <span class=n>requestOptions</span><span class=p>,</span>
<a id=__codelineno-24-92 name=__codelineno-24-92></a><a href=#__codelineno-24-92><span class=linenos data-linenos=" 92 "></span></a>    <span class=n>RequestCoordinator</span> <span class=n>requestCoordinator</span><span class=p>,</span>
<a id=__codelineno-24-93 name=__codelineno-24-93></a><a href=#__codelineno-24-93><span class=linenos data-linenos=" 93 "></span></a>    <span class=n>TransitionOptions</span><span class=o>&lt;?</span><span class=p>,</span> <span class=o>?</span> <span class=kd>super</span> <span class=n>TranscodeType</span><span class=o>&gt;</span> <span class=n>transitionOptions</span><span class=p>,</span>
<a id=__codelineno-24-94 name=__codelineno-24-94></a><a href=#__codelineno-24-94><span class=linenos data-linenos=" 94 "></span></a>    <span class=n>Priority</span> <span class=n>priority</span><span class=p>,</span>
<a id=__codelineno-24-95 name=__codelineno-24-95></a><a href=#__codelineno-24-95><span class=linenos data-linenos=" 95 "></span></a>    <span class=kt>int</span> <span class=n>overrideWidth</span><span class=p>,</span>
<a id=__codelineno-24-96 name=__codelineno-24-96></a><a href=#__codelineno-24-96><span class=linenos data-linenos=" 96 "></span></a>    <span class=kt>int</span> <span class=n>overrideHeight</span><span class=p>,</span>
<a id=__codelineno-24-97 name=__codelineno-24-97></a><a href=#__codelineno-24-97><span class=linenos data-linenos=" 97 "></span></a>    <span class=n>Executor</span> <span class=n>callbackExecutor</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-24-98 name=__codelineno-24-98></a><a href=#__codelineno-24-98><span class=linenos data-linenos=" 98 "></span></a>  <span class=k>return</span> <span class=n>SingleRequest</span><span class=p>.</span><span class=na>obtain</span><span class=p>(</span>
<a id=__codelineno-24-99 name=__codelineno-24-99></a><a href=#__codelineno-24-99><span class=linenos data-linenos=" 99 "></span></a>      <span class=n>context</span><span class=p>,</span>
<a id=__codelineno-24-100 name=__codelineno-24-100></a><a href=#__codelineno-24-100><span class=linenos data-linenos="100 "></span></a>      <span class=n>glideContext</span><span class=p>,</span>
<a id=__codelineno-24-101 name=__codelineno-24-101></a><a href=#__codelineno-24-101><span class=linenos data-linenos="101 "></span></a>      <span class=n>model</span><span class=p>,</span>
<a id=__codelineno-24-102 name=__codelineno-24-102></a><a href=#__codelineno-24-102><span class=linenos data-linenos="102 "></span></a>      <span class=n>transcodeClass</span><span class=p>,</span>
<a id=__codelineno-24-103 name=__codelineno-24-103></a><a href=#__codelineno-24-103><span class=linenos data-linenos="103 "></span></a>      <span class=n>requestOptions</span><span class=p>,</span>
<a id=__codelineno-24-104 name=__codelineno-24-104></a><a href=#__codelineno-24-104><span class=linenos data-linenos="104 "></span></a>      <span class=n>overrideWidth</span><span class=p>,</span>
<a id=__codelineno-24-105 name=__codelineno-24-105></a><a href=#__codelineno-24-105><span class=linenos data-linenos="105 "></span></a>      <span class=n>overrideHeight</span><span class=p>,</span>
<a id=__codelineno-24-106 name=__codelineno-24-106></a><a href=#__codelineno-24-106><span class=linenos data-linenos="106 "></span></a>      <span class=n>priority</span><span class=p>,</span>
<a id=__codelineno-24-107 name=__codelineno-24-107></a><a href=#__codelineno-24-107><span class=linenos data-linenos="107 "></span></a>      <span class=n>target</span><span class=p>,</span>
<a id=__codelineno-24-108 name=__codelineno-24-108></a><a href=#__codelineno-24-108><span class=linenos data-linenos="108 "></span></a>      <span class=n>targetListener</span><span class=p>,</span>
<a id=__codelineno-24-109 name=__codelineno-24-109></a><a href=#__codelineno-24-109><span class=linenos data-linenos="109 "></span></a>      <span class=n>requestListeners</span><span class=p>,</span>
<a id=__codelineno-24-110 name=__codelineno-24-110></a><a href=#__codelineno-24-110><span class=linenos data-linenos="110 "></span></a>      <span class=n>requestCoordinator</span><span class=p>,</span>
<a id=__codelineno-24-111 name=__codelineno-24-111></a><a href=#__codelineno-24-111><span class=linenos data-linenos="111 "></span></a>      <span class=n>glideContext</span><span class=p>.</span><span class=na>getEngine</span><span class=p>(),</span>
<a id=__codelineno-24-112 name=__codelineno-24-112></a><a href=#__codelineno-24-112><span class=linenos data-linenos="112 "></span></a>      <span class=n>transitionOptions</span><span class=p>.</span><span class=na>getTransitionFactory</span><span class=p>(),</span>
<a id=__codelineno-24-113 name=__codelineno-24-113></a><a href=#__codelineno-24-113><span class=linenos data-linenos="113 "></span></a>      <span class=n>callbackExecutor</span><span class=p>);</span>
<a id=__codelineno-24-114 name=__codelineno-24-114></a><a href=#__codelineno-24-114><span class=linenos data-linenos="114 "></span></a><span class=p>}</span>
</code></pre></div> <p><code>SingleRequest</code>çš„åˆå§‹çŠ¶æ€ä¸º<code>Status.PENDING</code>ã€‚</p> <h3 id=32-requestmanagertrack>3.2 RequestManager.track<a class=headerlink href=#32-requestmanagertrack title="Anchor link to this section for reference">&para;</a></h3> <p>ğŸ˜·ğŸ˜·ğŸ˜·ä¸‹é¢å¼€å§‹åˆ†æ<code>RequestManager.track</code>çš„æµç¨‹</p> <div class=highlight><pre><span></span><code><a id=__codelineno-25-1 name=__codelineno-25-1></a><a href=#__codelineno-25-1><span class=linenos data-linenos="1 "></span></a><span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>track</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Target</span><span class=o>&lt;?&gt;</span> <span class=n>target</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Request</span> <span class=n>request</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-25-2 name=__codelineno-25-2></a><a href=#__codelineno-25-2><span class=linenos data-linenos="2 "></span></a>  <span class=n>targetTracker</span><span class=p>.</span><span class=na>track</span><span class=p>(</span><span class=n>target</span><span class=p>);</span>
<a id=__codelineno-25-3 name=__codelineno-25-3></a><a href=#__codelineno-25-3><span class=linenos data-linenos="3 "></span></a>  <span class=n>requestTracker</span><span class=p>.</span><span class=na>runRequest</span><span class=p>(</span><span class=n>request</span><span class=p>);</span>
<a id=__codelineno-25-4 name=__codelineno-25-4></a><a href=#__codelineno-25-4><span class=linenos data-linenos="4 "></span></a><span class=p>}</span>
</code></pre></div> <p>åœ¨è¿™é‡Œé¢ï¼Œ<code>targetTracker</code>æˆå‘˜å˜é‡åœ¨å£°æ˜çš„æ—¶å€™ç›´æ¥åˆå§‹åŒ–ä¸º<code>TargetTracker</code>ç±»çš„æ— å‚æ•°å®ä¾‹ï¼Œè¯¥ç±»çš„ä½œç”¨æ˜¯ä¿å­˜æ‰€æœ‰çš„Targetå¹¶å‘å®ƒä»¬è½¬å‘ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼›<code>requestTracker</code>åœ¨<code>RequestManager</code>çš„æ„é€ å™¨ä¸­ä¼ å…¥äº†<code>new RequestTracker()</code>ï¼Œè¯¥ç±»çš„ä½œç”¨ç®¡ç†æ‰€æœ‰çŠ¶æ€çš„è¯·æ±‚ã€‚</p> <p><code>targetTracker.track(target)</code>å°†targetä¿å­˜åˆ°äº†å†…éƒ¨çš„<code>targets</code>ä¸­ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-26-1 name=__codelineno-26-1></a><a href=#__codelineno-26-1><span class=linenos data-linenos="1 "></span></a><span class=kd>private</span> <span class=kd>final</span> <span class=n>Set</span><span class=o>&lt;</span><span class=n>Target</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>targets</span> <span class=o>=</span>
<a id=__codelineno-26-2 name=__codelineno-26-2></a><a href=#__codelineno-26-2><span class=linenos data-linenos="2 "></span></a>    <span class=n>Collections</span><span class=p>.</span><span class=na>newSetFromMap</span><span class=p>(</span><span class=k>new</span> <span class=n>WeakHashMap</span><span class=o>&lt;</span><span class=n>Target</span><span class=o>&lt;?&gt;</span><span class=p>,</span> <span class=n>Boolean</span><span class=o>&gt;</span><span class=p>());</span>
<a id=__codelineno-26-3 name=__codelineno-26-3></a><a href=#__codelineno-26-3><span class=linenos data-linenos="3 "></span></a>
<a id=__codelineno-26-4 name=__codelineno-26-4></a><a href=#__codelineno-26-4><span class=linenos data-linenos="4 "></span></a><span class=kd>public</span> <span class=kt>void</span> <span class=nf>track</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Target</span><span class=o>&lt;?&gt;</span> <span class=n>target</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-26-5 name=__codelineno-26-5></a><a href=#__codelineno-26-5><span class=linenos data-linenos="5 "></span></a>  <span class=n>targets</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>target</span><span class=p>);</span>
<a id=__codelineno-26-6 name=__codelineno-26-6></a><a href=#__codelineno-26-6><span class=linenos data-linenos="6 "></span></a><span class=p>}</span>
</code></pre></div> <p>ä¸‹é¢çœ‹çœ‹<code>requestTracker.runRequest(request)</code>å¹²äº†ä»€ä¹ˆï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-27-1 name=__codelineno-27-1></a><a href=#__codelineno-27-1><span class=linenos data-linenos=" 1 "></span></a><span class=cm>/**</span>
<a id=__codelineno-27-2 name=__codelineno-27-2></a><a href=#__codelineno-27-2><span class=linenos data-linenos=" 2 "></span></a><span class=cm>  * Starts tracking the given request.</span>
<a id=__codelineno-27-3 name=__codelineno-27-3></a><a href=#__codelineno-27-3><span class=linenos data-linenos=" 3 "></span></a><span class=cm>  */</span>
<a id=__codelineno-27-4 name=__codelineno-27-4></a><a href=#__codelineno-27-4><span class=linenos data-linenos=" 4 "></span></a><span class=kd>public</span> <span class=kt>void</span> <span class=nf>runRequest</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Request</span> <span class=n>request</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-27-5 name=__codelineno-27-5></a><a href=#__codelineno-27-5><span class=linenos data-linenos=" 5 "></span></a>  <span class=n>requests</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>request</span><span class=p>);</span>
<a id=__codelineno-27-6 name=__codelineno-27-6></a><a href=#__codelineno-27-6><span class=linenos data-linenos=" 6 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>isPaused</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-27-7 name=__codelineno-27-7></a><a href=#__codelineno-27-7><span class=linenos data-linenos=" 7 "></span></a>    <span class=n>request</span><span class=p>.</span><span class=na>begin</span><span class=p>();</span>
<a id=__codelineno-27-8 name=__codelineno-27-8></a><a href=#__codelineno-27-8><span class=linenos data-linenos=" 8 "></span></a>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
<a id=__codelineno-27-9 name=__codelineno-27-9></a><a href=#__codelineno-27-9><span class=linenos data-linenos=" 9 "></span></a>    <span class=n>request</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span>
<a id=__codelineno-27-10 name=__codelineno-27-10></a><a href=#__codelineno-27-10><span class=linenos data-linenos="10 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>Log</span><span class=p>.</span><span class=na>isLoggable</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=n>Log</span><span class=p>.</span><span class=na>VERBOSE</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-27-11 name=__codelineno-27-11></a><a href=#__codelineno-27-11><span class=linenos data-linenos="11 "></span></a>      <span class=n>Log</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s>&quot;Paused, delaying request&quot;</span><span class=p>);</span>
<a id=__codelineno-27-12 name=__codelineno-27-12></a><a href=#__codelineno-27-12><span class=linenos data-linenos="12 "></span></a>    <span class=p>}</span>
<a id=__codelineno-27-13 name=__codelineno-27-13></a><a href=#__codelineno-27-13><span class=linenos data-linenos="13 "></span></a>    <span class=n>pendingRequests</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>request</span><span class=p>);</span>
<a id=__codelineno-27-14 name=__codelineno-27-14></a><a href=#__codelineno-27-14><span class=linenos data-linenos="14 "></span></a>  <span class=p>}</span>
<a id=__codelineno-27-15 name=__codelineno-27-15></a><a href=#__codelineno-27-15><span class=linenos data-linenos="15 "></span></a><span class=p>}</span>
</code></pre></div> <p><code>isPaused</code>é»˜è®¤ä¸ºfalseï¼Œåªæœ‰è°ƒç”¨äº†<code>RequestTracker.pauseRequests</code>æˆ–<code>RequestTracker.pauseAllRequests</code>åæ‰ä¼šä¸ºtrueã€‚<br> å› æ­¤ï¼Œä¸‹é¢ä¼šæ‰§è¡Œ<code>request.begin()</code>æ–¹æ³•ã€‚ä¸Šé¢è¯´åˆ°è¿‡ï¼Œè¿™é‡Œçš„requestå®é™…ä¸Šæ˜¯<code>SingleRequest</code>å¯¹è±¡ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹å®ƒçš„<code>begin()</code>æ–¹æ³•ã€‚</p> <div class=highlight><pre><span></span><code><a id=__codelineno-28-1 name=__codelineno-28-1></a><a href=#__codelineno-28-1><span class=linenos data-linenos=" 1 "></span></a><span class=nd>@Override</span>
<a id=__codelineno-28-2 name=__codelineno-28-2></a><a href=#__codelineno-28-2><span class=linenos data-linenos=" 2 "></span></a><span class=kd>public</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>begin</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-28-3 name=__codelineno-28-3></a><a href=#__codelineno-28-3><span class=linenos data-linenos=" 3 "></span></a>  <span class=c1>// sanity check</span>
<a id=__codelineno-28-4 name=__codelineno-28-4></a><a href=#__codelineno-28-4><span class=linenos data-linenos=" 4 "></span></a>  <span class=n>assertNotCallingCallbacks</span><span class=p>();</span>
<a id=__codelineno-28-5 name=__codelineno-28-5></a><a href=#__codelineno-28-5><span class=linenos data-linenos=" 5 "></span></a>  <span class=n>stateVerifier</span><span class=p>.</span><span class=na>throwIfRecycled</span><span class=p>();</span>
<a id=__codelineno-28-6 name=__codelineno-28-6></a><a href=#__codelineno-28-6><span class=linenos data-linenos=" 6 "></span></a>  <span class=n>startTime</span> <span class=o>=</span> <span class=n>LogTime</span><span class=p>.</span><span class=na>getLogTime</span><span class=p>();</span>
<a id=__codelineno-28-7 name=__codelineno-28-7></a><a href=#__codelineno-28-7><span class=linenos data-linenos=" 7 "></span></a>  <span class=c1>// å¦‚æœmodelä¸ºç©ºï¼Œä¼šè°ƒç”¨ç›‘å¬å™¨çš„onLoadFailedå¤„ç†</span>
<a id=__codelineno-28-8 name=__codelineno-28-8></a><a href=#__codelineno-28-8><span class=linenos data-linenos=" 8 "></span></a>  <span class=c1>// è‹¥æ— æ³•å¤„ç†ï¼Œåˆ™å±•ç¤ºå¤±è´¥æ—¶çš„å ä½å›¾</span>
<a id=__codelineno-28-9 name=__codelineno-28-9></a><a href=#__codelineno-28-9><span class=linenos data-linenos=" 9 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>model</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-28-10 name=__codelineno-28-10></a><a href=#__codelineno-28-10><span class=linenos data-linenos="10 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>Util</span><span class=p>.</span><span class=na>isValidDimensions</span><span class=p>(</span><span class=n>overrideWidth</span><span class=p>,</span> <span class=n>overrideHeight</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-28-11 name=__codelineno-28-11></a><a href=#__codelineno-28-11><span class=linenos data-linenos="11 "></span></a>      <span class=n>width</span> <span class=o>=</span> <span class=n>overrideWidth</span><span class=p>;</span>
<a id=__codelineno-28-12 name=__codelineno-28-12></a><a href=#__codelineno-28-12><span class=linenos data-linenos="12 "></span></a>      <span class=n>height</span> <span class=o>=</span> <span class=n>overrideHeight</span><span class=p>;</span>
<a id=__codelineno-28-13 name=__codelineno-28-13></a><a href=#__codelineno-28-13><span class=linenos data-linenos="13 "></span></a>    <span class=p>}</span>
<a id=__codelineno-28-14 name=__codelineno-28-14></a><a href=#__codelineno-28-14><span class=linenos data-linenos="14 "></span></a>    <span class=c1>// Only log at more verbose log levels if the user has set a fallback drawable, because</span>
<a id=__codelineno-28-15 name=__codelineno-28-15></a><a href=#__codelineno-28-15><span class=linenos data-linenos="15 "></span></a>    <span class=c1>// fallback Drawables indicate the user expects null models occasionally.</span>
<a id=__codelineno-28-16 name=__codelineno-28-16></a><a href=#__codelineno-28-16><span class=linenos data-linenos="16 "></span></a>    <span class=kt>int</span> <span class=n>logLevel</span> <span class=o>=</span> <span class=n>getFallbackDrawable</span><span class=p>()</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>?</span> <span class=n>Log</span><span class=p>.</span><span class=na>WARN</span> <span class=p>:</span> <span class=n>Log</span><span class=p>.</span><span class=na>DEBUG</span><span class=p>;</span>
<a id=__codelineno-28-17 name=__codelineno-28-17></a><a href=#__codelineno-28-17><span class=linenos data-linenos="17 "></span></a>    <span class=n>onLoadFailed</span><span class=p>(</span><span class=k>new</span> <span class=n>GlideException</span><span class=p>(</span><span class=s>&quot;Received null model&quot;</span><span class=p>),</span> <span class=n>logLevel</span><span class=p>);</span>
<a id=__codelineno-28-18 name=__codelineno-28-18></a><a href=#__codelineno-28-18><span class=linenos data-linenos="18 "></span></a>    <span class=k>return</span><span class=p>;</span>
<a id=__codelineno-28-19 name=__codelineno-28-19></a><a href=#__codelineno-28-19><span class=linenos data-linenos="19 "></span></a>  <span class=p>}</span>
<a id=__codelineno-28-20 name=__codelineno-28-20></a><a href=#__codelineno-28-20><span class=linenos data-linenos="20 "></span></a>
<a id=__codelineno-28-21 name=__codelineno-28-21></a><a href=#__codelineno-28-21><span class=linenos data-linenos="21 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>status</span> <span class=o>==</span> <span class=n>Status</span><span class=p>.</span><span class=na>RUNNING</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-28-22 name=__codelineno-28-22></a><a href=#__codelineno-28-22><span class=linenos data-linenos="22 "></span></a>    <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&quot;Cannot restart a running request&quot;</span><span class=p>);</span>
<a id=__codelineno-28-23 name=__codelineno-28-23></a><a href=#__codelineno-28-23><span class=linenos data-linenos="23 "></span></a>  <span class=p>}</span>
<a id=__codelineno-28-24 name=__codelineno-28-24></a><a href=#__codelineno-28-24><span class=linenos data-linenos="24 "></span></a>
<a id=__codelineno-28-25 name=__codelineno-28-25></a><a href=#__codelineno-28-25><span class=linenos data-linenos="25 "></span></a>  <span class=c1>// If we&#39;re restarted after we&#39;re complete (usually via something like a notifyDataSetChanged</span>
<a id=__codelineno-28-26 name=__codelineno-28-26></a><a href=#__codelineno-28-26><span class=linenos data-linenos="26 "></span></a>  <span class=c1>// that starts an identical request into the same Target or View), we can simply use the</span>
<a id=__codelineno-28-27 name=__codelineno-28-27></a><a href=#__codelineno-28-27><span class=linenos data-linenos="27 "></span></a>  <span class=c1>// resource and size we retrieved the last time around and skip obtaining a new size, starting a</span>
<a id=__codelineno-28-28 name=__codelineno-28-28></a><a href=#__codelineno-28-28><span class=linenos data-linenos="28 "></span></a>  <span class=c1>// new load etc. This does mean that users who want to restart a load because they expect that</span>
<a id=__codelineno-28-29 name=__codelineno-28-29></a><a href=#__codelineno-28-29><span class=linenos data-linenos="29 "></span></a>  <span class=c1>// the view size has changed will need to explicitly clear the View or Target before starting</span>
<a id=__codelineno-28-30 name=__codelineno-28-30></a><a href=#__codelineno-28-30><span class=linenos data-linenos="30 "></span></a>  <span class=c1>// the new load.</span>
<a id=__codelineno-28-31 name=__codelineno-28-31></a><a href=#__codelineno-28-31><span class=linenos data-linenos="31 "></span></a>  <span class=c1>//</span>
<a id=__codelineno-28-32 name=__codelineno-28-32></a><a href=#__codelineno-28-32><span class=linenos data-linenos="32 "></span></a>  <span class=c1>// å¦‚æœæˆ‘ä»¬åœ¨è¯·æ±‚å®Œæˆåæƒ³é‡æ–°å¼€å§‹åŠ è½½ï¼Œé‚£ä¹ˆå°±ä¼šè¿”å›å·²ç»åŠ è½½å¥½çš„èµ„æº</span>
<a id=__codelineno-28-33 name=__codelineno-28-33></a><a href=#__codelineno-28-33><span class=linenos data-linenos="33 "></span></a>  <span class=c1>// å¦‚æœç”±äºviewå°ºå¯¸çš„æ”¹å˜ï¼Œæˆ‘ä»¬çš„ç¡®éœ€è¦é‡æ–°æ¥åŠ è½½ï¼Œæ­¤æ—¶æˆ‘ä»¬éœ€è¦æ˜ç¡®åœ°æ¸…é™¤Viewæˆ–Target</span>
<a id=__codelineno-28-34 name=__codelineno-28-34></a><a href=#__codelineno-28-34><span class=linenos data-linenos="34 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>status</span> <span class=o>==</span> <span class=n>Status</span><span class=p>.</span><span class=na>COMPLETE</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-28-35 name=__codelineno-28-35></a><a href=#__codelineno-28-35><span class=linenos data-linenos="35 "></span></a>    <span class=n>onResourceReady</span><span class=p>(</span><span class=n>resource</span><span class=p>,</span> <span class=n>DataSource</span><span class=p>.</span><span class=na>MEMORY_CACHE</span><span class=p>);</span>
<a id=__codelineno-28-36 name=__codelineno-28-36></a><a href=#__codelineno-28-36><span class=linenos data-linenos="36 "></span></a>    <span class=k>return</span><span class=p>;</span>
<a id=__codelineno-28-37 name=__codelineno-28-37></a><a href=#__codelineno-28-37><span class=linenos data-linenos="37 "></span></a>  <span class=p>}</span>
<a id=__codelineno-28-38 name=__codelineno-28-38></a><a href=#__codelineno-28-38><span class=linenos data-linenos="38 "></span></a>
<a id=__codelineno-28-39 name=__codelineno-28-39></a><a href=#__codelineno-28-39><span class=linenos data-linenos="39 "></span></a>  <span class=c1>// Restarts for requests that are neither complete nor running can be treated as new requests</span>
<a id=__codelineno-28-40 name=__codelineno-28-40></a><a href=#__codelineno-28-40><span class=linenos data-linenos="40 "></span></a>  <span class=c1>// and can run again from the beginning.</span>
<a id=__codelineno-28-41 name=__codelineno-28-41></a><a href=#__codelineno-28-41><span class=linenos data-linenos="41 "></span></a>  <span class=c1>//</span>
<a id=__codelineno-28-42 name=__codelineno-28-42></a><a href=#__codelineno-28-42><span class=linenos data-linenos="42 "></span></a>  <span class=c1>// è¯·æ±‚å²‚æ²¡æœ‰å®Œæˆä¹Ÿæ²¡æœ‰åœ¨è¿è¡Œï¼Œå°±å½“ä½œæ–°è¯·æ±‚æ¥å¯¹å¾…ã€‚æ­¤æ—¶å¯ä»¥ä»beginningå¼€å§‹è¿è¡Œ</span>
<a id=__codelineno-28-43 name=__codelineno-28-43></a><a href=#__codelineno-28-43><span class=linenos data-linenos="43 "></span></a>
<a id=__codelineno-28-44 name=__codelineno-28-44></a><a href=#__codelineno-28-44><span class=linenos data-linenos="44 "></span></a>  <span class=c1>// å¦‚æœæŒ‡å®šäº†overrideWidthå’ŒoverrideHeightï¼Œé‚£ä¹ˆç›´æ¥è°ƒç”¨onSizeReadyæ–¹æ³•</span>
<a id=__codelineno-28-45 name=__codelineno-28-45></a><a href=#__codelineno-28-45><span class=linenos data-linenos="45 "></span></a>  <span class=c1>// å¦åˆ™ä¼šè·å–ImageViewçš„å®½ã€é«˜ï¼Œç„¶åè°ƒç”¨onSizeReadyæ–¹æ³•</span>
<a id=__codelineno-28-46 name=__codelineno-28-46></a><a href=#__codelineno-28-46><span class=linenos data-linenos="46 "></span></a>  <span class=c1>// åœ¨è¯¥æ–¹æ³•ä¸­ä¼šåˆ›å»ºå›¾ç‰‡åŠ è½½çš„Jobå¹¶å¼€å§‹æ‰§è¡Œ</span>
<a id=__codelineno-28-47 name=__codelineno-28-47></a><a href=#__codelineno-28-47><span class=linenos data-linenos="47 "></span></a>  <span class=n>status</span> <span class=o>=</span> <span class=n>Status</span><span class=p>.</span><span class=na>WAITING_FOR_SIZE</span><span class=p>;</span>
<a id=__codelineno-28-48 name=__codelineno-28-48></a><a href=#__codelineno-28-48><span class=linenos data-linenos="48 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>Util</span><span class=p>.</span><span class=na>isValidDimensions</span><span class=p>(</span><span class=n>overrideWidth</span><span class=p>,</span> <span class=n>overrideHeight</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-28-49 name=__codelineno-28-49></a><a href=#__codelineno-28-49><span class=linenos data-linenos="49 "></span></a>    <span class=n>onSizeReady</span><span class=p>(</span><span class=n>overrideWidth</span><span class=p>,</span> <span class=n>overrideHeight</span><span class=p>);</span>
<a id=__codelineno-28-50 name=__codelineno-28-50></a><a href=#__codelineno-28-50><span class=linenos data-linenos="50 "></span></a>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
<a id=__codelineno-28-51 name=__codelineno-28-51></a><a href=#__codelineno-28-51><span class=linenos data-linenos="51 "></span></a>    <span class=n>target</span><span class=p>.</span><span class=na>getSize</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
<a id=__codelineno-28-52 name=__codelineno-28-52></a><a href=#__codelineno-28-52><span class=linenos data-linenos="52 "></span></a>  <span class=p>}</span>
<a id=__codelineno-28-53 name=__codelineno-28-53></a><a href=#__codelineno-28-53><span class=linenos data-linenos="53 "></span></a>
<a id=__codelineno-28-54 name=__codelineno-28-54></a><a href=#__codelineno-28-54><span class=linenos data-linenos="54 "></span></a>  <span class=c1>// æ˜¾ç¤ºåŠ è½½ä¸­çš„å ä½ç¬¦</span>
<a id=__codelineno-28-55 name=__codelineno-28-55></a><a href=#__codelineno-28-55><span class=linenos data-linenos="55 "></span></a>  <span class=k>if</span> <span class=p>((</span><span class=n>status</span> <span class=o>==</span> <span class=n>Status</span><span class=p>.</span><span class=na>RUNNING</span> <span class=o>||</span> <span class=n>status</span> <span class=o>==</span> <span class=n>Status</span><span class=p>.</span><span class=na>WAITING_FOR_SIZE</span><span class=p>)</span>
<a id=__codelineno-28-56 name=__codelineno-28-56></a><a href=#__codelineno-28-56><span class=linenos data-linenos="56 "></span></a>      <span class=o>&amp;&amp;</span> <span class=n>canNotifyStatusChanged</span><span class=p>())</span> <span class=p>{</span>
<a id=__codelineno-28-57 name=__codelineno-28-57></a><a href=#__codelineno-28-57><span class=linenos data-linenos="57 "></span></a>    <span class=n>target</span><span class=p>.</span><span class=na>onLoadStarted</span><span class=p>(</span><span class=n>getPlaceholderDrawable</span><span class=p>());</span>
<a id=__codelineno-28-58 name=__codelineno-28-58></a><a href=#__codelineno-28-58><span class=linenos data-linenos="58 "></span></a>  <span class=p>}</span>
<a id=__codelineno-28-59 name=__codelineno-28-59></a><a href=#__codelineno-28-59><span class=linenos data-linenos="59 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>IS_VERBOSE_LOGGABLE</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-28-60 name=__codelineno-28-60></a><a href=#__codelineno-28-60><span class=linenos data-linenos="60 "></span></a>    <span class=n>logV</span><span class=p>(</span><span class=s>&quot;finished run method in &quot;</span> <span class=o>+</span> <span class=n>LogTime</span><span class=p>.</span><span class=na>getElapsedMillis</span><span class=p>(</span><span class=n>startTime</span><span class=p>));</span>
<a id=__codelineno-28-61 name=__codelineno-28-61></a><a href=#__codelineno-28-61><span class=linenos data-linenos="61 "></span></a>  <span class=p>}</span>
<a id=__codelineno-28-62 name=__codelineno-28-62></a><a href=#__codelineno-28-62><span class=linenos data-linenos="62 "></span></a><span class=p>}</span>
</code></pre></div> <p><code>begin</code>æ–¹æ³•å¯ä»¥åˆ†ä¸ºå‡ ä¸ªå¤§æ­¥éª¤ï¼Œæ¯ä¸ªæ­¥éª¤çš„ç”¨é€”å·²ç»åœ¨ä»£ç ä¸­è¿›è¡Œæ³¨é‡Šäº†ã€‚</p> <p>è·Ÿç€ä»£ç ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹<code>model = null</code>æ—¶ï¼Œ<code>onLoadFailed(new GlideException("Received null model"), logLevel);</code>å¹²äº†ä»€ä¹ˆï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-29-1 name=__codelineno-29-1></a><a href=#__codelineno-29-1><span class=linenos data-linenos=" 1 "></span></a><span class=kd>private</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>onLoadFailed</span><span class=p>(</span><span class=n>GlideException</span> <span class=n>e</span><span class=p>,</span> <span class=kt>int</span> <span class=n>maxLogLevel</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-29-2 name=__codelineno-29-2></a><a href=#__codelineno-29-2><span class=linenos data-linenos=" 2 "></span></a>  <span class=n>stateVerifier</span><span class=p>.</span><span class=na>throwIfRecycled</span><span class=p>();</span>
<a id=__codelineno-29-3 name=__codelineno-29-3></a><a href=#__codelineno-29-3><span class=linenos data-linenos=" 3 "></span></a>  <span class=n>e</span><span class=p>.</span><span class=na>setOrigin</span><span class=p>(</span><span class=n>requestOrigin</span><span class=p>);</span>
<a id=__codelineno-29-4 name=__codelineno-29-4></a><a href=#__codelineno-29-4><span class=linenos data-linenos=" 4 "></span></a>  <span class=kt>int</span> <span class=n>logLevel</span> <span class=o>=</span> <span class=n>glideContext</span><span class=p>.</span><span class=na>getLogLevel</span><span class=p>();</span>
<a id=__codelineno-29-5 name=__codelineno-29-5></a><a href=#__codelineno-29-5><span class=linenos data-linenos=" 5 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>logLevel</span> <span class=o>&lt;=</span> <span class=n>maxLogLevel</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-29-6 name=__codelineno-29-6></a><a href=#__codelineno-29-6><span class=linenos data-linenos=" 6 "></span></a>    <span class=n>Log</span><span class=p>.</span><span class=na>w</span><span class=p>(</span><span class=n>GLIDE_TAG</span><span class=p>,</span> <span class=s>&quot;Load failed for &quot;</span> <span class=o>+</span> <span class=n>model</span> <span class=o>+</span> <span class=s>&quot; with size [&quot;</span> <span class=o>+</span> <span class=n>width</span> <span class=o>+</span> <span class=s>&quot;x&quot;</span> <span class=o>+</span> <span class=n>height</span> <span class=o>+</span> <span class=s>&quot;]&quot;</span><span class=p>,</span> <span class=n>e</span><span class=p>);</span>
<a id=__codelineno-29-7 name=__codelineno-29-7></a><a href=#__codelineno-29-7><span class=linenos data-linenos=" 7 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>logLevel</span> <span class=o>&lt;=</span> <span class=n>Log</span><span class=p>.</span><span class=na>INFO</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-29-8 name=__codelineno-29-8></a><a href=#__codelineno-29-8><span class=linenos data-linenos=" 8 "></span></a>      <span class=n>e</span><span class=p>.</span><span class=na>logRootCauses</span><span class=p>(</span><span class=n>GLIDE_TAG</span><span class=p>);</span>
<a id=__codelineno-29-9 name=__codelineno-29-9></a><a href=#__codelineno-29-9><span class=linenos data-linenos=" 9 "></span></a>    <span class=p>}</span>
<a id=__codelineno-29-10 name=__codelineno-29-10></a><a href=#__codelineno-29-10><span class=linenos data-linenos="10 "></span></a>  <span class=p>}</span>
<a id=__codelineno-29-11 name=__codelineno-29-11></a><a href=#__codelineno-29-11><span class=linenos data-linenos="11 "></span></a>
<a id=__codelineno-29-12 name=__codelineno-29-12></a><a href=#__codelineno-29-12><span class=linenos data-linenos="12 "></span></a>  <span class=c1>// è®¾ç½®çŠ¶æ€ä¸ºStatus.FAILED</span>
<a id=__codelineno-29-13 name=__codelineno-29-13></a><a href=#__codelineno-29-13><span class=linenos data-linenos="13 "></span></a>  <span class=n>loadStatus</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-29-14 name=__codelineno-29-14></a><a href=#__codelineno-29-14><span class=linenos data-linenos="14 "></span></a>  <span class=n>status</span> <span class=o>=</span> <span class=n>Status</span><span class=p>.</span><span class=na>FAILED</span><span class=p>;</span>
<a id=__codelineno-29-15 name=__codelineno-29-15></a><a href=#__codelineno-29-15><span class=linenos data-linenos="15 "></span></a>
<a id=__codelineno-29-16 name=__codelineno-29-16></a><a href=#__codelineno-29-16><span class=linenos data-linenos="16 "></span></a>  <span class=n>isCallingCallbacks</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
<a id=__codelineno-29-17 name=__codelineno-29-17></a><a href=#__codelineno-29-17><span class=linenos data-linenos="17 "></span></a>  <span class=k>try</span> <span class=p>{</span>
<a id=__codelineno-29-18 name=__codelineno-29-18></a><a href=#__codelineno-29-18><span class=linenos data-linenos="18 "></span></a>    <span class=c1>//TODO: what if this is a thumbnail request?</span>
<a id=__codelineno-29-19 name=__codelineno-29-19></a><a href=#__codelineno-29-19><span class=linenos data-linenos="19 "></span></a>    <span class=c1>// å°è¯•è°ƒç”¨å„ä¸ªlistenerçš„onLoadFailedå›è°ƒè¿›è¡Œå¤„ç†</span>
<a id=__codelineno-29-20 name=__codelineno-29-20></a><a href=#__codelineno-29-20><span class=linenos data-linenos="20 "></span></a>    <span class=kt>boolean</span> <span class=n>anyListenerHandledUpdatingTarget</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
<a id=__codelineno-29-21 name=__codelineno-29-21></a><a href=#__codelineno-29-21><span class=linenos data-linenos="21 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>requestListeners</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-29-22 name=__codelineno-29-22></a><a href=#__codelineno-29-22><span class=linenos data-linenos="22 "></span></a>      <span class=k>for</span> <span class=p>(</span><span class=n>RequestListener</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>listener</span> <span class=p>:</span> <span class=n>requestListeners</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-29-23 name=__codelineno-29-23></a><a href=#__codelineno-29-23><span class=linenos data-linenos="23 "></span></a>        <span class=n>anyListenerHandledUpdatingTarget</span> <span class=o>|=</span>
<a id=__codelineno-29-24 name=__codelineno-29-24></a><a href=#__codelineno-29-24><span class=linenos data-linenos="24 "></span></a>            <span class=n>listener</span><span class=p>.</span><span class=na>onLoadFailed</span><span class=p>(</span><span class=n>e</span><span class=p>,</span> <span class=n>model</span><span class=p>,</span> <span class=n>target</span><span class=p>,</span> <span class=n>isFirstReadyResource</span><span class=p>());</span>
<a id=__codelineno-29-25 name=__codelineno-29-25></a><a href=#__codelineno-29-25><span class=linenos data-linenos="25 "></span></a>      <span class=p>}</span>
<a id=__codelineno-29-26 name=__codelineno-29-26></a><a href=#__codelineno-29-26><span class=linenos data-linenos="26 "></span></a>    <span class=p>}</span>
<a id=__codelineno-29-27 name=__codelineno-29-27></a><a href=#__codelineno-29-27><span class=linenos data-linenos="27 "></span></a>    <span class=n>anyListenerHandledUpdatingTarget</span> <span class=o>|=</span>
<a id=__codelineno-29-28 name=__codelineno-29-28></a><a href=#__codelineno-29-28><span class=linenos data-linenos="28 "></span></a>        <span class=n>targetListener</span> <span class=o>!=</span> <span class=kc>null</span>
<a id=__codelineno-29-29 name=__codelineno-29-29></a><a href=#__codelineno-29-29><span class=linenos data-linenos="29 "></span></a>            <span class=o>&amp;&amp;</span> <span class=n>targetListener</span><span class=p>.</span><span class=na>onLoadFailed</span><span class=p>(</span><span class=n>e</span><span class=p>,</span> <span class=n>model</span><span class=p>,</span> <span class=n>target</span><span class=p>,</span> <span class=n>isFirstReadyResource</span><span class=p>());</span>
<a id=__codelineno-29-30 name=__codelineno-29-30></a><a href=#__codelineno-29-30><span class=linenos data-linenos="30 "></span></a>
<a id=__codelineno-29-31 name=__codelineno-29-31></a><a href=#__codelineno-29-31><span class=linenos data-linenos="31 "></span></a>    <span class=c1>// å¦‚æœæ²¡æœ‰ä¸€ä¸ªå›è°ƒèƒ½å¤Ÿå¤„ç†ï¼Œé‚£ä¹ˆæ˜¾ç¤ºå¤±è´¥å ä½ç¬¦</span>
<a id=__codelineno-29-32 name=__codelineno-29-32></a><a href=#__codelineno-29-32><span class=linenos data-linenos="32 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>anyListenerHandledUpdatingTarget</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-29-33 name=__codelineno-29-33></a><a href=#__codelineno-29-33><span class=linenos data-linenos="33 "></span></a>      <span class=n>setErrorPlaceholder</span><span class=p>();</span>
<a id=__codelineno-29-34 name=__codelineno-29-34></a><a href=#__codelineno-29-34><span class=linenos data-linenos="34 "></span></a>    <span class=p>}</span>
<a id=__codelineno-29-35 name=__codelineno-29-35></a><a href=#__codelineno-29-35><span class=linenos data-linenos="35 "></span></a>  <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
<a id=__codelineno-29-36 name=__codelineno-29-36></a><a href=#__codelineno-29-36><span class=linenos data-linenos="36 "></span></a>    <span class=n>isCallingCallbacks</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
<a id=__codelineno-29-37 name=__codelineno-29-37></a><a href=#__codelineno-29-37><span class=linenos data-linenos="37 "></span></a>  <span class=p>}</span>
<a id=__codelineno-29-38 name=__codelineno-29-38></a><a href=#__codelineno-29-38><span class=linenos data-linenos="38 "></span></a>
<a id=__codelineno-29-39 name=__codelineno-29-39></a><a href=#__codelineno-29-39><span class=linenos data-linenos="39 "></span></a>  <span class=c1>// é€šçŸ¥requestCoordinatorï¼Œæ­¤è¯·æ±‚å¤±è´¥</span>
<a id=__codelineno-29-40 name=__codelineno-29-40></a><a href=#__codelineno-29-40><span class=linenos data-linenos="40 "></span></a>  <span class=n>notifyLoadFailed</span><span class=p>();</span>
<a id=__codelineno-29-41 name=__codelineno-29-41></a><a href=#__codelineno-29-41><span class=linenos data-linenos="41 "></span></a><span class=p>}</span>
<a id=__codelineno-29-42 name=__codelineno-29-42></a><a href=#__codelineno-29-42><span class=linenos data-linenos="42 "></span></a>
<a id=__codelineno-29-43 name=__codelineno-29-43></a><a href=#__codelineno-29-43><span class=linenos data-linenos="43 "></span></a><span class=kd>private</span> <span class=kt>void</span> <span class=nf>notifyLoadFailed</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-29-44 name=__codelineno-29-44></a><a href=#__codelineno-29-44><span class=linenos data-linenos="44 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>requestCoordinator</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-29-45 name=__codelineno-29-45></a><a href=#__codelineno-29-45><span class=linenos data-linenos="45 "></span></a>    <span class=n>requestCoordinator</span><span class=p>.</span><span class=na>onRequestFailed</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
<a id=__codelineno-29-46 name=__codelineno-29-46></a><a href=#__codelineno-29-46><span class=linenos data-linenos="46 "></span></a>  <span class=p>}</span>
<a id=__codelineno-29-47 name=__codelineno-29-47></a><a href=#__codelineno-29-47><span class=linenos data-linenos="47 "></span></a><span class=p>}</span>
</code></pre></div> <p>çœ‹ä¸€ä¸‹<code>setErrorPlaceholder</code>ä¸­æ˜¾ç¤ºå¤±è´¥å ä½ç¬¦çš„é€»è¾‘ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-30-1 name=__codelineno-30-1></a><a href=#__codelineno-30-1><span class=linenos data-linenos=" 1 "></span></a><span class=kd>private</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>setErrorPlaceholder</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-30-2 name=__codelineno-30-2></a><a href=#__codelineno-30-2><span class=linenos data-linenos=" 2 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>canNotifyStatusChanged</span><span class=p>())</span> <span class=p>{</span>
<a id=__codelineno-30-3 name=__codelineno-30-3></a><a href=#__codelineno-30-3><span class=linenos data-linenos=" 3 "></span></a>    <span class=k>return</span><span class=p>;</span>
<a id=__codelineno-30-4 name=__codelineno-30-4></a><a href=#__codelineno-30-4><span class=linenos data-linenos=" 4 "></span></a>  <span class=p>}</span>
<a id=__codelineno-30-5 name=__codelineno-30-5></a><a href=#__codelineno-30-5><span class=linenos data-linenos=" 5 "></span></a>
<a id=__codelineno-30-6 name=__codelineno-30-6></a><a href=#__codelineno-30-6><span class=linenos data-linenos=" 6 "></span></a>  <span class=n>Drawable</span> <span class=n>error</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-30-7 name=__codelineno-30-7></a><a href=#__codelineno-30-7><span class=linenos data-linenos=" 7 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>model</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-30-8 name=__codelineno-30-8></a><a href=#__codelineno-30-8><span class=linenos data-linenos=" 8 "></span></a>    <span class=n>error</span> <span class=o>=</span> <span class=n>getFallbackDrawable</span><span class=p>();</span>
<a id=__codelineno-30-9 name=__codelineno-30-9></a><a href=#__codelineno-30-9><span class=linenos data-linenos=" 9 "></span></a>  <span class=p>}</span>
<a id=__codelineno-30-10 name=__codelineno-30-10></a><a href=#__codelineno-30-10><span class=linenos data-linenos="10 "></span></a>  <span class=c1>// Either the model isn&#39;t null, or there was no fallback drawable set.</span>
<a id=__codelineno-30-11 name=__codelineno-30-11></a><a href=#__codelineno-30-11><span class=linenos data-linenos="11 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>error</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-30-12 name=__codelineno-30-12></a><a href=#__codelineno-30-12><span class=linenos data-linenos="12 "></span></a>    <span class=n>error</span> <span class=o>=</span> <span class=n>getErrorDrawable</span><span class=p>();</span>
<a id=__codelineno-30-13 name=__codelineno-30-13></a><a href=#__codelineno-30-13><span class=linenos data-linenos="13 "></span></a>  <span class=p>}</span>
<a id=__codelineno-30-14 name=__codelineno-30-14></a><a href=#__codelineno-30-14><span class=linenos data-linenos="14 "></span></a>  <span class=c1>// The model isn&#39;t null, no fallback drawable was set or no error drawable was set.</span>
<a id=__codelineno-30-15 name=__codelineno-30-15></a><a href=#__codelineno-30-15><span class=linenos data-linenos="15 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>error</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-30-16 name=__codelineno-30-16></a><a href=#__codelineno-30-16><span class=linenos data-linenos="16 "></span></a>    <span class=n>error</span> <span class=o>=</span> <span class=n>getPlaceholderDrawable</span><span class=p>();</span>
<a id=__codelineno-30-17 name=__codelineno-30-17></a><a href=#__codelineno-30-17><span class=linenos data-linenos="17 "></span></a>  <span class=p>}</span>
<a id=__codelineno-30-18 name=__codelineno-30-18></a><a href=#__codelineno-30-18><span class=linenos data-linenos="18 "></span></a>  <span class=n>target</span><span class=p>.</span><span class=na>onLoadFailed</span><span class=p>(</span><span class=n>error</span><span class=p>);</span>
<a id=__codelineno-30-19 name=__codelineno-30-19></a><a href=#__codelineno-30-19><span class=linenos data-linenos="19 "></span></a><span class=p>}</span>
</code></pre></div> <p>è¿™é‡Œçš„<code>target</code>æ˜¯<code>DrawableImageViewTarget</code>ç±»å‹ï¼Œ<code>onLoadFailed</code>æ–¹æ³•çš„é€»è¾‘å®ç°åœ¨å…¶çˆ¶ç±»<code>ImageViewTarget</code>ä¸­ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-31-1 name=__codelineno-31-1></a><a href=#__codelineno-31-1><span class=linenos data-linenos=" 1 "></span></a><span class=nd>@Override</span>
<a id=__codelineno-31-2 name=__codelineno-31-2></a><a href=#__codelineno-31-2><span class=linenos data-linenos=" 2 "></span></a><span class=kd>public</span> <span class=kt>void</span> <span class=nf>onLoadFailed</span><span class=p>(</span><span class=nd>@Nullable</span> <span class=n>Drawable</span> <span class=n>errorDrawable</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-31-3 name=__codelineno-31-3></a><a href=#__codelineno-31-3><span class=linenos data-linenos=" 3 "></span></a>  <span class=kd>super</span><span class=p>.</span><span class=na>onLoadFailed</span><span class=p>(</span><span class=n>errorDrawable</span><span class=p>);</span>
<a id=__codelineno-31-4 name=__codelineno-31-4></a><a href=#__codelineno-31-4><span class=linenos data-linenos=" 4 "></span></a>  <span class=n>setResourceInternal</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span>
<a id=__codelineno-31-5 name=__codelineno-31-5></a><a href=#__codelineno-31-5><span class=linenos data-linenos=" 5 "></span></a>  <span class=n>setDrawable</span><span class=p>(</span><span class=n>errorDrawable</span><span class=p>);</span>
<a id=__codelineno-31-6 name=__codelineno-31-6></a><a href=#__codelineno-31-6><span class=linenos data-linenos=" 6 "></span></a><span class=p>}</span>
<a id=__codelineno-31-7 name=__codelineno-31-7></a><a href=#__codelineno-31-7><span class=linenos data-linenos=" 7 "></span></a>
<a id=__codelineno-31-8 name=__codelineno-31-8></a><a href=#__codelineno-31-8><span class=linenos data-linenos=" 8 "></span></a><span class=nd>@Override</span>
<a id=__codelineno-31-9 name=__codelineno-31-9></a><a href=#__codelineno-31-9><span class=linenos data-linenos=" 9 "></span></a><span class=kd>public</span> <span class=kt>void</span> <span class=nf>setDrawable</span><span class=p>(</span><span class=n>Drawable</span> <span class=n>drawable</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-31-10 name=__codelineno-31-10></a><a href=#__codelineno-31-10><span class=linenos data-linenos="10 "></span></a>  <span class=n>view</span><span class=p>.</span><span class=na>setImageDrawable</span><span class=p>(</span><span class=n>drawable</span><span class=p>);</span>
<a id=__codelineno-31-11 name=__codelineno-31-11></a><a href=#__codelineno-31-11><span class=linenos data-linenos="11 "></span></a><span class=p>}</span>
</code></pre></div> <p>æ˜¾è€Œæ˜“è§ï¼Œå½“modelä¸ºnullæ—¶ï¼Œå¤±è´¥å ä½ç¬¦çš„æ˜¾ç¤ºé€»è¾‘å¦‚ä¸‹ï¼š</p> <ol> <li>å¦‚æœè®¾ç½®äº†fallbackï¼Œé‚£ä¹ˆæ˜¾ç¤ºfallback</li> <li>å¦åˆ™ï¼Œå¦‚æœè®¾ç½®äº†errorï¼Œé‚£ä¹ˆæ˜¾ç¤ºerror</li> <li>å¦åˆ™ï¼Œå¦‚æœè®¾ç½®äº†placeholderï¼Œé‚£ä¹ˆæ˜¾ç¤ºplaceholder</li> </ol> <blockquote> <p>è¿™ä¹Ÿè¯æ˜äº†<a href=/android/3rd-library/glide1/#21>Glide v4 æºç è§£æï¼ˆä¸€ï¼‰--- å ä½ç¬¦</a>ä¸­ï¼Œå…³äºmodelä¸ºnulléƒ¨åˆ†çš„æµç¨‹æ˜¯æ­£ç¡®çš„ã€‚</p> </blockquote> <p>å›åˆ°<code>SingleRequest.begin()</code>æ–¹æ³•ä¸­ã€‚<br> åˆ¤æ–­å®Œmodelæ˜¯å¦ä¸ºnullåï¼Œä¸‹é¢ä¼šåˆ¤æ–­statusæ˜¯å¦ä¸º<code>Status.COMPLETE</code>ã€‚å¦‚æœæ˜¯ï¼Œä¼šè°ƒç”¨<code>onResourceReady(resource, DataSource.MEMORY_CACHE)</code>å¹¶è¿”å›ã€‚è¯¥æ–¹æ³•æˆ‘ä»¬åé¢ä¹Ÿä¼šé‡åˆ°ï¼Œåé¢åœ¨è¯´ã€‚</p> <p>æ¥ä¸‹æ¥ä¼šè·å–è¦åŠ è½½å›¾ç‰‡çš„sizeå¹¶è°ƒç”¨<code>onSizeReady</code>æ–¹æ³•ï¼Œæˆ‘ä»¬ç›´æ¥çœ‹è¯¥æ–¹æ³•ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-32-1 name=__codelineno-32-1></a><a href=#__codelineno-32-1><span class=linenos data-linenos=" 1 "></span></a><span class=nd>@Override</span>
<a id=__codelineno-32-2 name=__codelineno-32-2></a><a href=#__codelineno-32-2><span class=linenos data-linenos=" 2 "></span></a><span class=kd>public</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>onSizeReady</span><span class=p>(</span><span class=kt>int</span> <span class=n>width</span><span class=p>,</span> <span class=kt>int</span> <span class=n>height</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-32-3 name=__codelineno-32-3></a><a href=#__codelineno-32-3><span class=linenos data-linenos=" 3 "></span></a>  <span class=n>stateVerifier</span><span class=p>.</span><span class=na>throwIfRecycled</span><span class=p>();</span>
<a id=__codelineno-32-4 name=__codelineno-32-4></a><a href=#__codelineno-32-4><span class=linenos data-linenos=" 4 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>IS_VERBOSE_LOGGABLE</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-32-5 name=__codelineno-32-5></a><a href=#__codelineno-32-5><span class=linenos data-linenos=" 5 "></span></a>    <span class=n>logV</span><span class=p>(</span><span class=s>&quot;Got onSizeReady in &quot;</span> <span class=o>+</span> <span class=n>LogTime</span><span class=p>.</span><span class=na>getElapsedMillis</span><span class=p>(</span><span class=n>startTime</span><span class=p>));</span>
<a id=__codelineno-32-6 name=__codelineno-32-6></a><a href=#__codelineno-32-6><span class=linenos data-linenos=" 6 "></span></a>  <span class=p>}</span>
<a id=__codelineno-32-7 name=__codelineno-32-7></a><a href=#__codelineno-32-7><span class=linenos data-linenos=" 7 "></span></a>
<a id=__codelineno-32-8 name=__codelineno-32-8></a><a href=#__codelineno-32-8><span class=linenos data-linenos=" 8 "></span></a>  <span class=c1>// åœ¨SingleRequest.beginæ–¹æ³•ä¸­å·²ç»å°†statusè®¾ç½®ä¸ºWAITING_FOR_SIZEçŠ¶æ€äº†</span>
<a id=__codelineno-32-9 name=__codelineno-32-9></a><a href=#__codelineno-32-9><span class=linenos data-linenos=" 9 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>status</span> <span class=o>!=</span> <span class=n>Status</span><span class=p>.</span><span class=na>WAITING_FOR_SIZE</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-32-10 name=__codelineno-32-10></a><a href=#__codelineno-32-10><span class=linenos data-linenos="10 "></span></a>    <span class=k>return</span><span class=p>;</span>
<a id=__codelineno-32-11 name=__codelineno-32-11></a><a href=#__codelineno-32-11><span class=linenos data-linenos="11 "></span></a>  <span class=p>}</span>
<a id=__codelineno-32-12 name=__codelineno-32-12></a><a href=#__codelineno-32-12><span class=linenos data-linenos="12 "></span></a>  <span class=c1>// è®¾ç½®çŠ¶æ€ä¸ºRUNNING</span>
<a id=__codelineno-32-13 name=__codelineno-32-13></a><a href=#__codelineno-32-13><span class=linenos data-linenos="13 "></span></a>  <span class=n>status</span> <span class=o>=</span> <span class=n>Status</span><span class=p>.</span><span class=na>RUNNING</span><span class=p>;</span>
<a id=__codelineno-32-14 name=__codelineno-32-14></a><a href=#__codelineno-32-14><span class=linenos data-linenos="14 "></span></a>
<a id=__codelineno-32-15 name=__codelineno-32-15></a><a href=#__codelineno-32-15><span class=linenos data-linenos="15 "></span></a>  <span class=c1>// å°†åŸå§‹å°ºå¯¸ä¸0ï½1ä¹‹é—´çš„ç³»æ•°ç›¸ä¹˜ï¼Œå–æœ€æ¥è¿‘çš„æ•´æ•°å€¼ï¼Œå¾—åˆ°æ–°çš„å°ºå¯¸</span>
<a id=__codelineno-32-16 name=__codelineno-32-16></a><a href=#__codelineno-32-16><span class=linenos data-linenos="16 "></span></a>  <span class=kt>float</span> <span class=n>sizeMultiplier</span> <span class=o>=</span> <span class=n>requestOptions</span><span class=p>.</span><span class=na>getSizeMultiplier</span><span class=p>();</span>
<a id=__codelineno-32-17 name=__codelineno-32-17></a><a href=#__codelineno-32-17><span class=linenos data-linenos="17 "></span></a>  <span class=k>this</span><span class=p>.</span><span class=na>width</span> <span class=o>=</span> <span class=n>maybeApplySizeMultiplier</span><span class=p>(</span><span class=n>width</span><span class=p>,</span> <span class=n>sizeMultiplier</span><span class=p>);</span>
<a id=__codelineno-32-18 name=__codelineno-32-18></a><a href=#__codelineno-32-18><span class=linenos data-linenos="18 "></span></a>  <span class=k>this</span><span class=p>.</span><span class=na>height</span> <span class=o>=</span> <span class=n>maybeApplySizeMultiplier</span><span class=p>(</span><span class=n>height</span><span class=p>,</span> <span class=n>sizeMultiplier</span><span class=p>);</span>
<a id=__codelineno-32-19 name=__codelineno-32-19></a><a href=#__codelineno-32-19><span class=linenos data-linenos="19 "></span></a>
<a id=__codelineno-32-20 name=__codelineno-32-20></a><a href=#__codelineno-32-20><span class=linenos data-linenos="20 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>IS_VERBOSE_LOGGABLE</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-32-21 name=__codelineno-32-21></a><a href=#__codelineno-32-21><span class=linenos data-linenos="21 "></span></a>    <span class=n>logV</span><span class=p>(</span><span class=s>&quot;finished setup for calling load in &quot;</span> <span class=o>+</span> <span class=n>LogTime</span><span class=p>.</span><span class=na>getElapsedMillis</span><span class=p>(</span><span class=n>startTime</span><span class=p>));</span>
<a id=__codelineno-32-22 name=__codelineno-32-22></a><a href=#__codelineno-32-22><span class=linenos data-linenos="22 "></span></a>  <span class=p>}</span>
<a id=__codelineno-32-23 name=__codelineno-32-23></a><a href=#__codelineno-32-23><span class=linenos data-linenos="23 "></span></a>  <span class=c1>// ğŸ”¥ğŸ”¥ğŸ”¥ æ ¹æ®loadé‡Œé¢çš„è¿™äº›å‚æ•°å¼€å§‹åŠ è½½</span>
<a id=__codelineno-32-24 name=__codelineno-32-24></a><a href=#__codelineno-32-24><span class=linenos data-linenos="24 "></span></a>  <span class=n>loadStatus</span> <span class=o>=</span>
<a id=__codelineno-32-25 name=__codelineno-32-25></a><a href=#__codelineno-32-25><span class=linenos data-linenos="25 "></span></a>      <span class=n>engine</span><span class=p>.</span><span class=na>load</span><span class=p>(</span>
<a id=__codelineno-32-26 name=__codelineno-32-26></a><a href=#__codelineno-32-26><span class=linenos data-linenos="26 "></span></a>          <span class=n>glideContext</span><span class=p>,</span>
<a id=__codelineno-32-27 name=__codelineno-32-27></a><a href=#__codelineno-32-27><span class=linenos data-linenos="27 "></span></a>          <span class=n>model</span><span class=p>,</span>
<a id=__codelineno-32-28 name=__codelineno-32-28></a><a href=#__codelineno-32-28><span class=linenos data-linenos="28 "></span></a>          <span class=n>requestOptions</span><span class=p>.</span><span class=na>getSignature</span><span class=p>(),</span>
<a id=__codelineno-32-29 name=__codelineno-32-29></a><a href=#__codelineno-32-29><span class=linenos data-linenos="29 "></span></a>          <span class=k>this</span><span class=p>.</span><span class=na>width</span><span class=p>,</span>
<a id=__codelineno-32-30 name=__codelineno-32-30></a><a href=#__codelineno-32-30><span class=linenos data-linenos="30 "></span></a>          <span class=k>this</span><span class=p>.</span><span class=na>height</span><span class=p>,</span>
<a id=__codelineno-32-31 name=__codelineno-32-31></a><a href=#__codelineno-32-31><span class=linenos data-linenos="31 "></span></a>          <span class=n>requestOptions</span><span class=p>.</span><span class=na>getResourceClass</span><span class=p>(),</span>
<a id=__codelineno-32-32 name=__codelineno-32-32></a><a href=#__codelineno-32-32><span class=linenos data-linenos="32 "></span></a>          <span class=n>transcodeClass</span><span class=p>,</span>
<a id=__codelineno-32-33 name=__codelineno-32-33></a><a href=#__codelineno-32-33><span class=linenos data-linenos="33 "></span></a>          <span class=n>priority</span><span class=p>,</span>
<a id=__codelineno-32-34 name=__codelineno-32-34></a><a href=#__codelineno-32-34><span class=linenos data-linenos="34 "></span></a>          <span class=n>requestOptions</span><span class=p>.</span><span class=na>getDiskCacheStrategy</span><span class=p>(),</span>
<a id=__codelineno-32-35 name=__codelineno-32-35></a><a href=#__codelineno-32-35><span class=linenos data-linenos="35 "></span></a>          <span class=n>requestOptions</span><span class=p>.</span><span class=na>getTransformations</span><span class=p>(),</span>
<a id=__codelineno-32-36 name=__codelineno-32-36></a><a href=#__codelineno-32-36><span class=linenos data-linenos="36 "></span></a>          <span class=n>requestOptions</span><span class=p>.</span><span class=na>isTransformationRequired</span><span class=p>(),</span>
<a id=__codelineno-32-37 name=__codelineno-32-37></a><a href=#__codelineno-32-37><span class=linenos data-linenos="37 "></span></a>          <span class=n>requestOptions</span><span class=p>.</span><span class=na>isScaleOnlyOrNoTransform</span><span class=p>(),</span>
<a id=__codelineno-32-38 name=__codelineno-32-38></a><a href=#__codelineno-32-38><span class=linenos data-linenos="38 "></span></a>          <span class=n>requestOptions</span><span class=p>.</span><span class=na>getOptions</span><span class=p>(),</span>
<a id=__codelineno-32-39 name=__codelineno-32-39></a><a href=#__codelineno-32-39><span class=linenos data-linenos="39 "></span></a>          <span class=n>requestOptions</span><span class=p>.</span><span class=na>isMemoryCacheable</span><span class=p>(),</span>
<a id=__codelineno-32-40 name=__codelineno-32-40></a><a href=#__codelineno-32-40><span class=linenos data-linenos="40 "></span></a>          <span class=n>requestOptions</span><span class=p>.</span><span class=na>getUseUnlimitedSourceGeneratorsPool</span><span class=p>(),</span>
<a id=__codelineno-32-41 name=__codelineno-32-41></a><a href=#__codelineno-32-41><span class=linenos data-linenos="41 "></span></a>          <span class=n>requestOptions</span><span class=p>.</span><span class=na>getUseAnimationPool</span><span class=p>(),</span>
<a id=__codelineno-32-42 name=__codelineno-32-42></a><a href=#__codelineno-32-42><span class=linenos data-linenos="42 "></span></a>          <span class=n>requestOptions</span><span class=p>.</span><span class=na>getOnlyRetrieveFromCache</span><span class=p>(),</span>
<a id=__codelineno-32-43 name=__codelineno-32-43></a><a href=#__codelineno-32-43><span class=linenos data-linenos="43 "></span></a>          <span class=k>this</span><span class=p>,</span>
<a id=__codelineno-32-44 name=__codelineno-32-44></a><a href=#__codelineno-32-44><span class=linenos data-linenos="44 "></span></a>          <span class=n>callbackExecutor</span><span class=p>);</span>
<a id=__codelineno-32-45 name=__codelineno-32-45></a><a href=#__codelineno-32-45><span class=linenos data-linenos="45 "></span></a>
<a id=__codelineno-32-46 name=__codelineno-32-46></a><a href=#__codelineno-32-46><span class=linenos data-linenos="46 "></span></a>  <span class=c1>// This is a hack that&#39;s only useful for testing right now where loads complete synchronously</span>
<a id=__codelineno-32-47 name=__codelineno-32-47></a><a href=#__codelineno-32-47><span class=linenos data-linenos="47 "></span></a>  <span class=c1>// even though under any executor running on any thread but the main thread, the load would</span>
<a id=__codelineno-32-48 name=__codelineno-32-48></a><a href=#__codelineno-32-48><span class=linenos data-linenos="48 "></span></a>  <span class=c1>// have completed asynchronously.</span>
<a id=__codelineno-32-49 name=__codelineno-32-49></a><a href=#__codelineno-32-49><span class=linenos data-linenos="49 "></span></a>  <span class=c1>//</span>
<a id=__codelineno-32-50 name=__codelineno-32-50></a><a href=#__codelineno-32-50><span class=linenos data-linenos="50 "></span></a>  <span class=c1>// statusç›®å‰æ˜¾ç„¶æ˜¯RUNNINGçŠ¶æ€ï¼Œæ‰€ä»¥ä¸ä¼šå°†loadStatusè®¾ç½®ä¸ºnull</span>
<a id=__codelineno-32-51 name=__codelineno-32-51></a><a href=#__codelineno-32-51><span class=linenos data-linenos="51 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>status</span> <span class=o>!=</span> <span class=n>Status</span><span class=p>.</span><span class=na>RUNNING</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-32-52 name=__codelineno-32-52></a><a href=#__codelineno-32-52><span class=linenos data-linenos="52 "></span></a>    <span class=n>loadStatus</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-32-53 name=__codelineno-32-53></a><a href=#__codelineno-32-53><span class=linenos data-linenos="53 "></span></a>  <span class=p>}</span>
<a id=__codelineno-32-54 name=__codelineno-32-54></a><a href=#__codelineno-32-54><span class=linenos data-linenos="54 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>IS_VERBOSE_LOGGABLE</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-32-55 name=__codelineno-32-55></a><a href=#__codelineno-32-55><span class=linenos data-linenos="55 "></span></a>    <span class=n>logV</span><span class=p>(</span><span class=s>&quot;finished onSizeReady in &quot;</span> <span class=o>+</span> <span class=n>LogTime</span><span class=p>.</span><span class=na>getElapsedMillis</span><span class=p>(</span><span class=n>startTime</span><span class=p>));</span>
<a id=__codelineno-32-56 name=__codelineno-32-56></a><a href=#__codelineno-32-56><span class=linenos data-linenos="56 "></span></a>  <span class=p>}</span>
<a id=__codelineno-32-57 name=__codelineno-32-57></a><a href=#__codelineno-32-57><span class=linenos data-linenos="57 "></span></a><span class=p>}</span>
</code></pre></div> <h3 id=33-engineload>3.3 Engine.load<a class=headerlink href=#33-engineload title="Anchor link to this section for reference">&para;</a></h3> <p>ğŸ”¥ğŸ”¥ğŸ”¥ç›®å‰çœ‹æ¥ï¼Œ<code>engine.load</code>å°±æ˜¯å¼€å§‹è¯·æ±‚çš„å…³é”®ä»£ç äº†ã€‚<code>Engine</code>æ˜¯è´Ÿè´£å¼€å§‹åŠ è½½ï¼Œç®¡ç†activeã€cachedçŠ¶æ€èµ„æºçš„ç±»ã€‚åœ¨<code>GlideBuilder.build</code>ä¸­åˆ›å»º<code>Glide</code>æ—¶ï¼Œè‹¥æ²¡æœ‰ä¸»åŠ¨è®¾ç½®engineï¼Œä¼šä½¿ç”¨ä¸‹é¢çš„å‚æ•°è¿›è¡Œåˆ›å»ºï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-33-1 name=__codelineno-33-1></a><a href=#__codelineno-33-1><span class=linenos data-linenos=" 1 "></span></a><span class=k>if</span> <span class=p>(</span><span class=n>sourceExecutor</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-33-2 name=__codelineno-33-2></a><a href=#__codelineno-33-2><span class=linenos data-linenos=" 2 "></span></a>  <span class=n>sourceExecutor</span> <span class=o>=</span> <span class=n>GlideExecutor</span><span class=p>.</span><span class=na>newSourceExecutor</span><span class=p>();</span>
<a id=__codelineno-33-3 name=__codelineno-33-3></a><a href=#__codelineno-33-3><span class=linenos data-linenos=" 3 "></span></a><span class=p>}</span>
<a id=__codelineno-33-4 name=__codelineno-33-4></a><a href=#__codelineno-33-4><span class=linenos data-linenos=" 4 "></span></a>
<a id=__codelineno-33-5 name=__codelineno-33-5></a><a href=#__codelineno-33-5><span class=linenos data-linenos=" 5 "></span></a><span class=k>if</span> <span class=p>(</span><span class=n>diskCacheExecutor</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-33-6 name=__codelineno-33-6></a><a href=#__codelineno-33-6><span class=linenos data-linenos=" 6 "></span></a>  <span class=n>diskCacheExecutor</span> <span class=o>=</span> <span class=n>GlideExecutor</span><span class=p>.</span><span class=na>newDiskCacheExecutor</span><span class=p>();</span>
<a id=__codelineno-33-7 name=__codelineno-33-7></a><a href=#__codelineno-33-7><span class=linenos data-linenos=" 7 "></span></a><span class=p>}</span>
<a id=__codelineno-33-8 name=__codelineno-33-8></a><a href=#__codelineno-33-8><span class=linenos data-linenos=" 8 "></span></a>
<a id=__codelineno-33-9 name=__codelineno-33-9></a><a href=#__codelineno-33-9><span class=linenos data-linenos=" 9 "></span></a><span class=k>if</span> <span class=p>(</span><span class=n>memoryCache</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-33-10 name=__codelineno-33-10></a><a href=#__codelineno-33-10><span class=linenos data-linenos="10 "></span></a>  <span class=n>memoryCache</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LruResourceCache</span><span class=p>(</span><span class=n>memorySizeCalculator</span><span class=p>.</span><span class=na>getMemoryCacheSize</span><span class=p>());</span>
<a id=__codelineno-33-11 name=__codelineno-33-11></a><a href=#__codelineno-33-11><span class=linenos data-linenos="11 "></span></a><span class=p>}</span>
<a id=__codelineno-33-12 name=__codelineno-33-12></a><a href=#__codelineno-33-12><span class=linenos data-linenos="12 "></span></a>
<a id=__codelineno-33-13 name=__codelineno-33-13></a><a href=#__codelineno-33-13><span class=linenos data-linenos="13 "></span></a><span class=k>if</span> <span class=p>(</span><span class=n>diskCacheFactory</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-33-14 name=__codelineno-33-14></a><a href=#__codelineno-33-14><span class=linenos data-linenos="14 "></span></a>  <span class=n>diskCacheFactory</span> <span class=o>=</span> <span class=k>new</span> <span class=n>InternalCacheDiskCacheFactory</span><span class=p>(</span><span class=n>context</span><span class=p>);</span>
<a id=__codelineno-33-15 name=__codelineno-33-15></a><a href=#__codelineno-33-15><span class=linenos data-linenos="15 "></span></a><span class=p>}</span>
<a id=__codelineno-33-16 name=__codelineno-33-16></a><a href=#__codelineno-33-16><span class=linenos data-linenos="16 "></span></a>
<a id=__codelineno-33-17 name=__codelineno-33-17></a><a href=#__codelineno-33-17><span class=linenos data-linenos="17 "></span></a><span class=k>if</span> <span class=p>(</span><span class=n>engine</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-33-18 name=__codelineno-33-18></a><a href=#__codelineno-33-18><span class=linenos data-linenos="18 "></span></a>  <span class=n>engine</span> <span class=o>=</span>
<a id=__codelineno-33-19 name=__codelineno-33-19></a><a href=#__codelineno-33-19><span class=linenos data-linenos="19 "></span></a>      <span class=k>new</span> <span class=n>Engine</span><span class=p>(</span>
<a id=__codelineno-33-20 name=__codelineno-33-20></a><a href=#__codelineno-33-20><span class=linenos data-linenos="20 "></span></a>          <span class=n>memoryCache</span><span class=p>,</span>
<a id=__codelineno-33-21 name=__codelineno-33-21></a><a href=#__codelineno-33-21><span class=linenos data-linenos="21 "></span></a>          <span class=n>diskCacheFactory</span><span class=p>,</span>
<a id=__codelineno-33-22 name=__codelineno-33-22></a><a href=#__codelineno-33-22><span class=linenos data-linenos="22 "></span></a>          <span class=n>diskCacheExecutor</span><span class=p>,</span>
<a id=__codelineno-33-23 name=__codelineno-33-23></a><a href=#__codelineno-33-23><span class=linenos data-linenos="23 "></span></a>          <span class=n>sourceExecutor</span><span class=p>,</span>
<a id=__codelineno-33-24 name=__codelineno-33-24></a><a href=#__codelineno-33-24><span class=linenos data-linenos="24 "></span></a>          <span class=n>GlideExecutor</span><span class=p>.</span><span class=na>newUnlimitedSourceExecutor</span><span class=p>(),</span>
<a id=__codelineno-33-25 name=__codelineno-33-25></a><a href=#__codelineno-33-25><span class=linenos data-linenos="25 "></span></a>          <span class=n>GlideExecutor</span><span class=p>.</span><span class=na>newAnimationExecutor</span><span class=p>(),</span>
<a id=__codelineno-33-26 name=__codelineno-33-26></a><a href=#__codelineno-33-26><span class=linenos data-linenos="26 "></span></a>          <span class=n>isActiveResourceRetentionAllowed</span> <span class=cm>/* é»˜è®¤ä¸ºfalse */</span><span class=p>);</span>
<a id=__codelineno-33-27 name=__codelineno-33-27></a><a href=#__codelineno-33-27><span class=linenos data-linenos="27 "></span></a><span class=p>}</span>
</code></pre></div> <p><code>Engine.load</code>æ–¹æ³•ä¸­ä¼šä»¥ä¸€äº›å‚æ•°ä½œä¸ºkeyï¼Œä¾æ¬¡ä»activeçŠ¶æ€ã€cachedçŠ¶æ€å’Œè¿›è¡Œä¸­çš„loadé‡Œå¯»æ‰¾ã€‚è‹¥æ²¡æœ‰æ‰¾åˆ°ï¼Œåˆ™ä¼šåˆ›å»ºå¯¹åº”çš„jobå¹¶å¼€å§‹æ‰§è¡Œã€‚<br> æä¾›ç»™ä¸€ä¸ªæˆ–ä»¥ä¸Šè¯·æ±‚ä¸”æ²¡æœ‰è¢«é‡Šæ”¾çš„èµ„æºè¢«ç§°ä¸ºactiveèµ„æºã€‚ä¸€æ—¦æ‰€æœ‰çš„æ¶ˆè´¹è€…éƒ½é‡Šæ”¾äº†è¯¥èµ„æºï¼Œè¯¥èµ„æºå°±ä¼šè¢«æ”¾å…¥cacheä¸­ã€‚å¦‚æœæœ‰è¯·æ±‚å°†èµ„æºä»cacheä¸­å–å‡ºï¼Œå®ƒä¼šè¢«é‡æ–°æ·»åŠ åˆ°activeèµ„æºä¸­ã€‚å¦‚æœä¸€ä¸ªèµ„æºä»cacheä¸­ç§»é™¤ï¼Œå…¶æœ¬èº«ä¼šè¢«discardï¼Œå…¶å†…éƒ¨æ‹¥æœ‰çš„èµ„æºå°†ä¼šå›æ”¶æˆ–è€…åœ¨å¯èƒ½çš„æƒ…å†µä¸‹é‡ç”¨ã€‚å¹¶æ²¡æœ‰ä¸¥æ ¼è¦æ±‚æ¶ˆè´¹è€…ä¸€å®šè¦é‡Šæ”¾å®ƒä»¬çš„èµ„æºï¼Œæ‰€ä»¥activeèµ„æºä¼šä»¥å¼±å¼•ç”¨çš„æ–¹å¼ä¿æŒã€‚ </p> <p>æ³¨æ„æ–¹æ³•çš„æ³¨é‡Šï¼Œé‡Œé¢æœ‰ä¸Šé¢ä¸¤æ–¹é¢çš„è¯´æ˜ï¼šè¯·æ±‚éµå®ˆçš„æµç¨‹ä»¥åŠactiveçŠ¶æ€èµ„æºçš„è¯´æ˜ã€‚</p> <div class=highlight><pre><span></span><code><a id=__codelineno-34-1 name=__codelineno-34-1></a><a href=#__codelineno-34-1><span class=linenos data-linenos="  1 "></span></a><span class=cm>/**</span>
<a id=__codelineno-34-2 name=__codelineno-34-2></a><a href=#__codelineno-34-2><span class=linenos data-linenos="  2 "></span></a><span class=cm>  * Starts a load for the given arguments.</span>
<a id=__codelineno-34-3 name=__codelineno-34-3></a><a href=#__codelineno-34-3><span class=linenos data-linenos="  3 "></span></a><span class=cm>  *</span>
<a id=__codelineno-34-4 name=__codelineno-34-4></a><a href=#__codelineno-34-4><span class=linenos data-linenos="  4 "></span></a><span class=cm>  * &lt;p&gt;Must be called on the main thread.</span>
<a id=__codelineno-34-5 name=__codelineno-34-5></a><a href=#__codelineno-34-5><span class=linenos data-linenos="  5 "></span></a><span class=cm>  *</span>
<a id=__codelineno-34-6 name=__codelineno-34-6></a><a href=#__codelineno-34-6><span class=linenos data-linenos="  6 "></span></a><span class=cm>  * &lt;p&gt;The flow for any request is as follows:</span>
<a id=__codelineno-34-7 name=__codelineno-34-7></a><a href=#__codelineno-34-7><span class=linenos data-linenos="  7 "></span></a><span class=cm>  *</span>
<a id=__codelineno-34-8 name=__codelineno-34-8></a><a href=#__codelineno-34-8><span class=linenos data-linenos="  8 "></span></a><span class=cm>  * &lt;ul&gt;</span>
<a id=__codelineno-34-9 name=__codelineno-34-9></a><a href=#__codelineno-34-9><span class=linenos data-linenos="  9 "></span></a><span class=cm>  *   &lt;li&gt;Check the current set of actively used resources, return the active resource if present,</span>
<a id=__codelineno-34-10 name=__codelineno-34-10></a><a href=#__codelineno-34-10><span class=linenos data-linenos=" 10 "></span></a><span class=cm>  *       and move any newly inactive resources into the memory cache.</span>
<a id=__codelineno-34-11 name=__codelineno-34-11></a><a href=#__codelineno-34-11><span class=linenos data-linenos=" 11 "></span></a><span class=cm>  *   &lt;li&gt;Check the memory cache and provide the cached resource if present.</span>
<a id=__codelineno-34-12 name=__codelineno-34-12></a><a href=#__codelineno-34-12><span class=linenos data-linenos=" 12 "></span></a><span class=cm>  *   &lt;li&gt;Check the current set of in progress loads and add the cb to the in progress load if one</span>
<a id=__codelineno-34-13 name=__codelineno-34-13></a><a href=#__codelineno-34-13><span class=linenos data-linenos=" 13 "></span></a><span class=cm>  *       is present.</span>
<a id=__codelineno-34-14 name=__codelineno-34-14></a><a href=#__codelineno-34-14><span class=linenos data-linenos=" 14 "></span></a><span class=cm>  *   &lt;li&gt;Start a new load.</span>
<a id=__codelineno-34-15 name=__codelineno-34-15></a><a href=#__codelineno-34-15><span class=linenos data-linenos=" 15 "></span></a><span class=cm>  * &lt;/ul&gt;</span>
<a id=__codelineno-34-16 name=__codelineno-34-16></a><a href=#__codelineno-34-16><span class=linenos data-linenos=" 16 "></span></a><span class=cm>  *</span>
<a id=__codelineno-34-17 name=__codelineno-34-17></a><a href=#__codelineno-34-17><span class=linenos data-linenos=" 17 "></span></a><span class=cm>  * &lt;p&gt;Active resources are those that have been provided to at least one request and have not yet</span>
<a id=__codelineno-34-18 name=__codelineno-34-18></a><a href=#__codelineno-34-18><span class=linenos data-linenos=" 18 "></span></a><span class=cm>  * been released. Once all consumers of a resource have released that resource, the resource then</span>
<a id=__codelineno-34-19 name=__codelineno-34-19></a><a href=#__codelineno-34-19><span class=linenos data-linenos=" 19 "></span></a><span class=cm>  * goes to cache. If the resource is ever returned to a new consumer from cache, it is re-added to</span>
<a id=__codelineno-34-20 name=__codelineno-34-20></a><a href=#__codelineno-34-20><span class=linenos data-linenos=" 20 "></span></a><span class=cm>  * the active resources. If the resource is evicted from the cache, its resources are recycled and</span>
<a id=__codelineno-34-21 name=__codelineno-34-21></a><a href=#__codelineno-34-21><span class=linenos data-linenos=" 21 "></span></a><span class=cm>  * re-used if possible and the resource is discarded. There is no strict requirement that</span>
<a id=__codelineno-34-22 name=__codelineno-34-22></a><a href=#__codelineno-34-22><span class=linenos data-linenos=" 22 "></span></a><span class=cm>  * consumers release their resources so active resources are held weakly.</span>
<a id=__codelineno-34-23 name=__codelineno-34-23></a><a href=#__codelineno-34-23><span class=linenos data-linenos=" 23 "></span></a><span class=cm>  *</span>
<a id=__codelineno-34-24 name=__codelineno-34-24></a><a href=#__codelineno-34-24><span class=linenos data-linenos=" 24 "></span></a><span class=cm>  * @param width The target width in pixels of the desired resource.</span>
<a id=__codelineno-34-25 name=__codelineno-34-25></a><a href=#__codelineno-34-25><span class=linenos data-linenos=" 25 "></span></a><span class=cm>  * @param height The target height in pixels of the desired resource.</span>
<a id=__codelineno-34-26 name=__codelineno-34-26></a><a href=#__codelineno-34-26><span class=linenos data-linenos=" 26 "></span></a><span class=cm>  * @param cb The callback that will be called when the load completes.</span>
<a id=__codelineno-34-27 name=__codelineno-34-27></a><a href=#__codelineno-34-27><span class=linenos data-linenos=" 27 "></span></a><span class=cm>  */</span>
<a id=__codelineno-34-28 name=__codelineno-34-28></a><a href=#__codelineno-34-28><span class=linenos data-linenos=" 28 "></span></a><span class=kd>public</span> <span class=kd>synchronized</span> <span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>LoadStatus</span> <span class=nf>load</span><span class=p>(</span>
<a id=__codelineno-34-29 name=__codelineno-34-29></a><a href=#__codelineno-34-29><span class=linenos data-linenos=" 29 "></span></a>    <span class=n>GlideContext</span> <span class=n>glideContext</span><span class=p>,</span>
<a id=__codelineno-34-30 name=__codelineno-34-30></a><a href=#__codelineno-34-30><span class=linenos data-linenos=" 30 "></span></a>    <span class=n>Object</span> <span class=n>model</span><span class=p>,</span>
<a id=__codelineno-34-31 name=__codelineno-34-31></a><a href=#__codelineno-34-31><span class=linenos data-linenos=" 31 "></span></a>    <span class=n>Key</span> <span class=n>signature</span><span class=p>,</span>
<a id=__codelineno-34-32 name=__codelineno-34-32></a><a href=#__codelineno-34-32><span class=linenos data-linenos=" 32 "></span></a>    <span class=kt>int</span> <span class=n>width</span><span class=p>,</span>
<a id=__codelineno-34-33 name=__codelineno-34-33></a><a href=#__codelineno-34-33><span class=linenos data-linenos=" 33 "></span></a>    <span class=kt>int</span> <span class=n>height</span><span class=p>,</span>
<a id=__codelineno-34-34 name=__codelineno-34-34></a><a href=#__codelineno-34-34><span class=linenos data-linenos=" 34 "></span></a>    <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>resourceClass</span><span class=p>,</span>
<a id=__codelineno-34-35 name=__codelineno-34-35></a><a href=#__codelineno-34-35><span class=linenos data-linenos=" 35 "></span></a>    <span class=n>Class</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>transcodeClass</span><span class=p>,</span>
<a id=__codelineno-34-36 name=__codelineno-34-36></a><a href=#__codelineno-34-36><span class=linenos data-linenos=" 36 "></span></a>    <span class=n>Priority</span> <span class=n>priority</span><span class=p>,</span>
<a id=__codelineno-34-37 name=__codelineno-34-37></a><a href=#__codelineno-34-37><span class=linenos data-linenos=" 37 "></span></a>    <span class=n>DiskCacheStrategy</span> <span class=n>diskCacheStrategy</span><span class=p>,</span>
<a id=__codelineno-34-38 name=__codelineno-34-38></a><a href=#__codelineno-34-38><span class=linenos data-linenos=" 38 "></span></a>    <span class=n>Map</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;</span><span class=p>,</span> <span class=n>Transformation</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>transformations</span><span class=p>,</span>
<a id=__codelineno-34-39 name=__codelineno-34-39></a><a href=#__codelineno-34-39><span class=linenos data-linenos=" 39 "></span></a>    <span class=kt>boolean</span> <span class=n>isTransformationRequired</span><span class=p>,</span>
<a id=__codelineno-34-40 name=__codelineno-34-40></a><a href=#__codelineno-34-40><span class=linenos data-linenos=" 40 "></span></a>    <span class=kt>boolean</span> <span class=n>isScaleOnlyOrNoTransform</span><span class=p>,</span>
<a id=__codelineno-34-41 name=__codelineno-34-41></a><a href=#__codelineno-34-41><span class=linenos data-linenos=" 41 "></span></a>    <span class=n>Options</span> <span class=n>options</span><span class=p>,</span>
<a id=__codelineno-34-42 name=__codelineno-34-42></a><a href=#__codelineno-34-42><span class=linenos data-linenos=" 42 "></span></a>    <span class=kt>boolean</span> <span class=n>isMemoryCacheable</span><span class=p>,</span>
<a id=__codelineno-34-43 name=__codelineno-34-43></a><a href=#__codelineno-34-43><span class=linenos data-linenos=" 43 "></span></a>    <span class=kt>boolean</span> <span class=n>useUnlimitedSourceExecutorPool</span><span class=p>,</span>
<a id=__codelineno-34-44 name=__codelineno-34-44></a><a href=#__codelineno-34-44><span class=linenos data-linenos=" 44 "></span></a>    <span class=kt>boolean</span> <span class=n>useAnimationPool</span><span class=p>,</span>
<a id=__codelineno-34-45 name=__codelineno-34-45></a><a href=#__codelineno-34-45><span class=linenos data-linenos=" 45 "></span></a>    <span class=kt>boolean</span> <span class=n>onlyRetrieveFromCache</span><span class=p>,</span>
<a id=__codelineno-34-46 name=__codelineno-34-46></a><a href=#__codelineno-34-46><span class=linenos data-linenos=" 46 "></span></a>    <span class=n>ResourceCallback</span> <span class=n>cb</span><span class=p>,</span>
<a id=__codelineno-34-47 name=__codelineno-34-47></a><a href=#__codelineno-34-47><span class=linenos data-linenos=" 47 "></span></a>    <span class=n>Executor</span> <span class=n>callbackExecutor</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-34-48 name=__codelineno-34-48></a><a href=#__codelineno-34-48><span class=linenos data-linenos=" 48 "></span></a>  <span class=kt>long</span> <span class=n>startTime</span> <span class=o>=</span> <span class=n>VERBOSE_IS_LOGGABLE</span> <span class=o>?</span> <span class=n>LogTime</span><span class=p>.</span><span class=na>getLogTime</span><span class=p>()</span> <span class=p>:</span> <span class=mi>0</span><span class=p>;</span>
<a id=__codelineno-34-49 name=__codelineno-34-49></a><a href=#__codelineno-34-49><span class=linenos data-linenos=" 49 "></span></a>
<a id=__codelineno-34-50 name=__codelineno-34-50></a><a href=#__codelineno-34-50><span class=linenos data-linenos=" 50 "></span></a>  <span class=c1>// EngineKeyä»¥ä¼ å…¥çš„8ä¸ªå‚æ•°ä½œä¸ºkey</span>
<a id=__codelineno-34-51 name=__codelineno-34-51></a><a href=#__codelineno-34-51><span class=linenos data-linenos=" 51 "></span></a>  <span class=n>EngineKey</span> <span class=n>key</span> <span class=o>=</span> <span class=n>keyFactory</span><span class=p>.</span><span class=na>buildKey</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>signature</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>,</span> <span class=n>transformations</span><span class=p>,</span>
<a id=__codelineno-34-52 name=__codelineno-34-52></a><a href=#__codelineno-34-52><span class=linenos data-linenos=" 52 "></span></a>      <span class=n>resourceClass</span><span class=p>,</span> <span class=n>transcodeClass</span><span class=p>,</span> <span class=n>options</span><span class=p>);</span>
<a id=__codelineno-34-53 name=__codelineno-34-53></a><a href=#__codelineno-34-53><span class=linenos data-linenos=" 53 "></span></a>
<a id=__codelineno-34-54 name=__codelineno-34-54></a><a href=#__codelineno-34-54><span class=linenos data-linenos=" 54 "></span></a>  <span class=c1>// ä»activeèµ„æºä¸­è¿›è¡ŒåŠ è½½ï¼Œç¬¬ä¸€æ¬¡æ˜¾ç„¶å–ä¸åˆ°</span>
<a id=__codelineno-34-55 name=__codelineno-34-55></a><a href=#__codelineno-34-55><span class=linenos data-linenos=" 55 "></span></a>  <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>active</span> <span class=o>=</span> <span class=n>loadFromActiveResources</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>isMemoryCacheable</span><span class=p>);</span>
<a id=__codelineno-34-56 name=__codelineno-34-56></a><a href=#__codelineno-34-56><span class=linenos data-linenos=" 56 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>active</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-34-57 name=__codelineno-34-57></a><a href=#__codelineno-34-57><span class=linenos data-linenos=" 57 "></span></a>    <span class=n>cb</span><span class=p>.</span><span class=na>onResourceReady</span><span class=p>(</span><span class=n>active</span><span class=p>,</span> <span class=n>DataSource</span><span class=p>.</span><span class=na>MEMORY_CACHE</span><span class=p>);</span>
<a id=__codelineno-34-58 name=__codelineno-34-58></a><a href=#__codelineno-34-58><span class=linenos data-linenos=" 58 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>VERBOSE_IS_LOGGABLE</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-34-59 name=__codelineno-34-59></a><a href=#__codelineno-34-59><span class=linenos data-linenos=" 59 "></span></a>      <span class=n>logWithTimeAndKey</span><span class=p>(</span><span class=s>&quot;Loaded resource from active resources&quot;</span><span class=p>,</span> <span class=n>startTime</span><span class=p>,</span> <span class=n>key</span><span class=p>);</span>
<a id=__codelineno-34-60 name=__codelineno-34-60></a><a href=#__codelineno-34-60><span class=linenos data-linenos=" 60 "></span></a>    <span class=p>}</span>
<a id=__codelineno-34-61 name=__codelineno-34-61></a><a href=#__codelineno-34-61><span class=linenos data-linenos=" 61 "></span></a>    <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-34-62 name=__codelineno-34-62></a><a href=#__codelineno-34-62><span class=linenos data-linenos=" 62 "></span></a>  <span class=p>}</span>
<a id=__codelineno-34-63 name=__codelineno-34-63></a><a href=#__codelineno-34-63><span class=linenos data-linenos=" 63 "></span></a>
<a id=__codelineno-34-64 name=__codelineno-34-64></a><a href=#__codelineno-34-64><span class=linenos data-linenos=" 64 "></span></a>  <span class=c1>// ä»å†…å­˜cacheèµ„æºä¸­è¿›è¡ŒåŠ è½½ï¼Œç¬¬ä¸€æ¬¡æ˜¾ç„¶å–ä¸åˆ°</span>
<a id=__codelineno-34-65 name=__codelineno-34-65></a><a href=#__codelineno-34-65><span class=linenos data-linenos=" 65 "></span></a>  <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>cached</span> <span class=o>=</span> <span class=n>loadFromCache</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>isMemoryCacheable</span><span class=p>);</span>
<a id=__codelineno-34-66 name=__codelineno-34-66></a><a href=#__codelineno-34-66><span class=linenos data-linenos=" 66 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>cached</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-34-67 name=__codelineno-34-67></a><a href=#__codelineno-34-67><span class=linenos data-linenos=" 67 "></span></a>    <span class=n>cb</span><span class=p>.</span><span class=na>onResourceReady</span><span class=p>(</span><span class=n>cached</span><span class=p>,</span> <span class=n>DataSource</span><span class=p>.</span><span class=na>MEMORY_CACHE</span><span class=p>);</span>
<a id=__codelineno-34-68 name=__codelineno-34-68></a><a href=#__codelineno-34-68><span class=linenos data-linenos=" 68 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>VERBOSE_IS_LOGGABLE</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-34-69 name=__codelineno-34-69></a><a href=#__codelineno-34-69><span class=linenos data-linenos=" 69 "></span></a>      <span class=n>logWithTimeAndKey</span><span class=p>(</span><span class=s>&quot;Loaded resource from cache&quot;</span><span class=p>,</span> <span class=n>startTime</span><span class=p>,</span> <span class=n>key</span><span class=p>);</span>
<a id=__codelineno-34-70 name=__codelineno-34-70></a><a href=#__codelineno-34-70><span class=linenos data-linenos=" 70 "></span></a>    <span class=p>}</span>
<a id=__codelineno-34-71 name=__codelineno-34-71></a><a href=#__codelineno-34-71><span class=linenos data-linenos=" 71 "></span></a>    <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-34-72 name=__codelineno-34-72></a><a href=#__codelineno-34-72><span class=linenos data-linenos=" 72 "></span></a>  <span class=p>}</span>
<a id=__codelineno-34-73 name=__codelineno-34-73></a><a href=#__codelineno-34-73><span class=linenos data-linenos=" 73 "></span></a>
<a id=__codelineno-34-74 name=__codelineno-34-74></a><a href=#__codelineno-34-74><span class=linenos data-linenos=" 74 "></span></a>  <span class=c1>// ä»æ­£åœ¨è¿›è¡Œçš„jobsä¸­è¿›è¡ŒåŠ è½½ï¼Œç¬¬ä¸€æ¬¡æ˜¾ç„¶å–ä¸åˆ°</span>
<a id=__codelineno-34-75 name=__codelineno-34-75></a><a href=#__codelineno-34-75><span class=linenos data-linenos=" 75 "></span></a>  <span class=n>EngineJob</span><span class=o>&lt;?&gt;</span> <span class=n>current</span> <span class=o>=</span> <span class=n>jobs</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>onlyRetrieveFromCache</span><span class=p>);</span>
<a id=__codelineno-34-76 name=__codelineno-34-76></a><a href=#__codelineno-34-76><span class=linenos data-linenos=" 76 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>current</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-34-77 name=__codelineno-34-77></a><a href=#__codelineno-34-77><span class=linenos data-linenos=" 77 "></span></a>    <span class=n>current</span><span class=p>.</span><span class=na>addCallback</span><span class=p>(</span><span class=n>cb</span><span class=p>,</span> <span class=n>callbackExecutor</span><span class=p>);</span>
<a id=__codelineno-34-78 name=__codelineno-34-78></a><a href=#__codelineno-34-78><span class=linenos data-linenos=" 78 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>VERBOSE_IS_LOGGABLE</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-34-79 name=__codelineno-34-79></a><a href=#__codelineno-34-79><span class=linenos data-linenos=" 79 "></span></a>      <span class=n>logWithTimeAndKey</span><span class=p>(</span><span class=s>&quot;Added to existing load&quot;</span><span class=p>,</span> <span class=n>startTime</span><span class=p>,</span> <span class=n>key</span><span class=p>);</span>
<a id=__codelineno-34-80 name=__codelineno-34-80></a><a href=#__codelineno-34-80><span class=linenos data-linenos=" 80 "></span></a>    <span class=p>}</span>
<a id=__codelineno-34-81 name=__codelineno-34-81></a><a href=#__codelineno-34-81><span class=linenos data-linenos=" 81 "></span></a>    <span class=k>return</span> <span class=k>new</span> <span class=n>LoadStatus</span><span class=p>(</span><span class=n>cb</span><span class=p>,</span> <span class=n>current</span><span class=p>);</span>
<a id=__codelineno-34-82 name=__codelineno-34-82></a><a href=#__codelineno-34-82><span class=linenos data-linenos=" 82 "></span></a>  <span class=p>}</span>
<a id=__codelineno-34-83 name=__codelineno-34-83></a><a href=#__codelineno-34-83><span class=linenos data-linenos=" 83 "></span></a>
<a id=__codelineno-34-84 name=__codelineno-34-84></a><a href=#__codelineno-34-84><span class=linenos data-linenos=" 84 "></span></a>  <span class=c1>// æ„å»ºå‡ºä¸€ä¸ªEngineJob</span>
<a id=__codelineno-34-85 name=__codelineno-34-85></a><a href=#__codelineno-34-85><span class=linenos data-linenos=" 85 "></span></a>  <span class=n>EngineJob</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>engineJob</span> <span class=o>=</span>
<a id=__codelineno-34-86 name=__codelineno-34-86></a><a href=#__codelineno-34-86><span class=linenos data-linenos=" 86 "></span></a>      <span class=n>engineJobFactory</span><span class=p>.</span><span class=na>build</span><span class=p>(</span>
<a id=__codelineno-34-87 name=__codelineno-34-87></a><a href=#__codelineno-34-87><span class=linenos data-linenos=" 87 "></span></a>          <span class=n>key</span><span class=p>,</span>
<a id=__codelineno-34-88 name=__codelineno-34-88></a><a href=#__codelineno-34-88><span class=linenos data-linenos=" 88 "></span></a>          <span class=n>isMemoryCacheable</span><span class=p>,</span>
<a id=__codelineno-34-89 name=__codelineno-34-89></a><a href=#__codelineno-34-89><span class=linenos data-linenos=" 89 "></span></a>          <span class=n>useUnlimitedSourceExecutorPool</span><span class=p>,</span>
<a id=__codelineno-34-90 name=__codelineno-34-90></a><a href=#__codelineno-34-90><span class=linenos data-linenos=" 90 "></span></a>          <span class=n>useAnimationPool</span><span class=p>,</span>
<a id=__codelineno-34-91 name=__codelineno-34-91></a><a href=#__codelineno-34-91><span class=linenos data-linenos=" 91 "></span></a>          <span class=n>onlyRetrieveFromCache</span><span class=p>);</span>
<a id=__codelineno-34-92 name=__codelineno-34-92></a><a href=#__codelineno-34-92><span class=linenos data-linenos=" 92 "></span></a>
<a id=__codelineno-34-93 name=__codelineno-34-93></a><a href=#__codelineno-34-93><span class=linenos data-linenos=" 93 "></span></a>  <span class=c1>// æ„å»ºå‡ºä¸€ä¸ªDecodeJobï¼Œè¯¥ç±»å®ç°äº†Runnableæ¥å£</span>
<a id=__codelineno-34-94 name=__codelineno-34-94></a><a href=#__codelineno-34-94><span class=linenos data-linenos=" 94 "></span></a>  <span class=n>DecodeJob</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>decodeJob</span> <span class=o>=</span>
<a id=__codelineno-34-95 name=__codelineno-34-95></a><a href=#__codelineno-34-95><span class=linenos data-linenos=" 95 "></span></a>      <span class=n>decodeJobFactory</span><span class=p>.</span><span class=na>build</span><span class=p>(</span>
<a id=__codelineno-34-96 name=__codelineno-34-96></a><a href=#__codelineno-34-96><span class=linenos data-linenos=" 96 "></span></a>          <span class=n>glideContext</span><span class=p>,</span>
<a id=__codelineno-34-97 name=__codelineno-34-97></a><a href=#__codelineno-34-97><span class=linenos data-linenos=" 97 "></span></a>          <span class=n>model</span><span class=p>,</span>
<a id=__codelineno-34-98 name=__codelineno-34-98></a><a href=#__codelineno-34-98><span class=linenos data-linenos=" 98 "></span></a>          <span class=n>key</span><span class=p>,</span>
<a id=__codelineno-34-99 name=__codelineno-34-99></a><a href=#__codelineno-34-99><span class=linenos data-linenos=" 99 "></span></a>          <span class=n>signature</span><span class=p>,</span>
<a id=__codelineno-34-100 name=__codelineno-34-100></a><a href=#__codelineno-34-100><span class=linenos data-linenos="100 "></span></a>          <span class=n>width</span><span class=p>,</span>
<a id=__codelineno-34-101 name=__codelineno-34-101></a><a href=#__codelineno-34-101><span class=linenos data-linenos="101 "></span></a>          <span class=n>height</span><span class=p>,</span>
<a id=__codelineno-34-102 name=__codelineno-34-102></a><a href=#__codelineno-34-102><span class=linenos data-linenos="102 "></span></a>          <span class=n>resourceClass</span><span class=p>,</span>
<a id=__codelineno-34-103 name=__codelineno-34-103></a><a href=#__codelineno-34-103><span class=linenos data-linenos="103 "></span></a>          <span class=n>transcodeClass</span><span class=p>,</span>
<a id=__codelineno-34-104 name=__codelineno-34-104></a><a href=#__codelineno-34-104><span class=linenos data-linenos="104 "></span></a>          <span class=n>priority</span><span class=p>,</span>
<a id=__codelineno-34-105 name=__codelineno-34-105></a><a href=#__codelineno-34-105><span class=linenos data-linenos="105 "></span></a>          <span class=n>diskCacheStrategy</span><span class=p>,</span>
<a id=__codelineno-34-106 name=__codelineno-34-106></a><a href=#__codelineno-34-106><span class=linenos data-linenos="106 "></span></a>          <span class=n>transformations</span><span class=p>,</span>
<a id=__codelineno-34-107 name=__codelineno-34-107></a><a href=#__codelineno-34-107><span class=linenos data-linenos="107 "></span></a>          <span class=n>isTransformationRequired</span><span class=p>,</span>
<a id=__codelineno-34-108 name=__codelineno-34-108></a><a href=#__codelineno-34-108><span class=linenos data-linenos="108 "></span></a>          <span class=n>isScaleOnlyOrNoTransform</span><span class=p>,</span>
<a id=__codelineno-34-109 name=__codelineno-34-109></a><a href=#__codelineno-34-109><span class=linenos data-linenos="109 "></span></a>          <span class=n>onlyRetrieveFromCache</span><span class=p>,</span>
<a id=__codelineno-34-110 name=__codelineno-34-110></a><a href=#__codelineno-34-110><span class=linenos data-linenos="110 "></span></a>          <span class=n>options</span><span class=p>,</span>
<a id=__codelineno-34-111 name=__codelineno-34-111></a><a href=#__codelineno-34-111><span class=linenos data-linenos="111 "></span></a>          <span class=n>engineJob</span><span class=p>);</span>
<a id=__codelineno-34-112 name=__codelineno-34-112></a><a href=#__codelineno-34-112><span class=linenos data-linenos="112 "></span></a>
<a id=__codelineno-34-113 name=__codelineno-34-113></a><a href=#__codelineno-34-113><span class=linenos data-linenos="113 "></span></a>  <span class=c1>// æ ¹æ®engineJob.onlyRetrieveFromCacheçš„å€¼æ˜¯å¦ä¸ºtrue</span>
<a id=__codelineno-34-114 name=__codelineno-34-114></a><a href=#__codelineno-34-114><span class=linenos data-linenos="114 "></span></a>  <span class=c1>// å°†engineJobä¿å­˜åˆ°onlyCacheJobsæˆ–è€…jobs HashMapä¸­</span>
<a id=__codelineno-34-115 name=__codelineno-34-115></a><a href=#__codelineno-34-115><span class=linenos data-linenos="115 "></span></a>  <span class=n>jobs</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>engineJob</span><span class=p>);</span>
<a id=__codelineno-34-116 name=__codelineno-34-116></a><a href=#__codelineno-34-116><span class=linenos data-linenos="116 "></span></a>
<a id=__codelineno-34-117 name=__codelineno-34-117></a><a href=#__codelineno-34-117><span class=linenos data-linenos="117 "></span></a>  <span class=c1>// æ·»åŠ èµ„æºåŠ è½½çŠ¶æ€å›è°ƒï¼Œå‚æ•°ä¼šåŒ…è£…æˆResourceCallbackAndExecutorç±»å‹</span>
<a id=__codelineno-34-118 name=__codelineno-34-118></a><a href=#__codelineno-34-118><span class=linenos data-linenos="118 "></span></a>  <span class=c1>// å¹¶ä¿å­˜åˆ°ResourceCallbacksAndExecutors.callbacksAndExecutorsä¸­</span>
<a id=__codelineno-34-119 name=__codelineno-34-119></a><a href=#__codelineno-34-119><span class=linenos data-linenos="119 "></span></a>  <span class=n>engineJob</span><span class=p>.</span><span class=na>addCallback</span><span class=p>(</span><span class=n>cb</span><span class=p>,</span> <span class=n>callbackExecutor</span><span class=p>);</span>
<a id=__codelineno-34-120 name=__codelineno-34-120></a><a href=#__codelineno-34-120><span class=linenos data-linenos="120 "></span></a>  <span class=c1>// ğŸ”¥ğŸ”¥ğŸ”¥å¼€å§‹æ‰§è¡ŒdecodeJobä»»åŠ¡</span>
<a id=__codelineno-34-121 name=__codelineno-34-121></a><a href=#__codelineno-34-121><span class=linenos data-linenos="121 "></span></a>  <span class=n>engineJob</span><span class=p>.</span><span class=na>start</span><span class=p>(</span><span class=n>decodeJob</span><span class=p>);</span>
<a id=__codelineno-34-122 name=__codelineno-34-122></a><a href=#__codelineno-34-122><span class=linenos data-linenos="122 "></span></a>
<a id=__codelineno-34-123 name=__codelineno-34-123></a><a href=#__codelineno-34-123><span class=linenos data-linenos="123 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>VERBOSE_IS_LOGGABLE</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-34-124 name=__codelineno-34-124></a><a href=#__codelineno-34-124><span class=linenos data-linenos="124 "></span></a>    <span class=n>logWithTimeAndKey</span><span class=p>(</span><span class=s>&quot;Started new load&quot;</span><span class=p>,</span> <span class=n>startTime</span><span class=p>,</span> <span class=n>key</span><span class=p>);</span>
<a id=__codelineno-34-125 name=__codelineno-34-125></a><a href=#__codelineno-34-125><span class=linenos data-linenos="125 "></span></a>  <span class=p>}</span>
<a id=__codelineno-34-126 name=__codelineno-34-126></a><a href=#__codelineno-34-126><span class=linenos data-linenos="126 "></span></a>  <span class=k>return</span> <span class=k>new</span> <span class=n>LoadStatus</span><span class=p>(</span><span class=n>cb</span><span class=p>,</span> <span class=n>engineJob</span><span class=p>);</span>
<a id=__codelineno-34-127 name=__codelineno-34-127></a><a href=#__codelineno-34-127><span class=linenos data-linenos="127 "></span></a><span class=p>}</span>
</code></pre></div> <p>åœ¨ä¸Šé¢çš„è¿™æ®µä»£ç ä¸­ï¼Œä»å„ä¸ªä½ç½®å–èµ„æºæ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œè¿™é‡Œä¸å¤šè¯´äº†ã€‚<br> <code>engineJobFactory</code>ä¸<code>decodeJobFactory</code>ä¸¤ä¸ªFactoryå­˜åœ¨çš„æ„ä¹‰åœ¨äºé‡Œé¢ä½¿ç”¨äº†å¯¹è±¡æ± Pools.Poolã€‚ä»¥<code>DecodeJobFactory</code>ä¸ºä¾‹ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-35-1 name=__codelineno-35-1></a><a href=#__codelineno-35-1><span class=linenos data-linenos="  1 "></span></a><span class=nd>@VisibleForTesting</span>
<a id=__codelineno-35-2 name=__codelineno-35-2></a><a href=#__codelineno-35-2><span class=linenos data-linenos="  2 "></span></a><span class=kd>static</span> <span class=kd>class</span> <span class=nc>DecodeJobFactory</span> <span class=p>{</span>
<a id=__codelineno-35-3 name=__codelineno-35-3></a><a href=#__codelineno-35-3><span class=linenos data-linenos="  3 "></span></a>  <span class=p>...</span>
<a id=__codelineno-35-4 name=__codelineno-35-4></a><a href=#__codelineno-35-4><span class=linenos data-linenos="  4 "></span></a>  <span class=nd>@Synthetic</span> <span class=kd>final</span> <span class=n>Pools</span><span class=p>.</span><span class=na>Pool</span><span class=o>&lt;</span><span class=n>DecodeJob</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>pool</span> <span class=o>=</span>
<a id=__codelineno-35-5 name=__codelineno-35-5></a><a href=#__codelineno-35-5><span class=linenos data-linenos="  5 "></span></a>      <span class=n>FactoryPools</span><span class=p>.</span><span class=na>threadSafe</span><span class=p>(</span><span class=n>JOB_POOL_SIZE</span><span class=p>,</span>
<a id=__codelineno-35-6 name=__codelineno-35-6></a><a href=#__codelineno-35-6><span class=linenos data-linenos="  6 "></span></a>          <span class=k>new</span> <span class=n>FactoryPools</span><span class=p>.</span><span class=na>Factory</span><span class=o>&lt;</span><span class=n>DecodeJob</span><span class=o>&lt;?&gt;&gt;</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-35-7 name=__codelineno-35-7></a><a href=#__codelineno-35-7><span class=linenos data-linenos="  7 "></span></a>        <span class=nd>@Override</span>
<a id=__codelineno-35-8 name=__codelineno-35-8></a><a href=#__codelineno-35-8><span class=linenos data-linenos="  8 "></span></a>        <span class=kd>public</span> <span class=n>DecodeJob</span><span class=o>&lt;?&gt;</span> <span class=n>create</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-35-9 name=__codelineno-35-9></a><a href=#__codelineno-35-9><span class=linenos data-linenos="  9 "></span></a>          <span class=k>return</span> <span class=k>new</span> <span class=n>DecodeJob</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>diskCacheProvider</span><span class=p>,</span> <span class=n>pool</span><span class=p>);</span>
<a id=__codelineno-35-10 name=__codelineno-35-10></a><a href=#__codelineno-35-10><span class=linenos data-linenos=" 10 "></span></a>        <span class=p>}</span>
<a id=__codelineno-35-11 name=__codelineno-35-11></a><a href=#__codelineno-35-11><span class=linenos data-linenos=" 11 "></span></a>      <span class=p>});</span>
<a id=__codelineno-35-12 name=__codelineno-35-12></a><a href=#__codelineno-35-12><span class=linenos data-linenos=" 12 "></span></a>  <span class=p>...</span>
<a id=__codelineno-35-13 name=__codelineno-35-13></a><a href=#__codelineno-35-13><span class=linenos data-linenos=" 13 "></span></a>  <span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;unchecked&quot;</span><span class=p>)</span>
<a id=__codelineno-35-14 name=__codelineno-35-14></a><a href=#__codelineno-35-14><span class=linenos data-linenos=" 14 "></span></a>  <span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>DecodeJob</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=nf>build</span><span class=p>(...)</span> <span class=p>{</span>
<a id=__codelineno-35-15 name=__codelineno-35-15></a><a href=#__codelineno-35-15><span class=linenos data-linenos=" 15 "></span></a>    <span class=n>DecodeJob</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>((</span><span class=n>DecodeJob</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span><span class=p>)</span> <span class=n>pool</span><span class=p>.</span><span class=na>acquire</span><span class=p>());</span>
<a id=__codelineno-35-16 name=__codelineno-35-16></a><a href=#__codelineno-35-16><span class=linenos data-linenos=" 16 "></span></a>    <span class=k>return</span> <span class=n>result</span><span class=p>.</span><span class=na>init</span><span class=p>(...);</span>
<a id=__codelineno-35-17 name=__codelineno-35-17></a><a href=#__codelineno-35-17><span class=linenos data-linenos=" 17 "></span></a>  <span class=p>}</span>
<a id=__codelineno-35-18 name=__codelineno-35-18></a><a href=#__codelineno-35-18><span class=linenos data-linenos=" 18 "></span></a><span class=p>}</span>
<a id=__codelineno-35-19 name=__codelineno-35-19></a><a href=#__codelineno-35-19><span class=linenos data-linenos=" 19 "></span></a>
<a id=__codelineno-35-20 name=__codelineno-35-20></a><a href=#__codelineno-35-20><span class=linenos data-linenos=" 20 "></span></a><span class=c1>// FactoryPools.java</span>
<a id=__codelineno-35-21 name=__codelineno-35-21></a><a href=#__codelineno-35-21><span class=linenos data-linenos=" 21 "></span></a><span class=kd>public</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>FactoryPools</span> <span class=p>{</span>
<a id=__codelineno-35-22 name=__codelineno-35-22></a><a href=#__codelineno-35-22><span class=linenos data-linenos=" 22 "></span></a>  <span class=nd>@NonNull</span>
<a id=__codelineno-35-23 name=__codelineno-35-23></a><a href=#__codelineno-35-23><span class=linenos data-linenos=" 23 "></span></a>  <span class=kd>public</span> <span class=kd>static</span> <span class=o>&lt;</span><span class=n>T</span> <span class=kd>extends</span> <span class=n>Poolable</span><span class=o>&gt;</span> <span class=n>Pool</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=nf>threadSafe</span><span class=p>(</span><span class=kt>int</span> <span class=n>size</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Factory</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>factory</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-35-24 name=__codelineno-35-24></a><a href=#__codelineno-35-24><span class=linenos data-linenos=" 24 "></span></a>    <span class=k>return</span> <span class=n>build</span><span class=p>(</span><span class=k>new</span> <span class=n>SynchronizedPool</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=p>(</span><span class=n>size</span><span class=p>),</span> <span class=n>factory</span><span class=p>);</span>
<a id=__codelineno-35-25 name=__codelineno-35-25></a><a href=#__codelineno-35-25><span class=linenos data-linenos=" 25 "></span></a>  <span class=p>}</span>
<a id=__codelineno-35-26 name=__codelineno-35-26></a><a href=#__codelineno-35-26><span class=linenos data-linenos=" 26 "></span></a>
<a id=__codelineno-35-27 name=__codelineno-35-27></a><a href=#__codelineno-35-27><span class=linenos data-linenos=" 27 "></span></a>  <span class=nd>@NonNull</span>
<a id=__codelineno-35-28 name=__codelineno-35-28></a><a href=#__codelineno-35-28><span class=linenos data-linenos=" 28 "></span></a>  <span class=kd>private</span> <span class=kd>static</span> <span class=o>&lt;</span><span class=n>T</span> <span class=kd>extends</span> <span class=n>Poolable</span><span class=o>&gt;</span> <span class=n>Pool</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=nf>build</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Pool</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>pool</span><span class=p>,</span>
<a id=__codelineno-35-29 name=__codelineno-35-29></a><a href=#__codelineno-35-29><span class=linenos data-linenos=" 29 "></span></a>      <span class=nd>@NonNull</span> <span class=n>Factory</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>factory</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-35-30 name=__codelineno-35-30></a><a href=#__codelineno-35-30><span class=linenos data-linenos=" 30 "></span></a>    <span class=k>return</span> <span class=n>build</span><span class=p>(</span><span class=n>pool</span><span class=p>,</span> <span class=n>factory</span><span class=p>,</span> <span class=n>FactoryPools</span><span class=p>.</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span><span class=n>emptyResetter</span><span class=p>());</span>
<a id=__codelineno-35-31 name=__codelineno-35-31></a><a href=#__codelineno-35-31><span class=linenos data-linenos=" 31 "></span></a>  <span class=p>}</span>
<a id=__codelineno-35-32 name=__codelineno-35-32></a><a href=#__codelineno-35-32><span class=linenos data-linenos=" 32 "></span></a>
<a id=__codelineno-35-33 name=__codelineno-35-33></a><a href=#__codelineno-35-33><span class=linenos data-linenos=" 33 "></span></a>  <span class=nd>@NonNull</span>
<a id=__codelineno-35-34 name=__codelineno-35-34></a><a href=#__codelineno-35-34><span class=linenos data-linenos=" 34 "></span></a>  <span class=kd>private</span> <span class=kd>static</span> <span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>Pool</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=nf>build</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Pool</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>pool</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Factory</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>factory</span><span class=p>,</span>
<a id=__codelineno-35-35 name=__codelineno-35-35></a><a href=#__codelineno-35-35><span class=linenos data-linenos=" 35 "></span></a>      <span class=nd>@NonNull</span> <span class=n>Resetter</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>resetter</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-35-36 name=__codelineno-35-36></a><a href=#__codelineno-35-36><span class=linenos data-linenos=" 36 "></span></a>    <span class=k>return</span> <span class=k>new</span> <span class=n>FactoryPool</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>pool</span><span class=p>,</span> <span class=n>factory</span><span class=p>,</span> <span class=n>resetter</span><span class=p>);</span>
<a id=__codelineno-35-37 name=__codelineno-35-37></a><a href=#__codelineno-35-37><span class=linenos data-linenos=" 37 "></span></a>  <span class=p>}</span>
<a id=__codelineno-35-38 name=__codelineno-35-38></a><a href=#__codelineno-35-38><span class=linenos data-linenos=" 38 "></span></a>
<a id=__codelineno-35-39 name=__codelineno-35-39></a><a href=#__codelineno-35-39><span class=linenos data-linenos=" 39 "></span></a>  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>FactoryPool</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=kd>implements</span> <span class=n>Pool</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=p>{</span>
<a id=__codelineno-35-40 name=__codelineno-35-40></a><a href=#__codelineno-35-40><span class=linenos data-linenos=" 40 "></span></a>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>Factory</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>factory</span><span class=p>;</span>
<a id=__codelineno-35-41 name=__codelineno-35-41></a><a href=#__codelineno-35-41><span class=linenos data-linenos=" 41 "></span></a>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>Resetter</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>resetter</span><span class=p>;</span>
<a id=__codelineno-35-42 name=__codelineno-35-42></a><a href=#__codelineno-35-42><span class=linenos data-linenos=" 42 "></span></a>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>Pool</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>pool</span><span class=p>;</span>
<a id=__codelineno-35-43 name=__codelineno-35-43></a><a href=#__codelineno-35-43><span class=linenos data-linenos=" 43 "></span></a>
<a id=__codelineno-35-44 name=__codelineno-35-44></a><a href=#__codelineno-35-44><span class=linenos data-linenos=" 44 "></span></a>    <span class=n>FactoryPool</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Pool</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>pool</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Factory</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>factory</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Resetter</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>resetter</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-35-45 name=__codelineno-35-45></a><a href=#__codelineno-35-45><span class=linenos data-linenos=" 45 "></span></a>      <span class=k>this</span><span class=p>.</span><span class=na>pool</span> <span class=o>=</span> <span class=n>pool</span><span class=p>;</span>
<a id=__codelineno-35-46 name=__codelineno-35-46></a><a href=#__codelineno-35-46><span class=linenos data-linenos=" 46 "></span></a>      <span class=k>this</span><span class=p>.</span><span class=na>factory</span> <span class=o>=</span> <span class=n>factory</span><span class=p>;</span>
<a id=__codelineno-35-47 name=__codelineno-35-47></a><a href=#__codelineno-35-47><span class=linenos data-linenos=" 47 "></span></a>      <span class=k>this</span><span class=p>.</span><span class=na>resetter</span> <span class=o>=</span> <span class=n>resetter</span><span class=p>;</span>
<a id=__codelineno-35-48 name=__codelineno-35-48></a><a href=#__codelineno-35-48><span class=linenos data-linenos=" 48 "></span></a>    <span class=p>}</span>
<a id=__codelineno-35-49 name=__codelineno-35-49></a><a href=#__codelineno-35-49><span class=linenos data-linenos=" 49 "></span></a>
<a id=__codelineno-35-50 name=__codelineno-35-50></a><a href=#__codelineno-35-50><span class=linenos data-linenos=" 50 "></span></a>    <span class=nd>@Override</span>
<a id=__codelineno-35-51 name=__codelineno-35-51></a><a href=#__codelineno-35-51><span class=linenos data-linenos=" 51 "></span></a>    <span class=kd>public</span> <span class=n>T</span> <span class=nf>acquire</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-35-52 name=__codelineno-35-52></a><a href=#__codelineno-35-52><span class=linenos data-linenos=" 52 "></span></a>      <span class=n>T</span> <span class=n>result</span> <span class=o>=</span> <span class=n>pool</span><span class=p>.</span><span class=na>acquire</span><span class=p>();</span>
<a id=__codelineno-35-53 name=__codelineno-35-53></a><a href=#__codelineno-35-53><span class=linenos data-linenos=" 53 "></span></a>      <span class=k>if</span> <span class=p>(</span><span class=n>result</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-35-54 name=__codelineno-35-54></a><a href=#__codelineno-35-54><span class=linenos data-linenos=" 54 "></span></a>        <span class=n>result</span> <span class=o>=</span> <span class=n>factory</span><span class=p>.</span><span class=na>create</span><span class=p>();</span>
<a id=__codelineno-35-55 name=__codelineno-35-55></a><a href=#__codelineno-35-55><span class=linenos data-linenos=" 55 "></span></a>        <span class=k>if</span> <span class=p>(</span><span class=n>Log</span><span class=p>.</span><span class=na>isLoggable</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=n>Log</span><span class=p>.</span><span class=na>VERBOSE</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-35-56 name=__codelineno-35-56></a><a href=#__codelineno-35-56><span class=linenos data-linenos=" 56 "></span></a>          <span class=n>Log</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s>&quot;Created new &quot;</span> <span class=o>+</span> <span class=n>result</span><span class=p>.</span><span class=na>getClass</span><span class=p>());</span>
<a id=__codelineno-35-57 name=__codelineno-35-57></a><a href=#__codelineno-35-57><span class=linenos data-linenos=" 57 "></span></a>        <span class=p>}</span>
<a id=__codelineno-35-58 name=__codelineno-35-58></a><a href=#__codelineno-35-58><span class=linenos data-linenos=" 58 "></span></a>      <span class=p>}</span>
<a id=__codelineno-35-59 name=__codelineno-35-59></a><a href=#__codelineno-35-59><span class=linenos data-linenos=" 59 "></span></a>      <span class=k>if</span> <span class=p>(</span><span class=n>result</span> <span class=k>instanceof</span> <span class=n>Poolable</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-35-60 name=__codelineno-35-60></a><a href=#__codelineno-35-60><span class=linenos data-linenos=" 60 "></span></a>        <span class=p>((</span><span class=n>Poolable</span><span class=p>)</span> <span class=n>result</span><span class=p>).</span><span class=na>getVerifier</span><span class=p>().</span><span class=na>setRecycled</span><span class=p>(</span><span class=kc>false</span> <span class=cm>/*isRecycled*/</span><span class=p>);</span>
<a id=__codelineno-35-61 name=__codelineno-35-61></a><a href=#__codelineno-35-61><span class=linenos data-linenos=" 61 "></span></a>      <span class=p>}</span>
<a id=__codelineno-35-62 name=__codelineno-35-62></a><a href=#__codelineno-35-62><span class=linenos data-linenos=" 62 "></span></a>      <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
<a id=__codelineno-35-63 name=__codelineno-35-63></a><a href=#__codelineno-35-63><span class=linenos data-linenos=" 63 "></span></a>    <span class=p>}</span>
<a id=__codelineno-35-64 name=__codelineno-35-64></a><a href=#__codelineno-35-64><span class=linenos data-linenos=" 64 "></span></a>
<a id=__codelineno-35-65 name=__codelineno-35-65></a><a href=#__codelineno-35-65><span class=linenos data-linenos=" 65 "></span></a>    <span class=nd>@Override</span>
<a id=__codelineno-35-66 name=__codelineno-35-66></a><a href=#__codelineno-35-66><span class=linenos data-linenos=" 66 "></span></a>    <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>release</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>T</span> <span class=n>instance</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-35-67 name=__codelineno-35-67></a><a href=#__codelineno-35-67><span class=linenos data-linenos=" 67 "></span></a>      <span class=k>if</span> <span class=p>(</span><span class=n>instance</span> <span class=k>instanceof</span> <span class=n>Poolable</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-35-68 name=__codelineno-35-68></a><a href=#__codelineno-35-68><span class=linenos data-linenos=" 68 "></span></a>        <span class=p>((</span><span class=n>Poolable</span><span class=p>)</span> <span class=n>instance</span><span class=p>).</span><span class=na>getVerifier</span><span class=p>().</span><span class=na>setRecycled</span><span class=p>(</span><span class=kc>true</span> <span class=cm>/*isRecycled*/</span><span class=p>);</span>
<a id=__codelineno-35-69 name=__codelineno-35-69></a><a href=#__codelineno-35-69><span class=linenos data-linenos=" 69 "></span></a>      <span class=p>}</span>
<a id=__codelineno-35-70 name=__codelineno-35-70></a><a href=#__codelineno-35-70><span class=linenos data-linenos=" 70 "></span></a>      <span class=n>resetter</span><span class=p>.</span><span class=na>reset</span><span class=p>(</span><span class=n>instance</span><span class=p>);</span>
<a id=__codelineno-35-71 name=__codelineno-35-71></a><a href=#__codelineno-35-71><span class=linenos data-linenos=" 71 "></span></a>      <span class=k>return</span> <span class=n>pool</span><span class=p>.</span><span class=na>release</span><span class=p>(</span><span class=n>instance</span><span class=p>);</span>
<a id=__codelineno-35-72 name=__codelineno-35-72></a><a href=#__codelineno-35-72><span class=linenos data-linenos=" 72 "></span></a>    <span class=p>}</span>
<a id=__codelineno-35-73 name=__codelineno-35-73></a><a href=#__codelineno-35-73><span class=linenos data-linenos=" 73 "></span></a>  <span class=p>}</span>
<a id=__codelineno-35-74 name=__codelineno-35-74></a><a href=#__codelineno-35-74><span class=linenos data-linenos=" 74 "></span></a><span class=p>}</span>
<a id=__codelineno-35-75 name=__codelineno-35-75></a><a href=#__codelineno-35-75><span class=linenos data-linenos=" 75 "></span></a>
<a id=__codelineno-35-76 name=__codelineno-35-76></a><a href=#__codelineno-35-76><span class=linenos data-linenos=" 76 "></span></a><span class=c1>// Pools</span>
<a id=__codelineno-35-77 name=__codelineno-35-77></a><a href=#__codelineno-35-77><span class=linenos data-linenos=" 77 "></span></a><span class=kd>public</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>Pools</span> <span class=p>{</span>
<a id=__codelineno-35-78 name=__codelineno-35-78></a><a href=#__codelineno-35-78><span class=linenos data-linenos=" 78 "></span></a>
<a id=__codelineno-35-79 name=__codelineno-35-79></a><a href=#__codelineno-35-79><span class=linenos data-linenos=" 79 "></span></a>    <span class=cm>/**</span>
<a id=__codelineno-35-80 name=__codelineno-35-80></a><a href=#__codelineno-35-80><span class=linenos data-linenos=" 80 "></span></a><span class=cm>     * Interface for managing a pool of objects.</span>
<a id=__codelineno-35-81 name=__codelineno-35-81></a><a href=#__codelineno-35-81><span class=linenos data-linenos=" 81 "></span></a><span class=cm>     *</span>
<a id=__codelineno-35-82 name=__codelineno-35-82></a><a href=#__codelineno-35-82><span class=linenos data-linenos=" 82 "></span></a><span class=cm>     * @param &lt;T&gt; The pooled type.</span>
<a id=__codelineno-35-83 name=__codelineno-35-83></a><a href=#__codelineno-35-83><span class=linenos data-linenos=" 83 "></span></a><span class=cm>     */</span>
<a id=__codelineno-35-84 name=__codelineno-35-84></a><a href=#__codelineno-35-84><span class=linenos data-linenos=" 84 "></span></a>    <span class=kd>public</span> <span class=kd>interface</span> <span class=nc>Pool</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=p>{</span>
<a id=__codelineno-35-85 name=__codelineno-35-85></a><a href=#__codelineno-35-85><span class=linenos data-linenos=" 85 "></span></a>
<a id=__codelineno-35-86 name=__codelineno-35-86></a><a href=#__codelineno-35-86><span class=linenos data-linenos=" 86 "></span></a>        <span class=cm>/**</span>
<a id=__codelineno-35-87 name=__codelineno-35-87></a><a href=#__codelineno-35-87><span class=linenos data-linenos=" 87 "></span></a><span class=cm>         * @return An instance from the pool if such, null otherwise.</span>
<a id=__codelineno-35-88 name=__codelineno-35-88></a><a href=#__codelineno-35-88><span class=linenos data-linenos=" 88 "></span></a><span class=cm>         */</span>
<a id=__codelineno-35-89 name=__codelineno-35-89></a><a href=#__codelineno-35-89><span class=linenos data-linenos=" 89 "></span></a>        <span class=nd>@Nullable</span>
<a id=__codelineno-35-90 name=__codelineno-35-90></a><a href=#__codelineno-35-90><span class=linenos data-linenos=" 90 "></span></a>        <span class=n>T</span> <span class=nf>acquire</span><span class=p>();</span>
<a id=__codelineno-35-91 name=__codelineno-35-91></a><a href=#__codelineno-35-91><span class=linenos data-linenos=" 91 "></span></a>
<a id=__codelineno-35-92 name=__codelineno-35-92></a><a href=#__codelineno-35-92><span class=linenos data-linenos=" 92 "></span></a>        <span class=cm>/**</span>
<a id=__codelineno-35-93 name=__codelineno-35-93></a><a href=#__codelineno-35-93><span class=linenos data-linenos=" 93 "></span></a><span class=cm>         * Release an instance to the pool.</span>
<a id=__codelineno-35-94 name=__codelineno-35-94></a><a href=#__codelineno-35-94><span class=linenos data-linenos=" 94 "></span></a><span class=cm>         *</span>
<a id=__codelineno-35-95 name=__codelineno-35-95></a><a href=#__codelineno-35-95><span class=linenos data-linenos=" 95 "></span></a><span class=cm>         * @param instance The instance to release.</span>
<a id=__codelineno-35-96 name=__codelineno-35-96></a><a href=#__codelineno-35-96><span class=linenos data-linenos=" 96 "></span></a><span class=cm>         * @return Whether the instance was put in the pool.</span>
<a id=__codelineno-35-97 name=__codelineno-35-97></a><a href=#__codelineno-35-97><span class=linenos data-linenos=" 97 "></span></a><span class=cm>         *</span>
<a id=__codelineno-35-98 name=__codelineno-35-98></a><a href=#__codelineno-35-98><span class=linenos data-linenos=" 98 "></span></a><span class=cm>         * @throws IllegalStateException If the instance is already in the pool.</span>
<a id=__codelineno-35-99 name=__codelineno-35-99></a><a href=#__codelineno-35-99><span class=linenos data-linenos=" 99 "></span></a><span class=cm>         */</span>
<a id=__codelineno-35-100 name=__codelineno-35-100></a><a href=#__codelineno-35-100><span class=linenos data-linenos="100 "></span></a>        <span class=kt>boolean</span> <span class=nf>release</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>T</span> <span class=n>instance</span><span class=p>);</span>
<a id=__codelineno-35-101 name=__codelineno-35-101></a><a href=#__codelineno-35-101><span class=linenos data-linenos="101 "></span></a>    <span class=p>}</span>
<a id=__codelineno-35-102 name=__codelineno-35-102></a><a href=#__codelineno-35-102><span class=linenos data-linenos="102 "></span></a>
<a id=__codelineno-35-103 name=__codelineno-35-103></a><a href=#__codelineno-35-103><span class=linenos data-linenos="103 "></span></a>    <span class=kd>private</span> <span class=nf>Pools</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-35-104 name=__codelineno-35-104></a><a href=#__codelineno-35-104><span class=linenos data-linenos="104 "></span></a>        <span class=cm>/* do nothing - hiding constructor */</span>
<a id=__codelineno-35-105 name=__codelineno-35-105></a><a href=#__codelineno-35-105><span class=linenos data-linenos="105 "></span></a>    <span class=p>}</span>
<a id=__codelineno-35-106 name=__codelineno-35-106></a><a href=#__codelineno-35-106><span class=linenos data-linenos="106 "></span></a>
<a id=__codelineno-35-107 name=__codelineno-35-107></a><a href=#__codelineno-35-107><span class=linenos data-linenos="107 "></span></a>    <span class=cm>/**</span>
<a id=__codelineno-35-108 name=__codelineno-35-108></a><a href=#__codelineno-35-108><span class=linenos data-linenos="108 "></span></a><span class=cm>     * Simple (non-synchronized) pool of objects.</span>
<a id=__codelineno-35-109 name=__codelineno-35-109></a><a href=#__codelineno-35-109><span class=linenos data-linenos="109 "></span></a><span class=cm>     *</span>
<a id=__codelineno-35-110 name=__codelineno-35-110></a><a href=#__codelineno-35-110><span class=linenos data-linenos="110 "></span></a><span class=cm>     * @param &lt;T&gt; The pooled type.</span>
<a id=__codelineno-35-111 name=__codelineno-35-111></a><a href=#__codelineno-35-111><span class=linenos data-linenos="111 "></span></a><span class=cm>     */</span>
<a id=__codelineno-35-112 name=__codelineno-35-112></a><a href=#__codelineno-35-112><span class=linenos data-linenos="112 "></span></a>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>SimplePool</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=kd>implements</span> <span class=n>Pool</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=p>{</span>
<a id=__codelineno-35-113 name=__codelineno-35-113></a><a href=#__codelineno-35-113><span class=linenos data-linenos="113 "></span></a>        <span class=kd>private</span> <span class=kd>final</span> <span class=n>Object</span><span class=o>[]</span> <span class=n>mPool</span><span class=p>;</span>
<a id=__codelineno-35-114 name=__codelineno-35-114></a><a href=#__codelineno-35-114><span class=linenos data-linenos="114 "></span></a>
<a id=__codelineno-35-115 name=__codelineno-35-115></a><a href=#__codelineno-35-115><span class=linenos data-linenos="115 "></span></a>        <span class=kd>private</span> <span class=kt>int</span> <span class=n>mPoolSize</span><span class=p>;</span>
<a id=__codelineno-35-116 name=__codelineno-35-116></a><a href=#__codelineno-35-116><span class=linenos data-linenos="116 "></span></a>
<a id=__codelineno-35-117 name=__codelineno-35-117></a><a href=#__codelineno-35-117><span class=linenos data-linenos="117 "></span></a>        <span class=cm>/**</span>
<a id=__codelineno-35-118 name=__codelineno-35-118></a><a href=#__codelineno-35-118><span class=linenos data-linenos="118 "></span></a><span class=cm>         * Creates a new instance.</span>
<a id=__codelineno-35-119 name=__codelineno-35-119></a><a href=#__codelineno-35-119><span class=linenos data-linenos="119 "></span></a><span class=cm>         *</span>
<a id=__codelineno-35-120 name=__codelineno-35-120></a><a href=#__codelineno-35-120><span class=linenos data-linenos="120 "></span></a><span class=cm>         * @param maxPoolSize The max pool size.</span>
<a id=__codelineno-35-121 name=__codelineno-35-121></a><a href=#__codelineno-35-121><span class=linenos data-linenos="121 "></span></a><span class=cm>         *</span>
<a id=__codelineno-35-122 name=__codelineno-35-122></a><a href=#__codelineno-35-122><span class=linenos data-linenos="122 "></span></a><span class=cm>         * @throws IllegalArgumentException If the max pool size is less than zero.</span>
<a id=__codelineno-35-123 name=__codelineno-35-123></a><a href=#__codelineno-35-123><span class=linenos data-linenos="123 "></span></a><span class=cm>         */</span>
<a id=__codelineno-35-124 name=__codelineno-35-124></a><a href=#__codelineno-35-124><span class=linenos data-linenos="124 "></span></a>        <span class=kd>public</span> <span class=nf>SimplePool</span><span class=p>(</span><span class=kt>int</span> <span class=n>maxPoolSize</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-35-125 name=__codelineno-35-125></a><a href=#__codelineno-35-125><span class=linenos data-linenos="125 "></span></a>            <span class=k>if</span> <span class=p>(</span><span class=n>maxPoolSize</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-35-126 name=__codelineno-35-126></a><a href=#__codelineno-35-126><span class=linenos data-linenos="126 "></span></a>                <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&quot;The max pool size must be &gt; 0&quot;</span><span class=p>);</span>
<a id=__codelineno-35-127 name=__codelineno-35-127></a><a href=#__codelineno-35-127><span class=linenos data-linenos="127 "></span></a>            <span class=p>}</span>
<a id=__codelineno-35-128 name=__codelineno-35-128></a><a href=#__codelineno-35-128><span class=linenos data-linenos="128 "></span></a>            <span class=n>mPool</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Object</span><span class=o>[</span><span class=n>maxPoolSize</span><span class=o>]</span><span class=p>;</span>
<a id=__codelineno-35-129 name=__codelineno-35-129></a><a href=#__codelineno-35-129><span class=linenos data-linenos="129 "></span></a>        <span class=p>}</span>
<a id=__codelineno-35-130 name=__codelineno-35-130></a><a href=#__codelineno-35-130><span class=linenos data-linenos="130 "></span></a>
<a id=__codelineno-35-131 name=__codelineno-35-131></a><a href=#__codelineno-35-131><span class=linenos data-linenos="131 "></span></a>        <span class=nd>@Override</span>
<a id=__codelineno-35-132 name=__codelineno-35-132></a><a href=#__codelineno-35-132><span class=linenos data-linenos="132 "></span></a>        <span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;unchecked&quot;</span><span class=p>)</span>
<a id=__codelineno-35-133 name=__codelineno-35-133></a><a href=#__codelineno-35-133><span class=linenos data-linenos="133 "></span></a>        <span class=kd>public</span> <span class=n>T</span> <span class=nf>acquire</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-35-134 name=__codelineno-35-134></a><a href=#__codelineno-35-134><span class=linenos data-linenos="134 "></span></a>            <span class=k>if</span> <span class=p>(</span><span class=n>mPoolSize</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-35-135 name=__codelineno-35-135></a><a href=#__codelineno-35-135><span class=linenos data-linenos="135 "></span></a>                <span class=kd>final</span> <span class=kt>int</span> <span class=n>lastPooledIndex</span> <span class=o>=</span> <span class=n>mPoolSize</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span>
<a id=__codelineno-35-136 name=__codelineno-35-136></a><a href=#__codelineno-35-136><span class=linenos data-linenos="136 "></span></a>                <span class=n>T</span> <span class=n>instance</span> <span class=o>=</span> <span class=p>(</span><span class=n>T</span><span class=p>)</span> <span class=n>mPool</span><span class=o>[</span><span class=n>lastPooledIndex</span><span class=o>]</span><span class=p>;</span>
<a id=__codelineno-35-137 name=__codelineno-35-137></a><a href=#__codelineno-35-137><span class=linenos data-linenos="137 "></span></a>                <span class=n>mPool</span><span class=o>[</span><span class=n>lastPooledIndex</span><span class=o>]</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-35-138 name=__codelineno-35-138></a><a href=#__codelineno-35-138><span class=linenos data-linenos="138 "></span></a>                <span class=n>mPoolSize</span><span class=o>--</span><span class=p>;</span>
<a id=__codelineno-35-139 name=__codelineno-35-139></a><a href=#__codelineno-35-139><span class=linenos data-linenos="139 "></span></a>                <span class=k>return</span> <span class=n>instance</span><span class=p>;</span>
<a id=__codelineno-35-140 name=__codelineno-35-140></a><a href=#__codelineno-35-140><span class=linenos data-linenos="140 "></span></a>            <span class=p>}</span>
<a id=__codelineno-35-141 name=__codelineno-35-141></a><a href=#__codelineno-35-141><span class=linenos data-linenos="141 "></span></a>            <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-35-142 name=__codelineno-35-142></a><a href=#__codelineno-35-142><span class=linenos data-linenos="142 "></span></a>        <span class=p>}</span>
<a id=__codelineno-35-143 name=__codelineno-35-143></a><a href=#__codelineno-35-143><span class=linenos data-linenos="143 "></span></a>
<a id=__codelineno-35-144 name=__codelineno-35-144></a><a href=#__codelineno-35-144><span class=linenos data-linenos="144 "></span></a>        <span class=nd>@Override</span>
<a id=__codelineno-35-145 name=__codelineno-35-145></a><a href=#__codelineno-35-145><span class=linenos data-linenos="145 "></span></a>        <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>release</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>T</span> <span class=n>instance</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-35-146 name=__codelineno-35-146></a><a href=#__codelineno-35-146><span class=linenos data-linenos="146 "></span></a>            <span class=k>if</span> <span class=p>(</span><span class=n>isInPool</span><span class=p>(</span><span class=n>instance</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-35-147 name=__codelineno-35-147></a><a href=#__codelineno-35-147><span class=linenos data-linenos="147 "></span></a>                <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&quot;Already in the pool!&quot;</span><span class=p>);</span>
<a id=__codelineno-35-148 name=__codelineno-35-148></a><a href=#__codelineno-35-148><span class=linenos data-linenos="148 "></span></a>            <span class=p>}</span>
<a id=__codelineno-35-149 name=__codelineno-35-149></a><a href=#__codelineno-35-149><span class=linenos data-linenos="149 "></span></a>            <span class=k>if</span> <span class=p>(</span><span class=n>mPoolSize</span> <span class=o>&lt;</span> <span class=n>mPool</span><span class=p>.</span><span class=na>length</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-35-150 name=__codelineno-35-150></a><a href=#__codelineno-35-150><span class=linenos data-linenos="150 "></span></a>                <span class=n>mPool</span><span class=o>[</span><span class=n>mPoolSize</span><span class=o>]</span> <span class=o>=</span> <span class=n>instance</span><span class=p>;</span>
<a id=__codelineno-35-151 name=__codelineno-35-151></a><a href=#__codelineno-35-151><span class=linenos data-linenos="151 "></span></a>                <span class=n>mPoolSize</span><span class=o>++</span><span class=p>;</span>
<a id=__codelineno-35-152 name=__codelineno-35-152></a><a href=#__codelineno-35-152><span class=linenos data-linenos="152 "></span></a>                <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
<a id=__codelineno-35-153 name=__codelineno-35-153></a><a href=#__codelineno-35-153><span class=linenos data-linenos="153 "></span></a>            <span class=p>}</span>
<a id=__codelineno-35-154 name=__codelineno-35-154></a><a href=#__codelineno-35-154><span class=linenos data-linenos="154 "></span></a>            <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
<a id=__codelineno-35-155 name=__codelineno-35-155></a><a href=#__codelineno-35-155><span class=linenos data-linenos="155 "></span></a>        <span class=p>}</span>
<a id=__codelineno-35-156 name=__codelineno-35-156></a><a href=#__codelineno-35-156><span class=linenos data-linenos="156 "></span></a>
<a id=__codelineno-35-157 name=__codelineno-35-157></a><a href=#__codelineno-35-157><span class=linenos data-linenos="157 "></span></a>        <span class=kd>private</span> <span class=kt>boolean</span> <span class=nf>isInPool</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>T</span> <span class=n>instance</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-35-158 name=__codelineno-35-158></a><a href=#__codelineno-35-158><span class=linenos data-linenos="158 "></span></a>            <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>mPoolSize</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-35-159 name=__codelineno-35-159></a><a href=#__codelineno-35-159><span class=linenos data-linenos="159 "></span></a>                <span class=k>if</span> <span class=p>(</span><span class=n>mPool</span><span class=o>[</span><span class=n>i</span><span class=o>]</span> <span class=o>==</span> <span class=n>instance</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-35-160 name=__codelineno-35-160></a><a href=#__codelineno-35-160><span class=linenos data-linenos="160 "></span></a>                    <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
<a id=__codelineno-35-161 name=__codelineno-35-161></a><a href=#__codelineno-35-161><span class=linenos data-linenos="161 "></span></a>                <span class=p>}</span>
<a id=__codelineno-35-162 name=__codelineno-35-162></a><a href=#__codelineno-35-162><span class=linenos data-linenos="162 "></span></a>            <span class=p>}</span>
<a id=__codelineno-35-163 name=__codelineno-35-163></a><a href=#__codelineno-35-163><span class=linenos data-linenos="163 "></span></a>            <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
<a id=__codelineno-35-164 name=__codelineno-35-164></a><a href=#__codelineno-35-164><span class=linenos data-linenos="164 "></span></a>        <span class=p>}</span>
<a id=__codelineno-35-165 name=__codelineno-35-165></a><a href=#__codelineno-35-165><span class=linenos data-linenos="165 "></span></a>    <span class=p>}</span>
<a id=__codelineno-35-166 name=__codelineno-35-166></a><a href=#__codelineno-35-166><span class=linenos data-linenos="166 "></span></a>
<a id=__codelineno-35-167 name=__codelineno-35-167></a><a href=#__codelineno-35-167><span class=linenos data-linenos="167 "></span></a>    <span class=cm>/**</span>
<a id=__codelineno-35-168 name=__codelineno-35-168></a><a href=#__codelineno-35-168><span class=linenos data-linenos="168 "></span></a><span class=cm>     * Synchronized) pool of objects.</span>
<a id=__codelineno-35-169 name=__codelineno-35-169></a><a href=#__codelineno-35-169><span class=linenos data-linenos="169 "></span></a><span class=cm>     *</span>
<a id=__codelineno-35-170 name=__codelineno-35-170></a><a href=#__codelineno-35-170><span class=linenos data-linenos="170 "></span></a><span class=cm>     * @param &lt;T&gt; The pooled type.</span>
<a id=__codelineno-35-171 name=__codelineno-35-171></a><a href=#__codelineno-35-171><span class=linenos data-linenos="171 "></span></a><span class=cm>     */</span>
<a id=__codelineno-35-172 name=__codelineno-35-172></a><a href=#__codelineno-35-172><span class=linenos data-linenos="172 "></span></a>    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>SynchronizedPool</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=kd>extends</span> <span class=n>SimplePool</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=p>{</span>
<a id=__codelineno-35-173 name=__codelineno-35-173></a><a href=#__codelineno-35-173><span class=linenos data-linenos="173 "></span></a>        <span class=kd>private</span> <span class=kd>final</span> <span class=n>Object</span> <span class=n>mLock</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Object</span><span class=p>();</span>
<a id=__codelineno-35-174 name=__codelineno-35-174></a><a href=#__codelineno-35-174><span class=linenos data-linenos="174 "></span></a>
<a id=__codelineno-35-175 name=__codelineno-35-175></a><a href=#__codelineno-35-175><span class=linenos data-linenos="175 "></span></a>        <span class=cm>/**</span>
<a id=__codelineno-35-176 name=__codelineno-35-176></a><a href=#__codelineno-35-176><span class=linenos data-linenos="176 "></span></a><span class=cm>         * Creates a new instance.</span>
<a id=__codelineno-35-177 name=__codelineno-35-177></a><a href=#__codelineno-35-177><span class=linenos data-linenos="177 "></span></a><span class=cm>         *</span>
<a id=__codelineno-35-178 name=__codelineno-35-178></a><a href=#__codelineno-35-178><span class=linenos data-linenos="178 "></span></a><span class=cm>         * @param maxPoolSize The max pool size.</span>
<a id=__codelineno-35-179 name=__codelineno-35-179></a><a href=#__codelineno-35-179><span class=linenos data-linenos="179 "></span></a><span class=cm>         *</span>
<a id=__codelineno-35-180 name=__codelineno-35-180></a><a href=#__codelineno-35-180><span class=linenos data-linenos="180 "></span></a><span class=cm>         * @throws IllegalArgumentException If the max pool size is less than zero.</span>
<a id=__codelineno-35-181 name=__codelineno-35-181></a><a href=#__codelineno-35-181><span class=linenos data-linenos="181 "></span></a><span class=cm>         */</span>
<a id=__codelineno-35-182 name=__codelineno-35-182></a><a href=#__codelineno-35-182><span class=linenos data-linenos="182 "></span></a>        <span class=kd>public</span> <span class=nf>SynchronizedPool</span><span class=p>(</span><span class=kt>int</span> <span class=n>maxPoolSize</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-35-183 name=__codelineno-35-183></a><a href=#__codelineno-35-183><span class=linenos data-linenos="183 "></span></a>            <span class=kd>super</span><span class=p>(</span><span class=n>maxPoolSize</span><span class=p>);</span>
<a id=__codelineno-35-184 name=__codelineno-35-184></a><a href=#__codelineno-35-184><span class=linenos data-linenos="184 "></span></a>        <span class=p>}</span>
<a id=__codelineno-35-185 name=__codelineno-35-185></a><a href=#__codelineno-35-185><span class=linenos data-linenos="185 "></span></a>
<a id=__codelineno-35-186 name=__codelineno-35-186></a><a href=#__codelineno-35-186><span class=linenos data-linenos="186 "></span></a>        <span class=nd>@Override</span>
<a id=__codelineno-35-187 name=__codelineno-35-187></a><a href=#__codelineno-35-187><span class=linenos data-linenos="187 "></span></a>        <span class=kd>public</span> <span class=n>T</span> <span class=nf>acquire</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-35-188 name=__codelineno-35-188></a><a href=#__codelineno-35-188><span class=linenos data-linenos="188 "></span></a>            <span class=kd>synchronized</span> <span class=p>(</span><span class=n>mLock</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-35-189 name=__codelineno-35-189></a><a href=#__codelineno-35-189><span class=linenos data-linenos="189 "></span></a>                <span class=k>return</span> <span class=kd>super</span><span class=p>.</span><span class=na>acquire</span><span class=p>();</span>
<a id=__codelineno-35-190 name=__codelineno-35-190></a><a href=#__codelineno-35-190><span class=linenos data-linenos="190 "></span></a>            <span class=p>}</span>
<a id=__codelineno-35-191 name=__codelineno-35-191></a><a href=#__codelineno-35-191><span class=linenos data-linenos="191 "></span></a>        <span class=p>}</span>
<a id=__codelineno-35-192 name=__codelineno-35-192></a><a href=#__codelineno-35-192><span class=linenos data-linenos="192 "></span></a>
<a id=__codelineno-35-193 name=__codelineno-35-193></a><a href=#__codelineno-35-193><span class=linenos data-linenos="193 "></span></a>        <span class=nd>@Override</span>
<a id=__codelineno-35-194 name=__codelineno-35-194></a><a href=#__codelineno-35-194><span class=linenos data-linenos="194 "></span></a>        <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>release</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>T</span> <span class=n>element</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-35-195 name=__codelineno-35-195></a><a href=#__codelineno-35-195><span class=linenos data-linenos="195 "></span></a>            <span class=kd>synchronized</span> <span class=p>(</span><span class=n>mLock</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-35-196 name=__codelineno-35-196></a><a href=#__codelineno-35-196><span class=linenos data-linenos="196 "></span></a>                <span class=k>return</span> <span class=kd>super</span><span class=p>.</span><span class=na>release</span><span class=p>(</span><span class=n>element</span><span class=p>);</span>
<a id=__codelineno-35-197 name=__codelineno-35-197></a><a href=#__codelineno-35-197><span class=linenos data-linenos="197 "></span></a>            <span class=p>}</span>
<a id=__codelineno-35-198 name=__codelineno-35-198></a><a href=#__codelineno-35-198><span class=linenos data-linenos="198 "></span></a>        <span class=p>}</span>
<a id=__codelineno-35-199 name=__codelineno-35-199></a><a href=#__codelineno-35-199><span class=linenos data-linenos="199 "></span></a>    <span class=p>}</span>
<a id=__codelineno-35-200 name=__codelineno-35-200></a><a href=#__codelineno-35-200><span class=linenos data-linenos="200 "></span></a><span class=p>}</span>
</code></pre></div> <p>æ¥ç€çœ‹çœ‹<code>engineJob.start(decodeJob)</code>è¿™å¥ä»£ç ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-36-1 name=__codelineno-36-1></a><a href=#__codelineno-36-1><span class=linenos data-linenos=" 1 "></span></a><span class=c1>// EngineJob</span>
<a id=__codelineno-36-2 name=__codelineno-36-2></a><a href=#__codelineno-36-2><span class=linenos data-linenos=" 2 "></span></a><span class=kd>public</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>start</span><span class=p>(</span><span class=n>DecodeJob</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>decodeJob</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-36-3 name=__codelineno-36-3></a><a href=#__codelineno-36-3><span class=linenos data-linenos=" 3 "></span></a>  <span class=k>this</span><span class=p>.</span><span class=na>decodeJob</span> <span class=o>=</span> <span class=n>decodeJob</span><span class=p>;</span>
<a id=__codelineno-36-4 name=__codelineno-36-4></a><a href=#__codelineno-36-4><span class=linenos data-linenos=" 4 "></span></a>  <span class=c1>// decodeJob.willDecodeFromCache()è¿”å›true</span>
<a id=__codelineno-36-5 name=__codelineno-36-5></a><a href=#__codelineno-36-5><span class=linenos data-linenos=" 5 "></span></a>  <span class=n>GlideExecutor</span> <span class=n>executor</span> <span class=o>=</span> <span class=n>decodeJob</span><span class=p>.</span><span class=na>willDecodeFromCache</span><span class=p>()</span>
<a id=__codelineno-36-6 name=__codelineno-36-6></a><a href=#__codelineno-36-6><span class=linenos data-linenos=" 6 "></span></a>      <span class=o>?</span> <span class=n>diskCacheExecutor</span>
<a id=__codelineno-36-7 name=__codelineno-36-7></a><a href=#__codelineno-36-7><span class=linenos data-linenos=" 7 "></span></a>      <span class=p>:</span> <span class=n>getActiveSourceExecutor</span><span class=p>();</span>
<a id=__codelineno-36-8 name=__codelineno-36-8></a><a href=#__codelineno-36-8><span class=linenos data-linenos=" 8 "></span></a>  <span class=n>executor</span><span class=p>.</span><span class=na>execute</span><span class=p>(</span><span class=n>decodeJob</span><span class=p>);</span>
<a id=__codelineno-36-9 name=__codelineno-36-9></a><a href=#__codelineno-36-9><span class=linenos data-linenos=" 9 "></span></a><span class=p>}</span>
<a id=__codelineno-36-10 name=__codelineno-36-10></a><a href=#__codelineno-36-10><span class=linenos data-linenos="10 "></span></a>
<a id=__codelineno-36-11 name=__codelineno-36-11></a><a href=#__codelineno-36-11><span class=linenos data-linenos="11 "></span></a><span class=c1>// DecodeJob</span>
<a id=__codelineno-36-12 name=__codelineno-36-12></a><a href=#__codelineno-36-12><span class=linenos data-linenos="12 "></span></a><span class=cm>/**</span>
<a id=__codelineno-36-13 name=__codelineno-36-13></a><a href=#__codelineno-36-13><span class=linenos data-linenos="13 "></span></a><span class=cm>  * Returns true if this job will attempt to decode a resource from the disk cache, and false if it</span>
<a id=__codelineno-36-14 name=__codelineno-36-14></a><a href=#__codelineno-36-14><span class=linenos data-linenos="14 "></span></a><span class=cm>  * will always decode from source.</span>
<a id=__codelineno-36-15 name=__codelineno-36-15></a><a href=#__codelineno-36-15><span class=linenos data-linenos="15 "></span></a><span class=cm>  */</span>
<a id=__codelineno-36-16 name=__codelineno-36-16></a><a href=#__codelineno-36-16><span class=linenos data-linenos="16 "></span></a><span class=kt>boolean</span> <span class=nf>willDecodeFromCache</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-36-17 name=__codelineno-36-17></a><a href=#__codelineno-36-17><span class=linenos data-linenos="17 "></span></a>  <span class=c1>// è¿”å›å€¼ä¸ºStage.RESOURCE_CACHE</span>
<a id=__codelineno-36-18 name=__codelineno-36-18></a><a href=#__codelineno-36-18><span class=linenos data-linenos="18 "></span></a>  <span class=n>Stage</span> <span class=n>firstStage</span> <span class=o>=</span> <span class=n>getNextStage</span><span class=p>(</span><span class=n>Stage</span><span class=p>.</span><span class=na>INITIALIZE</span><span class=p>);</span>
<a id=__codelineno-36-19 name=__codelineno-36-19></a><a href=#__codelineno-36-19><span class=linenos data-linenos="19 "></span></a>  <span class=k>return</span> <span class=n>firstStage</span> <span class=o>==</span> <span class=n>Stage</span><span class=p>.</span><span class=na>RESOURCE_CACHE</span> <span class=o>||</span> <span class=n>firstStage</span> <span class=o>==</span> <span class=n>Stage</span><span class=p>.</span><span class=na>DATA_CACHE</span><span class=p>;</span>
<a id=__codelineno-36-20 name=__codelineno-36-20></a><a href=#__codelineno-36-20><span class=linenos data-linenos="20 "></span></a><span class=p>}</span>
<a id=__codelineno-36-21 name=__codelineno-36-21></a><a href=#__codelineno-36-21><span class=linenos data-linenos="21 "></span></a>
<a id=__codelineno-36-22 name=__codelineno-36-22></a><a href=#__codelineno-36-22><span class=linenos data-linenos="22 "></span></a><span class=kd>private</span> <span class=n>Stage</span> <span class=nf>getNextStage</span><span class=p>(</span><span class=n>Stage</span> <span class=n>current</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-36-23 name=__codelineno-36-23></a><a href=#__codelineno-36-23><span class=linenos data-linenos="23 "></span></a>    <span class=c1>// diskCacheStrategyä¸ºDiskCacheStrategy.AUTOMATIC</span>
<a id=__codelineno-36-24 name=__codelineno-36-24></a><a href=#__codelineno-36-24><span class=linenos data-linenos="24 "></span></a>    <span class=c1>// decodeCachedResource()ä¸ºtrue</span>
<a id=__codelineno-36-25 name=__codelineno-36-25></a><a href=#__codelineno-36-25><span class=linenos data-linenos="25 "></span></a>    <span class=k>switch</span> <span class=p>(</span><span class=n>current</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-36-26 name=__codelineno-36-26></a><a href=#__codelineno-36-26><span class=linenos data-linenos="26 "></span></a>      <span class=k>case</span> <span class=n>INITIALIZE</span><span class=p>:</span>
<a id=__codelineno-36-27 name=__codelineno-36-27></a><a href=#__codelineno-36-27><span class=linenos data-linenos="27 "></span></a>        <span class=k>return</span> <span class=n>diskCacheStrategy</span><span class=p>.</span><span class=na>decodeCachedResource</span><span class=p>()</span>
<a id=__codelineno-36-28 name=__codelineno-36-28></a><a href=#__codelineno-36-28><span class=linenos data-linenos="28 "></span></a>            <span class=o>?</span> <span class=n>Stage</span><span class=p>.</span><span class=na>RESOURCE_CACHE</span> <span class=p>:</span> <span class=n>getNextStage</span><span class=p>(</span><span class=n>Stage</span><span class=p>.</span><span class=na>RESOURCE_CACHE</span><span class=p>);</span>
<a id=__codelineno-36-29 name=__codelineno-36-29></a><a href=#__codelineno-36-29><span class=linenos data-linenos="29 "></span></a>      <span class=k>case</span> <span class=n>RESOURCE_CACHE</span><span class=p>:</span>
<a id=__codelineno-36-30 name=__codelineno-36-30></a><a href=#__codelineno-36-30><span class=linenos data-linenos="30 "></span></a>        <span class=k>return</span> <span class=n>diskCacheStrategy</span><span class=p>.</span><span class=na>decodeCachedData</span><span class=p>()</span>
<a id=__codelineno-36-31 name=__codelineno-36-31></a><a href=#__codelineno-36-31><span class=linenos data-linenos="31 "></span></a>            <span class=o>?</span> <span class=n>Stage</span><span class=p>.</span><span class=na>DATA_CACHE</span> <span class=p>:</span> <span class=n>getNextStage</span><span class=p>(</span><span class=n>Stage</span><span class=p>.</span><span class=na>DATA_CACHE</span><span class=p>);</span>
<a id=__codelineno-36-32 name=__codelineno-36-32></a><a href=#__codelineno-36-32><span class=linenos data-linenos="32 "></span></a>      <span class=k>case</span> <span class=n>DATA_CACHE</span><span class=p>:</span>
<a id=__codelineno-36-33 name=__codelineno-36-33></a><a href=#__codelineno-36-33><span class=linenos data-linenos="33 "></span></a>        <span class=c1>// Skip loading from source if the user opted to only retrieve the resource from cache.</span>
<a id=__codelineno-36-34 name=__codelineno-36-34></a><a href=#__codelineno-36-34><span class=linenos data-linenos="34 "></span></a>        <span class=k>return</span> <span class=n>onlyRetrieveFromCache</span> <span class=o>?</span> <span class=n>Stage</span><span class=p>.</span><span class=na>FINISHED</span> <span class=p>:</span> <span class=n>Stage</span><span class=p>.</span><span class=na>SOURCE</span><span class=p>;</span>
<a id=__codelineno-36-35 name=__codelineno-36-35></a><a href=#__codelineno-36-35><span class=linenos data-linenos="35 "></span></a>      <span class=k>case</span> <span class=n>SOURCE</span><span class=p>:</span>
<a id=__codelineno-36-36 name=__codelineno-36-36></a><a href=#__codelineno-36-36><span class=linenos data-linenos="36 "></span></a>      <span class=k>case</span> <span class=n>FINISHED</span><span class=p>:</span>
<a id=__codelineno-36-37 name=__codelineno-36-37></a><a href=#__codelineno-36-37><span class=linenos data-linenos="37 "></span></a>        <span class=k>return</span> <span class=n>Stage</span><span class=p>.</span><span class=na>FINISHED</span><span class=p>;</span>
<a id=__codelineno-36-38 name=__codelineno-36-38></a><a href=#__codelineno-36-38><span class=linenos data-linenos="38 "></span></a>      <span class=k>default</span><span class=p>:</span>
<a id=__codelineno-36-39 name=__codelineno-36-39></a><a href=#__codelineno-36-39><span class=linenos data-linenos="39 "></span></a>        <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&quot;Unrecognized stage: &quot;</span> <span class=o>+</span> <span class=n>current</span><span class=p>);</span>
<a id=__codelineno-36-40 name=__codelineno-36-40></a><a href=#__codelineno-36-40><span class=linenos data-linenos="40 "></span></a>    <span class=p>}</span>
<a id=__codelineno-36-41 name=__codelineno-36-41></a><a href=#__codelineno-36-41><span class=linenos data-linenos="41 "></span></a>  <span class=p>}</span>
</code></pre></div> <p>æ­¤çŠ¶æ€æœºçš„æ‰€æœ‰çŠ¶æ€å¦‚ä¸‹ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-37-1 name=__codelineno-37-1></a><a href=#__codelineno-37-1><span class=linenos data-linenos=" 1 "></span></a><span class=cm>/**</span>
<a id=__codelineno-37-2 name=__codelineno-37-2></a><a href=#__codelineno-37-2><span class=linenos data-linenos=" 2 "></span></a><span class=cm>  * Where we&#39;re trying to decode data from.</span>
<a id=__codelineno-37-3 name=__codelineno-37-3></a><a href=#__codelineno-37-3><span class=linenos data-linenos=" 3 "></span></a><span class=cm>  */</span>
<a id=__codelineno-37-4 name=__codelineno-37-4></a><a href=#__codelineno-37-4><span class=linenos data-linenos=" 4 "></span></a><span class=kd>private</span> <span class=kd>enum</span> <span class=n>Stage</span> <span class=p>{</span>
<a id=__codelineno-37-5 name=__codelineno-37-5></a><a href=#__codelineno-37-5><span class=linenos data-linenos=" 5 "></span></a>  <span class=cm>/** The initial stage. */</span>
<a id=__codelineno-37-6 name=__codelineno-37-6></a><a href=#__codelineno-37-6><span class=linenos data-linenos=" 6 "></span></a>  <span class=n>INITIALIZE</span><span class=p>,</span>
<a id=__codelineno-37-7 name=__codelineno-37-7></a><a href=#__codelineno-37-7><span class=linenos data-linenos=" 7 "></span></a>  <span class=cm>/** Decode from a cached resource. */</span>
<a id=__codelineno-37-8 name=__codelineno-37-8></a><a href=#__codelineno-37-8><span class=linenos data-linenos=" 8 "></span></a>  <span class=n>RESOURCE_CACHE</span><span class=p>,</span>
<a id=__codelineno-37-9 name=__codelineno-37-9></a><a href=#__codelineno-37-9><span class=linenos data-linenos=" 9 "></span></a>  <span class=cm>/** Decode from cached source data. */</span>
<a id=__codelineno-37-10 name=__codelineno-37-10></a><a href=#__codelineno-37-10><span class=linenos data-linenos="10 "></span></a>  <span class=n>DATA_CACHE</span><span class=p>,</span>
<a id=__codelineno-37-11 name=__codelineno-37-11></a><a href=#__codelineno-37-11><span class=linenos data-linenos="11 "></span></a>  <span class=cm>/** Decode from retrieved source. */</span>
<a id=__codelineno-37-12 name=__codelineno-37-12></a><a href=#__codelineno-37-12><span class=linenos data-linenos="12 "></span></a>  <span class=n>SOURCE</span><span class=p>,</span>
<a id=__codelineno-37-13 name=__codelineno-37-13></a><a href=#__codelineno-37-13><span class=linenos data-linenos="13 "></span></a>  <span class=cm>/** Encoding transformed resources after a successful load. */</span>
<a id=__codelineno-37-14 name=__codelineno-37-14></a><a href=#__codelineno-37-14><span class=linenos data-linenos="14 "></span></a>  <span class=n>ENCODE</span><span class=p>,</span>
<a id=__codelineno-37-15 name=__codelineno-37-15></a><a href=#__codelineno-37-15><span class=linenos data-linenos="15 "></span></a>  <span class=cm>/** No more viable stages. */</span>
<a id=__codelineno-37-16 name=__codelineno-37-16></a><a href=#__codelineno-37-16><span class=linenos data-linenos="16 "></span></a>  <span class=n>FINISHED</span><span class=p>,</span>
<a id=__codelineno-37-17 name=__codelineno-37-17></a><a href=#__codelineno-37-17><span class=linenos data-linenos="17 "></span></a><span class=p>}</span>
</code></pre></div> <p>å›åˆ°<code>EngineJob.start</code>æ–¹æ³•ä¸­ï¼Œç”±äº<code>decodeJob.willDecodeFromCache()</code>ä¸ºtrueï¼Œé‚£ä¹ˆå°±ä½¿ç”¨<code>diskCacheExecutor</code>æ¥æ‰§è¡ŒdecodeJobã€‚<br> <code>diskCacheExecutor</code>é»˜è®¤å€¼ä¸º<code>GlideExecutor.newDiskCacheExecutor()</code>ï¼Œè¿™æ˜¯ç±»ä¼¼äºä¸€ä¸ª<code>SingleThreadExecutor</code>çš„çº¿ç¨‹æ± ï¼Œè¿™é‡Œä½¿ç”¨äº†è®¾è®¡æ¨¡å¼ä¸­çš„ä»£ç†æ¨¡å¼ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-38-1 name=__codelineno-38-1></a><a href=#__codelineno-38-1><span class=linenos data-linenos=" 1 "></span></a><span class=cm>/**</span>
<a id=__codelineno-38-2 name=__codelineno-38-2></a><a href=#__codelineno-38-2><span class=linenos data-linenos=" 2 "></span></a><span class=cm> * A prioritized {@link ThreadPoolExecutor} for running jobs in Glide.</span>
<a id=__codelineno-38-3 name=__codelineno-38-3></a><a href=#__codelineno-38-3><span class=linenos data-linenos=" 3 "></span></a><span class=cm> */</span>
<a id=__codelineno-38-4 name=__codelineno-38-4></a><a href=#__codelineno-38-4><span class=linenos data-linenos=" 4 "></span></a><span class=kd>public</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>GlideExecutor</span> <span class=kd>implements</span> <span class=n>ExecutorService</span> <span class=p>{</span>
<a id=__codelineno-38-5 name=__codelineno-38-5></a><a href=#__codelineno-38-5><span class=linenos data-linenos=" 5 "></span></a>  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>DEFAULT_DISK_CACHE_EXECUTOR_NAME</span> <span class=o>=</span> <span class=s>&quot;disk-cache&quot;</span><span class=p>;</span>
<a id=__codelineno-38-6 name=__codelineno-38-6></a><a href=#__codelineno-38-6><span class=linenos data-linenos=" 6 "></span></a>  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>DEFAULT_DISK_CACHE_EXECUTOR_THREADS</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
<a id=__codelineno-38-7 name=__codelineno-38-7></a><a href=#__codelineno-38-7><span class=linenos data-linenos=" 7 "></span></a>
<a id=__codelineno-38-8 name=__codelineno-38-8></a><a href=#__codelineno-38-8><span class=linenos data-linenos=" 8 "></span></a>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>ExecutorService</span> <span class=n>delegate</span><span class=p>;</span>
<a id=__codelineno-38-9 name=__codelineno-38-9></a><a href=#__codelineno-38-9><span class=linenos data-linenos=" 9 "></span></a>
<a id=__codelineno-38-10 name=__codelineno-38-10></a><a href=#__codelineno-38-10><span class=linenos data-linenos="10 "></span></a>  <span class=kd>public</span> <span class=kd>static</span> <span class=n>GlideExecutor</span> <span class=nf>newDiskCacheExecutor</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-38-11 name=__codelineno-38-11></a><a href=#__codelineno-38-11><span class=linenos data-linenos="11 "></span></a>    <span class=k>return</span> <span class=n>newDiskCacheExecutor</span><span class=p>(</span>
<a id=__codelineno-38-12 name=__codelineno-38-12></a><a href=#__codelineno-38-12><span class=linenos data-linenos="12 "></span></a>        <span class=n>DEFAULT_DISK_CACHE_EXECUTOR_THREADS</span><span class=p>,</span>
<a id=__codelineno-38-13 name=__codelineno-38-13></a><a href=#__codelineno-38-13><span class=linenos data-linenos="13 "></span></a>        <span class=n>DEFAULT_DISK_CACHE_EXECUTOR_NAME</span><span class=p>,</span>
<a id=__codelineno-38-14 name=__codelineno-38-14></a><a href=#__codelineno-38-14><span class=linenos data-linenos="14 "></span></a>        <span class=n>UncaughtThrowableStrategy</span><span class=p>.</span><span class=na>DEFAULT</span><span class=p>);</span>
<a id=__codelineno-38-15 name=__codelineno-38-15></a><a href=#__codelineno-38-15><span class=linenos data-linenos="15 "></span></a>  <span class=p>}</span>
<a id=__codelineno-38-16 name=__codelineno-38-16></a><a href=#__codelineno-38-16><span class=linenos data-linenos="16 "></span></a>
<a id=__codelineno-38-17 name=__codelineno-38-17></a><a href=#__codelineno-38-17><span class=linenos data-linenos="17 "></span></a>  <span class=kd>public</span> <span class=kd>static</span> <span class=n>GlideExecutor</span> <span class=nf>newDiskCacheExecutor</span><span class=p>(</span>
<a id=__codelineno-38-18 name=__codelineno-38-18></a><a href=#__codelineno-38-18><span class=linenos data-linenos="18 "></span></a>      <span class=kt>int</span> <span class=n>threadCount</span><span class=p>,</span> <span class=n>String</span> <span class=n>name</span><span class=p>,</span> <span class=n>UncaughtThrowableStrategy</span> <span class=n>uncaughtThrowableStrategy</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-38-19 name=__codelineno-38-19></a><a href=#__codelineno-38-19><span class=linenos data-linenos="19 "></span></a>    <span class=k>return</span> <span class=k>new</span> <span class=n>GlideExecutor</span><span class=p>(</span>
<a id=__codelineno-38-20 name=__codelineno-38-20></a><a href=#__codelineno-38-20><span class=linenos data-linenos="20 "></span></a>        <span class=k>new</span> <span class=n>ThreadPoolExecutor</span><span class=p>(</span>
<a id=__codelineno-38-21 name=__codelineno-38-21></a><a href=#__codelineno-38-21><span class=linenos data-linenos="21 "></span></a>            <span class=n>threadCount</span> <span class=cm>/* corePoolSize */</span><span class=p>,</span>
<a id=__codelineno-38-22 name=__codelineno-38-22></a><a href=#__codelineno-38-22><span class=linenos data-linenos="22 "></span></a>            <span class=n>threadCount</span> <span class=cm>/* maximumPoolSize */</span><span class=p>,</span>
<a id=__codelineno-38-23 name=__codelineno-38-23></a><a href=#__codelineno-38-23><span class=linenos data-linenos="23 "></span></a>            <span class=mi>0</span> <span class=cm>/* keepAliveTime */</span><span class=p>,</span>
<a id=__codelineno-38-24 name=__codelineno-38-24></a><a href=#__codelineno-38-24><span class=linenos data-linenos="24 "></span></a>            <span class=n>TimeUnit</span><span class=p>.</span><span class=na>MILLISECONDS</span><span class=p>,</span>
<a id=__codelineno-38-25 name=__codelineno-38-25></a><a href=#__codelineno-38-25><span class=linenos data-linenos="25 "></span></a>            <span class=k>new</span> <span class=n>PriorityBlockingQueue</span><span class=o>&lt;</span><span class=n>Runnable</span><span class=o>&gt;</span><span class=p>(),</span>
<a id=__codelineno-38-26 name=__codelineno-38-26></a><a href=#__codelineno-38-26><span class=linenos data-linenos="26 "></span></a>            <span class=k>new</span> <span class=n>DefaultThreadFactory</span><span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>uncaughtThrowableStrategy</span><span class=p>,</span> <span class=kc>true</span><span class=p>)));</span>
<a id=__codelineno-38-27 name=__codelineno-38-27></a><a href=#__codelineno-38-27><span class=linenos data-linenos="27 "></span></a>  <span class=p>}</span>
<a id=__codelineno-38-28 name=__codelineno-38-28></a><a href=#__codelineno-38-28><span class=linenos data-linenos="28 "></span></a>
<a id=__codelineno-38-29 name=__codelineno-38-29></a><a href=#__codelineno-38-29><span class=linenos data-linenos="29 "></span></a>  <span class=nd>@VisibleForTesting</span>
<a id=__codelineno-38-30 name=__codelineno-38-30></a><a href=#__codelineno-38-30><span class=linenos data-linenos="30 "></span></a>  <span class=n>GlideExecutor</span><span class=p>(</span><span class=n>ExecutorService</span> <span class=n>delegate</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-38-31 name=__codelineno-38-31></a><a href=#__codelineno-38-31><span class=linenos data-linenos="31 "></span></a>    <span class=k>this</span><span class=p>.</span><span class=na>delegate</span> <span class=o>=</span> <span class=n>delegate</span><span class=p>;</span>
<a id=__codelineno-38-32 name=__codelineno-38-32></a><a href=#__codelineno-38-32><span class=linenos data-linenos="32 "></span></a>  <span class=p>}</span>
<a id=__codelineno-38-33 name=__codelineno-38-33></a><a href=#__codelineno-38-33><span class=linenos data-linenos="33 "></span></a>
<a id=__codelineno-38-34 name=__codelineno-38-34></a><a href=#__codelineno-38-34><span class=linenos data-linenos="34 "></span></a>  <span class=nd>@Override</span>
<a id=__codelineno-38-35 name=__codelineno-38-35></a><a href=#__codelineno-38-35><span class=linenos data-linenos="35 "></span></a>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>execute</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Runnable</span> <span class=n>command</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-38-36 name=__codelineno-38-36></a><a href=#__codelineno-38-36><span class=linenos data-linenos="36 "></span></a>    <span class=n>delegate</span><span class=p>.</span><span class=na>execute</span><span class=p>(</span><span class=n>command</span><span class=p>);</span>
<a id=__codelineno-38-37 name=__codelineno-38-37></a><a href=#__codelineno-38-37><span class=linenos data-linenos="37 "></span></a>  <span class=p>}</span>
<a id=__codelineno-38-38 name=__codelineno-38-38></a><a href=#__codelineno-38-38><span class=linenos data-linenos="38 "></span></a>
<a id=__codelineno-38-39 name=__codelineno-38-39></a><a href=#__codelineno-38-39><span class=linenos data-linenos="39 "></span></a>  <span class=nd>@NonNull</span>
<a id=__codelineno-38-40 name=__codelineno-38-40></a><a href=#__codelineno-38-40><span class=linenos data-linenos="40 "></span></a>  <span class=nd>@Override</span>
<a id=__codelineno-38-41 name=__codelineno-38-41></a><a href=#__codelineno-38-41><span class=linenos data-linenos="41 "></span></a>  <span class=kd>public</span> <span class=n>Future</span><span class=o>&lt;?&gt;</span> <span class=n>submit</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Runnable</span> <span class=n>task</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-38-42 name=__codelineno-38-42></a><a href=#__codelineno-38-42><span class=linenos data-linenos="42 "></span></a>    <span class=k>return</span> <span class=n>delegate</span><span class=p>.</span><span class=na>submit</span><span class=p>(</span><span class=n>task</span><span class=p>);</span>
<a id=__codelineno-38-43 name=__codelineno-38-43></a><a href=#__codelineno-38-43><span class=linenos data-linenos="43 "></span></a>  <span class=p>}</span>
<a id=__codelineno-38-44 name=__codelineno-38-44></a><a href=#__codelineno-38-44><span class=linenos data-linenos="44 "></span></a>  <span class=p>...</span>
<a id=__codelineno-38-45 name=__codelineno-38-45></a><a href=#__codelineno-38-45><span class=linenos data-linenos="45 "></span></a><span class=p>}</span>
</code></pre></div> <p>ç°åœ¨ï¼Œ<code>decodeJob</code>å·²ç»æäº¤åˆ°äº†çº¿ç¨‹æ± ä¸­ï¼Œå¾…ä¼šå„¿æˆ‘ä»¬åœ¨çœ‹å­çº¿ç¨‹ä¸­çš„æ‰§è¡Œæƒ…å†µã€‚<br> ç°åœ¨å›åˆ°ä¸»çº¿ç¨‹çš„<code>SingleRequest.begin</code>æ–¹æ³•ä¸­ï¼Œæ¥ä¸‹æ¥æ‰§è¡Œçš„æ˜¯ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-39-1 name=__codelineno-39-1></a><a href=#__codelineno-39-1><span class=linenos data-linenos="1 "></span></a><span class=k>if</span> <span class=p>((</span><span class=n>status</span> <span class=o>==</span> <span class=n>Status</span><span class=p>.</span><span class=na>RUNNING</span> <span class=o>||</span> <span class=n>status</span> <span class=o>==</span> <span class=n>Status</span><span class=p>.</span><span class=na>WAITING_FOR_SIZE</span><span class=p>)</span>
<a id=__codelineno-39-2 name=__codelineno-39-2></a><a href=#__codelineno-39-2><span class=linenos data-linenos="2 "></span></a>    <span class=o>&amp;&amp;</span> <span class=n>canNotifyStatusChanged</span><span class=p>())</span> <span class=p>{</span>
<a id=__codelineno-39-3 name=__codelineno-39-3></a><a href=#__codelineno-39-3><span class=linenos data-linenos="3 "></span></a>  <span class=n>target</span><span class=p>.</span><span class=na>onLoadStarted</span><span class=p>(</span><span class=n>getPlaceholderDrawable</span><span class=p>());</span>
<a id=__codelineno-39-4 name=__codelineno-39-4></a><a href=#__codelineno-39-4><span class=linenos data-linenos="4 "></span></a><span class=p>}</span>
</code></pre></div> <p>ç”±äºæ­¤æ—¶<code>status == Status.RUNNING</code>ä¸ºtrueï¼Œç°åœ¨å¼€å§‹å±•ç¤ºplaceholderã€‚</p> <h3 id=34-decodejobrun>3.4 DecodeJob.run<a class=headerlink href=#34-decodejobrun title="Anchor link to this section for reference">&para;</a></h3> <p>æ¥ç€ï¼Œç»§ç»­çœ‹çœ‹<code>decodeJob.run</code>æ–¹æ³•åœ¨çº¿ç¨‹æ± ä¸­çš„æ‰§è¡Œæƒ…å†µï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-40-1 name=__codelineno-40-1></a><a href=#__codelineno-40-1><span class=linenos data-linenos=" 1 "></span></a><span class=nd>@Override</span>
<a id=__codelineno-40-2 name=__codelineno-40-2></a><a href=#__codelineno-40-2><span class=linenos data-linenos=" 2 "></span></a><span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-40-3 name=__codelineno-40-3></a><a href=#__codelineno-40-3><span class=linenos data-linenos=" 3 "></span></a>  <span class=c1>// This should be much more fine grained, but since Java&#39;s thread pool implementation silently</span>
<a id=__codelineno-40-4 name=__codelineno-40-4></a><a href=#__codelineno-40-4><span class=linenos data-linenos=" 4 "></span></a>  <span class=c1>// swallows all otherwise fatal exceptions, this will at least make it obvious to developers</span>
<a id=__codelineno-40-5 name=__codelineno-40-5></a><a href=#__codelineno-40-5><span class=linenos data-linenos=" 5 "></span></a>  <span class=c1>// that something is failing.</span>
<a id=__codelineno-40-6 name=__codelineno-40-6></a><a href=#__codelineno-40-6><span class=linenos data-linenos=" 6 "></span></a>  <span class=n>GlideTrace</span><span class=p>.</span><span class=na>beginSectionFormat</span><span class=p>(</span><span class=s>&quot;DecodeJob#run(model=%s)&quot;</span><span class=p>,</span> <span class=n>model</span><span class=p>);</span>
<a id=__codelineno-40-7 name=__codelineno-40-7></a><a href=#__codelineno-40-7><span class=linenos data-linenos=" 7 "></span></a>  <span class=c1>// Methods in the try statement can invalidate currentFetcher, so set a local variable here to</span>
<a id=__codelineno-40-8 name=__codelineno-40-8></a><a href=#__codelineno-40-8><span class=linenos data-linenos=" 8 "></span></a>  <span class=c1>// ensure that the fetcher is cleaned up either way.</span>
<a id=__codelineno-40-9 name=__codelineno-40-9></a><a href=#__codelineno-40-9><span class=linenos data-linenos=" 9 "></span></a>  <span class=c1>//</span>
<a id=__codelineno-40-10 name=__codelineno-40-10></a><a href=#__codelineno-40-10><span class=linenos data-linenos="10 "></span></a>  <span class=c1>// currentFetcherç›®å‰ä¸ºnull</span>
<a id=__codelineno-40-11 name=__codelineno-40-11></a><a href=#__codelineno-40-11><span class=linenos data-linenos="11 "></span></a>  <span class=n>DataFetcher</span><span class=o>&lt;?&gt;</span> <span class=n>localFetcher</span> <span class=o>=</span> <span class=n>currentFetcher</span><span class=p>;</span>
<a id=__codelineno-40-12 name=__codelineno-40-12></a><a href=#__codelineno-40-12><span class=linenos data-linenos="12 "></span></a>  <span class=k>try</span> <span class=p>{</span>
<a id=__codelineno-40-13 name=__codelineno-40-13></a><a href=#__codelineno-40-13><span class=linenos data-linenos="13 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>isCancelled</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-40-14 name=__codelineno-40-14></a><a href=#__codelineno-40-14><span class=linenos data-linenos="14 "></span></a>      <span class=n>notifyFailed</span><span class=p>();</span>
<a id=__codelineno-40-15 name=__codelineno-40-15></a><a href=#__codelineno-40-15><span class=linenos data-linenos="15 "></span></a>      <span class=k>return</span><span class=p>;</span>
<a id=__codelineno-40-16 name=__codelineno-40-16></a><a href=#__codelineno-40-16><span class=linenos data-linenos="16 "></span></a>    <span class=p>}</span>
<a id=__codelineno-40-17 name=__codelineno-40-17></a><a href=#__codelineno-40-17><span class=linenos data-linenos="17 "></span></a>    <span class=n>runWrapped</span><span class=p>();</span>
<a id=__codelineno-40-18 name=__codelineno-40-18></a><a href=#__codelineno-40-18><span class=linenos data-linenos="18 "></span></a>  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>CallbackException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-40-19 name=__codelineno-40-19></a><a href=#__codelineno-40-19><span class=linenos data-linenos="19 "></span></a>    <span class=c1>// If a callback not controlled by Glide throws an exception, we should avoid the Glide</span>
<a id=__codelineno-40-20 name=__codelineno-40-20></a><a href=#__codelineno-40-20><span class=linenos data-linenos="20 "></span></a>    <span class=c1>// specific debug logic below.</span>
<a id=__codelineno-40-21 name=__codelineno-40-21></a><a href=#__codelineno-40-21><span class=linenos data-linenos="21 "></span></a>    <span class=k>throw</span> <span class=n>e</span><span class=p>;</span>
<a id=__codelineno-40-22 name=__codelineno-40-22></a><a href=#__codelineno-40-22><span class=linenos data-linenos="22 "></span></a>  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-40-23 name=__codelineno-40-23></a><a href=#__codelineno-40-23><span class=linenos data-linenos="23 "></span></a>    <span class=c1>// Catch Throwable and not Exception to handle OOMs. Throwables are swallowed by our</span>
<a id=__codelineno-40-24 name=__codelineno-40-24></a><a href=#__codelineno-40-24><span class=linenos data-linenos="24 "></span></a>    <span class=c1>// usage of .submit() in GlideExecutor so we&#39;re not silently hiding crashes by doing this. We</span>
<a id=__codelineno-40-25 name=__codelineno-40-25></a><a href=#__codelineno-40-25><span class=linenos data-linenos="25 "></span></a>    <span class=c1>// are however ensuring that our callbacks are always notified when a load fails. Without this</span>
<a id=__codelineno-40-26 name=__codelineno-40-26></a><a href=#__codelineno-40-26><span class=linenos data-linenos="26 "></span></a>    <span class=c1>// notification, uncaught throwables never notify the corresponding callbacks, which can cause</span>
<a id=__codelineno-40-27 name=__codelineno-40-27></a><a href=#__codelineno-40-27><span class=linenos data-linenos="27 "></span></a>    <span class=c1>// loads to silently hang forever, a case that&#39;s especially bad for users using Futures on</span>
<a id=__codelineno-40-28 name=__codelineno-40-28></a><a href=#__codelineno-40-28><span class=linenos data-linenos="28 "></span></a>    <span class=c1>// background threads.</span>
<a id=__codelineno-40-29 name=__codelineno-40-29></a><a href=#__codelineno-40-29><span class=linenos data-linenos="29 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>Log</span><span class=p>.</span><span class=na>isLoggable</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=n>Log</span><span class=p>.</span><span class=na>DEBUG</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-40-30 name=__codelineno-40-30></a><a href=#__codelineno-40-30><span class=linenos data-linenos="30 "></span></a>      <span class=n>Log</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s>&quot;DecodeJob threw unexpectedly&quot;</span>
<a id=__codelineno-40-31 name=__codelineno-40-31></a><a href=#__codelineno-40-31><span class=linenos data-linenos="31 "></span></a>          <span class=o>+</span> <span class=s>&quot;, isCancelled: &quot;</span> <span class=o>+</span> <span class=n>isCancelled</span>
<a id=__codelineno-40-32 name=__codelineno-40-32></a><a href=#__codelineno-40-32><span class=linenos data-linenos="32 "></span></a>          <span class=o>+</span> <span class=s>&quot;, stage: &quot;</span> <span class=o>+</span> <span class=n>stage</span><span class=p>,</span> <span class=n>t</span><span class=p>);</span>
<a id=__codelineno-40-33 name=__codelineno-40-33></a><a href=#__codelineno-40-33><span class=linenos data-linenos="33 "></span></a>    <span class=p>}</span>
<a id=__codelineno-40-34 name=__codelineno-40-34></a><a href=#__codelineno-40-34><span class=linenos data-linenos="34 "></span></a>    <span class=c1>// When we&#39;re encoding we&#39;ve already notified our callback and it isn&#39;t safe to do so again.</span>
<a id=__codelineno-40-35 name=__codelineno-40-35></a><a href=#__codelineno-40-35><span class=linenos data-linenos="35 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>stage</span> <span class=o>!=</span> <span class=n>Stage</span><span class=p>.</span><span class=na>ENCODE</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-40-36 name=__codelineno-40-36></a><a href=#__codelineno-40-36><span class=linenos data-linenos="36 "></span></a>      <span class=n>throwables</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>t</span><span class=p>);</span>
<a id=__codelineno-40-37 name=__codelineno-40-37></a><a href=#__codelineno-40-37><span class=linenos data-linenos="37 "></span></a>      <span class=n>notifyFailed</span><span class=p>();</span>
<a id=__codelineno-40-38 name=__codelineno-40-38></a><a href=#__codelineno-40-38><span class=linenos data-linenos="38 "></span></a>    <span class=p>}</span>
<a id=__codelineno-40-39 name=__codelineno-40-39></a><a href=#__codelineno-40-39><span class=linenos data-linenos="39 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>isCancelled</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-40-40 name=__codelineno-40-40></a><a href=#__codelineno-40-40><span class=linenos data-linenos="40 "></span></a>      <span class=k>throw</span> <span class=n>t</span><span class=p>;</span>
<a id=__codelineno-40-41 name=__codelineno-40-41></a><a href=#__codelineno-40-41><span class=linenos data-linenos="41 "></span></a>    <span class=p>}</span>
<a id=__codelineno-40-42 name=__codelineno-40-42></a><a href=#__codelineno-40-42><span class=linenos data-linenos="42 "></span></a>    <span class=k>throw</span> <span class=n>t</span><span class=p>;</span>
<a id=__codelineno-40-43 name=__codelineno-40-43></a><a href=#__codelineno-40-43><span class=linenos data-linenos="43 "></span></a>  <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
<a id=__codelineno-40-44 name=__codelineno-40-44></a><a href=#__codelineno-40-44><span class=linenos data-linenos="44 "></span></a>    <span class=c1>// Keeping track of the fetcher here and calling cleanup is excessively paranoid, we call</span>
<a id=__codelineno-40-45 name=__codelineno-40-45></a><a href=#__codelineno-40-45><span class=linenos data-linenos="45 "></span></a>    <span class=c1>// close in all cases anyway.</span>
<a id=__codelineno-40-46 name=__codelineno-40-46></a><a href=#__codelineno-40-46><span class=linenos data-linenos="46 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>localFetcher</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-40-47 name=__codelineno-40-47></a><a href=#__codelineno-40-47><span class=linenos data-linenos="47 "></span></a>      <span class=n>localFetcher</span><span class=p>.</span><span class=na>cleanup</span><span class=p>();</span>
<a id=__codelineno-40-48 name=__codelineno-40-48></a><a href=#__codelineno-40-48><span class=linenos data-linenos="48 "></span></a>    <span class=p>}</span>
<a id=__codelineno-40-49 name=__codelineno-40-49></a><a href=#__codelineno-40-49><span class=linenos data-linenos="49 "></span></a>    <span class=n>GlideTrace</span><span class=p>.</span><span class=na>endSection</span><span class=p>();</span>
<a id=__codelineno-40-50 name=__codelineno-40-50></a><a href=#__codelineno-40-50><span class=linenos data-linenos="50 "></span></a>  <span class=p>}</span>
<a id=__codelineno-40-51 name=__codelineno-40-51></a><a href=#__codelineno-40-51><span class=linenos data-linenos="51 "></span></a><span class=p>}</span>
</code></pre></div> <p>é‡Œé¢çœŸæ­£æ‰§è¡Œçš„æ˜¯<code>runWrapped</code>æ–¹æ³•ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-41-1 name=__codelineno-41-1></a><a href=#__codelineno-41-1><span class=linenos data-linenos=" 1 "></span></a><span class=kd>private</span> <span class=kt>void</span> <span class=nf>runWrapped</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-41-2 name=__codelineno-41-2></a><a href=#__codelineno-41-2><span class=linenos data-linenos=" 2 "></span></a>  <span class=c1>// runReasonåœ¨DecodeJob.initæ–¹æ³•ä¸­è¢«åˆå§‹åŒ–ä¸ºINITIALIZE</span>
<a id=__codelineno-41-3 name=__codelineno-41-3></a><a href=#__codelineno-41-3><span class=linenos data-linenos=" 3 "></span></a>  <span class=k>switch</span> <span class=p>(</span><span class=n>runReason</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-41-4 name=__codelineno-41-4></a><a href=#__codelineno-41-4><span class=linenos data-linenos=" 4 "></span></a>    <span class=k>case</span> <span class=n>INITIALIZE</span><span class=p>:</span>
<a id=__codelineno-41-5 name=__codelineno-41-5></a><a href=#__codelineno-41-5><span class=linenos data-linenos=" 5 "></span></a>      <span class=c1>// INITIALIZEä¸‹ä¸€ä¸ªçŠ¶æ€æ˜¾ç„¶ä¸ºRESOURCE_CACHE</span>
<a id=__codelineno-41-6 name=__codelineno-41-6></a><a href=#__codelineno-41-6><span class=linenos data-linenos=" 6 "></span></a>      <span class=n>stage</span> <span class=o>=</span> <span class=n>getNextStage</span><span class=p>(</span><span class=n>Stage</span><span class=p>.</span><span class=na>INITIALIZE</span><span class=p>);</span>
<a id=__codelineno-41-7 name=__codelineno-41-7></a><a href=#__codelineno-41-7><span class=linenos data-linenos=" 7 "></span></a>      <span class=n>currentGenerator</span> <span class=o>=</span> <span class=n>getNextGenerator</span><span class=p>();</span>
<a id=__codelineno-41-8 name=__codelineno-41-8></a><a href=#__codelineno-41-8><span class=linenos data-linenos=" 8 "></span></a>      <span class=n>runGenerators</span><span class=p>();</span>
<a id=__codelineno-41-9 name=__codelineno-41-9></a><a href=#__codelineno-41-9><span class=linenos data-linenos=" 9 "></span></a>      <span class=k>break</span><span class=p>;</span>
<a id=__codelineno-41-10 name=__codelineno-41-10></a><a href=#__codelineno-41-10><span class=linenos data-linenos="10 "></span></a>    <span class=p>...</span>
<a id=__codelineno-41-11 name=__codelineno-41-11></a><a href=#__codelineno-41-11><span class=linenos data-linenos="11 "></span></a>  <span class=p>}</span>
<a id=__codelineno-41-12 name=__codelineno-41-12></a><a href=#__codelineno-41-12><span class=linenos data-linenos="12 "></span></a><span class=p>}</span>
<a id=__codelineno-41-13 name=__codelineno-41-13></a><a href=#__codelineno-41-13><span class=linenos data-linenos="13 "></span></a>
<a id=__codelineno-41-14 name=__codelineno-41-14></a><a href=#__codelineno-41-14><span class=linenos data-linenos="14 "></span></a><span class=cm>/**</span>
<a id=__codelineno-41-15 name=__codelineno-41-15></a><a href=#__codelineno-41-15><span class=linenos data-linenos="15 "></span></a><span class=cm> * è¿”å›ä¸€ä¸ªResourceCacheGenerator</span>
<a id=__codelineno-41-16 name=__codelineno-41-16></a><a href=#__codelineno-41-16><span class=linenos data-linenos="16 "></span></a><span class=cm> */</span>
<a id=__codelineno-41-17 name=__codelineno-41-17></a><a href=#__codelineno-41-17><span class=linenos data-linenos="17 "></span></a><span class=kd>private</span> <span class=n>DataFetcherGenerator</span> <span class=nf>getNextGenerator</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-41-18 name=__codelineno-41-18></a><a href=#__codelineno-41-18><span class=linenos data-linenos="18 "></span></a>  <span class=k>switch</span> <span class=p>(</span><span class=n>stage</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-41-19 name=__codelineno-41-19></a><a href=#__codelineno-41-19><span class=linenos data-linenos="19 "></span></a>    <span class=k>case</span> <span class=n>RESOURCE_CACHE</span><span class=p>:</span>
<a id=__codelineno-41-20 name=__codelineno-41-20></a><a href=#__codelineno-41-20><span class=linenos data-linenos="20 "></span></a>      <span class=k>return</span> <span class=k>new</span> <span class=n>ResourceCacheGenerator</span><span class=p>(</span><span class=n>decodeHelper</span><span class=p>,</span> <span class=k>this</span><span class=p>);</span>
<a id=__codelineno-41-21 name=__codelineno-41-21></a><a href=#__codelineno-41-21><span class=linenos data-linenos="21 "></span></a>    <span class=p>...</span>
<a id=__codelineno-41-22 name=__codelineno-41-22></a><a href=#__codelineno-41-22><span class=linenos data-linenos="22 "></span></a>  <span class=p>}</span>
<a id=__codelineno-41-23 name=__codelineno-41-23></a><a href=#__codelineno-41-23><span class=linenos data-linenos="23 "></span></a><span class=p>}</span>
</code></pre></div> <p><code>getNextGenerator()</code>æ–¹æ³•è¿”å›äº†ä¸€ä¸ª<code>ResourceCacheGenerator</code>ï¼Œç„¶åè°ƒç”¨<code>runGenerators()</code>æ–¹æ³•è¿›è¡Œæ‰§è¡Œã€‚</p> <div class=highlight><pre><span></span><code><a id=__codelineno-42-1 name=__codelineno-42-1></a><a href=#__codelineno-42-1><span class=linenos data-linenos=" 1 "></span></a><span class=kd>private</span> <span class=kt>void</span> <span class=nf>runGenerators</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-42-2 name=__codelineno-42-2></a><a href=#__codelineno-42-2><span class=linenos data-linenos=" 2 "></span></a>  <span class=n>currentThread</span> <span class=o>=</span> <span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>();</span>
<a id=__codelineno-42-3 name=__codelineno-42-3></a><a href=#__codelineno-42-3><span class=linenos data-linenos=" 3 "></span></a>  <span class=n>startFetchTime</span> <span class=o>=</span> <span class=n>LogTime</span><span class=p>.</span><span class=na>getLogTime</span><span class=p>();</span>
<a id=__codelineno-42-4 name=__codelineno-42-4></a><a href=#__codelineno-42-4><span class=linenos data-linenos=" 4 "></span></a>  <span class=kt>boolean</span> <span class=n>isStarted</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
<a id=__codelineno-42-5 name=__codelineno-42-5></a><a href=#__codelineno-42-5><span class=linenos data-linenos=" 5 "></span></a>  <span class=k>while</span> <span class=p>(</span><span class=o>!</span><span class=n>isCancelled</span> <span class=o>&amp;&amp;</span> <span class=n>currentGenerator</span> <span class=o>!=</span> <span class=kc>null</span>
<a id=__codelineno-42-6 name=__codelineno-42-6></a><a href=#__codelineno-42-6><span class=linenos data-linenos=" 6 "></span></a>      <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=p>(</span><span class=n>isStarted</span> <span class=o>=</span> <span class=n>currentGenerator</span><span class=p>.</span><span class=na>startNext</span><span class=p>()))</span> <span class=p>{</span>
<a id=__codelineno-42-7 name=__codelineno-42-7></a><a href=#__codelineno-42-7><span class=linenos data-linenos=" 7 "></span></a>    <span class=n>stage</span> <span class=o>=</span> <span class=n>getNextStage</span><span class=p>(</span><span class=n>stage</span><span class=p>);</span>
<a id=__codelineno-42-8 name=__codelineno-42-8></a><a href=#__codelineno-42-8><span class=linenos data-linenos=" 8 "></span></a>    <span class=n>currentGenerator</span> <span class=o>=</span> <span class=n>getNextGenerator</span><span class=p>();</span>
<a id=__codelineno-42-9 name=__codelineno-42-9></a><a href=#__codelineno-42-9><span class=linenos data-linenos=" 9 "></span></a>
<a id=__codelineno-42-10 name=__codelineno-42-10></a><a href=#__codelineno-42-10><span class=linenos data-linenos="10 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>stage</span> <span class=o>==</span> <span class=n>Stage</span><span class=p>.</span><span class=na>SOURCE</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-42-11 name=__codelineno-42-11></a><a href=#__codelineno-42-11><span class=linenos data-linenos="11 "></span></a>      <span class=n>reschedule</span><span class=p>();</span>
<a id=__codelineno-42-12 name=__codelineno-42-12></a><a href=#__codelineno-42-12><span class=linenos data-linenos="12 "></span></a>      <span class=k>return</span><span class=p>;</span>
<a id=__codelineno-42-13 name=__codelineno-42-13></a><a href=#__codelineno-42-13><span class=linenos data-linenos="13 "></span></a>    <span class=p>}</span>
<a id=__codelineno-42-14 name=__codelineno-42-14></a><a href=#__codelineno-42-14><span class=linenos data-linenos="14 "></span></a>  <span class=p>}</span>
<a id=__codelineno-42-15 name=__codelineno-42-15></a><a href=#__codelineno-42-15><span class=linenos data-linenos="15 "></span></a>  <span class=c1>// We&#39;ve run out of stages and generators, give up.</span>
<a id=__codelineno-42-16 name=__codelineno-42-16></a><a href=#__codelineno-42-16><span class=linenos data-linenos="16 "></span></a>  <span class=k>if</span> <span class=p>((</span><span class=n>stage</span> <span class=o>==</span> <span class=n>Stage</span><span class=p>.</span><span class=na>FINISHED</span> <span class=o>||</span> <span class=n>isCancelled</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>isStarted</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-42-17 name=__codelineno-42-17></a><a href=#__codelineno-42-17><span class=linenos data-linenos="17 "></span></a>    <span class=n>notifyFailed</span><span class=p>();</span>
<a id=__codelineno-42-18 name=__codelineno-42-18></a><a href=#__codelineno-42-18><span class=linenos data-linenos="18 "></span></a>  <span class=p>}</span>
<a id=__codelineno-42-19 name=__codelineno-42-19></a><a href=#__codelineno-42-19><span class=linenos data-linenos="19 "></span></a>
<a id=__codelineno-42-20 name=__codelineno-42-20></a><a href=#__codelineno-42-20><span class=linenos data-linenos="20 "></span></a>  <span class=c1>// Otherwise a generator started a new load and we expect to be called back in</span>
<a id=__codelineno-42-21 name=__codelineno-42-21></a><a href=#__codelineno-42-21><span class=linenos data-linenos="21 "></span></a>  <span class=c1>// onDataFetcherReady.</span>
<a id=__codelineno-42-22 name=__codelineno-42-22></a><a href=#__codelineno-42-22><span class=linenos data-linenos="22 "></span></a><span class=p>}</span>
</code></pre></div> <p>åœ¨è¯¥æ–¹æ³•ä¸­ä¼šä¾æ¬¡è°ƒç”¨å„ä¸ªçŠ¶æ€ç”Ÿæˆçš„<code>DataFetcherGenerator</code>çš„<code>startNext()</code>å°è¯•fetchæ•°æ®ï¼Œç›´åˆ°æœ‰æŸä¸ªçŠ¶æ€çš„<code>DataFetcherGenerator.startNext()</code>æ–¹æ³•å¯ä»¥èƒœä»»ã€‚è‹¥çŠ¶æ€æŠµè¾¾åˆ°äº†<code>Stage.FINISHED</code>æˆ–jobè¢«å–æ¶ˆï¼Œä¸”æ‰€æœ‰çŠ¶æ€çš„<code>DataFetcherGenerator.startNext()</code>éƒ½æ— æ³•æ»¡è¶³æ¡ä»¶ï¼Œåˆ™è°ƒç”¨<code>SingleRequest.onLoadFailed</code>è¿›è¡Œé”™è¯¯å¤„ç†ã€‚ </p> <p>è¿™é‡Œæ€»å…±æœ‰ä¸‰ä¸ª<code>DataFetcherGenerator</code>ï¼Œä¾æ¬¡æ˜¯ï¼š</p> <ol> <li>ResourceCacheGenerator<br> è·å–é‡‡æ ·åã€transformedåèµ„æºæ–‡ä»¶çš„ç¼“å­˜æ–‡ä»¶</li> <li>DataCacheGenerator<br> è·å–åŸå§‹çš„æ²¡æœ‰ä¿®æ”¹è¿‡çš„èµ„æºæ–‡ä»¶çš„ç¼“å­˜æ–‡ä»¶</li> <li>SourceGenerator<br> è·å–åŸå§‹æºæ•°æ®</li> </ol> <p>è¿™é‡Œé¢fetchæ•°æ®é€»è¾‘æœ‰ç‚¹å¤æ‚ï¼Œå› ä¸ºæ¶‰åŠåˆ°<code>Registry</code>ç±»ï¼Œè¯¥ç±»æ˜¯ç”¨æ¥ç®¡ç†Glideæ³¨å†Œè¿›æ¥çš„ç”¨æ¥æ‹“å±•æˆ–æ›¿ä»£Glideé»˜è®¤åŠ è½½ã€è§£ç ã€ç¼–ç é€»è¾‘çš„ç»„ä»¶ã€‚åœ¨Glideåˆ›å»ºçš„æ—¶å€™ï¼Œç»å¤§å¤šæ•°ä»£ç éƒ½æ˜¯å¯¹<code>Registry</code>çš„æ“ä½œã€‚</p> <p>æˆ‘ä»¬å…ˆå¤§è‡´è¯´ä¸€ä¸‹<code>Registry</code>ç±»é‡Œé¢å„ä¸ªç»„ä»¶çš„åŠŸèƒ½å§ã€‚</p> <h3 id=35-registry>3.5 Registry<a class=headerlink href=#35-registry title="Anchor link to this section for reference">&para;</a></h3> <p>Glideåœ¨åˆ›å»ºæ—¶ï¼Œä¼šå‘<code>Registry</code>å®ä¾‹ä¸­æ³¨å…¥ç›¸å½“å¤šçš„é…ç½®ï¼Œæ¯ä¸ªé…ç½®éƒ½ä¼šè½¬å‘ç»™å¯¹åº”çš„ä¸€ä¸ªä¸“é—¨çš„ç±»ï¼Œè¿™äº›ä¸“é—¨çš„ç±»æœ‰7ä¸ªã€‚<br> åœ¨è¿™7ä¸ªç±»ä¸­ï¼Œé™¤äº†<code>DataRewinderRegistry</code>å’Œ<code>ImageHeaderParserRegistry</code>å¤–ï¼Œå…¶ä»–çš„Registryéƒ½ä¼šå°†æ³¨å…¥çš„é…ç½®ä¿å­˜åˆ°å†…éƒ¨çš„<code>Entry</code>ç±»ä¸­ã€‚<code>Entry</code>ç±»çš„ä½œç”¨å°±æ˜¯åˆ¤æ–­è¯¥é¡¹é…ç½®èƒ½å¤Ÿæ»¡è¶³æ¡ä»¶ï¼ˆ<code>handles</code>ï¼‰ã€‚<br> <code>handles</code>æ–¹æ³•éƒ½æ˜¯ä»¥<code>isAssignableFrom</code>æ–¹æ³•åˆ¤æ–­ï¼Œä½†è¢«åˆ¤æ–­å‚æ•°æœ‰ä¸€äº›å·®åˆ«ã€‚</p> <p>åœ¨å„ä¸ªRegistryä¸­<code>Entry</code>ç±»çš„<code>hanldes</code>å®ç°å‰ï¼Œå…ˆç†è§£ä¸€ä¸‹è¿™é‡Œé¢å‡ºç°çš„å„ç§classï¼š</p> <ul> <li><code>modelClass</code><br> Glide.with(..).load()ä¸­è¢«loadå‚æ•°çš„ç±»å‹ï¼Œåœ¨å®ä¾‹ä¸­å°±æ˜¯String.class</li> <li><code>dataClass</code><br> æ¯”è¾ƒåŸå§‹çš„æ•°æ®ï¼Œæ ¹æ®<code>ModelLoaderRegistry</code>ä¸­çš„é…ç½®ï¼Œå¯ä»¥å¾—åˆ°æ‰€æœ‰ç”±<code>modelClass</code>æœ‰å¯èƒ½åˆ°è¾¾çš„<code>dataClass</code><br> åŒæ—¶ï¼Œä¸€èµ·æ³¨å…¥çš„<code>ModelLoaderFactory&lt;Model, Data&gt;</code>æ˜¯ä¸€ä¸ªå¯ä»¥åˆ›å»ºå¦‚ä½•ä»<code>modelClass</code>åˆ°<code>dataClass</code>è¿›è¡Œè½¬æ¢çš„<code>ModelLoader&lt;Model, Data&gt;</code>çš„ç±»çš„å·¥å‚ï¼Œå¯ä»¥æ ¹æ®<code>modelClass</code>è·å¾—</li> <li><code>resourceClass</code><br> è§£ç åçš„èµ„æºç±»å‹ï¼Œæ ¹æ®<code>ResourceDecoderRegistry</code>ä¸­çš„é…ç½®ï¼Œå¯ä»¥ç”±<code>dataClass</code>å’Œ<code>resourceClass</code>è·å¾—æ‰€æœ‰<code>registeredResourceClasses</code><br> åŒæ—¶ï¼Œä¸€èµ·æ³¨å…¥çš„<code>ResourceDecoder&lt;Data, Resource&gt;</code>æ˜¯ä¸€ä¸ªå°†<code>dataClass</code>è§£ç æˆ<code>resourceClass</code>çš„ç±»ï¼Œå¯ä»¥ç”±æœ‰å¯èƒ½åˆ°è¾¾çš„<code>dataClass</code>ä»¥åŠ<code>registeredResourceClass</code>è·å¾—</li> <li><code>transcodeClass</code><br> æœ€ç»ˆè¦è½¬æ¢æˆçš„æ•°æ®ç±»å‹ï¼Œä¸€èˆ¬æƒ…å†µä¸‹Drawable.classï¼›è‹¥GlideåŠ è½½æ˜¯æŒ‡å®šäº†asBitmapã€asGifã€asFileï¼Œé‚£ä¹ˆæ­¤ç±»å‹å°±æ˜¯Bitmap.classã€GifDrawable.classã€File.class<br> è‹¥<code>registeredResourceClass</code>ä¸æ˜¯<code>transcodeClass</code>ç±»å‹ï¼Œåˆ™é€šè¿‡<code>TranscoderRegistry</code>æ³¨å…¥çš„<code>ResourceTranscoder&lt;Resource, T&gt;</code>å¯ä»¥å°†<code>resourceClass</code>è½¬ä¸º<code>transcodeClass</code></li> </ul> <p>ä¸‹é¢æ˜¯5ä¸ªåœ¨å„ä¸ªRegistryä¸­<code>Entry</code>ç±»çš„<code>hanldes</code>å®ç°ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-43-1 name=__codelineno-43-1></a><a href=#__codelineno-43-1><span class=linenos data-linenos=" 1 "></span></a><span class=c1>// MultiModelLoaderFactory.Entry</span>
<a id=__codelineno-43-2 name=__codelineno-43-2></a><a href=#__codelineno-43-2><span class=linenos data-linenos=" 2 "></span></a><span class=kd>private</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>Entry</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=n>Data</span><span class=o>&gt;</span> <span class=p>{</span>
<a id=__codelineno-43-3 name=__codelineno-43-3></a><a href=#__codelineno-43-3><span class=linenos data-linenos=" 3 "></span></a>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Model</span><span class=o>&gt;</span> <span class=n>modelClass</span><span class=p>;</span>
<a id=__codelineno-43-4 name=__codelineno-43-4></a><a href=#__codelineno-43-4><span class=linenos data-linenos=" 4 "></span></a>  <span class=nd>@Synthetic</span> <span class=kd>final</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>dataClass</span><span class=p>;</span>
<a id=__codelineno-43-5 name=__codelineno-43-5></a><a href=#__codelineno-43-5><span class=linenos data-linenos=" 5 "></span></a>  <span class=p>...</span>
<a id=__codelineno-43-6 name=__codelineno-43-6></a><a href=#__codelineno-43-6><span class=linenos data-linenos=" 6 "></span></a>  <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>handles</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>modelClass</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>dataClass</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-43-7 name=__codelineno-43-7></a><a href=#__codelineno-43-7><span class=linenos data-linenos=" 7 "></span></a>    <span class=k>return</span> <span class=n>handles</span><span class=p>(</span><span class=n>modelClass</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=k>this</span><span class=p>.</span><span class=na>dataClass</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>dataClass</span><span class=p>);</span>
<a id=__codelineno-43-8 name=__codelineno-43-8></a><a href=#__codelineno-43-8><span class=linenos data-linenos=" 8 "></span></a>  <span class=p>}</span>
<a id=__codelineno-43-9 name=__codelineno-43-9></a><a href=#__codelineno-43-9><span class=linenos data-linenos=" 9 "></span></a>
<a id=__codelineno-43-10 name=__codelineno-43-10></a><a href=#__codelineno-43-10><span class=linenos data-linenos="10 "></span></a>  <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>handles</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>modelClass</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-43-11 name=__codelineno-43-11></a><a href=#__codelineno-43-11><span class=linenos data-linenos="11 "></span></a>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=na>modelClass</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>modelClass</span><span class=p>);</span>
<a id=__codelineno-43-12 name=__codelineno-43-12></a><a href=#__codelineno-43-12><span class=linenos data-linenos="12 "></span></a>  <span class=p>}</span>
<a id=__codelineno-43-13 name=__codelineno-43-13></a><a href=#__codelineno-43-13><span class=linenos data-linenos="13 "></span></a><span class=p>}</span>
<a id=__codelineno-43-14 name=__codelineno-43-14></a><a href=#__codelineno-43-14><span class=linenos data-linenos="14 "></span></a>
<a id=__codelineno-43-15 name=__codelineno-43-15></a><a href=#__codelineno-43-15><span class=linenos data-linenos="15 "></span></a><span class=c1>// EncoderRegistry.Entry</span>
<a id=__codelineno-43-16 name=__codelineno-43-16></a><a href=#__codelineno-43-16><span class=linenos data-linenos="16 "></span></a><span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>Entry</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=p>{</span>
<a id=__codelineno-43-17 name=__codelineno-43-17></a><a href=#__codelineno-43-17><span class=linenos data-linenos="17 "></span></a>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>dataClass</span><span class=p>;</span>
<a id=__codelineno-43-18 name=__codelineno-43-18></a><a href=#__codelineno-43-18><span class=linenos data-linenos="18 "></span></a>  <span class=p>...</span>
<a id=__codelineno-43-19 name=__codelineno-43-19></a><a href=#__codelineno-43-19><span class=linenos data-linenos="19 "></span></a>  <span class=kt>boolean</span> <span class=nf>handles</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>dataClass</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-43-20 name=__codelineno-43-20></a><a href=#__codelineno-43-20><span class=linenos data-linenos="20 "></span></a>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=na>dataClass</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>dataClass</span><span class=p>);</span>
<a id=__codelineno-43-21 name=__codelineno-43-21></a><a href=#__codelineno-43-21><span class=linenos data-linenos="21 "></span></a>  <span class=p>}</span>
<a id=__codelineno-43-22 name=__codelineno-43-22></a><a href=#__codelineno-43-22><span class=linenos data-linenos="22 "></span></a><span class=p>}</span>
<a id=__codelineno-43-23 name=__codelineno-43-23></a><a href=#__codelineno-43-23><span class=linenos data-linenos="23 "></span></a>
<a id=__codelineno-43-24 name=__codelineno-43-24></a><a href=#__codelineno-43-24><span class=linenos data-linenos="24 "></span></a><span class=c1>// ResourceEncoderRegistry.Entry</span>
<a id=__codelineno-43-25 name=__codelineno-43-25></a><a href=#__codelineno-43-25><span class=linenos data-linenos="25 "></span></a><span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>Entry</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=p>{</span>
<a id=__codelineno-43-26 name=__codelineno-43-26></a><a href=#__codelineno-43-26><span class=linenos data-linenos="26 "></span></a>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>resourceClass</span><span class=p>;</span>
<a id=__codelineno-43-27 name=__codelineno-43-27></a><a href=#__codelineno-43-27><span class=linenos data-linenos="27 "></span></a>  <span class=p>...</span>
<a id=__codelineno-43-28 name=__codelineno-43-28></a><a href=#__codelineno-43-28><span class=linenos data-linenos="28 "></span></a>  <span class=nd>@Synthetic</span>
<a id=__codelineno-43-29 name=__codelineno-43-29></a><a href=#__codelineno-43-29><span class=linenos data-linenos="29 "></span></a>  <span class=kt>boolean</span> <span class=nf>handles</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>resourceClass</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-43-30 name=__codelineno-43-30></a><a href=#__codelineno-43-30><span class=linenos data-linenos="30 "></span></a>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=na>resourceClass</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>resourceClass</span><span class=p>);</span>
<a id=__codelineno-43-31 name=__codelineno-43-31></a><a href=#__codelineno-43-31><span class=linenos data-linenos="31 "></span></a>  <span class=p>}</span>
<a id=__codelineno-43-32 name=__codelineno-43-32></a><a href=#__codelineno-43-32><span class=linenos data-linenos="32 "></span></a><span class=p>}</span>
<a id=__codelineno-43-33 name=__codelineno-43-33></a><a href=#__codelineno-43-33><span class=linenos data-linenos="33 "></span></a>
<a id=__codelineno-43-34 name=__codelineno-43-34></a><a href=#__codelineno-43-34><span class=linenos data-linenos="34 "></span></a><span class=c1>// ResourceDecoderRegistry.Entry</span>
<a id=__codelineno-43-35 name=__codelineno-43-35></a><a href=#__codelineno-43-35><span class=linenos data-linenos="35 "></span></a><span class=kd>private</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>Entry</span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span> <span class=n>R</span><span class=o>&gt;</span> <span class=p>{</span>
<a id=__codelineno-43-36 name=__codelineno-43-36></a><a href=#__codelineno-43-36><span class=linenos data-linenos="36 "></span></a>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>dataClass</span><span class=p>;</span>
<a id=__codelineno-43-37 name=__codelineno-43-37></a><a href=#__codelineno-43-37><span class=linenos data-linenos="37 "></span></a>  <span class=nd>@Synthetic</span> <span class=kd>final</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>resourceClass</span><span class=p>;</span>
<a id=__codelineno-43-38 name=__codelineno-43-38></a><a href=#__codelineno-43-38><span class=linenos data-linenos="38 "></span></a>  <span class=p>...</span>
<a id=__codelineno-43-39 name=__codelineno-43-39></a><a href=#__codelineno-43-39><span class=linenos data-linenos="39 "></span></a>  <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>handles</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>dataClass</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>resourceClass</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-43-40 name=__codelineno-43-40></a><a href=#__codelineno-43-40><span class=linenos data-linenos="40 "></span></a>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=na>dataClass</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>dataClass</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=n>resourceClass</span>
<a id=__codelineno-43-41 name=__codelineno-43-41></a><a href=#__codelineno-43-41><span class=linenos data-linenos="41 "></span></a>        <span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>resourceClass</span><span class=p>);</span>
<a id=__codelineno-43-42 name=__codelineno-43-42></a><a href=#__codelineno-43-42><span class=linenos data-linenos="42 "></span></a>  <span class=p>}</span>
<a id=__codelineno-43-43 name=__codelineno-43-43></a><a href=#__codelineno-43-43><span class=linenos data-linenos="43 "></span></a><span class=p>}</span>
<a id=__codelineno-43-44 name=__codelineno-43-44></a><a href=#__codelineno-43-44><span class=linenos data-linenos="44 "></span></a>
<a id=__codelineno-43-45 name=__codelineno-43-45></a><a href=#__codelineno-43-45><span class=linenos data-linenos="45 "></span></a><span class=c1>// TranscoderRegistry.Entry</span>
<a id=__codelineno-43-46 name=__codelineno-43-46></a><a href=#__codelineno-43-46><span class=linenos data-linenos="46 "></span></a><span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>Entry</span><span class=o>&lt;</span><span class=n>Z</span><span class=p>,</span> <span class=n>R</span><span class=o>&gt;</span> <span class=p>{</span>
<a id=__codelineno-43-47 name=__codelineno-43-47></a><a href=#__codelineno-43-47><span class=linenos data-linenos="47 "></span></a>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>fromClass</span><span class=p>;</span>
<a id=__codelineno-43-48 name=__codelineno-43-48></a><a href=#__codelineno-43-48><span class=linenos data-linenos="48 "></span></a>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>toClass</span><span class=p>;</span>
<a id=__codelineno-43-49 name=__codelineno-43-49></a><a href=#__codelineno-43-49><span class=linenos data-linenos="49 "></span></a>  <span class=p>...</span>
<a id=__codelineno-43-50 name=__codelineno-43-50></a><a href=#__codelineno-43-50><span class=linenos data-linenos="50 "></span></a>  <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>handles</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>fromClass</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>toClass</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-43-51 name=__codelineno-43-51></a><a href=#__codelineno-43-51><span class=linenos data-linenos="51 "></span></a>    <span class=k>return</span> <span class=k>this</span><span class=p>.</span><span class=na>fromClass</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>fromClass</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=n>toClass</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=na>toClass</span><span class=p>);</span>
<a id=__codelineno-43-52 name=__codelineno-43-52></a><a href=#__codelineno-43-52><span class=linenos data-linenos="52 "></span></a>  <span class=p>}</span>
<a id=__codelineno-43-53 name=__codelineno-43-53></a><a href=#__codelineno-43-53><span class=linenos data-linenos="53 "></span></a><span class=p>}</span>
</code></pre></div> <blockquote> <p><code>isAssignableFrom</code>åˆ¤æ–­è¯¥ç±»æ˜¯å¦æ˜¯æŸä¸ªç±»çš„çˆ¶ç±»ï¼Œ<code>instanceof</code>åˆ¤æ–­è¯¥å®ä¾‹çš„ç±»æ˜¯å¦æŸä¸ªå®ä¾‹çš„ç±»çš„å­ç±»ã€‚</p> </blockquote> <p>è¿™7ä¸ªRegistryç±»ä½œç”¨å¦‚ä¸‹ï¼š</p> <ol> <li>ModelLoaderRegistry<br> æ„å»º<code>modelClass</code>åˆ°<code>dataClass</code>çš„æ¡¥æ¢<br> <em>load custom Models (Urls, Uris, arbitrary POJOs) and Data (InputStreams, FileDescriptors).</em></li> <li>ResourceDecoderRegistry<br> <code>dataClass</code>åˆ°<code>resourceClass</code>çš„æ¡¥æ¢<br> <em>to decode new Resources (Drawables, Bitmaps) or new types of Data (InputStreams, FileDescriptors).</em></li> <li>EncoderRegistry<br> <em>write Data (InputStreams, FileDescriptors) to Glideâ€™s disk cache</em></li> <li>TranscoderRegistry<br> æ„å»º<code>resourceClass</code>åˆ°<code>transcodeClass</code>çš„æ¡¥æ¢<br> <em>convert Resources (BitmapResource) into other types of Resources (DrawableResource)</em></li> <li>ResourceEncoderRegistry<br> <em>write Resources (BitmapResource, DrawableResource) to Glideâ€™s disk cache.</em></li> <li>DataRewinderRegistry<br> æä¾›å¯¹<code>ByteBuffer.class</code>ã€<code>InputStream.class</code>è¿™ä¸¤ç§dataè¿›è¡Œrewindæ“ä½œçš„èƒ½åŠ›</li> <li>ImageHeaderParserRegistry<br> æä¾›è§£æImageå¤´ä¿¡æ¯çš„èƒ½åŠ›</li> </ol> <blockquote> <ol> <li><code>ModelLoaders</code> to load custom Models (Urls, Uris, arbitrary POJOs) and Data (InputStreams, FileDescriptors). </li> <li><code>ResourceDecoders</code> to decode new Resources (Drawables, Bitmaps) or new types of Data (InputStreams, FileDescriptors). </li> <li><code>Encoders</code> to write Data (InputStreams, FileDescriptors) to Glideâ€™s disk cache. </li> <li><code>ResourceTranscoders</code> to convert Resources (BitmapResource) into other types of Resources (DrawableResource). </li> <li><code>ResourceEncoders</code> to write Resources (BitmapResource, DrawableResource) to Glideâ€™s disk cache. </li> </ol> <p><strong>Anatomy of a load</strong><br> The set of registered components, including both those registered by default in Glide and those registered in Modules are used to define a set of load paths. Each load path is a step by step progression from the the Model provided to <code>load()</code> to the Resource type specified by <code>as()</code>. A load path consists (roughly) of the following steps:<br> 1. Model -&gt; Data (handled by <code>ModelLoader</code>s) 2. Data -&gt; Resource (handled by <code>ResourceDecoder</code>s) 3. Resource -&gt; Transcoded Resource (optional, handled by <code>ResourceTranscoder</code>s).</p> <p><code>Encoder</code>s can write Data to Glideâ€™s disk cache cache before step 2.<br> <code>ResourceEncoder</code>s can write Resourceâ€™s to Glideâ€™s disk cache before step 3.<br> When a request is started, Glide will attempt all available paths from the Model to the requested Resource type. A request will succeed if any load path succeeds. A request will fail only if all available load paths fail. </p> <p><cite><a href=http://bumptech.github.io/glide/doc/configuration.html#registering-components>Configuration - Registering Components</a></cite> </p> </blockquote> <h3 id=36-resourcecachegenerator>3.6 ResourceCacheGenerator<a class=headerlink href=#36-resourcecachegenerator title="Anchor link to this section for reference">&para;</a></h3> <p>ä¸‹é¢æˆ‘ä»¬çœ‹çœ‹<code>ResourceCacheGenerator.startNext</code>æ–¹æ³•ï¼Œç”±äºæ–¹æ³•è¿™é‡Œé¢æ–¹æ³•è°ƒç”¨å±‚æ¬¡éå¸¸æ·±ï¼Œæ‰€ä»¥å…ˆç›´æ¥å†™ä¸Šæ¯ä¸€æ­¥æ‰§è¡Œçš„ç»“æœï¼Œæœ‰ä¸€ä¸ªå¤§ä½“ä¸Šçš„äº†è§£ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-44-1 name=__codelineno-44-1></a><a href=#__codelineno-44-1><span class=linenos data-linenos=" 1 "></span></a><span class=nd>@Override</span>
<a id=__codelineno-44-2 name=__codelineno-44-2></a><a href=#__codelineno-44-2><span class=linenos data-linenos=" 2 "></span></a><span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>startNext</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-44-3 name=__codelineno-44-3></a><a href=#__codelineno-44-3><span class=linenos data-linenos=" 3 "></span></a> <span class=c1>// listé‡Œé¢åªæœ‰ä¸€ä¸ªGlideUrlå¯¹è±¡</span>
<a id=__codelineno-44-4 name=__codelineno-44-4></a><a href=#__codelineno-44-4><span class=linenos data-linenos=" 4 "></span></a> <span class=n>List</span><span class=o>&lt;</span><span class=n>Key</span><span class=o>&gt;</span> <span class=n>sourceIds</span> <span class=o>=</span> <span class=n>helper</span><span class=p>.</span><span class=na>getCacheKeys</span><span class=p>();</span>
<a id=__codelineno-44-5 name=__codelineno-44-5></a><a href=#__codelineno-44-5><span class=linenos data-linenos=" 5 "></span></a> <span class=k>if</span> <span class=p>(</span><span class=n>sourceIds</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span> <span class=p>{</span>
<a id=__codelineno-44-6 name=__codelineno-44-6></a><a href=#__codelineno-44-6><span class=linenos data-linenos=" 6 "></span></a>   <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
<a id=__codelineno-44-7 name=__codelineno-44-7></a><a href=#__codelineno-44-7><span class=linenos data-linenos=" 7 "></span></a> <span class=p>}</span>
<a id=__codelineno-44-8 name=__codelineno-44-8></a><a href=#__codelineno-44-8><span class=linenos data-linenos=" 8 "></span></a> <span class=c1>// è·å¾—äº†ä¸‰ä¸ªå¯ä»¥åˆ°è¾¾çš„registeredResourceClasses</span>
<a id=__codelineno-44-9 name=__codelineno-44-9></a><a href=#__codelineno-44-9><span class=linenos data-linenos=" 9 "></span></a> <span class=c1>// GifDrawableã€Bitmapã€BitmapDrawable</span>
<a id=__codelineno-44-10 name=__codelineno-44-10></a><a href=#__codelineno-44-10><span class=linenos data-linenos="10 "></span></a> <span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>resourceClasses</span> <span class=o>=</span> <span class=n>helper</span><span class=p>.</span><span class=na>getRegisteredResourceClasses</span><span class=p>();</span>
<a id=__codelineno-44-11 name=__codelineno-44-11></a><a href=#__codelineno-44-11><span class=linenos data-linenos="11 "></span></a> <span class=k>if</span> <span class=p>(</span><span class=n>resourceClasses</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span> <span class=p>{</span>
<a id=__codelineno-44-12 name=__codelineno-44-12></a><a href=#__codelineno-44-12><span class=linenos data-linenos="12 "></span></a>   <span class=k>if</span> <span class=p>(</span><span class=n>File</span><span class=p>.</span><span class=na>class</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>helper</span><span class=p>.</span><span class=na>getTranscodeClass</span><span class=p>()))</span> <span class=p>{</span>
<a id=__codelineno-44-13 name=__codelineno-44-13></a><a href=#__codelineno-44-13><span class=linenos data-linenos="13 "></span></a>     <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
<a id=__codelineno-44-14 name=__codelineno-44-14></a><a href=#__codelineno-44-14><span class=linenos data-linenos="14 "></span></a>   <span class=p>}</span>
<a id=__codelineno-44-15 name=__codelineno-44-15></a><a href=#__codelineno-44-15><span class=linenos data-linenos="15 "></span></a>   <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=p>(</span>
<a id=__codelineno-44-16 name=__codelineno-44-16></a><a href=#__codelineno-44-16><span class=linenos data-linenos="16 "></span></a>       <span class=s>&quot;Failed to find any load path from &quot;</span> <span class=o>+</span> <span class=n>helper</span><span class=p>.</span><span class=na>getModelClass</span><span class=p>()</span> <span class=o>+</span> <span class=s>&quot; to &quot;</span>
<a id=__codelineno-44-17 name=__codelineno-44-17></a><a href=#__codelineno-44-17><span class=linenos data-linenos="17 "></span></a>           <span class=o>+</span> <span class=n>helper</span><span class=p>.</span><span class=na>getTranscodeClass</span><span class=p>());</span>
<a id=__codelineno-44-18 name=__codelineno-44-18></a><a href=#__codelineno-44-18><span class=linenos data-linenos="18 "></span></a> <span class=p>}</span>
<a id=__codelineno-44-19 name=__codelineno-44-19></a><a href=#__codelineno-44-19><span class=linenos data-linenos="19 "></span></a> <span class=c1>// éå†sourceIdsä¸­çš„æ¯ä¸€ä¸ªkeyã€resourceClassesä¸­æ¯ä¸€ä¸ªclassï¼Œä»¥åŠå…¶ä»–çš„ä¸€äº›å€¼ç»„æˆkey</span>
<a id=__codelineno-44-20 name=__codelineno-44-20></a><a href=#__codelineno-44-20><span class=linenos data-linenos="20 "></span></a> <span class=c1>// å°è¯•åœ¨ç£ç›˜ç¼“å­˜ä¸­ä»¥keyæ‰¾åˆ°ç¼“å­˜æ–‡ä»¶</span>
<a id=__codelineno-44-21 name=__codelineno-44-21></a><a href=#__codelineno-44-21><span class=linenos data-linenos="21 "></span></a> <span class=k>while</span> <span class=p>(</span><span class=n>modelLoaders</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=o>!</span><span class=n>hasNextModelLoader</span><span class=p>())</span> <span class=p>{</span>
<a id=__codelineno-44-22 name=__codelineno-44-22></a><a href=#__codelineno-44-22><span class=linenos data-linenos="22 "></span></a>   <span class=n>resourceClassIndex</span><span class=o>++</span><span class=p>;</span>
<a id=__codelineno-44-23 name=__codelineno-44-23></a><a href=#__codelineno-44-23><span class=linenos data-linenos="23 "></span></a>   <span class=k>if</span> <span class=p>(</span><span class=n>resourceClassIndex</span> <span class=o>&gt;=</span> <span class=n>resourceClasses</span><span class=p>.</span><span class=na>size</span><span class=p>())</span> <span class=p>{</span>
<a id=__codelineno-44-24 name=__codelineno-44-24></a><a href=#__codelineno-44-24><span class=linenos data-linenos="24 "></span></a>     <span class=n>sourceIdIndex</span><span class=o>++</span><span class=p>;</span>
<a id=__codelineno-44-25 name=__codelineno-44-25></a><a href=#__codelineno-44-25><span class=linenos data-linenos="25 "></span></a>     <span class=k>if</span> <span class=p>(</span><span class=n>sourceIdIndex</span> <span class=o>&gt;=</span> <span class=n>sourceIds</span><span class=p>.</span><span class=na>size</span><span class=p>())</span> <span class=p>{</span>
<a id=__codelineno-44-26 name=__codelineno-44-26></a><a href=#__codelineno-44-26><span class=linenos data-linenos="26 "></span></a>       <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
<a id=__codelineno-44-27 name=__codelineno-44-27></a><a href=#__codelineno-44-27><span class=linenos data-linenos="27 "></span></a>     <span class=p>}</span>
<a id=__codelineno-44-28 name=__codelineno-44-28></a><a href=#__codelineno-44-28><span class=linenos data-linenos="28 "></span></a>     <span class=n>resourceClassIndex</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
<a id=__codelineno-44-29 name=__codelineno-44-29></a><a href=#__codelineno-44-29><span class=linenos data-linenos="29 "></span></a>   <span class=p>}</span>
<a id=__codelineno-44-30 name=__codelineno-44-30></a><a href=#__codelineno-44-30><span class=linenos data-linenos="30 "></span></a>
<a id=__codelineno-44-31 name=__codelineno-44-31></a><a href=#__codelineno-44-31><span class=linenos data-linenos="31 "></span></a>   <span class=n>Key</span> <span class=n>sourceId</span> <span class=o>=</span> <span class=n>sourceIds</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>sourceIdIndex</span><span class=p>);</span>
<a id=__codelineno-44-32 name=__codelineno-44-32></a><a href=#__codelineno-44-32><span class=linenos data-linenos="32 "></span></a>   <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>resourceClass</span> <span class=o>=</span> <span class=n>resourceClasses</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>resourceClassIndex</span><span class=p>);</span>
<a id=__codelineno-44-33 name=__codelineno-44-33></a><a href=#__codelineno-44-33><span class=linenos data-linenos="33 "></span></a>   <span class=n>Transformation</span><span class=o>&lt;?&gt;</span> <span class=n>transformation</span> <span class=o>=</span> <span class=n>helper</span><span class=p>.</span><span class=na>getTransformation</span><span class=p>(</span><span class=n>resourceClass</span><span class=p>);</span>
<a id=__codelineno-44-34 name=__codelineno-44-34></a><a href=#__codelineno-44-34><span class=linenos data-linenos="34 "></span></a>   <span class=c1>// PMD.AvoidInstantiatingObjectsInLoops Each iteration is comparatively expensive anyway,</span>
<a id=__codelineno-44-35 name=__codelineno-44-35></a><a href=#__codelineno-44-35><span class=linenos data-linenos="35 "></span></a>   <span class=c1>// we only run until the first one succeeds, the loop runs for only a limited</span>
<a id=__codelineno-44-36 name=__codelineno-44-36></a><a href=#__codelineno-44-36><span class=linenos data-linenos="36 "></span></a>   <span class=c1>// number of iterations on the order of 10-20 in the worst case.</span>
<a id=__codelineno-44-37 name=__codelineno-44-37></a><a href=#__codelineno-44-37><span class=linenos data-linenos="37 "></span></a>   <span class=n>currentKey</span> <span class=o>=</span>
<a id=__codelineno-44-38 name=__codelineno-44-38></a><a href=#__codelineno-44-38><span class=linenos data-linenos="38 "></span></a>       <span class=k>new</span> <span class=n>ResourceCacheKey</span><span class=p>(</span><span class=c1>// NOPMD AvoidInstantiatingObjectsInLoops</span>
<a id=__codelineno-44-39 name=__codelineno-44-39></a><a href=#__codelineno-44-39><span class=linenos data-linenos="39 "></span></a>           <span class=n>helper</span><span class=p>.</span><span class=na>getArrayPool</span><span class=p>(),</span>
<a id=__codelineno-44-40 name=__codelineno-44-40></a><a href=#__codelineno-44-40><span class=linenos data-linenos="40 "></span></a>           <span class=n>sourceId</span><span class=p>,</span>
<a id=__codelineno-44-41 name=__codelineno-44-41></a><a href=#__codelineno-44-41><span class=linenos data-linenos="41 "></span></a>           <span class=n>helper</span><span class=p>.</span><span class=na>getSignature</span><span class=p>(),</span>
<a id=__codelineno-44-42 name=__codelineno-44-42></a><a href=#__codelineno-44-42><span class=linenos data-linenos="42 "></span></a>           <span class=n>helper</span><span class=p>.</span><span class=na>getWidth</span><span class=p>(),</span>
<a id=__codelineno-44-43 name=__codelineno-44-43></a><a href=#__codelineno-44-43><span class=linenos data-linenos="43 "></span></a>           <span class=n>helper</span><span class=p>.</span><span class=na>getHeight</span><span class=p>(),</span>
<a id=__codelineno-44-44 name=__codelineno-44-44></a><a href=#__codelineno-44-44><span class=linenos data-linenos="44 "></span></a>           <span class=n>transformation</span><span class=p>,</span>
<a id=__codelineno-44-45 name=__codelineno-44-45></a><a href=#__codelineno-44-45><span class=linenos data-linenos="45 "></span></a>           <span class=n>resourceClass</span><span class=p>,</span>
<a id=__codelineno-44-46 name=__codelineno-44-46></a><a href=#__codelineno-44-46><span class=linenos data-linenos="46 "></span></a>           <span class=n>helper</span><span class=p>.</span><span class=na>getOptions</span><span class=p>());</span>
<a id=__codelineno-44-47 name=__codelineno-44-47></a><a href=#__codelineno-44-47><span class=linenos data-linenos="47 "></span></a>   <span class=n>cacheFile</span> <span class=o>=</span> <span class=n>helper</span><span class=p>.</span><span class=na>getDiskCache</span><span class=p>().</span><span class=na>get</span><span class=p>(</span><span class=n>currentKey</span><span class=p>);</span>
<a id=__codelineno-44-48 name=__codelineno-44-48></a><a href=#__codelineno-44-48><span class=linenos data-linenos="48 "></span></a>   <span class=c1>// å¦‚æœæ‰¾åˆ°äº†ç¼“å­˜æ–‡ä»¶ï¼Œé‚£ä¹ˆå¾ªç¯æ¡ä»¶åˆ™ä¼šä¸ºfalseï¼Œä¹Ÿå°±é€€å‡ºå¾ªç¯äº†</span>
<a id=__codelineno-44-49 name=__codelineno-44-49></a><a href=#__codelineno-44-49><span class=linenos data-linenos="49 "></span></a>   <span class=k>if</span> <span class=p>(</span><span class=n>cacheFile</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-44-50 name=__codelineno-44-50></a><a href=#__codelineno-44-50><span class=linenos data-linenos="50 "></span></a>     <span class=n>sourceKey</span> <span class=o>=</span> <span class=n>sourceId</span><span class=p>;</span>
<a id=__codelineno-44-51 name=__codelineno-44-51></a><a href=#__codelineno-44-51><span class=linenos data-linenos="51 "></span></a>     <span class=n>modelLoaders</span> <span class=o>=</span> <span class=n>helper</span><span class=p>.</span><span class=na>getModelLoaders</span><span class=p>(</span><span class=n>cacheFile</span><span class=p>);</span>
<a id=__codelineno-44-52 name=__codelineno-44-52></a><a href=#__codelineno-44-52><span class=linenos data-linenos="52 "></span></a>     <span class=n>modelLoaderIndex</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
<a id=__codelineno-44-53 name=__codelineno-44-53></a><a href=#__codelineno-44-53><span class=linenos data-linenos="53 "></span></a>   <span class=p>}</span>
<a id=__codelineno-44-54 name=__codelineno-44-54></a><a href=#__codelineno-44-54><span class=linenos data-linenos="54 "></span></a> <span class=p>}</span>
<a id=__codelineno-44-55 name=__codelineno-44-55></a><a href=#__codelineno-44-55><span class=linenos data-linenos="55 "></span></a>
<a id=__codelineno-44-56 name=__codelineno-44-56></a><a href=#__codelineno-44-56><span class=linenos data-linenos="56 "></span></a> <span class=c1>// æ‰¾æ²¡æ‰¾åˆ°ç¼“å­˜æ–‡ä»¶ï¼Œéƒ½ä¼šæ‰§è¡Œè¿™é‡Œçš„æ–¹æ³•</span>
<a id=__codelineno-44-57 name=__codelineno-44-57></a><a href=#__codelineno-44-57><span class=linenos data-linenos="57 "></span></a> <span class=c1>// å¦‚æœæ‰¾åˆ°äº†ï¼ŒhasNextModelLoader()æ–¹æ³•åˆ™ä¼šä¸ºtrueï¼Œå¯ä»¥æ‰§è¡Œå¾ªç¯</span>
<a id=__codelineno-44-58 name=__codelineno-44-58></a><a href=#__codelineno-44-58><span class=linenos data-linenos="58 "></span></a> <span class=c1>// æ²¡æœ‰æ‰¾åˆ°ç¼“å­˜æ–‡ä»¶ï¼Œåˆ™ä¸ä¼šè¿›å…¥å¾ªç¯ï¼Œä¼šç›´æ¥è¿”å›false</span>
<a id=__codelineno-44-59 name=__codelineno-44-59></a><a href=#__codelineno-44-59><span class=linenos data-linenos="59 "></span></a> <span class=n>loadData</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-44-60 name=__codelineno-44-60></a><a href=#__codelineno-44-60><span class=linenos data-linenos="60 "></span></a> <span class=kt>boolean</span> <span class=n>started</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
<a id=__codelineno-44-61 name=__codelineno-44-61></a><a href=#__codelineno-44-61><span class=linenos data-linenos="61 "></span></a> <span class=k>while</span> <span class=p>(</span><span class=o>!</span><span class=n>started</span> <span class=o>&amp;&amp;</span> <span class=n>hasNextModelLoader</span><span class=p>())</span> <span class=p>{</span>
<a id=__codelineno-44-62 name=__codelineno-44-62></a><a href=#__codelineno-44-62><span class=linenos data-linenos="62 "></span></a>   <span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>File</span><span class=p>,</span> <span class=o>?&gt;</span> <span class=n>modelLoader</span> <span class=o>=</span> <span class=n>modelLoaders</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>modelLoaderIndex</span><span class=o>++</span><span class=p>);</span>
<a id=__codelineno-44-63 name=__codelineno-44-63></a><a href=#__codelineno-44-63><span class=linenos data-linenos="63 "></span></a>   <span class=c1>//  åœ¨å¾ªç¯ä¸­ä¼šä¾æ¬¡åˆ¤æ–­æŸä¸ªModelLoaderèƒ½ä¸èƒ½åŠ è½½æ­¤æ–‡ä»¶</span>
<a id=__codelineno-44-64 name=__codelineno-44-64></a><a href=#__codelineno-44-64><span class=linenos data-linenos="64 "></span></a>   <span class=n>loadData</span> <span class=o>=</span> <span class=n>modelLoader</span><span class=p>.</span><span class=na>buildLoadData</span><span class=p>(</span><span class=n>cacheFile</span><span class=p>,</span>
<a id=__codelineno-44-65 name=__codelineno-44-65></a><a href=#__codelineno-44-65><span class=linenos data-linenos="65 "></span></a>       <span class=n>helper</span><span class=p>.</span><span class=na>getWidth</span><span class=p>(),</span> <span class=n>helper</span><span class=p>.</span><span class=na>getHeight</span><span class=p>(),</span> <span class=n>helper</span><span class=p>.</span><span class=na>getOptions</span><span class=p>());</span>
<a id=__codelineno-44-66 name=__codelineno-44-66></a><a href=#__codelineno-44-66><span class=linenos data-linenos="66 "></span></a>   <span class=k>if</span> <span class=p>(</span><span class=n>loadData</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>helper</span><span class=p>.</span><span class=na>hasLoadPath</span><span class=p>(</span><span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>getDataClass</span><span class=p>()))</span> <span class=p>{</span>
<a id=__codelineno-44-67 name=__codelineno-44-67></a><a href=#__codelineno-44-67><span class=linenos data-linenos="67 "></span></a>     <span class=n>started</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
<a id=__codelineno-44-68 name=__codelineno-44-68></a><a href=#__codelineno-44-68><span class=linenos data-linenos="68 "></span></a>     <span class=c1>// å¦‚æœæŸä¸ªModelLoaderå¯ä»¥ï¼Œé‚£ä¹ˆå°±è°ƒç”¨å…¶fetcherè¿›è¡ŒåŠ è½½æ•°æ®</span>
<a id=__codelineno-44-69 name=__codelineno-44-69></a><a href=#__codelineno-44-69><span class=linenos data-linenos="69 "></span></a>     <span class=c1>// åŠ è½½æˆåŠŸæˆ–å¤±è´¥ä¼šé€šçŸ¥è‡ªèº«</span>
<a id=__codelineno-44-70 name=__codelineno-44-70></a><a href=#__codelineno-44-70><span class=linenos data-linenos="70 "></span></a>     <span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>loadData</span><span class=p>(</span><span class=n>helper</span><span class=p>.</span><span class=na>getPriority</span><span class=p>(),</span> <span class=k>this</span><span class=p>);</span>
<a id=__codelineno-44-71 name=__codelineno-44-71></a><a href=#__codelineno-44-71><span class=linenos data-linenos="71 "></span></a>   <span class=p>}</span>
<a id=__codelineno-44-72 name=__codelineno-44-72></a><a href=#__codelineno-44-72><span class=linenos data-linenos="72 "></span></a> <span class=p>}</span>
<a id=__codelineno-44-73 name=__codelineno-44-73></a><a href=#__codelineno-44-73><span class=linenos data-linenos="73 "></span></a>
<a id=__codelineno-44-74 name=__codelineno-44-74></a><a href=#__codelineno-44-74><span class=linenos data-linenos="74 "></span></a> <span class=k>return</span> <span class=n>started</span><span class=p>;</span>
<a id=__codelineno-44-75 name=__codelineno-44-75></a><a href=#__codelineno-44-75><span class=linenos data-linenos="75 "></span></a><span class=p>}</span>
</code></pre></div> <h4 id=361-helpergetcachekeys>3.6.1 helper.getCacheKeys<a class=headerlink href=#361-helpergetcachekeys title="Anchor link to this section for reference">&para;</a></h4> <p>æˆ‘ä»¬ä¸€è¡Œè¡Œè§£æè¿™é‡Œé¢çš„ä»£ç ï¼Œå…ˆçœ‹çœ‹<code>helper.getCacheKeys()</code>æ˜¯å¦‚ä½•æŠŠæˆ‘ä»¬ç»•æ™•åï¼ŒæˆåŠŸçš„å°†Stringè½¬æ¢ä¸ºGlideUrlçš„ã€‚</p> <p><strong>DecodeHelper.java</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-45-1 name=__codelineno-45-1></a><a href=#__codelineno-45-1><span class=linenos data-linenos=" 1 "></span></a><span class=n>List</span><span class=o>&lt;</span><span class=n>Key</span><span class=o>&gt;</span> <span class=nf>getCacheKeys</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-45-2 name=__codelineno-45-2></a><a href=#__codelineno-45-2><span class=linenos data-linenos=" 2 "></span></a> <span class=c1>// è¿™é‡Œä½¿ç”¨äº†ä¸€ä¸ªæ ‡å¿—ä½ï¼Œé˜²æ­¢åœ¨DataCacheGeneratorä¸­é‡å¤åŠ è½½</span>
<a id=__codelineno-45-3 name=__codelineno-45-3></a><a href=#__codelineno-45-3><span class=linenos data-linenos=" 3 "></span></a> <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>isCacheKeysSet</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-45-4 name=__codelineno-45-4></a><a href=#__codelineno-45-4><span class=linenos data-linenos=" 4 "></span></a>   <span class=n>isCacheKeysSet</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
<a id=__codelineno-45-5 name=__codelineno-45-5></a><a href=#__codelineno-45-5><span class=linenos data-linenos=" 5 "></span></a>   <span class=n>cacheKeys</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span>
<a id=__codelineno-45-6 name=__codelineno-45-6></a><a href=#__codelineno-45-6><span class=linenos data-linenos=" 6 "></span></a>   <span class=c1>// å¾—åˆ°å¯ä»¥å¤„ç†è¯¥è¯·æ±‚çš„ModelLoaderçš„LoadData list</span>
<a id=__codelineno-45-7 name=__codelineno-45-7></a><a href=#__codelineno-45-7><span class=linenos data-linenos=" 7 "></span></a>   <span class=n>List</span><span class=o>&lt;</span><span class=n>LoadData</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>loadData</span> <span class=o>=</span> <span class=n>getLoadData</span><span class=p>();</span>
<a id=__codelineno-45-8 name=__codelineno-45-8></a><a href=#__codelineno-45-8><span class=linenos data-linenos=" 8 "></span></a>   <span class=c1>// å°†æ¯ä¸€ä¸ªloadDataé‡Œçš„sourceKeyä»¥åŠæ¯ä¸€ä¸ªalternateKeysæ·»åŠ åˆ°cacheKeysä¸­</span>
<a id=__codelineno-45-9 name=__codelineno-45-9></a><a href=#__codelineno-45-9><span class=linenos data-linenos=" 9 "></span></a>   <span class=c1>// åœ¨æˆ‘ä»¬çš„ä¸‰æ­¥ä¾‹å­ä¸­sourceKeyä¸ºä¸€ä¸ªGlideUrlï¼ŒalternateKeysä¸ºç©º</span>
<a id=__codelineno-45-10 name=__codelineno-45-10></a><a href=#__codelineno-45-10><span class=linenos data-linenos="10 "></span></a>   <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>size</span> <span class=o>=</span> <span class=n>loadData</span><span class=p>.</span><span class=na>size</span><span class=p>();</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>size</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-45-11 name=__codelineno-45-11></a><a href=#__codelineno-45-11><span class=linenos data-linenos="11 "></span></a>     <span class=n>LoadData</span><span class=o>&lt;?&gt;</span> <span class=n>data</span> <span class=o>=</span> <span class=n>loadData</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
<a id=__codelineno-45-12 name=__codelineno-45-12></a><a href=#__codelineno-45-12><span class=linenos data-linenos="12 "></span></a>     <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>cacheKeys</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>data</span><span class=p>.</span><span class=na>sourceKey</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-45-13 name=__codelineno-45-13></a><a href=#__codelineno-45-13><span class=linenos data-linenos="13 "></span></a>       <span class=n>cacheKeys</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>data</span><span class=p>.</span><span class=na>sourceKey</span><span class=p>);</span>
<a id=__codelineno-45-14 name=__codelineno-45-14></a><a href=#__codelineno-45-14><span class=linenos data-linenos="14 "></span></a>     <span class=p>}</span>
<a id=__codelineno-45-15 name=__codelineno-45-15></a><a href=#__codelineno-45-15><span class=linenos data-linenos="15 "></span></a>     <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>data</span><span class=p>.</span><span class=na>alternateKeys</span><span class=p>.</span><span class=na>size</span><span class=p>();</span> <span class=n>j</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-45-16 name=__codelineno-45-16></a><a href=#__codelineno-45-16><span class=linenos data-linenos="16 "></span></a>       <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>cacheKeys</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>data</span><span class=p>.</span><span class=na>alternateKeys</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>j</span><span class=p>)))</span> <span class=p>{</span>
<a id=__codelineno-45-17 name=__codelineno-45-17></a><a href=#__codelineno-45-17><span class=linenos data-linenos="17 "></span></a>         <span class=n>cacheKeys</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>data</span><span class=p>.</span><span class=na>alternateKeys</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>j</span><span class=p>));</span>
<a id=__codelineno-45-18 name=__codelineno-45-18></a><a href=#__codelineno-45-18><span class=linenos data-linenos="18 "></span></a>       <span class=p>}</span>
<a id=__codelineno-45-19 name=__codelineno-45-19></a><a href=#__codelineno-45-19><span class=linenos data-linenos="19 "></span></a>     <span class=p>}</span>
<a id=__codelineno-45-20 name=__codelineno-45-20></a><a href=#__codelineno-45-20><span class=linenos data-linenos="20 "></span></a>   <span class=p>}</span>
<a id=__codelineno-45-21 name=__codelineno-45-21></a><a href=#__codelineno-45-21><span class=linenos data-linenos="21 "></span></a> <span class=p>}</span>
<a id=__codelineno-45-22 name=__codelineno-45-22></a><a href=#__codelineno-45-22><span class=linenos data-linenos="22 "></span></a> <span class=k>return</span> <span class=n>cacheKeys</span><span class=p>;</span>
<a id=__codelineno-45-23 name=__codelineno-45-23></a><a href=#__codelineno-45-23><span class=linenos data-linenos="23 "></span></a><span class=p>}</span>
<a id=__codelineno-45-24 name=__codelineno-45-24></a><a href=#__codelineno-45-24><span class=linenos data-linenos="24 "></span></a>
<a id=__codelineno-45-25 name=__codelineno-45-25></a><a href=#__codelineno-45-25><span class=linenos data-linenos="25 "></span></a><span class=n>List</span><span class=o>&lt;</span><span class=n>LoadData</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>getLoadData</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-45-26 name=__codelineno-45-26></a><a href=#__codelineno-45-26><span class=linenos data-linenos="26 "></span></a> <span class=c1>// è¿™é‡Œä¹Ÿä½¿ç”¨äº†ä¸€ä¸ªæ ‡å¿—ä½ï¼Œé˜²æ­¢åœ¨é‡å¤åŠ è½½</span>
<a id=__codelineno-45-27 name=__codelineno-45-27></a><a href=#__codelineno-45-27><span class=linenos data-linenos="27 "></span></a> <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>isLoadDataSet</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-45-28 name=__codelineno-45-28></a><a href=#__codelineno-45-28><span class=linenos data-linenos="28 "></span></a>   <span class=n>isLoadDataSet</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
<a id=__codelineno-45-29 name=__codelineno-45-29></a><a href=#__codelineno-45-29><span class=linenos data-linenos="29 "></span></a>   <span class=n>loadData</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span>
<a id=__codelineno-45-30 name=__codelineno-45-30></a><a href=#__codelineno-45-30><span class=linenos data-linenos="30 "></span></a>   <span class=c1>// è·å¾—äº†æ³¨å†Œçš„3ä¸ªModelLoader</span>
<a id=__codelineno-45-31 name=__codelineno-45-31></a><a href=#__codelineno-45-31><span class=linenos data-linenos="31 "></span></a>   <span class=n>List</span><span class=o>&lt;</span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>Object</span><span class=p>,</span> <span class=o>?&gt;&gt;</span> <span class=n>modelLoaders</span> <span class=o>=</span> <span class=n>glideContext</span><span class=p>.</span><span class=na>getRegistry</span><span class=p>().</span><span class=na>getModelLoaders</span><span class=p>(</span><span class=n>model</span><span class=p>);</span>
<a id=__codelineno-45-32 name=__codelineno-45-32></a><a href=#__codelineno-45-32><span class=linenos data-linenos="32 "></span></a>   <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>size</span> <span class=o>=</span> <span class=n>modelLoaders</span><span class=p>.</span><span class=na>size</span><span class=p>();</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>size</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-45-33 name=__codelineno-45-33></a><a href=#__codelineno-45-33><span class=linenos data-linenos="33 "></span></a>     <span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>Object</span><span class=p>,</span> <span class=o>?&gt;</span> <span class=n>modelLoader</span> <span class=o>=</span> <span class=n>modelLoaders</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
<a id=__codelineno-45-34 name=__codelineno-45-34></a><a href=#__codelineno-45-34><span class=linenos data-linenos="34 "></span></a>     <span class=c1>// å¯¹æ¯ä¸ªModelLoaderè°ƒç”¨buildLoadDataï¼Œçœ‹çœ‹å…¶æ˜¯å¦å¯ä»¥æ»¡è¶³æ¡ä»¶</span>
<a id=__codelineno-45-35 name=__codelineno-45-35></a><a href=#__codelineno-45-35><span class=linenos data-linenos="35 "></span></a>     <span class=c1>// å¦‚æœè¿”å›ä¸ä¸ºnullï¼Œè¯´æ˜æ˜¯å¯ä»¥å¤„ç†çš„ï¼Œé‚£ä¹ˆæ·»åŠ è¿›æ¥</span>
<a id=__codelineno-45-36 name=__codelineno-45-36></a><a href=#__codelineno-45-36><span class=linenos data-linenos="36 "></span></a>     <span class=n>LoadData</span><span class=o>&lt;?&gt;</span> <span class=n>current</span> <span class=o>=</span>
<a id=__codelineno-45-37 name=__codelineno-45-37></a><a href=#__codelineno-45-37><span class=linenos data-linenos="37 "></span></a>         <span class=n>modelLoader</span><span class=p>.</span><span class=na>buildLoadData</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>,</span> <span class=n>options</span><span class=p>);</span>
<a id=__codelineno-45-38 name=__codelineno-45-38></a><a href=#__codelineno-45-38><span class=linenos data-linenos="38 "></span></a>     <span class=k>if</span> <span class=p>(</span><span class=n>current</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-45-39 name=__codelineno-45-39></a><a href=#__codelineno-45-39><span class=linenos data-linenos="39 "></span></a>       <span class=n>loadData</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>current</span><span class=p>);</span>
<a id=__codelineno-45-40 name=__codelineno-45-40></a><a href=#__codelineno-45-40><span class=linenos data-linenos="40 "></span></a>     <span class=p>}</span>
<a id=__codelineno-45-41 name=__codelineno-45-41></a><a href=#__codelineno-45-41><span class=linenos data-linenos="41 "></span></a>   <span class=p>}</span>
<a id=__codelineno-45-42 name=__codelineno-45-42></a><a href=#__codelineno-45-42><span class=linenos data-linenos="42 "></span></a> <span class=p>}</span>
<a id=__codelineno-45-43 name=__codelineno-45-43></a><a href=#__codelineno-45-43><span class=linenos data-linenos="43 "></span></a> <span class=c1>// è¿”å›å¯ä»¥å¤„ç†è¯¥è¯·æ±‚çš„ModelLoaderçš„LoadDataåˆ—è¡¨</span>
<a id=__codelineno-45-44 name=__codelineno-45-44></a><a href=#__codelineno-45-44><span class=linenos data-linenos="44 "></span></a> <span class=k>return</span> <span class=n>loadData</span><span class=p>;</span>
<a id=__codelineno-45-45 name=__codelineno-45-45></a><a href=#__codelineno-45-45><span class=linenos data-linenos="45 "></span></a><span class=p>}</span>
</code></pre></div></p> <p>ä¸Šé¢ä»£ç ä¸­æ¯”è¾ƒéº»çƒ¦çš„éƒ¨åˆ†åœ¨<code>glideContext.getRegistry().getModelLoaders(model)</code>ï¼Œåœ¨æ·±å…¥æ¢ç´¢è¯¥æ–¹æ³•çš„ä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬è¿˜æ˜¯å…ˆçœ‹çœ‹<code>Registry</code>ç±»çš„ç›¸å…³ä»£ç å§ã€‚</p> <p><code>Registry</code>ç±»ä¸­æä¾›äº†å¾ˆå¤šç”¨æ¥æ‹“å±•ã€æ›¿æ¢é»˜è®¤ç»„ä»¶çš„æ–¹æ³•ï¼Œæ ¹æ®ç»„ä»¶åŠŸèƒ½çš„ä¸åŒï¼Œä¼šäº¤ç»™å†…éƒ¨å¾ˆå¤šä¸åŒçš„Registryå¤„ç†ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-46-1 name=__codelineno-46-1></a><a href=#__codelineno-46-1><span class=linenos data-linenos="1 "></span></a><span class=kd>public</span> <span class=kd>class</span> <span class=nc>Registry</span> <span class=p>{</span>
<a id=__codelineno-46-2 name=__codelineno-46-2></a><a href=#__codelineno-46-2><span class=linenos data-linenos="2 "></span></a> <span class=kd>private</span> <span class=kd>final</span> <span class=n>ModelLoaderRegistry</span> <span class=n>modelLoaderRegistry</span><span class=p>;</span>
<a id=__codelineno-46-3 name=__codelineno-46-3></a><a href=#__codelineno-46-3><span class=linenos data-linenos="3 "></span></a> <span class=kd>private</span> <span class=kd>final</span> <span class=n>EncoderRegistry</span> <span class=n>encoderRegistry</span><span class=p>;</span>
<a id=__codelineno-46-4 name=__codelineno-46-4></a><a href=#__codelineno-46-4><span class=linenos data-linenos="4 "></span></a> <span class=kd>private</span> <span class=kd>final</span> <span class=n>ResourceDecoderRegistry</span> <span class=n>decoderRegistry</span><span class=p>;</span>
<a id=__codelineno-46-5 name=__codelineno-46-5></a><a href=#__codelineno-46-5><span class=linenos data-linenos="5 "></span></a> <span class=kd>private</span> <span class=kd>final</span> <span class=n>ResourceEncoderRegistry</span> <span class=n>resourceEncoderRegistry</span><span class=p>;</span>
<a id=__codelineno-46-6 name=__codelineno-46-6></a><a href=#__codelineno-46-6><span class=linenos data-linenos="6 "></span></a> <span class=kd>private</span> <span class=kd>final</span> <span class=n>DataRewinderRegistry</span> <span class=n>dataRewinderRegistry</span><span class=p>;</span>
<a id=__codelineno-46-7 name=__codelineno-46-7></a><a href=#__codelineno-46-7><span class=linenos data-linenos="7 "></span></a> <span class=kd>private</span> <span class=kd>final</span> <span class=n>TranscoderRegistry</span> <span class=n>transcoderRegistry</span><span class=p>;</span>
<a id=__codelineno-46-8 name=__codelineno-46-8></a><a href=#__codelineno-46-8><span class=linenos data-linenos="8 "></span></a> <span class=kd>private</span> <span class=kd>final</span> <span class=n>ImageHeaderParserRegistry</span> <span class=n>imageHeaderParserRegistry</span><span class=p>;</span>
<a id=__codelineno-46-9 name=__codelineno-46-9></a><a href=#__codelineno-46-9><span class=linenos data-linenos="9 "></span></a><span class=p>}</span>
</code></pre></div> <p>æ‹¿é©¬ä¸Šè¦é‡åˆ°çš„<code>modelLoaderRegistry</code>æ¥è¯´ï¼Œç›¸å…³çš„ç®¡ç†ç»„ä»¶çš„ä¸‰ä¸ªæ–¹æ³•ä¸ºï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-47-1 name=__codelineno-47-1></a><a href=#__codelineno-47-1><span class=linenos data-linenos=" 1 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-47-2 name=__codelineno-47-2></a><a href=#__codelineno-47-2><span class=linenos data-linenos=" 2 "></span></a><span class=kd>public</span> <span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=n>Data</span><span class=o>&gt;</span> <span class=n>Registry</span> <span class=nf>append</span><span class=p>(</span>
<a id=__codelineno-47-3 name=__codelineno-47-3></a><a href=#__codelineno-47-3><span class=linenos data-linenos=" 3 "></span></a>   <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Model</span><span class=o>&gt;</span> <span class=n>modelClass</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>dataClass</span><span class=p>,</span>
<a id=__codelineno-47-4 name=__codelineno-47-4></a><a href=#__codelineno-47-4><span class=linenos data-linenos=" 4 "></span></a>   <span class=nd>@NonNull</span> <span class=n>ModelLoaderFactory</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=n>Data</span><span class=o>&gt;</span> <span class=n>factory</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-47-5 name=__codelineno-47-5></a><a href=#__codelineno-47-5><span class=linenos data-linenos=" 5 "></span></a> <span class=n>modelLoaderRegistry</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>modelClass</span><span class=p>,</span> <span class=n>dataClass</span><span class=p>,</span> <span class=n>factory</span><span class=p>);</span>
<a id=__codelineno-47-6 name=__codelineno-47-6></a><a href=#__codelineno-47-6><span class=linenos data-linenos=" 6 "></span></a> <span class=k>return</span> <span class=k>this</span><span class=p>;</span>
<a id=__codelineno-47-7 name=__codelineno-47-7></a><a href=#__codelineno-47-7><span class=linenos data-linenos=" 7 "></span></a><span class=p>}</span>
<a id=__codelineno-47-8 name=__codelineno-47-8></a><a href=#__codelineno-47-8><span class=linenos data-linenos=" 8 "></span></a>
<a id=__codelineno-47-9 name=__codelineno-47-9></a><a href=#__codelineno-47-9><span class=linenos data-linenos=" 9 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-47-10 name=__codelineno-47-10></a><a href=#__codelineno-47-10><span class=linenos data-linenos="10 "></span></a><span class=kd>public</span> <span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=n>Data</span><span class=o>&gt;</span> <span class=n>Registry</span> <span class=nf>prepend</span><span class=p>(</span>
<a id=__codelineno-47-11 name=__codelineno-47-11></a><a href=#__codelineno-47-11><span class=linenos data-linenos="11 "></span></a>   <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Model</span><span class=o>&gt;</span> <span class=n>modelClass</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>dataClass</span><span class=p>,</span>
<a id=__codelineno-47-12 name=__codelineno-47-12></a><a href=#__codelineno-47-12><span class=linenos data-linenos="12 "></span></a>   <span class=nd>@NonNull</span> <span class=n>ModelLoaderFactory</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=n>Data</span><span class=o>&gt;</span> <span class=n>factory</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-47-13 name=__codelineno-47-13></a><a href=#__codelineno-47-13><span class=linenos data-linenos="13 "></span></a> <span class=n>modelLoaderRegistry</span><span class=p>.</span><span class=na>prepend</span><span class=p>(</span><span class=n>modelClass</span><span class=p>,</span> <span class=n>dataClass</span><span class=p>,</span> <span class=n>factory</span><span class=p>);</span>
<a id=__codelineno-47-14 name=__codelineno-47-14></a><a href=#__codelineno-47-14><span class=linenos data-linenos="14 "></span></a> <span class=k>return</span> <span class=k>this</span><span class=p>;</span>
<a id=__codelineno-47-15 name=__codelineno-47-15></a><a href=#__codelineno-47-15><span class=linenos data-linenos="15 "></span></a><span class=p>}</span>
<a id=__codelineno-47-16 name=__codelineno-47-16></a><a href=#__codelineno-47-16><span class=linenos data-linenos="16 "></span></a>
<a id=__codelineno-47-17 name=__codelineno-47-17></a><a href=#__codelineno-47-17><span class=linenos data-linenos="17 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-47-18 name=__codelineno-47-18></a><a href=#__codelineno-47-18><span class=linenos data-linenos="18 "></span></a><span class=kd>public</span> <span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=n>Data</span><span class=o>&gt;</span> <span class=n>Registry</span> <span class=nf>replace</span><span class=p>(</span>
<a id=__codelineno-47-19 name=__codelineno-47-19></a><a href=#__codelineno-47-19><span class=linenos data-linenos="19 "></span></a>   <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Model</span><span class=o>&gt;</span> <span class=n>modelClass</span><span class=p>,</span>
<a id=__codelineno-47-20 name=__codelineno-47-20></a><a href=#__codelineno-47-20><span class=linenos data-linenos="20 "></span></a>   <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>dataClass</span><span class=p>,</span>
<a id=__codelineno-47-21 name=__codelineno-47-21></a><a href=#__codelineno-47-21><span class=linenos data-linenos="21 "></span></a>   <span class=nd>@NonNull</span> <span class=n>ModelLoaderFactory</span><span class=o>&lt;?</span> <span class=kd>extends</span> <span class=n>Model</span><span class=p>,</span> <span class=o>?</span> <span class=kd>extends</span> <span class=n>Data</span><span class=o>&gt;</span> <span class=n>factory</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-47-22 name=__codelineno-47-22></a><a href=#__codelineno-47-22><span class=linenos data-linenos="22 "></span></a> <span class=n>modelLoaderRegistry</span><span class=p>.</span><span class=na>replace</span><span class=p>(</span><span class=n>modelClass</span><span class=p>,</span> <span class=n>dataClass</span><span class=p>,</span> <span class=n>factory</span><span class=p>);</span>
<a id=__codelineno-47-23 name=__codelineno-47-23></a><a href=#__codelineno-47-23><span class=linenos data-linenos="23 "></span></a> <span class=k>return</span> <span class=k>this</span><span class=p>;</span>
<a id=__codelineno-47-24 name=__codelineno-47-24></a><a href=#__codelineno-47-24><span class=linenos data-linenos="24 "></span></a><span class=p>}</span>
</code></pre></div> <p>ä¸Šé¢è¿™ä¸‰ä¸ªæ–¹æ³•å®é™…ä¸Šåˆä¼šäº¤ç»™<code>MultiModelLoaderFactory</code>æ¥å¤„ç†ï¼Œè¿™æ˜¯ä¸€ä¸ªä»£ç†æ¨¡å¼ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-48-1 name=__codelineno-48-1></a><a href=#__codelineno-48-1><span class=linenos data-linenos=" 1 "></span></a><span class=kd>public</span> <span class=kd>synchronized</span> <span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=n>Data</span><span class=o>&gt;</span> <span class=kt>void</span> <span class=nf>append</span><span class=p>(</span>
<a id=__codelineno-48-2 name=__codelineno-48-2></a><a href=#__codelineno-48-2><span class=linenos data-linenos=" 2 "></span></a>   <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Model</span><span class=o>&gt;</span> <span class=n>modelClass</span><span class=p>,</span>
<a id=__codelineno-48-3 name=__codelineno-48-3></a><a href=#__codelineno-48-3><span class=linenos data-linenos=" 3 "></span></a>   <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>dataClass</span><span class=p>,</span>
<a id=__codelineno-48-4 name=__codelineno-48-4></a><a href=#__codelineno-48-4><span class=linenos data-linenos=" 4 "></span></a>   <span class=nd>@NonNull</span> <span class=n>ModelLoaderFactory</span><span class=o>&lt;?</span> <span class=kd>extends</span> <span class=n>Model</span><span class=p>,</span> <span class=o>?</span> <span class=kd>extends</span> <span class=n>Data</span><span class=o>&gt;</span> <span class=n>factory</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-48-5 name=__codelineno-48-5></a><a href=#__codelineno-48-5><span class=linenos data-linenos=" 5 "></span></a> <span class=n>multiModelLoaderFactory</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>modelClass</span><span class=p>,</span> <span class=n>dataClass</span><span class=p>,</span> <span class=n>factory</span><span class=p>);</span>
<a id=__codelineno-48-6 name=__codelineno-48-6></a><a href=#__codelineno-48-6><span class=linenos data-linenos=" 6 "></span></a> <span class=n>cache</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span>
<a id=__codelineno-48-7 name=__codelineno-48-7></a><a href=#__codelineno-48-7><span class=linenos data-linenos=" 7 "></span></a><span class=p>}</span>
<a id=__codelineno-48-8 name=__codelineno-48-8></a><a href=#__codelineno-48-8><span class=linenos data-linenos=" 8 "></span></a>
<a id=__codelineno-48-9 name=__codelineno-48-9></a><a href=#__codelineno-48-9><span class=linenos data-linenos=" 9 "></span></a><span class=kd>public</span> <span class=kd>synchronized</span> <span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=n>Data</span><span class=o>&gt;</span> <span class=kt>void</span> <span class=nf>prepend</span><span class=p>(</span>
<a id=__codelineno-48-10 name=__codelineno-48-10></a><a href=#__codelineno-48-10><span class=linenos data-linenos="10 "></span></a>   <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Model</span><span class=o>&gt;</span> <span class=n>modelClass</span><span class=p>,</span>
<a id=__codelineno-48-11 name=__codelineno-48-11></a><a href=#__codelineno-48-11><span class=linenos data-linenos="11 "></span></a>   <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>dataClass</span><span class=p>,</span>
<a id=__codelineno-48-12 name=__codelineno-48-12></a><a href=#__codelineno-48-12><span class=linenos data-linenos="12 "></span></a>   <span class=nd>@NonNull</span> <span class=n>ModelLoaderFactory</span><span class=o>&lt;?</span> <span class=kd>extends</span> <span class=n>Model</span><span class=p>,</span> <span class=o>?</span> <span class=kd>extends</span> <span class=n>Data</span><span class=o>&gt;</span> <span class=n>factory</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-48-13 name=__codelineno-48-13></a><a href=#__codelineno-48-13><span class=linenos data-linenos="13 "></span></a> <span class=n>multiModelLoaderFactory</span><span class=p>.</span><span class=na>prepend</span><span class=p>(</span><span class=n>modelClass</span><span class=p>,</span> <span class=n>dataClass</span><span class=p>,</span> <span class=n>factory</span><span class=p>);</span>
<a id=__codelineno-48-14 name=__codelineno-48-14></a><a href=#__codelineno-48-14><span class=linenos data-linenos="14 "></span></a> <span class=n>cache</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span>
<a id=__codelineno-48-15 name=__codelineno-48-15></a><a href=#__codelineno-48-15><span class=linenos data-linenos="15 "></span></a><span class=p>}</span>
<a id=__codelineno-48-16 name=__codelineno-48-16></a><a href=#__codelineno-48-16><span class=linenos data-linenos="16 "></span></a>
<a id=__codelineno-48-17 name=__codelineno-48-17></a><a href=#__codelineno-48-17><span class=linenos data-linenos="17 "></span></a><span class=kd>public</span> <span class=kd>synchronized</span> <span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=n>Data</span><span class=o>&gt;</span> <span class=kt>void</span> <span class=nf>remove</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Model</span><span class=o>&gt;</span> <span class=n>modelClass</span><span class=p>,</span>
<a id=__codelineno-48-18 name=__codelineno-48-18></a><a href=#__codelineno-48-18><span class=linenos data-linenos="18 "></span></a>   <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>dataClass</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-48-19 name=__codelineno-48-19></a><a href=#__codelineno-48-19><span class=linenos data-linenos="19 "></span></a> <span class=n>tearDown</span><span class=p>(</span><span class=n>multiModelLoaderFactory</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>modelClass</span><span class=p>,</span> <span class=n>dataClass</span><span class=p>));</span>
<a id=__codelineno-48-20 name=__codelineno-48-20></a><a href=#__codelineno-48-20><span class=linenos data-linenos="20 "></span></a> <span class=n>cache</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span>
<a id=__codelineno-48-21 name=__codelineno-48-21></a><a href=#__codelineno-48-21><span class=linenos data-linenos="21 "></span></a><span class=p>}</span>
</code></pre></div> <p><code>MultiModelLoaderFactory</code>ä¸­ä¼šä½¿ç”¨ä¸€ä¸ª<code>entries</code>çš„listæ¥ä¿å­˜æ‰€æœ‰æ³¨å…¥çš„å†…å®¹ã€‚</p> <p>å‰é¢å·²ç»æåˆ°è¿‡ï¼ŒGlideåœ¨æ„é€ æ—¶ä¼šå¯¹<code>Registry</code>è¿›è¡Œå¤§é‡çš„æ“ä½œã€‚å› ä¸ºæˆ‘ä»¬ç¤ºä¾‹æ˜¯loadçš„<code>String</code>ç±»å‹çš„Urlï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ<code>modelClass</code> ä¸º <code>String.class</code>ï¼Œæ‰€ä»¥<code>Registry</code>ä¸­ç¬¦åˆçš„æ³¨å†Œé¡¹åªæœ‰4ä¸ªï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-49-1 name=__codelineno-49-1></a><a href=#__codelineno-49-1><span class=linenos data-linenos="1 "></span></a><span class=c1>// modelå¯èƒ½æ˜¯ä¸€ä¸ªbase64æ ¼å¼çš„imgï¼Œç»è¿‡å¤„ç†åå¯ä»¥å˜æˆInputStreamç±»å‹(dataClass)çš„æ•°æ®</span>
<a id=__codelineno-49-2 name=__codelineno-49-2></a><a href=#__codelineno-49-2><span class=linenos data-linenos="2 "></span></a><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>String</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>InputStream</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=k>new</span> <span class=n>DataUrlLoader</span><span class=p>.</span><span class=na>StreamFactory</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span><span class=p>())</span>
<a id=__codelineno-49-3 name=__codelineno-49-3></a><a href=#__codelineno-49-3><span class=linenos data-linenos="3 "></span></a><span class=c1>// modelå¯èƒ½æ˜¯ä¸€ä¸ªuriï¼Œè¿™ç§æƒ…å†µä¸‹å¯èƒ½æ€§éå¸¸å¤šï¼Œå› ä¸ºç½‘ç»œå›¾ç‰‡ã€assetså›¾ç‰‡ã€ç£ç›˜å›¾ç‰‡ç­‰ç­‰éƒ½æ˜¯ä¸€ä¸ªuri</span>
<a id=__codelineno-49-4 name=__codelineno-49-4></a><a href=#__codelineno-49-4><span class=linenos data-linenos="4 "></span></a><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>String</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>InputStream</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=k>new</span> <span class=n>StringLoader</span><span class=p>.</span><span class=na>StreamFactory</span><span class=p>())</span>
<a id=__codelineno-49-5 name=__codelineno-49-5></a><a href=#__codelineno-49-5><span class=linenos data-linenos="5 "></span></a><span class=c1>// modelå¯èƒ½æ˜¯ä¸€ä¸ªæœ¬åœ°å›¾ç‰‡ã€assetså›¾ç‰‡ï¼Œæ‰€ä»¥å¯ä»¥å¤„ç†æˆParcelFileDescriptor.classç±»å‹çš„æ•°æ®</span>
<a id=__codelineno-49-6 name=__codelineno-49-6></a><a href=#__codelineno-49-6><span class=linenos data-linenos="6 "></span></a><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>String</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>ParcelFileDescriptor</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=k>new</span> <span class=n>StringLoader</span><span class=p>.</span><span class=na>FileDescriptorFactory</span><span class=p>())</span>
<a id=__codelineno-49-7 name=__codelineno-49-7></a><a href=#__codelineno-49-7><span class=linenos data-linenos="7 "></span></a><span class=c1>// modelå¯èƒ½æ˜¯ä¸€ä¸ªæœ¬åœ°å›¾ç‰‡ï¼Œæ‰€ä»¥å¯ä»¥å¤„ç†æˆä¸ºAssetFileDescriptor.classç±»å‹çš„æ•°æ®</span>
<a id=__codelineno-49-8 name=__codelineno-49-8></a><a href=#__codelineno-49-8><span class=linenos data-linenos="8 "></span></a><span class=p>.</span><span class=na>append</span><span class=p>(</span>
<a id=__codelineno-49-9 name=__codelineno-49-9></a><a href=#__codelineno-49-9><span class=linenos data-linenos="9 "></span></a>   <span class=n>String</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>AssetFileDescriptor</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=k>new</span> <span class=n>StringLoader</span><span class=p>.</span><span class=na>AssetFileDescriptorFactory</span><span class=p>())</span>
</code></pre></div> <p>äº†è§£äº†è¿™äº›ä¹‹åï¼Œæˆ‘ä»¬å›è¿‡å¤´çœ‹çœ‹<code>Registry.getModelLoaders</code>æ–¹æ³•å¹²äº†å•¥ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-50-1 name=__codelineno-50-1></a><a href=#__codelineno-50-1><span class=linenos data-linenos="1 "></span></a><span class=c1>// Registry.java</span>
<a id=__codelineno-50-2 name=__codelineno-50-2></a><a href=#__codelineno-50-2><span class=linenos data-linenos="2 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-50-3 name=__codelineno-50-3></a><a href=#__codelineno-50-3><span class=linenos data-linenos="3 "></span></a><span class=kd>public</span> <span class=o>&lt;</span><span class=n>Model</span><span class=o>&gt;</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=o>?&gt;&gt;</span> <span class=n>getModelLoaders</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Model</span> <span class=n>model</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-50-4 name=__codelineno-50-4></a><a href=#__codelineno-50-4><span class=linenos data-linenos="4 "></span></a> <span class=n>List</span><span class=o>&lt;</span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=o>?&gt;&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=n>modelLoaderRegistry</span><span class=p>.</span><span class=na>getModelLoaders</span><span class=p>(</span><span class=n>model</span><span class=p>);</span>
<a id=__codelineno-50-5 name=__codelineno-50-5></a><a href=#__codelineno-50-5><span class=linenos data-linenos="5 "></span></a> <span class=k>if</span> <span class=p>(</span><span class=n>result</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span> <span class=p>{</span>
<a id=__codelineno-50-6 name=__codelineno-50-6></a><a href=#__codelineno-50-6><span class=linenos data-linenos="6 "></span></a>   <span class=k>throw</span> <span class=k>new</span> <span class=n>NoModelLoaderAvailableException</span><span class=p>(</span><span class=n>model</span><span class=p>);</span>
<a id=__codelineno-50-7 name=__codelineno-50-7></a><a href=#__codelineno-50-7><span class=linenos data-linenos="7 "></span></a> <span class=p>}</span>
<a id=__codelineno-50-8 name=__codelineno-50-8></a><a href=#__codelineno-50-8><span class=linenos data-linenos="8 "></span></a> <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
<a id=__codelineno-50-9 name=__codelineno-50-9></a><a href=#__codelineno-50-9><span class=linenos data-linenos="9 "></span></a><span class=p>}</span>
</code></pre></div> <p>è¿™é‡Œåªæ˜¯è°ƒç”¨äº†<code>modelLoaderRegistry.getModelLoaders(model)</code>ï¼Œå¦‚æœè¿”å›ç»“æœä¸ä¸ºç©ºåˆ™è¿”å›è¯¥ç»“æœï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸ã€‚æˆ‘ä»¬ç»§ç»­è·Ÿè¸ªä¸€ä¸‹ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-51-1 name=__codelineno-51-1></a><a href=#__codelineno-51-1><span class=linenos data-linenos=" 1 "></span></a><span class=c1>// ModelLoaderRegistry.java</span>
<a id=__codelineno-51-2 name=__codelineno-51-2></a><a href=#__codelineno-51-2><span class=linenos data-linenos=" 2 "></span></a><span class=c1>// getModelLoadersæ–¹æ³•ä¼šè·å–æ‰€æœ‰å£°æ˜å¯ä»¥å¤„ç†Stringç±»å‹çš„ModelLoaderï¼Œå¹¶è°ƒç”¨handlesæ–¹æ³•è¿‡æ»¤æ‰è‚¯å®šä¸èƒ½å¤„ç†çš„</span>
<a id=__codelineno-51-3 name=__codelineno-51-3></a><a href=#__codelineno-51-3><span class=linenos data-linenos=" 3 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-51-4 name=__codelineno-51-4></a><a href=#__codelineno-51-4><span class=linenos data-linenos=" 4 "></span></a><span class=kd>public</span> <span class=o>&lt;</span><span class=n>A</span><span class=o>&gt;</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>A</span><span class=p>,</span> <span class=o>?&gt;&gt;</span> <span class=n>getModelLoaders</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>A</span> <span class=n>model</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-51-5 name=__codelineno-51-5></a><a href=#__codelineno-51-5><span class=linenos data-linenos=" 5 "></span></a> <span class=c1>// è¿”å›æ‰€æœ‰æ³¨å†Œè¿‡çš„modelClassä¸ºStringçš„ModelLoaderï¼Œå°±æ˜¯ä¸Šé¢åˆ—å‡ºæ¥çš„å››ä¸ª</span>
<a id=__codelineno-51-6 name=__codelineno-51-6></a><a href=#__codelineno-51-6><span class=linenos data-linenos=" 6 "></span></a> <span class=n>List</span><span class=o>&lt;</span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>A</span><span class=p>,</span> <span class=o>?&gt;&gt;</span> <span class=n>modelLoaders</span> <span class=o>=</span> <span class=n>getModelLoadersForClass</span><span class=p>(</span><span class=n>getClass</span><span class=p>(</span><span class=n>model</span><span class=p>));</span>
<a id=__codelineno-51-7 name=__codelineno-51-7></a><a href=#__codelineno-51-7><span class=linenos data-linenos=" 7 "></span></a> <span class=kt>int</span> <span class=n>size</span> <span class=o>=</span> <span class=n>modelLoaders</span><span class=p>.</span><span class=na>size</span><span class=p>();</span>
<a id=__codelineno-51-8 name=__codelineno-51-8></a><a href=#__codelineno-51-8><span class=linenos data-linenos=" 8 "></span></a> <span class=kt>boolean</span> <span class=n>isEmpty</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
<a id=__codelineno-51-9 name=__codelineno-51-9></a><a href=#__codelineno-51-9><span class=linenos data-linenos=" 9 "></span></a> <span class=n>List</span><span class=o>&lt;</span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>A</span><span class=p>,</span> <span class=o>?&gt;&gt;</span> <span class=n>filteredLoaders</span> <span class=o>=</span> <span class=n>Collections</span><span class=p>.</span><span class=na>emptyList</span><span class=p>();</span>
<a id=__codelineno-51-10 name=__codelineno-51-10></a><a href=#__codelineno-51-10><span class=linenos data-linenos="10 "></span></a> <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>size</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-51-11 name=__codelineno-51-11></a><a href=#__codelineno-51-11><span class=linenos data-linenos="11 "></span></a>   <span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>A</span><span class=p>,</span> <span class=o>?&gt;</span> <span class=n>loader</span> <span class=o>=</span> <span class=n>modelLoaders</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
<a id=__codelineno-51-12 name=__codelineno-51-12></a><a href=#__codelineno-51-12><span class=linenos data-linenos="12 "></span></a>   <span class=c1>// å¯¹äºæ¯ä¸ªModelLoaderï¼Œçœ‹çœ‹æ˜¯å¦å¯èƒ½å¤„ç†è¿™ç§ç±»å‹çš„æ•°æ®</span>
<a id=__codelineno-51-13 name=__codelineno-51-13></a><a href=#__codelineno-51-13><span class=linenos data-linenos="13 "></span></a>   <span class=c1>// æ­¤å¤„ä¼šè¿‡æ»¤ç¬¬ä¸€ä¸ªï¼Œå› ä¸ºæˆ‘ä»¬ä¼ å…¥çš„urlä¸ä»¥data:imageå¼€å¤´</span>
<a id=__codelineno-51-14 name=__codelineno-51-14></a><a href=#__codelineno-51-14><span class=linenos data-linenos="14 "></span></a>   <span class=k>if</span> <span class=p>(</span><span class=n>loader</span><span class=p>.</span><span class=na>handles</span><span class=p>(</span><span class=n>model</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-51-15 name=__codelineno-51-15></a><a href=#__codelineno-51-15><span class=linenos data-linenos="15 "></span></a>     <span class=k>if</span> <span class=p>(</span><span class=n>isEmpty</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-51-16 name=__codelineno-51-16></a><a href=#__codelineno-51-16><span class=linenos data-linenos="16 "></span></a>       <span class=n>filteredLoaders</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>size</span> <span class=o>-</span> <span class=n>i</span><span class=p>);</span>
<a id=__codelineno-51-17 name=__codelineno-51-17></a><a href=#__codelineno-51-17><span class=linenos data-linenos="17 "></span></a>       <span class=n>isEmpty</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
<a id=__codelineno-51-18 name=__codelineno-51-18></a><a href=#__codelineno-51-18><span class=linenos data-linenos="18 "></span></a>     <span class=p>}</span>
<a id=__codelineno-51-19 name=__codelineno-51-19></a><a href=#__codelineno-51-19><span class=linenos data-linenos="19 "></span></a>     <span class=n>filteredLoaders</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>loader</span><span class=p>);</span>
<a id=__codelineno-51-20 name=__codelineno-51-20></a><a href=#__codelineno-51-20><span class=linenos data-linenos="20 "></span></a>   <span class=p>}</span>
<a id=__codelineno-51-21 name=__codelineno-51-21></a><a href=#__codelineno-51-21><span class=linenos data-linenos="21 "></span></a> <span class=p>}</span>
<a id=__codelineno-51-22 name=__codelineno-51-22></a><a href=#__codelineno-51-22><span class=linenos data-linenos="22 "></span></a> <span class=k>return</span> <span class=n>filteredLoaders</span><span class=p>;</span>
<a id=__codelineno-51-23 name=__codelineno-51-23></a><a href=#__codelineno-51-23><span class=linenos data-linenos="23 "></span></a><span class=p>}</span>
<a id=__codelineno-51-24 name=__codelineno-51-24></a><a href=#__codelineno-51-24><span class=linenos data-linenos="24 "></span></a>
<a id=__codelineno-51-25 name=__codelineno-51-25></a><a href=#__codelineno-51-25><span class=linenos data-linenos="25 "></span></a><span class=c1>// è¿”å›æ‰€æœ‰å£°æ˜å¯ä»¥å¤„ç†modelClassä¸ºStringçš„ModelLoader</span>
<a id=__codelineno-51-26 name=__codelineno-51-26></a><a href=#__codelineno-51-26><span class=linenos data-linenos="26 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-51-27 name=__codelineno-51-27></a><a href=#__codelineno-51-27><span class=linenos data-linenos="27 "></span></a><span class=kd>private</span> <span class=kd>synchronized</span> <span class=o>&lt;</span><span class=n>A</span><span class=o>&gt;</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>A</span><span class=p>,</span> <span class=o>?&gt;&gt;</span> <span class=n>getModelLoadersForClass</span><span class=p>(</span>
<a id=__codelineno-51-28 name=__codelineno-51-28></a><a href=#__codelineno-51-28><span class=linenos data-linenos="28 "></span></a>   <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>A</span><span class=o>&gt;</span> <span class=n>modelClass</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-51-29 name=__codelineno-51-29></a><a href=#__codelineno-51-29><span class=linenos data-linenos="29 "></span></a> <span class=n>List</span><span class=o>&lt;</span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>A</span><span class=p>,</span> <span class=o>?&gt;&gt;</span> <span class=n>loaders</span> <span class=o>=</span> <span class=n>cache</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>modelClass</span><span class=p>);</span>
<a id=__codelineno-51-30 name=__codelineno-51-30></a><a href=#__codelineno-51-30><span class=linenos data-linenos="30 "></span></a> <span class=k>if</span> <span class=p>(</span><span class=n>loaders</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-51-31 name=__codelineno-51-31></a><a href=#__codelineno-51-31><span class=linenos data-linenos="31 "></span></a>   <span class=n>loaders</span> <span class=o>=</span> <span class=n>Collections</span><span class=p>.</span><span class=na>unmodifiableList</span><span class=p>(</span><span class=n>multiModelLoaderFactory</span><span class=p>.</span><span class=na>build</span><span class=p>(</span><span class=n>modelClass</span><span class=p>));</span>
<a id=__codelineno-51-32 name=__codelineno-51-32></a><a href=#__codelineno-51-32><span class=linenos data-linenos="32 "></span></a>   <span class=n>cache</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>modelClass</span><span class=p>,</span> <span class=n>loaders</span><span class=p>);</span>
<a id=__codelineno-51-33 name=__codelineno-51-33></a><a href=#__codelineno-51-33><span class=linenos data-linenos="33 "></span></a> <span class=p>}</span>
<a id=__codelineno-51-34 name=__codelineno-51-34></a><a href=#__codelineno-51-34><span class=linenos data-linenos="34 "></span></a> <span class=k>return</span> <span class=n>loaders</span><span class=p>;</span>
<a id=__codelineno-51-35 name=__codelineno-51-35></a><a href=#__codelineno-51-35><span class=linenos data-linenos="35 "></span></a><span class=p>}</span>
</code></pre></div> <p>æˆ‘ä»¬çœ‹çœ‹<code>multiModelLoaderFactory.build(modelClass)</code>æ˜¯å¦‚ä½•è·å–æ‰€æœ‰å£°æ˜å¯ä»¥å¤„ç†modelClassçš„ModelLoaderçš„ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-52-1 name=__codelineno-52-1></a><a href=#__codelineno-52-1><span class=linenos data-linenos=" 1 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-52-2 name=__codelineno-52-2></a><a href=#__codelineno-52-2><span class=linenos data-linenos=" 2 "></span></a><span class=kd>synchronized</span> <span class=o>&lt;</span><span class=n>Model</span><span class=o>&gt;</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=o>?&gt;&gt;</span> <span class=n>build</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Model</span><span class=o>&gt;</span> <span class=n>modelClass</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-52-3 name=__codelineno-52-3></a><a href=#__codelineno-52-3><span class=linenos data-linenos=" 3 "></span></a> <span class=k>try</span> <span class=p>{</span>
<a id=__codelineno-52-4 name=__codelineno-52-4></a><a href=#__codelineno-52-4><span class=linenos data-linenos=" 4 "></span></a>   <span class=n>List</span><span class=o>&lt;</span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=o>?&gt;&gt;</span> <span class=n>loaders</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span>
<a id=__codelineno-52-5 name=__codelineno-52-5></a><a href=#__codelineno-52-5><span class=linenos data-linenos=" 5 "></span></a>   <span class=c1>// éå†æ‰€æœ‰æ³¨å†Œè¿›æ¥çš„entry</span>
<a id=__codelineno-52-6 name=__codelineno-52-6></a><a href=#__codelineno-52-6><span class=linenos data-linenos=" 6 "></span></a>   <span class=k>for</span> <span class=p>(</span><span class=n>Entry</span><span class=o>&lt;?</span><span class=p>,</span> <span class=o>?&gt;</span> <span class=n>entry</span> <span class=p>:</span> <span class=n>entries</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-52-7 name=__codelineno-52-7></a><a href=#__codelineno-52-7><span class=linenos data-linenos=" 7 "></span></a>     <span class=c1>// Avoid stack overflow recursively creating model loaders by only creating loaders in</span>
<a id=__codelineno-52-8 name=__codelineno-52-8></a><a href=#__codelineno-52-8><span class=linenos data-linenos=" 8 "></span></a>     <span class=c1>// recursive requests if they haven&#39;t been created earlier in the chain. For example:</span>
<a id=__codelineno-52-9 name=__codelineno-52-9></a><a href=#__codelineno-52-9><span class=linenos data-linenos=" 9 "></span></a>     <span class=c1>// A Uri loader may translate to another model, which in turn may translate back to a Uri.</span>
<a id=__codelineno-52-10 name=__codelineno-52-10></a><a href=#__codelineno-52-10><span class=linenos data-linenos="10 "></span></a>     <span class=c1>// The original Uri loader won&#39;t be provided to the intermediate model loader, although</span>
<a id=__codelineno-52-11 name=__codelineno-52-11></a><a href=#__codelineno-52-11><span class=linenos data-linenos="11 "></span></a>     <span class=c1>// other Uri loaders will be.</span>
<a id=__codelineno-52-12 name=__codelineno-52-12></a><a href=#__codelineno-52-12><span class=linenos data-linenos="12 "></span></a>     <span class=k>if</span> <span class=p>(</span><span class=n>alreadyUsedEntries</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>entry</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-52-13 name=__codelineno-52-13></a><a href=#__codelineno-52-13><span class=linenos data-linenos="13 "></span></a>       <span class=k>continue</span><span class=p>;</span>
<a id=__codelineno-52-14 name=__codelineno-52-14></a><a href=#__codelineno-52-14><span class=linenos data-linenos="14 "></span></a>     <span class=p>}</span>
<a id=__codelineno-52-15 name=__codelineno-52-15></a><a href=#__codelineno-52-15><span class=linenos data-linenos="15 "></span></a>     <span class=c1>// æ³¨å†Œè¿‡çš„entryæœ‰å¾ˆå¤šï¼Œä½†æ˜¯entry.modelClassæ˜¯modelClassï¼ˆå³String.classï¼‰çš„åŒç±»æˆ–çˆ¶ç±»çš„å´åªæœ‰å››ä¸ª</span>
<a id=__codelineno-52-16 name=__codelineno-52-16></a><a href=#__codelineno-52-16><span class=linenos data-linenos="16 "></span></a>     <span class=k>if</span> <span class=p>(</span><span class=n>entry</span><span class=p>.</span><span class=na>handles</span><span class=p>(</span><span class=n>modelClass</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-52-17 name=__codelineno-52-17></a><a href=#__codelineno-52-17><span class=linenos data-linenos="17 "></span></a>       <span class=n>alreadyUsedEntries</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>entry</span><span class=p>);</span>
<a id=__codelineno-52-18 name=__codelineno-52-18></a><a href=#__codelineno-52-18><span class=linenos data-linenos="18 "></span></a>       <span class=c1>// å¯¹æ¯ä¸€ä¸ªç¬¦åˆæ¡ä»¶çš„entryè°ƒç”¨buildæ¥å£ï¼Œè·å–å¯¹åº”çš„ModelLoader</span>
<a id=__codelineno-52-19 name=__codelineno-52-19></a><a href=#__codelineno-52-19><span class=linenos data-linenos="19 "></span></a>       <span class=n>loaders</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=n>Object</span><span class=o>&gt;</span><span class=n>build</span><span class=p>(</span><span class=n>entry</span><span class=p>));</span>
<a id=__codelineno-52-20 name=__codelineno-52-20></a><a href=#__codelineno-52-20><span class=linenos data-linenos="20 "></span></a>       <span class=n>alreadyUsedEntries</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>entry</span><span class=p>);</span>
<a id=__codelineno-52-21 name=__codelineno-52-21></a><a href=#__codelineno-52-21><span class=linenos data-linenos="21 "></span></a>     <span class=p>}</span>
<a id=__codelineno-52-22 name=__codelineno-52-22></a><a href=#__codelineno-52-22><span class=linenos data-linenos="22 "></span></a>   <span class=p>}</span>
<a id=__codelineno-52-23 name=__codelineno-52-23></a><a href=#__codelineno-52-23><span class=linenos data-linenos="23 "></span></a>   <span class=k>return</span> <span class=n>loaders</span><span class=p>;</span>
<a id=__codelineno-52-24 name=__codelineno-52-24></a><a href=#__codelineno-52-24><span class=linenos data-linenos="24 "></span></a> <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-52-25 name=__codelineno-52-25></a><a href=#__codelineno-52-25><span class=linenos data-linenos="25 "></span></a>   <span class=n>alreadyUsedEntries</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span>
<a id=__codelineno-52-26 name=__codelineno-52-26></a><a href=#__codelineno-52-26><span class=linenos data-linenos="26 "></span></a>   <span class=k>throw</span> <span class=n>t</span><span class=p>;</span>
<a id=__codelineno-52-27 name=__codelineno-52-27></a><a href=#__codelineno-52-27><span class=linenos data-linenos="27 "></span></a> <span class=p>}</span>
<a id=__codelineno-52-28 name=__codelineno-52-28></a><a href=#__codelineno-52-28><span class=linenos data-linenos="28 "></span></a><span class=p>}</span>
<a id=__codelineno-52-29 name=__codelineno-52-29></a><a href=#__codelineno-52-29><span class=linenos data-linenos="29 "></span></a>
<a id=__codelineno-52-30 name=__codelineno-52-30></a><a href=#__codelineno-52-30><span class=linenos data-linenos="30 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-52-31 name=__codelineno-52-31></a><a href=#__codelineno-52-31><span class=linenos data-linenos="31 "></span></a><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;unchecked&quot;</span><span class=p>)</span>
<a id=__codelineno-52-32 name=__codelineno-52-32></a><a href=#__codelineno-52-32><span class=linenos data-linenos="32 "></span></a><span class=kd>private</span> <span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=n>Data</span><span class=o>&gt;</span> <span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=n>Data</span><span class=o>&gt;</span> <span class=nf>build</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Entry</span><span class=o>&lt;?</span><span class=p>,</span> <span class=o>?&gt;</span> <span class=n>entry</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-52-33 name=__codelineno-52-33></a><a href=#__codelineno-52-33><span class=linenos data-linenos="33 "></span></a> <span class=k>return</span> <span class=p>(</span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=n>Data</span><span class=o>&gt;</span><span class=p>)</span> <span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>entry</span><span class=p>.</span><span class=na>factory</span><span class=p>.</span><span class=na>build</span><span class=p>(</span><span class=k>this</span><span class=p>));</span>
<a id=__codelineno-52-34 name=__codelineno-52-34></a><a href=#__codelineno-52-34><span class=linenos data-linenos="34 "></span></a><span class=p>}</span>
</code></pre></div> <p>è¿™é‡Œçš„entryçš„æ•°æ®ç»“æ„ä»¥åŠä¿å­˜çš„å€¼æˆ‘ä»¬åœ¨ä¸Šé¢æåˆ°è¿‡ï¼Œä¸‹é¢æˆ‘ä»¬çœ‹çœ‹<code>entry.factory.build(this)</code>åˆ›å»ºäº†å››ä¸ªä»€ä¹ˆæ ·çš„ModelLoaderï¼š</p> <ul> <li><code>append(String.class, InputStream.class, new DataUrlLoader.StreamFactory&lt;String&gt;())</code><br> è¯¥Factoryä¼šåˆ›å»ºä¸€ä¸ªå¤„ç†data scheme(<code>data:[mediatype][;base64],encoded_data</code>, e.g. data:image/gif;base64,R0lGO...lBCBMQiB0UjIQA7)ç±»å‹æ•°æ®çš„<code>DataUrlLoader</code><br> <strong>å£°æ˜å¯èƒ½å¤„ç†ä»¥</strong><code>data:image</code><strong>å¼€å¤´çš„model</strong></li> <li><code>append(String.class, InputStream.class, new StringLoader.StreamFactory())</code><br> è¯¥Factoryèƒ½å¤Ÿä»Stringä¸­åŠ è½½InputStream<br> <strong>å£°æ˜å¯èƒ½å¤„ç†æ‰€æœ‰ç±»å‹çš„model</strong></li> <li><code>.append(String.class, ParcelFileDescriptor.class, new StringLoader.FileDescriptorFactory())</code><br> è¯¥Factoryèƒ½å¤Ÿä»Stringä¸­åŠ è½½ParcelFileDescriptor<br> <strong>å£°æ˜å¯èƒ½å¤„ç†æ‰€æœ‰ç±»å‹çš„model</strong></li> <li><code>.append(String.class, AssetFileDescriptor.class, new StringLoader.AssetFileDescriptorFactory())</code><br> è¯¥Factoryèƒ½å¤Ÿä»Stringä¸­åŠ è½½AssetFileDescriptor <br> <strong>å£°æ˜å¯èƒ½å¤„ç†æ‰€æœ‰ç±»å‹çš„model</strong></li> </ul> <p>æ­¤å¤„çš„å››ä¸ªModelLoaderä¸­ï¼Œ<code>DataUrlLoader.StreamFactory</code>çš„é€»è¾‘éå¸¸æ¸…æ™°æ˜äº†ï¼Œå…¶ä»–ä¸‰ä¸ªæœ‰ç‚¹éº»çƒ¦ã€‚å› ä¸ºå®ƒä»¬éƒ½æ˜¯åˆ›å»ºçš„<code>StringLoader</code>ï¼Œè€Œ<code>StringLoader</code>å†…éƒ¨ä¹Ÿæœ‰ä¸€ä¸ª<code>MultiModelLoader</code>ï¼Œåœ¨Factoryä¸­build <code>StringLoader</code>æ—¶ï¼Œä¼šè°ƒç”¨<code>multiFactory.build</code>åˆ›å»ºä¸€ä¸ªå†…éƒ¨çš„<code>MultiModelLoader</code>ã€‚<br> å› ä¸ºStringå¯èƒ½æŒ‡å‘çš„æ•°æ®å¤ªå¤šäº†ï¼Œæ‰€ä»¥é‡‡å–<code>MultiModelLoader</code>ä¿å­˜æ‰€æœ‰å¯èƒ½çš„<code>ModelLoader</code>ï¼Œåœ¨å¤„ç†æ—¶ä¼šéå†listæ‰¾å‡ºæ‰€æœ‰å¯ä»¥å¤„ç†çš„ã€‚</p> <p>æˆ‘ä»¬çœ‹çœ‹<code>StringLoader.StreamFactory()</code>çš„buildè¿‡ç¨‹ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-53-1 name=__codelineno-53-1></a><a href=#__codelineno-53-1><span class=linenos data-linenos=" 1 "></span></a><span class=cm>/**</span>
<a id=__codelineno-53-2 name=__codelineno-53-2></a><a href=#__codelineno-53-2><span class=linenos data-linenos=" 2 "></span></a><span class=cm> * Factory for loading {@link InputStream}s from Strings.</span>
<a id=__codelineno-53-3 name=__codelineno-53-3></a><a href=#__codelineno-53-3><span class=linenos data-linenos=" 3 "></span></a><span class=cm> */</span>
<a id=__codelineno-53-4 name=__codelineno-53-4></a><a href=#__codelineno-53-4><span class=linenos data-linenos=" 4 "></span></a><span class=kd>public</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>StreamFactory</span> <span class=kd>implements</span> <span class=n>ModelLoaderFactory</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>InputStream</span><span class=o>&gt;</span> <span class=p>{</span>
<a id=__codelineno-53-5 name=__codelineno-53-5></a><a href=#__codelineno-53-5><span class=linenos data-linenos=" 5 "></span></a>
<a id=__codelineno-53-6 name=__codelineno-53-6></a><a href=#__codelineno-53-6><span class=linenos data-linenos=" 6 "></span></a> <span class=nd>@NonNull</span>
<a id=__codelineno-53-7 name=__codelineno-53-7></a><a href=#__codelineno-53-7><span class=linenos data-linenos=" 7 "></span></a> <span class=nd>@Override</span>
<a id=__codelineno-53-8 name=__codelineno-53-8></a><a href=#__codelineno-53-8><span class=linenos data-linenos=" 8 "></span></a> <span class=kd>public</span> <span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>InputStream</span><span class=o>&gt;</span> <span class=nf>build</span><span class=p>(</span>
<a id=__codelineno-53-9 name=__codelineno-53-9></a><a href=#__codelineno-53-9><span class=linenos data-linenos=" 9 "></span></a>     <span class=nd>@NonNull</span> <span class=n>MultiModelLoaderFactory</span> <span class=n>multiFactory</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-53-10 name=__codelineno-53-10></a><a href=#__codelineno-53-10><span class=linenos data-linenos="10 "></span></a>   <span class=k>return</span> <span class=k>new</span> <span class=n>StringLoader</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>multiFactory</span><span class=p>.</span><span class=na>build</span><span class=p>(</span><span class=n>Uri</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>InputStream</span><span class=p>.</span><span class=na>class</span><span class=p>));</span>
<a id=__codelineno-53-11 name=__codelineno-53-11></a><a href=#__codelineno-53-11><span class=linenos data-linenos="11 "></span></a> <span class=p>}</span>
<a id=__codelineno-53-12 name=__codelineno-53-12></a><a href=#__codelineno-53-12><span class=linenos data-linenos="12 "></span></a>
<a id=__codelineno-53-13 name=__codelineno-53-13></a><a href=#__codelineno-53-13><span class=linenos data-linenos="13 "></span></a> <span class=nd>@Override</span>
<a id=__codelineno-53-14 name=__codelineno-53-14></a><a href=#__codelineno-53-14><span class=linenos data-linenos="14 "></span></a> <span class=kd>public</span> <span class=kt>void</span> <span class=nf>teardown</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-53-15 name=__codelineno-53-15></a><a href=#__codelineno-53-15><span class=linenos data-linenos="15 "></span></a>   <span class=c1>// Do nothing.</span>
<a id=__codelineno-53-16 name=__codelineno-53-16></a><a href=#__codelineno-53-16><span class=linenos data-linenos="16 "></span></a> <span class=p>}</span>
<a id=__codelineno-53-17 name=__codelineno-53-17></a><a href=#__codelineno-53-17><span class=linenos data-linenos="17 "></span></a><span class=p>}</span>
</code></pre></div> <p>è¿™é‡Œè°ƒç”¨äº†<code>MultiModelLoaderFactory.build(Class, Class)</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•çš„é‡è½½æ–¹æ³•<code>MultiModelLoaderFactory.build(Class)</code>æˆ‘ä»¬åœ¨ä¸Šé¢é‡åˆ°è¿‡ï¼Œä¸¤ä¸ªæ–¹æ³•æœ‰ä¸€äº›å·®åˆ«ï¼Œä¸è¦å¼„æ··æ·†äº†ã€‚</p> <div class=highlight><pre><span></span><code><a id=__codelineno-54-1 name=__codelineno-54-1></a><a href=#__codelineno-54-1><span class=linenos data-linenos=" 1 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-54-2 name=__codelineno-54-2></a><a href=#__codelineno-54-2><span class=linenos data-linenos=" 2 "></span></a><span class=kd>public</span> <span class=kd>synchronized</span> <span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=n>Data</span><span class=o>&gt;</span> <span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=n>Data</span><span class=o>&gt;</span> <span class=nf>build</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Model</span><span class=o>&gt;</span> <span class=n>modelClass</span> <span class=cm>/* Uri.class */</span><span class=p>,</span>
<a id=__codelineno-54-3 name=__codelineno-54-3></a><a href=#__codelineno-54-3><span class=linenos data-linenos=" 3 "></span></a>   <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>dataClass</span> <span class=cm>/* InputStream.class */</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-54-4 name=__codelineno-54-4></a><a href=#__codelineno-54-4><span class=linenos data-linenos=" 4 "></span></a> <span class=k>try</span> <span class=p>{</span>
<a id=__codelineno-54-5 name=__codelineno-54-5></a><a href=#__codelineno-54-5><span class=linenos data-linenos=" 5 "></span></a>   <span class=n>List</span><span class=o>&lt;</span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=n>Data</span><span class=o>&gt;&gt;</span> <span class=n>loaders</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span>
<a id=__codelineno-54-6 name=__codelineno-54-6></a><a href=#__codelineno-54-6><span class=linenos data-linenos=" 6 "></span></a>   <span class=kt>boolean</span> <span class=n>ignoredAnyEntries</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
<a id=__codelineno-54-7 name=__codelineno-54-7></a><a href=#__codelineno-54-7><span class=linenos data-linenos=" 7 "></span></a>   <span class=k>for</span> <span class=p>(</span><span class=n>Entry</span><span class=o>&lt;?</span><span class=p>,</span> <span class=o>?&gt;</span> <span class=n>entry</span> <span class=p>:</span> <span class=n>entries</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-54-8 name=__codelineno-54-8></a><a href=#__codelineno-54-8><span class=linenos data-linenos=" 8 "></span></a>     <span class=c1>// Avoid stack overflow recursively creating model loaders by only creating loaders in</span>
<a id=__codelineno-54-9 name=__codelineno-54-9></a><a href=#__codelineno-54-9><span class=linenos data-linenos=" 9 "></span></a>     <span class=c1>// recursive requests if they haven&#39;t been created earlier in the chain. For example:</span>
<a id=__codelineno-54-10 name=__codelineno-54-10></a><a href=#__codelineno-54-10><span class=linenos data-linenos="10 "></span></a>     <span class=c1>// A Uri loader may translate to another model, which in turn may translate back to a Uri.</span>
<a id=__codelineno-54-11 name=__codelineno-54-11></a><a href=#__codelineno-54-11><span class=linenos data-linenos="11 "></span></a>     <span class=c1>// The original Uri loader won&#39;t be provided to the intermediate model loader, although</span>
<a id=__codelineno-54-12 name=__codelineno-54-12></a><a href=#__codelineno-54-12><span class=linenos data-linenos="12 "></span></a>     <span class=c1>// other Uri loaders will be.</span>
<a id=__codelineno-54-13 name=__codelineno-54-13></a><a href=#__codelineno-54-13><span class=linenos data-linenos="13 "></span></a>     <span class=c1>//</span>
<a id=__codelineno-54-14 name=__codelineno-54-14></a><a href=#__codelineno-54-14><span class=linenos data-linenos="14 "></span></a>     <span class=c1>// é˜²æ­¢é€’å½’æ—¶é‡å¤åŠ è½½åˆ°ï¼Œé€ æˆStackOverflow</span>
<a id=__codelineno-54-15 name=__codelineno-54-15></a><a href=#__codelineno-54-15><span class=linenos data-linenos="15 "></span></a>     <span class=k>if</span> <span class=p>(</span><span class=n>alreadyUsedEntries</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>entry</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-54-16 name=__codelineno-54-16></a><a href=#__codelineno-54-16><span class=linenos data-linenos="16 "></span></a>       <span class=n>ignoredAnyEntries</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
<a id=__codelineno-54-17 name=__codelineno-54-17></a><a href=#__codelineno-54-17><span class=linenos data-linenos="17 "></span></a>       <span class=k>continue</span><span class=p>;</span>
<a id=__codelineno-54-18 name=__codelineno-54-18></a><a href=#__codelineno-54-18><span class=linenos data-linenos="18 "></span></a>     <span class=p>}</span>
<a id=__codelineno-54-19 name=__codelineno-54-19></a><a href=#__codelineno-54-19><span class=linenos data-linenos="19 "></span></a>     <span class=c1>// âš¡âš¡ï¸âš¡ï¸ å·®åˆ«1ï¼Œè¿™é‡Œä¼šæ£€æŸ¥ä¸¤ä¸ªclass</span>
<a id=__codelineno-54-20 name=__codelineno-54-20></a><a href=#__codelineno-54-20><span class=linenos data-linenos="20 "></span></a>     <span class=k>if</span> <span class=p>(</span><span class=n>entry</span><span class=p>.</span><span class=na>handles</span><span class=p>(</span><span class=n>modelClass</span><span class=p>,</span> <span class=n>dataClass</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-54-21 name=__codelineno-54-21></a><a href=#__codelineno-54-21><span class=linenos data-linenos="21 "></span></a>       <span class=n>alreadyUsedEntries</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>entry</span><span class=p>);</span>
<a id=__codelineno-54-22 name=__codelineno-54-22></a><a href=#__codelineno-54-22><span class=linenos data-linenos="22 "></span></a>       <span class=n>loaders</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=n>Data</span><span class=o>&gt;</span><span class=n>build</span><span class=p>(</span><span class=n>entry</span><span class=p>));</span>
<a id=__codelineno-54-23 name=__codelineno-54-23></a><a href=#__codelineno-54-23><span class=linenos data-linenos="23 "></span></a>       <span class=n>alreadyUsedEntries</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>entry</span><span class=p>);</span>
<a id=__codelineno-54-24 name=__codelineno-54-24></a><a href=#__codelineno-54-24><span class=linenos data-linenos="24 "></span></a>     <span class=p>}</span>
<a id=__codelineno-54-25 name=__codelineno-54-25></a><a href=#__codelineno-54-25><span class=linenos data-linenos="25 "></span></a>   <span class=p>}</span>
<a id=__codelineno-54-26 name=__codelineno-54-26></a><a href=#__codelineno-54-26><span class=linenos data-linenos="26 "></span></a>   <span class=c1>// âš¡âš¡ï¸âš¡ï¸ å·®åˆ«2ï¼Œè¿™é‡Œä¼šæ£€æŸ¥loadersçš„æ•°é‡ï¼Œå¹¶åšç›¸åº”çš„å¤„ç†</span>
<a id=__codelineno-54-27 name=__codelineno-54-27></a><a href=#__codelineno-54-27><span class=linenos data-linenos="27 "></span></a>   <span class=k>if</span> <span class=p>(</span><span class=n>loaders</span><span class=p>.</span><span class=na>size</span><span class=p>()</span> <span class=o>&gt;</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-54-28 name=__codelineno-54-28></a><a href=#__codelineno-54-28><span class=linenos data-linenos="28 "></span></a>     <span class=k>return</span> <span class=n>factory</span><span class=p>.</span><span class=na>build</span><span class=p>(</span><span class=n>loaders</span><span class=p>,</span> <span class=n>throwableListPool</span><span class=p>);</span>
<a id=__codelineno-54-29 name=__codelineno-54-29></a><a href=#__codelineno-54-29><span class=linenos data-linenos="29 "></span></a>   <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>loaders</span><span class=p>.</span><span class=na>size</span><span class=p>()</span> <span class=o>==</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-54-30 name=__codelineno-54-30></a><a href=#__codelineno-54-30><span class=linenos data-linenos="30 "></span></a>     <span class=k>return</span> <span class=n>loaders</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
<a id=__codelineno-54-31 name=__codelineno-54-31></a><a href=#__codelineno-54-31><span class=linenos data-linenos="31 "></span></a>   <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
<a id=__codelineno-54-32 name=__codelineno-54-32></a><a href=#__codelineno-54-32><span class=linenos data-linenos="32 "></span></a>     <span class=c1>// Avoid crashing if recursion results in no loaders available. The assertion is supposed to</span>
<a id=__codelineno-54-33 name=__codelineno-54-33></a><a href=#__codelineno-54-33><span class=linenos data-linenos="33 "></span></a>     <span class=c1>// catch completely unhandled types, recursion may mean a subtype isn&#39;t handled somewhere</span>
<a id=__codelineno-54-34 name=__codelineno-54-34></a><a href=#__codelineno-54-34><span class=linenos data-linenos="34 "></span></a>     <span class=c1>// down the stack, which is often ok.</span>
<a id=__codelineno-54-35 name=__codelineno-54-35></a><a href=#__codelineno-54-35><span class=linenos data-linenos="35 "></span></a>     <span class=k>if</span> <span class=p>(</span><span class=n>ignoredAnyEntries</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-54-36 name=__codelineno-54-36></a><a href=#__codelineno-54-36><span class=linenos data-linenos="36 "></span></a>       <span class=k>return</span> <span class=n>emptyModelLoader</span><span class=p>();</span>
<a id=__codelineno-54-37 name=__codelineno-54-37></a><a href=#__codelineno-54-37><span class=linenos data-linenos="37 "></span></a>     <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
<a id=__codelineno-54-38 name=__codelineno-54-38></a><a href=#__codelineno-54-38><span class=linenos data-linenos="38 "></span></a>       <span class=k>throw</span> <span class=k>new</span> <span class=n>NoModelLoaderAvailableException</span><span class=p>(</span><span class=n>modelClass</span><span class=p>,</span> <span class=n>dataClass</span><span class=p>);</span>
<a id=__codelineno-54-39 name=__codelineno-54-39></a><a href=#__codelineno-54-39><span class=linenos data-linenos="39 "></span></a>     <span class=p>}</span>
<a id=__codelineno-54-40 name=__codelineno-54-40></a><a href=#__codelineno-54-40><span class=linenos data-linenos="40 "></span></a>   <span class=p>}</span>
<a id=__codelineno-54-41 name=__codelineno-54-41></a><a href=#__codelineno-54-41><span class=linenos data-linenos="41 "></span></a> <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-54-42 name=__codelineno-54-42></a><a href=#__codelineno-54-42><span class=linenos data-linenos="42 "></span></a>   <span class=n>alreadyUsedEntries</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span>
<a id=__codelineno-54-43 name=__codelineno-54-43></a><a href=#__codelineno-54-43><span class=linenos data-linenos="43 "></span></a>   <span class=k>throw</span> <span class=n>t</span><span class=p>;</span>
<a id=__codelineno-54-44 name=__codelineno-54-44></a><a href=#__codelineno-54-44><span class=linenos data-linenos="44 "></span></a> <span class=p>}</span>
<a id=__codelineno-54-45 name=__codelineno-54-45></a><a href=#__codelineno-54-45><span class=linenos data-linenos="45 "></span></a><span class=p>}</span>
</code></pre></div> <p>æˆ‘ä»¬çœ‹ä¸€ä¸‹å››ä¸ªæ³¨å†Œé¡¹è°ƒç”¨<code>this.&lt;Model, Data&gt;build(entry)</code>åè¿”å›çš„å€¼ï¼š</p> <p><code>append(String.class, InputStream.class, new DataUrlLoader.StreamFactory&lt;String&gt;())</code> - build &rarr; <code>DataUrlLoader</code></p> <p><code>append(String.class, InputStream.class, new StringLoader.StreamFactory())</code><br> - build &rarr; <code>StringLoader</code> å‚æ•°urlLoader = <code>multiFactory.build(Uri.class, InputStream.class)</code><br> å°†Stringå½“ä½œUriæ¥å¤„ç†ï¼Œä¸‹é¢å¼€å§‹åœ¨æ³¨å†Œè¡¨ä¸­æ‰¾æ‰€æœ‰modelClassä¸ºUri.classï¼ŒdataClassä¸ºInputStream.classçš„æ³¨å†Œé¡¹<br> - <code>append(Uri.class, InputStream.class, new DataUrlLoader.StreamFactory&lt;Uri&gt;())</code><br> - build &rarr; <code>DataUrlLoader</code> - <code>append(Uri.class, InputStream.class, new HttpUriLoader.Factory())</code><br> - build &rarr; <code>HttpUriLoader</code> å‚æ•°urlLoader = <code>multiFactory.build(GlideUrl.class, InputStream.class)</code><br> Uriå¯èƒ½æ˜¯ä¸€ä¸ªGlideUrlï¼Œä¸‹é¢å¼€å§‹åœ¨æ³¨å†Œè¡¨ä¸­æ‰¾æ‰€æœ‰modelClassä¸ºGlideUrl.classï¼ŒdataClassä¸ºInputStream.classçš„æ³¨å†Œé¡¹ - <code>.append(GlideUrl.class, InputStream.class, new HttpGlideUrlLoader.Factory())</code><br> - build &rarr; <code>HttpGlideUrlLoader</code> - <code>append(Uri.class, InputStream.class, new AssetUriLoader.StreamFactory(context.getAssets()))</code><br> - build &rarr; <code>AssetUriLoader</code> - <code>append(Uri.class, InputStream.class, new MediaStoreImageThumbLoader.Factory(context))</code><br> - build &rarr; <code>MediaStoreImageThumbLoader</code> - <code>append(Uri.class, InputStream.class, new MediaStoreVideoThumbLoader.Factory(context))</code><br> - build &rarr; <code>MediaStoreVideoThumbLoader</code> - <code>append(Uri.class, InputStream.class, new UriLoader.StreamFactory(contentResolver))</code><br> - build &rarr; <code>UriLoader</code> - <code>append(Uri.class, InputStream.class, new UrlUriLoader.StreamFactory())</code><br> - build &rarr; <code>UrlUriLoader</code> å‚æ•°urlLoader = <code>multiFactory.build(GlideUrl.class, InputStream.class)</code><br> Uriå¯èƒ½æ˜¯ä¸€ä¸ªGlideUrlï¼Œä¸‹é¢å¼€å§‹åœ¨æ³¨å†Œè¡¨ä¸­æ‰¾æ‰€æœ‰modelClassä¸ºGlideUrl.classï¼ŒdataClassä¸ºInputStream.classçš„æ³¨å†Œé¡¹ - <code>.append(GlideUrl.class, InputStream.class, new HttpGlideUrlLoader.Factory())</code><br> - build &rarr; <code>HttpGlideUrlLoader</code> - <code>MultiModelLoader</code></p> <p><code>append(String.class, ParcelFileDescriptor.class, new StringLoader.FileDescriptorFactory())</code><br> - build &rarr; <code>StringLoader</code> å‚æ•°urlLoader = <code>multiFactory.build(Uri.class, ParcelFileDescriptor.class)</code><br> å°†Stringå½“ä½œUriæ¥å¤„ç†ï¼Œä¸‹é¢å¼€å§‹åœ¨æ³¨å†Œè¡¨ä¸­æ‰¾æ‰€æœ‰modelClassä¸ºUri.classï¼ŒdataClassä¸ºParcelFileDescriptor.classçš„æ³¨å†Œé¡¹<br> - <code>append(Uri.class, ParcelFileDescriptor.class, new AssetUriLoader.FileDescriptorFactory(context.getAssets()))</code><br> - build &rarr; <code>AssetUriLoader</code> - <code>append(Uri.class, ParcelFileDescriptor.class, new UriLoader.FileDescriptorFactory(contentResolver))</code> <br> - build &rarr; <code>UriLoader</code> - <code>MultiModelLoader</code></p> <p><code>append(String.class, AssetFileDescriptor.class, new StringLoader.AssetFileDescriptorFactory())</code><br> - build &rarr; <code>StringLoader</code> å‚æ•°urlLoader = <code>multiFactory.build(Uri.class, AssetFileDescriptor.class)</code><br> å°†Stringå½“ä½œUriæ¥å¤„ç†ï¼Œä¸‹é¢å¼€å§‹åœ¨æ³¨å†Œè¡¨ä¸­æ‰¾æ‰€æœ‰modelClassä¸ºUri.classï¼ŒdataClassä¸ºAssetFileDescriptor.classçš„æ³¨å†Œé¡¹<br> - <code>append(Uri.class, AssetFileDescriptor.class, new UriLoader.AssetFileDescriptorFactory(contentResolver))</code><br> - build &rarr; <code>UriLoader</code> - <code>UriLoader</code></p> <p>ä¸Šé¢å°±æ˜¯<code>this.&lt;Model, Data&gt;build(entry)</code>è·å¾—åˆ°çš„4ä¸ªloaderï¼Œç„¶ååœ¨<code>modelLoaderRegistry.getModelLoaders(model)</code>æ–¹æ³•ä¸­è¢«è¿‡æ»¤æ‰ç¬¬ä¸€ä¸ªï¼Œç°åœ¨å°±è¿”å›3.6.1èŠ‚åˆšå¼€å§‹çš„<code>DecodeHelper.getLoadData</code>æ–¹æ³•é‡Œé¢äº†ã€‚</p> <p>åœ¨<code>DecodeHelper.getLoadData</code>æ–¹æ³•ä¸­ä¼šéå†æ¯ä¸ªModelLoaderï¼Œå¹¶è°ƒç”¨å…¶<code>buildLoadData</code>æ–¹æ³•ï¼Œå¦‚æœä¸ä¸ºç©ºåˆ™åŠ å…¥åˆ°æ•°ç»„ä¸­ã€‚ç”±äºæ­¤å¤„çš„3ä¸ªModelLoaderéƒ½æ˜¯<code>StringLoader</code>ï¼Œæˆ‘ä»¬çœ‹çœ‹<code>StringLoader.buildLoadData</code>æ–¹æ³•ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-55-1 name=__codelineno-55-1></a><a href=#__codelineno-55-1><span class=linenos data-linenos=" 1 "></span></a><span class=nd>@Override</span>
<a id=__codelineno-55-2 name=__codelineno-55-2></a><a href=#__codelineno-55-2><span class=linenos data-linenos=" 2 "></span></a><span class=kd>public</span> <span class=n>LoadData</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=nf>buildLoadData</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>String</span> <span class=n>model</span><span class=p>,</span> <span class=kt>int</span> <span class=n>width</span><span class=p>,</span> <span class=kt>int</span> <span class=n>height</span><span class=p>,</span>
<a id=__codelineno-55-3 name=__codelineno-55-3></a><a href=#__codelineno-55-3><span class=linenos data-linenos=" 3 "></span></a>   <span class=nd>@NonNull</span> <span class=n>Options</span> <span class=n>options</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-55-4 name=__codelineno-55-4></a><a href=#__codelineno-55-4><span class=linenos data-linenos=" 4 "></span></a> <span class=c1>// ç”±äºæˆ‘ä»¬ä¼ å…¥çš„modelæ˜¯ä¸€ä¸ªç½‘ç»œå›¾ç‰‡åœ°å€ï¼Œæ‰€ä»¥uriè‚¯å®šæ˜¯æ­£å¸¸çš„</span>
<a id=__codelineno-55-5 name=__codelineno-55-5></a><a href=#__codelineno-55-5><span class=linenos data-linenos=" 5 "></span></a> <span class=n>Uri</span> <span class=n>uri</span> <span class=o>=</span> <span class=n>parseUri</span><span class=p>(</span><span class=n>model</span><span class=p>);</span>
<a id=__codelineno-55-6 name=__codelineno-55-6></a><a href=#__codelineno-55-6><span class=linenos data-linenos=" 6 "></span></a> <span class=c1>// ä¸‹é¢åˆ¤æ–­uriLoaderæ˜¯å¦æœ‰å¯èƒ½å¤„ç†</span>
<a id=__codelineno-55-7 name=__codelineno-55-7></a><a href=#__codelineno-55-7><span class=linenos data-linenos=" 7 "></span></a> <span class=c1>// å¦‚æœæ²¡æœ‰å¯èƒ½ï¼Œé‚£ä¹ˆè¿”å›null</span>
<a id=__codelineno-55-8 name=__codelineno-55-8></a><a href=#__codelineno-55-8><span class=linenos data-linenos=" 8 "></span></a> <span class=k>if</span> <span class=p>(</span><span class=n>uri</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=o>!</span><span class=n>uriLoader</span><span class=p>.</span><span class=na>handles</span><span class=p>(</span><span class=n>uri</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-55-9 name=__codelineno-55-9></a><a href=#__codelineno-55-9><span class=linenos data-linenos=" 9 "></span></a>   <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-55-10 name=__codelineno-55-10></a><a href=#__codelineno-55-10><span class=linenos data-linenos="10 "></span></a> <span class=p>}</span>
<a id=__codelineno-55-11 name=__codelineno-55-11></a><a href=#__codelineno-55-11><span class=linenos data-linenos="11 "></span></a> <span class=c1>// å¦åˆ™è°ƒç”¨uriLoaderçš„buildLoadDataæ–¹æ³•</span>
<a id=__codelineno-55-12 name=__codelineno-55-12></a><a href=#__codelineno-55-12><span class=linenos data-linenos="12 "></span></a> <span class=k>return</span> <span class=n>uriLoader</span><span class=p>.</span><span class=na>buildLoadData</span><span class=p>(</span><span class=n>uri</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>,</span> <span class=n>options</span><span class=p>);</span>
<a id=__codelineno-55-13 name=__codelineno-55-13></a><a href=#__codelineno-55-13><span class=linenos data-linenos="13 "></span></a><span class=p>}</span>
<a id=__codelineno-55-14 name=__codelineno-55-14></a><a href=#__codelineno-55-14><span class=linenos data-linenos="14 "></span></a>
<a id=__codelineno-55-15 name=__codelineno-55-15></a><a href=#__codelineno-55-15><span class=linenos data-linenos="15 "></span></a><span class=nd>@Nullable</span>
<a id=__codelineno-55-16 name=__codelineno-55-16></a><a href=#__codelineno-55-16><span class=linenos data-linenos="16 "></span></a><span class=kd>private</span> <span class=kd>static</span> <span class=n>Uri</span> <span class=nf>parseUri</span><span class=p>(</span><span class=n>String</span> <span class=n>model</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-55-17 name=__codelineno-55-17></a><a href=#__codelineno-55-17><span class=linenos data-linenos="17 "></span></a> <span class=n>Uri</span> <span class=n>uri</span><span class=p>;</span>
<a id=__codelineno-55-18 name=__codelineno-55-18></a><a href=#__codelineno-55-18><span class=linenos data-linenos="18 "></span></a> <span class=k>if</span> <span class=p>(</span><span class=n>TextUtils</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>(</span><span class=n>model</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-55-19 name=__codelineno-55-19></a><a href=#__codelineno-55-19><span class=linenos data-linenos="19 "></span></a>   <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-55-20 name=__codelineno-55-20></a><a href=#__codelineno-55-20><span class=linenos data-linenos="20 "></span></a> <span class=c1>// See https://pmd.github.io/pmd-6.0.0/pmd_rules_java_performance.html#simplifystartswith</span>
<a id=__codelineno-55-21 name=__codelineno-55-21></a><a href=#__codelineno-55-21><span class=linenos data-linenos="21 "></span></a> <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>model</span><span class=p>.</span><span class=na>charAt</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span> <span class=o>==</span> <span class=sc>&#39;/&#39;</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-55-22 name=__codelineno-55-22></a><a href=#__codelineno-55-22><span class=linenos data-linenos="22 "></span></a>   <span class=n>uri</span> <span class=o>=</span> <span class=n>toFileUri</span><span class=p>(</span><span class=n>model</span><span class=p>);</span>
<a id=__codelineno-55-23 name=__codelineno-55-23></a><a href=#__codelineno-55-23><span class=linenos data-linenos="23 "></span></a> <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
<a id=__codelineno-55-24 name=__codelineno-55-24></a><a href=#__codelineno-55-24><span class=linenos data-linenos="24 "></span></a>   <span class=n>uri</span> <span class=o>=</span> <span class=n>Uri</span><span class=p>.</span><span class=na>parse</span><span class=p>(</span><span class=n>model</span><span class=p>);</span>
<a id=__codelineno-55-25 name=__codelineno-55-25></a><a href=#__codelineno-55-25><span class=linenos data-linenos="25 "></span></a>   <span class=n>String</span> <span class=n>scheme</span> <span class=o>=</span> <span class=n>uri</span><span class=p>.</span><span class=na>getScheme</span><span class=p>();</span>
<a id=__codelineno-55-26 name=__codelineno-55-26></a><a href=#__codelineno-55-26><span class=linenos data-linenos="26 "></span></a>   <span class=k>if</span> <span class=p>(</span><span class=n>scheme</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-55-27 name=__codelineno-55-27></a><a href=#__codelineno-55-27><span class=linenos data-linenos="27 "></span></a>     <span class=n>uri</span> <span class=o>=</span> <span class=n>toFileUri</span><span class=p>(</span><span class=n>model</span><span class=p>);</span>
<a id=__codelineno-55-28 name=__codelineno-55-28></a><a href=#__codelineno-55-28><span class=linenos data-linenos="28 "></span></a>   <span class=p>}</span>
<a id=__codelineno-55-29 name=__codelineno-55-29></a><a href=#__codelineno-55-29><span class=linenos data-linenos="29 "></span></a> <span class=p>}</span>
<a id=__codelineno-55-30 name=__codelineno-55-30></a><a href=#__codelineno-55-30><span class=linenos data-linenos="30 "></span></a> <span class=k>return</span> <span class=n>uri</span><span class=p>;</span>
<a id=__codelineno-55-31 name=__codelineno-55-31></a><a href=#__codelineno-55-31><span class=linenos data-linenos="31 "></span></a><span class=p>}</span>
<a id=__codelineno-55-32 name=__codelineno-55-32></a><a href=#__codelineno-55-32><span class=linenos data-linenos="32 "></span></a>
<a id=__codelineno-55-33 name=__codelineno-55-33></a><a href=#__codelineno-55-33><span class=linenos data-linenos="33 "></span></a><span class=kd>private</span> <span class=kd>static</span> <span class=n>Uri</span> <span class=nf>toFileUri</span><span class=p>(</span><span class=n>String</span> <span class=n>path</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-55-34 name=__codelineno-55-34></a><a href=#__codelineno-55-34><span class=linenos data-linenos="34 "></span></a> <span class=k>return</span> <span class=n>Uri</span><span class=p>.</span><span class=na>fromFile</span><span class=p>(</span><span class=k>new</span> <span class=n>File</span><span class=p>(</span><span class=n>path</span><span class=p>));</span>
<a id=__codelineno-55-35 name=__codelineno-55-35></a><a href=#__codelineno-55-35><span class=linenos data-linenos="35 "></span></a><span class=p>}</span>
</code></pre></div> <p>æ‰€ä»¥é‡ç‚¹å°±åœ¨äº<code>StringLoader.uriLoader</code>äº†ï¼Œè¯¥å‚æ•°æˆ‘ä»¬ä¸Šé¢åˆ†æé€’å½’è¿‡ç¨‹çš„æ—¶å€™åˆ†æåˆ°äº†ï¼Œæ˜¯ä¸€ä¸ª<code>MultiModelLoader</code>å¯¹è±¡ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-56-1 name=__codelineno-56-1></a><a href=#__codelineno-56-1><span class=linenos data-linenos=" 1 "></span></a><span class=kd>class</span> <span class=nc>MultiModelLoader</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=n>Data</span><span class=o>&gt;</span> <span class=kd>implements</span> <span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=n>Data</span><span class=o>&gt;</span> <span class=p>{</span>
<a id=__codelineno-56-2 name=__codelineno-56-2></a><a href=#__codelineno-56-2><span class=linenos data-linenos=" 2 "></span></a>
<a id=__codelineno-56-3 name=__codelineno-56-3></a><a href=#__codelineno-56-3><span class=linenos data-linenos=" 3 "></span></a> <span class=kd>private</span> <span class=kd>final</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=n>Data</span><span class=o>&gt;&gt;</span> <span class=n>modelLoaders</span><span class=p>;</span>
<a id=__codelineno-56-4 name=__codelineno-56-4></a><a href=#__codelineno-56-4><span class=linenos data-linenos=" 4 "></span></a> <span class=kd>private</span> <span class=kd>final</span> <span class=n>Pool</span><span class=o>&lt;</span><span class=n>List</span><span class=o>&lt;</span><span class=n>Throwable</span><span class=o>&gt;&gt;</span> <span class=n>exceptionListPool</span><span class=p>;</span>
<a id=__codelineno-56-5 name=__codelineno-56-5></a><a href=#__codelineno-56-5><span class=linenos data-linenos=" 5 "></span></a>
<a id=__codelineno-56-6 name=__codelineno-56-6></a><a href=#__codelineno-56-6><span class=linenos data-linenos=" 6 "></span></a> <span class=n>MultiModelLoader</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=n>Data</span><span class=o>&gt;&gt;</span> <span class=n>modelLoaders</span><span class=p>,</span>
<a id=__codelineno-56-7 name=__codelineno-56-7></a><a href=#__codelineno-56-7><span class=linenos data-linenos=" 7 "></span></a>     <span class=nd>@NonNull</span> <span class=n>Pool</span><span class=o>&lt;</span><span class=n>List</span><span class=o>&lt;</span><span class=n>Throwable</span><span class=o>&gt;&gt;</span> <span class=n>exceptionListPool</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-56-8 name=__codelineno-56-8></a><a href=#__codelineno-56-8><span class=linenos data-linenos=" 8 "></span></a>   <span class=k>this</span><span class=p>.</span><span class=na>modelLoaders</span> <span class=o>=</span> <span class=n>modelLoaders</span><span class=p>;</span>
<a id=__codelineno-56-9 name=__codelineno-56-9></a><a href=#__codelineno-56-9><span class=linenos data-linenos=" 9 "></span></a>   <span class=k>this</span><span class=p>.</span><span class=na>exceptionListPool</span> <span class=o>=</span> <span class=n>exceptionListPool</span><span class=p>;</span>
<a id=__codelineno-56-10 name=__codelineno-56-10></a><a href=#__codelineno-56-10><span class=linenos data-linenos="10 "></span></a> <span class=p>}</span>
<a id=__codelineno-56-11 name=__codelineno-56-11></a><a href=#__codelineno-56-11><span class=linenos data-linenos="11 "></span></a>
<a id=__codelineno-56-12 name=__codelineno-56-12></a><a href=#__codelineno-56-12><span class=linenos data-linenos="12 "></span></a> <span class=nd>@Override</span>
<a id=__codelineno-56-13 name=__codelineno-56-13></a><a href=#__codelineno-56-13><span class=linenos data-linenos="13 "></span></a> <span class=kd>public</span> <span class=n>LoadData</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=nf>buildLoadData</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Model</span> <span class=n>model</span><span class=p>,</span> <span class=kt>int</span> <span class=n>width</span><span class=p>,</span> <span class=kt>int</span> <span class=n>height</span><span class=p>,</span>
<a id=__codelineno-56-14 name=__codelineno-56-14></a><a href=#__codelineno-56-14><span class=linenos data-linenos="14 "></span></a>     <span class=nd>@NonNull</span> <span class=n>Options</span> <span class=n>options</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-56-15 name=__codelineno-56-15></a><a href=#__codelineno-56-15><span class=linenos data-linenos="15 "></span></a>   <span class=n>Key</span> <span class=n>sourceKey</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-56-16 name=__codelineno-56-16></a><a href=#__codelineno-56-16><span class=linenos data-linenos="16 "></span></a>   <span class=kt>int</span> <span class=n>size</span> <span class=o>=</span> <span class=n>modelLoaders</span><span class=p>.</span><span class=na>size</span><span class=p>();</span>
<a id=__codelineno-56-17 name=__codelineno-56-17></a><a href=#__codelineno-56-17><span class=linenos data-linenos="17 "></span></a>   <span class=n>List</span><span class=o>&lt;</span><span class=n>DataFetcher</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;&gt;</span> <span class=n>fetchers</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>size</span><span class=p>);</span>
<a id=__codelineno-56-18 name=__codelineno-56-18></a><a href=#__codelineno-56-18><span class=linenos data-linenos="18 "></span></a>   <span class=c1>//noinspection ForLoopReplaceableByForEach to improve perf</span>
<a id=__codelineno-56-19 name=__codelineno-56-19></a><a href=#__codelineno-56-19><span class=linenos data-linenos="19 "></span></a>   <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>size</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-56-20 name=__codelineno-56-20></a><a href=#__codelineno-56-20><span class=linenos data-linenos="20 "></span></a>     <span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=n>Data</span><span class=o>&gt;</span> <span class=n>modelLoader</span> <span class=o>=</span> <span class=n>modelLoaders</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
<a id=__codelineno-56-21 name=__codelineno-56-21></a><a href=#__codelineno-56-21><span class=linenos data-linenos="21 "></span></a>     <span class=k>if</span> <span class=p>(</span><span class=n>modelLoader</span><span class=p>.</span><span class=na>handles</span><span class=p>(</span><span class=n>model</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-56-22 name=__codelineno-56-22></a><a href=#__codelineno-56-22><span class=linenos data-linenos="22 "></span></a>       <span class=n>LoadData</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>loadData</span> <span class=o>=</span> <span class=n>modelLoader</span><span class=p>.</span><span class=na>buildLoadData</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>,</span> <span class=n>options</span><span class=p>);</span>
<a id=__codelineno-56-23 name=__codelineno-56-23></a><a href=#__codelineno-56-23><span class=linenos data-linenos="23 "></span></a>       <span class=k>if</span> <span class=p>(</span><span class=n>loadData</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-56-24 name=__codelineno-56-24></a><a href=#__codelineno-56-24><span class=linenos data-linenos="24 "></span></a>         <span class=n>sourceKey</span> <span class=o>=</span> <span class=n>loadData</span><span class=p>.</span><span class=na>sourceKey</span><span class=p>;</span>
<a id=__codelineno-56-25 name=__codelineno-56-25></a><a href=#__codelineno-56-25><span class=linenos data-linenos="25 "></span></a>         <span class=n>fetchers</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>);</span>
<a id=__codelineno-56-26 name=__codelineno-56-26></a><a href=#__codelineno-56-26><span class=linenos data-linenos="26 "></span></a>       <span class=p>}</span>
<a id=__codelineno-56-27 name=__codelineno-56-27></a><a href=#__codelineno-56-27><span class=linenos data-linenos="27 "></span></a>     <span class=p>}</span>
<a id=__codelineno-56-28 name=__codelineno-56-28></a><a href=#__codelineno-56-28><span class=linenos data-linenos="28 "></span></a>   <span class=p>}</span>
<a id=__codelineno-56-29 name=__codelineno-56-29></a><a href=#__codelineno-56-29><span class=linenos data-linenos="29 "></span></a>   <span class=k>return</span> <span class=o>!</span><span class=n>fetchers</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>()</span> <span class=o>&amp;&amp;</span> <span class=n>sourceKey</span> <span class=o>!=</span> <span class=kc>null</span>
<a id=__codelineno-56-30 name=__codelineno-56-30></a><a href=#__codelineno-56-30><span class=linenos data-linenos="30 "></span></a>       <span class=o>?</span> <span class=k>new</span> <span class=n>LoadData</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>sourceKey</span><span class=p>,</span> <span class=k>new</span> <span class=n>MultiFetcher</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>fetchers</span><span class=p>,</span> <span class=n>exceptionListPool</span><span class=p>))</span> <span class=p>:</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-56-31 name=__codelineno-56-31></a><a href=#__codelineno-56-31><span class=linenos data-linenos="31 "></span></a> <span class=p>}</span>
<a id=__codelineno-56-32 name=__codelineno-56-32></a><a href=#__codelineno-56-32><span class=linenos data-linenos="32 "></span></a>
<a id=__codelineno-56-33 name=__codelineno-56-33></a><a href=#__codelineno-56-33><span class=linenos data-linenos="33 "></span></a> <span class=nd>@Override</span>
<a id=__codelineno-56-34 name=__codelineno-56-34></a><a href=#__codelineno-56-34><span class=linenos data-linenos="34 "></span></a> <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>handles</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Model</span> <span class=n>model</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-56-35 name=__codelineno-56-35></a><a href=#__codelineno-56-35><span class=linenos data-linenos="35 "></span></a>   <span class=k>for</span> <span class=p>(</span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=n>Data</span><span class=o>&gt;</span> <span class=n>modelLoader</span> <span class=p>:</span> <span class=n>modelLoaders</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-56-36 name=__codelineno-56-36></a><a href=#__codelineno-56-36><span class=linenos data-linenos="36 "></span></a>     <span class=k>if</span> <span class=p>(</span><span class=n>modelLoader</span><span class=p>.</span><span class=na>handles</span><span class=p>(</span><span class=n>model</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-56-37 name=__codelineno-56-37></a><a href=#__codelineno-56-37><span class=linenos data-linenos="37 "></span></a>       <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
<a id=__codelineno-56-38 name=__codelineno-56-38></a><a href=#__codelineno-56-38><span class=linenos data-linenos="38 "></span></a>     <span class=p>}</span>
<a id=__codelineno-56-39 name=__codelineno-56-39></a><a href=#__codelineno-56-39><span class=linenos data-linenos="39 "></span></a>   <span class=p>}</span>
<a id=__codelineno-56-40 name=__codelineno-56-40></a><a href=#__codelineno-56-40><span class=linenos data-linenos="40 "></span></a>   <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
<a id=__codelineno-56-41 name=__codelineno-56-41></a><a href=#__codelineno-56-41><span class=linenos data-linenos="41 "></span></a> <span class=p>}</span>
<a id=__codelineno-56-42 name=__codelineno-56-42></a><a href=#__codelineno-56-42><span class=linenos data-linenos="42 "></span></a><span class=p>}</span>
</code></pre></div> <p><code>MultiModelLoader</code>ç±»çš„<code>handles</code>æ–¹æ³•å’Œ<code>buildLoadData</code>æ–¹æ³•éƒ½æ¯”è¾ƒæ¸…æ™°æ˜äº†ã€‚ </p> <ul> <li><code>handles</code>æ–¹æ³•æ˜¯åªè¦å†…éƒ¨æœ‰ä¸€ä¸ªModelLoaderæœ‰å¯èƒ½å¤„ç†ï¼Œå°±è¿”å›trueã€‚ </li> <li><code>buildLoadData</code>æ–¹æ³•ä¼šå…ˆè°ƒç”¨<code>hanldes</code>è¿›è¡Œç¬¬ä¸€æ¬¡ç­›é€‰ï¼Œç„¶ååœ¨è°ƒç”¨ModelLoaderçš„<code>buildLoadData</code>æ–¹æ³•ï¼Œå¦‚æœä¸ä¸ºç©ºåˆ™ä¿å­˜èµ·æ¥ï¼Œæœ€åè¿”å›<code>LoadData&lt;&gt;(sourceKey, new MultiFetcher&lt;&gt;(fetchers, exceptionListPool))</code>å¯¹è±¡ã€‚</li> </ul> <p>æˆ‘ä»¬è¿˜æ˜¯èµ°ä¸€ä¸‹<code>DecodeHelper.getLoadData</code>æ–¹æ³•ä¸­çš„æµç¨‹ï¼Œéå†ä¸€ä¸‹è°ƒç”¨ä¸‰ä¸ª<code>StringLoader</code>çš„<code>buildLoadData</code>æ–¹æ³•ï¼š</p> <p><code>append(String.class, InputStream.class, new StringLoader.StreamFactory())</code><br> - build &rarr; <code>StringLoader</code> å‚æ•°urlLoader = <code>MultiModelLoader</code> - <code>DataUrlLoader</code> å¤„ç†data:imageèµ„æº<br> 1 <em>handles</em>: <strong>false</strong><br> 3 <em>buildLoadData</em>: è·³è¿‡ å› ä¸º<em>handles</em> return <strong>false</strong> - <code>HttpUriLoader</code> å¤„ç†httpã€httpsèµ„æº å‚æ•°urlLoader = <code>HttpGlideUrlLoader</code><br> 2 <em>handles</em>: <strong>true</strong><br> 4 <em>buildLoadData</em>: <code>HttpGlideUrlLoader.buildLoadData(GlideUrl)</code> &rarr; <code>LoadData&lt;&gt;(url, new HttpUrlFetcher(url, timeout))</code> ---&gt; <code>fetchers.add(loadData.fetcher)</code> - <code>AssetUriLoader</code> å¤„ç†file:///android_asset/èµ„æº<br> 5 <em>buildLoadData</em>: è·³è¿‡ å› ä¸º<em>handles</em> return <strong>false</strong> - <code>MediaStoreImageThumbLoader</code> å¤„ç†content://media/ä¸”path segmentsä¸­ä¸åŒ…å«videoå­—ç¬¦ä¸²çš„èµ„æº<br> 6 <em>buildLoadData</em>: è·³è¿‡ å› ä¸º<em>handles</em> return <strong>false</strong> - <code>MediaStoreVideoThumbLoader</code> å¤„ç†content://media/ä¸”path segmentsä¸­åŒ…å«videoå­—ç¬¦ä¸²çš„èµ„æº<br> 7 <em>buildLoadData</em>: è·³è¿‡ å› ä¸º<em>handles</em> return <strong>false</strong> - <code>UriLoader</code> å¤„ç†schemeä¸ºfileã€android.resourceã€contentçš„èµ„æº<br> 8 <em>buildLoadData</em>: è·³è¿‡ å› ä¸º<em>handles</em> return <strong>false</strong> - <code>UrlUriLoader</code> å¤„ç†httpã€httpsèµ„æº å‚æ•°urlLoader = <code>HttpGlideUrlLoader</code><br> 9 <em>buildLoadData</em>: <code>HttpGlideUrlLoader.buildLoadData(GlideUrl)</code> ---&gt; <code>LoadData&lt;&gt;(url, new HttpUrlFetcher(url, timeout))</code> ---&gt; <code>fetchers.add(loadData.fetcher)</code> - å¾—åˆ° <code>LoadData&lt;&gt;(sourceKey, new MultiFetcher&lt;&gt;(fetchers, exceptionListPool))</code></p> <p><code>append(String.class, ParcelFileDescriptor.class, new StringLoader.FileDescriptorFactory())</code><br> - build &rarr; <code>StringLoader</code> å‚æ•°urlLoader = <code>MultiModelLoader</code> - <code>AssetUriLoader</code> å¤„ç†file:///android_asset/èµ„æº<br> 1 <em>handles</em>: <strong>false</strong><br> - <code>UriLoader</code> å¤„ç†schemeä¸ºfileã€android.resourceã€contentçš„èµ„æº<br> 2 <em>handles</em>: <strong>false</strong><br> - å¾—åˆ° <code>null</code></p> <p><code>append(String.class, AssetFileDescriptor.class, new StringLoader.AssetFileDescriptorFactory())</code><br> - build &rarr; <code>StringLoader</code> å‚æ•°urlLoader = - <code>UriLoader</code> å¤„ç†schemeä¸ºfileã€android.resourceã€contentçš„èµ„æº<br> 1 <em>handles</em>: <strong>false</strong><br> - å¾—åˆ° <code>null</code></p> <p>ç”±äº<code>DecodeHelper.getLoadData</code>åªæ·»åŠ ä¸ä¸ºnullçš„<code>LoadData</code>ï¼Œæ‰€ä»¥åªè¿”å›äº†ä¸€ä¸ª<code>StringLoader.StreamFactory()</code>ç”Ÿæˆçš„<code>LoadData</code>ã€‚ </p> <p>è¿”å›åˆ°ä¸Šä¸€ä¸ªæ–¹æ³•<code>DecodeHelper.getCacheKeys</code>ä¸­ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-57-1 name=__codelineno-57-1></a><a href=#__codelineno-57-1><span class=linenos data-linenos=" 1 "></span></a><span class=n>List</span><span class=o>&lt;</span><span class=n>Key</span><span class=o>&gt;</span> <span class=nf>getCacheKeys</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-57-2 name=__codelineno-57-2></a><a href=#__codelineno-57-2><span class=linenos data-linenos=" 2 "></span></a> <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>isCacheKeysSet</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-57-3 name=__codelineno-57-3></a><a href=#__codelineno-57-3><span class=linenos data-linenos=" 3 "></span></a>   <span class=n>isCacheKeysSet</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
<a id=__codelineno-57-4 name=__codelineno-57-4></a><a href=#__codelineno-57-4><span class=linenos data-linenos=" 4 "></span></a>   <span class=n>cacheKeys</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span>
<a id=__codelineno-57-5 name=__codelineno-57-5></a><a href=#__codelineno-57-5><span class=linenos data-linenos=" 5 "></span></a>   <span class=n>List</span><span class=o>&lt;</span><span class=n>LoadData</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>loadData</span> <span class=o>=</span> <span class=n>getLoadData</span><span class=p>();</span>
<a id=__codelineno-57-6 name=__codelineno-57-6></a><a href=#__codelineno-57-6><span class=linenos data-linenos=" 6 "></span></a>   <span class=c1>//noinspection ForLoopReplaceableByForEach to improve perf</span>
<a id=__codelineno-57-7 name=__codelineno-57-7></a><a href=#__codelineno-57-7><span class=linenos data-linenos=" 7 "></span></a>   <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>size</span> <span class=o>=</span> <span class=n>loadData</span><span class=p>.</span><span class=na>size</span><span class=p>();</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>size</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-57-8 name=__codelineno-57-8></a><a href=#__codelineno-57-8><span class=linenos data-linenos=" 8 "></span></a>     <span class=n>LoadData</span><span class=o>&lt;?&gt;</span> <span class=n>data</span> <span class=o>=</span> <span class=n>loadData</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
<a id=__codelineno-57-9 name=__codelineno-57-9></a><a href=#__codelineno-57-9><span class=linenos data-linenos=" 9 "></span></a>     <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>cacheKeys</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>data</span><span class=p>.</span><span class=na>sourceKey</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-57-10 name=__codelineno-57-10></a><a href=#__codelineno-57-10><span class=linenos data-linenos="10 "></span></a>       <span class=n>cacheKeys</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>data</span><span class=p>.</span><span class=na>sourceKey</span><span class=p>);</span>
<a id=__codelineno-57-11 name=__codelineno-57-11></a><a href=#__codelineno-57-11><span class=linenos data-linenos="11 "></span></a>     <span class=p>}</span>
<a id=__codelineno-57-12 name=__codelineno-57-12></a><a href=#__codelineno-57-12><span class=linenos data-linenos="12 "></span></a>     <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>j</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>j</span> <span class=o>&lt;</span> <span class=n>data</span><span class=p>.</span><span class=na>alternateKeys</span><span class=p>.</span><span class=na>size</span><span class=p>();</span> <span class=n>j</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-57-13 name=__codelineno-57-13></a><a href=#__codelineno-57-13><span class=linenos data-linenos="13 "></span></a>       <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>cacheKeys</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>data</span><span class=p>.</span><span class=na>alternateKeys</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>j</span><span class=p>)))</span> <span class=p>{</span>
<a id=__codelineno-57-14 name=__codelineno-57-14></a><a href=#__codelineno-57-14><span class=linenos data-linenos="14 "></span></a>         <span class=n>cacheKeys</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>data</span><span class=p>.</span><span class=na>alternateKeys</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>j</span><span class=p>));</span>
<a id=__codelineno-57-15 name=__codelineno-57-15></a><a href=#__codelineno-57-15><span class=linenos data-linenos="15 "></span></a>       <span class=p>}</span>
<a id=__codelineno-57-16 name=__codelineno-57-16></a><a href=#__codelineno-57-16><span class=linenos data-linenos="16 "></span></a>     <span class=p>}</span>
<a id=__codelineno-57-17 name=__codelineno-57-17></a><a href=#__codelineno-57-17><span class=linenos data-linenos="17 "></span></a>   <span class=p>}</span>
<a id=__codelineno-57-18 name=__codelineno-57-18></a><a href=#__codelineno-57-18><span class=linenos data-linenos="18 "></span></a> <span class=p>}</span>
<a id=__codelineno-57-19 name=__codelineno-57-19></a><a href=#__codelineno-57-19><span class=linenos data-linenos="19 "></span></a> <span class=k>return</span> <span class=n>cacheKeys</span><span class=p>;</span>
<a id=__codelineno-57-20 name=__codelineno-57-20></a><a href=#__codelineno-57-20><span class=linenos data-linenos="20 "></span></a><span class=p>}</span>
</code></pre></div> <p>å¾ˆæ˜¾ç„¶ï¼Œè¿”å›çš„listä¸­åªæœ‰ä¸€ä¸ªkeyï¼šä¸Šé¢çš„<code>LoadData</code>çš„<code>sourceKey</code>ï¼Œå³<code>GlideUrl</code>ã€‚</p> <h4 id=362-dhgetregisteredresourceclasses>3.6.2 DH.getRegisteredResourceClasses<a class=headerlink href=#362-dhgetregisteredresourceclasses title="Anchor link to this section for reference">&para;</a></h4> <p>æ¥ç€è¿”å›åˆ°ä¸Šä¸€ä¸ªæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯æœ¬å°èŠ‚çš„ç¬¬ä¸€ä¸ªæ–¹æ³•<code>ResourceCacheGenerator.startNext</code>ä¸­ã€‚<br> æ¥ä¸‹æ¥è¦æ‰§è¡Œçš„ä»£ç æ˜¯ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-58-1 name=__codelineno-58-1></a><a href=#__codelineno-58-1><span class=linenos data-linenos="1 "></span></a><span class=c1>// ResourceCacheGenerator.startNext</span>
<a id=__codelineno-58-2 name=__codelineno-58-2></a><a href=#__codelineno-58-2><span class=linenos data-linenos="2 "></span></a><span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>resourceClasses</span> <span class=o>=</span> <span class=n>helper</span><span class=p>.</span><span class=na>getRegisteredResourceClasses</span><span class=p>();</span>
<a id=__codelineno-58-3 name=__codelineno-58-3></a><a href=#__codelineno-58-3><span class=linenos data-linenos="3 "></span></a>
<a id=__codelineno-58-4 name=__codelineno-58-4></a><a href=#__codelineno-58-4><span class=linenos data-linenos="4 "></span></a><span class=c1>// DecodeHelper</span>
<a id=__codelineno-58-5 name=__codelineno-58-5></a><a href=#__codelineno-58-5><span class=linenos data-linenos="5 "></span></a><span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>getRegisteredResourceClasses</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-58-6 name=__codelineno-58-6></a><a href=#__codelineno-58-6><span class=linenos data-linenos="6 "></span></a> <span class=k>return</span> <span class=n>glideContext</span><span class=p>.</span><span class=na>getRegistry</span><span class=p>()</span>
<a id=__codelineno-58-7 name=__codelineno-58-7></a><a href=#__codelineno-58-7><span class=linenos data-linenos="7 "></span></a>     <span class=p>.</span><span class=na>getRegisteredResourceClasses</span><span class=p>(</span><span class=n>model</span><span class=p>.</span><span class=na>getClass</span><span class=p>(),</span> <span class=n>resourceClass</span><span class=p>,</span> <span class=n>transcodeClass</span><span class=p>);</span>
<a id=__codelineno-58-8 name=__codelineno-58-8></a><a href=#__codelineno-58-8><span class=linenos data-linenos="8 "></span></a><span class=p>}</span>
</code></pre></div> <p>è¿™é‡Œåˆå›åˆ°äº†<code>Registry</code>ç±»ä¸­ï¼Œå¤´ç–¼ã€‚ä½†è¿˜æ˜¯è¦åˆ†æã€‚</p> <div class=highlight><pre><span></span><code><a id=__codelineno-59-1 name=__codelineno-59-1></a><a href=#__codelineno-59-1><span class=linenos data-linenos=" 1 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-59-2 name=__codelineno-59-2></a><a href=#__codelineno-59-2><span class=linenos data-linenos=" 2 "></span></a><span class=kd>public</span> <span class=o>&lt;</span><span class=n>Model</span><span class=p>,</span> <span class=n>TResource</span><span class=p>,</span> <span class=n>Transcode</span><span class=o>&gt;</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>getRegisteredResourceClasses</span><span class=p>(</span>
<a id=__codelineno-59-3 name=__codelineno-59-3></a><a href=#__codelineno-59-3><span class=linenos data-linenos=" 3 "></span></a>   <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Model</span><span class=o>&gt;</span> <span class=n>modelClass</span><span class=p>,</span>
<a id=__codelineno-59-4 name=__codelineno-59-4></a><a href=#__codelineno-59-4><span class=linenos data-linenos=" 4 "></span></a>   <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>TResource</span><span class=o>&gt;</span> <span class=n>resourceClass</span><span class=p>,</span>
<a id=__codelineno-59-5 name=__codelineno-59-5></a><a href=#__codelineno-59-5><span class=linenos data-linenos=" 5 "></span></a>   <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Transcode</span><span class=o>&gt;</span> <span class=n>transcodeClass</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-59-6 name=__codelineno-59-6></a><a href=#__codelineno-59-6><span class=linenos data-linenos=" 6 "></span></a> <span class=c1>// modelClass = String.class</span>
<a id=__codelineno-59-7 name=__codelineno-59-7></a><a href=#__codelineno-59-7><span class=linenos data-linenos=" 7 "></span></a> <span class=c1>// resourceClass é»˜è®¤ä¸º Object.class</span>
<a id=__codelineno-59-8 name=__codelineno-59-8></a><a href=#__codelineno-59-8><span class=linenos data-linenos=" 8 "></span></a> <span class=c1>// transcodeClass = Drawable.class</span>
<a id=__codelineno-59-9 name=__codelineno-59-9></a><a href=#__codelineno-59-9><span class=linenos data-linenos=" 9 "></span></a> <span class=c1>//</span>
<a id=__codelineno-59-10 name=__codelineno-59-10></a><a href=#__codelineno-59-10><span class=linenos data-linenos="10 "></span></a> <span class=c1>// é¦–å…ˆå–ç¼“å­˜</span>
<a id=__codelineno-59-11 name=__codelineno-59-11></a><a href=#__codelineno-59-11><span class=linenos data-linenos="11 "></span></a> <span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>result</span> <span class=o>=</span>
<a id=__codelineno-59-12 name=__codelineno-59-12></a><a href=#__codelineno-59-12><span class=linenos data-linenos="12 "></span></a>     <span class=n>modelToResourceClassCache</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>modelClass</span><span class=p>,</span> <span class=n>resourceClass</span><span class=p>,</span> <span class=n>transcodeClass</span><span class=p>);</span>
<a id=__codelineno-59-13 name=__codelineno-59-13></a><a href=#__codelineno-59-13><span class=linenos data-linenos="13 "></span></a>
<a id=__codelineno-59-14 name=__codelineno-59-14></a><a href=#__codelineno-59-14><span class=linenos data-linenos="14 "></span></a> <span class=c1>// æœ‰ç¼“å­˜å°±è¿”å›ç¼“å­˜ï¼Œæ²¡æœ‰å°±åŠ è½½ï¼Œç„¶åæ”¾å…¥ç¼“å­˜</span>
<a id=__codelineno-59-15 name=__codelineno-59-15></a><a href=#__codelineno-59-15><span class=linenos data-linenos="15 "></span></a> <span class=k>if</span> <span class=p>(</span><span class=n>result</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-59-16 name=__codelineno-59-16></a><a href=#__codelineno-59-16><span class=linenos data-linenos="16 "></span></a>   <span class=n>result</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span>
<a id=__codelineno-59-17 name=__codelineno-59-17></a><a href=#__codelineno-59-17><span class=linenos data-linenos="17 "></span></a>   <span class=c1>// ä»modelLoaderRegistryä¸­å¯»æ‰¾æ‰€æœ‰modelClassä¸ºStringæˆ–çˆ¶ç±»çš„entryï¼Œå¹¶è¿”å›å…¶dataClass</span>
<a id=__codelineno-59-18 name=__codelineno-59-18></a><a href=#__codelineno-59-18><span class=linenos data-linenos="18 "></span></a>   <span class=c1>// æ­¤å¤„å¾—åˆ°çš„dataClassesä¸º[InputStream.class, ParcelFileDescriptor.class, AssetFileDescriptor.class]  </span>
<a id=__codelineno-59-19 name=__codelineno-59-19></a><a href=#__codelineno-59-19><span class=linenos data-linenos="19 "></span></a>   <span class=c1>// å› ä¸ºå››ä¸ªæ³¨å†Œé¡¹ä¸­ï¼Œå‰ä¸¤ä¸ªdataClasséƒ½ä¸ºInputStream.classï¼Œå»é‡æ—¶è‚¯å®šä¼šå»æ‰ä¸€ä¸ª</span>
<a id=__codelineno-59-20 name=__codelineno-59-20></a><a href=#__codelineno-59-20><span class=linenos data-linenos="20 "></span></a>   <span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>dataClasses</span> <span class=o>=</span> <span class=n>modelLoaderRegistry</span><span class=p>.</span><span class=na>getDataClasses</span><span class=p>(</span><span class=n>modelClass</span><span class=p>);</span>
<a id=__codelineno-59-21 name=__codelineno-59-21></a><a href=#__codelineno-59-21><span class=linenos data-linenos="21 "></span></a>   <span class=k>for</span> <span class=p>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>dataClass</span> <span class=p>:</span> <span class=n>dataClasses</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-59-22 name=__codelineno-59-22></a><a href=#__codelineno-59-22><span class=linenos data-linenos="22 "></span></a>       <span class=c1>// ğŸ”¥ğŸ”¥ğŸ”¥ çœ‹ä¸æ‡‚äº†ï¼Œå…ˆçœ‹çœ‹å¯¹åº”çš„ResourceDecoderRegistryæ•°æ®ç»“æ„å§</span>
<a id=__codelineno-59-23 name=__codelineno-59-23></a><a href=#__codelineno-59-23><span class=linenos data-linenos="23 "></span></a>       <span class=n>List</span><span class=o>&lt;?</span> <span class=kd>extends</span> <span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>registeredResourceClasses</span> <span class=o>=</span>
<a id=__codelineno-59-24 name=__codelineno-59-24></a><a href=#__codelineno-59-24><span class=linenos data-linenos="24 "></span></a>           <span class=n>decoderRegistry</span><span class=p>.</span><span class=na>getResourceClasses</span><span class=p>(</span><span class=n>dataClass</span><span class=p>,</span> <span class=n>resourceClass</span><span class=p>);</span>
<a id=__codelineno-59-25 name=__codelineno-59-25></a><a href=#__codelineno-59-25><span class=linenos data-linenos="25 "></span></a>       <span class=k>for</span> <span class=p>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>registeredResourceClass</span> <span class=p>:</span> <span class=n>registeredResourceClasses</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-59-26 name=__codelineno-59-26></a><a href=#__codelineno-59-26><span class=linenos data-linenos="26 "></span></a>         <span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Transcode</span><span class=o>&gt;&gt;</span> <span class=n>registeredTranscodeClasses</span> <span class=o>=</span> <span class=n>transcoderRegistry</span>
<a id=__codelineno-59-27 name=__codelineno-59-27></a><a href=#__codelineno-59-27><span class=linenos data-linenos="27 "></span></a>             <span class=p>.</span><span class=na>getTranscodeClasses</span><span class=p>(</span><span class=n>registeredResourceClass</span><span class=p>,</span> <span class=n>transcodeClass</span><span class=p>);</span>
<a id=__codelineno-59-28 name=__codelineno-59-28></a><a href=#__codelineno-59-28><span class=linenos data-linenos="28 "></span></a>         <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>registeredTranscodeClasses</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>()</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>result</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>registeredResourceClass</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-59-29 name=__codelineno-59-29></a><a href=#__codelineno-59-29><span class=linenos data-linenos="29 "></span></a>           <span class=n>result</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>registeredResourceClass</span><span class=p>);</span>
<a id=__codelineno-59-30 name=__codelineno-59-30></a><a href=#__codelineno-59-30><span class=linenos data-linenos="30 "></span></a>         <span class=p>}</span>
<a id=__codelineno-59-31 name=__codelineno-59-31></a><a href=#__codelineno-59-31><span class=linenos data-linenos="31 "></span></a>       <span class=p>}</span>
<a id=__codelineno-59-32 name=__codelineno-59-32></a><a href=#__codelineno-59-32><span class=linenos data-linenos="32 "></span></a>     <span class=p>}</span>
<a id=__codelineno-59-33 name=__codelineno-59-33></a><a href=#__codelineno-59-33><span class=linenos data-linenos="33 "></span></a>   <span class=n>modelToResourceClassCache</span><span class=p>.</span><span class=na>put</span><span class=p>(</span>
<a id=__codelineno-59-34 name=__codelineno-59-34></a><a href=#__codelineno-59-34><span class=linenos data-linenos="34 "></span></a>       <span class=n>modelClass</span><span class=p>,</span> <span class=n>resourceClass</span><span class=p>,</span> <span class=n>transcodeClass</span><span class=p>,</span> <span class=n>Collections</span><span class=p>.</span><span class=na>unmodifiableList</span><span class=p>(</span><span class=n>result</span><span class=p>));</span>
<a id=__codelineno-59-35 name=__codelineno-59-35></a><a href=#__codelineno-59-35><span class=linenos data-linenos="35 "></span></a> <span class=p>}</span>
<a id=__codelineno-59-36 name=__codelineno-59-36></a><a href=#__codelineno-59-36><span class=linenos data-linenos="36 "></span></a>
<a id=__codelineno-59-37 name=__codelineno-59-37></a><a href=#__codelineno-59-37><span class=linenos data-linenos="37 "></span></a> <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
<a id=__codelineno-59-38 name=__codelineno-59-38></a><a href=#__codelineno-59-38><span class=linenos data-linenos="38 "></span></a><span class=p>}</span>
</code></pre></div> <p>ğŸ”¥ğŸ”¥ğŸ”¥ è·å–å®ŒdataClassesåï¼Œä¸‹é¢è¦å¯¹æ¯ä¸€ä¸ªdataClassè°ƒç”¨<code>decoderRegistry.getResourceClasses</code>æ–¹æ³•ã€‚ </p> <p>è¿™é‡Œæ¶‰åŠåˆ°äº†<code>ResourceDecoderRegistry</code>ç±»ï¼ŒåŒæ ·è¯¥ç±»ä¸­çš„æ•°æ®ä¹Ÿæ˜¯Glideåˆ›å»ºæ—¶æ³¨å…¥çš„ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ç›¸å…³çš„ä»£ç ã€‚</p> <div class=highlight><pre><span></span><code><a id=__codelineno-60-1 name=__codelineno-60-1></a><a href=#__codelineno-60-1><span class=linenos data-linenos="  1 "></span></a><span class=c1>// Glide</span>
<a id=__codelineno-60-2 name=__codelineno-60-2></a><a href=#__codelineno-60-2><span class=linenos data-linenos="  2 "></span></a><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>Registry</span><span class=p>.</span><span class=na>BUCKET_BITMAP</span><span class=p>,</span> <span class=n>ByteBuffer</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>Bitmap</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>byteBufferBitmapDecoder</span><span class=p>)</span>
<a id=__codelineno-60-3 name=__codelineno-60-3></a><a href=#__codelineno-60-3><span class=linenos data-linenos="  3 "></span></a><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>Registry</span><span class=p>.</span><span class=na>BUCKET_BITMAP</span><span class=p>,</span> <span class=n>InputStream</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>Bitmap</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>streamBitmapDecoder</span><span class=p>)</span>
<a id=__codelineno-60-4 name=__codelineno-60-4></a><a href=#__codelineno-60-4><span class=linenos data-linenos="  4 "></span></a><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>Registry</span><span class=p>.</span><span class=na>BUCKET_BITMAP</span><span class=p>,</span> <span class=n>ParcelFileDescriptor</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>Bitmap</span><span class=p>.</span><span class=na>class</span><span class=p>,</span>
<a id=__codelineno-60-5 name=__codelineno-60-5></a><a href=#__codelineno-60-5><span class=linenos data-linenos="  5 "></span></a><span class=n>parcelFileDescriptorVideoDecoder</span><span class=p>)</span>
<a id=__codelineno-60-6 name=__codelineno-60-6></a><a href=#__codelineno-60-6><span class=linenos data-linenos="  6 "></span></a><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>Registry</span><span class=p>.</span><span class=na>BUCKET_BITMAP</span><span class=p>,</span> <span class=n>AssetFileDescriptor</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>Bitmap</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>VideoDecoder</span><span class=p>.</span><span class=na>asset</span><span class=p>(</span><span class=n>bitmapPool</span><span class=p>))</span>
<a id=__codelineno-60-7 name=__codelineno-60-7></a><a href=#__codelineno-60-7><span class=linenos data-linenos="  7 "></span></a><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>Registry</span><span class=p>.</span><span class=na>BUCKET_BITMAP</span><span class=p>,</span> <span class=n>Bitmap</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>Bitmap</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=k>new</span> <span class=n>UnitBitmapDecoder</span><span class=p>())</span>
<a id=__codelineno-60-8 name=__codelineno-60-8></a><a href=#__codelineno-60-8><span class=linenos data-linenos="  8 "></span></a><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>Registry</span><span class=p>.</span><span class=na>BUCKET_BITMAP_DRAWABLE</span><span class=p>,</span> <span class=n>ByteBuffer</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>BitmapDrawable</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=k>new</span> <span class=n>BitmapDrawableDecoder</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>resources</span><span class=p>,</span> <span class=n>byteBufferBitmapDecoder</span><span class=p>))</span>
<a id=__codelineno-60-9 name=__codelineno-60-9></a><a href=#__codelineno-60-9><span class=linenos data-linenos="  9 "></span></a><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>Registry</span><span class=p>.</span><span class=na>BUCKET_BITMAP_DRAWABLE</span><span class=p>,</span> <span class=n>InputStream</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>BitmapDrawable</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=k>new</span> <span class=n>BitmapDrawableDecoder</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>resources</span><span class=p>,</span> <span class=n>streamBitmapDecoder</span><span class=p>))</span>
<a id=__codelineno-60-10 name=__codelineno-60-10></a><a href=#__codelineno-60-10><span class=linenos data-linenos=" 10 "></span></a><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>Registry</span><span class=p>.</span><span class=na>BUCKET_BITMAP_DRAWABLE</span><span class=p>,</span> <span class=n>ParcelFileDescriptor</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>BitmapDrawable</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=k>new</span> <span class=n>BitmapDrawableDecoder</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>resources</span><span class=p>,</span> <span class=n>parcelFileDescriptorVideoDecoder</span><span class=p>))</span>
<a id=__codelineno-60-11 name=__codelineno-60-11></a><a href=#__codelineno-60-11><span class=linenos data-linenos=" 11 "></span></a><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>Registry</span><span class=p>.</span><span class=na>BUCKET_GIF</span><span class=p>,</span> <span class=n>InputStream</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>GifDrawable</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=k>new</span> <span class=n>StreamGifDecoder</span><span class=p>(</span><span class=n>imageHeaderParsers</span><span class=p>,</span> <span class=n>byteBufferGifDecoder</span><span class=p>,</span> <span class=n>arrayPool</span><span class=p>))</span>
<a id=__codelineno-60-12 name=__codelineno-60-12></a><a href=#__codelineno-60-12><span class=linenos data-linenos=" 12 "></span></a><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>Registry</span><span class=p>.</span><span class=na>BUCKET_GIF</span><span class=p>,</span> <span class=n>ByteBuffer</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>GifDrawable</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>byteBufferGifDecoder</span><span class=p>)</span>
<a id=__codelineno-60-13 name=__codelineno-60-13></a><a href=#__codelineno-60-13><span class=linenos data-linenos=" 13 "></span></a><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>Registry</span><span class=p>.</span><span class=na>BUCKET_BITMAP</span><span class=p>,</span> <span class=n>GifDecoder</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>Bitmap</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=k>new</span> <span class=n>GifFrameResourceDecoder</span><span class=p>(</span><span class=n>bitmapPool</span><span class=p>))</span>
<a id=__codelineno-60-14 name=__codelineno-60-14></a><a href=#__codelineno-60-14><span class=linenos data-linenos=" 14 "></span></a><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>Uri</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>Drawable</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>resourceDrawableDecoder</span><span class=p>)</span>
<a id=__codelineno-60-15 name=__codelineno-60-15></a><a href=#__codelineno-60-15><span class=linenos data-linenos=" 15 "></span></a><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>Uri</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>Bitmap</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=k>new</span> <span class=n>ResourceBitmapDecoder</span><span class=p>(</span><span class=n>resourceDrawableDecoder</span><span class=p>,</span> <span class=n>bitmapPool</span><span class=p>))</span>
<a id=__codelineno-60-16 name=__codelineno-60-16></a><a href=#__codelineno-60-16><span class=linenos data-linenos=" 16 "></span></a><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>File</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>File</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=k>new</span> <span class=n>FileDecoder</span><span class=p>())</span>
<a id=__codelineno-60-17 name=__codelineno-60-17></a><a href=#__codelineno-60-17><span class=linenos data-linenos=" 17 "></span></a><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>Drawable</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>Drawable</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=k>new</span> <span class=n>UnitDrawableDecoder</span><span class=p>())</span>
<a id=__codelineno-60-18 name=__codelineno-60-18></a><a href=#__codelineno-60-18><span class=linenos data-linenos=" 18 "></span></a>
<a id=__codelineno-60-19 name=__codelineno-60-19></a><a href=#__codelineno-60-19><span class=linenos data-linenos=" 19 "></span></a><span class=c1>// Registry</span>
<a id=__codelineno-60-20 name=__codelineno-60-20></a><a href=#__codelineno-60-20><span class=linenos data-linenos=" 20 "></span></a><span class=kd>public</span> <span class=kd>class</span> <span class=nc>Registry</span> <span class=p>{</span>
<a id=__codelineno-60-21 name=__codelineno-60-21></a><a href=#__codelineno-60-21><span class=linenos data-linenos=" 21 "></span></a> <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>BUCKET_GIF</span> <span class=o>=</span> <span class=s>&quot;Gif&quot;</span><span class=p>;</span>
<a id=__codelineno-60-22 name=__codelineno-60-22></a><a href=#__codelineno-60-22><span class=linenos data-linenos=" 22 "></span></a> <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>BUCKET_BITMAP</span> <span class=o>=</span> <span class=s>&quot;Bitmap&quot;</span><span class=p>;</span>
<a id=__codelineno-60-23 name=__codelineno-60-23></a><a href=#__codelineno-60-23><span class=linenos data-linenos=" 23 "></span></a> <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>BUCKET_BITMAP_DRAWABLE</span> <span class=o>=</span> <span class=s>&quot;BitmapDrawable&quot;</span><span class=p>;</span>
<a id=__codelineno-60-24 name=__codelineno-60-24></a><a href=#__codelineno-60-24><span class=linenos data-linenos=" 24 "></span></a> <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>BUCKET_PREPEND_ALL</span> <span class=o>=</span> <span class=s>&quot;legacy_prepend_all&quot;</span><span class=p>;</span>
<a id=__codelineno-60-25 name=__codelineno-60-25></a><a href=#__codelineno-60-25><span class=linenos data-linenos=" 25 "></span></a> <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>BUCKET_APPEND_ALL</span> <span class=o>=</span> <span class=s>&quot;legacy_append&quot;</span><span class=p>;</span>
<a id=__codelineno-60-26 name=__codelineno-60-26></a><a href=#__codelineno-60-26><span class=linenos data-linenos=" 26 "></span></a>
<a id=__codelineno-60-27 name=__codelineno-60-27></a><a href=#__codelineno-60-27><span class=linenos data-linenos=" 27 "></span></a> <span class=kd>private</span> <span class=kd>final</span> <span class=n>ResourceDecoderRegistry</span> <span class=n>decoderRegistry</span><span class=p>;</span>
<a id=__codelineno-60-28 name=__codelineno-60-28></a><a href=#__codelineno-60-28><span class=linenos data-linenos=" 28 "></span></a>
<a id=__codelineno-60-29 name=__codelineno-60-29></a><a href=#__codelineno-60-29><span class=linenos data-linenos=" 29 "></span></a> <span class=kd>public</span> <span class=nf>Registry</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-60-30 name=__codelineno-60-30></a><a href=#__codelineno-60-30><span class=linenos data-linenos=" 30 "></span></a>   <span class=k>this</span><span class=p>.</span><span class=na>decoderRegistry</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ResourceDecoderRegistry</span><span class=p>();</span>
<a id=__codelineno-60-31 name=__codelineno-60-31></a><a href=#__codelineno-60-31><span class=linenos data-linenos=" 31 "></span></a>   <span class=n>setResourceDecoderBucketPriorityList</span><span class=p>(</span>
<a id=__codelineno-60-32 name=__codelineno-60-32></a><a href=#__codelineno-60-32><span class=linenos data-linenos=" 32 "></span></a>       <span class=n>Arrays</span><span class=p>.</span><span class=na>asList</span><span class=p>(</span><span class=n>BUCKET_GIF</span><span class=p>,</span> <span class=n>BUCKET_BITMAP</span><span class=p>,</span> <span class=n>BUCKET_BITMAP_DRAWABLE</span><span class=p>));</span>
<a id=__codelineno-60-33 name=__codelineno-60-33></a><a href=#__codelineno-60-33><span class=linenos data-linenos=" 33 "></span></a> <span class=p>}</span>
<a id=__codelineno-60-34 name=__codelineno-60-34></a><a href=#__codelineno-60-34><span class=linenos data-linenos=" 34 "></span></a>
<a id=__codelineno-60-35 name=__codelineno-60-35></a><a href=#__codelineno-60-35><span class=linenos data-linenos=" 35 "></span></a> <span class=nd>@NonNull</span>
<a id=__codelineno-60-36 name=__codelineno-60-36></a><a href=#__codelineno-60-36><span class=linenos data-linenos=" 36 "></span></a> <span class=kd>public</span> <span class=kd>final</span> <span class=n>Registry</span> <span class=nf>setResourceDecoderBucketPriorityList</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>buckets</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-60-37 name=__codelineno-60-37></a><a href=#__codelineno-60-37><span class=linenos data-linenos=" 37 "></span></a>   <span class=c1>// See #3296 and https://bugs.openjdk.java.net/browse/JDK-6260652.</span>
<a id=__codelineno-60-38 name=__codelineno-60-38></a><a href=#__codelineno-60-38><span class=linenos data-linenos=" 38 "></span></a>   <span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>modifiedBuckets</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>buckets</span><span class=p>.</span><span class=na>size</span><span class=p>());</span>
<a id=__codelineno-60-39 name=__codelineno-60-39></a><a href=#__codelineno-60-39><span class=linenos data-linenos=" 39 "></span></a>   <span class=n>modifiedBuckets</span><span class=p>.</span><span class=na>addAll</span><span class=p>(</span><span class=n>buckets</span><span class=p>);</span>
<a id=__codelineno-60-40 name=__codelineno-60-40></a><a href=#__codelineno-60-40><span class=linenos data-linenos=" 40 "></span></a>   <span class=n>modifiedBuckets</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>BUCKET_PREPEND_ALL</span><span class=p>);</span>
<a id=__codelineno-60-41 name=__codelineno-60-41></a><a href=#__codelineno-60-41><span class=linenos data-linenos=" 41 "></span></a>   <span class=n>modifiedBuckets</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>BUCKET_APPEND_ALL</span><span class=p>);</span>
<a id=__codelineno-60-42 name=__codelineno-60-42></a><a href=#__codelineno-60-42><span class=linenos data-linenos=" 42 "></span></a>   <span class=n>decoderRegistry</span><span class=p>.</span><span class=na>setBucketPriorityList</span><span class=p>(</span><span class=n>modifiedBuckets</span><span class=p>);</span>
<a id=__codelineno-60-43 name=__codelineno-60-43></a><a href=#__codelineno-60-43><span class=linenos data-linenos=" 43 "></span></a>   <span class=k>return</span> <span class=k>this</span><span class=p>;</span>
<a id=__codelineno-60-44 name=__codelineno-60-44></a><a href=#__codelineno-60-44><span class=linenos data-linenos=" 44 "></span></a> <span class=p>}</span>
<a id=__codelineno-60-45 name=__codelineno-60-45></a><a href=#__codelineno-60-45><span class=linenos data-linenos=" 45 "></span></a>
<a id=__codelineno-60-46 name=__codelineno-60-46></a><a href=#__codelineno-60-46><span class=linenos data-linenos=" 46 "></span></a> <span class=nd>@NonNull</span>
<a id=__codelineno-60-47 name=__codelineno-60-47></a><a href=#__codelineno-60-47><span class=linenos data-linenos=" 47 "></span></a> <span class=kd>public</span> <span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span> <span class=n>TResource</span><span class=o>&gt;</span> <span class=n>Registry</span> <span class=nf>append</span><span class=p>(</span>
<a id=__codelineno-60-48 name=__codelineno-60-48></a><a href=#__codelineno-60-48><span class=linenos data-linenos=" 48 "></span></a>     <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>dataClass</span><span class=p>,</span>
<a id=__codelineno-60-49 name=__codelineno-60-49></a><a href=#__codelineno-60-49><span class=linenos data-linenos=" 49 "></span></a>     <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>TResource</span><span class=o>&gt;</span> <span class=n>resourceClass</span><span class=p>,</span>
<a id=__codelineno-60-50 name=__codelineno-60-50></a><a href=#__codelineno-60-50><span class=linenos data-linenos=" 50 "></span></a>     <span class=nd>@NonNull</span> <span class=n>ResourceDecoder</span><span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span> <span class=n>TResource</span><span class=o>&gt;</span> <span class=n>decoder</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-60-51 name=__codelineno-60-51></a><a href=#__codelineno-60-51><span class=linenos data-linenos=" 51 "></span></a>   <span class=n>append</span><span class=p>(</span><span class=n>BUCKET_APPEND_ALL</span><span class=p>,</span> <span class=n>dataClass</span><span class=p>,</span> <span class=n>resourceClass</span><span class=p>,</span> <span class=n>decoder</span><span class=p>);</span>
<a id=__codelineno-60-52 name=__codelineno-60-52></a><a href=#__codelineno-60-52><span class=linenos data-linenos=" 52 "></span></a>   <span class=k>return</span> <span class=k>this</span><span class=p>;</span>
<a id=__codelineno-60-53 name=__codelineno-60-53></a><a href=#__codelineno-60-53><span class=linenos data-linenos=" 53 "></span></a> <span class=p>}</span>
<a id=__codelineno-60-54 name=__codelineno-60-54></a><a href=#__codelineno-60-54><span class=linenos data-linenos=" 54 "></span></a>
<a id=__codelineno-60-55 name=__codelineno-60-55></a><a href=#__codelineno-60-55><span class=linenos data-linenos=" 55 "></span></a> <span class=nd>@NonNull</span>
<a id=__codelineno-60-56 name=__codelineno-60-56></a><a href=#__codelineno-60-56><span class=linenos data-linenos=" 56 "></span></a> <span class=kd>public</span> <span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span> <span class=n>TResource</span><span class=o>&gt;</span> <span class=n>Registry</span> <span class=nf>append</span><span class=p>(</span>
<a id=__codelineno-60-57 name=__codelineno-60-57></a><a href=#__codelineno-60-57><span class=linenos data-linenos=" 57 "></span></a>     <span class=nd>@NonNull</span> <span class=n>String</span> <span class=n>bucket</span><span class=p>,</span>
<a id=__codelineno-60-58 name=__codelineno-60-58></a><a href=#__codelineno-60-58><span class=linenos data-linenos=" 58 "></span></a>     <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>dataClass</span><span class=p>,</span>
<a id=__codelineno-60-59 name=__codelineno-60-59></a><a href=#__codelineno-60-59><span class=linenos data-linenos=" 59 "></span></a>     <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>TResource</span><span class=o>&gt;</span> <span class=n>resourceClass</span><span class=p>,</span>
<a id=__codelineno-60-60 name=__codelineno-60-60></a><a href=#__codelineno-60-60><span class=linenos data-linenos=" 60 "></span></a>     <span class=nd>@NonNull</span> <span class=n>ResourceDecoder</span><span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span> <span class=n>TResource</span><span class=o>&gt;</span> <span class=n>decoder</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-60-61 name=__codelineno-60-61></a><a href=#__codelineno-60-61><span class=linenos data-linenos=" 61 "></span></a>   <span class=n>decoderRegistry</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>bucket</span><span class=p>,</span> <span class=n>decoder</span><span class=p>,</span> <span class=n>dataClass</span><span class=p>,</span> <span class=n>resourceClass</span><span class=p>);</span>
<a id=__codelineno-60-62 name=__codelineno-60-62></a><a href=#__codelineno-60-62><span class=linenos data-linenos=" 62 "></span></a>   <span class=k>return</span> <span class=k>this</span><span class=p>;</span>
<a id=__codelineno-60-63 name=__codelineno-60-63></a><a href=#__codelineno-60-63><span class=linenos data-linenos=" 63 "></span></a> <span class=p>}</span>
<a id=__codelineno-60-64 name=__codelineno-60-64></a><a href=#__codelineno-60-64><span class=linenos data-linenos=" 64 "></span></a>
<a id=__codelineno-60-65 name=__codelineno-60-65></a><a href=#__codelineno-60-65><span class=linenos data-linenos=" 65 "></span></a> <span class=nd>@NonNull</span>
<a id=__codelineno-60-66 name=__codelineno-60-66></a><a href=#__codelineno-60-66><span class=linenos data-linenos=" 66 "></span></a> <span class=kd>public</span> <span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span> <span class=n>TResource</span><span class=o>&gt;</span> <span class=n>Registry</span> <span class=nf>prepend</span><span class=p>(</span>
<a id=__codelineno-60-67 name=__codelineno-60-67></a><a href=#__codelineno-60-67><span class=linenos data-linenos=" 67 "></span></a>     <span class=nd>@NonNull</span> <span class=n>String</span> <span class=n>bucket</span><span class=p>,</span>
<a id=__codelineno-60-68 name=__codelineno-60-68></a><a href=#__codelineno-60-68><span class=linenos data-linenos=" 68 "></span></a>     <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>dataClass</span><span class=p>,</span>
<a id=__codelineno-60-69 name=__codelineno-60-69></a><a href=#__codelineno-60-69><span class=linenos data-linenos=" 69 "></span></a>     <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>TResource</span><span class=o>&gt;</span> <span class=n>resourceClass</span><span class=p>,</span>
<a id=__codelineno-60-70 name=__codelineno-60-70></a><a href=#__codelineno-60-70><span class=linenos data-linenos=" 70 "></span></a>     <span class=nd>@NonNull</span> <span class=n>ResourceDecoder</span><span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span> <span class=n>TResource</span><span class=o>&gt;</span> <span class=n>decoder</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-60-71 name=__codelineno-60-71></a><a href=#__codelineno-60-71><span class=linenos data-linenos=" 71 "></span></a>   <span class=n>decoderRegistry</span><span class=p>.</span><span class=na>prepend</span><span class=p>(</span><span class=n>bucket</span><span class=p>,</span> <span class=n>decoder</span><span class=p>,</span> <span class=n>dataClass</span><span class=p>,</span> <span class=n>resourceClass</span><span class=p>);</span>
<a id=__codelineno-60-72 name=__codelineno-60-72></a><a href=#__codelineno-60-72><span class=linenos data-linenos=" 72 "></span></a>   <span class=k>return</span> <span class=k>this</span><span class=p>;</span>
<a id=__codelineno-60-73 name=__codelineno-60-73></a><a href=#__codelineno-60-73><span class=linenos data-linenos=" 73 "></span></a> <span class=p>}</span>
<a id=__codelineno-60-74 name=__codelineno-60-74></a><a href=#__codelineno-60-74><span class=linenos data-linenos=" 74 "></span></a><span class=p>}</span>
<a id=__codelineno-60-75 name=__codelineno-60-75></a><a href=#__codelineno-60-75><span class=linenos data-linenos=" 75 "></span></a>
<a id=__codelineno-60-76 name=__codelineno-60-76></a><a href=#__codelineno-60-76><span class=linenos data-linenos=" 76 "></span></a><span class=c1>// ResourceDecoderRegistry</span>
<a id=__codelineno-60-77 name=__codelineno-60-77></a><a href=#__codelineno-60-77><span class=linenos data-linenos=" 77 "></span></a><span class=kd>public</span> <span class=kd>class</span> <span class=nc>ResourceDecoderRegistry</span> <span class=p>{</span>
<a id=__codelineno-60-78 name=__codelineno-60-78></a><a href=#__codelineno-60-78><span class=linenos data-linenos=" 78 "></span></a> <span class=kd>private</span> <span class=kd>final</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>bucketPriorityList</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span>
<a id=__codelineno-60-79 name=__codelineno-60-79></a><a href=#__codelineno-60-79><span class=linenos data-linenos=" 79 "></span></a> <span class=kd>private</span> <span class=kd>final</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Entry</span><span class=o>&lt;?</span><span class=p>,</span> <span class=o>?&gt;&gt;&gt;</span> <span class=n>decoders</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HashMap</span><span class=o>&lt;&gt;</span><span class=p>();</span>
<a id=__codelineno-60-80 name=__codelineno-60-80></a><a href=#__codelineno-60-80><span class=linenos data-linenos=" 80 "></span></a>
<a id=__codelineno-60-81 name=__codelineno-60-81></a><a href=#__codelineno-60-81><span class=linenos data-linenos=" 81 "></span></a> <span class=kd>public</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>setBucketPriorityList</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>buckets</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-60-82 name=__codelineno-60-82></a><a href=#__codelineno-60-82><span class=linenos data-linenos=" 82 "></span></a>   <span class=n>List</span><span class=o>&lt;</span><span class=n>String</span><span class=o>&gt;</span> <span class=n>previousBuckets</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>bucketPriorityList</span><span class=p>);</span>
<a id=__codelineno-60-83 name=__codelineno-60-83></a><a href=#__codelineno-60-83><span class=linenos data-linenos=" 83 "></span></a>   <span class=n>bucketPriorityList</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span>
<a id=__codelineno-60-84 name=__codelineno-60-84></a><a href=#__codelineno-60-84><span class=linenos data-linenos=" 84 "></span></a>   <span class=n>bucketPriorityList</span><span class=p>.</span><span class=na>addAll</span><span class=p>(</span><span class=n>buckets</span><span class=p>);</span>
<a id=__codelineno-60-85 name=__codelineno-60-85></a><a href=#__codelineno-60-85><span class=linenos data-linenos=" 85 "></span></a>   <span class=k>for</span> <span class=p>(</span><span class=n>String</span> <span class=n>previousBucket</span> <span class=p>:</span> <span class=n>previousBuckets</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-60-86 name=__codelineno-60-86></a><a href=#__codelineno-60-86><span class=linenos data-linenos=" 86 "></span></a>     <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>buckets</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>previousBucket</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-60-87 name=__codelineno-60-87></a><a href=#__codelineno-60-87><span class=linenos data-linenos=" 87 "></span></a>       <span class=c1>// Keep any buckets from the previous list that aren&#39;t included here, but but them at the</span>
<a id=__codelineno-60-88 name=__codelineno-60-88></a><a href=#__codelineno-60-88><span class=linenos data-linenos=" 88 "></span></a>       <span class=c1>// end.</span>
<a id=__codelineno-60-89 name=__codelineno-60-89></a><a href=#__codelineno-60-89><span class=linenos data-linenos=" 89 "></span></a>       <span class=n>bucketPriorityList</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>previousBucket</span><span class=p>);</span>
<a id=__codelineno-60-90 name=__codelineno-60-90></a><a href=#__codelineno-60-90><span class=linenos data-linenos=" 90 "></span></a>     <span class=p>}</span>
<a id=__codelineno-60-91 name=__codelineno-60-91></a><a href=#__codelineno-60-91><span class=linenos data-linenos=" 91 "></span></a>   <span class=p>}</span>
<a id=__codelineno-60-92 name=__codelineno-60-92></a><a href=#__codelineno-60-92><span class=linenos data-linenos=" 92 "></span></a> <span class=p>}</span>
<a id=__codelineno-60-93 name=__codelineno-60-93></a><a href=#__codelineno-60-93><span class=linenos data-linenos=" 93 "></span></a>
<a id=__codelineno-60-94 name=__codelineno-60-94></a><a href=#__codelineno-60-94><span class=linenos data-linenos=" 94 "></span></a> <span class=kd>public</span> <span class=kd>synchronized</span> <span class=o>&lt;</span><span class=n>T</span><span class=p>,</span> <span class=n>R</span><span class=o>&gt;</span> <span class=kt>void</span> <span class=nf>append</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>String</span> <span class=n>bucket</span><span class=p>,</span>
<a id=__codelineno-60-95 name=__codelineno-60-95></a><a href=#__codelineno-60-95><span class=linenos data-linenos=" 95 "></span></a>     <span class=nd>@NonNull</span> <span class=n>ResourceDecoder</span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span> <span class=n>R</span><span class=o>&gt;</span> <span class=n>decoder</span><span class=p>,</span>
<a id=__codelineno-60-96 name=__codelineno-60-96></a><a href=#__codelineno-60-96><span class=linenos data-linenos=" 96 "></span></a>     <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>dataClass</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>resourceClass</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-60-97 name=__codelineno-60-97></a><a href=#__codelineno-60-97><span class=linenos data-linenos=" 97 "></span></a>   <span class=n>getOrAddEntryList</span><span class=p>(</span><span class=n>bucket</span><span class=p>).</span><span class=na>add</span><span class=p>(</span><span class=k>new</span> <span class=n>Entry</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>dataClass</span><span class=p>,</span> <span class=n>resourceClass</span><span class=p>,</span> <span class=n>decoder</span><span class=p>));</span>
<a id=__codelineno-60-98 name=__codelineno-60-98></a><a href=#__codelineno-60-98><span class=linenos data-linenos=" 98 "></span></a> <span class=p>}</span>
<a id=__codelineno-60-99 name=__codelineno-60-99></a><a href=#__codelineno-60-99><span class=linenos data-linenos=" 99 "></span></a>
<a id=__codelineno-60-100 name=__codelineno-60-100></a><a href=#__codelineno-60-100><span class=linenos data-linenos="100 "></span></a> <span class=kd>public</span> <span class=kd>synchronized</span> <span class=o>&lt;</span><span class=n>T</span><span class=p>,</span> <span class=n>R</span><span class=o>&gt;</span> <span class=kt>void</span> <span class=nf>prepend</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>String</span> <span class=n>bucket</span><span class=p>,</span>
<a id=__codelineno-60-101 name=__codelineno-60-101></a><a href=#__codelineno-60-101><span class=linenos data-linenos="101 "></span></a>     <span class=nd>@NonNull</span> <span class=n>ResourceDecoder</span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span> <span class=n>R</span><span class=o>&gt;</span> <span class=n>decoder</span><span class=p>,</span>
<a id=__codelineno-60-102 name=__codelineno-60-102></a><a href=#__codelineno-60-102><span class=linenos data-linenos="102 "></span></a>     <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>dataClass</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>resourceClass</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-60-103 name=__codelineno-60-103></a><a href=#__codelineno-60-103><span class=linenos data-linenos="103 "></span></a>   <span class=n>getOrAddEntryList</span><span class=p>(</span><span class=n>bucket</span><span class=p>).</span><span class=na>add</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=k>new</span> <span class=n>Entry</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>dataClass</span><span class=p>,</span> <span class=n>resourceClass</span><span class=p>,</span> <span class=n>decoder</span><span class=p>));</span>
<a id=__codelineno-60-104 name=__codelineno-60-104></a><a href=#__codelineno-60-104><span class=linenos data-linenos="104 "></span></a> <span class=p>}</span>
<a id=__codelineno-60-105 name=__codelineno-60-105></a><a href=#__codelineno-60-105><span class=linenos data-linenos="105 "></span></a>
<a id=__codelineno-60-106 name=__codelineno-60-106></a><a href=#__codelineno-60-106><span class=linenos data-linenos="106 "></span></a> <span class=nd>@NonNull</span>
<a id=__codelineno-60-107 name=__codelineno-60-107></a><a href=#__codelineno-60-107><span class=linenos data-linenos="107 "></span></a> <span class=kd>private</span> <span class=kd>synchronized</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Entry</span><span class=o>&lt;?</span><span class=p>,</span> <span class=o>?&gt;&gt;</span> <span class=n>getOrAddEntryList</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>String</span> <span class=n>bucket</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-60-108 name=__codelineno-60-108></a><a href=#__codelineno-60-108><span class=linenos data-linenos="108 "></span></a>   <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>bucketPriorityList</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>bucket</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-60-109 name=__codelineno-60-109></a><a href=#__codelineno-60-109><span class=linenos data-linenos="109 "></span></a>     <span class=c1>// Add this unspecified bucket as a low priority bucket.</span>
<a id=__codelineno-60-110 name=__codelineno-60-110></a><a href=#__codelineno-60-110><span class=linenos data-linenos="110 "></span></a>     <span class=n>bucketPriorityList</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>bucket</span><span class=p>);</span>
<a id=__codelineno-60-111 name=__codelineno-60-111></a><a href=#__codelineno-60-111><span class=linenos data-linenos="111 "></span></a>   <span class=p>}</span>
<a id=__codelineno-60-112 name=__codelineno-60-112></a><a href=#__codelineno-60-112><span class=linenos data-linenos="112 "></span></a>   <span class=n>List</span><span class=o>&lt;</span><span class=n>Entry</span><span class=o>&lt;?</span><span class=p>,</span> <span class=o>?&gt;&gt;</span> <span class=n>entries</span> <span class=o>=</span> <span class=n>decoders</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>bucket</span><span class=p>);</span>
<a id=__codelineno-60-113 name=__codelineno-60-113></a><a href=#__codelineno-60-113><span class=linenos data-linenos="113 "></span></a>   <span class=k>if</span> <span class=p>(</span><span class=n>entries</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-60-114 name=__codelineno-60-114></a><a href=#__codelineno-60-114><span class=linenos data-linenos="114 "></span></a>     <span class=n>entries</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span>
<a id=__codelineno-60-115 name=__codelineno-60-115></a><a href=#__codelineno-60-115><span class=linenos data-linenos="115 "></span></a>     <span class=n>decoders</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>bucket</span><span class=p>,</span> <span class=n>entries</span><span class=p>);</span>
<a id=__codelineno-60-116 name=__codelineno-60-116></a><a href=#__codelineno-60-116><span class=linenos data-linenos="116 "></span></a>   <span class=p>}</span>
<a id=__codelineno-60-117 name=__codelineno-60-117></a><a href=#__codelineno-60-117><span class=linenos data-linenos="117 "></span></a>   <span class=k>return</span> <span class=n>entries</span><span class=p>;</span>
<a id=__codelineno-60-118 name=__codelineno-60-118></a><a href=#__codelineno-60-118><span class=linenos data-linenos="118 "></span></a> <span class=p>}</span>
<a id=__codelineno-60-119 name=__codelineno-60-119></a><a href=#__codelineno-60-119><span class=linenos data-linenos="119 "></span></a><span class=p>}</span>
</code></pre></div> <p><code>ResourceDecoderRegistry</code>å†…éƒ¨ç»´æŒç€ä¸€ä¸ªå…·æœ‰ä¼˜å…ˆçº§ bucket çš„ listï¼Œä¼˜å…ˆçº§é¡ºåºç”±BUCKETåœ¨<code>bucketPriorityList</code>ä¸­çš„é¡ºåºå†³å®šã€‚<br> åœ¨<code>Registry</code>çš„æ„é€ å™¨ä¸­ï¼Œåˆ›å»º<code>ResourceDecoderRegistry</code>åï¼Œå°±è°ƒç”¨<code>setResourceDecoderBucketPriorityList</code>æ–¹æ³•è°ƒæ•´äº†å…¶ä¼˜å…ˆçº§ï¼Œä¼˜å…ˆçº§åˆ«ä¸ºï¼š<br> BUCKET_PREPEND_ALL, BUCKET_GIF, BUCKET_BITMAP, BUCKET_BITMAP_DRAWABLE, BUCKET_APPEND_ALLã€‚ </p> <p><code>ResourceDecoderRegistry</code>çš„<code>append</code>æ–¹æ³•å’Œ<code>prepend</code>æ–¹æ³•å°±æ˜¯å‘å¯¹åº”çš„æ¡¶ä¸­å°†entryæ’å…¥åˆ°å°¾éƒ¨æˆ–å¤´éƒ¨ã€‚</p> <p>ä¸‹é¢å°±æ˜¯<code>ResourceDecoderRegistry</code>é‡Œé¢æ•°æ®çš„å›¾ï¼Œdecodersé‡Œé¢çš„æ•°å­—è¡¨ç¤ºçš„Entryä¸ä¸Šé¢æ³¨å†Œä»£ç ä¸­è¡Œæ•°ç›¸å¯¹åº”ï¼š</p> <figure style="width: 66%" class=align-center> <img src=/assets/images/android/glide-resource-decoder-registry-content.png> <figcaption>ResourceDecoderRegistryå†…éƒ¨æ•°æ®æ¨¡å‹</figcaption> </figure> <p>äº†è§£å®Œäº†<code>ResourceDecoderRegistry</code>ä¹‹åï¼Œæˆ‘ä»¬åœ¨å›åˆ°ğŸ”¥ğŸ”¥ğŸ”¥åŸæ¥çš„ä½ç½®ç»§ç»­çœ‹çœ‹<code>decoderRegistry.getResourceClasses</code>æ–¹æ³•å¹²äº†ä»€ä¹ˆï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-61-1 name=__codelineno-61-1></a><a href=#__codelineno-61-1><span class=linenos data-linenos=" 1 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-61-2 name=__codelineno-61-2></a><a href=#__codelineno-61-2><span class=linenos data-linenos=" 2 "></span></a><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;unchecked&quot;</span><span class=p>)</span>
<a id=__codelineno-61-3 name=__codelineno-61-3></a><a href=#__codelineno-61-3><span class=linenos data-linenos=" 3 "></span></a><span class=kd>public</span> <span class=kd>synchronized</span> <span class=o>&lt;</span><span class=n>T</span><span class=p>,</span> <span class=n>R</span><span class=o>&gt;</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;&gt;</span> <span class=nf>getResourceClasses</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>dataClass</span><span class=p>,</span>
<a id=__codelineno-61-4 name=__codelineno-61-4></a><a href=#__codelineno-61-4><span class=linenos data-linenos=" 4 "></span></a>   <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>resourceClass</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-61-5 name=__codelineno-61-5></a><a href=#__codelineno-61-5><span class=linenos data-linenos=" 5 "></span></a> <span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span>
<a id=__codelineno-61-6 name=__codelineno-61-6></a><a href=#__codelineno-61-6><span class=linenos data-linenos=" 6 "></span></a> <span class=k>for</span> <span class=p>(</span><span class=n>String</span> <span class=n>bucket</span> <span class=p>:</span> <span class=n>bucketPriorityList</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-61-7 name=__codelineno-61-7></a><a href=#__codelineno-61-7><span class=linenos data-linenos=" 7 "></span></a>   <span class=n>List</span><span class=o>&lt;</span><span class=n>Entry</span><span class=o>&lt;?</span><span class=p>,</span> <span class=o>?&gt;&gt;</span> <span class=n>entries</span> <span class=o>=</span> <span class=n>decoders</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>bucket</span><span class=p>);</span>
<a id=__codelineno-61-8 name=__codelineno-61-8></a><a href=#__codelineno-61-8><span class=linenos data-linenos=" 8 "></span></a>   <span class=k>if</span> <span class=p>(</span><span class=n>entries</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-61-9 name=__codelineno-61-9></a><a href=#__codelineno-61-9><span class=linenos data-linenos=" 9 "></span></a>     <span class=k>continue</span><span class=p>;</span>
<a id=__codelineno-61-10 name=__codelineno-61-10></a><a href=#__codelineno-61-10><span class=linenos data-linenos="10 "></span></a>   <span class=p>}</span>
<a id=__codelineno-61-11 name=__codelineno-61-11></a><a href=#__codelineno-61-11><span class=linenos data-linenos="11 "></span></a>   <span class=k>for</span> <span class=p>(</span><span class=n>Entry</span><span class=o>&lt;?</span><span class=p>,</span> <span class=o>?&gt;</span> <span class=n>entry</span> <span class=p>:</span> <span class=n>entries</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-61-12 name=__codelineno-61-12></a><a href=#__codelineno-61-12><span class=linenos data-linenos="12 "></span></a>     <span class=k>if</span> <span class=p>(</span><span class=n>entry</span><span class=p>.</span><span class=na>handles</span><span class=p>(</span><span class=n>dataClass</span><span class=p>,</span> <span class=n>resourceClass</span><span class=p>)</span>
<a id=__codelineno-61-13 name=__codelineno-61-13></a><a href=#__codelineno-61-13><span class=linenos data-linenos="13 "></span></a>         <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>result</span><span class=p>.</span><span class=na>contains</span><span class=p>((</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span><span class=p>)</span> <span class=n>entry</span><span class=p>.</span><span class=na>resourceClass</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-61-14 name=__codelineno-61-14></a><a href=#__codelineno-61-14><span class=linenos data-linenos="14 "></span></a>       <span class=n>result</span><span class=p>.</span><span class=na>add</span><span class=p>((</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span><span class=p>)</span> <span class=n>entry</span><span class=p>.</span><span class=na>resourceClass</span><span class=p>);</span>
<a id=__codelineno-61-15 name=__codelineno-61-15></a><a href=#__codelineno-61-15><span class=linenos data-linenos="15 "></span></a>     <span class=p>}</span>
<a id=__codelineno-61-16 name=__codelineno-61-16></a><a href=#__codelineno-61-16><span class=linenos data-linenos="16 "></span></a>   <span class=p>}</span>
<a id=__codelineno-61-17 name=__codelineno-61-17></a><a href=#__codelineno-61-17><span class=linenos data-linenos="17 "></span></a> <span class=p>}</span>
<a id=__codelineno-61-18 name=__codelineno-61-18></a><a href=#__codelineno-61-18><span class=linenos data-linenos="18 "></span></a> <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
<a id=__codelineno-61-19 name=__codelineno-61-19></a><a href=#__codelineno-61-19><span class=linenos data-linenos="19 "></span></a><span class=p>}</span>
</code></pre></div> <p>é‚£ä¹ˆï¼Œè¯¥æ–¹æ³•çš„ä½œç”¨å°±æ˜¯æ ¹æ®ä¼ å…¥çš„dataClassä»¥åŠresourceClassåœ¨æ¡¶ä¸­ä¾æ¬¡æŒ‰é¡ºåºæŸ¥æ‰¾æ˜ å°„å…³ç³»ï¼Œå¦‚æœå¯ä»¥æ‰¾åˆ°å°±è¿”å›è¿™æ¡æ˜ å°„å…³ç³»çš„resourceClassã€‚</p> <p>è¿™é‡Œçš„å…¥å‚<code>dataClass inã€€[InputStream.class, ParcelFileDescriptor.class, AssetFileDescriptor.class]</code>, <code>resourceClass = Object.class</code>ã€‚ </p> <p>ä¸Šé¢çš„æ–¹æ³•ä¼šè¿è¡Œä¸‰æ¬¡ï¼Œæ¯ä¸€æ¬¡çš„ç»“æœå¦‚ä¸‹ï¼š</p> <ol> <li>InputStream.class &amp; Object.class<br> æ³¨å†Œè¡¨ç¬¬11ã€3ã€9è¡Œæ‰€å¯¹åº”çš„resourceClass å³<code>GifDrawable.class</code>ã€<code>Bitmap.class</code>ã€<code>BitmapDrawable.class</code></li> <li>ParcelFileDescriptor.class &amp; Object.class<br> æ³¨å†Œè¡¨ç¬¬4ã€10è¡Œæ‰€å¯¹åº”çš„resourceClass å³<code>Bitmap.class</code>ã€<code>BitmapDrawable.class</code></li> <li>AssetFileDescriptor.class &amp; Object.class<br> æ³¨å†Œè¡¨ç¬¬6è¡Œæ‰€å¯¹åº”çš„resourceClass å³<code>Bitmap.class</code></li> </ol> <p>OKï¼Œç¦»çœ‹å®Œè¿™ä¸ªéƒ¨åˆ†çš„ä»£ç æ›´è¿‘äº†ä¸€æ­¥ï¼Œæˆ‘çš„çœ¼ç›å·²ç»å—ä¸äº†äº†:( </p> <p>å›åˆ°<code>Registry.getRegisteredResourceClasses</code>æ–¹æ³•ä¸­ï¼Œä¸‹é¢å°†ä¼šå¯¹æ¯æ¬¡è¿è¡Œè¿”å›çš„resourceClassesæ•°ç»„è¿›è¡Œéå†ï¼Œå¹¶è°ƒç”¨äº†<code>transcoderRegistry.getTranscodeClasses</code>æ–¹æ³•ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-62-1 name=__codelineno-62-1></a><a href=#__codelineno-62-1><span class=linenos data-linenos=" 1 "></span></a><span class=c1>// Registry.getRegisteredResourceClasses</span>
<a id=__codelineno-62-2 name=__codelineno-62-2></a><a href=#__codelineno-62-2><span class=linenos data-linenos=" 2 "></span></a><span class=k>for</span> <span class=p>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>dataClass</span> <span class=p>:</span> <span class=n>dataClasses</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-62-3 name=__codelineno-62-3></a><a href=#__codelineno-62-3><span class=linenos data-linenos=" 3 "></span></a> <span class=c1>// æˆ‘ä»¬åˆšæ‰åˆ†æäº†è¿™ä¸ªæ–¹æ³•ï¼Œè¿”å›å€¼çœ‹ä¸Šé¢çš„åˆ†æ</span>
<a id=__codelineno-62-4 name=__codelineno-62-4></a><a href=#__codelineno-62-4><span class=linenos data-linenos=" 4 "></span></a> <span class=n>List</span><span class=o>&lt;?</span> <span class=kd>extends</span> <span class=n>Class</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>registeredResourceClasses</span> <span class=o>=</span>
<a id=__codelineno-62-5 name=__codelineno-62-5></a><a href=#__codelineno-62-5><span class=linenos data-linenos=" 5 "></span></a>     <span class=n>decoderRegistry</span><span class=p>.</span><span class=na>getResourceClasses</span><span class=p>(</span><span class=n>dataClass</span><span class=p>,</span> <span class=n>resourceClass</span><span class=p>);</span>
<a id=__codelineno-62-6 name=__codelineno-62-6></a><a href=#__codelineno-62-6><span class=linenos data-linenos=" 6 "></span></a> <span class=k>for</span> <span class=p>(</span><span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>registeredResourceClass</span> <span class=p>:</span> <span class=n>registeredResourceClasses</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-62-7 name=__codelineno-62-7></a><a href=#__codelineno-62-7><span class=linenos data-linenos=" 7 "></span></a>   <span class=c1>// ğŸ”¥ğŸ”¥ğŸ”¥ ç°åœ¨åˆ†æè¿™ä¸ªæ–¹æ³•</span>
<a id=__codelineno-62-8 name=__codelineno-62-8></a><a href=#__codelineno-62-8><span class=linenos data-linenos=" 8 "></span></a>   <span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Transcode</span><span class=o>&gt;&gt;</span> <span class=n>registeredTranscodeClasses</span> <span class=o>=</span> <span class=n>transcoderRegistry</span>
<a id=__codelineno-62-9 name=__codelineno-62-9></a><a href=#__codelineno-62-9><span class=linenos data-linenos=" 9 "></span></a>       <span class=p>.</span><span class=na>getTranscodeClasses</span><span class=p>(</span><span class=n>registeredResourceClass</span><span class=p>,</span> <span class=n>transcodeClass</span><span class=p>);</span>
<a id=__codelineno-62-10 name=__codelineno-62-10></a><a href=#__codelineno-62-10><span class=linenos data-linenos="10 "></span></a>   <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>registeredTranscodeClasses</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>()</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>result</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>registeredResourceClass</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-62-11 name=__codelineno-62-11></a><a href=#__codelineno-62-11><span class=linenos data-linenos="11 "></span></a>     <span class=n>result</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>registeredResourceClass</span><span class=p>);</span>
<a id=__codelineno-62-12 name=__codelineno-62-12></a><a href=#__codelineno-62-12><span class=linenos data-linenos="12 "></span></a>   <span class=p>}</span>
<a id=__codelineno-62-13 name=__codelineno-62-13></a><a href=#__codelineno-62-13><span class=linenos data-linenos="13 "></span></a> <span class=p>}</span>
<a id=__codelineno-62-14 name=__codelineno-62-14></a><a href=#__codelineno-62-14><span class=linenos data-linenos="14 "></span></a><span class=p>}</span>
</code></pre></div> <p>ğŸ”¥ğŸ”¥ğŸ”¥ ç°åœ¨åˆ†æä¸€ä¸‹<code>transcoderRegistry.getTranscodeClasses</code>æ–¹æ³•ã€‚</p> <p>å’Œä¸Šé¢åˆ†æè¿‡çš„ä¸¤ä¸ªRegistryä¸€æ ·ï¼Œ<code>TranscoderRegistry</code>ä¹ŸåŒæ ·æ˜¯åœ¨Glideæ„å»ºçš„æ—¶å€™æ³¨å†Œè¿›æ¥çš„ï¼Œç›¸å…³ä»£ç å¦‚ä¸‹ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-63-1 name=__codelineno-63-1></a><a href=#__codelineno-63-1><span class=linenos data-linenos=" 1 "></span></a><span class=c1>// Glide</span>
<a id=__codelineno-63-2 name=__codelineno-63-2></a><a href=#__codelineno-63-2><span class=linenos data-linenos=" 2 "></span></a><span class=p>.</span><span class=na>register</span><span class=p>(</span><span class=n>Bitmap</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>BitmapDrawable</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=k>new</span> <span class=n>BitmapDrawableTranscoder</span><span class=p>(</span><span class=n>resources</span><span class=p>))</span>
<a id=__codelineno-63-3 name=__codelineno-63-3></a><a href=#__codelineno-63-3><span class=linenos data-linenos=" 3 "></span></a><span class=p>.</span><span class=na>register</span><span class=p>(</span><span class=n>Bitmap</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=kt>byte</span><span class=o>[]</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>bitmapBytesTranscoder</span><span class=p>)</span>
<a id=__codelineno-63-4 name=__codelineno-63-4></a><a href=#__codelineno-63-4><span class=linenos data-linenos=" 4 "></span></a><span class=p>.</span><span class=na>register</span><span class=p>(</span><span class=n>Drawable</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=kt>byte</span><span class=o>[]</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=k>new</span> <span class=n>DrawableBytesTranscoder</span><span class=p>(</span><span class=n>bitmapPool</span><span class=p>,</span> <span class=n>bitmapBytesTranscoder</span><span class=p>,</span> <span class=n>gifDrawableBytesTranscoder</span><span class=p>))</span>
<a id=__codelineno-63-5 name=__codelineno-63-5></a><a href=#__codelineno-63-5><span class=linenos data-linenos=" 5 "></span></a><span class=p>.</span><span class=na>register</span><span class=p>(</span><span class=n>GifDrawable</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=kt>byte</span><span class=o>[]</span><span class=p>.</span><span class=na>class</span><span class=p>,</span> <span class=n>gifDrawableBytesTranscoder</span><span class=p>);</span>
<a id=__codelineno-63-6 name=__codelineno-63-6></a><a href=#__codelineno-63-6><span class=linenos data-linenos=" 6 "></span></a>
<a id=__codelineno-63-7 name=__codelineno-63-7></a><a href=#__codelineno-63-7><span class=linenos data-linenos=" 7 "></span></a><span class=c1>// Registry</span>
<a id=__codelineno-63-8 name=__codelineno-63-8></a><a href=#__codelineno-63-8><span class=linenos data-linenos=" 8 "></span></a><span class=kd>public</span> <span class=kd>class</span> <span class=nc>Registry</span> <span class=p>{</span>
<a id=__codelineno-63-9 name=__codelineno-63-9></a><a href=#__codelineno-63-9><span class=linenos data-linenos=" 9 "></span></a> <span class=kd>private</span> <span class=kd>final</span> <span class=n>TranscoderRegistry</span> <span class=n>transcoderRegistry</span><span class=p>;</span>
<a id=__codelineno-63-10 name=__codelineno-63-10></a><a href=#__codelineno-63-10><span class=linenos data-linenos="10 "></span></a>
<a id=__codelineno-63-11 name=__codelineno-63-11></a><a href=#__codelineno-63-11><span class=linenos data-linenos="11 "></span></a> <span class=kd>public</span> <span class=nf>Registry</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-63-12 name=__codelineno-63-12></a><a href=#__codelineno-63-12><span class=linenos data-linenos="12 "></span></a>   <span class=k>this</span><span class=p>.</span><span class=na>transcoderRegistry</span> <span class=o>=</span> <span class=k>new</span> <span class=n>TranscoderRegistry</span><span class=p>();</span>
<a id=__codelineno-63-13 name=__codelineno-63-13></a><a href=#__codelineno-63-13><span class=linenos data-linenos="13 "></span></a> <span class=p>}</span>
<a id=__codelineno-63-14 name=__codelineno-63-14></a><a href=#__codelineno-63-14><span class=linenos data-linenos="14 "></span></a>
<a id=__codelineno-63-15 name=__codelineno-63-15></a><a href=#__codelineno-63-15><span class=linenos data-linenos="15 "></span></a> <span class=nd>@NonNull</span>
<a id=__codelineno-63-16 name=__codelineno-63-16></a><a href=#__codelineno-63-16><span class=linenos data-linenos="16 "></span></a> <span class=kd>public</span> <span class=o>&lt;</span><span class=n>TResource</span><span class=p>,</span> <span class=n>Transcode</span><span class=o>&gt;</span> <span class=n>Registry</span> <span class=nf>register</span><span class=p>(</span>
<a id=__codelineno-63-17 name=__codelineno-63-17></a><a href=#__codelineno-63-17><span class=linenos data-linenos="17 "></span></a>     <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>TResource</span><span class=o>&gt;</span> <span class=n>resourceClass</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Transcode</span><span class=o>&gt;</span> <span class=n>transcodeClass</span><span class=p>,</span>
<a id=__codelineno-63-18 name=__codelineno-63-18></a><a href=#__codelineno-63-18><span class=linenos data-linenos="18 "></span></a>     <span class=nd>@NonNull</span> <span class=n>ResourceTranscoder</span><span class=o>&lt;</span><span class=n>TResource</span><span class=p>,</span> <span class=n>Transcode</span><span class=o>&gt;</span> <span class=n>transcoder</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-63-19 name=__codelineno-63-19></a><a href=#__codelineno-63-19><span class=linenos data-linenos="19 "></span></a>   <span class=n>transcoderRegistry</span><span class=p>.</span><span class=na>register</span><span class=p>(</span><span class=n>resourceClass</span><span class=p>,</span> <span class=n>transcodeClass</span><span class=p>,</span> <span class=n>transcoder</span><span class=p>);</span>
<a id=__codelineno-63-20 name=__codelineno-63-20></a><a href=#__codelineno-63-20><span class=linenos data-linenos="20 "></span></a>   <span class=k>return</span> <span class=k>this</span><span class=p>;</span>
<a id=__codelineno-63-21 name=__codelineno-63-21></a><a href=#__codelineno-63-21><span class=linenos data-linenos="21 "></span></a> <span class=p>}</span>
<a id=__codelineno-63-22 name=__codelineno-63-22></a><a href=#__codelineno-63-22><span class=linenos data-linenos="22 "></span></a><span class=p>}</span>
<a id=__codelineno-63-23 name=__codelineno-63-23></a><a href=#__codelineno-63-23><span class=linenos data-linenos="23 "></span></a>
<a id=__codelineno-63-24 name=__codelineno-63-24></a><a href=#__codelineno-63-24><span class=linenos data-linenos="24 "></span></a><span class=kd>public</span> <span class=kd>class</span> <span class=nc>TranscoderRegistry</span> <span class=p>{</span>
<a id=__codelineno-63-25 name=__codelineno-63-25></a><a href=#__codelineno-63-25><span class=linenos data-linenos="25 "></span></a> <span class=kd>private</span> <span class=kd>final</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Entry</span><span class=o>&lt;?</span><span class=p>,</span> <span class=o>?&gt;&gt;</span> <span class=n>transcoders</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span>
<a id=__codelineno-63-26 name=__codelineno-63-26></a><a href=#__codelineno-63-26><span class=linenos data-linenos="26 "></span></a>
<a id=__codelineno-63-27 name=__codelineno-63-27></a><a href=#__codelineno-63-27><span class=linenos data-linenos="27 "></span></a> <span class=kd>public</span> <span class=kd>synchronized</span> <span class=o>&lt;</span><span class=n>Z</span><span class=p>,</span> <span class=n>R</span><span class=o>&gt;</span> <span class=kt>void</span> <span class=nf>register</span><span class=p>(</span>
<a id=__codelineno-63-28 name=__codelineno-63-28></a><a href=#__codelineno-63-28><span class=linenos data-linenos="28 "></span></a>     <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>decodedClass</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>transcodedClass</span><span class=p>,</span>
<a id=__codelineno-63-29 name=__codelineno-63-29></a><a href=#__codelineno-63-29><span class=linenos data-linenos="29 "></span></a>     <span class=nd>@NonNull</span> <span class=n>ResourceTranscoder</span><span class=o>&lt;</span><span class=n>Z</span><span class=p>,</span> <span class=n>R</span><span class=o>&gt;</span> <span class=n>transcoder</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-63-30 name=__codelineno-63-30></a><a href=#__codelineno-63-30><span class=linenos data-linenos="30 "></span></a>   <span class=n>transcoders</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=k>new</span> <span class=n>Entry</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>decodedClass</span><span class=p>,</span> <span class=n>transcodedClass</span><span class=p>,</span> <span class=n>transcoder</span><span class=p>));</span>
<a id=__codelineno-63-31 name=__codelineno-63-31></a><a href=#__codelineno-63-31><span class=linenos data-linenos="31 "></span></a> <span class=p>}</span>
<a id=__codelineno-63-32 name=__codelineno-63-32></a><a href=#__codelineno-63-32><span class=linenos data-linenos="32 "></span></a><span class=p>}</span>
</code></pre></div> <p>æ³¨å†Œä»£ç å¾ˆç®€å•ï¼Œå°±æ˜¯ä¿å­˜åˆ°listä¸­å°±å®Œäº‹äº†ã€‚çœ‹çœ‹<code>TranscoderRegistry.getTranscodeClasses</code>æ–¹æ³•ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-64-1 name=__codelineno-64-1></a><a href=#__codelineno-64-1><span class=linenos data-linenos=" 1 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-64-2 name=__codelineno-64-2></a><a href=#__codelineno-64-2><span class=linenos data-linenos=" 2 "></span></a><span class=kd>public</span> <span class=kd>synchronized</span> <span class=o>&lt;</span><span class=n>Z</span><span class=p>,</span> <span class=n>R</span><span class=o>&gt;</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;&gt;</span> <span class=nf>getTranscodeClasses</span><span class=p>(</span>
<a id=__codelineno-64-3 name=__codelineno-64-3></a><a href=#__codelineno-64-3><span class=linenos data-linenos=" 3 "></span></a>   <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>resourceClass</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>transcodeClass</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-64-4 name=__codelineno-64-4></a><a href=#__codelineno-64-4><span class=linenos data-linenos=" 4 "></span></a> <span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;&gt;</span> <span class=n>transcodeClasses</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span>
<a id=__codelineno-64-5 name=__codelineno-64-5></a><a href=#__codelineno-64-5><span class=linenos data-linenos=" 5 "></span></a> <span class=c1>// GifDrawable -&gt; Drawable is just the UnitTranscoder, as is GifDrawable -&gt; GifDrawable.</span>
<a id=__codelineno-64-6 name=__codelineno-64-6></a><a href=#__codelineno-64-6><span class=linenos data-linenos=" 6 "></span></a> <span class=c1>// ğŸ”¥è·¯å¾„1</span>
<a id=__codelineno-64-7 name=__codelineno-64-7></a><a href=#__codelineno-64-7><span class=linenos data-linenos=" 7 "></span></a> <span class=k>if</span> <span class=p>(</span><span class=n>transcodeClass</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>resourceClass</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-64-8 name=__codelineno-64-8></a><a href=#__codelineno-64-8><span class=linenos data-linenos=" 8 "></span></a>   <span class=n>transcodeClasses</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>transcodeClass</span><span class=p>);</span>
<a id=__codelineno-64-9 name=__codelineno-64-9></a><a href=#__codelineno-64-9><span class=linenos data-linenos=" 9 "></span></a>   <span class=k>return</span> <span class=n>transcodeClasses</span><span class=p>;</span>
<a id=__codelineno-64-10 name=__codelineno-64-10></a><a href=#__codelineno-64-10><span class=linenos data-linenos="10 "></span></a> <span class=p>}</span>
<a id=__codelineno-64-11 name=__codelineno-64-11></a><a href=#__codelineno-64-11><span class=linenos data-linenos="11 "></span></a>
<a id=__codelineno-64-12 name=__codelineno-64-12></a><a href=#__codelineno-64-12><span class=linenos data-linenos="12 "></span></a> <span class=c1>// ğŸ”¥è·¯å¾„2</span>
<a id=__codelineno-64-13 name=__codelineno-64-13></a><a href=#__codelineno-64-13><span class=linenos data-linenos="13 "></span></a> <span class=k>for</span> <span class=p>(</span><span class=n>Entry</span><span class=o>&lt;?</span><span class=p>,</span> <span class=o>?&gt;</span> <span class=n>entry</span> <span class=p>:</span> <span class=n>transcoders</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-64-14 name=__codelineno-64-14></a><a href=#__codelineno-64-14><span class=linenos data-linenos="14 "></span></a>   <span class=k>if</span> <span class=p>(</span><span class=n>entry</span><span class=p>.</span><span class=na>handles</span><span class=p>(</span><span class=n>resourceClass</span><span class=p>,</span> <span class=n>transcodeClass</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-64-15 name=__codelineno-64-15></a><a href=#__codelineno-64-15><span class=linenos data-linenos="15 "></span></a>     <span class=n>transcodeClasses</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>transcodeClass</span><span class=p>);</span>
<a id=__codelineno-64-16 name=__codelineno-64-16></a><a href=#__codelineno-64-16><span class=linenos data-linenos="16 "></span></a>   <span class=p>}</span>
<a id=__codelineno-64-17 name=__codelineno-64-17></a><a href=#__codelineno-64-17><span class=linenos data-linenos="17 "></span></a> <span class=p>}</span>
<a id=__codelineno-64-18 name=__codelineno-64-18></a><a href=#__codelineno-64-18><span class=linenos data-linenos="18 "></span></a>
<a id=__codelineno-64-19 name=__codelineno-64-19></a><a href=#__codelineno-64-19><span class=linenos data-linenos="19 "></span></a> <span class=c1>// listæ·»åŠ çš„éƒ½æ˜¯å…¥å‚transcodeClass</span>
<a id=__codelineno-64-20 name=__codelineno-64-20></a><a href=#__codelineno-64-20><span class=linenos data-linenos="20 "></span></a> <span class=k>return</span> <span class=n>transcodeClasses</span><span class=p>;</span>
<a id=__codelineno-64-21 name=__codelineno-64-21></a><a href=#__codelineno-64-21><span class=linenos data-linenos="21 "></span></a><span class=p>}</span>
</code></pre></div> <p>æ­¤æ–¹æ³•çš„ä½œç”¨æ˜¯æ ¹æ®resourceClasså’ŒtranscodeClassï¼Œä»è‡ªèº«æˆ–è€…æ³¨å†Œè¡¨çš„â€œmapâ€ä¸­æ‰¾å‡º<code>transcodeClass</code>ã€‚</p> <p>å›åˆ°<code>Registry.getRegisteredResourceClasses</code>æ–¹æ³•ä¸­çš„ç¬¬äºŒå±‚for loopç»§ç»­åˆ†æï¼Œä¸‹é¢å°±æ˜¯å¯¹æ¯ä¸ªresourceClasså¾—åˆ°çš„registeredTranscodeClassesï¼ˆtranscodeClassä¸º<code>Drawable.class</code>ï¼‰</p> <ol> <li>InputStream.class &amp; Object.class<br> resourceClassä¸º</li> <li><code>GifDrawable.class</code><br> è·¯å¾„1 å…è®¸æ·»åŠ resourceClass</li> <li><code>Bitmap.class</code><br> è·¯å¾„2 èµ°Glideæ³¨å…¥ä»£ç ç‰‡æ®µçš„ç¬¬2è¡Œ å…è®¸æ·»åŠ resourceClass</li> <li><code>BitmapDrawable.class</code><br> è·¯å¾„1 å…è®¸æ·»åŠ resourceClass</li> <li>ParcelFileDescriptor.class &amp; Object.class<br> resourceClassä¸º</li> <li><code>Bitmap.class</code><br> è·¯å¾„2 èµ°Glideæ³¨å…¥ä»£ç ç‰‡æ®µçš„ç¬¬2è¡Œ ä½†resourceClasså·²ç»æ·»åŠ è¿‡</li> <li><code>BitmapDrawable.class</code><br> è·¯å¾„1 ä½†resourceClasså·²ç»æ·»åŠ è¿‡</li> <li>AssetFileDescriptor.class &amp; Object.class<br> resourceClassä¸º</li> <li><code>Bitmap.class</code><br> è·¯å¾„2 èµ°Glideæ³¨å…¥ä»£ç ç‰‡æ®µçš„ç¬¬2è¡Œ ä½†resourceClasså·²ç»æ·»åŠ è¿‡</li> </ol> <p>å› æ­¤ï¼Œ<code>Registry.getRegisteredResourceClasses</code>è¿”å›äº†<code>[GifDrawable.classã€Bitmap.classã€BitmapDrawable.class]</code>æ•°ç»„ï¼Œè¯¥æ•°ç»„ä¼šç»è¿‡<code>DecodeHelper</code>è¿”å›åˆ°<code>ResourceCacheGenerator.startNext</code>æ–¹æ³•çš„è°ƒç”¨ä¸­ã€‚</p> <h4 id=363>3.6.3 å¯»æ‰¾ç¼“å­˜æ–‡ä»¶å¹¶åŠ è½½<a class=headerlink href=#363 title="Anchor link to this section for reference">&para;</a></h4> <p>ç»§ç»­å›åˆ°æœ¬å°èŠ‚çš„ç¬¬ä¸€ä¸ªæ–¹æ³•<code>ResourceCacheGenerator.startNext</code>æ–¹æ³•ä¸­ã€‚ä¸‹é¢è¦æ‰§è¡Œçš„ä»£ç æ˜¯ä¸€ä¸ªwhileå¾ªç¯ï¼Œå¾ªç¯ç»“æŸçš„æ ‡å¿—æ˜¯æ‰¾åˆ°äº†ç¼“å­˜æ–‡ä»¶ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-65-1 name=__codelineno-65-1></a><a href=#__codelineno-65-1><span class=linenos data-linenos=" 1 "></span></a><span class=c1>// éå†sourceIdsä¸­çš„æ¯ä¸€ä¸ªkeyã€resourceClassesä¸­æ¯ä¸€ä¸ªclassï¼Œä»¥åŠå…¶ä»–çš„ä¸€äº›å€¼ç»„æˆkey</span>
<a id=__codelineno-65-2 name=__codelineno-65-2></a><a href=#__codelineno-65-2><span class=linenos data-linenos=" 2 "></span></a><span class=c1>// å°è¯•åœ¨ç£ç›˜ç¼“å­˜ä¸­ä»¥keyæ‰¾åˆ°ç¼“å­˜æ–‡ä»¶</span>
<a id=__codelineno-65-3 name=__codelineno-65-3></a><a href=#__codelineno-65-3><span class=linenos data-linenos=" 3 "></span></a><span class=k>while</span> <span class=p>(</span><span class=n>modelLoaders</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=o>!</span><span class=n>hasNextModelLoader</span><span class=p>())</span> <span class=p>{</span>
<a id=__codelineno-65-4 name=__codelineno-65-4></a><a href=#__codelineno-65-4><span class=linenos data-linenos=" 4 "></span></a> <span class=n>resourceClassIndex</span><span class=o>++</span><span class=p>;</span>
<a id=__codelineno-65-5 name=__codelineno-65-5></a><a href=#__codelineno-65-5><span class=linenos data-linenos=" 5 "></span></a> <span class=k>if</span> <span class=p>(</span><span class=n>resourceClassIndex</span> <span class=o>&gt;=</span> <span class=n>resourceClasses</span><span class=p>.</span><span class=na>size</span><span class=p>())</span> <span class=p>{</span>
<a id=__codelineno-65-6 name=__codelineno-65-6></a><a href=#__codelineno-65-6><span class=linenos data-linenos=" 6 "></span></a>   <span class=n>sourceIdIndex</span><span class=o>++</span><span class=p>;</span>
<a id=__codelineno-65-7 name=__codelineno-65-7></a><a href=#__codelineno-65-7><span class=linenos data-linenos=" 7 "></span></a>   <span class=k>if</span> <span class=p>(</span><span class=n>sourceIdIndex</span> <span class=o>&gt;=</span> <span class=n>sourceIds</span><span class=p>.</span><span class=na>size</span><span class=p>())</span> <span class=p>{</span>
<a id=__codelineno-65-8 name=__codelineno-65-8></a><a href=#__codelineno-65-8><span class=linenos data-linenos=" 8 "></span></a>     <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
<a id=__codelineno-65-9 name=__codelineno-65-9></a><a href=#__codelineno-65-9><span class=linenos data-linenos=" 9 "></span></a>   <span class=p>}</span>
<a id=__codelineno-65-10 name=__codelineno-65-10></a><a href=#__codelineno-65-10><span class=linenos data-linenos="10 "></span></a>   <span class=n>resourceClassIndex</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
<a id=__codelineno-65-11 name=__codelineno-65-11></a><a href=#__codelineno-65-11><span class=linenos data-linenos="11 "></span></a> <span class=p>}</span>
<a id=__codelineno-65-12 name=__codelineno-65-12></a><a href=#__codelineno-65-12><span class=linenos data-linenos="12 "></span></a>
<a id=__codelineno-65-13 name=__codelineno-65-13></a><a href=#__codelineno-65-13><span class=linenos data-linenos="13 "></span></a> <span class=n>Key</span> <span class=n>sourceId</span> <span class=o>=</span> <span class=n>sourceIds</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>sourceIdIndex</span><span class=p>);</span>
<a id=__codelineno-65-14 name=__codelineno-65-14></a><a href=#__codelineno-65-14><span class=linenos data-linenos="14 "></span></a> <span class=n>Class</span><span class=o>&lt;?&gt;</span> <span class=n>resourceClass</span> <span class=o>=</span> <span class=n>resourceClasses</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>resourceClassIndex</span><span class=p>);</span>
<a id=__codelineno-65-15 name=__codelineno-65-15></a><a href=#__codelineno-65-15><span class=linenos data-linenos="15 "></span></a> <span class=n>Transformation</span><span class=o>&lt;?&gt;</span> <span class=n>transformation</span> <span class=o>=</span> <span class=n>helper</span><span class=p>.</span><span class=na>getTransformation</span><span class=p>(</span><span class=n>resourceClass</span><span class=p>);</span>
<a id=__codelineno-65-16 name=__codelineno-65-16></a><a href=#__codelineno-65-16><span class=linenos data-linenos="16 "></span></a> <span class=c1>// PMD.AvoidInstantiatingObjectsInLoops Each iteration is comparatively expensive anyway,</span>
<a id=__codelineno-65-17 name=__codelineno-65-17></a><a href=#__codelineno-65-17><span class=linenos data-linenos="17 "></span></a> <span class=c1>// we only run until the first one succeeds, the loop runs for only a limited</span>
<a id=__codelineno-65-18 name=__codelineno-65-18></a><a href=#__codelineno-65-18><span class=linenos data-linenos="18 "></span></a> <span class=c1>// number of iterations on the order of 10-20 in the worst case.</span>
<a id=__codelineno-65-19 name=__codelineno-65-19></a><a href=#__codelineno-65-19><span class=linenos data-linenos="19 "></span></a> <span class=n>currentKey</span> <span class=o>=</span>
<a id=__codelineno-65-20 name=__codelineno-65-20></a><a href=#__codelineno-65-20><span class=linenos data-linenos="20 "></span></a>     <span class=k>new</span> <span class=n>ResourceCacheKey</span><span class=p>(</span><span class=c1>// NOPMD AvoidInstantiatingObjectsInLoops</span>
<a id=__codelineno-65-21 name=__codelineno-65-21></a><a href=#__codelineno-65-21><span class=linenos data-linenos="21 "></span></a>         <span class=n>helper</span><span class=p>.</span><span class=na>getArrayPool</span><span class=p>(),</span>
<a id=__codelineno-65-22 name=__codelineno-65-22></a><a href=#__codelineno-65-22><span class=linenos data-linenos="22 "></span></a>         <span class=n>sourceId</span><span class=p>,</span>
<a id=__codelineno-65-23 name=__codelineno-65-23></a><a href=#__codelineno-65-23><span class=linenos data-linenos="23 "></span></a>         <span class=n>helper</span><span class=p>.</span><span class=na>getSignature</span><span class=p>(),</span>
<a id=__codelineno-65-24 name=__codelineno-65-24></a><a href=#__codelineno-65-24><span class=linenos data-linenos="24 "></span></a>         <span class=n>helper</span><span class=p>.</span><span class=na>getWidth</span><span class=p>(),</span>
<a id=__codelineno-65-25 name=__codelineno-65-25></a><a href=#__codelineno-65-25><span class=linenos data-linenos="25 "></span></a>         <span class=n>helper</span><span class=p>.</span><span class=na>getHeight</span><span class=p>(),</span>
<a id=__codelineno-65-26 name=__codelineno-65-26></a><a href=#__codelineno-65-26><span class=linenos data-linenos="26 "></span></a>         <span class=n>transformation</span><span class=p>,</span>
<a id=__codelineno-65-27 name=__codelineno-65-27></a><a href=#__codelineno-65-27><span class=linenos data-linenos="27 "></span></a>         <span class=n>resourceClass</span><span class=p>,</span>
<a id=__codelineno-65-28 name=__codelineno-65-28></a><a href=#__codelineno-65-28><span class=linenos data-linenos="28 "></span></a>         <span class=n>helper</span><span class=p>.</span><span class=na>getOptions</span><span class=p>());</span>
<a id=__codelineno-65-29 name=__codelineno-65-29></a><a href=#__codelineno-65-29><span class=linenos data-linenos="29 "></span></a> <span class=n>cacheFile</span> <span class=o>=</span> <span class=n>helper</span><span class=p>.</span><span class=na>getDiskCache</span><span class=p>().</span><span class=na>get</span><span class=p>(</span><span class=n>currentKey</span><span class=p>);</span>
<a id=__codelineno-65-30 name=__codelineno-65-30></a><a href=#__codelineno-65-30><span class=linenos data-linenos="30 "></span></a> <span class=c1>// å¦‚æœæ‰¾åˆ°äº†ç¼“å­˜æ–‡ä»¶ï¼Œé‚£ä¹ˆå¾ªç¯æ¡ä»¶åˆ™ä¼šä¸ºfalseï¼Œä¹Ÿå°±é€€å‡ºå¾ªç¯äº†</span>
<a id=__codelineno-65-31 name=__codelineno-65-31></a><a href=#__codelineno-65-31><span class=linenos data-linenos="31 "></span></a> <span class=k>if</span> <span class=p>(</span><span class=n>cacheFile</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-65-32 name=__codelineno-65-32></a><a href=#__codelineno-65-32><span class=linenos data-linenos="32 "></span></a>   <span class=n>sourceKey</span> <span class=o>=</span> <span class=n>sourceId</span><span class=p>;</span>
<a id=__codelineno-65-33 name=__codelineno-65-33></a><a href=#__codelineno-65-33><span class=linenos data-linenos="33 "></span></a>   <span class=n>modelLoaders</span> <span class=o>=</span> <span class=n>helper</span><span class=p>.</span><span class=na>getModelLoaders</span><span class=p>(</span><span class=n>cacheFile</span><span class=p>);</span>
<a id=__codelineno-65-34 name=__codelineno-65-34></a><a href=#__codelineno-65-34><span class=linenos data-linenos="34 "></span></a>   <span class=n>modelLoaderIndex</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
<a id=__codelineno-65-35 name=__codelineno-65-35></a><a href=#__codelineno-65-35><span class=linenos data-linenos="35 "></span></a> <span class=p>}</span>
<a id=__codelineno-65-36 name=__codelineno-65-36></a><a href=#__codelineno-65-36><span class=linenos data-linenos="36 "></span></a><span class=p>}</span>
</code></pre></div> <p>èµ°åˆ°è¿™é‡Œï¼Œç”±äºæ˜¯åˆæ¬¡åŠ è½½ï¼Œæ‰€ä»¥DiskLruCacheé‡Œé¢è‚¯å®šæ˜¯æ²¡æœ‰ç¼“å­˜çš„ã€‚ </p> <p>æ³¨æ„è¿™é‡Œçš„Keyçš„ç»„æˆï¼Œåœ¨ä¹‹å‰æˆ‘ä»¬æè¿°è¿‡<code>ResourceCacheGenerator</code>çš„ä½œç”¨ï¼šè·å–é‡‡æ ·åã€transformedåèµ„æºæ–‡ä»¶çš„ç¼“å­˜æ–‡ä»¶ã€‚åœ¨ç¬¬3èŠ‚ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒDownsampleStrategyå’ŒTransformationä¿å­˜åœ¨äº†<code>BaseRequestOptions</code>é‡Œé¢ï¼Œå‰è€…ä¿å­˜åœ¨<code>BaseRequestOptions.Options</code>é‡Œï¼Œåè€…ä¿å­˜åœ¨<code>transformations</code>é‡Œã€‚åœ¨è¿™é‡Œè¿™ä¸¤ä¸ªå‚æ•°éƒ½ä½œä¸ºäº†ç¼“å­˜æ–‡ä»¶çš„Keyï¼Œè¿™ä¹Ÿä¾§é¢éªŒè¯äº†<code>ResourceCacheGenerator</code>çš„ä½œç”¨ã€‚</p> <p>ä½†åœ¨åŠ è½½ä»£ç ä¸ŠåŠ ä¸Šè¯<code>.diskCacheStrategy(DiskCacheStrategy.RESOURCE)</code>ï¼Œå°±å¯ä»¥åˆ°äº†ç¼“å­˜ï¼Œè¿™æ ·å¯ä»¥æ¥ç€ä¸€æ¬¡æ€§æŠŠåé¢çš„æ–¹æ³•ä¹Ÿåˆ†æå®Œï¼Œå…ˆçœ‹çœ‹ä¸‹é¢çš„è¿™ä¸ªæ–¹æ³•ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-66-1 name=__codelineno-66-1></a><a href=#__codelineno-66-1><span class=linenos data-linenos="1 "></span></a><span class=n>modelLoaders</span> <span class=o>=</span> <span class=n>helper</span><span class=p>.</span><span class=na>getModelLoaders</span><span class=p>(</span><span class=n>cacheFile</span><span class=p>);</span>
</code></pre></div> <p>å†…éƒ¨è°ƒç”¨äº†<code>Registry.getModelLoaders</code>æ–¹æ³•ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-67-1 name=__codelineno-67-1></a><a href=#__codelineno-67-1><span class=linenos data-linenos="1 "></span></a><span class=n>List</span><span class=o>&lt;</span><span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>File</span><span class=p>,</span> <span class=o>?&gt;&gt;</span> <span class=n>getModelLoaders</span><span class=p>(</span><span class=n>File</span> <span class=n>file</span><span class=p>)</span>
<a id=__codelineno-67-2 name=__codelineno-67-2></a><a href=#__codelineno-67-2><span class=linenos data-linenos="2 "></span></a>   <span class=kd>throws</span> <span class=n>Registry</span><span class=p>.</span><span class=na>NoModelLoaderAvailableException</span> <span class=p>{</span>
<a id=__codelineno-67-3 name=__codelineno-67-3></a><a href=#__codelineno-67-3><span class=linenos data-linenos="3 "></span></a> <span class=k>return</span> <span class=n>glideContext</span><span class=p>.</span><span class=na>getRegistry</span><span class=p>().</span><span class=na>getModelLoaders</span><span class=p>(</span><span class=n>file</span><span class=p>);</span>
<a id=__codelineno-67-4 name=__codelineno-67-4></a><a href=#__codelineno-67-4><span class=linenos data-linenos="4 "></span></a><span class=p>}</span>
</code></pre></div> <p>è¯¥æ–¹æ³•æˆ‘ä»¬ä¸Šé¢å…·ä½“åˆ†æè¿‡ï¼Œç¨åŠ å›å¿†åæˆ‘ä»¬å¯ä»¥å†™å‡º<code>getModelLoaders(File)</code>æ–¹æ³•çš„è¿‡ç¨‹ï¼š</p> <ol> <li>é¦–å…ˆæ‰¾å‡ºæ³¨å…¥æ—¶ä»¥<code>File.class</code>ä¸ºmodelClassçš„æ³¨å…¥ä»£ç </li> <li>è°ƒç”¨æ‰€æœ‰æ³¨å…¥çš„<code>factory.build</code>æ–¹æ³•å¾—åˆ°<code>ModelLoader</code></li> <li>è¿‡æ»¤æ‰ä¸å¯èƒ½å¤„ç†<code>model</code>çš„<code>ModelLoader</code></li> </ol> <p>è¿™æ ·å¾—åˆ°äº†ä»¥ä¸‹å››ä¸ªModelLoader</p> <ul> <li><code>.append(File.class, ByteBuffer.class, new ByteBufferFileLoader.Factory())</code></li> <li><code>ByteBufferFileLoader</code></li> <li><code>.append(File.class, InputStream.class, new FileLoader.StreamFactory())</code></li> <li><code>FileLoader</code></li> <li><code>.append(File.class, ParcelFileDescriptor.class, new FileLoader.FileDescriptorFactory())</code></li> <li><code>FileLoader</code></li> <li><code>.append(File.class, File.class, UnitModelLoader.Factory.&lt;File&gt;getInstance())</code></li> <li><code>UnitModelLoader</code></li> </ul> <p>æ‰€ä»¥æ­¤æ—¶çš„modelLoaderså€¼ä¸º<code>[ByteBufferFileLoader, FileLoader, FileLoader, UnitModelLoader]</code>ã€‚</p> <p>æ¥ä¸‹æ¥ä¼šè°ƒç”¨æ¯ä¸€ä¸ªModelLoaderå°è¯•åŠ è½½æ•°æ®ï¼Œç›´åˆ°æ‰¾åˆ°ç¬¬ä¸€ä¸ªå¯ä»¥å¤„ç†çš„ModelLoaderï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-68-1 name=__codelineno-68-1></a><a href=#__codelineno-68-1><span class=linenos data-linenos=" 1 "></span></a><span class=n>loadData</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-68-2 name=__codelineno-68-2></a><a href=#__codelineno-68-2><span class=linenos data-linenos=" 2 "></span></a><span class=kt>boolean</span> <span class=n>started</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
<a id=__codelineno-68-3 name=__codelineno-68-3></a><a href=#__codelineno-68-3><span class=linenos data-linenos=" 3 "></span></a><span class=k>while</span> <span class=p>(</span><span class=o>!</span><span class=n>started</span> <span class=o>&amp;&amp;</span> <span class=n>hasNextModelLoader</span><span class=p>())</span> <span class=p>{</span>
<a id=__codelineno-68-4 name=__codelineno-68-4></a><a href=#__codelineno-68-4><span class=linenos data-linenos=" 4 "></span></a> <span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>File</span><span class=p>,</span> <span class=o>?&gt;</span> <span class=n>modelLoader</span> <span class=o>=</span> <span class=n>modelLoaders</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>modelLoaderIndex</span><span class=o>++</span><span class=p>);</span>
<a id=__codelineno-68-5 name=__codelineno-68-5></a><a href=#__codelineno-68-5><span class=linenos data-linenos=" 5 "></span></a> <span class=n>loadData</span> <span class=o>=</span> <span class=n>modelLoader</span><span class=p>.</span><span class=na>buildLoadData</span><span class=p>(</span><span class=n>cacheFile</span><span class=p>,</span>
<a id=__codelineno-68-6 name=__codelineno-68-6></a><a href=#__codelineno-68-6><span class=linenos data-linenos=" 6 "></span></a>     <span class=n>helper</span><span class=p>.</span><span class=na>getWidth</span><span class=p>(),</span> <span class=n>helper</span><span class=p>.</span><span class=na>getHeight</span><span class=p>(),</span> <span class=n>helper</span><span class=p>.</span><span class=na>getOptions</span><span class=p>());</span>
<a id=__codelineno-68-7 name=__codelineno-68-7></a><a href=#__codelineno-68-7><span class=linenos data-linenos=" 7 "></span></a> <span class=k>if</span> <span class=p>(</span><span class=n>loadData</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>helper</span><span class=p>.</span><span class=na>hasLoadPath</span><span class=p>(</span><span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>getDataClass</span><span class=p>()))</span> <span class=p>{</span>
<a id=__codelineno-68-8 name=__codelineno-68-8></a><a href=#__codelineno-68-8><span class=linenos data-linenos=" 8 "></span></a>   <span class=n>started</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
<a id=__codelineno-68-9 name=__codelineno-68-9></a><a href=#__codelineno-68-9><span class=linenos data-linenos=" 9 "></span></a>   <span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>loadData</span><span class=p>(</span><span class=n>helper</span><span class=p>.</span><span class=na>getPriority</span><span class=p>(),</span> <span class=k>this</span><span class=p>);</span>
<a id=__codelineno-68-10 name=__codelineno-68-10></a><a href=#__codelineno-68-10><span class=linenos data-linenos="10 "></span></a> <span class=p>}</span>
<a id=__codelineno-68-11 name=__codelineno-68-11></a><a href=#__codelineno-68-11><span class=linenos data-linenos="11 "></span></a><span class=p>}</span>
<a id=__codelineno-68-12 name=__codelineno-68-12></a><a href=#__codelineno-68-12><span class=linenos data-linenos="12 "></span></a>
<a id=__codelineno-68-13 name=__codelineno-68-13></a><a href=#__codelineno-68-13><span class=linenos data-linenos="13 "></span></a><span class=k>return</span> <span class=n>started</span><span class=p>;</span>
</code></pre></div> <p>è¿™å››ä¸ªModelLoaderéƒ½ä¼šè°ƒç”¨<code>buildLoadData</code>æ–¹æ³•åˆ›å»º<code>LoadData</code>å¯¹è±¡ï¼Œè¯¥å¯¹è±¡é‡è¦çš„æˆå‘˜å˜é‡æ˜¯<code>DataFetcher</code>ï¼›ç„¶åè°ƒç”¨<code>helper.hasLoadPath</code>æ ¹æ®<code>resourceClass</code>å‚æ•°å’Œ<code>transcodeClass</code>å‚æ•°åˆ¤æ–­æ˜¯å¦æœ‰è·¯å¾„è¾¾åˆ°<code>DataFetcher.getDataClass</code>ï¼Œå¦‚æœæœ‰é‚£å°±è°ƒç”¨æ­¤fetcherè¿›è¡ŒloadDataï¼Œä»»åŠ¡æ‰§è¡Œå®Œæ¯•ã€‚</p> <p>ä¾‹å­ä¸­ç¬¦åˆæ¡ä»¶çš„<code>ModelLoader</code>ä»¥åŠå…¶<code>fetcher</code>å¦‚ä¸‹ï¼š</p> <ul> <li><code>ByteBufferFileLoader</code><br> fetcher = <code>ByteBufferFetcher(file)</code><br> fetcher.dataClass = <code>ByteBuffer.class</code></li> <li><code>FileLoader</code><br> fetcher = <code>FileFetcher(model, fileOpener)</code><br> fetcher.dataClass = <code>InputStream.class</code></li> <li><code>FileLoader</code><br> fetcher = <code>FileFetcher(model, fileOpener)</code><br> fetcher.dataClass = <code>ParcelFileDescriptor.class</code></li> <li><code>UnitModelLoader</code><br> fetcher = <code>UnitFetcher&lt;&gt;(model)</code><br> fetcher.dataClass = <code>File.class</code></li> </ul> <p>çœ‹ä¸€ä¸‹<code>DecodeHelper.getLoadPath</code>æ–¹æ³•æ˜¯å¦‚ä½•åˆ¤æ–­è·¯å¾„çš„ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-69-1 name=__codelineno-69-1></a><a href=#__codelineno-69-1><span class=linenos data-linenos=" 1 "></span></a><span class=c1>// DecodeHelper</span>
<a id=__codelineno-69-2 name=__codelineno-69-2></a><a href=#__codelineno-69-2><span class=linenos data-linenos=" 2 "></span></a><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>LoadPath</span><span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span> <span class=o>?</span><span class=p>,</span> <span class=n>Transcode</span><span class=o>&gt;</span> <span class=nf>getLoadPath</span><span class=p>(</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>dataClass</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-69-3 name=__codelineno-69-3></a><a href=#__codelineno-69-3><span class=linenos data-linenos=" 3 "></span></a> <span class=k>return</span> <span class=n>glideContext</span><span class=p>.</span><span class=na>getRegistry</span><span class=p>().</span><span class=na>getLoadPath</span><span class=p>(</span><span class=n>dataClass</span><span class=p>,</span> <span class=n>resourceClass</span><span class=p>,</span> <span class=n>transcodeClass</span><span class=p>);</span>
<a id=__codelineno-69-4 name=__codelineno-69-4></a><a href=#__codelineno-69-4><span class=linenos data-linenos=" 4 "></span></a><span class=p>}</span>
<a id=__codelineno-69-5 name=__codelineno-69-5></a><a href=#__codelineno-69-5><span class=linenos data-linenos=" 5 "></span></a>
<a id=__codelineno-69-6 name=__codelineno-69-6></a><a href=#__codelineno-69-6><span class=linenos data-linenos=" 6 "></span></a><span class=c1>// Registry</span>
<a id=__codelineno-69-7 name=__codelineno-69-7></a><a href=#__codelineno-69-7><span class=linenos data-linenos=" 7 "></span></a><span class=nd>@Nullable</span>
<a id=__codelineno-69-8 name=__codelineno-69-8></a><a href=#__codelineno-69-8><span class=linenos data-linenos=" 8 "></span></a><span class=kd>public</span> <span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span> <span class=n>TResource</span><span class=p>,</span> <span class=n>Transcode</span><span class=o>&gt;</span> <span class=n>LoadPath</span><span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span> <span class=n>TResource</span><span class=p>,</span> <span class=n>Transcode</span><span class=o>&gt;</span> <span class=nf>getLoadPath</span><span class=p>(</span>
<a id=__codelineno-69-9 name=__codelineno-69-9></a><a href=#__codelineno-69-9><span class=linenos data-linenos=" 9 "></span></a>   <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>dataClass</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>TResource</span><span class=o>&gt;</span> <span class=n>resourceClass</span><span class=p>,</span>
<a id=__codelineno-69-10 name=__codelineno-69-10></a><a href=#__codelineno-69-10><span class=linenos data-linenos="10 "></span></a>   <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Transcode</span><span class=o>&gt;</span> <span class=n>transcodeClass</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-69-11 name=__codelineno-69-11></a><a href=#__codelineno-69-11><span class=linenos data-linenos="11 "></span></a> <span class=c1>// å…ˆå–ç¼“å­˜</span>
<a id=__codelineno-69-12 name=__codelineno-69-12></a><a href=#__codelineno-69-12><span class=linenos data-linenos="12 "></span></a> <span class=n>LoadPath</span><span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span> <span class=n>TResource</span><span class=p>,</span> <span class=n>Transcode</span><span class=o>&gt;</span> <span class=n>result</span> <span class=o>=</span>
<a id=__codelineno-69-13 name=__codelineno-69-13></a><a href=#__codelineno-69-13><span class=linenos data-linenos="13 "></span></a>     <span class=n>loadPathCache</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>dataClass</span><span class=p>,</span> <span class=n>resourceClass</span><span class=p>,</span> <span class=n>transcodeClass</span><span class=p>);</span>
<a id=__codelineno-69-14 name=__codelineno-69-14></a><a href=#__codelineno-69-14><span class=linenos data-linenos="14 "></span></a> <span class=c1>// å¦‚æœå–åˆ°NO_PATHS_SIGNALè¿™æ¡LoadPathï¼Œé‚£ä¹ˆè¿”å›null</span>
<a id=__codelineno-69-15 name=__codelineno-69-15></a><a href=#__codelineno-69-15><span class=linenos data-linenos="15 "></span></a> <span class=k>if</span> <span class=p>(</span><span class=n>loadPathCache</span><span class=p>.</span><span class=na>isEmptyLoadPath</span><span class=p>(</span><span class=n>result</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-69-16 name=__codelineno-69-16></a><a href=#__codelineno-69-16><span class=linenos data-linenos="16 "></span></a>   <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-69-17 name=__codelineno-69-17></a><a href=#__codelineno-69-17><span class=linenos data-linenos="17 "></span></a> <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>result</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-69-18 name=__codelineno-69-18></a><a href=#__codelineno-69-18><span class=linenos data-linenos="18 "></span></a>   <span class=c1>// å–åˆ°nullï¼Œè¯´æ˜è¿˜æ²¡æœ‰è·å–è¿‡</span>
<a id=__codelineno-69-19 name=__codelineno-69-19></a><a href=#__codelineno-69-19><span class=linenos data-linenos="19 "></span></a>   <span class=c1>// é‚£ä¹ˆå…ˆè·å–decodePathsï¼Œåœ¨åˆ›å»ºLoadPathå¯¹è±¡å¹¶å­˜å…¥ç¼“å­˜ä¸­</span>
<a id=__codelineno-69-20 name=__codelineno-69-20></a><a href=#__codelineno-69-20><span class=linenos data-linenos="20 "></span></a>   <span class=n>List</span><span class=o>&lt;</span><span class=n>DecodePath</span><span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span> <span class=n>TResource</span><span class=p>,</span> <span class=n>Transcode</span><span class=o>&gt;&gt;</span> <span class=n>decodePaths</span> <span class=o>=</span>
<a id=__codelineno-69-21 name=__codelineno-69-21></a><a href=#__codelineno-69-21><span class=linenos data-linenos="21 "></span></a>       <span class=n>getDecodePaths</span><span class=p>(</span><span class=n>dataClass</span><span class=p>,</span> <span class=n>resourceClass</span><span class=p>,</span> <span class=n>transcodeClass</span><span class=p>);</span>
<a id=__codelineno-69-22 name=__codelineno-69-22></a><a href=#__codelineno-69-22><span class=linenos data-linenos="22 "></span></a>   <span class=c1>// It&#39;s possible there is no way to decode or transcode to the desired types from a given</span>
<a id=__codelineno-69-23 name=__codelineno-69-23></a><a href=#__codelineno-69-23><span class=linenos data-linenos="23 "></span></a>   <span class=c1>// data class.</span>
<a id=__codelineno-69-24 name=__codelineno-69-24></a><a href=#__codelineno-69-24><span class=linenos data-linenos="24 "></span></a>   <span class=k>if</span> <span class=p>(</span><span class=n>decodePaths</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span> <span class=p>{</span>
<a id=__codelineno-69-25 name=__codelineno-69-25></a><a href=#__codelineno-69-25><span class=linenos data-linenos="25 "></span></a>     <span class=n>result</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-69-26 name=__codelineno-69-26></a><a href=#__codelineno-69-26><span class=linenos data-linenos="26 "></span></a>   <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
<a id=__codelineno-69-27 name=__codelineno-69-27></a><a href=#__codelineno-69-27><span class=linenos data-linenos="27 "></span></a>     <span class=n>result</span> <span class=o>=</span>
<a id=__codelineno-69-28 name=__codelineno-69-28></a><a href=#__codelineno-69-28><span class=linenos data-linenos="28 "></span></a>         <span class=k>new</span> <span class=n>LoadPath</span><span class=o>&lt;&gt;</span><span class=p>(</span>
<a id=__codelineno-69-29 name=__codelineno-69-29></a><a href=#__codelineno-69-29><span class=linenos data-linenos="29 "></span></a>             <span class=n>dataClass</span><span class=p>,</span> <span class=n>resourceClass</span><span class=p>,</span> <span class=n>transcodeClass</span><span class=p>,</span> <span class=n>decodePaths</span><span class=p>,</span> <span class=n>throwableListPool</span><span class=p>);</span>
<a id=__codelineno-69-30 name=__codelineno-69-30></a><a href=#__codelineno-69-30><span class=linenos data-linenos="30 "></span></a>   <span class=p>}</span>
<a id=__codelineno-69-31 name=__codelineno-69-31></a><a href=#__codelineno-69-31><span class=linenos data-linenos="31 "></span></a>   <span class=c1>// å­˜å…¥ç¼“å­˜</span>
<a id=__codelineno-69-32 name=__codelineno-69-32></a><a href=#__codelineno-69-32><span class=linenos data-linenos="32 "></span></a>   <span class=n>loadPathCache</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>dataClass</span><span class=p>,</span> <span class=n>resourceClass</span><span class=p>,</span> <span class=n>transcodeClass</span><span class=p>,</span> <span class=n>result</span><span class=p>);</span>
<a id=__codelineno-69-33 name=__codelineno-69-33></a><a href=#__codelineno-69-33><span class=linenos data-linenos="33 "></span></a> <span class=p>}</span>
<a id=__codelineno-69-34 name=__codelineno-69-34></a><a href=#__codelineno-69-34><span class=linenos data-linenos="34 "></span></a> <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
<a id=__codelineno-69-35 name=__codelineno-69-35></a><a href=#__codelineno-69-35><span class=linenos data-linenos="35 "></span></a><span class=p>}</span>
</code></pre></div> <p>å¯ä»¥çœ‹å‡ºï¼Œ<code>getLoadPath</code>çš„å…³é”®å°±æ˜¯<code>getDecodePaths</code>æ–¹æ³•ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-70-1 name=__codelineno-70-1></a><a href=#__codelineno-70-1><span class=linenos data-linenos=" 1 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-70-2 name=__codelineno-70-2></a><a href=#__codelineno-70-2><span class=linenos data-linenos=" 2 "></span></a><span class=kd>private</span> <span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span> <span class=n>TResource</span><span class=p>,</span> <span class=n>Transcode</span><span class=o>&gt;</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>DecodePath</span><span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span> <span class=n>TResource</span><span class=p>,</span> <span class=n>Transcode</span><span class=o>&gt;&gt;</span> <span class=nf>getDecodePaths</span><span class=p>(</span>
<a id=__codelineno-70-3 name=__codelineno-70-3></a><a href=#__codelineno-70-3><span class=linenos data-linenos=" 3 "></span></a>   <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>dataClass</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>TResource</span><span class=o>&gt;</span> <span class=n>resourceClass</span><span class=p>,</span>
<a id=__codelineno-70-4 name=__codelineno-70-4></a><a href=#__codelineno-70-4><span class=linenos data-linenos=" 4 "></span></a>   <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Transcode</span><span class=o>&gt;</span> <span class=n>transcodeClass</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-70-5 name=__codelineno-70-5></a><a href=#__codelineno-70-5><span class=linenos data-linenos=" 5 "></span></a> <span class=n>List</span><span class=o>&lt;</span><span class=n>DecodePath</span><span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span> <span class=n>TResource</span><span class=p>,</span> <span class=n>Transcode</span><span class=o>&gt;&gt;</span> <span class=n>decodePaths</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span>
<a id=__codelineno-70-6 name=__codelineno-70-6></a><a href=#__codelineno-70-6><span class=linenos data-linenos=" 6 "></span></a> <span class=c1>// 1</span>
<a id=__codelineno-70-7 name=__codelineno-70-7></a><a href=#__codelineno-70-7><span class=linenos data-linenos=" 7 "></span></a> <span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>TResource</span><span class=o>&gt;&gt;</span> <span class=n>registeredResourceClasses</span> <span class=o>=</span>
<a id=__codelineno-70-8 name=__codelineno-70-8></a><a href=#__codelineno-70-8><span class=linenos data-linenos=" 8 "></span></a>     <span class=n>decoderRegistry</span><span class=p>.</span><span class=na>getResourceClasses</span><span class=p>(</span><span class=n>dataClass</span><span class=p>,</span> <span class=n>resourceClass</span><span class=p>);</span>
<a id=__codelineno-70-9 name=__codelineno-70-9></a><a href=#__codelineno-70-9><span class=linenos data-linenos=" 9 "></span></a>
<a id=__codelineno-70-10 name=__codelineno-70-10></a><a href=#__codelineno-70-10><span class=linenos data-linenos="10 "></span></a> <span class=k>for</span> <span class=p>(</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>TResource</span><span class=o>&gt;</span> <span class=n>registeredResourceClass</span> <span class=p>:</span> <span class=n>registeredResourceClasses</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-70-11 name=__codelineno-70-11></a><a href=#__codelineno-70-11><span class=linenos data-linenos="11 "></span></a>   <span class=c1>// 2</span>
<a id=__codelineno-70-12 name=__codelineno-70-12></a><a href=#__codelineno-70-12><span class=linenos data-linenos="12 "></span></a>   <span class=n>List</span><span class=o>&lt;</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Transcode</span><span class=o>&gt;&gt;</span> <span class=n>registeredTranscodeClasses</span> <span class=o>=</span>
<a id=__codelineno-70-13 name=__codelineno-70-13></a><a href=#__codelineno-70-13><span class=linenos data-linenos="13 "></span></a>       <span class=n>transcoderRegistry</span><span class=p>.</span><span class=na>getTranscodeClasses</span><span class=p>(</span><span class=n>registeredResourceClass</span><span class=p>,</span> <span class=n>transcodeClass</span><span class=p>);</span>
<a id=__codelineno-70-14 name=__codelineno-70-14></a><a href=#__codelineno-70-14><span class=linenos data-linenos="14 "></span></a>
<a id=__codelineno-70-15 name=__codelineno-70-15></a><a href=#__codelineno-70-15><span class=linenos data-linenos="15 "></span></a>   <span class=k>for</span> <span class=p>(</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Transcode</span><span class=o>&gt;</span> <span class=n>registeredTranscodeClass</span> <span class=p>:</span> <span class=n>registeredTranscodeClasses</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-70-16 name=__codelineno-70-16></a><a href=#__codelineno-70-16><span class=linenos data-linenos="16 "></span></a>     <span class=c1>// 3</span>
<a id=__codelineno-70-17 name=__codelineno-70-17></a><a href=#__codelineno-70-17><span class=linenos data-linenos="17 "></span></a>     <span class=n>List</span><span class=o>&lt;</span><span class=n>ResourceDecoder</span><span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span> <span class=n>TResource</span><span class=o>&gt;&gt;</span> <span class=n>decoders</span> <span class=o>=</span>
<a id=__codelineno-70-18 name=__codelineno-70-18></a><a href=#__codelineno-70-18><span class=linenos data-linenos="18 "></span></a>         <span class=n>decoderRegistry</span><span class=p>.</span><span class=na>getDecoders</span><span class=p>(</span><span class=n>dataClass</span><span class=p>,</span> <span class=n>registeredResourceClass</span><span class=p>);</span>
<a id=__codelineno-70-19 name=__codelineno-70-19></a><a href=#__codelineno-70-19><span class=linenos data-linenos="19 "></span></a>     <span class=n>ResourceTranscoder</span><span class=o>&lt;</span><span class=n>TResource</span><span class=p>,</span> <span class=n>Transcode</span><span class=o>&gt;</span> <span class=n>transcoder</span> <span class=o>=</span>
<a id=__codelineno-70-20 name=__codelineno-70-20></a><a href=#__codelineno-70-20><span class=linenos data-linenos="20 "></span></a>         <span class=n>transcoderRegistry</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>registeredResourceClass</span><span class=p>,</span> <span class=n>registeredTranscodeClass</span><span class=p>);</span>
<a id=__codelineno-70-21 name=__codelineno-70-21></a><a href=#__codelineno-70-21><span class=linenos data-linenos="21 "></span></a>     <span class=c1>// 4</span>
<a id=__codelineno-70-22 name=__codelineno-70-22></a><a href=#__codelineno-70-22><span class=linenos data-linenos="22 "></span></a>     <span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;PMD.AvoidInstantiatingObjectsInLoops&quot;</span><span class=p>)</span>
<a id=__codelineno-70-23 name=__codelineno-70-23></a><a href=#__codelineno-70-23><span class=linenos data-linenos="23 "></span></a>     <span class=n>DecodePath</span><span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span> <span class=n>TResource</span><span class=p>,</span> <span class=n>Transcode</span><span class=o>&gt;</span> <span class=n>path</span> <span class=o>=</span>
<a id=__codelineno-70-24 name=__codelineno-70-24></a><a href=#__codelineno-70-24><span class=linenos data-linenos="24 "></span></a>         <span class=k>new</span> <span class=n>DecodePath</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>dataClass</span><span class=p>,</span> <span class=n>registeredResourceClass</span><span class=p>,</span> <span class=n>registeredTranscodeClass</span><span class=p>,</span>
<a id=__codelineno-70-25 name=__codelineno-70-25></a><a href=#__codelineno-70-25><span class=linenos data-linenos="25 "></span></a>             <span class=n>decoders</span><span class=p>,</span> <span class=n>transcoder</span><span class=p>,</span> <span class=n>throwableListPool</span><span class=p>);</span>
<a id=__codelineno-70-26 name=__codelineno-70-26></a><a href=#__codelineno-70-26><span class=linenos data-linenos="26 "></span></a>     <span class=n>decodePaths</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>path</span><span class=p>);</span>
<a id=__codelineno-70-27 name=__codelineno-70-27></a><a href=#__codelineno-70-27><span class=linenos data-linenos="27 "></span></a>   <span class=p>}</span>
<a id=__codelineno-70-28 name=__codelineno-70-28></a><a href=#__codelineno-70-28><span class=linenos data-linenos="28 "></span></a> <span class=p>}</span>
<a id=__codelineno-70-29 name=__codelineno-70-29></a><a href=#__codelineno-70-29><span class=linenos data-linenos="29 "></span></a> <span class=k>return</span> <span class=n>decodePaths</span><span class=p>;</span>
<a id=__codelineno-70-30 name=__codelineno-70-30></a><a href=#__codelineno-70-30><span class=linenos data-linenos="30 "></span></a><span class=p>}</span>
</code></pre></div> <p>é¦–å…ˆå°±æ˜¯<code>decoderRegistry.getResourceClasses(dataClass, resourceClass)</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æˆ‘ä»¬ä¸Šé¢åˆ†æè¿‡ï¼Œä½œç”¨å°±æ˜¯æ ¹æ®ä¼ å…¥çš„dataClassä»¥åŠresourceClassåœ¨Registryä¸­æ‰¾æ˜ å°„å…³ç³»ï¼Œå¦‚æœå¯ä»¥æ‰¾åˆ°å°±è¿”å›è¿™æ¡æ˜ å°„å…³ç³»çš„resourceClassï¼ˆè¯¥æ–¹æ³•ä¸­dataClassä¸ºä¼ å…¥çš„fetcher.dataClassï¼ŒresourceClasså€¼ä¸ºObject.classï¼‰ã€‚</p> <p>ç„¶åå¯¹äºæ¯ä¸ªè·å–åˆ°çš„registeredResourceClassï¼Œè°ƒç”¨<code>transcoderRegistry.getTranscodeClasses</code>æ–¹æ³•ï¼Œæ­¤æ–¹æ³•ä¹‹å‰ä¹Ÿè§£æè¿‡ï¼Œå…¶ä½œç”¨æ˜¯æ ¹æ®resourceClasså’ŒtranscodeClassï¼Œä»è‡ªèº«æˆ–è€…æ³¨å†Œè¡¨çš„â€œmapâ€ä¸­æ‰¾å‡ºtranscodeClassï¼ˆå‚æ•°transcodeClassä¸º<code>Drawable.class</code>ï¼‰ã€‚</p> <p>æœ€åï¼Œå¯¹äºæ¯ä¸ªregisteredResourceClasså’ŒregisteredTranscodeClassï¼Œéƒ½ä¼šè·å–å…¶<code>ResourceDecoder</code>å’Œ<code>ResourceTranscoder</code>ï¼Œå¹¶å°†è¿™äº›å‚æ•°ç»„æˆä¸€ä¸ª<code>DecodePath</code>ä¿å­˜åˆ°listï¼Œæœ€åè¿”å›ã€‚æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹è¿™äº›æ–¹æ³•çš„å®ç°ï¼Œæœ€ååœ¨ç»™å‡ºæ¯ä¸€æ­¥çš„æ“ä½œç»“æœã€‚</p> <p>æ‰€ä»¥æˆ‘ä»¬ç›´æ¥çœ‹<code>decoderRegistry.getDecoders</code>æ–¹æ³•ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-71-1 name=__codelineno-71-1></a><a href=#__codelineno-71-1><span class=linenos data-linenos=" 1 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-71-2 name=__codelineno-71-2></a><a href=#__codelineno-71-2><span class=linenos data-linenos=" 2 "></span></a><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;unchecked&quot;</span><span class=p>)</span>
<a id=__codelineno-71-3 name=__codelineno-71-3></a><a href=#__codelineno-71-3><span class=linenos data-linenos=" 3 "></span></a><span class=kd>public</span> <span class=kd>synchronized</span> <span class=o>&lt;</span><span class=n>T</span><span class=p>,</span> <span class=n>R</span><span class=o>&gt;</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>ResourceDecoder</span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span> <span class=n>R</span><span class=o>&gt;&gt;</span> <span class=nf>getDecoders</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>T</span><span class=o>&gt;</span> <span class=n>dataClass</span><span class=p>,</span>
<a id=__codelineno-71-4 name=__codelineno-71-4></a><a href=#__codelineno-71-4><span class=linenos data-linenos=" 4 "></span></a>   <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>resourceClass</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-71-5 name=__codelineno-71-5></a><a href=#__codelineno-71-5><span class=linenos data-linenos=" 5 "></span></a> <span class=n>List</span><span class=o>&lt;</span><span class=n>ResourceDecoder</span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span> <span class=n>R</span><span class=o>&gt;&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span>
<a id=__codelineno-71-6 name=__codelineno-71-6></a><a href=#__codelineno-71-6><span class=linenos data-linenos=" 6 "></span></a> <span class=k>for</span> <span class=p>(</span><span class=n>String</span> <span class=n>bucket</span> <span class=p>:</span> <span class=n>bucketPriorityList</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-71-7 name=__codelineno-71-7></a><a href=#__codelineno-71-7><span class=linenos data-linenos=" 7 "></span></a>   <span class=n>List</span><span class=o>&lt;</span><span class=n>Entry</span><span class=o>&lt;?</span><span class=p>,</span> <span class=o>?&gt;&gt;</span> <span class=n>entries</span> <span class=o>=</span> <span class=n>decoders</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>bucket</span><span class=p>);</span>
<a id=__codelineno-71-8 name=__codelineno-71-8></a><a href=#__codelineno-71-8><span class=linenos data-linenos=" 8 "></span></a>   <span class=k>if</span> <span class=p>(</span><span class=n>entries</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-71-9 name=__codelineno-71-9></a><a href=#__codelineno-71-9><span class=linenos data-linenos=" 9 "></span></a>     <span class=k>continue</span><span class=p>;</span>
<a id=__codelineno-71-10 name=__codelineno-71-10></a><a href=#__codelineno-71-10><span class=linenos data-linenos="10 "></span></a>   <span class=p>}</span>
<a id=__codelineno-71-11 name=__codelineno-71-11></a><a href=#__codelineno-71-11><span class=linenos data-linenos="11 "></span></a>   <span class=k>for</span> <span class=p>(</span><span class=n>Entry</span><span class=o>&lt;?</span><span class=p>,</span> <span class=o>?&gt;</span> <span class=n>entry</span> <span class=p>:</span> <span class=n>entries</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-71-12 name=__codelineno-71-12></a><a href=#__codelineno-71-12><span class=linenos data-linenos="12 "></span></a>     <span class=k>if</span> <span class=p>(</span><span class=n>entry</span><span class=p>.</span><span class=na>handles</span><span class=p>(</span><span class=n>dataClass</span><span class=p>,</span> <span class=n>resourceClass</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-71-13 name=__codelineno-71-13></a><a href=#__codelineno-71-13><span class=linenos data-linenos="13 "></span></a>       <span class=n>result</span><span class=p>.</span><span class=na>add</span><span class=p>((</span><span class=n>ResourceDecoder</span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span> <span class=n>R</span><span class=o>&gt;</span><span class=p>)</span> <span class=n>entry</span><span class=p>.</span><span class=na>decoder</span><span class=p>);</span>
<a id=__codelineno-71-14 name=__codelineno-71-14></a><a href=#__codelineno-71-14><span class=linenos data-linenos="14 "></span></a>     <span class=p>}</span>
<a id=__codelineno-71-15 name=__codelineno-71-15></a><a href=#__codelineno-71-15><span class=linenos data-linenos="15 "></span></a>   <span class=p>}</span>
<a id=__codelineno-71-16 name=__codelineno-71-16></a><a href=#__codelineno-71-16><span class=linenos data-linenos="16 "></span></a> <span class=p>}</span>
<a id=__codelineno-71-17 name=__codelineno-71-17></a><a href=#__codelineno-71-17><span class=linenos data-linenos="17 "></span></a> <span class=c1>// TODO: cache result list.</span>
<a id=__codelineno-71-18 name=__codelineno-71-18></a><a href=#__codelineno-71-18><span class=linenos data-linenos="18 "></span></a>
<a id=__codelineno-71-19 name=__codelineno-71-19></a><a href=#__codelineno-71-19><span class=linenos data-linenos="19 "></span></a> <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
<a id=__codelineno-71-20 name=__codelineno-71-20></a><a href=#__codelineno-71-20><span class=linenos data-linenos="20 "></span></a><span class=p>}</span>
</code></pre></div> <p>è¯¥æ–¹æ³•ä¹Ÿéå¸¸ç®€å•ï¼Œé‚£å°±æ˜¯éå†æ‰€æœ‰çš„bucketä¸­çš„æ‰€æœ‰entryï¼Œæ‰¾å‡ºæ‰€æœ‰èƒ½å¤„ç†dataClassã€resourceClassçš„entryï¼Œä¿å­˜å…¶decoderã€‚</p> <p>æœ€åçœ‹ä¸€ä¸‹<code>transcoderRegistry.get</code>æ–¹æ³•ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-72-1 name=__codelineno-72-1></a><a href=#__codelineno-72-1><span class=linenos data-linenos=" 1 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-72-2 name=__codelineno-72-2></a><a href=#__codelineno-72-2><span class=linenos data-linenos=" 2 "></span></a><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;unchecked&quot;</span><span class=p>)</span>
<a id=__codelineno-72-3 name=__codelineno-72-3></a><a href=#__codelineno-72-3><span class=linenos data-linenos=" 3 "></span></a><span class=kd>public</span> <span class=kd>synchronized</span> <span class=o>&lt;</span><span class=n>Z</span><span class=p>,</span> <span class=n>R</span><span class=o>&gt;</span> <span class=n>ResourceTranscoder</span><span class=o>&lt;</span><span class=n>Z</span><span class=p>,</span> <span class=n>R</span><span class=o>&gt;</span> <span class=nf>get</span><span class=p>(</span>
<a id=__codelineno-72-4 name=__codelineno-72-4></a><a href=#__codelineno-72-4><span class=linenos data-linenos=" 4 "></span></a>   <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>resourceClass</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Class</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>transcodedClass</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-72-5 name=__codelineno-72-5></a><a href=#__codelineno-72-5><span class=linenos data-linenos=" 5 "></span></a> <span class=c1>// For example, there may be a transcoder that can convert a GifDrawable to a Drawable, which</span>
<a id=__codelineno-72-6 name=__codelineno-72-6></a><a href=#__codelineno-72-6><span class=linenos data-linenos=" 6 "></span></a> <span class=c1>// will be caught above. However, if there is no registered transcoder, we can still just use</span>
<a id=__codelineno-72-7 name=__codelineno-72-7></a><a href=#__codelineno-72-7><span class=linenos data-linenos=" 7 "></span></a> <span class=c1>// the UnitTranscoder to return the Drawable because the transcode class (Drawable) is</span>
<a id=__codelineno-72-8 name=__codelineno-72-8></a><a href=#__codelineno-72-8><span class=linenos data-linenos=" 8 "></span></a> <span class=c1>// assignable from the resource class (GifDrawable).</span>
<a id=__codelineno-72-9 name=__codelineno-72-9></a><a href=#__codelineno-72-9><span class=linenos data-linenos=" 9 "></span></a> <span class=k>if</span> <span class=p>(</span><span class=n>transcodedClass</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>resourceClass</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-72-10 name=__codelineno-72-10></a><a href=#__codelineno-72-10><span class=linenos data-linenos="10 "></span></a>   <span class=k>return</span> <span class=p>(</span><span class=n>ResourceTranscoder</span><span class=o>&lt;</span><span class=n>Z</span><span class=p>,</span> <span class=n>R</span><span class=o>&gt;</span><span class=p>)</span> <span class=n>UnitTranscoder</span><span class=p>.</span><span class=na>get</span><span class=p>();</span>
<a id=__codelineno-72-11 name=__codelineno-72-11></a><a href=#__codelineno-72-11><span class=linenos data-linenos="11 "></span></a> <span class=p>}</span>
<a id=__codelineno-72-12 name=__codelineno-72-12></a><a href=#__codelineno-72-12><span class=linenos data-linenos="12 "></span></a> <span class=k>for</span> <span class=p>(</span><span class=n>Entry</span><span class=o>&lt;?</span><span class=p>,</span> <span class=o>?&gt;</span> <span class=n>entry</span> <span class=p>:</span> <span class=n>transcoders</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-72-13 name=__codelineno-72-13></a><a href=#__codelineno-72-13><span class=linenos data-linenos="13 "></span></a>   <span class=k>if</span> <span class=p>(</span><span class=n>entry</span><span class=p>.</span><span class=na>handles</span><span class=p>(</span><span class=n>resourceClass</span><span class=p>,</span> <span class=n>transcodedClass</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-72-14 name=__codelineno-72-14></a><a href=#__codelineno-72-14><span class=linenos data-linenos="14 "></span></a>     <span class=k>return</span> <span class=p>(</span><span class=n>ResourceTranscoder</span><span class=o>&lt;</span><span class=n>Z</span><span class=p>,</span> <span class=n>R</span><span class=o>&gt;</span><span class=p>)</span> <span class=n>entry</span><span class=p>.</span><span class=na>transcoder</span><span class=p>;</span>
<a id=__codelineno-72-15 name=__codelineno-72-15></a><a href=#__codelineno-72-15><span class=linenos data-linenos="15 "></span></a>   <span class=p>}</span>
<a id=__codelineno-72-16 name=__codelineno-72-16></a><a href=#__codelineno-72-16><span class=linenos data-linenos="16 "></span></a> <span class=p>}</span>
<a id=__codelineno-72-17 name=__codelineno-72-17></a><a href=#__codelineno-72-17><span class=linenos data-linenos="17 "></span></a>
<a id=__codelineno-72-18 name=__codelineno-72-18></a><a href=#__codelineno-72-18><span class=linenos data-linenos="18 "></span></a> <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=p>(</span>
<a id=__codelineno-72-19 name=__codelineno-72-19></a><a href=#__codelineno-72-19><span class=linenos data-linenos="19 "></span></a>     <span class=s>&quot;No transcoder registered to transcode from &quot;</span> <span class=o>+</span> <span class=n>resourceClass</span> <span class=o>+</span> <span class=s>&quot; to &quot;</span> <span class=o>+</span> <span class=n>transcodedClass</span><span class=p>);</span>
<a id=__codelineno-72-20 name=__codelineno-72-20></a><a href=#__codelineno-72-20><span class=linenos data-linenos="20 "></span></a><span class=p>}</span>
</code></pre></div> <p>è¯¥æ–¹æ³•é€»è¾‘å’Œæˆ‘ä»¬ä¹‹å‰è°ˆåˆ°è¿‡çš„<code>transcoderRegistry.getTranscodeClasses</code>æ–¹æ³•ç±»ä¼¼ï¼Œåªä¸è¿‡è¿”å›çš„æ˜¯å¯¹åº”çš„<code>transcoder</code>å¯¹è±¡ã€‚</p> <p>äº†è§£åˆ°ä¸Šé¢è¿™äº›æ–¹æ³•çš„ä½œç”¨åï¼Œæˆ‘ä»¬åˆ—å‡º<code>Registry.getDecodePaths</code>æ–¹æ³•æ‰§è¡Œçš„æ­¥éª¤ä»¥åŠç»“æœï¼ˆdataClassä¸ºä¸‹é¢çš„fetcher.dataClassï¼ŒresourceClassä¸ºObject.classï¼ŒtranscodeClassä¸ºDrawable.classï¼‰ï¼š</p> <ul> <li><code>ByteBufferFileLoader</code><br> fetcher = <code>ByteBufferFetcher(file)</code><br> fetcher.dataClass = <code>ByteBuffer.class</code><br> 1 registeredResourceClasses = <code>[GifDrawable.class, Bitmap.class, BitmapDrawable.class]</code><br> 2 registeredTranscodeClasses = <code>[[Drawable.class], [Drawable.class], [Drawable.class]]</code><br> 3 decoders = <code>[[ByteBufferGifDecoder], [ByteBufferBitmapDecoder], [BitmapDrawableDecoder]]</code><br> 4 transcoder = <code>[UnitTranscoder, BitmapDrawableTranscoder, UnitTranscoder]</code><br> 5 decodePaths = <code>[DecodePath(ByteBuffer.class, GifDrawable.class, Drawable.class, [ByteBufferGifDecoder], UnitTranscoder), DecodePath(ByteBuffer.class, Bitmap.class, Drawable.class, [ByteBufferBitmapDecoder], BitmapDrawableTranscoder), DecodePath(ByteBuffer.class, BitmapDrawable.class, Drawable.class, [BitmapDrawableDecoder], UnitTranscoder)]</code><br> 6 loadPath = <code>LoadPath(ByteBuffer.class, Object.class, Drawable.class, decodePaths)</code> </li> </ul> <p>åœ¨<code>ByteBufferFileLoader</code>ä¸­ï¼Œæˆ‘ä»¬å·²ç»æ‰¾åˆ°ä¸€ä¸ªä¸€æ¡å¯ä»¥åŠ è½½çš„è·¯å¾„ï¼Œé‚£ä¹ˆå°±è°ƒç”¨æ­¤<code>fetcher.loadData</code>æ–¹æ³•è¿›è¡ŒåŠ è½½ã€‚åŒæ—¶ï¼Œè¯¥æ–¹æ³•<code>ResourceCacheGenerator.startNext</code>è¿”å›trueï¼Œè¿™å°±æ„å‘³ç€<code>DecodeJob</code>æ— éœ€åœ¨å°è¯•å¦å¤–çš„<code>DataFetcherGenerator</code>è¿›è¡ŒåŠ è½½ï¼Œæ•´ä¸ª<code>into</code>è¿‡ç¨‹å·²ç»å¤§è‡´å®Œæˆï¼Œå‰©ä¸‹çš„å°±æ˜¯ç­‰å¾…èµ„æºåŠ è½½å®Œæ¯•åè§¦å‘å›è°ƒå³å¯ã€‚</p> <p>ä¸‹é¢æˆ‘ä»¬æ¥ç€çœ‹çœ‹<code>loadData.fetcher.loadData(helper.getPriority(), this)</code>è¿™æ¡è¯­å¥å¹²äº†ä»€ä¹ˆï¼Œåœ¨ä¸Šé¢çš„åˆ†æä¸­æˆ‘ä»¬çŸ¥é“ï¼Œè¿™é‡Œçš„fetcheræ˜¯<code>ByteBufferFetcher</code>å¯¹è±¡ï¼Œå…¶loadDataæ–¹æ³•å¦‚ä¸‹ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-73-1 name=__codelineno-73-1></a><a href=#__codelineno-73-1><span class=linenos data-linenos=" 1 "></span></a><span class=nd>@Override</span>
<a id=__codelineno-73-2 name=__codelineno-73-2></a><a href=#__codelineno-73-2><span class=linenos data-linenos=" 2 "></span></a><span class=kd>public</span> <span class=kt>void</span> <span class=nf>loadData</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Priority</span> <span class=n>priority</span><span class=p>,</span>
<a id=__codelineno-73-3 name=__codelineno-73-3></a><a href=#__codelineno-73-3><span class=linenos data-linenos=" 3 "></span></a>   <span class=nd>@NonNull</span> <span class=n>DataCallback</span><span class=o>&lt;?</span> <span class=kd>super</span> <span class=n>ByteBuffer</span><span class=o>&gt;</span> <span class=n>callback</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-73-4 name=__codelineno-73-4></a><a href=#__codelineno-73-4><span class=linenos data-linenos=" 4 "></span></a> <span class=n>ByteBuffer</span> <span class=n>result</span><span class=p>;</span>
<a id=__codelineno-73-5 name=__codelineno-73-5></a><a href=#__codelineno-73-5><span class=linenos data-linenos=" 5 "></span></a> <span class=k>try</span> <span class=p>{</span>
<a id=__codelineno-73-6 name=__codelineno-73-6></a><a href=#__codelineno-73-6><span class=linenos data-linenos=" 6 "></span></a>   <span class=c1>// è¿™é‡Œçš„fileå°±æ˜¯ç¼“å­˜ä¸‹æ¥çš„source file</span>
<a id=__codelineno-73-7 name=__codelineno-73-7></a><a href=#__codelineno-73-7><span class=linenos data-linenos=" 7 "></span></a>   <span class=c1>// è·¯å¾„åœ¨demoä¸­ä¸º /data/data/yorek.demoandtest/cache/image_manager_disk_cache/65a6e0855da59221f073aba07dc6c69206834ef83f60c58062bee458fcac7dde.0</span>
<a id=__codelineno-73-8 name=__codelineno-73-8></a><a href=#__codelineno-73-8><span class=linenos data-linenos=" 8 "></span></a>   <span class=n>result</span> <span class=o>=</span> <span class=n>ByteBufferUtil</span><span class=p>.</span><span class=na>fromFile</span><span class=p>(</span><span class=n>file</span><span class=p>);</span>
<a id=__codelineno-73-9 name=__codelineno-73-9></a><a href=#__codelineno-73-9><span class=linenos data-linenos=" 9 "></span></a> <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>IOException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-73-10 name=__codelineno-73-10></a><a href=#__codelineno-73-10><span class=linenos data-linenos="10 "></span></a>   <span class=k>if</span> <span class=p>(</span><span class=n>Log</span><span class=p>.</span><span class=na>isLoggable</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=n>Log</span><span class=p>.</span><span class=na>DEBUG</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-73-11 name=__codelineno-73-11></a><a href=#__codelineno-73-11><span class=linenos data-linenos="11 "></span></a>     <span class=n>Log</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s>&quot;Failed to obtain ByteBuffer for file&quot;</span><span class=p>,</span> <span class=n>e</span><span class=p>);</span>
<a id=__codelineno-73-12 name=__codelineno-73-12></a><a href=#__codelineno-73-12><span class=linenos data-linenos="12 "></span></a>   <span class=p>}</span>
<a id=__codelineno-73-13 name=__codelineno-73-13></a><a href=#__codelineno-73-13><span class=linenos data-linenos="13 "></span></a>   <span class=n>callback</span><span class=p>.</span><span class=na>onLoadFailed</span><span class=p>(</span><span class=n>e</span><span class=p>);</span>
<a id=__codelineno-73-14 name=__codelineno-73-14></a><a href=#__codelineno-73-14><span class=linenos data-linenos="14 "></span></a>   <span class=k>return</span><span class=p>;</span>
<a id=__codelineno-73-15 name=__codelineno-73-15></a><a href=#__codelineno-73-15><span class=linenos data-linenos="15 "></span></a> <span class=p>}</span>
<a id=__codelineno-73-16 name=__codelineno-73-16></a><a href=#__codelineno-73-16><span class=linenos data-linenos="16 "></span></a>
<a id=__codelineno-73-17 name=__codelineno-73-17></a><a href=#__codelineno-73-17><span class=linenos data-linenos="17 "></span></a> <span class=n>callback</span><span class=p>.</span><span class=na>onDataReady</span><span class=p>(</span><span class=n>result</span><span class=p>);</span>
<a id=__codelineno-73-18 name=__codelineno-73-18></a><a href=#__codelineno-73-18><span class=linenos data-linenos="18 "></span></a><span class=p>}</span>
</code></pre></div> <p><code>ByteBufferUtil.fromFile</code>ä½¿ç”¨äº†<code>RandomAccessFile</code>å’Œ<code>FileChannel</code>è¿›è¡Œæ–‡ä»¶æ“ä½œã€‚å¦‚æœæ“ä½œå¤±è´¥ï¼Œè°ƒç”¨<code>callback.onLoadFailed(e)</code>é€šçŸ¥<code>ResourceCacheGenerator</code>ç±»ï¼Œè¯¥ç±»ä¼šå°†æ“ä½œè½¬å‘ç»™<code>DecodeJob</code>ï¼›<code>callback.onDataReady</code>æ“ä½œç±»ä¼¼ã€‚è¿™æ ·ç¨‹åºå°±å›åˆ°äº†<code>DecodeJob</code>å›è°ƒæ–¹æ³•ä¸­äº†ã€‚</p> <p>æˆ‘ä»¬æš‚æ—¶ä¸ç»§ç»­åˆ†æ<code>DecodeJob</code>çš„å›è°ƒæ–¹æ³•ï¼Œå› ä¸ºåœ¨æœ¬èŠ‚ä¸­ç¼“å­˜æ–‡ä»¶æœ¬æ¥æ˜¯æ²¡æœ‰çš„ï¼Œæ‰€ä»¥ä¼šäº¤ç»™ä¸‹ä¸€ä¸ª<code>DataFetcherGenerator</code>è¿›è¡Œå°è¯•å¤„ç†ï¼Œæ‰€ä»¥åé¢è‚¯å®šä¹Ÿä¼šé‡åˆ°<code>DecodeJob</code>çš„å›è°ƒæ–¹æ³•ã€‚ </p> <h3 id=37-datacachegenerator>3.7 DataCacheGenerator<a class=headerlink href=#37-datacachegenerator title="Anchor link to this section for reference">&para;</a></h3> <p>ç”±äº<code>Glide-with-load-into</code>ä¸‰æ­¥æ²¡æœ‰åœ¨<code>ResourceCacheGenerator</code>ä¸­è¢«fetchï¼Œæ‰€ä»¥å›åˆ°<code>DecodeJob.runGenerators</code>æ–¹æ³•ä¸­ï¼Œç»§ç»­æ‰§è¡Œwhileå¾ªç¯ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-74-1 name=__codelineno-74-1></a><a href=#__codelineno-74-1><span class=linenos data-linenos=" 1 "></span></a><span class=kd>private</span> <span class=kt>void</span> <span class=nf>runGenerators</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-74-2 name=__codelineno-74-2></a><a href=#__codelineno-74-2><span class=linenos data-linenos=" 2 "></span></a>  <span class=n>currentThread</span> <span class=o>=</span> <span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>();</span>
<a id=__codelineno-74-3 name=__codelineno-74-3></a><a href=#__codelineno-74-3><span class=linenos data-linenos=" 3 "></span></a>  <span class=n>startFetchTime</span> <span class=o>=</span> <span class=n>LogTime</span><span class=p>.</span><span class=na>getLogTime</span><span class=p>();</span>
<a id=__codelineno-74-4 name=__codelineno-74-4></a><a href=#__codelineno-74-4><span class=linenos data-linenos=" 4 "></span></a>  <span class=kt>boolean</span> <span class=n>isStarted</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
<a id=__codelineno-74-5 name=__codelineno-74-5></a><a href=#__codelineno-74-5><span class=linenos data-linenos=" 5 "></span></a>  <span class=k>while</span> <span class=p>(</span><span class=o>!</span><span class=n>isCancelled</span> <span class=o>&amp;&amp;</span> <span class=n>currentGenerator</span> <span class=o>!=</span> <span class=kc>null</span>
<a id=__codelineno-74-6 name=__codelineno-74-6></a><a href=#__codelineno-74-6><span class=linenos data-linenos=" 6 "></span></a>      <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=p>(</span><span class=n>isStarted</span> <span class=o>=</span> <span class=n>currentGenerator</span><span class=p>.</span><span class=na>startNext</span><span class=p>()))</span> <span class=p>{</span>
<a id=__codelineno-74-7 name=__codelineno-74-7></a><a href=#__codelineno-74-7><span class=linenos data-linenos=" 7 "></span></a>    <span class=n>stage</span> <span class=o>=</span> <span class=n>getNextStage</span><span class=p>(</span><span class=n>stage</span><span class=p>);</span>
<a id=__codelineno-74-8 name=__codelineno-74-8></a><a href=#__codelineno-74-8><span class=linenos data-linenos=" 8 "></span></a>    <span class=n>currentGenerator</span> <span class=o>=</span> <span class=n>getNextGenerator</span><span class=p>();</span>
<a id=__codelineno-74-9 name=__codelineno-74-9></a><a href=#__codelineno-74-9><span class=linenos data-linenos=" 9 "></span></a>
<a id=__codelineno-74-10 name=__codelineno-74-10></a><a href=#__codelineno-74-10><span class=linenos data-linenos="10 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>stage</span> <span class=o>==</span> <span class=n>Stage</span><span class=p>.</span><span class=na>SOURCE</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-74-11 name=__codelineno-74-11></a><a href=#__codelineno-74-11><span class=linenos data-linenos="11 "></span></a>      <span class=n>reschedule</span><span class=p>();</span>
<a id=__codelineno-74-12 name=__codelineno-74-12></a><a href=#__codelineno-74-12><span class=linenos data-linenos="12 "></span></a>      <span class=k>return</span><span class=p>;</span>
<a id=__codelineno-74-13 name=__codelineno-74-13></a><a href=#__codelineno-74-13><span class=linenos data-linenos="13 "></span></a>    <span class=p>}</span>
<a id=__codelineno-74-14 name=__codelineno-74-14></a><a href=#__codelineno-74-14><span class=linenos data-linenos="14 "></span></a>  <span class=p>}</span>
<a id=__codelineno-74-15 name=__codelineno-74-15></a><a href=#__codelineno-74-15><span class=linenos data-linenos="15 "></span></a>  <span class=c1>// We&#39;ve run out of stages and generators, give up.</span>
<a id=__codelineno-74-16 name=__codelineno-74-16></a><a href=#__codelineno-74-16><span class=linenos data-linenos="16 "></span></a>  <span class=k>if</span> <span class=p>((</span><span class=n>stage</span> <span class=o>==</span> <span class=n>Stage</span><span class=p>.</span><span class=na>FINISHED</span> <span class=o>||</span> <span class=n>isCancelled</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>isStarted</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-74-17 name=__codelineno-74-17></a><a href=#__codelineno-74-17><span class=linenos data-linenos="17 "></span></a>    <span class=n>notifyFailed</span><span class=p>();</span>
<a id=__codelineno-74-18 name=__codelineno-74-18></a><a href=#__codelineno-74-18><span class=linenos data-linenos="18 "></span></a>  <span class=p>}</span>
<a id=__codelineno-74-19 name=__codelineno-74-19></a><a href=#__codelineno-74-19><span class=linenos data-linenos="19 "></span></a>
<a id=__codelineno-74-20 name=__codelineno-74-20></a><a href=#__codelineno-74-20><span class=linenos data-linenos="20 "></span></a>  <span class=c1>// Otherwise a generator started a new load and we expect to be called back in</span>
<a id=__codelineno-74-21 name=__codelineno-74-21></a><a href=#__codelineno-74-21><span class=linenos data-linenos="21 "></span></a>  <span class=c1>// onDataFetcherReady.</span>
<a id=__codelineno-74-22 name=__codelineno-74-22></a><a href=#__codelineno-74-22><span class=linenos data-linenos="22 "></span></a><span class=p>}</span>
</code></pre></div> <p>ç”±äº<code>diskCacheStrategy</code>é»˜è®¤ä¸º<code>DiskCacheStrategy.AUTOMATIC</code>ï¼Œå…¶<code>decodeCachedData()</code>è¿”å›trueï¼Œæ‰€ä»¥<code>getNextStage(stage)</code>æ˜¯<code>Stage.DATA_CACHE</code>ã€‚å› æ­¤<code>getNextGenerator()</code>æ–¹æ³•è¿”å›äº†<code>DataCacheGenerator(decodeHelper, this)</code>ã€‚ç„¶ååœ¨whileå¾ªç¯ä¸­ä¼šæ‰§è¡Œå…¶<code>startNext()</code>æ–¹æ³•ã€‚</p> <div class="admonition success"> <p class=admonition-title>Success</p> <p>æœ‰äº†åœ¨<code>ResourceCacheGenerator</code>ä¸­ç¼“å­˜å¥½çš„å¤§é‡å˜é‡ï¼Œ<code>DataCacheGenerator</code>å’Œ<code>SourceGenerator</code>ä»£ç å°±éå¸¸ç®€å•äº†ã€‚</p> </div> <p><code>ResourceCacheGenerator</code>åœ¨æ„é€ çš„æ—¶å€™å°±å°†<code>helper.getCacheKeys()</code>ä¿å­˜äº†èµ·æ¥ï¼Œæˆ‘ä»¬å‰é¢åœ¨è°ˆ<code>ResourceCacheGenerator</code>çš„æ—¶å€™æåˆ°è¿‡ï¼Œ<code>helper.getCacheKeys()</code>é‡‡å–äº†é˜²æ­¢é‡å¤åŠ è½½çš„ç­–ç•¥ã€‚</p> <p>æ„é€ å™¨ç›¸å…³ä»£ç å¦‚ä¸‹ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-75-1 name=__codelineno-75-1></a><a href=#__codelineno-75-1><span class=linenos data-linenos=" 1 "></span></a><span class=kd>private</span> <span class=kd>final</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Key</span><span class=o>&gt;</span> <span class=n>cacheKeys</span><span class=p>;</span>
<a id=__codelineno-75-2 name=__codelineno-75-2></a><a href=#__codelineno-75-2><span class=linenos data-linenos=" 2 "></span></a><span class=kd>private</span> <span class=kd>final</span> <span class=n>DecodeHelper</span><span class=o>&lt;?&gt;</span> <span class=n>helper</span><span class=p>;</span>
<a id=__codelineno-75-3 name=__codelineno-75-3></a><a href=#__codelineno-75-3><span class=linenos data-linenos=" 3 "></span></a><span class=kd>private</span> <span class=kd>final</span> <span class=n>FetcherReadyCallback</span> <span class=n>cb</span><span class=p>;</span>
<a id=__codelineno-75-4 name=__codelineno-75-4></a><a href=#__codelineno-75-4><span class=linenos data-linenos=" 4 "></span></a>
<a id=__codelineno-75-5 name=__codelineno-75-5></a><a href=#__codelineno-75-5><span class=linenos data-linenos=" 5 "></span></a><span class=n>DataCacheGenerator</span><span class=p>(</span><span class=n>DecodeHelper</span><span class=o>&lt;?&gt;</span> <span class=n>helper</span><span class=p>,</span> <span class=n>FetcherReadyCallback</span> <span class=n>cb</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-75-6 name=__codelineno-75-6></a><a href=#__codelineno-75-6><span class=linenos data-linenos=" 6 "></span></a>  <span class=k>this</span><span class=p>(</span><span class=n>helper</span><span class=p>.</span><span class=na>getCacheKeys</span><span class=p>(),</span> <span class=n>helper</span><span class=p>,</span> <span class=n>cb</span><span class=p>);</span>
<a id=__codelineno-75-7 name=__codelineno-75-7></a><a href=#__codelineno-75-7><span class=linenos data-linenos=" 7 "></span></a><span class=p>}</span>
<a id=__codelineno-75-8 name=__codelineno-75-8></a><a href=#__codelineno-75-8><span class=linenos data-linenos=" 8 "></span></a>
<a id=__codelineno-75-9 name=__codelineno-75-9></a><a href=#__codelineno-75-9><span class=linenos data-linenos=" 9 "></span></a><span class=n>DataCacheGenerator</span><span class=p>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>Key</span><span class=o>&gt;</span> <span class=n>cacheKeys</span><span class=p>,</span> <span class=n>DecodeHelper</span><span class=o>&lt;?&gt;</span> <span class=n>helper</span><span class=p>,</span> <span class=n>FetcherReadyCallback</span> <span class=n>cb</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-75-10 name=__codelineno-75-10></a><a href=#__codelineno-75-10><span class=linenos data-linenos="10 "></span></a>  <span class=k>this</span><span class=p>.</span><span class=na>cacheKeys</span> <span class=o>=</span> <span class=n>cacheKeys</span><span class=p>;</span>
<a id=__codelineno-75-11 name=__codelineno-75-11></a><a href=#__codelineno-75-11><span class=linenos data-linenos="11 "></span></a>  <span class=k>this</span><span class=p>.</span><span class=na>helper</span> <span class=o>=</span> <span class=n>helper</span><span class=p>;</span>
<a id=__codelineno-75-12 name=__codelineno-75-12></a><a href=#__codelineno-75-12><span class=linenos data-linenos="12 "></span></a>  <span class=k>this</span><span class=p>.</span><span class=na>cb</span> <span class=o>=</span> <span class=n>cb</span><span class=p>;</span>
<a id=__codelineno-75-13 name=__codelineno-75-13></a><a href=#__codelineno-75-13><span class=linenos data-linenos="13 "></span></a><span class=p>}</span>
</code></pre></div> <p>ç„¶åçœ‹ä¸€ä¸‹å®ƒçš„<code>startNext()</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å’Œ<code>ResourceCacheGenerator.startNext</code>æ–¹æ³•éå¸¸ç›¸ä¼¼ï¼Œç”±äºè·å–çš„æ˜¯åŸå§‹çš„æºæ•°æ®ï¼Œæ‰€ä»¥è¿™é‡Œçš„keyçš„ç»„æˆéå¸¸ç®€å•ã€‚</p> <div class=highlight><pre><span></span><code><a id=__codelineno-76-1 name=__codelineno-76-1></a><a href=#__codelineno-76-1><span class=linenos data-linenos=" 1 "></span></a><span class=nd>@Override</span>
<a id=__codelineno-76-2 name=__codelineno-76-2></a><a href=#__codelineno-76-2><span class=linenos data-linenos=" 2 "></span></a><span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>startNext</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-76-3 name=__codelineno-76-3></a><a href=#__codelineno-76-3><span class=linenos data-linenos=" 3 "></span></a>  <span class=k>while</span> <span class=p>(</span><span class=n>modelLoaders</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=o>!</span><span class=n>hasNextModelLoader</span><span class=p>())</span> <span class=p>{</span>
<a id=__codelineno-76-4 name=__codelineno-76-4></a><a href=#__codelineno-76-4><span class=linenos data-linenos=" 4 "></span></a>    <span class=n>sourceIdIndex</span><span class=o>++</span><span class=p>;</span>
<a id=__codelineno-76-5 name=__codelineno-76-5></a><a href=#__codelineno-76-5><span class=linenos data-linenos=" 5 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>sourceIdIndex</span> <span class=o>&gt;=</span> <span class=n>cacheKeys</span><span class=p>.</span><span class=na>size</span><span class=p>())</span> <span class=p>{</span>
<a id=__codelineno-76-6 name=__codelineno-76-6></a><a href=#__codelineno-76-6><span class=linenos data-linenos=" 6 "></span></a>      <span class=k>return</span> <span class=kc>false</span><span class=p>;</span>
<a id=__codelineno-76-7 name=__codelineno-76-7></a><a href=#__codelineno-76-7><span class=linenos data-linenos=" 7 "></span></a>    <span class=p>}</span>
<a id=__codelineno-76-8 name=__codelineno-76-8></a><a href=#__codelineno-76-8><span class=linenos data-linenos=" 8 "></span></a>
<a id=__codelineno-76-9 name=__codelineno-76-9></a><a href=#__codelineno-76-9><span class=linenos data-linenos=" 9 "></span></a>    <span class=n>Key</span> <span class=n>sourceId</span> <span class=o>=</span> <span class=n>cacheKeys</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>sourceIdIndex</span><span class=p>);</span>
<a id=__codelineno-76-10 name=__codelineno-76-10></a><a href=#__codelineno-76-10><span class=linenos data-linenos="10 "></span></a>    <span class=c1>// PMD.AvoidInstantiatingObjectsInLoops The loop iterates a limited number of times</span>
<a id=__codelineno-76-11 name=__codelineno-76-11></a><a href=#__codelineno-76-11><span class=linenos data-linenos="11 "></span></a>    <span class=c1>// and the actions it performs are much more expensive than a single allocation.</span>
<a id=__codelineno-76-12 name=__codelineno-76-12></a><a href=#__codelineno-76-12><span class=linenos data-linenos="12 "></span></a>    <span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;PMD.AvoidInstantiatingObjectsInLoops&quot;</span><span class=p>)</span>
<a id=__codelineno-76-13 name=__codelineno-76-13></a><a href=#__codelineno-76-13><span class=linenos data-linenos="13 "></span></a>    <span class=n>Key</span> <span class=n>originalKey</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DataCacheKey</span><span class=p>(</span><span class=n>sourceId</span><span class=p>,</span> <span class=n>helper</span><span class=p>.</span><span class=na>getSignature</span><span class=p>());</span>
<a id=__codelineno-76-14 name=__codelineno-76-14></a><a href=#__codelineno-76-14><span class=linenos data-linenos="14 "></span></a>    <span class=n>cacheFile</span> <span class=o>=</span> <span class=n>helper</span><span class=p>.</span><span class=na>getDiskCache</span><span class=p>().</span><span class=na>get</span><span class=p>(</span><span class=n>originalKey</span><span class=p>);</span>
<a id=__codelineno-76-15 name=__codelineno-76-15></a><a href=#__codelineno-76-15><span class=linenos data-linenos="15 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>cacheFile</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-76-16 name=__codelineno-76-16></a><a href=#__codelineno-76-16><span class=linenos data-linenos="16 "></span></a>      <span class=k>this</span><span class=p>.</span><span class=na>sourceKey</span> <span class=o>=</span> <span class=n>sourceId</span><span class=p>;</span>
<a id=__codelineno-76-17 name=__codelineno-76-17></a><a href=#__codelineno-76-17><span class=linenos data-linenos="17 "></span></a>      <span class=n>modelLoaders</span> <span class=o>=</span> <span class=n>helper</span><span class=p>.</span><span class=na>getModelLoaders</span><span class=p>(</span><span class=n>cacheFile</span><span class=p>);</span>
<a id=__codelineno-76-18 name=__codelineno-76-18></a><a href=#__codelineno-76-18><span class=linenos data-linenos="18 "></span></a>      <span class=n>modelLoaderIndex</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
<a id=__codelineno-76-19 name=__codelineno-76-19></a><a href=#__codelineno-76-19><span class=linenos data-linenos="19 "></span></a>    <span class=p>}</span>
<a id=__codelineno-76-20 name=__codelineno-76-20></a><a href=#__codelineno-76-20><span class=linenos data-linenos="20 "></span></a>  <span class=p>}</span>
<a id=__codelineno-76-21 name=__codelineno-76-21></a><a href=#__codelineno-76-21><span class=linenos data-linenos="21 "></span></a>
<a id=__codelineno-76-22 name=__codelineno-76-22></a><a href=#__codelineno-76-22><span class=linenos data-linenos="22 "></span></a>  <span class=n>loadData</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-76-23 name=__codelineno-76-23></a><a href=#__codelineno-76-23><span class=linenos data-linenos="23 "></span></a>  <span class=kt>boolean</span> <span class=n>started</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
<a id=__codelineno-76-24 name=__codelineno-76-24></a><a href=#__codelineno-76-24><span class=linenos data-linenos="24 "></span></a>  <span class=k>while</span> <span class=p>(</span><span class=o>!</span><span class=n>started</span> <span class=o>&amp;&amp;</span> <span class=n>hasNextModelLoader</span><span class=p>())</span> <span class=p>{</span>
<a id=__codelineno-76-25 name=__codelineno-76-25></a><a href=#__codelineno-76-25><span class=linenos data-linenos="25 "></span></a>    <span class=n>ModelLoader</span><span class=o>&lt;</span><span class=n>File</span><span class=p>,</span> <span class=o>?&gt;</span> <span class=n>modelLoader</span> <span class=o>=</span> <span class=n>modelLoaders</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>modelLoaderIndex</span><span class=o>++</span><span class=p>);</span>
<a id=__codelineno-76-26 name=__codelineno-76-26></a><a href=#__codelineno-76-26><span class=linenos data-linenos="26 "></span></a>    <span class=n>loadData</span> <span class=o>=</span>
<a id=__codelineno-76-27 name=__codelineno-76-27></a><a href=#__codelineno-76-27><span class=linenos data-linenos="27 "></span></a>        <span class=n>modelLoader</span><span class=p>.</span><span class=na>buildLoadData</span><span class=p>(</span><span class=n>cacheFile</span><span class=p>,</span> <span class=n>helper</span><span class=p>.</span><span class=na>getWidth</span><span class=p>(),</span> <span class=n>helper</span><span class=p>.</span><span class=na>getHeight</span><span class=p>(),</span>
<a id=__codelineno-76-28 name=__codelineno-76-28></a><a href=#__codelineno-76-28><span class=linenos data-linenos="28 "></span></a>            <span class=n>helper</span><span class=p>.</span><span class=na>getOptions</span><span class=p>());</span>
<a id=__codelineno-76-29 name=__codelineno-76-29></a><a href=#__codelineno-76-29><span class=linenos data-linenos="29 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>loadData</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>helper</span><span class=p>.</span><span class=na>hasLoadPath</span><span class=p>(</span><span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>getDataClass</span><span class=p>()))</span> <span class=p>{</span>
<a id=__codelineno-76-30 name=__codelineno-76-30></a><a href=#__codelineno-76-30><span class=linenos data-linenos="30 "></span></a>      <span class=n>started</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
<a id=__codelineno-76-31 name=__codelineno-76-31></a><a href=#__codelineno-76-31><span class=linenos data-linenos="31 "></span></a>      <span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>loadData</span><span class=p>(</span><span class=n>helper</span><span class=p>.</span><span class=na>getPriority</span><span class=p>(),</span> <span class=k>this</span><span class=p>);</span>
<a id=__codelineno-76-32 name=__codelineno-76-32></a><a href=#__codelineno-76-32><span class=linenos data-linenos="32 "></span></a>    <span class=p>}</span>
<a id=__codelineno-76-33 name=__codelineno-76-33></a><a href=#__codelineno-76-33><span class=linenos data-linenos="33 "></span></a>  <span class=p>}</span>
<a id=__codelineno-76-34 name=__codelineno-76-34></a><a href=#__codelineno-76-34><span class=linenos data-linenos="34 "></span></a>  <span class=k>return</span> <span class=n>started</span><span class=p>;</span>
<a id=__codelineno-76-35 name=__codelineno-76-35></a><a href=#__codelineno-76-35><span class=linenos data-linenos="35 "></span></a><span class=p>}</span>
<a id=__codelineno-76-36 name=__codelineno-76-36></a><a href=#__codelineno-76-36><span class=linenos data-linenos="36 "></span></a>
<a id=__codelineno-76-37 name=__codelineno-76-37></a><a href=#__codelineno-76-37><span class=linenos data-linenos="37 "></span></a><span class=kd>private</span> <span class=kt>boolean</span> <span class=nf>hasNextModelLoader</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-76-38 name=__codelineno-76-38></a><a href=#__codelineno-76-38><span class=linenos data-linenos="38 "></span></a>  <span class=k>return</span> <span class=n>modelLoaderIndex</span> <span class=o>&lt;</span> <span class=n>modelLoaders</span><span class=p>.</span><span class=na>size</span><span class=p>();</span>
<a id=__codelineno-76-39 name=__codelineno-76-39></a><a href=#__codelineno-76-39><span class=linenos data-linenos="39 "></span></a><span class=p>}</span>
</code></pre></div> <p>ç”±äºæˆ‘ä»¬ç¬¬ä¸€æ¬¡åŠ è½½ï¼Œæœ¬åœ°ç¼“å­˜æ–‡ä»¶è‚¯å®šæ˜¯æ²¡æœ‰çš„ã€‚æˆ‘ä»¬æ¥ç€çœ‹æœ€åä¸€ä¸ª<code>SourceGenerator</code>ï¼Œçœ‹çœ‹å®ƒæ˜¯å¦‚ä½•è·å–æ•°æ®çš„ã€‚</p> <h3 id=38-sourcegenerator>3.8 SourceGenerator<a class=headerlink href=#38-sourcegenerator title="Anchor link to this section for reference">&para;</a></h3> <p>åœ¨è¿™ä¹‹å‰æˆ‘ä»¬éœ€è¦æ³¨æ„ï¼Œå¦‚æœGlideåœ¨åŠ è½½æ—¶æŒ‡å®šäº†<code>.onlyRetrieveFromCache(true)</code>ï¼Œé‚£ä¹ˆåœ¨<code>DecodeJob.getNextStage(Stage)</code>æ–¹æ³•ä¸­å°±ä¼šè·³è¿‡<code>Stage.SOURCE</code>ç›´æ¥åˆ°è¾¾<code>Stage.FINISHED</code>ã€‚<br> ä¸”å½“ä¸º<code>Stage.SOURCE</code>æ—¶ï¼Œ<code>DecodeJob.runGenerators()</code>æ–¹æ³•ä¼šè°ƒç”¨<code>reschedule()</code>æ–¹æ³•ï¼Œè¿™å°†ä¼šå¯¼è‡´<code>DecodeJob</code>é‡æ–°è¢«æäº¤åˆ°<code>sourceExecutor</code>è¿™ä¸ªçº¿ç¨‹æ± ä¸­ï¼ŒåŒæ—¶runReasonè¢«èµ‹å€¼ä¸º<code>RunReason.SWITCH_TO_SOURCE_SERVICE</code>ã€‚è¯¥çº¿ç¨‹æ± é»˜è®¤å®ç°ä¸º<code>GlideExecutor.newSourceExecutor()</code>:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-77-1 name=__codelineno-77-1></a><a href=#__codelineno-77-1><span class=linenos data-linenos=" 1 "></span></a><span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>MAXIMUM_AUTOMATIC_THREAD_COUNT</span> <span class=o>=</span> <span class=mi>4</span><span class=p>;</span>
<a id=__codelineno-77-2 name=__codelineno-77-2></a><a href=#__codelineno-77-2><span class=linenos data-linenos=" 2 "></span></a><span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>DEFAULT_SOURCE_EXECUTOR_NAME</span> <span class=o>=</span> <span class=s>&quot;source&quot;</span><span class=p>;</span>
<a id=__codelineno-77-3 name=__codelineno-77-3></a><a href=#__codelineno-77-3><span class=linenos data-linenos=" 3 "></span></a>
<a id=__codelineno-77-4 name=__codelineno-77-4></a><a href=#__codelineno-77-4><span class=linenos data-linenos=" 4 "></span></a><span class=kd>public</span> <span class=kd>static</span> <span class=n>GlideExecutor</span> <span class=nf>newSourceExecutor</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-77-5 name=__codelineno-77-5></a><a href=#__codelineno-77-5><span class=linenos data-linenos=" 5 "></span></a>  <span class=k>return</span> <span class=n>newSourceExecutor</span><span class=p>(</span>
<a id=__codelineno-77-6 name=__codelineno-77-6></a><a href=#__codelineno-77-6><span class=linenos data-linenos=" 6 "></span></a>      <span class=n>calculateBestThreadCount</span><span class=p>(),</span>
<a id=__codelineno-77-7 name=__codelineno-77-7></a><a href=#__codelineno-77-7><span class=linenos data-linenos=" 7 "></span></a>      <span class=n>DEFAULT_SOURCE_EXECUTOR_NAME</span><span class=p>,</span>
<a id=__codelineno-77-8 name=__codelineno-77-8></a><a href=#__codelineno-77-8><span class=linenos data-linenos=" 8 "></span></a>      <span class=n>UncaughtThrowableStrategy</span><span class=p>.</span><span class=na>DEFAULT</span><span class=p>);</span>
<a id=__codelineno-77-9 name=__codelineno-77-9></a><a href=#__codelineno-77-9><span class=linenos data-linenos=" 9 "></span></a><span class=p>}</span>
<a id=__codelineno-77-10 name=__codelineno-77-10></a><a href=#__codelineno-77-10><span class=linenos data-linenos="10 "></span></a>
<a id=__codelineno-77-11 name=__codelineno-77-11></a><a href=#__codelineno-77-11><span class=linenos data-linenos="11 "></span></a><span class=kd>public</span> <span class=kd>static</span> <span class=kt>int</span> <span class=nf>calculateBestThreadCount</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-77-12 name=__codelineno-77-12></a><a href=#__codelineno-77-12><span class=linenos data-linenos="12 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>bestThreadCount</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-77-13 name=__codelineno-77-13></a><a href=#__codelineno-77-13><span class=linenos data-linenos="13 "></span></a>    <span class=n>bestThreadCount</span> <span class=o>=</span>
<a id=__codelineno-77-14 name=__codelineno-77-14></a><a href=#__codelineno-77-14><span class=linenos data-linenos="14 "></span></a>        <span class=n>Math</span><span class=p>.</span><span class=na>min</span><span class=p>(</span><span class=n>MAXIMUM_AUTOMATIC_THREAD_COUNT</span><span class=p>,</span> <span class=n>RuntimeCompat</span><span class=p>.</span><span class=na>availableProcessors</span><span class=p>());</span>
<a id=__codelineno-77-15 name=__codelineno-77-15></a><a href=#__codelineno-77-15><span class=linenos data-linenos="15 "></span></a>  <span class=p>}</span>
<a id=__codelineno-77-16 name=__codelineno-77-16></a><a href=#__codelineno-77-16><span class=linenos data-linenos="16 "></span></a>  <span class=k>return</span> <span class=n>bestThreadCount</span><span class=p>;</span>
<a id=__codelineno-77-17 name=__codelineno-77-17></a><a href=#__codelineno-77-17><span class=linenos data-linenos="17 "></span></a><span class=p>}</span>
</code></pre></div> <p>ç”±äº<code>DecodeJob</code>å®ç°äº†<code>Runnable</code>æ¥å£ï¼Œé‚£ä¹ˆç›´æ¥çœ‹<code>run()</code>æ–¹æ³•é‡Œé¢çš„çœŸæ­£å®ç°<code>runWrapped()</code>æ–¹æ³•ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-78-1 name=__codelineno-78-1></a><a href=#__codelineno-78-1><span class=linenos data-linenos="1 "></span></a><span class=kd>private</span> <span class=kt>void</span> <span class=nf>runWrapped</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-78-2 name=__codelineno-78-2></a><a href=#__codelineno-78-2><span class=linenos data-linenos="2 "></span></a>  <span class=k>switch</span> <span class=p>(</span><span class=n>runReason</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-78-3 name=__codelineno-78-3></a><a href=#__codelineno-78-3><span class=linenos data-linenos="3 "></span></a>    <span class=p>...</span>
<a id=__codelineno-78-4 name=__codelineno-78-4></a><a href=#__codelineno-78-4><span class=linenos data-linenos="4 "></span></a>    <span class=k>case</span> <span class=n>SWITCH_TO_SOURCE_SERVICE</span><span class=p>:</span>
<a id=__codelineno-78-5 name=__codelineno-78-5></a><a href=#__codelineno-78-5><span class=linenos data-linenos="5 "></span></a>      <span class=n>runGenerators</span><span class=p>();</span>
<a id=__codelineno-78-6 name=__codelineno-78-6></a><a href=#__codelineno-78-6><span class=linenos data-linenos="6 "></span></a>      <span class=k>break</span><span class=p>;</span>
<a id=__codelineno-78-7 name=__codelineno-78-7></a><a href=#__codelineno-78-7><span class=linenos data-linenos="7 "></span></a>  <span class=p>}</span>
<a id=__codelineno-78-8 name=__codelineno-78-8></a><a href=#__codelineno-78-8><span class=linenos data-linenos="8 "></span></a><span class=p>}</span>
</code></pre></div> <p>è¿™é‡Œè¿˜æ˜¯æ‰§è¡Œäº†<code>runGenerators()</code>æ–¹æ³•ã€‚è¯¥æ–¹æ³•æˆ‘ä»¬å·²ç»å¾ˆç†Ÿæ‚‰äº†ï¼Œåœ¨è¿™é‡Œä¼šæ‰§è¡Œ<code>SourceGenerator.startNext()</code>æ–¹æ³•ã€‚ </p> <div class=highlight><pre><span></span><code><a id=__codelineno-79-1 name=__codelineno-79-1></a><a href=#__codelineno-79-1><span class=linenos data-linenos=" 1 "></span></a><span class=kd>private</span> <span class=kt>int</span> <span class=n>loadDataListIndex</span><span class=p>;</span>
<a id=__codelineno-79-2 name=__codelineno-79-2></a><a href=#__codelineno-79-2><span class=linenos data-linenos=" 2 "></span></a>
<a id=__codelineno-79-3 name=__codelineno-79-3></a><a href=#__codelineno-79-3><span class=linenos data-linenos=" 3 "></span></a><span class=nd>@Override</span>
<a id=__codelineno-79-4 name=__codelineno-79-4></a><a href=#__codelineno-79-4><span class=linenos data-linenos=" 4 "></span></a><span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>startNext</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-79-5 name=__codelineno-79-5></a><a href=#__codelineno-79-5><span class=linenos data-linenos=" 5 "></span></a>  <span class=c1>// é¦–æ¬¡è¿è¡ŒdataToCacheä¸ºnull</span>
<a id=__codelineno-79-6 name=__codelineno-79-6></a><a href=#__codelineno-79-6><span class=linenos data-linenos=" 6 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>dataToCache</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-79-7 name=__codelineno-79-7></a><a href=#__codelineno-79-7><span class=linenos data-linenos=" 7 "></span></a>    <span class=n>Object</span> <span class=n>data</span> <span class=o>=</span> <span class=n>dataToCache</span><span class=p>;</span>
<a id=__codelineno-79-8 name=__codelineno-79-8></a><a href=#__codelineno-79-8><span class=linenos data-linenos=" 8 "></span></a>    <span class=n>dataToCache</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-79-9 name=__codelineno-79-9></a><a href=#__codelineno-79-9><span class=linenos data-linenos=" 9 "></span></a>    <span class=n>cacheData</span><span class=p>(</span><span class=n>data</span><span class=p>);</span>
<a id=__codelineno-79-10 name=__codelineno-79-10></a><a href=#__codelineno-79-10><span class=linenos data-linenos="10 "></span></a>  <span class=p>}</span>
<a id=__codelineno-79-11 name=__codelineno-79-11></a><a href=#__codelineno-79-11><span class=linenos data-linenos="11 "></span></a>
<a id=__codelineno-79-12 name=__codelineno-79-12></a><a href=#__codelineno-79-12><span class=linenos data-linenos="12 "></span></a>  <span class=c1>// é¦–æ¬¡è¿è¡ŒsourceCacheGeneratorä¸ºnull</span>
<a id=__codelineno-79-13 name=__codelineno-79-13></a><a href=#__codelineno-79-13><span class=linenos data-linenos="13 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>sourceCacheGenerator</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>sourceCacheGenerator</span><span class=p>.</span><span class=na>startNext</span><span class=p>())</span> <span class=p>{</span>
<a id=__codelineno-79-14 name=__codelineno-79-14></a><a href=#__codelineno-79-14><span class=linenos data-linenos="14 "></span></a>    <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
<a id=__codelineno-79-15 name=__codelineno-79-15></a><a href=#__codelineno-79-15><span class=linenos data-linenos="15 "></span></a>  <span class=p>}</span>
<a id=__codelineno-79-16 name=__codelineno-79-16></a><a href=#__codelineno-79-16><span class=linenos data-linenos="16 "></span></a>  <span class=n>sourceCacheGenerator</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-79-17 name=__codelineno-79-17></a><a href=#__codelineno-79-17><span class=linenos data-linenos="17 "></span></a>
<a id=__codelineno-79-18 name=__codelineno-79-18></a><a href=#__codelineno-79-18><span class=linenos data-linenos="18 "></span></a>  <span class=c1>// å‡†å¤‡åŠ è½½æ•°æ®</span>
<a id=__codelineno-79-19 name=__codelineno-79-19></a><a href=#__codelineno-79-19><span class=linenos data-linenos="19 "></span></a>  <span class=n>loadData</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-79-20 name=__codelineno-79-20></a><a href=#__codelineno-79-20><span class=linenos data-linenos="20 "></span></a>  <span class=kt>boolean</span> <span class=n>started</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
<a id=__codelineno-79-21 name=__codelineno-79-21></a><a href=#__codelineno-79-21><span class=linenos data-linenos="21 "></span></a>  <span class=c1>// è¿™é‡Œç›´æ¥è°ƒç”¨äº†DecodeHelper.getLoadData()æ–¹æ³•</span>
<a id=__codelineno-79-22 name=__codelineno-79-22></a><a href=#__codelineno-79-22><span class=linenos data-linenos="22 "></span></a>  <span class=c1>// è¯¥æ–¹æ³•åœ¨å‰é¢åœ¨ResourceCacheGeneratorä¸­è¢«è°ƒç”¨è¿‡ï¼Œä¸”è¢«ç¼“å­˜äº†ä¸‹æ¥</span>
<a id=__codelineno-79-23 name=__codelineno-79-23></a><a href=#__codelineno-79-23><span class=linenos data-linenos="23 "></span></a>  <span class=k>while</span> <span class=p>(</span><span class=o>!</span><span class=n>started</span> <span class=o>&amp;&amp;</span> <span class=n>hasNextModelLoader</span><span class=p>())</span> <span class=p>{</span>
<a id=__codelineno-79-24 name=__codelineno-79-24></a><a href=#__codelineno-79-24><span class=linenos data-linenos="24 "></span></a>    <span class=n>loadData</span> <span class=o>=</span> <span class=n>helper</span><span class=p>.</span><span class=na>getLoadData</span><span class=p>().</span><span class=na>get</span><span class=p>(</span><span class=n>loadDataListIndex</span><span class=o>++</span><span class=p>);</span>
<a id=__codelineno-79-25 name=__codelineno-79-25></a><a href=#__codelineno-79-25><span class=linenos data-linenos="25 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>loadData</span> <span class=o>!=</span> <span class=kc>null</span>
<a id=__codelineno-79-26 name=__codelineno-79-26></a><a href=#__codelineno-79-26><span class=linenos data-linenos="26 "></span></a>        <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>helper</span><span class=p>.</span><span class=na>getDiskCacheStrategy</span><span class=p>().</span><span class=na>isDataCacheable</span><span class=p>(</span><span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>getDataSource</span><span class=p>())</span>
<a id=__codelineno-79-27 name=__codelineno-79-27></a><a href=#__codelineno-79-27><span class=linenos data-linenos="27 "></span></a>        <span class=o>||</span> <span class=n>helper</span><span class=p>.</span><span class=na>hasLoadPath</span><span class=p>(</span><span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>getDataClass</span><span class=p>())))</span> <span class=p>{</span>
<a id=__codelineno-79-28 name=__codelineno-79-28></a><a href=#__codelineno-79-28><span class=linenos data-linenos="28 "></span></a>      <span class=n>started</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
<a id=__codelineno-79-29 name=__codelineno-79-29></a><a href=#__codelineno-79-29><span class=linenos data-linenos="29 "></span></a>      <span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>loadData</span><span class=p>(</span><span class=n>helper</span><span class=p>.</span><span class=na>getPriority</span><span class=p>(),</span> <span class=k>this</span><span class=p>);</span>
<a id=__codelineno-79-30 name=__codelineno-79-30></a><a href=#__codelineno-79-30><span class=linenos data-linenos="30 "></span></a>    <span class=p>}</span>
<a id=__codelineno-79-31 name=__codelineno-79-31></a><a href=#__codelineno-79-31><span class=linenos data-linenos="31 "></span></a>  <span class=p>}</span>
<a id=__codelineno-79-32 name=__codelineno-79-32></a><a href=#__codelineno-79-32><span class=linenos data-linenos="32 "></span></a>  <span class=k>return</span> <span class=n>started</span><span class=p>;</span>
<a id=__codelineno-79-33 name=__codelineno-79-33></a><a href=#__codelineno-79-33><span class=linenos data-linenos="33 "></span></a><span class=p>}</span>
<a id=__codelineno-79-34 name=__codelineno-79-34></a><a href=#__codelineno-79-34><span class=linenos data-linenos="34 "></span></a>
<a id=__codelineno-79-35 name=__codelineno-79-35></a><a href=#__codelineno-79-35><span class=linenos data-linenos="35 "></span></a><span class=kd>private</span> <span class=kt>boolean</span> <span class=nf>hasNextModelLoader</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-79-36 name=__codelineno-79-36></a><a href=#__codelineno-79-36><span class=linenos data-linenos="36 "></span></a>  <span class=k>return</span> <span class=n>loadDataListIndex</span> <span class=o>&lt;</span> <span class=n>helper</span><span class=p>.</span><span class=na>getLoadData</span><span class=p>().</span><span class=na>size</span><span class=p>();</span>
<a id=__codelineno-79-37 name=__codelineno-79-37></a><a href=#__codelineno-79-37><span class=linenos data-linenos="37 "></span></a><span class=p>}</span>
</code></pre></div> <p><code>helper.getLoadData()</code>çš„å€¼åœ¨<code>ResourceCacheGenerator</code>ä¸­å°±å·²ç»è¢«è·å–å¹¶ç¼“å­˜ä¸‹æ¥äº†ï¼Œè¿™æ˜¯ä¸€ä¸ª<code>MultiModelLoader</code>å¯¹è±¡ç”Ÿæˆçš„<code>LoadData</code>å¯¹è±¡ï¼Œ<code>LoadData</code>å¯¹è±¡é‡Œé¢æœ‰ä¸¤ä¸ªfetcherã€‚è¯¦è§<a href=/android/3rd-library/glide2/#361-helpergetcachekeys>ç¬¬3.6.1èŠ‚çš„æœ«å°¾éƒ¨åˆ†</a></p> <p>åœ¨ä¸Šé¢çš„æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬ä¼šéå†LoadData listï¼Œæ‰¾å‡ºç¬¦åˆæ¡ä»¶çš„LoadDataï¼Œç„¶åè°ƒç”¨<code>loadData.fetcher.loadData</code>åŠ è½½æ•°æ®ã€‚<br> åœ¨loadDataä¸ä¸ºç©ºçš„å‰æä¸‹ï¼Œä¼šåˆ¤æ–­Glideçš„ç¼“å­˜ç­–ç•¥æ˜¯å¦å¯ä»¥ç¼“å­˜æ­¤æ•°æ®æºï¼Œæˆ–è€…æ˜¯å¦æœ‰åŠ è½½è·¯å¾„ã€‚ </p> <p>æˆ‘ä»¬çŸ¥é“ï¼Œé»˜è®¤æƒ…å†µä¸‹Glideçš„ç¼“å­˜ç­–ç•¥æ˜¯<code>DiskCacheStrategy.AUTOMATIC</code>ï¼Œå…¶<code>isDataCacheable</code>å®ç°å¦‚ä¸‹ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-80-1 name=__codelineno-80-1></a><a href=#__codelineno-80-1><span class=linenos data-linenos="1 "></span></a><span class=nd>@Override</span>
<a id=__codelineno-80-2 name=__codelineno-80-2></a><a href=#__codelineno-80-2><span class=linenos data-linenos="2 "></span></a><span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>isDataCacheable</span><span class=p>(</span><span class=n>DataSource</span> <span class=n>dataSource</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-80-3 name=__codelineno-80-3></a><a href=#__codelineno-80-3><span class=linenos data-linenos="3 "></span></a>  <span class=k>return</span> <span class=n>dataSource</span> <span class=o>==</span> <span class=n>DataSource</span><span class=p>.</span><span class=na>REMOTE</span><span class=p>;</span>
<a id=__codelineno-80-4 name=__codelineno-80-4></a><a href=#__codelineno-80-4><span class=linenos data-linenos="4 "></span></a><span class=p>}</span>
</code></pre></div> <p>æ‰€ä»¥ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹<code>loadData.fetcher.getDataSource()</code>è¿”å›äº†ä»€ä¹ˆï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-81-1 name=__codelineno-81-1></a><a href=#__codelineno-81-1><span class=linenos data-linenos=" 1 "></span></a><span class=kd>static</span> <span class=kd>class</span> <span class=nc>MultiFetcher</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=kd>implements</span> <span class=n>DataFetcher</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span><span class=p>,</span> <span class=n>DataCallback</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=p>{</span>
<a id=__codelineno-81-2 name=__codelineno-81-2></a><a href=#__codelineno-81-2><span class=linenos data-linenos=" 2 "></span></a>  <span class=nd>@NonNull</span>
<a id=__codelineno-81-3 name=__codelineno-81-3></a><a href=#__codelineno-81-3><span class=linenos data-linenos=" 3 "></span></a>  <span class=nd>@Override</span>
<a id=__codelineno-81-4 name=__codelineno-81-4></a><a href=#__codelineno-81-4><span class=linenos data-linenos=" 4 "></span></a>  <span class=kd>public</span> <span class=n>DataSource</span> <span class=nf>getDataSource</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-81-5 name=__codelineno-81-5></a><a href=#__codelineno-81-5><span class=linenos data-linenos=" 5 "></span></a>    <span class=k>return</span> <span class=n>fetchers</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=mi>0</span><span class=p>).</span><span class=na>getDataSource</span><span class=p>();</span>
<a id=__codelineno-81-6 name=__codelineno-81-6></a><a href=#__codelineno-81-6><span class=linenos data-linenos=" 6 "></span></a>  <span class=p>}</span>
<a id=__codelineno-81-7 name=__codelineno-81-7></a><a href=#__codelineno-81-7><span class=linenos data-linenos=" 7 "></span></a><span class=p>}</span>
<a id=__codelineno-81-8 name=__codelineno-81-8></a><a href=#__codelineno-81-8><span class=linenos data-linenos=" 8 "></span></a>
<a id=__codelineno-81-9 name=__codelineno-81-9></a><a href=#__codelineno-81-9><span class=linenos data-linenos=" 9 "></span></a><span class=c1>// MultiFetcherä¸­fetchersæ•°ç»„ä¿å­˜çš„ä¸¤ä¸ªDataFetcheréƒ½æ˜¯HttpUrlFetcher</span>
<a id=__codelineno-81-10 name=__codelineno-81-10></a><a href=#__codelineno-81-10><span class=linenos data-linenos="10 "></span></a><span class=kd>public</span> <span class=kd>class</span> <span class=nc>HttpUrlFetcher</span> <span class=kd>implements</span> <span class=n>DataFetcher</span><span class=o>&lt;</span><span class=n>InputStream</span><span class=o>&gt;</span> <span class=p>{</span>
<a id=__codelineno-81-11 name=__codelineno-81-11></a><a href=#__codelineno-81-11><span class=linenos data-linenos="11 "></span></a>  <span class=nd>@NonNull</span>
<a id=__codelineno-81-12 name=__codelineno-81-12></a><a href=#__codelineno-81-12><span class=linenos data-linenos="12 "></span></a>  <span class=nd>@Override</span>
<a id=__codelineno-81-13 name=__codelineno-81-13></a><a href=#__codelineno-81-13><span class=linenos data-linenos="13 "></span></a>  <span class=kd>public</span> <span class=n>DataSource</span> <span class=nf>getDataSource</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-81-14 name=__codelineno-81-14></a><a href=#__codelineno-81-14><span class=linenos data-linenos="14 "></span></a>  <span class=k>return</span> <span class=n>DataSource</span><span class=p>.</span><span class=na>REMOTE</span><span class=p>;</span>
<a id=__codelineno-81-15 name=__codelineno-81-15></a><a href=#__codelineno-81-15><span class=linenos data-linenos="15 "></span></a>  <span class=p>}</span>
<a id=__codelineno-81-16 name=__codelineno-81-16></a><a href=#__codelineno-81-16><span class=linenos data-linenos="16 "></span></a><span class=p>}</span>
</code></pre></div> <p>æ˜¾ç„¶ï¼ŒGlideçš„ç¼“å­˜ç­–ç•¥æ˜¯å¯ä»¥ç¼“å­˜æ­¤æ•°æ®æºçš„ã€‚æ‰€ä»¥ä¼šè¿›è¡Œæ•°æ®çš„åŠ è½½ã€‚æ¥ç€çœ‹çœ‹<code>MultiFetcher.loadData</code>æ–¹æ³•ã€‚<br> è¿™é‡Œé¦–å…ˆä¼šè°ƒç”¨å†…éƒ¨çš„ç¬¬0ä¸ªDataFetcherè¿›è¡ŒåŠ è½½ï¼ŒåŒæ—¶è®¾ç½®å›è°ƒä¸ºè‡ªå·±ã€‚å½“è¿™ä¸€ä¸ªDataFetcheråŠ è½½å¤±è´¥æ—¶ï¼Œä¼šå°è¯•è°ƒç”¨ä¸‹ä¸€ä¸ªDataFetcherè¿›è¡ŒåŠ è½½ï¼Œå¦‚æœæ²¡æœ‰æ‰€æœ‰çš„DataFetcheréƒ½åŠ è½½å¤±è´¥äº†ï¼Œå°±æŠŠé”™è¯¯æŠ›ç»™ä¸Šä¸€å±‚ï¼›å½“æœ‰DataFetcheråŠ è½½æˆåŠŸæ—¶ï¼Œä¹Ÿä¼šæŠŠè·å–åˆ°çš„æ•°æ®è½¬äº¤ç»™ä¸Šä¸€å±‚ã€‚</p> <div class=highlight><pre><span></span><code><a id=__codelineno-82-1 name=__codelineno-82-1></a><a href=#__codelineno-82-1><span class=linenos data-linenos=" 1 "></span></a><span class=kd>static</span> <span class=kd>class</span> <span class=nc>MultiFetcher</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=kd>implements</span> <span class=n>DataFetcher</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span><span class=p>,</span> <span class=n>DataCallback</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=p>{</span>
<a id=__codelineno-82-2 name=__codelineno-82-2></a><a href=#__codelineno-82-2><span class=linenos data-linenos=" 2 "></span></a>
<a id=__codelineno-82-3 name=__codelineno-82-3></a><a href=#__codelineno-82-3><span class=linenos data-linenos=" 3 "></span></a>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>DataFetcher</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;&gt;</span> <span class=n>fetchers</span><span class=p>;</span>
<a id=__codelineno-82-4 name=__codelineno-82-4></a><a href=#__codelineno-82-4><span class=linenos data-linenos=" 4 "></span></a>  <span class=kd>private</span> <span class=kt>int</span> <span class=n>currentIndex</span><span class=p>;</span>
<a id=__codelineno-82-5 name=__codelineno-82-5></a><a href=#__codelineno-82-5><span class=linenos data-linenos=" 5 "></span></a>  <span class=kd>private</span> <span class=n>Priority</span> <span class=n>priority</span><span class=p>;</span>
<a id=__codelineno-82-6 name=__codelineno-82-6></a><a href=#__codelineno-82-6><span class=linenos data-linenos=" 6 "></span></a>  <span class=kd>private</span> <span class=n>DataCallback</span><span class=o>&lt;?</span> <span class=kd>super</span> <span class=n>Data</span><span class=o>&gt;</span> <span class=n>callback</span><span class=p>;</span>
<a id=__codelineno-82-7 name=__codelineno-82-7></a><a href=#__codelineno-82-7><span class=linenos data-linenos=" 7 "></span></a>
<a id=__codelineno-82-8 name=__codelineno-82-8></a><a href=#__codelineno-82-8><span class=linenos data-linenos=" 8 "></span></a>  <span class=nd>@Override</span>
<a id=__codelineno-82-9 name=__codelineno-82-9></a><a href=#__codelineno-82-9><span class=linenos data-linenos=" 9 "></span></a>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>loadData</span><span class=p>(</span>
<a id=__codelineno-82-10 name=__codelineno-82-10></a><a href=#__codelineno-82-10><span class=linenos data-linenos="10 "></span></a>      <span class=nd>@NonNull</span> <span class=n>Priority</span> <span class=n>priority</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>DataCallback</span><span class=o>&lt;?</span> <span class=kd>super</span> <span class=n>Data</span><span class=o>&gt;</span> <span class=n>callback</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-82-11 name=__codelineno-82-11></a><a href=#__codelineno-82-11><span class=linenos data-linenos="11 "></span></a>    <span class=k>this</span><span class=p>.</span><span class=na>priority</span> <span class=o>=</span> <span class=n>priority</span><span class=p>;</span>
<a id=__codelineno-82-12 name=__codelineno-82-12></a><a href=#__codelineno-82-12><span class=linenos data-linenos="12 "></span></a>    <span class=k>this</span><span class=p>.</span><span class=na>callback</span> <span class=o>=</span> <span class=n>callback</span><span class=p>;</span>
<a id=__codelineno-82-13 name=__codelineno-82-13></a><a href=#__codelineno-82-13><span class=linenos data-linenos="13 "></span></a>    <span class=n>exceptions</span> <span class=o>=</span> <span class=n>throwableListPool</span><span class=p>.</span><span class=na>acquire</span><span class=p>();</span>
<a id=__codelineno-82-14 name=__codelineno-82-14></a><a href=#__codelineno-82-14><span class=linenos data-linenos="14 "></span></a>    <span class=n>fetchers</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>currentIndex</span><span class=p>).</span><span class=na>loadData</span><span class=p>(</span><span class=n>priority</span><span class=p>,</span> <span class=k>this</span><span class=p>);</span>
<a id=__codelineno-82-15 name=__codelineno-82-15></a><a href=#__codelineno-82-15><span class=linenos data-linenos="15 "></span></a>
<a id=__codelineno-82-16 name=__codelineno-82-16></a><a href=#__codelineno-82-16><span class=linenos data-linenos="16 "></span></a>    <span class=c1>// If a race occurred where we cancelled the fetcher in cancel() and then called loadData here</span>
<a id=__codelineno-82-17 name=__codelineno-82-17></a><a href=#__codelineno-82-17><span class=linenos data-linenos="17 "></span></a>    <span class=c1>// immediately after, make sure that we cancel the newly started fetcher. We don&#39;t bother</span>
<a id=__codelineno-82-18 name=__codelineno-82-18></a><a href=#__codelineno-82-18><span class=linenos data-linenos="18 "></span></a>    <span class=c1>// checking cancelled before loadData because it&#39;s not required for correctness and would</span>
<a id=__codelineno-82-19 name=__codelineno-82-19></a><a href=#__codelineno-82-19><span class=linenos data-linenos="19 "></span></a>    <span class=c1>// require an unlikely race to be useful.</span>
<a id=__codelineno-82-20 name=__codelineno-82-20></a><a href=#__codelineno-82-20><span class=linenos data-linenos="20 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>isCancelled</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-82-21 name=__codelineno-82-21></a><a href=#__codelineno-82-21><span class=linenos data-linenos="21 "></span></a>      <span class=n>cancel</span><span class=p>();</span>
<a id=__codelineno-82-22 name=__codelineno-82-22></a><a href=#__codelineno-82-22><span class=linenos data-linenos="22 "></span></a>    <span class=p>}</span>
<a id=__codelineno-82-23 name=__codelineno-82-23></a><a href=#__codelineno-82-23><span class=linenos data-linenos="23 "></span></a>  <span class=p>}</span>
<a id=__codelineno-82-24 name=__codelineno-82-24></a><a href=#__codelineno-82-24><span class=linenos data-linenos="24 "></span></a>
<a id=__codelineno-82-25 name=__codelineno-82-25></a><a href=#__codelineno-82-25><span class=linenos data-linenos="25 "></span></a>  <span class=nd>@Override</span>
<a id=__codelineno-82-26 name=__codelineno-82-26></a><a href=#__codelineno-82-26><span class=linenos data-linenos="26 "></span></a>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onDataReady</span><span class=p>(</span><span class=nd>@Nullable</span> <span class=n>Data</span> <span class=n>data</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-82-27 name=__codelineno-82-27></a><a href=#__codelineno-82-27><span class=linenos data-linenos="27 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>data</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-82-28 name=__codelineno-82-28></a><a href=#__codelineno-82-28><span class=linenos data-linenos="28 "></span></a>      <span class=n>callback</span><span class=p>.</span><span class=na>onDataReady</span><span class=p>(</span><span class=n>data</span><span class=p>);</span>
<a id=__codelineno-82-29 name=__codelineno-82-29></a><a href=#__codelineno-82-29><span class=linenos data-linenos="29 "></span></a>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
<a id=__codelineno-82-30 name=__codelineno-82-30></a><a href=#__codelineno-82-30><span class=linenos data-linenos="30 "></span></a>      <span class=n>startNextOrFail</span><span class=p>();</span>
<a id=__codelineno-82-31 name=__codelineno-82-31></a><a href=#__codelineno-82-31><span class=linenos data-linenos="31 "></span></a>    <span class=p>}</span>
<a id=__codelineno-82-32 name=__codelineno-82-32></a><a href=#__codelineno-82-32><span class=linenos data-linenos="32 "></span></a>  <span class=p>}</span>
<a id=__codelineno-82-33 name=__codelineno-82-33></a><a href=#__codelineno-82-33><span class=linenos data-linenos="33 "></span></a>
<a id=__codelineno-82-34 name=__codelineno-82-34></a><a href=#__codelineno-82-34><span class=linenos data-linenos="34 "></span></a>  <span class=nd>@Override</span>
<a id=__codelineno-82-35 name=__codelineno-82-35></a><a href=#__codelineno-82-35><span class=linenos data-linenos="35 "></span></a>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>onLoadFailed</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Exception</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-82-36 name=__codelineno-82-36></a><a href=#__codelineno-82-36><span class=linenos data-linenos="36 "></span></a>    <span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>exceptions</span><span class=p>).</span><span class=na>add</span><span class=p>(</span><span class=n>e</span><span class=p>);</span>
<a id=__codelineno-82-37 name=__codelineno-82-37></a><a href=#__codelineno-82-37><span class=linenos data-linenos="37 "></span></a>    <span class=n>startNextOrFail</span><span class=p>();</span>
<a id=__codelineno-82-38 name=__codelineno-82-38></a><a href=#__codelineno-82-38><span class=linenos data-linenos="38 "></span></a>  <span class=p>}</span>
<a id=__codelineno-82-39 name=__codelineno-82-39></a><a href=#__codelineno-82-39><span class=linenos data-linenos="39 "></span></a>
<a id=__codelineno-82-40 name=__codelineno-82-40></a><a href=#__codelineno-82-40><span class=linenos data-linenos="40 "></span></a>  <span class=kd>private</span> <span class=kt>void</span> <span class=nf>startNextOrFail</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-82-41 name=__codelineno-82-41></a><a href=#__codelineno-82-41><span class=linenos data-linenos="41 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>isCancelled</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-82-42 name=__codelineno-82-42></a><a href=#__codelineno-82-42><span class=linenos data-linenos="42 "></span></a>      <span class=k>return</span><span class=p>;</span>
<a id=__codelineno-82-43 name=__codelineno-82-43></a><a href=#__codelineno-82-43><span class=linenos data-linenos="43 "></span></a>    <span class=p>}</span>
<a id=__codelineno-82-44 name=__codelineno-82-44></a><a href=#__codelineno-82-44><span class=linenos data-linenos="44 "></span></a>
<a id=__codelineno-82-45 name=__codelineno-82-45></a><a href=#__codelineno-82-45><span class=linenos data-linenos="45 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>currentIndex</span> <span class=o>&lt;</span> <span class=n>fetchers</span><span class=p>.</span><span class=na>size</span><span class=p>()</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-82-46 name=__codelineno-82-46></a><a href=#__codelineno-82-46><span class=linenos data-linenos="46 "></span></a>      <span class=n>currentIndex</span><span class=o>++</span><span class=p>;</span>
<a id=__codelineno-82-47 name=__codelineno-82-47></a><a href=#__codelineno-82-47><span class=linenos data-linenos="47 "></span></a>      <span class=n>loadData</span><span class=p>(</span><span class=n>priority</span><span class=p>,</span> <span class=n>callback</span><span class=p>);</span>
<a id=__codelineno-82-48 name=__codelineno-82-48></a><a href=#__codelineno-82-48><span class=linenos data-linenos="48 "></span></a>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
<a id=__codelineno-82-49 name=__codelineno-82-49></a><a href=#__codelineno-82-49><span class=linenos data-linenos="49 "></span></a>      <span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>exceptions</span><span class=p>);</span>
<a id=__codelineno-82-50 name=__codelineno-82-50></a><a href=#__codelineno-82-50><span class=linenos data-linenos="50 "></span></a>      <span class=n>callback</span><span class=p>.</span><span class=na>onLoadFailed</span><span class=p>(</span><span class=k>new</span> <span class=n>GlideException</span><span class=p>(</span><span class=s>&quot;Fetch failed&quot;</span><span class=p>,</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>exceptions</span><span class=p>)));</span>
<a id=__codelineno-82-51 name=__codelineno-82-51></a><a href=#__codelineno-82-51><span class=linenos data-linenos="51 "></span></a>    <span class=p>}</span>
<a id=__codelineno-82-52 name=__codelineno-82-52></a><a href=#__codelineno-82-52><span class=linenos data-linenos="52 "></span></a>  <span class=p>}</span>
<a id=__codelineno-82-53 name=__codelineno-82-53></a><a href=#__codelineno-82-53><span class=linenos data-linenos="53 "></span></a><span class=p>}</span>
</code></pre></div> <p>è¿™é‡Œé¢ä¸¤ä¸ªDataFetcheréƒ½æ˜¯å‚æ•°ç›¸åŒçš„<code>HttpUrlFetcher</code>å®ä¾‹ï¼Œæˆ‘ä»¬ç›´æ¥çœ‹é‡Œé¢å¦‚ä½•ä»ç½‘ç»œåŠ è½½å›¾ç‰‡çš„ã€‚</p> <div class=highlight><pre><span></span><code><a id=__codelineno-83-1 name=__codelineno-83-1></a><a href=#__codelineno-83-1><span class=linenos data-linenos=" 1 "></span></a><span class=nd>@Override</span>
<a id=__codelineno-83-2 name=__codelineno-83-2></a><a href=#__codelineno-83-2><span class=linenos data-linenos=" 2 "></span></a><span class=kd>public</span> <span class=kt>void</span> <span class=nf>loadData</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Priority</span> <span class=n>priority</span><span class=p>,</span>
<a id=__codelineno-83-3 name=__codelineno-83-3></a><a href=#__codelineno-83-3><span class=linenos data-linenos=" 3 "></span></a>    <span class=nd>@NonNull</span> <span class=n>DataCallback</span><span class=o>&lt;?</span> <span class=kd>super</span> <span class=n>InputStream</span><span class=o>&gt;</span> <span class=n>callback</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-83-4 name=__codelineno-83-4></a><a href=#__codelineno-83-4><span class=linenos data-linenos=" 4 "></span></a>  <span class=kt>long</span> <span class=n>startTime</span> <span class=o>=</span> <span class=n>LogTime</span><span class=p>.</span><span class=na>getLogTime</span><span class=p>();</span>
<a id=__codelineno-83-5 name=__codelineno-83-5></a><a href=#__codelineno-83-5><span class=linenos data-linenos=" 5 "></span></a>  <span class=k>try</span> <span class=p>{</span>
<a id=__codelineno-83-6 name=__codelineno-83-6></a><a href=#__codelineno-83-6><span class=linenos data-linenos=" 6 "></span></a>    <span class=n>InputStream</span> <span class=n>result</span> <span class=o>=</span> <span class=n>loadDataWithRedirects</span><span class=p>(</span><span class=n>glideUrl</span><span class=p>.</span><span class=na>toURL</span><span class=p>(),</span> <span class=mi>0</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=n>glideUrl</span><span class=p>.</span><span class=na>getHeaders</span><span class=p>());</span>
<a id=__codelineno-83-7 name=__codelineno-83-7></a><a href=#__codelineno-83-7><span class=linenos data-linenos=" 7 "></span></a>    <span class=n>callback</span><span class=p>.</span><span class=na>onDataReady</span><span class=p>(</span><span class=n>result</span><span class=p>);</span>
<a id=__codelineno-83-8 name=__codelineno-83-8></a><a href=#__codelineno-83-8><span class=linenos data-linenos=" 8 "></span></a>  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>IOException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-83-9 name=__codelineno-83-9></a><a href=#__codelineno-83-9><span class=linenos data-linenos=" 9 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>Log</span><span class=p>.</span><span class=na>isLoggable</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=n>Log</span><span class=p>.</span><span class=na>DEBUG</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-83-10 name=__codelineno-83-10></a><a href=#__codelineno-83-10><span class=linenos data-linenos="10 "></span></a>      <span class=n>Log</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s>&quot;Failed to load data for url&quot;</span><span class=p>,</span> <span class=n>e</span><span class=p>);</span>
<a id=__codelineno-83-11 name=__codelineno-83-11></a><a href=#__codelineno-83-11><span class=linenos data-linenos="11 "></span></a>    <span class=p>}</span>
<a id=__codelineno-83-12 name=__codelineno-83-12></a><a href=#__codelineno-83-12><span class=linenos data-linenos="12 "></span></a>    <span class=n>callback</span><span class=p>.</span><span class=na>onLoadFailed</span><span class=p>(</span><span class=n>e</span><span class=p>);</span>
<a id=__codelineno-83-13 name=__codelineno-83-13></a><a href=#__codelineno-83-13><span class=linenos data-linenos="13 "></span></a>  <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
<a id=__codelineno-83-14 name=__codelineno-83-14></a><a href=#__codelineno-83-14><span class=linenos data-linenos="14 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>Log</span><span class=p>.</span><span class=na>isLoggable</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=n>Log</span><span class=p>.</span><span class=na>VERBOSE</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-83-15 name=__codelineno-83-15></a><a href=#__codelineno-83-15><span class=linenos data-linenos="15 "></span></a>      <span class=n>Log</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s>&quot;Finished http url fetcher fetch in &quot;</span> <span class=o>+</span> <span class=n>LogTime</span><span class=p>.</span><span class=na>getElapsedMillis</span><span class=p>(</span><span class=n>startTime</span><span class=p>));</span>
<a id=__codelineno-83-16 name=__codelineno-83-16></a><a href=#__codelineno-83-16><span class=linenos data-linenos="16 "></span></a>    <span class=p>}</span>
<a id=__codelineno-83-17 name=__codelineno-83-17></a><a href=#__codelineno-83-17><span class=linenos data-linenos="17 "></span></a>  <span class=p>}</span>
<a id=__codelineno-83-18 name=__codelineno-83-18></a><a href=#__codelineno-83-18><span class=linenos data-linenos="18 "></span></a><span class=p>}</span>
</code></pre></div> <p>å¾ˆæ˜¾ç„¶ï¼Œè¿™é‡Œå°†è¯·æ±‚æ“ä½œæ”¾åˆ°äº†<code>loadDataWithRedirects</code>æ–¹æ³•ä¸­ï¼Œç„¶åå°†è¯·æ±‚ç»“æœé€šè¿‡å›è°ƒè¿”å›ä¸Šä¸€å±‚ä¹Ÿå°±æ˜¯<code>MultiFetcher</code>ä¸­ã€‚ </p> <p><code>loadDataWithRedirects</code>ç¬¬äºŒä¸ªå‚æ•°è¡¨ç¤ºé‡å®šå‘çš„æ¬¡æ•°ï¼Œåœ¨æ–¹æ³•å†…éƒ¨é™åˆ¶äº†é‡å®šå‘å‘ç”Ÿçš„æ¬¡æ•°ä¸èƒ½è¶…è¿‡<code>MAXIMUM_REDIRECTS=5</code>æ¬¡ã€‚<br> ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯å‘ç”Ÿé‡å®šå‘å‰çš„åŸå§‹urlï¼Œç”¨æ¥ä¸å½“å‰urlåˆ¤æ–­ï¼Œæ˜¯ä¸æ˜¯é‡å®šå‘åˆ°è‡ªèº«äº†ã€‚è€Œä¸”å¯ä»¥çœ‹å‡ºï¼ŒGlideåŠ è½½ç½‘ç»œå›¾ç‰‡ä½¿ç”¨çš„æ˜¯<code>HttpUrlConnection</code>ã€‚<br> ç¬¬å››ä¸ªå‚æ•°headersé»˜è®¤ä¸º<code>Headers.DEFAULT</code>ï¼Œå°±æ˜¯ä¸€ä¸ªUser-Agentçš„key-valueå¯¹ã€‚</p> <p>ä»£ç å¦‚ä¸‹ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-84-1 name=__codelineno-84-1></a><a href=#__codelineno-84-1><span class=linenos data-linenos=" 1 "></span></a><span class=kd>private</span> <span class=n>InputStream</span> <span class=nf>loadDataWithRedirects</span><span class=p>(</span><span class=n>URL</span> <span class=n>url</span><span class=p>,</span> <span class=kt>int</span> <span class=n>redirects</span><span class=p>,</span> <span class=n>URL</span> <span class=n>lastUrl</span><span class=p>,</span>
<a id=__codelineno-84-2 name=__codelineno-84-2></a><a href=#__codelineno-84-2><span class=linenos data-linenos=" 2 "></span></a>    <span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>String</span><span class=o>&gt;</span> <span class=n>headers</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=p>{</span>
<a id=__codelineno-84-3 name=__codelineno-84-3></a><a href=#__codelineno-84-3><span class=linenos data-linenos=" 3 "></span></a>  <span class=c1>// æ£€æŸ¥é‡å®šå‘æ¬¡æ•°</span>
<a id=__codelineno-84-4 name=__codelineno-84-4></a><a href=#__codelineno-84-4><span class=linenos data-linenos=" 4 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>redirects</span> <span class=o>&gt;=</span> <span class=n>MAXIMUM_REDIRECTS</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-84-5 name=__codelineno-84-5></a><a href=#__codelineno-84-5><span class=linenos data-linenos=" 5 "></span></a>    <span class=k>throw</span> <span class=k>new</span> <span class=n>HttpException</span><span class=p>(</span><span class=s>&quot;Too many (&gt; &quot;</span> <span class=o>+</span> <span class=n>MAXIMUM_REDIRECTS</span> <span class=o>+</span> <span class=s>&quot;) redirects!&quot;</span><span class=p>);</span>
<a id=__codelineno-84-6 name=__codelineno-84-6></a><a href=#__codelineno-84-6><span class=linenos data-linenos=" 6 "></span></a>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
<a id=__codelineno-84-7 name=__codelineno-84-7></a><a href=#__codelineno-84-7><span class=linenos data-linenos=" 7 "></span></a>    <span class=c1>// Comparing the URLs using .equals performs additional network I/O and is generally broken.</span>
<a id=__codelineno-84-8 name=__codelineno-84-8></a><a href=#__codelineno-84-8><span class=linenos data-linenos=" 8 "></span></a>    <span class=c1>// See http://michaelscharf.blogspot.com/2006/11/javaneturlequals-and-hashcode-make.html.</span>
<a id=__codelineno-84-9 name=__codelineno-84-9></a><a href=#__codelineno-84-9><span class=linenos data-linenos=" 9 "></span></a>    <span class=k>try</span> <span class=p>{</span>
<a id=__codelineno-84-10 name=__codelineno-84-10></a><a href=#__codelineno-84-10><span class=linenos data-linenos="10 "></span></a>      <span class=c1>// æ£€æŸ¥æ˜¯ä¸æ˜¯é‡å®šå‘åˆ°è‡ªèº«äº†</span>
<a id=__codelineno-84-11 name=__codelineno-84-11></a><a href=#__codelineno-84-11><span class=linenos data-linenos="11 "></span></a>      <span class=k>if</span> <span class=p>(</span><span class=n>lastUrl</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>url</span><span class=p>.</span><span class=na>toURI</span><span class=p>().</span><span class=na>equals</span><span class=p>(</span><span class=n>lastUrl</span><span class=p>.</span><span class=na>toURI</span><span class=p>()))</span> <span class=p>{</span>
<a id=__codelineno-84-12 name=__codelineno-84-12></a><a href=#__codelineno-84-12><span class=linenos data-linenos="12 "></span></a>        <span class=k>throw</span> <span class=k>new</span> <span class=n>HttpException</span><span class=p>(</span><span class=s>&quot;In re-direct loop&quot;</span><span class=p>);</span>
<a id=__codelineno-84-13 name=__codelineno-84-13></a><a href=#__codelineno-84-13><span class=linenos data-linenos="13 "></span></a>
<a id=__codelineno-84-14 name=__codelineno-84-14></a><a href=#__codelineno-84-14><span class=linenos data-linenos="14 "></span></a>      <span class=p>}</span>
<a id=__codelineno-84-15 name=__codelineno-84-15></a><a href=#__codelineno-84-15><span class=linenos data-linenos="15 "></span></a>    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>URISyntaxException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-84-16 name=__codelineno-84-16></a><a href=#__codelineno-84-16><span class=linenos data-linenos="16 "></span></a>      <span class=c1>// Do nothing, this is best effort.</span>
<a id=__codelineno-84-17 name=__codelineno-84-17></a><a href=#__codelineno-84-17><span class=linenos data-linenos="17 "></span></a>    <span class=p>}</span>
<a id=__codelineno-84-18 name=__codelineno-84-18></a><a href=#__codelineno-84-18><span class=linenos data-linenos="18 "></span></a>  <span class=p>}</span>
<a id=__codelineno-84-19 name=__codelineno-84-19></a><a href=#__codelineno-84-19><span class=linenos data-linenos="19 "></span></a>
<a id=__codelineno-84-20 name=__codelineno-84-20></a><a href=#__codelineno-84-20><span class=linenos data-linenos="20 "></span></a>  <span class=c1>// connectionFactoryé»˜è®¤æ˜¯DefaultHttpUrlConnectionFactory</span>
<a id=__codelineno-84-21 name=__codelineno-84-21></a><a href=#__codelineno-84-21><span class=linenos data-linenos="21 "></span></a>  <span class=c1>// å…¶buildæ–¹æ³•å°±æ˜¯è°ƒç”¨äº†url.openConnection()</span>
<a id=__codelineno-84-22 name=__codelineno-84-22></a><a href=#__codelineno-84-22><span class=linenos data-linenos="22 "></span></a>  <span class=n>urlConnection</span> <span class=o>=</span> <span class=n>connectionFactory</span><span class=p>.</span><span class=na>build</span><span class=p>(</span><span class=n>url</span><span class=p>);</span>
<a id=__codelineno-84-23 name=__codelineno-84-23></a><a href=#__codelineno-84-23><span class=linenos data-linenos="23 "></span></a>  <span class=k>for</span> <span class=p>(</span><span class=n>Map</span><span class=p>.</span><span class=na>Entry</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span> <span class=n>String</span><span class=o>&gt;</span> <span class=n>headerEntry</span> <span class=p>:</span> <span class=n>headers</span><span class=p>.</span><span class=na>entrySet</span><span class=p>())</span> <span class=p>{</span>
<a id=__codelineno-84-24 name=__codelineno-84-24></a><a href=#__codelineno-84-24><span class=linenos data-linenos="24 "></span></a>    <span class=n>urlConnection</span><span class=p>.</span><span class=na>addRequestProperty</span><span class=p>(</span><span class=n>headerEntry</span><span class=p>.</span><span class=na>getKey</span><span class=p>(),</span> <span class=n>headerEntry</span><span class=p>.</span><span class=na>getValue</span><span class=p>());</span>
<a id=__codelineno-84-25 name=__codelineno-84-25></a><a href=#__codelineno-84-25><span class=linenos data-linenos="25 "></span></a>  <span class=p>}</span>
<a id=__codelineno-84-26 name=__codelineno-84-26></a><a href=#__codelineno-84-26><span class=linenos data-linenos="26 "></span></a>  <span class=n>urlConnection</span><span class=p>.</span><span class=na>setConnectTimeout</span><span class=p>(</span><span class=n>timeout</span><span class=p>);</span>
<a id=__codelineno-84-27 name=__codelineno-84-27></a><a href=#__codelineno-84-27><span class=linenos data-linenos="27 "></span></a>  <span class=n>urlConnection</span><span class=p>.</span><span class=na>setReadTimeout</span><span class=p>(</span><span class=n>timeout</span><span class=p>);</span>
<a id=__codelineno-84-28 name=__codelineno-84-28></a><a href=#__codelineno-84-28><span class=linenos data-linenos="28 "></span></a>  <span class=n>urlConnection</span><span class=p>.</span><span class=na>setUseCaches</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span>
<a id=__codelineno-84-29 name=__codelineno-84-29></a><a href=#__codelineno-84-29><span class=linenos data-linenos="29 "></span></a>  <span class=n>urlConnection</span><span class=p>.</span><span class=na>setDoInput</span><span class=p>(</span><span class=kc>true</span><span class=p>);</span>
<a id=__codelineno-84-30 name=__codelineno-84-30></a><a href=#__codelineno-84-30><span class=linenos data-linenos="30 "></span></a>
<a id=__codelineno-84-31 name=__codelineno-84-31></a><a href=#__codelineno-84-31><span class=linenos data-linenos="31 "></span></a>  <span class=c1>// Stop the urlConnection instance of HttpUrlConnection from following redirects so that</span>
<a id=__codelineno-84-32 name=__codelineno-84-32></a><a href=#__codelineno-84-32><span class=linenos data-linenos="32 "></span></a>  <span class=c1>// redirects will be handled by recursive calls to this method, loadDataWithRedirects.</span>
<a id=__codelineno-84-33 name=__codelineno-84-33></a><a href=#__codelineno-84-33><span class=linenos data-linenos="33 "></span></a>  <span class=c1>// ç¦æ­¢HttpUrlConnectionè‡ªåŠ¨é‡å®šå‘ï¼Œé‡å®šå‘åŠŸèƒ½ç”±æœ¬æ–¹æ³•è‡ªå·±å®ç°</span>
<a id=__codelineno-84-34 name=__codelineno-84-34></a><a href=#__codelineno-84-34><span class=linenos data-linenos="34 "></span></a>  <span class=n>urlConnection</span><span class=p>.</span><span class=na>setInstanceFollowRedirects</span><span class=p>(</span><span class=kc>false</span><span class=p>);</span>
<a id=__codelineno-84-35 name=__codelineno-84-35></a><a href=#__codelineno-84-35><span class=linenos data-linenos="35 "></span></a>
<a id=__codelineno-84-36 name=__codelineno-84-36></a><a href=#__codelineno-84-36><span class=linenos data-linenos="36 "></span></a>  <span class=c1>// Connect explicitly to avoid errors in decoders if connection fails.</span>
<a id=__codelineno-84-37 name=__codelineno-84-37></a><a href=#__codelineno-84-37><span class=linenos data-linenos="37 "></span></a>  <span class=n>urlConnection</span><span class=p>.</span><span class=na>connect</span><span class=p>();</span>
<a id=__codelineno-84-38 name=__codelineno-84-38></a><a href=#__codelineno-84-38><span class=linenos data-linenos="38 "></span></a>  <span class=c1>// Set the stream so that it&#39;s closed in cleanup to avoid resource leaks. See #2352.</span>
<a id=__codelineno-84-39 name=__codelineno-84-39></a><a href=#__codelineno-84-39><span class=linenos data-linenos="39 "></span></a>  <span class=n>stream</span> <span class=o>=</span> <span class=n>urlConnection</span><span class=p>.</span><span class=na>getInputStream</span><span class=p>();</span>
<a id=__codelineno-84-40 name=__codelineno-84-40></a><a href=#__codelineno-84-40><span class=linenos data-linenos="40 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>isCancelled</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-84-41 name=__codelineno-84-41></a><a href=#__codelineno-84-41><span class=linenos data-linenos="41 "></span></a>    <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-84-42 name=__codelineno-84-42></a><a href=#__codelineno-84-42><span class=linenos data-linenos="42 "></span></a>  <span class=p>}</span>
<a id=__codelineno-84-43 name=__codelineno-84-43></a><a href=#__codelineno-84-43><span class=linenos data-linenos="43 "></span></a>  <span class=kd>final</span> <span class=kt>int</span> <span class=n>statusCode</span> <span class=o>=</span> <span class=n>urlConnection</span><span class=p>.</span><span class=na>getResponseCode</span><span class=p>();</span>
<a id=__codelineno-84-44 name=__codelineno-84-44></a><a href=#__codelineno-84-44><span class=linenos data-linenos="44 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>isHttpOk</span><span class=p>(</span><span class=n>statusCode</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-84-45 name=__codelineno-84-45></a><a href=#__codelineno-84-45><span class=linenos data-linenos="45 "></span></a>    <span class=c1>// statusCode=2xxï¼Œè¯·æ±‚æˆåŠŸ</span>
<a id=__codelineno-84-46 name=__codelineno-84-46></a><a href=#__codelineno-84-46><span class=linenos data-linenos="46 "></span></a>    <span class=k>return</span> <span class=n>getStreamForSuccessfulRequest</span><span class=p>(</span><span class=n>urlConnection</span><span class=p>);</span>
<a id=__codelineno-84-47 name=__codelineno-84-47></a><a href=#__codelineno-84-47><span class=linenos data-linenos="47 "></span></a>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>isHttpRedirect</span><span class=p>(</span><span class=n>statusCode</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-84-48 name=__codelineno-84-48></a><a href=#__codelineno-84-48><span class=linenos data-linenos="48 "></span></a>    <span class=c1>// statusCode=3xxï¼Œéœ€è¦é‡å®šå‘</span>
<a id=__codelineno-84-49 name=__codelineno-84-49></a><a href=#__codelineno-84-49><span class=linenos data-linenos="49 "></span></a>    <span class=n>String</span> <span class=n>redirectUrlString</span> <span class=o>=</span> <span class=n>urlConnection</span><span class=p>.</span><span class=na>getHeaderField</span><span class=p>(</span><span class=s>&quot;Location&quot;</span><span class=p>);</span>
<a id=__codelineno-84-50 name=__codelineno-84-50></a><a href=#__codelineno-84-50><span class=linenos data-linenos="50 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>TextUtils</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>(</span><span class=n>redirectUrlString</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-84-51 name=__codelineno-84-51></a><a href=#__codelineno-84-51><span class=linenos data-linenos="51 "></span></a>      <span class=k>throw</span> <span class=k>new</span> <span class=n>HttpException</span><span class=p>(</span><span class=s>&quot;Received empty or null redirect url&quot;</span><span class=p>);</span>
<a id=__codelineno-84-52 name=__codelineno-84-52></a><a href=#__codelineno-84-52><span class=linenos data-linenos="52 "></span></a>    <span class=p>}</span>
<a id=__codelineno-84-53 name=__codelineno-84-53></a><a href=#__codelineno-84-53><span class=linenos data-linenos="53 "></span></a>    <span class=n>URL</span> <span class=n>redirectUrl</span> <span class=o>=</span> <span class=k>new</span> <span class=n>URL</span><span class=p>(</span><span class=n>url</span><span class=p>,</span> <span class=n>redirectUrlString</span><span class=p>);</span>
<a id=__codelineno-84-54 name=__codelineno-84-54></a><a href=#__codelineno-84-54><span class=linenos data-linenos="54 "></span></a>    <span class=c1>// Closing the stream specifically is required to avoid leaking ResponseBodys in addition</span>
<a id=__codelineno-84-55 name=__codelineno-84-55></a><a href=#__codelineno-84-55><span class=linenos data-linenos="55 "></span></a>    <span class=c1>// to disconnecting the url connection below. See #2352.</span>
<a id=__codelineno-84-56 name=__codelineno-84-56></a><a href=#__codelineno-84-56><span class=linenos data-linenos="56 "></span></a>    <span class=n>cleanup</span><span class=p>();</span>
<a id=__codelineno-84-57 name=__codelineno-84-57></a><a href=#__codelineno-84-57><span class=linenos data-linenos="57 "></span></a>    <span class=k>return</span> <span class=n>loadDataWithRedirects</span><span class=p>(</span><span class=n>redirectUrl</span><span class=p>,</span> <span class=n>redirects</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span> <span class=n>url</span><span class=p>,</span> <span class=n>headers</span><span class=p>);</span>
<a id=__codelineno-84-58 name=__codelineno-84-58></a><a href=#__codelineno-84-58><span class=linenos data-linenos="58 "></span></a>  <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>statusCode</span> <span class=o>==</span> <span class=n>INVALID_STATUS_CODE</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-84-59 name=__codelineno-84-59></a><a href=#__codelineno-84-59><span class=linenos data-linenos="59 "></span></a>    <span class=c1>// -1 è¡¨ç¤ºä¸æ˜¯HTTPå“åº”</span>
<a id=__codelineno-84-60 name=__codelineno-84-60></a><a href=#__codelineno-84-60><span class=linenos data-linenos="60 "></span></a>    <span class=k>throw</span> <span class=k>new</span> <span class=n>HttpException</span><span class=p>(</span><span class=n>statusCode</span><span class=p>);</span>
<a id=__codelineno-84-61 name=__codelineno-84-61></a><a href=#__codelineno-84-61><span class=linenos data-linenos="61 "></span></a>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
<a id=__codelineno-84-62 name=__codelineno-84-62></a><a href=#__codelineno-84-62><span class=linenos data-linenos="62 "></span></a>    <span class=c1>// å…¶ä»–HTTPé”™è¯¯</span>
<a id=__codelineno-84-63 name=__codelineno-84-63></a><a href=#__codelineno-84-63><span class=linenos data-linenos="63 "></span></a>    <span class=k>throw</span> <span class=k>new</span> <span class=n>HttpException</span><span class=p>(</span><span class=n>urlConnection</span><span class=p>.</span><span class=na>getResponseMessage</span><span class=p>(),</span> <span class=n>statusCode</span><span class=p>);</span>
<a id=__codelineno-84-64 name=__codelineno-84-64></a><a href=#__codelineno-84-64><span class=linenos data-linenos="64 "></span></a>  <span class=p>}</span>
<a id=__codelineno-84-65 name=__codelineno-84-65></a><a href=#__codelineno-84-65><span class=linenos data-linenos="65 "></span></a><span class=p>}</span>
<a id=__codelineno-84-66 name=__codelineno-84-66></a><a href=#__codelineno-84-66><span class=linenos data-linenos="66 "></span></a>
<a id=__codelineno-84-67 name=__codelineno-84-67></a><a href=#__codelineno-84-67><span class=linenos data-linenos="67 "></span></a><span class=c1>// Referencing constants is less clear than a simple static method.</span>
<a id=__codelineno-84-68 name=__codelineno-84-68></a><a href=#__codelineno-84-68><span class=linenos data-linenos="68 "></span></a><span class=kd>private</span> <span class=kd>static</span> <span class=kt>boolean</span> <span class=nf>isHttpOk</span><span class=p>(</span><span class=kt>int</span> <span class=n>statusCode</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-84-69 name=__codelineno-84-69></a><a href=#__codelineno-84-69><span class=linenos data-linenos="69 "></span></a>  <span class=k>return</span> <span class=n>statusCode</span> <span class=o>/</span> <span class=mi>100</span> <span class=o>==</span> <span class=mi>2</span><span class=p>;</span>
<a id=__codelineno-84-70 name=__codelineno-84-70></a><a href=#__codelineno-84-70><span class=linenos data-linenos="70 "></span></a><span class=p>}</span>
<a id=__codelineno-84-71 name=__codelineno-84-71></a><a href=#__codelineno-84-71><span class=linenos data-linenos="71 "></span></a>
<a id=__codelineno-84-72 name=__codelineno-84-72></a><a href=#__codelineno-84-72><span class=linenos data-linenos="72 "></span></a><span class=c1>// Referencing constants is less clear than a simple static method.</span>
<a id=__codelineno-84-73 name=__codelineno-84-73></a><a href=#__codelineno-84-73><span class=linenos data-linenos="73 "></span></a><span class=kd>private</span> <span class=kd>static</span> <span class=kt>boolean</span> <span class=nf>isHttpRedirect</span><span class=p>(</span><span class=kt>int</span> <span class=n>statusCode</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-84-74 name=__codelineno-84-74></a><a href=#__codelineno-84-74><span class=linenos data-linenos="74 "></span></a>  <span class=k>return</span> <span class=n>statusCode</span> <span class=o>/</span> <span class=mi>100</span> <span class=o>==</span> <span class=mi>3</span><span class=p>;</span>
<a id=__codelineno-84-75 name=__codelineno-84-75></a><a href=#__codelineno-84-75><span class=linenos data-linenos="75 "></span></a><span class=p>}</span>
</code></pre></div> <p>ç°åœ¨æˆ‘ä»¬å·²ç»è·å¾—ç½‘ç»œå›¾ç‰‡çš„InputStreamäº†ï¼Œè¯¥èµ„æºä¼šé€šè¿‡å›è°ƒç»è¿‡<code>MultiFetcher</code>åˆ°è¾¾<code>SourceGenerator</code>ä¸­ã€‚ </p> <p>ä¸‹é¢æ˜¯<code>DataCallback</code>å›è°ƒåœ¨<code>SourceGenerator</code>ä¸­çš„å®ç°ã€‚</p> <div class=highlight><pre><span></span><code><a id=__codelineno-85-1 name=__codelineno-85-1></a><a href=#__codelineno-85-1><span class=linenos data-linenos=" 1 "></span></a><span class=nd>@Override</span>
<a id=__codelineno-85-2 name=__codelineno-85-2></a><a href=#__codelineno-85-2><span class=linenos data-linenos=" 2 "></span></a><span class=kd>public</span> <span class=kt>void</span> <span class=nf>onDataReady</span><span class=p>(</span><span class=n>Object</span> <span class=n>data</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-85-3 name=__codelineno-85-3></a><a href=#__codelineno-85-3><span class=linenos data-linenos=" 3 "></span></a>  <span class=n>DiskCacheStrategy</span> <span class=n>diskCacheStrategy</span> <span class=o>=</span> <span class=n>helper</span><span class=p>.</span><span class=na>getDiskCacheStrategy</span><span class=p>();</span>
<a id=__codelineno-85-4 name=__codelineno-85-4></a><a href=#__codelineno-85-4><span class=linenos data-linenos=" 4 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>data</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>diskCacheStrategy</span><span class=p>.</span><span class=na>isDataCacheable</span><span class=p>(</span><span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>getDataSource</span><span class=p>()))</span> <span class=p>{</span>
<a id=__codelineno-85-5 name=__codelineno-85-5></a><a href=#__codelineno-85-5><span class=linenos data-linenos=" 5 "></span></a>    <span class=n>dataToCache</span> <span class=o>=</span> <span class=n>data</span><span class=p>;</span>
<a id=__codelineno-85-6 name=__codelineno-85-6></a><a href=#__codelineno-85-6><span class=linenos data-linenos=" 6 "></span></a>    <span class=c1>// We might be being called back on someone else&#39;s thread. Before doing anything, we should</span>
<a id=__codelineno-85-7 name=__codelineno-85-7></a><a href=#__codelineno-85-7><span class=linenos data-linenos=" 7 "></span></a>    <span class=c1>// reschedule to get back onto Glide&#39;s thread.</span>
<a id=__codelineno-85-8 name=__codelineno-85-8></a><a href=#__codelineno-85-8><span class=linenos data-linenos=" 8 "></span></a>    <span class=n>cb</span><span class=p>.</span><span class=na>reschedule</span><span class=p>();</span>
<a id=__codelineno-85-9 name=__codelineno-85-9></a><a href=#__codelineno-85-9><span class=linenos data-linenos=" 9 "></span></a>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
<a id=__codelineno-85-10 name=__codelineno-85-10></a><a href=#__codelineno-85-10><span class=linenos data-linenos="10 "></span></a>    <span class=n>cb</span><span class=p>.</span><span class=na>onDataFetcherReady</span><span class=p>(</span><span class=n>loadData</span><span class=p>.</span><span class=na>sourceKey</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>,</span>
<a id=__codelineno-85-11 name=__codelineno-85-11></a><a href=#__codelineno-85-11><span class=linenos data-linenos="11 "></span></a>        <span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>getDataSource</span><span class=p>(),</span> <span class=n>originalKey</span><span class=p>);</span>
<a id=__codelineno-85-12 name=__codelineno-85-12></a><a href=#__codelineno-85-12><span class=linenos data-linenos="12 "></span></a>  <span class=p>}</span>
<a id=__codelineno-85-13 name=__codelineno-85-13></a><a href=#__codelineno-85-13><span class=linenos data-linenos="13 "></span></a><span class=p>}</span>
<a id=__codelineno-85-14 name=__codelineno-85-14></a><a href=#__codelineno-85-14><span class=linenos data-linenos="14 "></span></a>
<a id=__codelineno-85-15 name=__codelineno-85-15></a><a href=#__codelineno-85-15><span class=linenos data-linenos="15 "></span></a><span class=nd>@Override</span>
<a id=__codelineno-85-16 name=__codelineno-85-16></a><a href=#__codelineno-85-16><span class=linenos data-linenos="16 "></span></a><span class=kd>public</span> <span class=kt>void</span> <span class=nf>onLoadFailed</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Exception</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-85-17 name=__codelineno-85-17></a><a href=#__codelineno-85-17><span class=linenos data-linenos="17 "></span></a>  <span class=n>cb</span><span class=p>.</span><span class=na>onDataFetcherFailed</span><span class=p>(</span><span class=n>originalKey</span><span class=p>,</span> <span class=n>e</span><span class=p>,</span> <span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>,</span> <span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>getDataSource</span><span class=p>());</span>
<a id=__codelineno-85-18 name=__codelineno-85-18></a><a href=#__codelineno-85-18><span class=linenos data-linenos="18 "></span></a><span class=p>}</span>
</code></pre></div> <p><code>onLoadFailed</code>å¾ˆç®€å•ï¼Œç›´æ¥è°ƒç”¨<code>DecodeJob.onDataFetcherFailed</code>æ–¹æ³•ã€‚<code>onDataReady</code>æ–¹æ³•ä¼šé¦–å…ˆåˆ¤dataèƒ½ä¸èƒ½ç¼“å­˜ï¼Œè‹¥èƒ½ç¼“å­˜åˆ™ç¼“å­˜èµ·æ¥ï¼Œç„¶åè°ƒç”¨<code>DataCacheGenerator</code>è¿›è¡ŒåŠ è½½ç¼“å­˜ï¼›è‹¥ä¸èƒ½ç¼“å­˜ï¼Œåˆ™ç›´æ¥è°ƒç”¨<code>DecodeJob.onDataFetcherReady</code>æ–¹æ³•é€šçŸ¥å¤–ç•Œdataå·²ç»å‡†å¤‡å¥½äº†ã€‚</p> <p>æˆ‘ä»¬è§£è¯»ä¸€ä¸‹<code>onDataReady</code>é‡Œé¢çš„ä»£ç ã€‚é¦–å…ˆï¼Œè·å–<code>DiskCacheStrategy</code>åˆ¤æ–­èƒ½ä¸èƒ½è¢«ç¼“å­˜ï¼Œè¿™é‡Œçš„åˆ¤æ–­ä»£ç åœ¨<code>SourceGenerator.startNext()</code>ä¸­å‡ºç°è¿‡ï¼Œæ˜¾ç„¶æ˜¯å¯ä»¥çš„ã€‚ç„¶åå°†dataä¿å­˜åˆ°<code>dataToCache</code>ï¼Œå¹¶è°ƒç”¨<code>cb.reschedule()</code>ã€‚<br> <code>cb.reschedule()</code>æˆ‘ä»¬åœ¨å‰é¢åˆ†æè¿‡ï¼Œè¯¥æ–¹æ³•çš„ä½œç”¨å°±æ˜¯å°†<code>DecodeJob</code>æäº¤åˆ°Glideçš„sourceçº¿ç¨‹æ± ä¸­ã€‚ç„¶åæ‰§è¡Œ<code>DecodeJob.run()</code>æ–¹æ³•ï¼Œç»è¿‡<code>runWrapped()</code>ã€ <code>runGenerators()</code>æ–¹æ³•åï¼Œåˆå›åˆ°äº†<code>SourceGenerator.startNext()</code>æ–¹æ³•ã€‚</p> <p>åœ¨æ–¹æ³•çš„å¼€å¤´ï¼Œä¼šåˆ¤æ–­<code>dataToCache</code>æ˜¯å¦ä¸ºç©ºï¼Œæ­¤æ—¶æ˜¾ç„¶ä¸ä¸ºç©ºï¼Œæ‰€ä»¥ä¼šè°ƒç”¨<code>cacheData(Object)</code>æ–¹æ³•è¿›è¡Œdataçš„ç¼“å­˜å¤„ç†ã€‚ç¼“å­˜å®Œæ¯•åï¼Œä¼šä¸ºè¯¥ç¼“å­˜æ–‡ä»¶ç”Ÿæˆä¸€ä¸ª<code>SourceCacheGenerator</code>ã€‚ç„¶ååœ¨<code>startNext()</code>æ–¹æ³•ä¸­ä¼šç›´æ¥è°ƒç”¨è¯¥å˜é‡è¿›è¡ŒåŠ è½½ã€‚</p> <div class=highlight><pre><span></span><code><a id=__codelineno-86-1 name=__codelineno-86-1></a><a href=#__codelineno-86-1><span class=linenos data-linenos=" 1 "></span></a><span class=nd>@Override</span>
<a id=__codelineno-86-2 name=__codelineno-86-2></a><a href=#__codelineno-86-2><span class=linenos data-linenos=" 2 "></span></a><span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>startNext</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-86-3 name=__codelineno-86-3></a><a href=#__codelineno-86-3><span class=linenos data-linenos=" 3 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>dataToCache</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-86-4 name=__codelineno-86-4></a><a href=#__codelineno-86-4><span class=linenos data-linenos=" 4 "></span></a>    <span class=n>Object</span> <span class=n>data</span> <span class=o>=</span> <span class=n>dataToCache</span><span class=p>;</span>
<a id=__codelineno-86-5 name=__codelineno-86-5></a><a href=#__codelineno-86-5><span class=linenos data-linenos=" 5 "></span></a>    <span class=n>dataToCache</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-86-6 name=__codelineno-86-6></a><a href=#__codelineno-86-6><span class=linenos data-linenos=" 6 "></span></a>    <span class=n>cacheData</span><span class=p>(</span><span class=n>data</span><span class=p>);</span>
<a id=__codelineno-86-7 name=__codelineno-86-7></a><a href=#__codelineno-86-7><span class=linenos data-linenos=" 7 "></span></a>  <span class=p>}</span>
<a id=__codelineno-86-8 name=__codelineno-86-8></a><a href=#__codelineno-86-8><span class=linenos data-linenos=" 8 "></span></a>
<a id=__codelineno-86-9 name=__codelineno-86-9></a><a href=#__codelineno-86-9><span class=linenos data-linenos=" 9 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>sourceCacheGenerator</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>sourceCacheGenerator</span><span class=p>.</span><span class=na>startNext</span><span class=p>())</span> <span class=p>{</span>
<a id=__codelineno-86-10 name=__codelineno-86-10></a><a href=#__codelineno-86-10><span class=linenos data-linenos="10 "></span></a>    <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
<a id=__codelineno-86-11 name=__codelineno-86-11></a><a href=#__codelineno-86-11><span class=linenos data-linenos="11 "></span></a>  <span class=p>}</span>
<a id=__codelineno-86-12 name=__codelineno-86-12></a><a href=#__codelineno-86-12><span class=linenos data-linenos="12 "></span></a>  <span class=n>sourceCacheGenerator</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-86-13 name=__codelineno-86-13></a><a href=#__codelineno-86-13><span class=linenos data-linenos="13 "></span></a><span class=p>}</span>
<a id=__codelineno-86-14 name=__codelineno-86-14></a><a href=#__codelineno-86-14><span class=linenos data-linenos="14 "></span></a>
<a id=__codelineno-86-15 name=__codelineno-86-15></a><a href=#__codelineno-86-15><span class=linenos data-linenos="15 "></span></a><span class=kd>private</span> <span class=kt>void</span> <span class=nf>cacheData</span><span class=p>(</span><span class=n>Object</span> <span class=n>dataToCache</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-86-16 name=__codelineno-86-16></a><a href=#__codelineno-86-16><span class=linenos data-linenos="16 "></span></a>  <span class=kt>long</span> <span class=n>startTime</span> <span class=o>=</span> <span class=n>LogTime</span><span class=p>.</span><span class=na>getLogTime</span><span class=p>();</span>
<a id=__codelineno-86-17 name=__codelineno-86-17></a><a href=#__codelineno-86-17><span class=linenos data-linenos="17 "></span></a>  <span class=k>try</span> <span class=p>{</span>
<a id=__codelineno-86-18 name=__codelineno-86-18></a><a href=#__codelineno-86-18><span class=linenos data-linenos="18 "></span></a>    <span class=n>Encoder</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>encoder</span> <span class=o>=</span> <span class=n>helper</span><span class=p>.</span><span class=na>getSourceEncoder</span><span class=p>(</span><span class=n>dataToCache</span><span class=p>);</span>
<a id=__codelineno-86-19 name=__codelineno-86-19></a><a href=#__codelineno-86-19><span class=linenos data-linenos="19 "></span></a>    <span class=n>DataCacheWriter</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>writer</span> <span class=o>=</span>
<a id=__codelineno-86-20 name=__codelineno-86-20></a><a href=#__codelineno-86-20><span class=linenos data-linenos="20 "></span></a>        <span class=k>new</span> <span class=n>DataCacheWriter</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>encoder</span><span class=p>,</span> <span class=n>dataToCache</span><span class=p>,</span> <span class=n>helper</span><span class=p>.</span><span class=na>getOptions</span><span class=p>());</span>
<a id=__codelineno-86-21 name=__codelineno-86-21></a><a href=#__codelineno-86-21><span class=linenos data-linenos="21 "></span></a>    <span class=n>originalKey</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DataCacheKey</span><span class=p>(</span><span class=n>loadData</span><span class=p>.</span><span class=na>sourceKey</span><span class=p>,</span> <span class=n>helper</span><span class=p>.</span><span class=na>getSignature</span><span class=p>());</span>
<a id=__codelineno-86-22 name=__codelineno-86-22></a><a href=#__codelineno-86-22><span class=linenos data-linenos="22 "></span></a>    <span class=c1>// ç¼“å­˜data</span>
<a id=__codelineno-86-23 name=__codelineno-86-23></a><a href=#__codelineno-86-23><span class=linenos data-linenos="23 "></span></a>    <span class=n>helper</span><span class=p>.</span><span class=na>getDiskCache</span><span class=p>().</span><span class=na>put</span><span class=p>(</span><span class=n>originalKey</span><span class=p>,</span> <span class=n>writer</span><span class=p>);</span>
<a id=__codelineno-86-24 name=__codelineno-86-24></a><a href=#__codelineno-86-24><span class=linenos data-linenos="24 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>Log</span><span class=p>.</span><span class=na>isLoggable</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=n>Log</span><span class=p>.</span><span class=na>VERBOSE</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-86-25 name=__codelineno-86-25></a><a href=#__codelineno-86-25><span class=linenos data-linenos="25 "></span></a>      <span class=n>Log</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s>&quot;Finished encoding source to cache&quot;</span>
<a id=__codelineno-86-26 name=__codelineno-86-26></a><a href=#__codelineno-86-26><span class=linenos data-linenos="26 "></span></a>          <span class=o>+</span> <span class=s>&quot;, key: &quot;</span> <span class=o>+</span> <span class=n>originalKey</span>
<a id=__codelineno-86-27 name=__codelineno-86-27></a><a href=#__codelineno-86-27><span class=linenos data-linenos="27 "></span></a>          <span class=o>+</span> <span class=s>&quot;, data: &quot;</span> <span class=o>+</span> <span class=n>dataToCache</span>
<a id=__codelineno-86-28 name=__codelineno-86-28></a><a href=#__codelineno-86-28><span class=linenos data-linenos="28 "></span></a>          <span class=o>+</span> <span class=s>&quot;, encoder: &quot;</span> <span class=o>+</span> <span class=n>encoder</span>
<a id=__codelineno-86-29 name=__codelineno-86-29></a><a href=#__codelineno-86-29><span class=linenos data-linenos="29 "></span></a>          <span class=o>+</span> <span class=s>&quot;, duration: &quot;</span> <span class=o>+</span> <span class=n>LogTime</span><span class=p>.</span><span class=na>getElapsedMillis</span><span class=p>(</span><span class=n>startTime</span><span class=p>));</span>
<a id=__codelineno-86-30 name=__codelineno-86-30></a><a href=#__codelineno-86-30><span class=linenos data-linenos="30 "></span></a>    <span class=p>}</span>
<a id=__codelineno-86-31 name=__codelineno-86-31></a><a href=#__codelineno-86-31><span class=linenos data-linenos="31 "></span></a>  <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
<a id=__codelineno-86-32 name=__codelineno-86-32></a><a href=#__codelineno-86-32><span class=linenos data-linenos="32 "></span></a>    <span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>cleanup</span><span class=p>();</span>
<a id=__codelineno-86-33 name=__codelineno-86-33></a><a href=#__codelineno-86-33><span class=linenos data-linenos="33 "></span></a>  <span class=p>}</span>
<a id=__codelineno-86-34 name=__codelineno-86-34></a><a href=#__codelineno-86-34><span class=linenos data-linenos="34 "></span></a>
<a id=__codelineno-86-35 name=__codelineno-86-35></a><a href=#__codelineno-86-35><span class=linenos data-linenos="35 "></span></a>  <span class=n>sourceCacheGenerator</span> <span class=o>=</span>
<a id=__codelineno-86-36 name=__codelineno-86-36></a><a href=#__codelineno-86-36><span class=linenos data-linenos="36 "></span></a>      <span class=k>new</span> <span class=n>DataCacheGenerator</span><span class=p>(</span><span class=n>Collections</span><span class=p>.</span><span class=na>singletonList</span><span class=p>(</span><span class=n>loadData</span><span class=p>.</span><span class=na>sourceKey</span><span class=p>),</span> <span class=n>helper</span><span class=p>,</span> <span class=k>this</span><span class=p>);</span>
<a id=__codelineno-86-37 name=__codelineno-86-37></a><a href=#__codelineno-86-37><span class=linenos data-linenos="37 "></span></a><span class=p>}</span>
</code></pre></div> <p>ç”±äºåœ¨æ„é€ <code>DataCacheGenerator</code>æ—¶ï¼ŒæŒ‡å®šäº†<code>FetcherReadyCallback</code>ä¸ºè‡ªå·±ï¼Œæ‰€ä»¥<code>DataCacheGenerator</code>åŠ è½½ç»“æœä¼šç”±<code>SourceGenerator</code>è½¬å‘ç»™<code>DecodeJob</code>ã€‚<br> ç”±äºèµ„æºä¼šç”±<code>DataCacheGenerator</code>è§£ç ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨ä»£ç ä¸­çœ‹åˆ°ï¼Œè¿”å›çš„data sourceæ˜¯<code>DataSource.DATA_DISK_CACHE</code>ã€‚</p> <h3 id=39-decodejobfetcherreadycallback>3.9 DecodeJob.FetcherReadyCallback<a class=headerlink href=#39-decodejobfetcherreadycallback title="Anchor link to this section for reference">&para;</a></h3> <p>æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹fetchå¤±è´¥æ—¶å¹²äº†ä»€ä¹ˆï¼Œç„¶ååœ¨çœ‹æˆåŠŸçš„æ—¶å€™ã€‚å› ä¸ºå¤±è´¥çš„ä»£ç æ¯”è¾ƒç®€å•ã€‚</p> <p><code>onDataFetcherFailed</code>ä»£ç å¦‚ä¸‹ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-87-1 name=__codelineno-87-1></a><a href=#__codelineno-87-1><span class=linenos data-linenos=" 1 "></span></a><span class=nd>@Override</span>
<a id=__codelineno-87-2 name=__codelineno-87-2></a><a href=#__codelineno-87-2><span class=linenos data-linenos=" 2 "></span></a><span class=kd>public</span> <span class=kt>void</span> <span class=nf>onDataFetcherFailed</span><span class=p>(</span><span class=n>Key</span> <span class=n>attemptedKey</span><span class=p>,</span> <span class=n>Exception</span> <span class=n>e</span><span class=p>,</span> <span class=n>DataFetcher</span><span class=o>&lt;?&gt;</span> <span class=n>fetcher</span><span class=p>,</span>
<a id=__codelineno-87-3 name=__codelineno-87-3></a><a href=#__codelineno-87-3><span class=linenos data-linenos=" 3 "></span></a>    <span class=n>DataSource</span> <span class=n>dataSource</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-87-4 name=__codelineno-87-4></a><a href=#__codelineno-87-4><span class=linenos data-linenos=" 4 "></span></a>  <span class=n>fetcher</span><span class=p>.</span><span class=na>cleanup</span><span class=p>();</span>
<a id=__codelineno-87-5 name=__codelineno-87-5></a><a href=#__codelineno-87-5><span class=linenos data-linenos=" 5 "></span></a>  <span class=n>GlideException</span> <span class=n>exception</span> <span class=o>=</span> <span class=k>new</span> <span class=n>GlideException</span><span class=p>(</span><span class=s>&quot;Fetching data failed&quot;</span><span class=p>,</span> <span class=n>e</span><span class=p>);</span>
<a id=__codelineno-87-6 name=__codelineno-87-6></a><a href=#__codelineno-87-6><span class=linenos data-linenos=" 6 "></span></a>  <span class=n>exception</span><span class=p>.</span><span class=na>setLoggingDetails</span><span class=p>(</span><span class=n>attemptedKey</span><span class=p>,</span> <span class=n>dataSource</span><span class=p>,</span> <span class=n>fetcher</span><span class=p>.</span><span class=na>getDataClass</span><span class=p>());</span>
<a id=__codelineno-87-7 name=__codelineno-87-7></a><a href=#__codelineno-87-7><span class=linenos data-linenos=" 7 "></span></a>  <span class=n>throwables</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>exception</span><span class=p>);</span>
<a id=__codelineno-87-8 name=__codelineno-87-8></a><a href=#__codelineno-87-8><span class=linenos data-linenos=" 8 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>()</span> <span class=o>!=</span> <span class=n>currentThread</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-87-9 name=__codelineno-87-9></a><a href=#__codelineno-87-9><span class=linenos data-linenos=" 9 "></span></a>    <span class=n>runReason</span> <span class=o>=</span> <span class=n>RunReason</span><span class=p>.</span><span class=na>SWITCH_TO_SOURCE_SERVICE</span><span class=p>;</span>
<a id=__codelineno-87-10 name=__codelineno-87-10></a><a href=#__codelineno-87-10><span class=linenos data-linenos="10 "></span></a>    <span class=n>callback</span><span class=p>.</span><span class=na>reschedule</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
<a id=__codelineno-87-11 name=__codelineno-87-11></a><a href=#__codelineno-87-11><span class=linenos data-linenos="11 "></span></a>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
<a id=__codelineno-87-12 name=__codelineno-87-12></a><a href=#__codelineno-87-12><span class=linenos data-linenos="12 "></span></a>    <span class=n>runGenerators</span><span class=p>();</span>
<a id=__codelineno-87-13 name=__codelineno-87-13></a><a href=#__codelineno-87-13><span class=linenos data-linenos="13 "></span></a>  <span class=p>}</span>
<a id=__codelineno-87-14 name=__codelineno-87-14></a><a href=#__codelineno-87-14><span class=linenos data-linenos="14 "></span></a><span class=p>}</span>
</code></pre></div> <p>æ˜¾ç„¶ï¼Œå¦‚æœfetchå¤±è´¥äº†ï¼Œå¦‚æœä¸åœ¨sourceçº¿ç¨‹æ± ä¸­å°±ä¼šåˆ‡æ¢åˆ°sourceçº¿ç¨‹ï¼Œç„¶åé‡æ–°è°ƒç”¨<code>runGenerators()</code>æ–¹æ³•å°è¯•ä½¿ç”¨ä¸‹ä¸€ä¸ª<code>DataFetcherGenerator</code>è¿›è¡ŒåŠ è½½ï¼Œä¸€ç›´åˆ°æ²¡æœ‰ä¸€ä¸ªå¯ä»¥åŠ è½½ï¼Œè¿™æ—¶ä¼šè°ƒç”¨<code>notifyFailed()</code>æ–¹æ³•ï¼Œæ­£å¼å®£å‘ŠåŠ è½½å¤±è´¥ã€‚</p> <p>ç„¶ååœ¨çœ‹æˆåŠŸçš„æ—¶å€™ï¼š<code>onDataFetcherReady</code>æ–¹æ³•ä¼šä¿å­˜ä¼ å…¥çš„å‚æ•°ï¼Œç„¶åç¡®è®¤æ‰§è¡Œçº¿ç¨‹åè°ƒç”¨<code>decodeFromRetrievedData()</code>æ–¹æ³•è¿›è¡Œè§£ç ã€‚</p> <div class=highlight><pre><span></span><code><a id=__codelineno-88-1 name=__codelineno-88-1></a><a href=#__codelineno-88-1><span class=linenos data-linenos=" 1 "></span></a><span class=nd>@Override</span>
<a id=__codelineno-88-2 name=__codelineno-88-2></a><a href=#__codelineno-88-2><span class=linenos data-linenos=" 2 "></span></a><span class=kd>public</span> <span class=kt>void</span> <span class=nf>onDataFetcherReady</span><span class=p>(</span><span class=n>Key</span> <span class=n>sourceKey</span><span class=p>,</span> <span class=n>Object</span> <span class=n>data</span><span class=p>,</span> <span class=n>DataFetcher</span><span class=o>&lt;?&gt;</span> <span class=n>fetcher</span><span class=p>,</span>
<a id=__codelineno-88-3 name=__codelineno-88-3></a><a href=#__codelineno-88-3><span class=linenos data-linenos=" 3 "></span></a>    <span class=n>DataSource</span> <span class=n>dataSource</span><span class=p>,</span> <span class=n>Key</span> <span class=n>attemptedKey</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-88-4 name=__codelineno-88-4></a><a href=#__codelineno-88-4><span class=linenos data-linenos=" 4 "></span></a>  <span class=k>this</span><span class=p>.</span><span class=na>currentSourceKey</span> <span class=o>=</span> <span class=n>sourceKey</span><span class=p>;</span>
<a id=__codelineno-88-5 name=__codelineno-88-5></a><a href=#__codelineno-88-5><span class=linenos data-linenos=" 5 "></span></a>  <span class=k>this</span><span class=p>.</span><span class=na>currentData</span> <span class=o>=</span> <span class=n>data</span><span class=p>;</span>
<a id=__codelineno-88-6 name=__codelineno-88-6></a><a href=#__codelineno-88-6><span class=linenos data-linenos=" 6 "></span></a>  <span class=k>this</span><span class=p>.</span><span class=na>currentFetcher</span> <span class=o>=</span> <span class=n>fetcher</span><span class=p>;</span>
<a id=__codelineno-88-7 name=__codelineno-88-7></a><a href=#__codelineno-88-7><span class=linenos data-linenos=" 7 "></span></a>  <span class=k>this</span><span class=p>.</span><span class=na>currentDataSource</span> <span class=o>=</span> <span class=n>dataSource</span><span class=p>;</span>
<a id=__codelineno-88-8 name=__codelineno-88-8></a><a href=#__codelineno-88-8><span class=linenos data-linenos=" 8 "></span></a>  <span class=k>this</span><span class=p>.</span><span class=na>currentAttemptingKey</span> <span class=o>=</span> <span class=n>attemptedKey</span><span class=p>;</span>
<a id=__codelineno-88-9 name=__codelineno-88-9></a><a href=#__codelineno-88-9><span class=linenos data-linenos=" 9 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>()</span> <span class=o>!=</span> <span class=n>currentThread</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-88-10 name=__codelineno-88-10></a><a href=#__codelineno-88-10><span class=linenos data-linenos="10 "></span></a>    <span class=n>runReason</span> <span class=o>=</span> <span class=n>RunReason</span><span class=p>.</span><span class=na>DECODE_DATA</span><span class=p>;</span>
<a id=__codelineno-88-11 name=__codelineno-88-11></a><a href=#__codelineno-88-11><span class=linenos data-linenos="11 "></span></a>    <span class=n>callback</span><span class=p>.</span><span class=na>reschedule</span><span class=p>(</span><span class=k>this</span><span class=p>);</span>
<a id=__codelineno-88-12 name=__codelineno-88-12></a><a href=#__codelineno-88-12><span class=linenos data-linenos="12 "></span></a>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
<a id=__codelineno-88-13 name=__codelineno-88-13></a><a href=#__codelineno-88-13><span class=linenos data-linenos="13 "></span></a>    <span class=n>GlideTrace</span><span class=p>.</span><span class=na>beginSection</span><span class=p>(</span><span class=s>&quot;DecodeJob.decodeFromRetrievedData&quot;</span><span class=p>);</span>
<a id=__codelineno-88-14 name=__codelineno-88-14></a><a href=#__codelineno-88-14><span class=linenos data-linenos="14 "></span></a>    <span class=k>try</span> <span class=p>{</span>
<a id=__codelineno-88-15 name=__codelineno-88-15></a><a href=#__codelineno-88-15><span class=linenos data-linenos="15 "></span></a>      <span class=n>decodeFromRetrievedData</span><span class=p>();</span>
<a id=__codelineno-88-16 name=__codelineno-88-16></a><a href=#__codelineno-88-16><span class=linenos data-linenos="16 "></span></a>    <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
<a id=__codelineno-88-17 name=__codelineno-88-17></a><a href=#__codelineno-88-17><span class=linenos data-linenos="17 "></span></a>      <span class=n>GlideTrace</span><span class=p>.</span><span class=na>endSection</span><span class=p>();</span>
<a id=__codelineno-88-18 name=__codelineno-88-18></a><a href=#__codelineno-88-18><span class=linenos data-linenos="18 "></span></a>    <span class=p>}</span>
<a id=__codelineno-88-19 name=__codelineno-88-19></a><a href=#__codelineno-88-19><span class=linenos data-linenos="19 "></span></a>  <span class=p>}</span>
<a id=__codelineno-88-20 name=__codelineno-88-20></a><a href=#__codelineno-88-20><span class=linenos data-linenos="20 "></span></a><span class=p>}</span>
</code></pre></div> <p><code>decodeFromRetrievedData()</code>æ–¹æ³•ä¼šå…ˆè°ƒç”¨<code>decodeFromData</code>æ–¹æ³•è¿›è¡Œè§£ç ï¼Œç„¶åè°ƒç”¨<code>notifyEncodeAndRelease</code>æ–¹æ³•è¿›è¡Œç¼“å­˜ï¼ŒåŒæ—¶ä¹Ÿä¼šé€šçŸ¥<code>EngineJob</code>èµ„æºå·²ç»å‡†å¤‡å¥½äº†ã€‚</p> <div class=highlight><pre><span></span><code><a id=__codelineno-89-1 name=__codelineno-89-1></a><a href=#__codelineno-89-1><span class=linenos data-linenos=" 1 "></span></a><span class=kd>private</span> <span class=kt>void</span> <span class=nf>decodeFromRetrievedData</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-89-2 name=__codelineno-89-2></a><a href=#__codelineno-89-2><span class=linenos data-linenos=" 2 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>Log</span><span class=p>.</span><span class=na>isLoggable</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=n>Log</span><span class=p>.</span><span class=na>VERBOSE</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-89-3 name=__codelineno-89-3></a><a href=#__codelineno-89-3><span class=linenos data-linenos=" 3 "></span></a>    <span class=n>logWithTimeAndKey</span><span class=p>(</span><span class=s>&quot;Retrieved data&quot;</span><span class=p>,</span> <span class=n>startFetchTime</span><span class=p>,</span>
<a id=__codelineno-89-4 name=__codelineno-89-4></a><a href=#__codelineno-89-4><span class=linenos data-linenos=" 4 "></span></a>        <span class=s>&quot;data: &quot;</span> <span class=o>+</span> <span class=n>currentData</span>
<a id=__codelineno-89-5 name=__codelineno-89-5></a><a href=#__codelineno-89-5><span class=linenos data-linenos=" 5 "></span></a>            <span class=o>+</span> <span class=s>&quot;, cache key: &quot;</span> <span class=o>+</span> <span class=n>currentSourceKey</span>
<a id=__codelineno-89-6 name=__codelineno-89-6></a><a href=#__codelineno-89-6><span class=linenos data-linenos=" 6 "></span></a>            <span class=o>+</span> <span class=s>&quot;, fetcher: &quot;</span> <span class=o>+</span> <span class=n>currentFetcher</span><span class=p>);</span>
<a id=__codelineno-89-7 name=__codelineno-89-7></a><a href=#__codelineno-89-7><span class=linenos data-linenos=" 7 "></span></a>  <span class=p>}</span>
<a id=__codelineno-89-8 name=__codelineno-89-8></a><a href=#__codelineno-89-8><span class=linenos data-linenos=" 8 "></span></a>  <span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>resource</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-89-9 name=__codelineno-89-9></a><a href=#__codelineno-89-9><span class=linenos data-linenos=" 9 "></span></a>  <span class=k>try</span> <span class=p>{</span>
<a id=__codelineno-89-10 name=__codelineno-89-10></a><a href=#__codelineno-89-10><span class=linenos data-linenos="10 "></span></a>    <span class=n>resource</span> <span class=o>=</span> <span class=n>decodeFromData</span><span class=p>(</span><span class=n>currentFetcher</span><span class=p>,</span> <span class=n>currentData</span><span class=p>,</span> <span class=n>currentDataSource</span><span class=p>);</span>
<a id=__codelineno-89-11 name=__codelineno-89-11></a><a href=#__codelineno-89-11><span class=linenos data-linenos="11 "></span></a>  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>GlideException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-89-12 name=__codelineno-89-12></a><a href=#__codelineno-89-12><span class=linenos data-linenos="12 "></span></a>    <span class=n>e</span><span class=p>.</span><span class=na>setLoggingDetails</span><span class=p>(</span><span class=n>currentAttemptingKey</span><span class=p>,</span> <span class=n>currentDataSource</span><span class=p>);</span>
<a id=__codelineno-89-13 name=__codelineno-89-13></a><a href=#__codelineno-89-13><span class=linenos data-linenos="13 "></span></a>    <span class=n>throwables</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>e</span><span class=p>);</span>
<a id=__codelineno-89-14 name=__codelineno-89-14></a><a href=#__codelineno-89-14><span class=linenos data-linenos="14 "></span></a>  <span class=p>}</span>
<a id=__codelineno-89-15 name=__codelineno-89-15></a><a href=#__codelineno-89-15><span class=linenos data-linenos="15 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>resource</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-89-16 name=__codelineno-89-16></a><a href=#__codelineno-89-16><span class=linenos data-linenos="16 "></span></a>    <span class=n>notifyEncodeAndRelease</span><span class=p>(</span><span class=n>resource</span><span class=p>,</span> <span class=n>currentDataSource</span><span class=p>);</span>
<a id=__codelineno-89-17 name=__codelineno-89-17></a><a href=#__codelineno-89-17><span class=linenos data-linenos="17 "></span></a>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
<a id=__codelineno-89-18 name=__codelineno-89-18></a><a href=#__codelineno-89-18><span class=linenos data-linenos="18 "></span></a>    <span class=n>runGenerators</span><span class=p>();</span>
<a id=__codelineno-89-19 name=__codelineno-89-19></a><a href=#__codelineno-89-19><span class=linenos data-linenos="19 "></span></a>  <span class=p>}</span>
<a id=__codelineno-89-20 name=__codelineno-89-20></a><a href=#__codelineno-89-20><span class=linenos data-linenos="20 "></span></a><span class=p>}</span>
</code></pre></div> <p>å…ˆçœ‹çœ‹decodeç›¸å…³çš„ä»£ç ï¼Œ<code>decodeFromData</code>ç›¸å…³çš„ä»£ç æœ‰ä¸€äº›ï¼Œæˆ‘ä»¬ç›´æ¥åˆ—å‡ºè¿™äº›ä»£ç ã€‚<code>decodeFromData</code>æ–¹æ³•å†…éƒ¨åˆä¼šè°ƒç”¨<code>decodeFromFetcher</code>æ–¹æ³•å¹²æ´»ã€‚åœ¨<code>decodeFromFetcher</code>æ–¹æ³•ä¸­é¦–å…ˆä¼šè·å–LoadPathã€‚ç„¶åè°ƒç”¨<code>runLoadPath</code>æ–¹æ³•è§£ææˆèµ„æºã€‚ </p> <div class=highlight><pre><span></span><code><a id=__codelineno-90-1 name=__codelineno-90-1></a><a href=#__codelineno-90-1><span class=linenos data-linenos=" 1 "></span></a><span class=kd>private</span> <span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=nf>decodeFromData</span><span class=p>(</span><span class=n>DataFetcher</span><span class=o>&lt;?&gt;</span> <span class=n>fetcher</span><span class=p>,</span> <span class=n>Data</span> <span class=n>data</span><span class=p>,</span>
<a id=__codelineno-90-2 name=__codelineno-90-2></a><a href=#__codelineno-90-2><span class=linenos data-linenos=" 2 "></span></a>    <span class=n>DataSource</span> <span class=n>dataSource</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>GlideException</span> <span class=p>{</span>
<a id=__codelineno-90-3 name=__codelineno-90-3></a><a href=#__codelineno-90-3><span class=linenos data-linenos=" 3 "></span></a>  <span class=k>try</span> <span class=p>{</span>
<a id=__codelineno-90-4 name=__codelineno-90-4></a><a href=#__codelineno-90-4><span class=linenos data-linenos=" 4 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>data</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-90-5 name=__codelineno-90-5></a><a href=#__codelineno-90-5><span class=linenos data-linenos=" 5 "></span></a>      <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-90-6 name=__codelineno-90-6></a><a href=#__codelineno-90-6><span class=linenos data-linenos=" 6 "></span></a>    <span class=p>}</span>
<a id=__codelineno-90-7 name=__codelineno-90-7></a><a href=#__codelineno-90-7><span class=linenos data-linenos=" 7 "></span></a>    <span class=kt>long</span> <span class=n>startTime</span> <span class=o>=</span> <span class=n>LogTime</span><span class=p>.</span><span class=na>getLogTime</span><span class=p>();</span>
<a id=__codelineno-90-8 name=__codelineno-90-8></a><a href=#__codelineno-90-8><span class=linenos data-linenos=" 8 "></span></a>    <span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=n>decodeFromFetcher</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>dataSource</span><span class=p>);</span>
<a id=__codelineno-90-9 name=__codelineno-90-9></a><a href=#__codelineno-90-9><span class=linenos data-linenos=" 9 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>Log</span><span class=p>.</span><span class=na>isLoggable</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=n>Log</span><span class=p>.</span><span class=na>VERBOSE</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-90-10 name=__codelineno-90-10></a><a href=#__codelineno-90-10><span class=linenos data-linenos="10 "></span></a>      <span class=n>logWithTimeAndKey</span><span class=p>(</span><span class=s>&quot;Decoded result &quot;</span> <span class=o>+</span> <span class=n>result</span><span class=p>,</span> <span class=n>startTime</span><span class=p>);</span>
<a id=__codelineno-90-11 name=__codelineno-90-11></a><a href=#__codelineno-90-11><span class=linenos data-linenos="11 "></span></a>    <span class=p>}</span>
<a id=__codelineno-90-12 name=__codelineno-90-12></a><a href=#__codelineno-90-12><span class=linenos data-linenos="12 "></span></a>    <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
<a id=__codelineno-90-13 name=__codelineno-90-13></a><a href=#__codelineno-90-13><span class=linenos data-linenos="13 "></span></a>  <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
<a id=__codelineno-90-14 name=__codelineno-90-14></a><a href=#__codelineno-90-14><span class=linenos data-linenos="14 "></span></a>    <span class=n>fetcher</span><span class=p>.</span><span class=na>cleanup</span><span class=p>();</span>
<a id=__codelineno-90-15 name=__codelineno-90-15></a><a href=#__codelineno-90-15><span class=linenos data-linenos="15 "></span></a>  <span class=p>}</span>
<a id=__codelineno-90-16 name=__codelineno-90-16></a><a href=#__codelineno-90-16><span class=linenos data-linenos="16 "></span></a><span class=p>}</span>
<a id=__codelineno-90-17 name=__codelineno-90-17></a><a href=#__codelineno-90-17><span class=linenos data-linenos="17 "></span></a>
<a id=__codelineno-90-18 name=__codelineno-90-18></a><a href=#__codelineno-90-18><span class=linenos data-linenos="18 "></span></a><span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;unchecked&quot;</span><span class=p>)</span>
<a id=__codelineno-90-19 name=__codelineno-90-19></a><a href=#__codelineno-90-19><span class=linenos data-linenos="19 "></span></a><span class=kd>private</span> <span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=nf>decodeFromFetcher</span><span class=p>(</span><span class=n>Data</span> <span class=n>data</span><span class=p>,</span> <span class=n>DataSource</span> <span class=n>dataSource</span><span class=p>)</span>
<a id=__codelineno-90-20 name=__codelineno-90-20></a><a href=#__codelineno-90-20><span class=linenos data-linenos="20 "></span></a>    <span class=kd>throws</span> <span class=n>GlideException</span> <span class=p>{</span>
<a id=__codelineno-90-21 name=__codelineno-90-21></a><a href=#__codelineno-90-21><span class=linenos data-linenos="21 "></span></a>  <span class=n>LoadPath</span><span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span> <span class=o>?</span><span class=p>,</span> <span class=n>R</span><span class=o>&gt;</span> <span class=n>path</span> <span class=o>=</span> <span class=n>decodeHelper</span><span class=p>.</span><span class=na>getLoadPath</span><span class=p>((</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span><span class=p>)</span> <span class=n>data</span><span class=p>.</span><span class=na>getClass</span><span class=p>());</span>
<a id=__codelineno-90-22 name=__codelineno-90-22></a><a href=#__codelineno-90-22><span class=linenos data-linenos="22 "></span></a>  <span class=k>return</span> <span class=n>runLoadPath</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>dataSource</span><span class=p>,</span> <span class=n>path</span><span class=p>);</span>
<a id=__codelineno-90-23 name=__codelineno-90-23></a><a href=#__codelineno-90-23><span class=linenos data-linenos="23 "></span></a><span class=p>}</span>
<a id=__codelineno-90-24 name=__codelineno-90-24></a><a href=#__codelineno-90-24><span class=linenos data-linenos="24 "></span></a>
<a id=__codelineno-90-25 name=__codelineno-90-25></a><a href=#__codelineno-90-25><span class=linenos data-linenos="25 "></span></a><span class=kd>private</span> <span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span> <span class=n>ResourceType</span><span class=o>&gt;</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=nf>runLoadPath</span><span class=p>(</span><span class=n>Data</span> <span class=n>data</span><span class=p>,</span> <span class=n>DataSource</span> <span class=n>dataSource</span><span class=p>,</span>
<a id=__codelineno-90-26 name=__codelineno-90-26></a><a href=#__codelineno-90-26><span class=linenos data-linenos="26 "></span></a>    <span class=n>LoadPath</span><span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span> <span class=n>ResourceType</span><span class=p>,</span> <span class=n>R</span><span class=o>&gt;</span> <span class=n>path</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>GlideException</span> <span class=p>{</span>
<a id=__codelineno-90-27 name=__codelineno-90-27></a><a href=#__codelineno-90-27><span class=linenos data-linenos="27 "></span></a>  <span class=n>Options</span> <span class=n>options</span> <span class=o>=</span> <span class=n>getOptionsWithHardwareConfig</span><span class=p>(</span><span class=n>dataSource</span><span class=p>);</span>
<a id=__codelineno-90-28 name=__codelineno-90-28></a><a href=#__codelineno-90-28><span class=linenos data-linenos="28 "></span></a>  <span class=n>DataRewinder</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>rewinder</span> <span class=o>=</span> <span class=n>glideContext</span><span class=p>.</span><span class=na>getRegistry</span><span class=p>().</span><span class=na>getRewinder</span><span class=p>(</span><span class=n>data</span><span class=p>);</span>
<a id=__codelineno-90-29 name=__codelineno-90-29></a><a href=#__codelineno-90-29><span class=linenos data-linenos="29 "></span></a>  <span class=k>try</span> <span class=p>{</span>
<a id=__codelineno-90-30 name=__codelineno-90-30></a><a href=#__codelineno-90-30><span class=linenos data-linenos="30 "></span></a>    <span class=c1>// ResourceType in DecodeCallback below is required for compilation to work with gradle.</span>
<a id=__codelineno-90-31 name=__codelineno-90-31></a><a href=#__codelineno-90-31><span class=linenos data-linenos="31 "></span></a>    <span class=k>return</span> <span class=n>path</span><span class=p>.</span><span class=na>load</span><span class=p>(</span>
<a id=__codelineno-90-32 name=__codelineno-90-32></a><a href=#__codelineno-90-32><span class=linenos data-linenos="32 "></span></a>        <span class=n>rewinder</span><span class=p>,</span> <span class=n>options</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>,</span> <span class=k>new</span> <span class=n>DecodeCallback</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span><span class=p>(</span><span class=n>dataSource</span><span class=p>));</span>
<a id=__codelineno-90-33 name=__codelineno-90-33></a><a href=#__codelineno-90-33><span class=linenos data-linenos="33 "></span></a>  <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
<a id=__codelineno-90-34 name=__codelineno-90-34></a><a href=#__codelineno-90-34><span class=linenos data-linenos="34 "></span></a>    <span class=n>rewinder</span><span class=p>.</span><span class=na>cleanup</span><span class=p>();</span>
<a id=__codelineno-90-35 name=__codelineno-90-35></a><a href=#__codelineno-90-35><span class=linenos data-linenos="35 "></span></a>  <span class=p>}</span>
<a id=__codelineno-90-36 name=__codelineno-90-36></a><a href=#__codelineno-90-36><span class=linenos data-linenos="36 "></span></a><span class=p>}</span>
</code></pre></div> <p>æ³¨æ„<code>runLoadPath</code>æ–¹æ³•ä½¿ç”¨åˆ°äº†<code>DataRewinder</code>ï¼Œè¿™æ˜¯ä¸€ä¸ªå°†æ•°æ®æµé‡Œé¢çš„æŒ‡é’ˆé‡æ–°æŒ‡å‘å¼€å¤´çš„ç±»ï¼Œåœ¨è°ƒç”¨<code>ResourceDecoder</code>å¯¹dataè¿›è¡Œç¼–ç æ—¶ä¼šå°è¯•å¾ˆå¤šä¸ªç¼–ç å™¨ï¼Œæ‰€ä»¥æ¯ä¸€æ¬¡å°è¯•åéƒ½éœ€è¦é‡ç½®ç´¢å¼•ã€‚<br> åœ¨Glideåˆå§‹åŒ–çš„æ—¶å€™é»˜è®¤æ³¨å…¥äº†<code>ByteBufferRewinder</code>å’Œ<code>InputStreamRewinder</code>è¿™ä¸¤ä¸ªç±»çš„å·¥å‚ã€‚è¿™æ ·å°±ä¸º<code>ByteBuffer</code>å’Œ<code>InputStream</code>çš„é‡å®šå‘æä¾›äº†å®ç°ã€‚ </p> <p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œåœ¨<code>path.load(rewinder, options, width, height, new DecodeCallback&lt;ResourceType&gt;(dataSource))</code>è¿™è¡Œä»£ç ä¸­ï¼Œæœ€åä¼ å…¥äº†ä¸€ä¸ª<code>DecodeCallback</code>å›è°ƒï¼Œè¯¥ç±»çš„å›è°ƒæ–¹æ³•ä¼šå›è°ƒç»™<code>DecodeJob</code>å¯¹åº”çš„æ–¹æ³•ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-91-1 name=__codelineno-91-1></a><a href=#__codelineno-91-1><span class=linenos data-linenos=" 1 "></span></a><span class=kd>private</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>DecodeCallback</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=kd>implements</span> <span class=n>DecodePath</span><span class=p>.</span><span class=na>DecodeCallback</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=p>{</span>
<a id=__codelineno-91-2 name=__codelineno-91-2></a><a href=#__codelineno-91-2><span class=linenos data-linenos=" 2 "></span></a>
<a id=__codelineno-91-3 name=__codelineno-91-3></a><a href=#__codelineno-91-3><span class=linenos data-linenos=" 3 "></span></a>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>DataSource</span> <span class=n>dataSource</span><span class=p>;</span>
<a id=__codelineno-91-4 name=__codelineno-91-4></a><a href=#__codelineno-91-4><span class=linenos data-linenos=" 4 "></span></a>
<a id=__codelineno-91-5 name=__codelineno-91-5></a><a href=#__codelineno-91-5><span class=linenos data-linenos=" 5 "></span></a>  <span class=nd>@Synthetic</span>
<a id=__codelineno-91-6 name=__codelineno-91-6></a><a href=#__codelineno-91-6><span class=linenos data-linenos=" 6 "></span></a>  <span class=n>DecodeCallback</span><span class=p>(</span><span class=n>DataSource</span> <span class=n>dataSource</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-91-7 name=__codelineno-91-7></a><a href=#__codelineno-91-7><span class=linenos data-linenos=" 7 "></span></a>    <span class=k>this</span><span class=p>.</span><span class=na>dataSource</span> <span class=o>=</span> <span class=n>dataSource</span><span class=p>;</span>
<a id=__codelineno-91-8 name=__codelineno-91-8></a><a href=#__codelineno-91-8><span class=linenos data-linenos=" 8 "></span></a>  <span class=p>}</span>
<a id=__codelineno-91-9 name=__codelineno-91-9></a><a href=#__codelineno-91-9><span class=linenos data-linenos=" 9 "></span></a>
<a id=__codelineno-91-10 name=__codelineno-91-10></a><a href=#__codelineno-91-10><span class=linenos data-linenos="10 "></span></a>  <span class=nd>@NonNull</span>
<a id=__codelineno-91-11 name=__codelineno-91-11></a><a href=#__codelineno-91-11><span class=linenos data-linenos="11 "></span></a>  <span class=nd>@Override</span>
<a id=__codelineno-91-12 name=__codelineno-91-12></a><a href=#__codelineno-91-12><span class=linenos data-linenos="12 "></span></a>  <span class=kd>public</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=nf>onResourceDecoded</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>decoded</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-91-13 name=__codelineno-91-13></a><a href=#__codelineno-91-13><span class=linenos data-linenos="13 "></span></a>    <span class=k>return</span> <span class=n>DecodeJob</span><span class=p>.</span><span class=na>this</span><span class=p>.</span><span class=na>onResourceDecoded</span><span class=p>(</span><span class=n>dataSource</span><span class=p>,</span> <span class=n>decoded</span><span class=p>);</span>
<a id=__codelineno-91-14 name=__codelineno-91-14></a><a href=#__codelineno-91-14><span class=linenos data-linenos="14 "></span></a>  <span class=p>}</span>
<a id=__codelineno-91-15 name=__codelineno-91-15></a><a href=#__codelineno-91-15><span class=linenos data-linenos="15 "></span></a><span class=p>}</span>
</code></pre></div> <p>ç„¶åæˆ‘ä»¬çœ‹ä¸€ä¸‹<code>LoadPath.load</code>æ–¹æ³•çš„å®ç°ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-92-1 name=__codelineno-92-1></a><a href=#__codelineno-92-1><span class=linenos data-linenos="1 "></span></a><span class=kd>public</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Transcode</span><span class=o>&gt;</span> <span class=nf>load</span><span class=p>(</span><span class=n>DataRewinder</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>rewinder</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Options</span> <span class=n>options</span><span class=p>,</span> <span class=kt>int</span> <span class=n>width</span><span class=p>,</span>
<a id=__codelineno-92-2 name=__codelineno-92-2></a><a href=#__codelineno-92-2><span class=linenos data-linenos="2 "></span></a>    <span class=kt>int</span> <span class=n>height</span><span class=p>,</span> <span class=n>DecodePath</span><span class=p>.</span><span class=na>DecodeCallback</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span> <span class=n>decodeCallback</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>GlideException</span> <span class=p>{</span>
<a id=__codelineno-92-3 name=__codelineno-92-3></a><a href=#__codelineno-92-3><span class=linenos data-linenos="3 "></span></a>  <span class=n>List</span><span class=o>&lt;</span><span class=n>Throwable</span><span class=o>&gt;</span> <span class=n>throwables</span> <span class=o>=</span> <span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>listPool</span><span class=p>.</span><span class=na>acquire</span><span class=p>());</span>
<a id=__codelineno-92-4 name=__codelineno-92-4></a><a href=#__codelineno-92-4><span class=linenos data-linenos="4 "></span></a>  <span class=k>try</span> <span class=p>{</span>
<a id=__codelineno-92-5 name=__codelineno-92-5></a><a href=#__codelineno-92-5><span class=linenos data-linenos="5 "></span></a>    <span class=k>return</span> <span class=n>loadWithExceptionList</span><span class=p>(</span><span class=n>rewinder</span><span class=p>,</span> <span class=n>options</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>,</span> <span class=n>decodeCallback</span><span class=p>,</span> <span class=n>throwables</span><span class=p>);</span>
<a id=__codelineno-92-6 name=__codelineno-92-6></a><a href=#__codelineno-92-6><span class=linenos data-linenos="6 "></span></a>  <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
<a id=__codelineno-92-7 name=__codelineno-92-7></a><a href=#__codelineno-92-7><span class=linenos data-linenos="7 "></span></a>    <span class=n>listPool</span><span class=p>.</span><span class=na>release</span><span class=p>(</span><span class=n>throwables</span><span class=p>);</span>
<a id=__codelineno-92-8 name=__codelineno-92-8></a><a href=#__codelineno-92-8><span class=linenos data-linenos="8 "></span></a>  <span class=p>}</span>
<a id=__codelineno-92-9 name=__codelineno-92-9></a><a href=#__codelineno-92-9><span class=linenos data-linenos="9 "></span></a><span class=p>}</span>
</code></pre></div> <p>ummmmï¼Œè¿™é‡Œè°ƒç”¨äº†<code>loadWithExceptionList</code>æ–¹æ³•ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-93-1 name=__codelineno-93-1></a><a href=#__codelineno-93-1><span class=linenos data-linenos=" 1 "></span></a><span class=kd>private</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Transcode</span><span class=o>&gt;</span> <span class=nf>loadWithExceptionList</span><span class=p>(</span><span class=n>DataRewinder</span><span class=o>&lt;</span><span class=n>Data</span><span class=o>&gt;</span> <span class=n>rewinder</span><span class=p>,</span>
<a id=__codelineno-93-2 name=__codelineno-93-2></a><a href=#__codelineno-93-2><span class=linenos data-linenos=" 2 "></span></a>    <span class=nd>@NonNull</span> <span class=n>Options</span> <span class=n>options</span><span class=p>,</span>
<a id=__codelineno-93-3 name=__codelineno-93-3></a><a href=#__codelineno-93-3><span class=linenos data-linenos=" 3 "></span></a>    <span class=kt>int</span> <span class=n>width</span><span class=p>,</span> <span class=kt>int</span> <span class=n>height</span><span class=p>,</span> <span class=n>DecodePath</span><span class=p>.</span><span class=na>DecodeCallback</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span> <span class=n>decodeCallback</span><span class=p>,</span>
<a id=__codelineno-93-4 name=__codelineno-93-4></a><a href=#__codelineno-93-4><span class=linenos data-linenos=" 4 "></span></a>    <span class=n>List</span><span class=o>&lt;</span><span class=n>Throwable</span><span class=o>&gt;</span> <span class=n>exceptions</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>GlideException</span> <span class=p>{</span>
<a id=__codelineno-93-5 name=__codelineno-93-5></a><a href=#__codelineno-93-5><span class=linenos data-linenos=" 5 "></span></a>  <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Transcode</span><span class=o>&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-93-6 name=__codelineno-93-6></a><a href=#__codelineno-93-6><span class=linenos data-linenos=" 6 "></span></a>  <span class=c1>//noinspection ForLoopReplaceableByForEach to improve perf</span>
<a id=__codelineno-93-7 name=__codelineno-93-7></a><a href=#__codelineno-93-7><span class=linenos data-linenos=" 7 "></span></a>  <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>size</span> <span class=o>=</span> <span class=n>decodePaths</span><span class=p>.</span><span class=na>size</span><span class=p>();</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>size</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-93-8 name=__codelineno-93-8></a><a href=#__codelineno-93-8><span class=linenos data-linenos=" 8 "></span></a>    <span class=n>DecodePath</span><span class=o>&lt;</span><span class=n>Data</span><span class=p>,</span> <span class=n>ResourceType</span><span class=p>,</span> <span class=n>Transcode</span><span class=o>&gt;</span> <span class=n>path</span> <span class=o>=</span> <span class=n>decodePaths</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
<a id=__codelineno-93-9 name=__codelineno-93-9></a><a href=#__codelineno-93-9><span class=linenos data-linenos=" 9 "></span></a>    <span class=k>try</span> <span class=p>{</span>
<a id=__codelineno-93-10 name=__codelineno-93-10></a><a href=#__codelineno-93-10><span class=linenos data-linenos="10 "></span></a>      <span class=n>result</span> <span class=o>=</span> <span class=n>path</span><span class=p>.</span><span class=na>decode</span><span class=p>(</span><span class=n>rewinder</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>,</span> <span class=n>options</span><span class=p>,</span> <span class=n>decodeCallback</span><span class=p>);</span>
<a id=__codelineno-93-11 name=__codelineno-93-11></a><a href=#__codelineno-93-11><span class=linenos data-linenos="11 "></span></a>    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>GlideException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-93-12 name=__codelineno-93-12></a><a href=#__codelineno-93-12><span class=linenos data-linenos="12 "></span></a>      <span class=n>exceptions</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>e</span><span class=p>);</span>
<a id=__codelineno-93-13 name=__codelineno-93-13></a><a href=#__codelineno-93-13><span class=linenos data-linenos="13 "></span></a>    <span class=p>}</span>
<a id=__codelineno-93-14 name=__codelineno-93-14></a><a href=#__codelineno-93-14><span class=linenos data-linenos="14 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>result</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-93-15 name=__codelineno-93-15></a><a href=#__codelineno-93-15><span class=linenos data-linenos="15 "></span></a>      <span class=k>break</span><span class=p>;</span>
<a id=__codelineno-93-16 name=__codelineno-93-16></a><a href=#__codelineno-93-16><span class=linenos data-linenos="16 "></span></a>    <span class=p>}</span>
<a id=__codelineno-93-17 name=__codelineno-93-17></a><a href=#__codelineno-93-17><span class=linenos data-linenos="17 "></span></a>  <span class=p>}</span>
<a id=__codelineno-93-18 name=__codelineno-93-18></a><a href=#__codelineno-93-18><span class=linenos data-linenos="18 "></span></a>
<a id=__codelineno-93-19 name=__codelineno-93-19></a><a href=#__codelineno-93-19><span class=linenos data-linenos="19 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>result</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-93-20 name=__codelineno-93-20></a><a href=#__codelineno-93-20><span class=linenos data-linenos="20 "></span></a>    <span class=k>throw</span> <span class=k>new</span> <span class=n>GlideException</span><span class=p>(</span><span class=n>failureMessage</span><span class=p>,</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>exceptions</span><span class=p>));</span>
<a id=__codelineno-93-21 name=__codelineno-93-21></a><a href=#__codelineno-93-21><span class=linenos data-linenos="21 "></span></a>  <span class=p>}</span>
<a id=__codelineno-93-22 name=__codelineno-93-22></a><a href=#__codelineno-93-22><span class=linenos data-linenos="22 "></span></a>
<a id=__codelineno-93-23 name=__codelineno-93-23></a><a href=#__codelineno-93-23><span class=linenos data-linenos="23 "></span></a>  <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
<a id=__codelineno-93-24 name=__codelineno-93-24></a><a href=#__codelineno-93-24><span class=linenos data-linenos="24 "></span></a><span class=p>}</span>
</code></pre></div> <p>å¯¹äºæ¯æ¡DecodePathï¼Œéƒ½è°ƒç”¨å…¶<code>decode</code>æ–¹æ³•ï¼Œç›´åˆ°æœ‰ä¸€ä¸ªDecodePathå¯ä»¥decodeå‡ºèµ„æºã€‚<br> é‚£ä¹ˆæˆ‘ä»¬ç»§ç»­çœ‹çœ‹<code>DecodePath.decode</code>æ–¹æ³•ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-94-1 name=__codelineno-94-1></a><a href=#__codelineno-94-1><span class=linenos data-linenos="1 "></span></a><span class=kd>public</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Transcode</span><span class=o>&gt;</span> <span class=nf>decode</span><span class=p>(</span><span class=n>DataRewinder</span><span class=o>&lt;</span><span class=n>DataType</span><span class=o>&gt;</span> <span class=n>rewinder</span><span class=p>,</span> <span class=kt>int</span> <span class=n>width</span><span class=p>,</span> <span class=kt>int</span> <span class=n>height</span><span class=p>,</span>
<a id=__codelineno-94-2 name=__codelineno-94-2></a><a href=#__codelineno-94-2><span class=linenos data-linenos="2 "></span></a>    <span class=nd>@NonNull</span> <span class=n>Options</span> <span class=n>options</span><span class=p>,</span> <span class=n>DecodeCallback</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span> <span class=n>callback</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>GlideException</span> <span class=p>{</span>
<a id=__codelineno-94-3 name=__codelineno-94-3></a><a href=#__codelineno-94-3><span class=linenos data-linenos="3 "></span></a>  <span class=n>Resource</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span> <span class=n>decoded</span> <span class=o>=</span> <span class=n>decodeResource</span><span class=p>(</span><span class=n>rewinder</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>,</span> <span class=n>options</span><span class=p>);</span>
<a id=__codelineno-94-4 name=__codelineno-94-4></a><a href=#__codelineno-94-4><span class=linenos data-linenos="4 "></span></a>  <span class=n>Resource</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span> <span class=n>transformed</span> <span class=o>=</span> <span class=n>callback</span><span class=p>.</span><span class=na>onResourceDecoded</span><span class=p>(</span><span class=n>decoded</span><span class=p>);</span>
<a id=__codelineno-94-5 name=__codelineno-94-5></a><a href=#__codelineno-94-5><span class=linenos data-linenos="5 "></span></a>  <span class=k>return</span> <span class=n>transcoder</span><span class=p>.</span><span class=na>transcode</span><span class=p>(</span><span class=n>transformed</span><span class=p>,</span> <span class=n>options</span><span class=p>);</span>
<a id=__codelineno-94-6 name=__codelineno-94-6></a><a href=#__codelineno-94-6><span class=linenos data-linenos="6 "></span></a><span class=p>}</span>
</code></pre></div> <p>æ˜¾è€Œæ˜“è§ï¼Œè¿™é‡Œæœ‰3æ­¥ï¼š</p> <ol> <li>ä½¿ç”¨ResourceDecoder Listè¿›è¡Œdecode</li> <li>å°†decodedçš„èµ„æºè¿›è¡Œtransform</li> <li>å°†transformedçš„èµ„æºè¿›è¡Œtranscode</li> </ol> <p>åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œç¬¬äºŒæ¡DecodePath(<code>DecodePath{ dataClass=class java.nio.DirectByteBuffer, decoders=[ByteBufferBitmapDecoder@1ca5fe14], transcoder=BitmapDrawableTranscoder@1d8f76bd}</code>)å¯ä»¥æˆåŠŸå¤„ç†ï¼Œå¹¶è¿”å›çš„æ˜¯ä¸€ä¸ª<code>LazyBitmapDrawableResource</code>å¯¹è±¡ã€‚</p> <p>æˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™é‡Œé¢çš„æ“ä½œè¿‡ç¨‹ï¼Œé¦–å…ˆæ˜¯<code>decodeResource</code>çš„è¿‡ç¨‹ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-95-1 name=__codelineno-95-1></a><a href=#__codelineno-95-1><span class=linenos data-linenos=" 1 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-95-2 name=__codelineno-95-2></a><a href=#__codelineno-95-2><span class=linenos data-linenos=" 2 "></span></a><span class=kd>private</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span> <span class=nf>decodeResource</span><span class=p>(</span><span class=n>DataRewinder</span><span class=o>&lt;</span><span class=n>DataType</span><span class=o>&gt;</span> <span class=n>rewinder</span><span class=p>,</span> <span class=kt>int</span> <span class=n>width</span><span class=p>,</span>
<a id=__codelineno-95-3 name=__codelineno-95-3></a><a href=#__codelineno-95-3><span class=linenos data-linenos=" 3 "></span></a>    <span class=kt>int</span> <span class=n>height</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Options</span> <span class=n>options</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>GlideException</span> <span class=p>{</span>
<a id=__codelineno-95-4 name=__codelineno-95-4></a><a href=#__codelineno-95-4><span class=linenos data-linenos=" 4 "></span></a>  <span class=n>List</span><span class=o>&lt;</span><span class=n>Throwable</span><span class=o>&gt;</span> <span class=n>exceptions</span> <span class=o>=</span> <span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>listPool</span><span class=p>.</span><span class=na>acquire</span><span class=p>());</span>
<a id=__codelineno-95-5 name=__codelineno-95-5></a><a href=#__codelineno-95-5><span class=linenos data-linenos=" 5 "></span></a>  <span class=k>try</span> <span class=p>{</span>
<a id=__codelineno-95-6 name=__codelineno-95-6></a><a href=#__codelineno-95-6><span class=linenos data-linenos=" 6 "></span></a>    <span class=k>return</span> <span class=n>decodeResourceWithList</span><span class=p>(</span><span class=n>rewinder</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>,</span> <span class=n>options</span><span class=p>,</span> <span class=n>exceptions</span><span class=p>);</span>
<a id=__codelineno-95-7 name=__codelineno-95-7></a><a href=#__codelineno-95-7><span class=linenos data-linenos=" 7 "></span></a>  <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
<a id=__codelineno-95-8 name=__codelineno-95-8></a><a href=#__codelineno-95-8><span class=linenos data-linenos=" 8 "></span></a>    <span class=n>listPool</span><span class=p>.</span><span class=na>release</span><span class=p>(</span><span class=n>exceptions</span><span class=p>);</span>
<a id=__codelineno-95-9 name=__codelineno-95-9></a><a href=#__codelineno-95-9><span class=linenos data-linenos=" 9 "></span></a>  <span class=p>}</span>
<a id=__codelineno-95-10 name=__codelineno-95-10></a><a href=#__codelineno-95-10><span class=linenos data-linenos="10 "></span></a><span class=p>}</span>
<a id=__codelineno-95-11 name=__codelineno-95-11></a><a href=#__codelineno-95-11><span class=linenos data-linenos="11 "></span></a>
<a id=__codelineno-95-12 name=__codelineno-95-12></a><a href=#__codelineno-95-12><span class=linenos data-linenos="12 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-95-13 name=__codelineno-95-13></a><a href=#__codelineno-95-13><span class=linenos data-linenos="13 "></span></a><span class=kd>private</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span> <span class=nf>decodeResourceWithList</span><span class=p>(</span><span class=n>DataRewinder</span><span class=o>&lt;</span><span class=n>DataType</span><span class=o>&gt;</span> <span class=n>rewinder</span><span class=p>,</span> <span class=kt>int</span> <span class=n>width</span><span class=p>,</span>
<a id=__codelineno-95-14 name=__codelineno-95-14></a><a href=#__codelineno-95-14><span class=linenos data-linenos="14 "></span></a>    <span class=kt>int</span> <span class=n>height</span><span class=p>,</span> <span class=nd>@NonNull</span> <span class=n>Options</span> <span class=n>options</span><span class=p>,</span> <span class=n>List</span><span class=o>&lt;</span><span class=n>Throwable</span><span class=o>&gt;</span> <span class=n>exceptions</span><span class=p>)</span> <span class=kd>throws</span> <span class=n>GlideException</span> <span class=p>{</span>
<a id=__codelineno-95-15 name=__codelineno-95-15></a><a href=#__codelineno-95-15><span class=linenos data-linenos="15 "></span></a>  <span class=n>Resource</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-95-16 name=__codelineno-95-16></a><a href=#__codelineno-95-16><span class=linenos data-linenos="16 "></span></a>  <span class=c1>//noinspection ForLoopReplaceableByForEach to improve perf</span>
<a id=__codelineno-95-17 name=__codelineno-95-17></a><a href=#__codelineno-95-17><span class=linenos data-linenos="17 "></span></a>  <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span> <span class=n>size</span> <span class=o>=</span> <span class=n>decoders</span><span class=p>.</span><span class=na>size</span><span class=p>();</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>size</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-95-18 name=__codelineno-95-18></a><a href=#__codelineno-95-18><span class=linenos data-linenos="18 "></span></a>    <span class=c1>// decodersåªæœ‰ä¸€æ¡ï¼Œå°±æ˜¯ByteBufferBitmapDecoder</span>
<a id=__codelineno-95-19 name=__codelineno-95-19></a><a href=#__codelineno-95-19><span class=linenos data-linenos="19 "></span></a>    <span class=n>ResourceDecoder</span><span class=o>&lt;</span><span class=n>DataType</span><span class=p>,</span> <span class=n>ResourceType</span><span class=o>&gt;</span> <span class=n>decoder</span> <span class=o>=</span> <span class=n>decoders</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
<a id=__codelineno-95-20 name=__codelineno-95-20></a><a href=#__codelineno-95-20><span class=linenos data-linenos="20 "></span></a>    <span class=k>try</span> <span class=p>{</span>
<a id=__codelineno-95-21 name=__codelineno-95-21></a><a href=#__codelineno-95-21><span class=linenos data-linenos="21 "></span></a>      <span class=c1>// rewinderè‡ªç„¶æ˜¯ByteBufferRewind</span>
<a id=__codelineno-95-22 name=__codelineno-95-22></a><a href=#__codelineno-95-22><span class=linenos data-linenos="22 "></span></a>      <span class=c1>// dataä¸ºByteBuffer</span>
<a id=__codelineno-95-23 name=__codelineno-95-23></a><a href=#__codelineno-95-23><span class=linenos data-linenos="23 "></span></a>      <span class=n>DataType</span> <span class=n>data</span> <span class=o>=</span> <span class=n>rewinder</span><span class=p>.</span><span class=na>rewindAndGet</span><span class=p>();</span>
<a id=__codelineno-95-24 name=__codelineno-95-24></a><a href=#__codelineno-95-24><span class=linenos data-linenos="24 "></span></a>      <span class=c1>// ByteBufferBitmapDecoderå†…éƒ¨ä¼šè°ƒç”¨Downsamplerçš„hanldesæ–¹æ³•</span>
<a id=__codelineno-95-25 name=__codelineno-95-25></a><a href=#__codelineno-95-25><span class=linenos data-linenos="25 "></span></a>      <span class=c1>// å®ƒå¯¹ä»»æ„çš„InputStreamå’ŒByteBufferéƒ½è¿”å›true</span>
<a id=__codelineno-95-26 name=__codelineno-95-26></a><a href=#__codelineno-95-26><span class=linenos data-linenos="26 "></span></a>      <span class=k>if</span> <span class=p>(</span><span class=n>decoder</span><span class=p>.</span><span class=na>handles</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>options</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-95-27 name=__codelineno-95-27></a><a href=#__codelineno-95-27><span class=linenos data-linenos="27 "></span></a>        <span class=c1>// è°ƒç”¨ByteBuffer.position(0)å¤ä½</span>
<a id=__codelineno-95-28 name=__codelineno-95-28></a><a href=#__codelineno-95-28><span class=linenos data-linenos="28 "></span></a>        <span class=n>data</span> <span class=o>=</span> <span class=n>rewinder</span><span class=p>.</span><span class=na>rewindAndGet</span><span class=p>();</span>
<a id=__codelineno-95-29 name=__codelineno-95-29></a><a href=#__codelineno-95-29><span class=linenos data-linenos="29 "></span></a>        <span class=c1>// å¼€å§‹è§£ç </span>
<a id=__codelineno-95-30 name=__codelineno-95-30></a><a href=#__codelineno-95-30><span class=linenos data-linenos="30 "></span></a>        <span class=n>result</span> <span class=o>=</span> <span class=n>decoder</span><span class=p>.</span><span class=na>decode</span><span class=p>(</span><span class=n>data</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>,</span> <span class=n>options</span><span class=p>);</span>
<a id=__codelineno-95-31 name=__codelineno-95-31></a><a href=#__codelineno-95-31><span class=linenos data-linenos="31 "></span></a>      <span class=p>}</span>
<a id=__codelineno-95-32 name=__codelineno-95-32></a><a href=#__codelineno-95-32><span class=linenos data-linenos="32 "></span></a>      <span class=c1>// Some decoders throw unexpectedly. If they do, we shouldn&#39;t fail the entire load path, but</span>
<a id=__codelineno-95-33 name=__codelineno-95-33></a><a href=#__codelineno-95-33><span class=linenos data-linenos="33 "></span></a>      <span class=c1>// instead log and continue. See #2406 for an example.</span>
<a id=__codelineno-95-34 name=__codelineno-95-34></a><a href=#__codelineno-95-34><span class=linenos data-linenos="34 "></span></a>    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>IOException</span> <span class=o>|</span> <span class=n>RuntimeException</span> <span class=o>|</span> <span class=n>OutOfMemoryError</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-95-35 name=__codelineno-95-35></a><a href=#__codelineno-95-35><span class=linenos data-linenos="35 "></span></a>      <span class=k>if</span> <span class=p>(</span><span class=n>Log</span><span class=p>.</span><span class=na>isLoggable</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=n>Log</span><span class=p>.</span><span class=na>VERBOSE</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-95-36 name=__codelineno-95-36></a><a href=#__codelineno-95-36><span class=linenos data-linenos="36 "></span></a>        <span class=n>Log</span><span class=p>.</span><span class=na>v</span><span class=p>(</span><span class=n>TAG</span><span class=p>,</span> <span class=s>&quot;Failed to decode data for &quot;</span> <span class=o>+</span> <span class=n>decoder</span><span class=p>,</span> <span class=n>e</span><span class=p>);</span>
<a id=__codelineno-95-37 name=__codelineno-95-37></a><a href=#__codelineno-95-37><span class=linenos data-linenos="37 "></span></a>      <span class=p>}</span>
<a id=__codelineno-95-38 name=__codelineno-95-38></a><a href=#__codelineno-95-38><span class=linenos data-linenos="38 "></span></a>      <span class=n>exceptions</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>e</span><span class=p>);</span>
<a id=__codelineno-95-39 name=__codelineno-95-39></a><a href=#__codelineno-95-39><span class=linenos data-linenos="39 "></span></a>    <span class=p>}</span>
<a id=__codelineno-95-40 name=__codelineno-95-40></a><a href=#__codelineno-95-40><span class=linenos data-linenos="40 "></span></a>
<a id=__codelineno-95-41 name=__codelineno-95-41></a><a href=#__codelineno-95-41><span class=linenos data-linenos="41 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>result</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-95-42 name=__codelineno-95-42></a><a href=#__codelineno-95-42><span class=linenos data-linenos="42 "></span></a>      <span class=k>break</span><span class=p>;</span>
<a id=__codelineno-95-43 name=__codelineno-95-43></a><a href=#__codelineno-95-43><span class=linenos data-linenos="43 "></span></a>    <span class=p>}</span>
<a id=__codelineno-95-44 name=__codelineno-95-44></a><a href=#__codelineno-95-44><span class=linenos data-linenos="44 "></span></a>  <span class=p>}</span>
<a id=__codelineno-95-45 name=__codelineno-95-45></a><a href=#__codelineno-95-45><span class=linenos data-linenos="45 "></span></a>
<a id=__codelineno-95-46 name=__codelineno-95-46></a><a href=#__codelineno-95-46><span class=linenos data-linenos="46 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>result</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-95-47 name=__codelineno-95-47></a><a href=#__codelineno-95-47><span class=linenos data-linenos="47 "></span></a>    <span class=k>throw</span> <span class=k>new</span> <span class=n>GlideException</span><span class=p>(</span><span class=n>failureMessage</span><span class=p>,</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>exceptions</span><span class=p>));</span>
<a id=__codelineno-95-48 name=__codelineno-95-48></a><a href=#__codelineno-95-48><span class=linenos data-linenos="48 "></span></a>  <span class=p>}</span>
<a id=__codelineno-95-49 name=__codelineno-95-49></a><a href=#__codelineno-95-49><span class=linenos data-linenos="49 "></span></a>  <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
<a id=__codelineno-95-50 name=__codelineno-95-50></a><a href=#__codelineno-95-50><span class=linenos data-linenos="50 "></span></a><span class=p>}</span>
</code></pre></div> <p><code>ByteBufferBitmapDecoder.decode</code>æ–¹æ³•ä¼šå…ˆå°†<code>ByteBuffer</code>è½¬æ¢æˆ<code>InputStream</code>ï¼Œç„¶ååœ¨è°ƒç”¨<code>Downsampler.decode</code>æ–¹æ³•è¿›è¡Œè§£ç ã€‚</p> <div class=highlight><pre><span></span><code><a id=__codelineno-96-1 name=__codelineno-96-1></a><a href=#__codelineno-96-1><span class=linenos data-linenos="1 "></span></a><span class=nd>@Override</span>
<a id=__codelineno-96-2 name=__codelineno-96-2></a><a href=#__codelineno-96-2><span class=linenos data-linenos="2 "></span></a><span class=kd>public</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Bitmap</span><span class=o>&gt;</span> <span class=nf>decode</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>ByteBuffer</span> <span class=n>source</span><span class=p>,</span> <span class=kt>int</span> <span class=n>width</span><span class=p>,</span> <span class=kt>int</span> <span class=n>height</span><span class=p>,</span>
<a id=__codelineno-96-3 name=__codelineno-96-3></a><a href=#__codelineno-96-3><span class=linenos data-linenos="3 "></span></a>    <span class=nd>@NonNull</span> <span class=n>Options</span> <span class=n>options</span><span class=p>)</span>
<a id=__codelineno-96-4 name=__codelineno-96-4></a><a href=#__codelineno-96-4><span class=linenos data-linenos="4 "></span></a>    <span class=kd>throws</span> <span class=n>IOException</span> <span class=p>{</span>
<a id=__codelineno-96-5 name=__codelineno-96-5></a><a href=#__codelineno-96-5><span class=linenos data-linenos="5 "></span></a>  <span class=n>InputStream</span> <span class=n>is</span> <span class=o>=</span> <span class=n>ByteBufferUtil</span><span class=p>.</span><span class=na>toStream</span><span class=p>(</span><span class=n>source</span><span class=p>);</span>
<a id=__codelineno-96-6 name=__codelineno-96-6></a><a href=#__codelineno-96-6><span class=linenos data-linenos="6 "></span></a>  <span class=k>return</span> <span class=n>downsampler</span><span class=p>.</span><span class=na>decode</span><span class=p>(</span><span class=n>is</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>,</span> <span class=n>options</span><span class=p>);</span>
<a id=__codelineno-96-7 name=__codelineno-96-7></a><a href=#__codelineno-96-7><span class=linenos data-linenos="7 "></span></a><span class=p>}</span>
</code></pre></div> <p>è¿™é‡Œé¢ä½¿ç”¨çš„æŠ€å·§ä¹Ÿä¸»è¦æ˜¯ä½¿ç”¨çš„<a href=/android/framework/Bitmap%E7%9A%84%E7%BC%93%E5%AD%98%E4%B8%8E%E5%8A%A0%E8%BD%BD/#1-bitmap>Bitmapçš„åŠ è½½</a>ä¸­æåˆ°çš„æŠ€å·§ã€‚<br> ä¸è¿‡åœ¨Glideä¸­ï¼Œé™¤äº†è®¾ç½®äº†<code>BitmapFactory.Options</code>çš„<code>inJustDecodeBounds</code>å’Œ<code>inSampleSize</code>å±æ€§å¤–ï¼Œè¿˜ä¼šè®¾ç½®<code>inTargetDensity</code>ã€<code>inDensity</code>ã€<code>inScale</code>ã€<code>inPreferredConfig</code>ã€<code>inBitmap</code>å±æ€§ã€‚</p> <blockquote> <p>åœ¨è®¡ç®—å„ç§å€¼çš„æ—¶å€™ï¼Œç”¨åˆ°äº†Mathé‡Œé¢ceilã€floorã€roundå‡½æ•°ã€‚<br> <code>ceil(x)</code>è¡¨ç¤ºä¸å°äºxçš„æœ€å°æ•´æ•°<br> <code>floor(x)</code>è¡¨ç¤ºä¸å¤§äºxçš„æœ€å¤§æ•´æ•°<br> <code>round(x)</code>è¡¨ç¤ºè¡¨ç¤ºå››èˆäº”å…¥ï¼Œç†è§£ä¸ºfloor(x + 0.5) </p> <p><figcaption>ceilã€floorã€roundç¤ºä¾‹</figcaption> </p> <table> <thead> <tr> <th align=center>x</th> <th align=center>ceil</th> <th align=center>floor</th> <th align=center>round</th> </tr> </thead> <tbody> <tr> <td align=center>1.4</td> <td align=center>2.0</td> <td align=center>1.0</td> <td align=center>1</td> </tr> <tr> <td align=center>1.5</td> <td align=center>2.0</td> <td align=center>1.0</td> <td align=center>2</td> </tr> <tr> <td align=center>1.6</td> <td align=center>2.0</td> <td align=center>1.0</td> <td align=center>2</td> </tr> <tr> <td align=center>-1.4</td> <td align=center>-1.0</td> <td align=center>-2.0</td> <td align=center>-1</td> </tr> <tr> <td align=center>-1.5</td> <td align=center>-1.0</td> <td align=center>-2.0</td> <td align=center>-1</td> </tr> <tr> <td align=center>-1.6</td> <td align=center>-1.0</td> <td align=center>-2.0</td> <td align=center>-2</td> </tr> </tbody> </table> <p><figure style="width: 66%" class=align-center> <img src=/assets/images/android/math-floor-ceil.png> <figcaption>flootã€ceilå–å€¼èµ°å‘ç¤ºæ„å›¾</figcaption> </figure></p> </blockquote> <p>è¿™é‡Œæ‰§è¡Œå®Œæ¯•ï¼Œä¼šå°†decodeå‡ºæ¥çš„<code>Bitmap</code>åŒ…è£…æˆä¸ºä¸€ä¸ª<code>BitmapResource</code>å¯¹è±¡ã€‚ç„¶åå°±ä¸€ç›´å¾€ä¸Šè¿”å›ï¼Œè¿”å›åˆ°<code>DecodePath.decode</code>æ–¹æ³•ä¸­ã€‚æ¥ä¸‹æ¥æ‰§è¡Œï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-97-1 name=__codelineno-97-1></a><a href=#__codelineno-97-1><span class=linenos data-linenos="1 "></span></a><span class=n>Resource</span><span class=o>&lt;</span><span class=n>ResourceType</span><span class=o>&gt;</span> <span class=n>transformed</span> <span class=o>=</span> <span class=n>callback</span><span class=p>.</span><span class=na>onResourceDecoded</span><span class=p>(</span><span class=n>decoded</span><span class=p>);</span>
</code></pre></div> <p>è¿™é‡Œçš„<code>callback</code>æˆ‘ä»¬åœ¨å‰é¢æåˆ°è¿‡ï¼Œè¿™ä¼šè°ƒç”¨<code>DecodeJob.onResourceDecoded(DataSource, Resource&lt;Z&gt;)</code>æ–¹æ³•ã€‚</p> <div class=highlight><pre><span></span><code><a id=__codelineno-98-1 name=__codelineno-98-1></a><a href=#__codelineno-98-1><span class=linenos data-linenos=" 1 "></span></a><span class=nd>@Synthetic</span>
<a id=__codelineno-98-2 name=__codelineno-98-2></a><a href=#__codelineno-98-2><span class=linenos data-linenos=" 2 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-98-3 name=__codelineno-98-3></a><a href=#__codelineno-98-3><span class=linenos data-linenos=" 3 "></span></a><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=nf>onResourceDecoded</span><span class=p>(</span><span class=n>DataSource</span> <span class=n>dataSource</span><span class=p>,</span>
<a id=__codelineno-98-4 name=__codelineno-98-4></a><a href=#__codelineno-98-4><span class=linenos data-linenos=" 4 "></span></a>    <span class=nd>@NonNull</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>decoded</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-98-5 name=__codelineno-98-5></a><a href=#__codelineno-98-5><span class=linenos data-linenos=" 5 "></span></a>  <span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;unchecked&quot;</span><span class=p>)</span>
<a id=__codelineno-98-6 name=__codelineno-98-6></a><a href=#__codelineno-98-6><span class=linenos data-linenos=" 6 "></span></a>  <span class=n>Class</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>resourceSubClass</span> <span class=o>=</span> <span class=p>(</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span><span class=p>)</span> <span class=n>decoded</span><span class=p>.</span><span class=na>get</span><span class=p>().</span><span class=na>getClass</span><span class=p>();</span><span class=c1>// Bitmap.class</span>
<a id=__codelineno-98-7 name=__codelineno-98-7></a><a href=#__codelineno-98-7><span class=linenos data-linenos=" 7 "></span></a>  <span class=n>Transformation</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>appliedTransformation</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-98-8 name=__codelineno-98-8></a><a href=#__codelineno-98-8><span class=linenos data-linenos=" 8 "></span></a>  <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>transformed</span> <span class=o>=</span> <span class=n>decoded</span><span class=p>;</span>
<a id=__codelineno-98-9 name=__codelineno-98-9></a><a href=#__codelineno-98-9><span class=linenos data-linenos=" 9 "></span></a>  <span class=c1>// dataSourceä¸ºDATA_DISK_CACHEï¼Œæ‰€ä»¥æ»¡è¶³æ¡ä»¶</span>
<a id=__codelineno-98-10 name=__codelineno-98-10></a><a href=#__codelineno-98-10><span class=linenos data-linenos="10 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>dataSource</span> <span class=o>!=</span> <span class=n>DataSource</span><span class=p>.</span><span class=na>RESOURCE_DISK_CACHE</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-98-11 name=__codelineno-98-11></a><a href=#__codelineno-98-11><span class=linenos data-linenos="11 "></span></a>    <span class=c1>// åœ¨2.2èŠ‚ä¸­ç»™å‡ºäº†ä¸€ä¸ªã€ŒoptionalFitCenter()è¿‡ç¨‹ä¿å­˜çš„KVè¡¨ã€ï¼ŒæŸ¥é˜…å¾—çŸ¥Bitmap.classå¯¹åº”çš„æ­£æ˜¯FitCenter()</span>
<a id=__codelineno-98-12 name=__codelineno-98-12></a><a href=#__codelineno-98-12><span class=linenos data-linenos="12 "></span></a>    <span class=n>appliedTransformation</span> <span class=o>=</span> <span class=n>decodeHelper</span><span class=p>.</span><span class=na>getTransformation</span><span class=p>(</span><span class=n>resourceSubClass</span><span class=p>);</span>
<a id=__codelineno-98-13 name=__codelineno-98-13></a><a href=#__codelineno-98-13><span class=linenos data-linenos="13 "></span></a>    <span class=c1>// å¯¹decodedèµ„æºè¿›è¡Œtransform</span>
<a id=__codelineno-98-14 name=__codelineno-98-14></a><a href=#__codelineno-98-14><span class=linenos data-linenos="14 "></span></a>    <span class=n>transformed</span> <span class=o>=</span> <span class=n>appliedTransformation</span><span class=p>.</span><span class=na>transform</span><span class=p>(</span><span class=n>glideContext</span><span class=p>,</span> <span class=n>decoded</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>);</span>
<a id=__codelineno-98-15 name=__codelineno-98-15></a><a href=#__codelineno-98-15><span class=linenos data-linenos="15 "></span></a>  <span class=p>}</span>
<a id=__codelineno-98-16 name=__codelineno-98-16></a><a href=#__codelineno-98-16><span class=linenos data-linenos="16 "></span></a>  <span class=c1>// TODO: Make this the responsibility of the Transformation.</span>
<a id=__codelineno-98-17 name=__codelineno-98-17></a><a href=#__codelineno-98-17><span class=linenos data-linenos="17 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>decoded</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>transformed</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-98-18 name=__codelineno-98-18></a><a href=#__codelineno-98-18><span class=linenos data-linenos="18 "></span></a>    <span class=n>decoded</span><span class=p>.</span><span class=na>recycle</span><span class=p>();</span>
<a id=__codelineno-98-19 name=__codelineno-98-19></a><a href=#__codelineno-98-19><span class=linenos data-linenos="19 "></span></a>  <span class=p>}</span>
<a id=__codelineno-98-20 name=__codelineno-98-20></a><a href=#__codelineno-98-20><span class=linenos data-linenos="20 "></span></a>
<a id=__codelineno-98-21 name=__codelineno-98-21></a><a href=#__codelineno-98-21><span class=linenos data-linenos="21 "></span></a>  <span class=kd>final</span> <span class=n>EncodeStrategy</span> <span class=n>encodeStrategy</span><span class=p>;</span>
<a id=__codelineno-98-22 name=__codelineno-98-22></a><a href=#__codelineno-98-22><span class=linenos data-linenos="22 "></span></a>  <span class=kd>final</span> <span class=n>ResourceEncoder</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>encoder</span><span class=p>;</span>
<a id=__codelineno-98-23 name=__codelineno-98-23></a><a href=#__codelineno-98-23><span class=linenos data-linenos="23 "></span></a>  <span class=c1>// Bitmapæœ‰æ³¨å†Œå¯¹åº”çš„BitmapEncoderï¼Œæ‰€ä»¥æ˜¯availableçš„</span>
<a id=__codelineno-98-24 name=__codelineno-98-24></a><a href=#__codelineno-98-24><span class=linenos data-linenos="24 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>decodeHelper</span><span class=p>.</span><span class=na>isResourceEncoderAvailable</span><span class=p>(</span><span class=n>transformed</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-98-25 name=__codelineno-98-25></a><a href=#__codelineno-98-25><span class=linenos data-linenos="25 "></span></a>    <span class=c1>// encoderå°±æ˜¯BitmapEncoder</span>
<a id=__codelineno-98-26 name=__codelineno-98-26></a><a href=#__codelineno-98-26><span class=linenos data-linenos="26 "></span></a>    <span class=n>encoder</span> <span class=o>=</span> <span class=n>decodeHelper</span><span class=p>.</span><span class=na>getResultEncoder</span><span class=p>(</span><span class=n>transformed</span><span class=p>);</span>
<a id=__codelineno-98-27 name=__codelineno-98-27></a><a href=#__codelineno-98-27><span class=linenos data-linenos="27 "></span></a>    <span class=c1>// encodeStrategyä¸ºEncodeStrategy.TRANSFORMED</span>
<a id=__codelineno-98-28 name=__codelineno-98-28></a><a href=#__codelineno-98-28><span class=linenos data-linenos="28 "></span></a>    <span class=n>encodeStrategy</span> <span class=o>=</span> <span class=n>encoder</span><span class=p>.</span><span class=na>getEncodeStrategy</span><span class=p>(</span><span class=n>options</span><span class=p>);</span>
<a id=__codelineno-98-29 name=__codelineno-98-29></a><a href=#__codelineno-98-29><span class=linenos data-linenos="29 "></span></a>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
<a id=__codelineno-98-30 name=__codelineno-98-30></a><a href=#__codelineno-98-30><span class=linenos data-linenos="30 "></span></a>    <span class=n>encoder</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-98-31 name=__codelineno-98-31></a><a href=#__codelineno-98-31><span class=linenos data-linenos="31 "></span></a>    <span class=n>encodeStrategy</span> <span class=o>=</span> <span class=n>EncodeStrategy</span><span class=p>.</span><span class=na>NONE</span><span class=p>;</span>
<a id=__codelineno-98-32 name=__codelineno-98-32></a><a href=#__codelineno-98-32><span class=linenos data-linenos="32 "></span></a>  <span class=p>}</span>
<a id=__codelineno-98-33 name=__codelineno-98-33></a><a href=#__codelineno-98-33><span class=linenos data-linenos="33 "></span></a>
<a id=__codelineno-98-34 name=__codelineno-98-34></a><a href=#__codelineno-98-34><span class=linenos data-linenos="34 "></span></a>  <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=n>transformed</span><span class=p>;</span>
<a id=__codelineno-98-35 name=__codelineno-98-35></a><a href=#__codelineno-98-35><span class=linenos data-linenos="35 "></span></a>  <span class=c1>// isSourceKeyæ˜¾ç„¶ä¸ºtrueï¼Œæ‰€ä»¥isFromAlternateCacheKeyä¸ºfalseï¼Œæ‰€ä»¥å°±è¿”å›äº†</span>
<a id=__codelineno-98-36 name=__codelineno-98-36></a><a href=#__codelineno-98-36><span class=linenos data-linenos="36 "></span></a>  <span class=kt>boolean</span> <span class=n>isFromAlternateCacheKey</span> <span class=o>=</span> <span class=o>!</span><span class=n>decodeHelper</span><span class=p>.</span><span class=na>isSourceKey</span><span class=p>(</span><span class=n>currentSourceKey</span><span class=p>);</span>
<a id=__codelineno-98-37 name=__codelineno-98-37></a><a href=#__codelineno-98-37><span class=linenos data-linenos="37 "></span></a>  <span class=c1>// diskCacheStrategyä¸ºAUTOMATICï¼Œè¯¥æ–¹æ³•è¿”å›false</span>
<a id=__codelineno-98-38 name=__codelineno-98-38></a><a href=#__codelineno-98-38><span class=linenos data-linenos="38 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>diskCacheStrategy</span><span class=p>.</span><span class=na>isResourceCacheable</span><span class=p>(</span><span class=n>isFromAlternateCacheKey</span><span class=p>,</span> <span class=n>dataSource</span><span class=p>,</span>
<a id=__codelineno-98-39 name=__codelineno-98-39></a><a href=#__codelineno-98-39><span class=linenos data-linenos="39 "></span></a>      <span class=n>encodeStrategy</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-98-40 name=__codelineno-98-40></a><a href=#__codelineno-98-40><span class=linenos data-linenos="40 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>encoder</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-98-41 name=__codelineno-98-41></a><a href=#__codelineno-98-41><span class=linenos data-linenos="41 "></span></a>      <span class=k>throw</span> <span class=k>new</span> <span class=n>Registry</span><span class=p>.</span><span class=na>NoResultEncoderAvailableException</span><span class=p>(</span><span class=n>transformed</span><span class=p>.</span><span class=na>get</span><span class=p>().</span><span class=na>getClass</span><span class=p>());</span>
<a id=__codelineno-98-42 name=__codelineno-98-42></a><a href=#__codelineno-98-42><span class=linenos data-linenos="42 "></span></a>    <span class=p>}</span>
<a id=__codelineno-98-43 name=__codelineno-98-43></a><a href=#__codelineno-98-43><span class=linenos data-linenos="43 "></span></a>    <span class=kd>final</span> <span class=n>Key</span> <span class=n>key</span><span class=p>;</span>
<a id=__codelineno-98-44 name=__codelineno-98-44></a><a href=#__codelineno-98-44><span class=linenos data-linenos="44 "></span></a>    <span class=k>switch</span> <span class=p>(</span><span class=n>encodeStrategy</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-98-45 name=__codelineno-98-45></a><a href=#__codelineno-98-45><span class=linenos data-linenos="45 "></span></a>      <span class=k>case</span> <span class=n>SOURCE</span><span class=p>:</span>
<a id=__codelineno-98-46 name=__codelineno-98-46></a><a href=#__codelineno-98-46><span class=linenos data-linenos="46 "></span></a>        <span class=n>key</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DataCacheKey</span><span class=p>(</span><span class=n>currentSourceKey</span><span class=p>,</span> <span class=n>signature</span><span class=p>);</span>
<a id=__codelineno-98-47 name=__codelineno-98-47></a><a href=#__codelineno-98-47><span class=linenos data-linenos="47 "></span></a>        <span class=k>break</span><span class=p>;</span>
<a id=__codelineno-98-48 name=__codelineno-98-48></a><a href=#__codelineno-98-48><span class=linenos data-linenos="48 "></span></a>      <span class=k>case</span> <span class=n>TRANSFORMED</span><span class=p>:</span>
<a id=__codelineno-98-49 name=__codelineno-98-49></a><a href=#__codelineno-98-49><span class=linenos data-linenos="49 "></span></a>        <span class=n>key</span> <span class=o>=</span>
<a id=__codelineno-98-50 name=__codelineno-98-50></a><a href=#__codelineno-98-50><span class=linenos data-linenos="50 "></span></a>            <span class=k>new</span> <span class=n>ResourceCacheKey</span><span class=p>(</span>
<a id=__codelineno-98-51 name=__codelineno-98-51></a><a href=#__codelineno-98-51><span class=linenos data-linenos="51 "></span></a>                <span class=n>decodeHelper</span><span class=p>.</span><span class=na>getArrayPool</span><span class=p>(),</span>
<a id=__codelineno-98-52 name=__codelineno-98-52></a><a href=#__codelineno-98-52><span class=linenos data-linenos="52 "></span></a>                <span class=n>currentSourceKey</span><span class=p>,</span>
<a id=__codelineno-98-53 name=__codelineno-98-53></a><a href=#__codelineno-98-53><span class=linenos data-linenos="53 "></span></a>                <span class=n>signature</span><span class=p>,</span>
<a id=__codelineno-98-54 name=__codelineno-98-54></a><a href=#__codelineno-98-54><span class=linenos data-linenos="54 "></span></a>                <span class=n>width</span><span class=p>,</span>
<a id=__codelineno-98-55 name=__codelineno-98-55></a><a href=#__codelineno-98-55><span class=linenos data-linenos="55 "></span></a>                <span class=n>height</span><span class=p>,</span>
<a id=__codelineno-98-56 name=__codelineno-98-56></a><a href=#__codelineno-98-56><span class=linenos data-linenos="56 "></span></a>                <span class=n>appliedTransformation</span><span class=p>,</span>
<a id=__codelineno-98-57 name=__codelineno-98-57></a><a href=#__codelineno-98-57><span class=linenos data-linenos="57 "></span></a>                <span class=n>resourceSubClass</span><span class=p>,</span>
<a id=__codelineno-98-58 name=__codelineno-98-58></a><a href=#__codelineno-98-58><span class=linenos data-linenos="58 "></span></a>                <span class=n>options</span><span class=p>);</span>
<a id=__codelineno-98-59 name=__codelineno-98-59></a><a href=#__codelineno-98-59><span class=linenos data-linenos="59 "></span></a>        <span class=k>break</span><span class=p>;</span>
<a id=__codelineno-98-60 name=__codelineno-98-60></a><a href=#__codelineno-98-60><span class=linenos data-linenos="60 "></span></a>      <span class=k>default</span><span class=p>:</span>
<a id=__codelineno-98-61 name=__codelineno-98-61></a><a href=#__codelineno-98-61><span class=linenos data-linenos="61 "></span></a>        <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&quot;Unknown strategy: &quot;</span> <span class=o>+</span> <span class=n>encodeStrategy</span><span class=p>);</span>
<a id=__codelineno-98-62 name=__codelineno-98-62></a><a href=#__codelineno-98-62><span class=linenos data-linenos="62 "></span></a>    <span class=p>}</span>
<a id=__codelineno-98-63 name=__codelineno-98-63></a><a href=#__codelineno-98-63><span class=linenos data-linenos="63 "></span></a>
<a id=__codelineno-98-64 name=__codelineno-98-64></a><a href=#__codelineno-98-64><span class=linenos data-linenos="64 "></span></a>    <span class=n>LockedResource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>lockedResult</span> <span class=o>=</span> <span class=n>LockedResource</span><span class=p>.</span><span class=na>obtain</span><span class=p>(</span><span class=n>transformed</span><span class=p>);</span>
<a id=__codelineno-98-65 name=__codelineno-98-65></a><a href=#__codelineno-98-65><span class=linenos data-linenos="65 "></span></a>    <span class=n>deferredEncodeManager</span><span class=p>.</span><span class=na>init</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>encoder</span><span class=p>,</span> <span class=n>lockedResult</span><span class=p>);</span>
<a id=__codelineno-98-66 name=__codelineno-98-66></a><a href=#__codelineno-98-66><span class=linenos data-linenos="66 "></span></a>    <span class=n>result</span> <span class=o>=</span> <span class=n>lockedResult</span><span class=p>;</span>
<a id=__codelineno-98-67 name=__codelineno-98-67></a><a href=#__codelineno-98-67><span class=linenos data-linenos="67 "></span></a>  <span class=p>}</span>
<a id=__codelineno-98-68 name=__codelineno-98-68></a><a href=#__codelineno-98-68><span class=linenos data-linenos="68 "></span></a>  <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
<a id=__codelineno-98-69 name=__codelineno-98-69></a><a href=#__codelineno-98-69><span class=linenos data-linenos="69 "></span></a><span class=p>}</span>
</code></pre></div> <p>ç„¶åå°±å›åˆ°<code>DecodePath.decode</code>æ–¹æ³•çš„ç¬¬ä¸‰è¡Œäº†ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-99-1 name=__codelineno-99-1></a><a href=#__codelineno-99-1><span class=linenos data-linenos="1 "></span></a><span class=k>return</span> <span class=n>transcoder</span><span class=p>.</span><span class=na>transcode</span><span class=p>(</span><span class=n>transformed</span><span class=p>,</span> <span class=n>options</span><span class=p>);</span>
</code></pre></div> <p>è¿™é‡Œçš„transcoderå°±æ˜¯<code>BitmapDrawableTranscoder</code>ï¼Œè¯¥æ–¹æ³•è¿”å›äº†ä¸€ä¸ª<code>LazyBitmapDrawableResource</code>ã€‚</p> <p>è‡³æ­¤ï¼Œresourceå·²ç»decodeå®Œæ¯•ã€‚ä¸‹é¢ä¸€ç›´è¿”å›åˆ°<code>DecodeJob.decodeFromRetrievedData()</code>æ–¹æ³•ä¸­ã€‚ä¸‹é¢ä¼šè°ƒç”¨<code>notifyEncodeAndRelease</code>æ–¹æ³•å®Œæˆåé¢çš„äº‹å®œã€‚</p> <div class=highlight><pre><span></span><code><a id=__codelineno-100-1 name=__codelineno-100-1></a><a href=#__codelineno-100-1><span class=linenos data-linenos=" 1 "></span></a><span class=kd>private</span> <span class=kt>void</span> <span class=nf>notifyEncodeAndRelease</span><span class=p>(</span><span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>resource</span><span class=p>,</span> <span class=n>DataSource</span> <span class=n>dataSource</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-100-2 name=__codelineno-100-2></a><a href=#__codelineno-100-2><span class=linenos data-linenos=" 2 "></span></a>  <span class=c1>// resourceæ˜¯BitmapResourceç±»å‹ï¼Œå®ç°äº†Initializableæ¥å£</span>
<a id=__codelineno-100-3 name=__codelineno-100-3></a><a href=#__codelineno-100-3><span class=linenos data-linenos=" 3 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>resource</span> <span class=k>instanceof</span> <span class=n>Initializable</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-100-4 name=__codelineno-100-4></a><a href=#__codelineno-100-4><span class=linenos data-linenos=" 4 "></span></a>    <span class=c1>// initializeæ–¹æ³•è°ƒç”¨äº†bitmap.prepareToDraw()</span>
<a id=__codelineno-100-5 name=__codelineno-100-5></a><a href=#__codelineno-100-5><span class=linenos data-linenos=" 5 "></span></a>    <span class=p>((</span><span class=n>Initializable</span><span class=p>)</span> <span class=n>resource</span><span class=p>).</span><span class=na>initialize</span><span class=p>();</span>
<a id=__codelineno-100-6 name=__codelineno-100-6></a><a href=#__codelineno-100-6><span class=linenos data-linenos=" 6 "></span></a>  <span class=p>}</span>
<a id=__codelineno-100-7 name=__codelineno-100-7></a><a href=#__codelineno-100-7><span class=linenos data-linenos=" 7 "></span></a>
<a id=__codelineno-100-8 name=__codelineno-100-8></a><a href=#__codelineno-100-8><span class=linenos data-linenos=" 8 "></span></a>  <span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=n>resource</span><span class=p>;</span>
<a id=__codelineno-100-9 name=__codelineno-100-9></a><a href=#__codelineno-100-9><span class=linenos data-linenos=" 9 "></span></a>  <span class=n>LockedResource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>lockedResource</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-100-10 name=__codelineno-100-10></a><a href=#__codelineno-100-10><span class=linenos data-linenos="10 "></span></a>  <span class=c1>// ç”±äºåœ¨DecodeJob.onResourceDecodedæ–¹æ³•ä¸­diskCacheStrategy.isResourceCacheableè¿”å›false</span>
<a id=__codelineno-100-11 name=__codelineno-100-11></a><a href=#__codelineno-100-11><span class=linenos data-linenos="11 "></span></a>  <span class=c1>// æ‰€ä»¥æ²¡æœ‰è°ƒç”¨deferredEncodeManager.initæ–¹æ³•ï¼Œå› æ­¤æ­¤å¤„ä¸ºfalse</span>
<a id=__codelineno-100-12 name=__codelineno-100-12></a><a href=#__codelineno-100-12><span class=linenos data-linenos="12 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>deferredEncodeManager</span><span class=p>.</span><span class=na>hasResourceToEncode</span><span class=p>())</span> <span class=p>{</span>
<a id=__codelineno-100-13 name=__codelineno-100-13></a><a href=#__codelineno-100-13><span class=linenos data-linenos="13 "></span></a>    <span class=n>lockedResource</span> <span class=o>=</span> <span class=n>LockedResource</span><span class=p>.</span><span class=na>obtain</span><span class=p>(</span><span class=n>resource</span><span class=p>);</span>
<a id=__codelineno-100-14 name=__codelineno-100-14></a><a href=#__codelineno-100-14><span class=linenos data-linenos="14 "></span></a>    <span class=n>result</span> <span class=o>=</span> <span class=n>lockedResource</span><span class=p>;</span>
<a id=__codelineno-100-15 name=__codelineno-100-15></a><a href=#__codelineno-100-15><span class=linenos data-linenos="15 "></span></a>  <span class=p>}</span>
<a id=__codelineno-100-16 name=__codelineno-100-16></a><a href=#__codelineno-100-16><span class=linenos data-linenos="16 "></span></a>
<a id=__codelineno-100-17 name=__codelineno-100-17></a><a href=#__codelineno-100-17><span class=linenos data-linenos="17 "></span></a>  <span class=c1>// é€šçŸ¥å›è°ƒï¼Œèµ„æºå·²ç»å°±ç»ª</span>
<a id=__codelineno-100-18 name=__codelineno-100-18></a><a href=#__codelineno-100-18><span class=linenos data-linenos="18 "></span></a>  <span class=n>notifyComplete</span><span class=p>(</span><span class=n>result</span><span class=p>,</span> <span class=n>dataSource</span><span class=p>);</span>
<a id=__codelineno-100-19 name=__codelineno-100-19></a><a href=#__codelineno-100-19><span class=linenos data-linenos="19 "></span></a>
<a id=__codelineno-100-20 name=__codelineno-100-20></a><a href=#__codelineno-100-20><span class=linenos data-linenos="20 "></span></a>  <span class=n>stage</span> <span class=o>=</span> <span class=n>Stage</span><span class=p>.</span><span class=na>ENCODE</span><span class=p>;</span>
<a id=__codelineno-100-21 name=__codelineno-100-21></a><a href=#__codelineno-100-21><span class=linenos data-linenos="21 "></span></a>  <span class=k>try</span> <span class=p>{</span>
<a id=__codelineno-100-22 name=__codelineno-100-22></a><a href=#__codelineno-100-22><span class=linenos data-linenos="22 "></span></a>    <span class=c1>// æ­¤å¤„ä¸ºfalse, skip</span>
<a id=__codelineno-100-23 name=__codelineno-100-23></a><a href=#__codelineno-100-23><span class=linenos data-linenos="23 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>deferredEncodeManager</span><span class=p>.</span><span class=na>hasResourceToEncode</span><span class=p>())</span> <span class=p>{</span>
<a id=__codelineno-100-24 name=__codelineno-100-24></a><a href=#__codelineno-100-24><span class=linenos data-linenos="24 "></span></a>      <span class=n>deferredEncodeManager</span><span class=p>.</span><span class=na>encode</span><span class=p>(</span><span class=n>diskCacheProvider</span><span class=p>,</span> <span class=n>options</span><span class=p>);</span>
<a id=__codelineno-100-25 name=__codelineno-100-25></a><a href=#__codelineno-100-25><span class=linenos data-linenos="25 "></span></a>    <span class=p>}</span>
<a id=__codelineno-100-26 name=__codelineno-100-26></a><a href=#__codelineno-100-26><span class=linenos data-linenos="26 "></span></a>  <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
<a id=__codelineno-100-27 name=__codelineno-100-27></a><a href=#__codelineno-100-27><span class=linenos data-linenos="27 "></span></a>    <span class=c1>// lockedResourceä¸ºnull, skip</span>
<a id=__codelineno-100-28 name=__codelineno-100-28></a><a href=#__codelineno-100-28><span class=linenos data-linenos="28 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>lockedResource</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-100-29 name=__codelineno-100-29></a><a href=#__codelineno-100-29><span class=linenos data-linenos="29 "></span></a>      <span class=n>lockedResource</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span>
<a id=__codelineno-100-30 name=__codelineno-100-30></a><a href=#__codelineno-100-30><span class=linenos data-linenos="30 "></span></a>    <span class=p>}</span>
<a id=__codelineno-100-31 name=__codelineno-100-31></a><a href=#__codelineno-100-31><span class=linenos data-linenos="31 "></span></a>  <span class=p>}</span>
<a id=__codelineno-100-32 name=__codelineno-100-32></a><a href=#__codelineno-100-32><span class=linenos data-linenos="32 "></span></a>  <span class=c1>// Call onEncodeComplete outside the finally block so that it&#39;s not called if the encode process</span>
<a id=__codelineno-100-33 name=__codelineno-100-33></a><a href=#__codelineno-100-33><span class=linenos data-linenos="33 "></span></a>  <span class=c1>// throws.</span>
<a id=__codelineno-100-34 name=__codelineno-100-34></a><a href=#__codelineno-100-34><span class=linenos data-linenos="34 "></span></a>  <span class=c1>// è¿›è¡Œæ¸…ç†å·¥ä½œ</span>
<a id=__codelineno-100-35 name=__codelineno-100-35></a><a href=#__codelineno-100-35><span class=linenos data-linenos="35 "></span></a>  <span class=n>onEncodeComplete</span><span class=p>();</span>
<a id=__codelineno-100-36 name=__codelineno-100-36></a><a href=#__codelineno-100-36><span class=linenos data-linenos="36 "></span></a><span class=p>}</span>
</code></pre></div> <p>ä¸Šé¢è¿™æ®µä»£ç é‡ç‚¹åœ¨äº<code>notifyComplete</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å†…éƒ¨ä¼šè°ƒç”¨<code>callback.onResourceReady(resource, dataSource)</code>å°†ç»“æœä¼ é€’ç»™å›è°ƒï¼Œè¿™é‡Œçš„å›è°ƒæ˜¯<code>EngineJob</code>ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-101-1 name=__codelineno-101-1></a><a href=#__codelineno-101-1><span class=linenos data-linenos=" 1 "></span></a><span class=c1>// EngineJob.java</span>
<a id=__codelineno-101-2 name=__codelineno-101-2></a><a href=#__codelineno-101-2><span class=linenos data-linenos=" 2 "></span></a><span class=nd>@Override</span>
<a id=__codelineno-101-3 name=__codelineno-101-3></a><a href=#__codelineno-101-3><span class=linenos data-linenos=" 3 "></span></a><span class=kd>public</span> <span class=kt>void</span> <span class=nf>onResourceReady</span><span class=p>(</span><span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>resource</span><span class=p>,</span> <span class=n>DataSource</span> <span class=n>dataSource</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-101-4 name=__codelineno-101-4></a><a href=#__codelineno-101-4><span class=linenos data-linenos=" 4 "></span></a>  <span class=kd>synchronized</span> <span class=p>(</span><span class=k>this</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-101-5 name=__codelineno-101-5></a><a href=#__codelineno-101-5><span class=linenos data-linenos=" 5 "></span></a>    <span class=k>this</span><span class=p>.</span><span class=na>resource</span> <span class=o>=</span> <span class=n>resource</span><span class=p>;</span>
<a id=__codelineno-101-6 name=__codelineno-101-6></a><a href=#__codelineno-101-6><span class=linenos data-linenos=" 6 "></span></a>    <span class=k>this</span><span class=p>.</span><span class=na>dataSource</span> <span class=o>=</span> <span class=n>dataSource</span><span class=p>;</span>
<a id=__codelineno-101-7 name=__codelineno-101-7></a><a href=#__codelineno-101-7><span class=linenos data-linenos=" 7 "></span></a>  <span class=p>}</span>
<a id=__codelineno-101-8 name=__codelineno-101-8></a><a href=#__codelineno-101-8><span class=linenos data-linenos=" 8 "></span></a>  <span class=n>notifyCallbacksOfResult</span><span class=p>();</span>
<a id=__codelineno-101-9 name=__codelineno-101-9></a><a href=#__codelineno-101-9><span class=linenos data-linenos=" 9 "></span></a><span class=p>}</span>
<a id=__codelineno-101-10 name=__codelineno-101-10></a><a href=#__codelineno-101-10><span class=linenos data-linenos="10 "></span></a>
<a id=__codelineno-101-11 name=__codelineno-101-11></a><a href=#__codelineno-101-11><span class=linenos data-linenos="11 "></span></a><span class=kt>void</span> <span class=nf>notifyCallbacksOfResult</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-101-12 name=__codelineno-101-12></a><a href=#__codelineno-101-12><span class=linenos data-linenos="12 "></span></a>  <span class=n>ResourceCallbacksAndExecutors</span> <span class=n>copy</span><span class=p>;</span>
<a id=__codelineno-101-13 name=__codelineno-101-13></a><a href=#__codelineno-101-13><span class=linenos data-linenos="13 "></span></a>  <span class=n>Key</span> <span class=n>localKey</span><span class=p>;</span>
<a id=__codelineno-101-14 name=__codelineno-101-14></a><a href=#__codelineno-101-14><span class=linenos data-linenos="14 "></span></a>  <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>localResource</span><span class=p>;</span>
<a id=__codelineno-101-15 name=__codelineno-101-15></a><a href=#__codelineno-101-15><span class=linenos data-linenos="15 "></span></a>  <span class=kd>synchronized</span> <span class=p>(</span><span class=k>this</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-101-16 name=__codelineno-101-16></a><a href=#__codelineno-101-16><span class=linenos data-linenos="16 "></span></a>    <span class=n>stateVerifier</span><span class=p>.</span><span class=na>throwIfRecycled</span><span class=p>();</span>
<a id=__codelineno-101-17 name=__codelineno-101-17></a><a href=#__codelineno-101-17><span class=linenos data-linenos="17 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>isCancelled</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-101-18 name=__codelineno-101-18></a><a href=#__codelineno-101-18><span class=linenos data-linenos="18 "></span></a>      <span class=c1>// TODO: Seems like we might as well put this in the memory cache instead of just recycling</span>
<a id=__codelineno-101-19 name=__codelineno-101-19></a><a href=#__codelineno-101-19><span class=linenos data-linenos="19 "></span></a>      <span class=c1>// it since we&#39;ve gotten this far...</span>
<a id=__codelineno-101-20 name=__codelineno-101-20></a><a href=#__codelineno-101-20><span class=linenos data-linenos="20 "></span></a>      <span class=n>resource</span><span class=p>.</span><span class=na>recycle</span><span class=p>();</span>
<a id=__codelineno-101-21 name=__codelineno-101-21></a><a href=#__codelineno-101-21><span class=linenos data-linenos="21 "></span></a>      <span class=n>release</span><span class=p>();</span>
<a id=__codelineno-101-22 name=__codelineno-101-22></a><a href=#__codelineno-101-22><span class=linenos data-linenos="22 "></span></a>      <span class=k>return</span><span class=p>;</span>
<a id=__codelineno-101-23 name=__codelineno-101-23></a><a href=#__codelineno-101-23><span class=linenos data-linenos="23 "></span></a>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>cbs</span><span class=p>.</span><span class=na>isEmpty</span><span class=p>())</span> <span class=p>{</span>
<a id=__codelineno-101-24 name=__codelineno-101-24></a><a href=#__codelineno-101-24><span class=linenos data-linenos="24 "></span></a>      <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&quot;Received a resource without any callbacks to notify&quot;</span><span class=p>);</span>
<a id=__codelineno-101-25 name=__codelineno-101-25></a><a href=#__codelineno-101-25><span class=linenos data-linenos="25 "></span></a>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>hasResource</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-101-26 name=__codelineno-101-26></a><a href=#__codelineno-101-26><span class=linenos data-linenos="26 "></span></a>      <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&quot;Already have resource&quot;</span><span class=p>);</span>
<a id=__codelineno-101-27 name=__codelineno-101-27></a><a href=#__codelineno-101-27><span class=linenos data-linenos="27 "></span></a>    <span class=p>}</span>
<a id=__codelineno-101-28 name=__codelineno-101-28></a><a href=#__codelineno-101-28><span class=linenos data-linenos="28 "></span></a>    <span class=c1>// engineResourceFactoryé»˜è®¤ä¸ºEngineResourceFactory</span>
<a id=__codelineno-101-29 name=__codelineno-101-29></a><a href=#__codelineno-101-29><span class=linenos data-linenos="29 "></span></a>    <span class=c1>// å…¶buildæ–¹æ³•å°±æ˜¯newä¸€ä¸ªå¯¹åº”çš„èµ„æº</span>
<a id=__codelineno-101-30 name=__codelineno-101-30></a><a href=#__codelineno-101-30><span class=linenos data-linenos="30 "></span></a>    <span class=c1>// new EngineResource&lt;&gt;(resource, isMemoryCacheable, /*isRecyclable=*/ true)</span>
<a id=__codelineno-101-31 name=__codelineno-101-31></a><a href=#__codelineno-101-31><span class=linenos data-linenos="31 "></span></a>    <span class=n>engineResource</span> <span class=o>=</span> <span class=n>engineResourceFactory</span><span class=p>.</span><span class=na>build</span><span class=p>(</span><span class=n>resource</span><span class=p>,</span> <span class=n>isCacheable</span><span class=p>);</span>
<a id=__codelineno-101-32 name=__codelineno-101-32></a><a href=#__codelineno-101-32><span class=linenos data-linenos="32 "></span></a>    <span class=c1>// Hold on to resource for duration of our callbacks below so we don&#39;t recycle it in the</span>
<a id=__codelineno-101-33 name=__codelineno-101-33></a><a href=#__codelineno-101-33><span class=linenos data-linenos="33 "></span></a>    <span class=c1>// middle of notifying if it synchronously released by one of the callbacks. Acquire it under</span>
<a id=__codelineno-101-34 name=__codelineno-101-34></a><a href=#__codelineno-101-34><span class=linenos data-linenos="34 "></span></a>    <span class=c1>// a lock here so that any newly added callback that executes before the next locked section</span>
<a id=__codelineno-101-35 name=__codelineno-101-35></a><a href=#__codelineno-101-35><span class=linenos data-linenos="35 "></span></a>    <span class=c1>// below can&#39;t recycle the resource before we call the callbacks.</span>
<a id=__codelineno-101-36 name=__codelineno-101-36></a><a href=#__codelineno-101-36><span class=linenos data-linenos="36 "></span></a>    <span class=n>hasResource</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
<a id=__codelineno-101-37 name=__codelineno-101-37></a><a href=#__codelineno-101-37><span class=linenos data-linenos="37 "></span></a>    <span class=n>copy</span> <span class=o>=</span> <span class=n>cbs</span><span class=p>.</span><span class=na>copy</span><span class=p>();</span>
<a id=__codelineno-101-38 name=__codelineno-101-38></a><a href=#__codelineno-101-38><span class=linenos data-linenos="38 "></span></a>    <span class=n>incrementPendingCallbacks</span><span class=p>(</span><span class=n>copy</span><span class=p>.</span><span class=na>size</span><span class=p>()</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
<a id=__codelineno-101-39 name=__codelineno-101-39></a><a href=#__codelineno-101-39><span class=linenos data-linenos="39 "></span></a>
<a id=__codelineno-101-40 name=__codelineno-101-40></a><a href=#__codelineno-101-40><span class=linenos data-linenos="40 "></span></a>    <span class=n>localKey</span> <span class=o>=</span> <span class=n>key</span><span class=p>;</span>
<a id=__codelineno-101-41 name=__codelineno-101-41></a><a href=#__codelineno-101-41><span class=linenos data-linenos="41 "></span></a>    <span class=n>localResource</span> <span class=o>=</span> <span class=n>engineResource</span><span class=p>;</span>
<a id=__codelineno-101-42 name=__codelineno-101-42></a><a href=#__codelineno-101-42><span class=linenos data-linenos="42 "></span></a>  <span class=p>}</span>
<a id=__codelineno-101-43 name=__codelineno-101-43></a><a href=#__codelineno-101-43><span class=linenos data-linenos="43 "></span></a>
<a id=__codelineno-101-44 name=__codelineno-101-44></a><a href=#__codelineno-101-44><span class=linenos data-linenos="44 "></span></a>  <span class=c1>// listenerå°±æ˜¯Engineï¼Œè¯¥æ–¹æ³•ä¼šè®²èµ„æºä¿å­˜åˆ°activeResourcesä¸­</span>
<a id=__codelineno-101-45 name=__codelineno-101-45></a><a href=#__codelineno-101-45><span class=linenos data-linenos="45 "></span></a>  <span class=n>listener</span><span class=p>.</span><span class=na>onEngineJobComplete</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=n>localKey</span><span class=p>,</span> <span class=n>localResource</span><span class=p>);</span>
<a id=__codelineno-101-46 name=__codelineno-101-46></a><a href=#__codelineno-101-46><span class=linenos data-linenos="46 "></span></a>
<a id=__codelineno-101-47 name=__codelineno-101-47></a><a href=#__codelineno-101-47><span class=linenos data-linenos="47 "></span></a>  <span class=c1>// è¿™é‡Œçš„ResourceCallbackAndExecutorå°±æ˜¯æˆ‘ä»¬åœ¨3.3èŠ‚ä¸­åˆ›å»ºEngineJobå’ŒDecodeJob</span>
<a id=__codelineno-101-48 name=__codelineno-101-48></a><a href=#__codelineno-101-48><span class=linenos data-linenos="48 "></span></a>  <span class=c1>// å¹¶åœ¨æ‰§è¡ŒDecodeJobä¹‹å‰æ·»åŠ çš„å›è°ƒ</span>
<a id=__codelineno-101-49 name=__codelineno-101-49></a><a href=#__codelineno-101-49><span class=linenos data-linenos="49 "></span></a>  <span class=c1>// entry.executorå°±æ˜¯Glide.with.load.intoä¸­å‡ºç°çš„Executors.mainThreadExecutor()</span>
<a id=__codelineno-101-50 name=__codelineno-101-50></a><a href=#__codelineno-101-50><span class=linenos data-linenos="50 "></span></a>  <span class=c1>// entry.cbå°±æ˜¯SingleRequest</span>
<a id=__codelineno-101-51 name=__codelineno-101-51></a><a href=#__codelineno-101-51><span class=linenos data-linenos="51 "></span></a>  <span class=k>for</span> <span class=p>(</span><span class=kd>final</span> <span class=n>ResourceCallbackAndExecutor</span> <span class=n>entry</span> <span class=p>:</span> <span class=n>copy</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-101-52 name=__codelineno-101-52></a><a href=#__codelineno-101-52><span class=linenos data-linenos="52 "></span></a>    <span class=n>entry</span><span class=p>.</span><span class=na>executor</span><span class=p>.</span><span class=na>execute</span><span class=p>(</span><span class=k>new</span> <span class=n>CallResourceReady</span><span class=p>(</span><span class=n>entry</span><span class=p>.</span><span class=na>cb</span><span class=p>));</span>
<a id=__codelineno-101-53 name=__codelineno-101-53></a><a href=#__codelineno-101-53><span class=linenos data-linenos="53 "></span></a>  <span class=p>}</span>
<a id=__codelineno-101-54 name=__codelineno-101-54></a><a href=#__codelineno-101-54><span class=linenos data-linenos="54 "></span></a>  <span class=n>decrementPendingCallbacks</span><span class=p>();</span>
<a id=__codelineno-101-55 name=__codelineno-101-55></a><a href=#__codelineno-101-55><span class=linenos data-linenos="55 "></span></a><span class=p>}</span>
</code></pre></div> <p><code>listener.onEngineJobComplete</code>çš„ä»£ç å¾ˆç®€å•ã€‚é¦–å…ˆä¼šè®¾ç½®èµ„æºçš„å›è°ƒä¸ºè‡ªå·±ï¼Œè¿™æ ·åœ¨èµ„æºé‡Šæ”¾æ—¶ä¼šé€šçŸ¥è‡ªå·±çš„å›è°ƒæ–¹æ³•ï¼Œå°†èµ„æºä»activeçŠ¶æ€å˜ä¸ºcacheçŠ¶æ€ï¼Œå¦‚<code>onResourceReleased</code>æ–¹æ³•ï¼›ç„¶åå°†èµ„æºæ”¾å…¥activeResourcesä¸­ï¼Œèµ„æºå˜ä¸ºactiveçŠ¶æ€ï¼›æœ€åå°†engineJobä»Jobsä¸­ç§»é™¤ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-102-1 name=__codelineno-102-1></a><a href=#__codelineno-102-1><span class=linenos data-linenos=" 1 "></span></a><span class=nd>@Override</span>
<a id=__codelineno-102-2 name=__codelineno-102-2></a><a href=#__codelineno-102-2><span class=linenos data-linenos=" 2 "></span></a><span class=kd>public</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>onEngineJobComplete</span><span class=p>(</span>
<a id=__codelineno-102-3 name=__codelineno-102-3></a><a href=#__codelineno-102-3><span class=linenos data-linenos=" 3 "></span></a>    <span class=n>EngineJob</span><span class=o>&lt;?&gt;</span> <span class=n>engineJob</span><span class=p>,</span> <span class=n>Key</span> <span class=n>key</span><span class=p>,</span> <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>resource</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-102-4 name=__codelineno-102-4></a><a href=#__codelineno-102-4><span class=linenos data-linenos=" 4 "></span></a>  <span class=c1>// A null resource indicates that the load failed, usually due to an exception.</span>
<a id=__codelineno-102-5 name=__codelineno-102-5></a><a href=#__codelineno-102-5><span class=linenos data-linenos=" 5 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>resource</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-102-6 name=__codelineno-102-6></a><a href=#__codelineno-102-6><span class=linenos data-linenos=" 6 "></span></a>    <span class=n>resource</span><span class=p>.</span><span class=na>setResourceListener</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=k>this</span><span class=p>);</span>
<a id=__codelineno-102-7 name=__codelineno-102-7></a><a href=#__codelineno-102-7><span class=linenos data-linenos=" 7 "></span></a>
<a id=__codelineno-102-8 name=__codelineno-102-8></a><a href=#__codelineno-102-8><span class=linenos data-linenos=" 8 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>resource</span><span class=p>.</span><span class=na>isCacheable</span><span class=p>())</span> <span class=p>{</span>
<a id=__codelineno-102-9 name=__codelineno-102-9></a><a href=#__codelineno-102-9><span class=linenos data-linenos=" 9 "></span></a>      <span class=n>activeResources</span><span class=p>.</span><span class=na>activate</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>resource</span><span class=p>);</span>
<a id=__codelineno-102-10 name=__codelineno-102-10></a><a href=#__codelineno-102-10><span class=linenos data-linenos="10 "></span></a>    <span class=p>}</span>
<a id=__codelineno-102-11 name=__codelineno-102-11></a><a href=#__codelineno-102-11><span class=linenos data-linenos="11 "></span></a>  <span class=p>}</span>
<a id=__codelineno-102-12 name=__codelineno-102-12></a><a href=#__codelineno-102-12><span class=linenos data-linenos="12 "></span></a>
<a id=__codelineno-102-13 name=__codelineno-102-13></a><a href=#__codelineno-102-13><span class=linenos data-linenos="13 "></span></a>  <span class=n>jobs</span><span class=p>.</span><span class=na>removeIfCurrent</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>engineJob</span><span class=p>);</span>
<a id=__codelineno-102-14 name=__codelineno-102-14></a><a href=#__codelineno-102-14><span class=linenos data-linenos="14 "></span></a><span class=p>}</span>
<a id=__codelineno-102-15 name=__codelineno-102-15></a><a href=#__codelineno-102-15><span class=linenos data-linenos="15 "></span></a>
<a id=__codelineno-102-16 name=__codelineno-102-16></a><a href=#__codelineno-102-16><span class=linenos data-linenos="16 "></span></a><span class=nd>@Override</span>
<a id=__codelineno-102-17 name=__codelineno-102-17></a><a href=#__codelineno-102-17><span class=linenos data-linenos="17 "></span></a><span class=kd>public</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>onResourceReleased</span><span class=p>(</span><span class=n>Key</span> <span class=n>cacheKey</span><span class=p>,</span> <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>resource</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-102-18 name=__codelineno-102-18></a><a href=#__codelineno-102-18><span class=linenos data-linenos="18 "></span></a>  <span class=n>activeResources</span><span class=p>.</span><span class=na>deactivate</span><span class=p>(</span><span class=n>cacheKey</span><span class=p>);</span>
<a id=__codelineno-102-19 name=__codelineno-102-19></a><a href=#__codelineno-102-19><span class=linenos data-linenos="19 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>resource</span><span class=p>.</span><span class=na>isCacheable</span><span class=p>())</span> <span class=p>{</span>
<a id=__codelineno-102-20 name=__codelineno-102-20></a><a href=#__codelineno-102-20><span class=linenos data-linenos="20 "></span></a>    <span class=n>cache</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>cacheKey</span><span class=p>,</span> <span class=n>resource</span><span class=p>);</span>
<a id=__codelineno-102-21 name=__codelineno-102-21></a><a href=#__codelineno-102-21><span class=linenos data-linenos="21 "></span></a>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
<a id=__codelineno-102-22 name=__codelineno-102-22></a><a href=#__codelineno-102-22><span class=linenos data-linenos="22 "></span></a>    <span class=n>resourceRecycler</span><span class=p>.</span><span class=na>recycle</span><span class=p>(</span><span class=n>resource</span><span class=p>);</span>
<a id=__codelineno-102-23 name=__codelineno-102-23></a><a href=#__codelineno-102-23><span class=linenos data-linenos="23 "></span></a>  <span class=p>}</span>
<a id=__codelineno-102-24 name=__codelineno-102-24></a><a href=#__codelineno-102-24><span class=linenos data-linenos="24 "></span></a><span class=p>}</span>
</code></pre></div> <p>ç„¶åçœ‹ä¸‹<code>entry.executor.execute(new CallResourceReady(entry.cb));</code>çš„å®ç°ï¼Œ<code>Executors.mainThreadExecutor()</code>çš„å®ç°ä¹‹å‰è¯´è¿‡ï¼Œå°±æ˜¯ä¸€ä¸ªä½¿ç”¨MainLooperçš„Handlerï¼Œåœ¨execute Runnableæ—¶ä½¿ç”¨æ­¤Handler postå‡ºå»ã€‚æ‰€ä»¥æˆ‘ä»¬çš„å…³æ³¨ç‚¹å°±åœ¨<code>CallResourceReady</code>ä¸Šé¢äº†ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-103-1 name=__codelineno-103-1></a><a href=#__codelineno-103-1><span class=linenos data-linenos=" 1 "></span></a><span class=kd>private</span> <span class=kd>class</span> <span class=nc>CallResourceReady</span> <span class=kd>implements</span> <span class=n>Runnable</span> <span class=p>{</span>
<a id=__codelineno-103-2 name=__codelineno-103-2></a><a href=#__codelineno-103-2><span class=linenos data-linenos=" 2 "></span></a>
<a id=__codelineno-103-3 name=__codelineno-103-3></a><a href=#__codelineno-103-3><span class=linenos data-linenos=" 3 "></span></a>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>ResourceCallback</span> <span class=n>cb</span><span class=p>;</span>
<a id=__codelineno-103-4 name=__codelineno-103-4></a><a href=#__codelineno-103-4><span class=linenos data-linenos=" 4 "></span></a>
<a id=__codelineno-103-5 name=__codelineno-103-5></a><a href=#__codelineno-103-5><span class=linenos data-linenos=" 5 "></span></a>    <span class=n>CallResourceReady</span><span class=p>(</span><span class=n>ResourceCallback</span> <span class=n>cb</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-103-6 name=__codelineno-103-6></a><a href=#__codelineno-103-6><span class=linenos data-linenos=" 6 "></span></a>      <span class=k>this</span><span class=p>.</span><span class=na>cb</span> <span class=o>=</span> <span class=n>cb</span><span class=p>;</span>
<a id=__codelineno-103-7 name=__codelineno-103-7></a><a href=#__codelineno-103-7><span class=linenos data-linenos=" 7 "></span></a>    <span class=p>}</span>
<a id=__codelineno-103-8 name=__codelineno-103-8></a><a href=#__codelineno-103-8><span class=linenos data-linenos=" 8 "></span></a>
<a id=__codelineno-103-9 name=__codelineno-103-9></a><a href=#__codelineno-103-9><span class=linenos data-linenos=" 9 "></span></a>    <span class=nd>@Override</span>
<a id=__codelineno-103-10 name=__codelineno-103-10></a><a href=#__codelineno-103-10><span class=linenos data-linenos="10 "></span></a>    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-103-11 name=__codelineno-103-11></a><a href=#__codelineno-103-11><span class=linenos data-linenos="11 "></span></a>      <span class=kd>synchronized</span> <span class=p>(</span><span class=n>EngineJob</span><span class=p>.</span><span class=na>this</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-103-12 name=__codelineno-103-12></a><a href=#__codelineno-103-12><span class=linenos data-linenos="12 "></span></a>        <span class=k>if</span> <span class=p>(</span><span class=n>cbs</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>cb</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-103-13 name=__codelineno-103-13></a><a href=#__codelineno-103-13><span class=linenos data-linenos="13 "></span></a>          <span class=c1>// Acquire for this particular callback.</span>
<a id=__codelineno-103-14 name=__codelineno-103-14></a><a href=#__codelineno-103-14><span class=linenos data-linenos="14 "></span></a>          <span class=n>engineResource</span><span class=p>.</span><span class=na>acquire</span><span class=p>();</span>
<a id=__codelineno-103-15 name=__codelineno-103-15></a><a href=#__codelineno-103-15><span class=linenos data-linenos="15 "></span></a>          <span class=n>callCallbackOnResourceReady</span><span class=p>(</span><span class=n>cb</span><span class=p>);</span>
<a id=__codelineno-103-16 name=__codelineno-103-16></a><a href=#__codelineno-103-16><span class=linenos data-linenos="16 "></span></a>          <span class=n>removeCallback</span><span class=p>(</span><span class=n>cb</span><span class=p>);</span>
<a id=__codelineno-103-17 name=__codelineno-103-17></a><a href=#__codelineno-103-17><span class=linenos data-linenos="17 "></span></a>        <span class=p>}</span>
<a id=__codelineno-103-18 name=__codelineno-103-18></a><a href=#__codelineno-103-18><span class=linenos data-linenos="18 "></span></a>        <span class=n>decrementPendingCallbacks</span><span class=p>();</span>
<a id=__codelineno-103-19 name=__codelineno-103-19></a><a href=#__codelineno-103-19><span class=linenos data-linenos="19 "></span></a>      <span class=p>}</span>
<a id=__codelineno-103-20 name=__codelineno-103-20></a><a href=#__codelineno-103-20><span class=linenos data-linenos="20 "></span></a>    <span class=p>}</span>
<a id=__codelineno-103-21 name=__codelineno-103-21></a><a href=#__codelineno-103-21><span class=linenos data-linenos="21 "></span></a>  <span class=p>}</span>
</code></pre></div> <p>ummmmï¼ŒæŠ›å¼€åŒæ­¥æ“ä½œä¸è°ˆï¼Œé¦–å…ˆè°ƒç”¨<code>callCallbackOnResourceReady(cb)</code>è°ƒç”¨callbackï¼Œç„¶åè°ƒç”¨<code>removeCallback(cb)</code>ç§»é™¤callbackã€‚çœ‹çœ‹<code>callCallbackOnResourceReady(cb)</code>ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-104-1 name=__codelineno-104-1></a><a href=#__codelineno-104-1><span class=linenos data-linenos=" 1 "></span></a><span class=nd>@Synthetic</span>
<a id=__codelineno-104-2 name=__codelineno-104-2></a><a href=#__codelineno-104-2><span class=linenos data-linenos=" 2 "></span></a>  <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>callCallbackOnResourceReady</span><span class=p>(</span><span class=n>ResourceCallback</span> <span class=n>cb</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-104-3 name=__codelineno-104-3></a><a href=#__codelineno-104-3><span class=linenos data-linenos=" 3 "></span></a>    <span class=k>try</span> <span class=p>{</span>
<a id=__codelineno-104-4 name=__codelineno-104-4></a><a href=#__codelineno-104-4><span class=linenos data-linenos=" 4 "></span></a>      <span class=c1>// This is overly broad, some Glide code is actually called here, but it&#39;s much</span>
<a id=__codelineno-104-5 name=__codelineno-104-5></a><a href=#__codelineno-104-5><span class=linenos data-linenos=" 5 "></span></a>      <span class=c1>// simpler to encapsulate here than to do so at the actual call point in the</span>
<a id=__codelineno-104-6 name=__codelineno-104-6></a><a href=#__codelineno-104-6><span class=linenos data-linenos=" 6 "></span></a>      <span class=c1>// Request implementation.</span>
<a id=__codelineno-104-7 name=__codelineno-104-7></a><a href=#__codelineno-104-7><span class=linenos data-linenos=" 7 "></span></a>      <span class=n>cb</span><span class=p>.</span><span class=na>onResourceReady</span><span class=p>(</span><span class=n>engineResource</span><span class=p>,</span> <span class=n>dataSource</span><span class=p>);</span>
<a id=__codelineno-104-8 name=__codelineno-104-8></a><a href=#__codelineno-104-8><span class=linenos data-linenos=" 8 "></span></a>    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>Throwable</span> <span class=n>t</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-104-9 name=__codelineno-104-9></a><a href=#__codelineno-104-9><span class=linenos data-linenos=" 9 "></span></a>      <span class=k>throw</span> <span class=k>new</span> <span class=n>CallbackException</span><span class=p>(</span><span class=n>t</span><span class=p>);</span>
<a id=__codelineno-104-10 name=__codelineno-104-10></a><a href=#__codelineno-104-10><span class=linenos data-linenos="10 "></span></a>    <span class=p>}</span>
<a id=__codelineno-104-11 name=__codelineno-104-11></a><a href=#__codelineno-104-11><span class=linenos data-linenos="11 "></span></a>  <span class=p>}</span>
</code></pre></div> <p>è¿™é‡Œå°±è°ƒç”¨äº†<code>cb.onResourceReady</code>ï¼Œè¿™é‡Œè¯´åˆ°è¿‡entry.cbå°±æ˜¯SingleRequestã€‚æ‰€ä»¥ç»§ç»­çœ‹çœ‹<code>SingleRequest.onResourceReady</code>æ–¹æ³•ï¼Œå¾ˆæ˜¾ç„¶<code>onResourceReady(Resource&lt;?&gt;, DataSource)</code>éƒ½åœ¨åšsanity checkï¼Œæœ€åè°ƒç”¨äº†<code>onResourceReady(Resource&lt;?&gt;, R, DataSource)</code>ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-105-1 name=__codelineno-105-1></a><a href=#__codelineno-105-1><span class=linenos data-linenos=" 1 "></span></a><span class=nd>@Override</span>
<a id=__codelineno-105-2 name=__codelineno-105-2></a><a href=#__codelineno-105-2><span class=linenos data-linenos=" 2 "></span></a><span class=kd>public</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>onResourceReady</span><span class=p>(</span><span class=n>Resource</span><span class=o>&lt;?&gt;</span> <span class=n>resource</span><span class=p>,</span> <span class=n>DataSource</span> <span class=n>dataSource</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-105-3 name=__codelineno-105-3></a><a href=#__codelineno-105-3><span class=linenos data-linenos=" 3 "></span></a>  <span class=n>stateVerifier</span><span class=p>.</span><span class=na>throwIfRecycled</span><span class=p>();</span>
<a id=__codelineno-105-4 name=__codelineno-105-4></a><a href=#__codelineno-105-4><span class=linenos data-linenos=" 4 "></span></a>  <span class=n>loadStatus</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-105-5 name=__codelineno-105-5></a><a href=#__codelineno-105-5><span class=linenos data-linenos=" 5 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>resource</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-105-6 name=__codelineno-105-6></a><a href=#__codelineno-105-6><span class=linenos data-linenos=" 6 "></span></a>    <span class=n>GlideException</span> <span class=n>exception</span> <span class=o>=</span> <span class=k>new</span> <span class=n>GlideException</span><span class=p>(</span><span class=s>&quot;Expected to receive a Resource&lt;R&gt; with an &quot;</span>
<a id=__codelineno-105-7 name=__codelineno-105-7></a><a href=#__codelineno-105-7><span class=linenos data-linenos=" 7 "></span></a>        <span class=o>+</span> <span class=s>&quot;object of &quot;</span> <span class=o>+</span> <span class=n>transcodeClass</span> <span class=o>+</span> <span class=s>&quot; inside, but instead got null.&quot;</span><span class=p>);</span>
<a id=__codelineno-105-8 name=__codelineno-105-8></a><a href=#__codelineno-105-8><span class=linenos data-linenos=" 8 "></span></a>    <span class=n>onLoadFailed</span><span class=p>(</span><span class=n>exception</span><span class=p>);</span>
<a id=__codelineno-105-9 name=__codelineno-105-9></a><a href=#__codelineno-105-9><span class=linenos data-linenos=" 9 "></span></a>    <span class=k>return</span><span class=p>;</span>
<a id=__codelineno-105-10 name=__codelineno-105-10></a><a href=#__codelineno-105-10><span class=linenos data-linenos="10 "></span></a>  <span class=p>}</span>
<a id=__codelineno-105-11 name=__codelineno-105-11></a><a href=#__codelineno-105-11><span class=linenos data-linenos="11 "></span></a>
<a id=__codelineno-105-12 name=__codelineno-105-12></a><a href=#__codelineno-105-12><span class=linenos data-linenos="12 "></span></a>  <span class=n>Object</span> <span class=n>received</span> <span class=o>=</span> <span class=n>resource</span><span class=p>.</span><span class=na>get</span><span class=p>();</span>
<a id=__codelineno-105-13 name=__codelineno-105-13></a><a href=#__codelineno-105-13><span class=linenos data-linenos="13 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>received</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=o>!</span><span class=n>transcodeClass</span><span class=p>.</span><span class=na>isAssignableFrom</span><span class=p>(</span><span class=n>received</span><span class=p>.</span><span class=na>getClass</span><span class=p>()))</span> <span class=p>{</span>
<a id=__codelineno-105-14 name=__codelineno-105-14></a><a href=#__codelineno-105-14><span class=linenos data-linenos="14 "></span></a>    <span class=n>releaseResource</span><span class=p>(</span><span class=n>resource</span><span class=p>);</span>
<a id=__codelineno-105-15 name=__codelineno-105-15></a><a href=#__codelineno-105-15><span class=linenos data-linenos="15 "></span></a>    <span class=n>GlideException</span> <span class=n>exception</span> <span class=o>=</span> <span class=k>new</span> <span class=n>GlideException</span><span class=p>(</span><span class=s>&quot;Expected to receive an object of &quot;</span>
<a id=__codelineno-105-16 name=__codelineno-105-16></a><a href=#__codelineno-105-16><span class=linenos data-linenos="16 "></span></a>        <span class=o>+</span> <span class=n>transcodeClass</span> <span class=o>+</span> <span class=s>&quot; but instead&quot;</span> <span class=o>+</span> <span class=s>&quot; got &quot;</span>
<a id=__codelineno-105-17 name=__codelineno-105-17></a><a href=#__codelineno-105-17><span class=linenos data-linenos="17 "></span></a>        <span class=o>+</span> <span class=p>(</span><span class=n>received</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>?</span> <span class=n>received</span><span class=p>.</span><span class=na>getClass</span><span class=p>()</span> <span class=p>:</span> <span class=s>&quot;&quot;</span><span class=p>)</span> <span class=o>+</span> <span class=s>&quot;{&quot;</span> <span class=o>+</span> <span class=n>received</span> <span class=o>+</span> <span class=s>&quot;} inside&quot;</span> <span class=o>+</span> <span class=s>&quot; &quot;</span>
<a id=__codelineno-105-18 name=__codelineno-105-18></a><a href=#__codelineno-105-18><span class=linenos data-linenos="18 "></span></a>        <span class=o>+</span> <span class=s>&quot;Resource{&quot;</span> <span class=o>+</span> <span class=n>resource</span> <span class=o>+</span> <span class=s>&quot;}.&quot;</span>
<a id=__codelineno-105-19 name=__codelineno-105-19></a><a href=#__codelineno-105-19><span class=linenos data-linenos="19 "></span></a>        <span class=o>+</span> <span class=p>(</span><span class=n>received</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>?</span> <span class=s>&quot;&quot;</span> <span class=p>:</span> <span class=s>&quot; &quot;</span> <span class=o>+</span> <span class=s>&quot;To indicate failure return a null Resource &quot;</span>
<a id=__codelineno-105-20 name=__codelineno-105-20></a><a href=#__codelineno-105-20><span class=linenos data-linenos="20 "></span></a>        <span class=o>+</span> <span class=s>&quot;object, rather than a Resource object containing null data.&quot;</span><span class=p>));</span>
<a id=__codelineno-105-21 name=__codelineno-105-21></a><a href=#__codelineno-105-21><span class=linenos data-linenos="21 "></span></a>    <span class=n>onLoadFailed</span><span class=p>(</span><span class=n>exception</span><span class=p>);</span>
<a id=__codelineno-105-22 name=__codelineno-105-22></a><a href=#__codelineno-105-22><span class=linenos data-linenos="22 "></span></a>    <span class=k>return</span><span class=p>;</span>
<a id=__codelineno-105-23 name=__codelineno-105-23></a><a href=#__codelineno-105-23><span class=linenos data-linenos="23 "></span></a>  <span class=p>}</span>
<a id=__codelineno-105-24 name=__codelineno-105-24></a><a href=#__codelineno-105-24><span class=linenos data-linenos="24 "></span></a>
<a id=__codelineno-105-25 name=__codelineno-105-25></a><a href=#__codelineno-105-25><span class=linenos data-linenos="25 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>canSetResource</span><span class=p>())</span> <span class=p>{</span>
<a id=__codelineno-105-26 name=__codelineno-105-26></a><a href=#__codelineno-105-26><span class=linenos data-linenos="26 "></span></a>    <span class=n>releaseResource</span><span class=p>(</span><span class=n>resource</span><span class=p>);</span>
<a id=__codelineno-105-27 name=__codelineno-105-27></a><a href=#__codelineno-105-27><span class=linenos data-linenos="27 "></span></a>    <span class=c1>// We can&#39;t put the status to complete before asking canSetResource().</span>
<a id=__codelineno-105-28 name=__codelineno-105-28></a><a href=#__codelineno-105-28><span class=linenos data-linenos="28 "></span></a>    <span class=n>status</span> <span class=o>=</span> <span class=n>Status</span><span class=p>.</span><span class=na>COMPLETE</span><span class=p>;</span>
<a id=__codelineno-105-29 name=__codelineno-105-29></a><a href=#__codelineno-105-29><span class=linenos data-linenos="29 "></span></a>    <span class=k>return</span><span class=p>;</span>
<a id=__codelineno-105-30 name=__codelineno-105-30></a><a href=#__codelineno-105-30><span class=linenos data-linenos="30 "></span></a>  <span class=p>}</span>
<a id=__codelineno-105-31 name=__codelineno-105-31></a><a href=#__codelineno-105-31><span class=linenos data-linenos="31 "></span></a>
<a id=__codelineno-105-32 name=__codelineno-105-32></a><a href=#__codelineno-105-32><span class=linenos data-linenos="32 "></span></a>  <span class=n>onResourceReady</span><span class=p>((</span><span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span><span class=p>)</span> <span class=n>resource</span><span class=p>,</span> <span class=p>(</span><span class=n>R</span><span class=p>)</span> <span class=n>received</span><span class=p>,</span> <span class=n>dataSource</span><span class=p>);</span>
<a id=__codelineno-105-33 name=__codelineno-105-33></a><a href=#__codelineno-105-33><span class=linenos data-linenos="33 "></span></a><span class=p>}</span>
</code></pre></div> <p><code>onResourceReady(Resource&lt;?&gt;, R, DataSource)</code>æ–¹æ³•å¦‚ä¸‹ï¼Œå…¶å¤„ç†è¿‡ç¨‹å’Œ<code>onLoadFailed</code>æ–¹æ³•éå¸¸ç±»ä¼¼ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-106-1 name=__codelineno-106-1></a><a href=#__codelineno-106-1><span class=linenos data-linenos=" 1 "></span></a><span class=kd>private</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>onResourceReady</span><span class=p>(</span><span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>resource</span><span class=p>,</span> <span class=n>R</span> <span class=n>result</span><span class=p>,</span> <span class=n>DataSource</span> <span class=n>dataSource</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-106-2 name=__codelineno-106-2></a><a href=#__codelineno-106-2><span class=linenos data-linenos=" 2 "></span></a>  <span class=c1>// We must call isFirstReadyResource before setting status.</span>
<a id=__codelineno-106-3 name=__codelineno-106-3></a><a href=#__codelineno-106-3><span class=linenos data-linenos=" 3 "></span></a>  <span class=c1>// ç”±äºrequestCoordinatorä¸ºnullï¼Œæ‰€ä»¥è¿”å›true</span>
<a id=__codelineno-106-4 name=__codelineno-106-4></a><a href=#__codelineno-106-4><span class=linenos data-linenos=" 4 "></span></a>  <span class=kt>boolean</span> <span class=n>isFirstResource</span> <span class=o>=</span> <span class=n>isFirstReadyResource</span><span class=p>();</span>
<a id=__codelineno-106-5 name=__codelineno-106-5></a><a href=#__codelineno-106-5><span class=linenos data-linenos=" 5 "></span></a>  <span class=c1>// å°†statusçŠ¶æ€è®¾ç½®ä¸ºCOMPLETE</span>
<a id=__codelineno-106-6 name=__codelineno-106-6></a><a href=#__codelineno-106-6><span class=linenos data-linenos=" 6 "></span></a>  <span class=n>status</span> <span class=o>=</span> <span class=n>Status</span><span class=p>.</span><span class=na>COMPLETE</span><span class=p>;</span>
<a id=__codelineno-106-7 name=__codelineno-106-7></a><a href=#__codelineno-106-7><span class=linenos data-linenos=" 7 "></span></a>  <span class=k>this</span><span class=p>.</span><span class=na>resource</span> <span class=o>=</span> <span class=n>resource</span><span class=p>;</span>
<a id=__codelineno-106-8 name=__codelineno-106-8></a><a href=#__codelineno-106-8><span class=linenos data-linenos=" 8 "></span></a>
<a id=__codelineno-106-9 name=__codelineno-106-9></a><a href=#__codelineno-106-9><span class=linenos data-linenos=" 9 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>glideContext</span><span class=p>.</span><span class=na>getLogLevel</span><span class=p>()</span> <span class=o>&lt;=</span> <span class=n>Log</span><span class=p>.</span><span class=na>DEBUG</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-106-10 name=__codelineno-106-10></a><a href=#__codelineno-106-10><span class=linenos data-linenos="10 "></span></a>    <span class=n>Log</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=n>GLIDE_TAG</span><span class=p>,</span> <span class=s>&quot;Finished loading &quot;</span> <span class=o>+</span> <span class=n>result</span><span class=p>.</span><span class=na>getClass</span><span class=p>().</span><span class=na>getSimpleName</span><span class=p>()</span> <span class=o>+</span> <span class=s>&quot; from &quot;</span>
<a id=__codelineno-106-11 name=__codelineno-106-11></a><a href=#__codelineno-106-11><span class=linenos data-linenos="11 "></span></a>        <span class=o>+</span> <span class=n>dataSource</span> <span class=o>+</span> <span class=s>&quot; for &quot;</span> <span class=o>+</span> <span class=n>model</span> <span class=o>+</span> <span class=s>&quot; with size [&quot;</span> <span class=o>+</span> <span class=n>width</span> <span class=o>+</span> <span class=s>&quot;x&quot;</span> <span class=o>+</span> <span class=n>height</span> <span class=o>+</span> <span class=s>&quot;] in &quot;</span>
<a id=__codelineno-106-12 name=__codelineno-106-12></a><a href=#__codelineno-106-12><span class=linenos data-linenos="12 "></span></a>        <span class=o>+</span> <span class=n>LogTime</span><span class=p>.</span><span class=na>getElapsedMillis</span><span class=p>(</span><span class=n>startTime</span><span class=p>)</span> <span class=o>+</span> <span class=s>&quot; ms&quot;</span><span class=p>);</span>
<a id=__codelineno-106-13 name=__codelineno-106-13></a><a href=#__codelineno-106-13><span class=linenos data-linenos="13 "></span></a>  <span class=p>}</span>
<a id=__codelineno-106-14 name=__codelineno-106-14></a><a href=#__codelineno-106-14><span class=linenos data-linenos="14 "></span></a>
<a id=__codelineno-106-15 name=__codelineno-106-15></a><a href=#__codelineno-106-15><span class=linenos data-linenos="15 "></span></a>  <span class=n>isCallingCallbacks</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
<a id=__codelineno-106-16 name=__codelineno-106-16></a><a href=#__codelineno-106-16><span class=linenos data-linenos="16 "></span></a>  <span class=k>try</span> <span class=p>{</span>
<a id=__codelineno-106-17 name=__codelineno-106-17></a><a href=#__codelineno-106-17><span class=linenos data-linenos="17 "></span></a>     <span class=c1>// å°è¯•è°ƒç”¨å„ä¸ªlistenerçš„onResourceReadyå›è°ƒè¿›è¡Œå¤„ç†</span>
<a id=__codelineno-106-18 name=__codelineno-106-18></a><a href=#__codelineno-106-18><span class=linenos data-linenos="18 "></span></a>    <span class=kt>boolean</span> <span class=n>anyListenerHandledUpdatingTarget</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
<a id=__codelineno-106-19 name=__codelineno-106-19></a><a href=#__codelineno-106-19><span class=linenos data-linenos="19 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>requestListeners</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-106-20 name=__codelineno-106-20></a><a href=#__codelineno-106-20><span class=linenos data-linenos="20 "></span></a>      <span class=k>for</span> <span class=p>(</span><span class=n>RequestListener</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>listener</span> <span class=p>:</span> <span class=n>requestListeners</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-106-21 name=__codelineno-106-21></a><a href=#__codelineno-106-21><span class=linenos data-linenos="21 "></span></a>        <span class=n>anyListenerHandledUpdatingTarget</span> <span class=o>|=</span>
<a id=__codelineno-106-22 name=__codelineno-106-22></a><a href=#__codelineno-106-22><span class=linenos data-linenos="22 "></span></a>            <span class=n>listener</span><span class=p>.</span><span class=na>onResourceReady</span><span class=p>(</span><span class=n>result</span><span class=p>,</span> <span class=n>model</span><span class=p>,</span> <span class=n>target</span><span class=p>,</span> <span class=n>dataSource</span><span class=p>,</span> <span class=n>isFirstResource</span><span class=p>);</span>
<a id=__codelineno-106-23 name=__codelineno-106-23></a><a href=#__codelineno-106-23><span class=linenos data-linenos="23 "></span></a>      <span class=p>}</span>
<a id=__codelineno-106-24 name=__codelineno-106-24></a><a href=#__codelineno-106-24><span class=linenos data-linenos="24 "></span></a>    <span class=p>}</span>
<a id=__codelineno-106-25 name=__codelineno-106-25></a><a href=#__codelineno-106-25><span class=linenos data-linenos="25 "></span></a>    <span class=n>anyListenerHandledUpdatingTarget</span> <span class=o>|=</span>
<a id=__codelineno-106-26 name=__codelineno-106-26></a><a href=#__codelineno-106-26><span class=linenos data-linenos="26 "></span></a>        <span class=n>targetListener</span> <span class=o>!=</span> <span class=kc>null</span>
<a id=__codelineno-106-27 name=__codelineno-106-27></a><a href=#__codelineno-106-27><span class=linenos data-linenos="27 "></span></a>            <span class=o>&amp;&amp;</span> <span class=n>targetListener</span><span class=p>.</span><span class=na>onResourceReady</span><span class=p>(</span><span class=n>result</span><span class=p>,</span> <span class=n>model</span><span class=p>,</span> <span class=n>target</span><span class=p>,</span> <span class=n>dataSource</span><span class=p>,</span> <span class=n>isFirstResource</span><span class=p>);</span>
<a id=__codelineno-106-28 name=__codelineno-106-28></a><a href=#__codelineno-106-28><span class=linenos data-linenos="28 "></span></a>
<a id=__codelineno-106-29 name=__codelineno-106-29></a><a href=#__codelineno-106-29><span class=linenos data-linenos="29 "></span></a>    <span class=c1>// å¦‚æœæ²¡æœ‰ä¸€ä¸ªå›è°ƒèƒ½å¤Ÿå¤„ç†ï¼Œé‚£ä¹ˆè‡ªå·±å¤„ç†</span>
<a id=__codelineno-106-30 name=__codelineno-106-30></a><a href=#__codelineno-106-30><span class=linenos data-linenos="30 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>anyListenerHandledUpdatingTarget</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-106-31 name=__codelineno-106-31></a><a href=#__codelineno-106-31><span class=linenos data-linenos="31 "></span></a>      <span class=c1>// animationFactoryé»˜è®¤ä¸ºNoTransition.getFactory()ï¼Œç”Ÿæˆçš„animationä¸ºNO_ANIMATION</span>
<a id=__codelineno-106-32 name=__codelineno-106-32></a><a href=#__codelineno-106-32><span class=linenos data-linenos="32 "></span></a>      <span class=n>Transition</span><span class=o>&lt;?</span> <span class=kd>super</span> <span class=n>R</span><span class=o>&gt;</span> <span class=n>animation</span> <span class=o>=</span>
<a id=__codelineno-106-33 name=__codelineno-106-33></a><a href=#__codelineno-106-33><span class=linenos data-linenos="33 "></span></a>          <span class=n>animationFactory</span><span class=p>.</span><span class=na>build</span><span class=p>(</span><span class=n>dataSource</span><span class=p>,</span> <span class=n>isFirstResource</span><span class=p>);</span>
<a id=__codelineno-106-34 name=__codelineno-106-34></a><a href=#__codelineno-106-34><span class=linenos data-linenos="34 "></span></a>      <span class=c1>// targetä¸ºDrawableImageViewTarget</span>
<a id=__codelineno-106-35 name=__codelineno-106-35></a><a href=#__codelineno-106-35><span class=linenos data-linenos="35 "></span></a>      <span class=n>target</span><span class=p>.</span><span class=na>onResourceReady</span><span class=p>(</span><span class=n>result</span><span class=p>,</span> <span class=n>animation</span><span class=p>);</span>
<a id=__codelineno-106-36 name=__codelineno-106-36></a><a href=#__codelineno-106-36><span class=linenos data-linenos="36 "></span></a>    <span class=p>}</span>
<a id=__codelineno-106-37 name=__codelineno-106-37></a><a href=#__codelineno-106-37><span class=linenos data-linenos="37 "></span></a>  <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
<a id=__codelineno-106-38 name=__codelineno-106-38></a><a href=#__codelineno-106-38><span class=linenos data-linenos="38 "></span></a>    <span class=n>isCallingCallbacks</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
<a id=__codelineno-106-39 name=__codelineno-106-39></a><a href=#__codelineno-106-39><span class=linenos data-linenos="39 "></span></a>  <span class=p>}</span>
<a id=__codelineno-106-40 name=__codelineno-106-40></a><a href=#__codelineno-106-40><span class=linenos data-linenos="40 "></span></a>
<a id=__codelineno-106-41 name=__codelineno-106-41></a><a href=#__codelineno-106-41><span class=linenos data-linenos="41 "></span></a>  <span class=c1>// é€šçŸ¥requestCoordinator</span>
<a id=__codelineno-106-42 name=__codelineno-106-42></a><a href=#__codelineno-106-42><span class=linenos data-linenos="42 "></span></a>  <span class=n>notifyLoadSuccess</span><span class=p>();</span>
<a id=__codelineno-106-43 name=__codelineno-106-43></a><a href=#__codelineno-106-43><span class=linenos data-linenos="43 "></span></a><span class=p>}</span>
</code></pre></div> <p><code>DrawableImageViewTarget</code>çš„åŸºç±»<code>ImageViewTarget</code>å®ç°äº†æ­¤æ–¹æ³•ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-107-1 name=__codelineno-107-1></a><a href=#__codelineno-107-1><span class=linenos data-linenos=" 1 "></span></a><span class=c1>// ImageViewTarget.java</span>
<a id=__codelineno-107-2 name=__codelineno-107-2></a><a href=#__codelineno-107-2><span class=linenos data-linenos=" 2 "></span></a><span class=nd>@Override</span>
<a id=__codelineno-107-3 name=__codelineno-107-3></a><a href=#__codelineno-107-3><span class=linenos data-linenos=" 3 "></span></a><span class=kd>public</span> <span class=kt>void</span> <span class=nf>onResourceReady</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Z</span> <span class=n>resource</span><span class=p>,</span> <span class=nd>@Nullable</span> <span class=n>Transition</span><span class=o>&lt;?</span> <span class=kd>super</span> <span class=n>Z</span><span class=o>&gt;</span> <span class=n>transition</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-107-4 name=__codelineno-107-4></a><a href=#__codelineno-107-4><span class=linenos data-linenos=" 4 "></span></a>  <span class=c1>// NO_ANIMATION.transitionè¿”å›falseï¼Œæ‰€ä»¥ç›´æ¥è°ƒç”¨setResourceInternalæ–¹æ³•</span>
<a id=__codelineno-107-5 name=__codelineno-107-5></a><a href=#__codelineno-107-5><span class=linenos data-linenos=" 5 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>transition</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=o>!</span><span class=n>transition</span><span class=p>.</span><span class=na>transition</span><span class=p>(</span><span class=n>resource</span><span class=p>,</span> <span class=k>this</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-107-6 name=__codelineno-107-6></a><a href=#__codelineno-107-6><span class=linenos data-linenos=" 6 "></span></a>    <span class=n>setResourceInternal</span><span class=p>(</span><span class=n>resource</span><span class=p>);</span>
<a id=__codelineno-107-7 name=__codelineno-107-7></a><a href=#__codelineno-107-7><span class=linenos data-linenos=" 7 "></span></a>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
<a id=__codelineno-107-8 name=__codelineno-107-8></a><a href=#__codelineno-107-8><span class=linenos data-linenos=" 8 "></span></a>    <span class=n>maybeUpdateAnimatable</span><span class=p>(</span><span class=n>resource</span><span class=p>);</span>
<a id=__codelineno-107-9 name=__codelineno-107-9></a><a href=#__codelineno-107-9><span class=linenos data-linenos=" 9 "></span></a>  <span class=p>}</span>
<a id=__codelineno-107-10 name=__codelineno-107-10></a><a href=#__codelineno-107-10><span class=linenos data-linenos="10 "></span></a><span class=p>}</span>
<a id=__codelineno-107-11 name=__codelineno-107-11></a><a href=#__codelineno-107-11><span class=linenos data-linenos="11 "></span></a>
<a id=__codelineno-107-12 name=__codelineno-107-12></a><a href=#__codelineno-107-12><span class=linenos data-linenos="12 "></span></a><span class=kd>private</span> <span class=kt>void</span> <span class=nf>setResourceInternal</span><span class=p>(</span><span class=nd>@Nullable</span> <span class=n>Z</span> <span class=n>resource</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-107-13 name=__codelineno-107-13></a><a href=#__codelineno-107-13><span class=linenos data-linenos="13 "></span></a>  <span class=c1>// Order matters here. Set the resource first to make sure that the Drawable has a valid and</span>
<a id=__codelineno-107-14 name=__codelineno-107-14></a><a href=#__codelineno-107-14><span class=linenos data-linenos="14 "></span></a>  <span class=c1>// non-null Callback before starting it.</span>
<a id=__codelineno-107-15 name=__codelineno-107-15></a><a href=#__codelineno-107-15><span class=linenos data-linenos="15 "></span></a>  <span class=c1>// å…ˆè®¾ç½®å›¾ç‰‡</span>
<a id=__codelineno-107-16 name=__codelineno-107-16></a><a href=#__codelineno-107-16><span class=linenos data-linenos="16 "></span></a>  <span class=n>setResource</span><span class=p>(</span><span class=n>resource</span><span class=p>);</span>
<a id=__codelineno-107-17 name=__codelineno-107-17></a><a href=#__codelineno-107-17><span class=linenos data-linenos="17 "></span></a>  <span class=c1>// ç„¶åå¦‚æœæ˜¯åŠ¨ç”»ï¼Œä¼šæ‰§è¡ŒåŠ¨ç”»</span>
<a id=__codelineno-107-18 name=__codelineno-107-18></a><a href=#__codelineno-107-18><span class=linenos data-linenos="18 "></span></a>  <span class=n>maybeUpdateAnimatable</span><span class=p>(</span><span class=n>resource</span><span class=p>);</span>
<a id=__codelineno-107-19 name=__codelineno-107-19></a><a href=#__codelineno-107-19><span class=linenos data-linenos="19 "></span></a><span class=p>}</span>
<a id=__codelineno-107-20 name=__codelineno-107-20></a><a href=#__codelineno-107-20><span class=linenos data-linenos="20 "></span></a>
<a id=__codelineno-107-21 name=__codelineno-107-21></a><a href=#__codelineno-107-21><span class=linenos data-linenos="21 "></span></a><span class=kd>private</span> <span class=kt>void</span> <span class=nf>maybeUpdateAnimatable</span><span class=p>(</span><span class=nd>@Nullable</span> <span class=n>Z</span> <span class=n>resource</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-107-22 name=__codelineno-107-22></a><a href=#__codelineno-107-22><span class=linenos data-linenos="22 "></span></a>  <span class=c1>// BitmapDrawableæ˜¾ç„¶ä¸æ˜¯ä¸€ä¸ªAnimatableå¯¹è±¡ï¼Œæ‰€ä»¥èµ°elseåˆ†æ”¯</span>
<a id=__codelineno-107-23 name=__codelineno-107-23></a><a href=#__codelineno-107-23><span class=linenos data-linenos="23 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>resource</span> <span class=k>instanceof</span> <span class=n>Animatable</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-107-24 name=__codelineno-107-24></a><a href=#__codelineno-107-24><span class=linenos data-linenos="24 "></span></a>    <span class=n>animatable</span> <span class=o>=</span> <span class=p>(</span><span class=n>Animatable</span><span class=p>)</span> <span class=n>resource</span><span class=p>;</span>
<a id=__codelineno-107-25 name=__codelineno-107-25></a><a href=#__codelineno-107-25><span class=linenos data-linenos="25 "></span></a>    <span class=n>animatable</span><span class=p>.</span><span class=na>start</span><span class=p>();</span>
<a id=__codelineno-107-26 name=__codelineno-107-26></a><a href=#__codelineno-107-26><span class=linenos data-linenos="26 "></span></a>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
<a id=__codelineno-107-27 name=__codelineno-107-27></a><a href=#__codelineno-107-27><span class=linenos data-linenos="27 "></span></a>    <span class=n>animatable</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-107-28 name=__codelineno-107-28></a><a href=#__codelineno-107-28><span class=linenos data-linenos="28 "></span></a>  <span class=p>}</span>
<a id=__codelineno-107-29 name=__codelineno-107-29></a><a href=#__codelineno-107-29><span class=linenos data-linenos="29 "></span></a><span class=p>}</span>
<a id=__codelineno-107-30 name=__codelineno-107-30></a><a href=#__codelineno-107-30><span class=linenos data-linenos="30 "></span></a>
<a id=__codelineno-107-31 name=__codelineno-107-31></a><a href=#__codelineno-107-31><span class=linenos data-linenos="31 "></span></a><span class=c1>// DrawableImageViewTarget</span>
<a id=__codelineno-107-32 name=__codelineno-107-32></a><a href=#__codelineno-107-32><span class=linenos data-linenos="32 "></span></a><span class=nd>@Override</span>
<a id=__codelineno-107-33 name=__codelineno-107-33></a><a href=#__codelineno-107-33><span class=linenos data-linenos="33 "></span></a><span class=kd>protected</span> <span class=kt>void</span> <span class=nf>setResource</span><span class=p>(</span><span class=nd>@Nullable</span> <span class=n>Drawable</span> <span class=n>resource</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-107-34 name=__codelineno-107-34></a><a href=#__codelineno-107-34><span class=linenos data-linenos="34 "></span></a>  <span class=n>view</span><span class=p>.</span><span class=na>setImageDrawable</span><span class=p>(</span><span class=n>resource</span><span class=p>);</span>
<a id=__codelineno-107-35 name=__codelineno-107-35></a><a href=#__codelineno-107-35><span class=linenos data-linenos="35 "></span></a><span class=p>}</span>
</code></pre></div> <p>OKï¼Œè‡³æ­¤ç½‘ç»œå›¾ç‰‡å·²ç»é€šè¿‡<code>view.setImageDrawable(resource)</code>åŠ è½½å®Œæ¯•ã€‚å®Œç»“æ’’èŠ±ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ğŸ‰ </p> <p>Butï¼Œæ•´ä¸ªæµç¨‹çœ‹çš„è„‘é˜”ç–¼ã€‚è¿™ç¯‡æ–‡ç« ä»4æœˆ25å·åˆ°ä»Šå¤©5æœˆ5å·ç»å†äº†10å¤©ï¼ŒæŠ›å¼€ä¸­é—´51çš„4å¤©å‡ï¼Œå·®ä¸å¤šä¹Ÿæœ‰ä¸€å‘¨ä¹‹ä¹…ï¼Œæ—¶æ–­æ—¶ç»­ï¼Œä¸€éæ‹ä¸‹æ¥æˆ‘è‡ªå·±ä¹Ÿæ˜¯åŠæ‡µçš„ï¼Œæ‰€ä»¥åº”è¯¥å¾—æœ‰ä¸ªæ€»ç»“å§ã€‚ä¸ç„¶æ¯æ¬¡æ¸©ä¹ ä¸€éï¼Œä¸€éå°±å¾—æ¸©ä¹ å‡ å¤©ã€‚<br> æ‰€ä»¥ï¼Œæ¥ä¸‹æ¥çš„å‡ ç¯‡æ–‡ç« ï¼Œæ¯ç¯‡éƒ½ä¼šé€‰å–ä¸€ä¸ªæ–¹é¢è¿›è¡Œæ€»ç»“ã€‚æ­¤å¤–ï¼Œæœ¬æ–‡çš„æµç¨‹å›¾å¦‚ä¸‹ï¼š</p> <figure style="width: 95%" class=align-center> <img src=/assets/images/android/glide-overview.png> <figcaption>Glideæ•´ä½“æµç¨‹å›¾</figcaption> </figure> <hr> <div class=md-source-file> <small> Last update: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">February 14, 2022</span> </small> </div> <!-- Giscus --> <h2 id=__comments>Comments</h2> <script src=https://giscus.app/client.js data-repo=wzasd/wzasd.github.io data-repo-id="MDEwOlJlcG9zaXRvcnk2NTQ0MDY0OA==" data-category=General data-category-id=DIC_kwDOA-aLiM4CA5Qt data-mapping=pathname data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=dark data-lang=zh-CN crossorigin=anonymous async>
</script> <!-- Replace with generated snippet --> <!-- Reload on palette change --> <script>
    var palette = __md_get("__palette")
    if (palette && typeof palette.color === "object")
      if (palette.color.scheme === "slate") {
        var giscus = document.querySelector("script[src*=giscus]")
        giscus.setAttribute("data-theme", "dark") // (1)!
      }

    /* Register event handlers after documented loaded */
    document.addEventListener("DOMContentLoaded", function() {
      var ref = document.querySelector("[data-md-component=palette]")
      ref.addEventListener("change", function() {
        var palette = __md_get("__palette")
        if (palette && typeof palette.color === "object") {
          var theme = palette.color.scheme === "slate" ? "dark" : "light"

          /* Instruct Giscus to change theme */
          var frame = document.querySelector(".giscus-frame")
          frame.contentWindow.postMessage(
            { giscus: { setConfig: { theme } } },
            "https://giscus.app"
          )
        }
      })
    })
  </script> <span id=busuanzi_container_site_uv>æœ¬ç«™è®¿å®¢æ•°<span id=busuanzi_value_site_uv></span>äººæ¬¡</span> </article> </div> </div> <a href=# class="md-top md-icon" data-md-component=top data-md-state=hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"/></svg> Back to top </a> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../glide1/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Glide v4 æºç è§£æï¼ˆä¸€ï¼‰" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> Glide v4 æºç è§£æï¼ˆä¸€ï¼‰ </div> </div> </a> <a href=../glide3/ class="md-footer__link md-footer__link--next" aria-label="Next: Glide v4 æºç è§£æï¼ˆä¸‰ï¼‰" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Next </span> Glide v4 æºç è§£æï¼ˆä¸‰ï¼‰ </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2015 - 2021 wzasd </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/wzasd target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33.85 0 1.71.11 2.5.33 1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2z"/></svg> </a> <a href=jeffrey@outlook.com target=_blank rel=noopener title class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m20 8-8 5-8-5V6l8 5 8-5m0-2H4c-1.11 0-2 .89-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../..", "features": ["navigation.instant", "navigation.tracking", "navigation.tabs", "navigation.indexes", "navigation.top", "toc.integrate", "search.suggest", "search.highlight"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../../assets/javascripts/workers/search.092fa1f6.min.js"}</script> <script src=../../../assets/javascripts/bundle.5a9542cf.min.js></script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script> <script src=../../../assets/js/busuanzi.pure.mini.js></script> </body> </html>