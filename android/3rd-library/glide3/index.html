<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link href=https://blog.founicy.top/android/3rd-library/glide3/ rel=canonical><link rel=icon href=../../../assets/images/favicon.png><meta name=generator content="mkdocs-1.2.3, mkdocs-material-8.1.11"><title>Glide v4 æºç è§£æï¼ˆä¸‰ï¼‰ - wzasd's world</title><link rel=stylesheet href=../../../assets/stylesheets/main.50e68009.min.css><link rel=stylesheet href=../../../assets/stylesheets/palette.e6a45f82.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>:root{--md-text-font:"";--md-code-font:"Roboto Mono"}</style><script>__md_scope=new URL("../../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-Q6FXPH6HVX"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&gtag("event","search",{search_term:this.value})}),"undefined"!=typeof location$&&location$.subscribe(function(e){gtag("config","G-Q6FXPH6HVX",{page_path:e.pathname})})})</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-Q6FXPH6HVX"></script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=white data-md-color-accent=blue> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#1-glide class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../../.. title="wzasd's world" class="md-header__button md-logo" aria-label="wzasd's world" data-md-component=logo> <img src=../../../assets/images/favicon.webp alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> wzasd's world </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Glide v4 æºç è§£æï¼ˆä¸‰ï¼‰ </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=white data-md-color-accent=blue aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary=black data-md-color-accent=deep-orange aria-label="Switch to light mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3z"/></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../3rd-library-source-code/ class="md-tabs__link md-tabs__link--active"> Android </a> </li> <li class=md-tabs__item> <a href=../../../flutter/flutter_first_project_1/ class=md-tabs__link> Flutter </a> </li> <li class=md-tabs__item> <a href=../../../leetcode/ class=md-tabs__link> LeetCode </a> </li> <li class=md-tabs__item> <a href=../../../design-pattern/design-pattern/ class=md-tabs__link> Books </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../../.. title="wzasd's world" class="md-nav__button md-logo" aria-label="wzasd's world" data-md-component=logo> <img src=../../../assets/images/favicon.webp alt=logo> </a> wzasd's world </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1 type=checkbox id=__nav_1 checked> <label class=md-nav__link for=__nav_1> Android <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Android data-md-level=1> <label class=md-nav__title for=__nav_1> <span class="md-nav__icon md-icon"></span> Android </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1_1 type=checkbox id=__nav_1_1 checked> <label class=md-nav__link for=__nav_1_1> ä¸‰æ–¹åº“ç³»åˆ— <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=ä¸‰æ–¹åº“ç³»åˆ— data-md-level=2> <label class=md-nav__title for=__nav_1_1> <span class="md-nav__icon md-icon"></span> ä¸‰æ–¹åº“ç³»åˆ— </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../3rd-library-source-code/ class=md-nav__link> Androidä¸‰æ–¹åº“æºç åˆ†æ </a> </li> <li class=md-nav__item> <a href=../matrix/ class=md-nav__link> å¾®ä¿¡APM Matrixè§£æ </a> </li> <li class=md-nav__item> <a href=../matrix-trace/ class=md-nav__link> Matrix-TraceCanaryè§£æ </a> </li> <li class=md-nav__item> <a href=../matrix-io/ class=md-nav__link> Matrix-IOCanaryè§£æ </a> </li> <li class=md-nav__item> <a href=../matrix-resource/ class=md-nav__link> Matrix-ResourceCanaryè§£æ </a> </li> <li class=md-nav__item> <a href=../matrix-sqlitelint/ class=md-nav__link> Matrix-SQLiteLintè§£æ </a> </li> <li class=md-nav__item> <a href=../okhttp/ class=md-nav__link> OkHttp3æºç è§£æ </a> </li> <li class=md-nav__item> <a href=../retrofit/ class=md-nav__link> Retrofit2æºç è§£æ </a> </li> <li class=md-nav__item> <a href=../rxjava%26rxandroid/ class=md-nav__link> RxJavaæºç è§£æåŠä½¿ç”¨å®ä¾‹ </a> </li> <li class=md-nav__item> <a href=../../other/RxJava/ class=md-nav__link> RxJavaæ“ä½œç¬¦å¤§å…¨ </a> </li> <li class=md-nav__item> <a href=../glide1/ class=md-nav__link> Glide v4 æºç è§£æï¼ˆä¸€ï¼‰ </a> </li> <li class=md-nav__item> <a href=../glide2/ class=md-nav__link> Glide v4 æºç è§£æï¼ˆäºŒï¼‰ </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Glide v4 æºç è§£æï¼ˆä¸‰ï¼‰ <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> Glide v4 æºç è§£æï¼ˆä¸‰ï¼‰ </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#1-glide class=md-nav__link> 1. Glideç¼“å­˜æœºåˆ¶ </a> </li> <li class=md-nav__item> <a href=#2-memorycache class=md-nav__link> 2. memoryCacheä»‹ç» </a> </li> <li class=md-nav__item> <a href=#3-diskcachefactory class=md-nav__link> 3. diskCacheFactoryä»‹ç» </a> </li> <li class=md-nav__item> <a href=#4-activeresources class=md-nav__link> 4. ActiveResources </a> </li> <li class=md-nav__item> <a href=#5 class=md-nav__link> 5. ç¼“å­˜åŠ è½½ã€å­˜æ”¾è¿‡ç¨‹ </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../glide4/ class=md-nav__link> Glide v4 æºç è§£æï¼ˆå››ï¼‰ </a> </li> <li class=md-nav__item> <a href=../glide5/ class=md-nav__link> Glide v4 æºç è§£æï¼ˆäº”ï¼‰ </a> </li> <li class=md-nav__item> <a href=../glide6/ class=md-nav__link> Glide v4 æºç è§£æï¼ˆå…­ï¼‰ </a> </li> <li class=md-nav__item> <a href=../glide7/ class=md-nav__link> Glide v4 æºç è§£æï¼ˆä¸ƒï¼‰ </a> </li> <li class=md-nav__item> <a href=../migrate-to-glide/ class=md-nav__link> æ‚è®°ï¼šä»Picassoè¿ç§»è‡³Glide </a> </li> <li class=md-nav__item> <a href=../eventbus/ class=md-nav__link> EventBusæºç è§£æ </a> </li> <li class=md-nav__item> <a href=../leakcanary/ class=md-nav__link> LeakCanary2æºç è§£æ </a> </li> <li class=md-nav__item> <a href=../permissiondispatcher/ class=md-nav__link> PermissionDispatcheræºç è§£æ </a> </li> <li class=md-nav__item> <a href=../../other/constraintlayout/ class=md-nav__link> ConstraintLayoutä½¿ç”¨å¤§å…¨ </a> </li> <li class=md-nav__item> <a href=../../other/dagger2/ class=md-nav__link> åˆå­¦è€…çš„Dagger2æ•™ç¨‹ </a> </li> <li class=md-nav__item> <a href=../hotfix/ class=md-nav__link> Hotfixæ–¹æ¡ˆåˆæ¢ </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1_2 type=checkbox id=__nav_1_2> <label class=md-nav__link for=__nav_1_2> frameworkç³»åˆ— <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=frameworkç³»åˆ— data-md-level=2> <label class=md-nav__title for=__nav_1_2> <span class="md-nav__icon md-icon"></span> frameworkç³»åˆ— </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../framework/Android%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%281%29/ class=md-nav__link> Activity </a> </li> <li class=md-nav__item> <a href=../../framework/Android%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%282%29/ class=md-nav__link> Service </a> </li> <li class=md-nav__item> <a href=../../framework/Android%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%283%29/ class=md-nav__link> Broadcasts </a> </li> <li class=md-nav__item> <a href=../../framework/Android%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%284%29/ class=md-nav__link> Content Providersä¸Fragment </a> </li> <li class=md-nav__item> <a href=../../framework/IPC%E6%9C%BA%E5%88%B6/ class=md-nav__link> IPCæœºåˆ¶ </a> </li> <li class=md-nav__item> <a href=../../framework/View%E7%9A%84%E4%BA%8B%E4%BB%B6%E4%BD%93%E7%B3%BB/ class=md-nav__link> Viewçš„äº‹ä»¶ä½“ç³» </a> </li> <li class=md-nav__item> <a href=../../framework/View%E7%9A%84%E7%BB%98%E5%88%B6%E5%8E%9F%E7%90%86/ class=md-nav__link> Viewçš„ç»˜åˆ¶åŸç† </a> </li> <li class=md-nav__item> <a href=../../framework/RemoteViews/ class=md-nav__link> RemoteViews </a> </li> <li class=md-nav__item> <a href=../../framework/Drawable/ class=md-nav__link> Androidä¸­çš„Drawableèµ„æº </a> </li> <li class=md-nav__item> <a href=../../framework/Android%E5%8A%A8%E7%94%BB/ class=md-nav__link> AndroidåŠ¨ç”» </a> </li> <li class=md-nav__item> <a href=../../framework/Window%E4%B8%8EWindowManager/ class=md-nav__link> Windowä¸WindowManager </a> </li> <li class=md-nav__item> <a href=../../framework/%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B/ class=md-nav__link> å››å¤§ç»„ä»¶å¯åŠ¨è¿‡ç¨‹ </a> </li> <li class=md-nav__item> <a href=../../framework/Android%E6%B6%88%E6%81%AF%E6%9C%BA%E5%88%B6/ class=md-nav__link> Androidæ¶ˆæ¯æœºåˆ¶ </a> </li> <li class=md-nav__item> <a href=../../framework/Android%E7%BA%BF%E7%A8%8B%E4%B8%8E%E7%BA%BF%E7%A8%8B%E6%B1%A0/ class=md-nav__link> Androidçº¿ç¨‹ä¸çº¿ç¨‹æ±  </a> </li> <li class=md-nav__item> <a href=../../framework/Bitmap%E7%9A%84%E7%BC%93%E5%AD%98%E4%B8%8E%E5%8A%A0%E8%BD%BD/ class=md-nav__link> Bitmapçš„ç¼“å­˜ä¸åŠ è½½ </a> </li> <li class=md-nav__item> <a href=../../framework/JNI%E4%B8%8ENDK/ class=md-nav__link> JNIä¸NDKç¼–ç¨‹ç®€ä»‹ </a> </li> <li class=md-nav__item> <a href=../../framework/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/ class=md-nav__link> Androidæ€§èƒ½ä¼˜åŒ– </a> </li> <li class=md-nav__item> <a href=../../framework/binder1-mediaservice/ class=md-nav__link> Binderæ·±å…¥ç†è§£â€”â€”ä»¥MediaServiceä¸ºä¾‹ </a> </li> <li class=md-nav__item> <a href=../../framework/binder2/ class=md-nav__link> Binderæ·±å…¥ç†è§£â€”â€”ç½—è€å¸ˆç³»åˆ— </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1_3 type=checkbox id=__nav_1_3> <label class=md-nav__link for=__nav_1_3> æ‚è®° <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=æ‚è®° data-md-level=2> <label class=md-nav__title for=__nav_1_3> <span class="md-nav__icon md-icon"></span> æ‚è®° </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../other/android-ipc-big-data/ class=md-nav__link> Ashmemç®€ä»‹ï¼ˆAndroid IPCä¼ è¾“å¤§æ•°æ®ï¼‰ </a> </li> <li class=md-nav__item> <a href=../../other/LocalSocket%EF%BC%8CSocket%20Websocket%20Http%2CP2P%E7%AD%89%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%28%E6%AD%A5%E9%AA%A4%29%EF%BC%88Demo%EF%BC%89/ class=md-nav__link> LocalSocketï¼ŒSocket Websocket Http,P2Pç­‰ç½‘ç»œç¼–ç¨‹(æ­¥éª¤)ï¼ˆDemoï¼‰ </a> </li> <li class=md-nav__item> <a href=../../other/commands/ class=md-nav__link> Androidå¼€å‘å¸¸è§å‘½ä»¤ </a> </li> <li class=md-nav__item> <a href=../../other/android-tv/ class=md-nav__link> Android TV ä¸“é¡¹ </a> </li> <li class=md-nav__item> <a href=../../other/annotation/ class=md-nav__link> æ³¨è§£çš„å®šä¹‰åŠè§£æ </a> </li> <li class=md-nav__item> <a href=../../other/best_throttle_in_mvvm/ class=md-nav__link> è¿™å¯èƒ½æ˜¯MVVMä¸­æœ€ä¼˜é›…çš„æŒ‰é”®é˜²æŠ–æ–¹æ¡ˆ </a> </li> <li class=md-nav__item> <a href=../../other/android-jenkins/ class=md-nav__link> Jenkins for android </a> </li> <li class=md-nav__item> <a href=../../other/SystemProrities/ class=md-nav__link> æ™®é€šAndroidç¨‹åºä½¿ç”¨SystemProrities </a> </li> <li class=md-nav__item> <a href=../../other/recyclerview-cache/ class=md-nav__link> ListViewã€RecyclerViewç¼“å­˜ç­–ç•¥è§£æ </a> </li> <li class=md-nav__item> <a href=../../other/recyclerview-item-docoration/ class=md-nav__link> RecyclerViewé«˜çº§ç‰¹æ€§â€”â€”ItemDecoration </a> </li> <li class=md-nav__item> <a href=../../other/recyclerview-others/ class=md-nav__link> RecyclerViewçš„ä¸€äº›ä½¿ç”¨ç»†èŠ‚ </a> </li> <li class=md-nav__item> <a href=../../other/RecyclerView-Sort%26Delete/ class=md-nav__link> RecyclerViewé«˜çº§ç‰¹æ€§â€”â€”æ‹–æ‹½æ’åºä»¥åŠæ»‘åŠ¨åˆ é™¤ </a> </li> <li class=md-nav__item> <a href=../../other/FAB-Behavior/ class=md-nav__link> FloatingActionButtonä¸Šæ»‘éšè—ä¸‹æ»‘æ˜¾ç¤º </a> </li> <li class=md-nav__item> <a href=../../other/nestedscrolling/ class=md-nav__link> NestedScrollingæœºåˆ¶ </a> </li> <li class=md-nav__item> <a href=../../other/porterduff/ class=md-nav__link> ä½¿ç”¨Porter-Duffåˆæˆæ•°å­—å›¾åƒ </a> </li> <li class=md-nav__item> <a href=../../other/runtime/ class=md-nav__link> Android Runtime </a> </li> <li class=md-nav__item> <a href=../../other/android_alias/ class=md-nav__link> Androidé©¬ç”²åŒ…çš„é‚£äº›äº‹å„¿ </a> </li> <li class=md-nav__item> <a href=../../other/Android-Development-Tool/ class=md-nav__link> Androidç¥å…µåˆ©å™¨ </a> </li> <li class=md-nav__item> <a href=../../other/FileProvider/ class=md-nav__link> FileProvider </a> </li> <li class=md-nav__item> <a href=../../other/Android%E5%88%A4%E6%96%AD%E5%AF%BC%E8%88%AA%E6%A0%8F%E9%AB%98%E5%BA%A6/ class=md-nav__link> Androidåˆ¤æ–­è™šæ‹ŸæŒ‰é”®(å¯¼èˆªæ )æ˜¾ç¤ºä¸å¦ã€é«˜åº¦ä»¥åŠè·å–å±å¹•å®é™…é«˜åº¦ </a> </li> <li class=md-nav__item> <a href=../../other/Android%E5%9B%BE%E7%89%87%E9%80%89%E6%8B%A9%E5%99%A8/ class=md-nav__link> Androidå›¾ç‰‡é€‰æ‹©å™¨ </a> </li> <li class=md-nav__item> <a href=../../other/Android%E5%BA%95%E9%83%A8%E5%AF%BC%E8%88%AA%E6%A0%8F%E6%A1%86%E6%9E%B6/ class=md-nav__link> AndroidåŸç”Ÿåº•éƒ¨å¯¼èˆªæ  </a> </li> <li class=md-nav__item> <a href=../../other/Android%E6%90%9C%E7%B4%A2%E6%A0%8F%E7%9A%84%E5%AE%9E%E7%8E%B0/ class=md-nav__link> Androidæœç´¢æ çš„å®ç° </a> </li> <li class=md-nav__item> <a href=../../other/Android%E6%9A%82%E5%81%9C%E9%9F%B3%E4%B9%90%E6%92%AD%E6%94%BE%E5%99%A8%E7%9A%84%E6%92%AD%E6%94%BE/ class=md-nav__link> Androidæš‚åœé…·ç‹—ã€ç½‘æ˜“äº‘éŸ³ä¹ç­‰éŸ³ä¹æ’­æ”¾å™¨çš„æ’­æ”¾ </a> </li> <li class=md-nav__item> <a href=../../other/Android%E6%BB%91%E5%8A%A8%E8%BF%94%E5%9B%9E%E5%AE%9E%E8%B7%B5/ class=md-nav__link> Androidæ»‘åŠ¨è¿”å›å®è·µ </a> </li> <li class=md-nav__item> <a href=../../other/Android%E7%A8%8B%E5%BA%8F%E5%8F%8D%E7%BC%96%E8%AF%91/ class=md-nav__link> MacOSä¸‹Androidç¨‹åºåç¼–è¯‘ </a> </li> <li class=md-nav__item> <a href=../../other/Android%E9%80%9A%E8%AE%AF%E5%BD%95%E5%BF%AB%E9%80%9F%E8%AF%BB%E5%8F%96/ class=md-nav__link> Androidé€šè®¯å½•å¿«é€Ÿè¯»å– </a> </li> <li class=md-nav__item> <a href=../../other/soft-keyboard-in-app/ class=md-nav__link> Appå†…è‡ªå®šä¹‰è½¯é”®ç›˜ </a> </li> <li class=md-nav__item> <a href=../../other/%E8%85%BE%E8%AE%AFX5%E5%86%85%E6%A0%B8%E5%85%A5%E5%9D%91%E6%8C%87%E5%8D%97/ class=md-nav__link> è…¾è®¯TBS X5æµè§ˆå™¨å†…æ ¸å…¥å‘æŒ‡å— </a> </li> <li class=md-nav__item> <a href=../../other/%E7%90%90%E7%A2%8E%E7%9F%A5%E8%AF%86%E7%82%B9/ class=md-nav__link> çç¢çŸ¥è¯†ç‚¹ </a> </li> <li class=md-nav__item> <a href=../../other/%E7%90%90%E7%A2%8E%E7%9F%A5%E8%AF%86%E7%82%B92/ class=md-nav__link> çç¢çŸ¥è¯†ç‚¹2 </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week1-synchronized/ class=md-nav__link> ç†è§£Javaä¸­synchronizedå…³é”®è¯ </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week2-service/ class=md-nav__link> ç†è§£Service </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week3-activity/ class=md-nav__link> ç†è§£Activityçš„å¯åŠ¨æ¨¡å¼ </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week4-startActivityForResult/ class=md-nav__link> å…³äºstartActivityForResult </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week5-view/ class=md-nav__link> å…³äºViewçš„çŸ¥è¯† </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week6-gradle/ class=md-nav__link> å…³äºGradleçš„çŸ¥è¯† </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week7-serialization/ class=md-nav__link> å…³äºåºåˆ—åŒ–çš„çŸ¥è¯† </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week10-classloader/ class=md-nav__link> Androidä¸­çš„ClassLoader </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week11-binder/ class=md-nav__link> Binderç®€ä»‹ </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week12-retrofit-okhttp/ class=md-nav__link> OkHttpå’ŒRetrofitçš„ä½œç”¨ä»¥åŠä¸¤è€…ä¹‹é—´çš„è”ç³» </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week14-jvm-gc/ class=md-nav__link> JVMä¸­åƒåœ¾å›æ”¶ç­–ç•¥ </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week16-keep-app-alive/ class=md-nav__link> è¿›ç¨‹ä¿æ´» </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week17-android-components/ class=md-nav__link> å››å¤§ç»„ä»¶çš„ä½œç”¨ä»¥åŠå¤šè¿›ç¨‹ </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week20-network-protocol/ class=md-nav__link> ç½‘ç»œåè®® </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week21-mvc%26mvp%26mvvm/ class=md-nav__link> MVCã€MVPå’ŒMVVM </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week22-android-studio-build/ class=md-nav__link> Android Studio buildè¿‡ç¨‹ </a> </li> <li class=md-nav__item> <a href=../../paid/zsxq/week23-load-large-bitmap/ class=md-nav__link> å¤§å°ºå¯¸å›¾ç‰‡åŠ è½½é—®é¢˜ </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_1_4 type=checkbox id=__nav_1_4> <div class="md-nav__link md-nav__link--index "> <a href=../../paid/master/ >Androidå¼€å‘é«˜æ‰‹è¯¾</a> <label for=__nav_1_4> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label=Androidå¼€å‘é«˜æ‰‹è¯¾ data-md-level=2> <label class=md-nav__title for=__nav_1_4> <span class="md-nav__icon md-icon"></span> Androidå¼€å‘é«˜æ‰‹è¯¾ </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../paid/master/crash_1/ class=md-nav__link> 01 | å´©æºƒä¼˜åŒ–ï¼ˆä¸Šï¼‰ï¼šå…³äºâ€œå´©æºƒâ€é‚£äº›äº‹å„¿ </a> </li> <li class=md-nav__item> <a href=../../paid/master/crash_2/ class=md-nav__link> 02 | å´©æºƒä¼˜åŒ–ï¼ˆä¸‹ï¼‰ï¼šåº”ç”¨å´©æºƒäº†ï¼Œä½ åº”è¯¥å¦‚ä½•å»åˆ†æï¼Ÿ </a> </li> <li class=md-nav__item> <a href=../../paid/master/memory_1/ class=md-nav__link> 03 | å†…å­˜ä¼˜åŒ–ï¼ˆä¸Šï¼‰ï¼š4GBå†…å­˜æ—¶ä»£ï¼Œå†è°ˆå†…å­˜ä¼˜åŒ– </a> </li> <li class=md-nav__item> <a href=../../paid/master/memory_2/ class=md-nav__link> 04 | å†…å­˜ä¼˜åŒ–ï¼ˆä¸‹ï¼‰ï¼šå†…å­˜ä¼˜åŒ–è¿™ä»¶äº‹ï¼Œåº”è¯¥ä»å“ªé‡Œç€æ‰‹ï¼Ÿ </a> </li> <li class=md-nav__item> <a href=../../paid/master/stuck_1/ class=md-nav__link> 05 | å¡é¡¿ä¼˜åŒ–ï¼ˆä¸Šï¼‰ï¼šä½ è¦æŒæ¡çš„å¡é¡¿åˆ†ææ–¹æ³• </a> </li> <li class=md-nav__item> <a href=../../paid/master/stuck_2/ class=md-nav__link> 06 | å¡é¡¿ä¼˜åŒ–ï¼ˆä¸‹ï¼‰ï¼šå¦‚ä½•ç›‘æ§åº”ç”¨å¡é¡¿ï¼Ÿ </a> </li> <li class=md-nav__item> <a href=../../paid/master/stuck_3/ class=md-nav__link> 06è¡¥å……ç¯‡ | å¡é¡¿ä¼˜åŒ–ï¼šå¡é¡¿ç°åœºä¸å¡é¡¿åˆ†æ </a> </li> <li class=md-nav__item> <a href=../../paid/master/start_1/ class=md-nav__link> 07 | å¯åŠ¨ä¼˜åŒ–ï¼ˆä¸Šï¼‰ï¼šä»å¯åŠ¨è¿‡ç¨‹çœ‹å¯åŠ¨é€Ÿåº¦ä¼˜åŒ– </a> </li> <li class=md-nav__item> <a href=../../paid/master/start_2/ class=md-nav__link> 08 | å¯åŠ¨ä¼˜åŒ–ï¼ˆä¸‹ï¼‰ï¼šä¼˜åŒ–å¯åŠ¨é€Ÿåº¦çš„è¿›é˜¶æ–¹æ³• </a> </li> <li class=md-nav__item> <a href=../../paid/master/io_1/ class=md-nav__link> 09 | I/Oä¼˜åŒ–ï¼ˆä¸Šï¼‰ï¼šå¼€å‘å·¥ç¨‹å¸ˆå¿…å¤‡çš„I/Oä¼˜åŒ–çŸ¥è¯† </a> </li> <li class=md-nav__item> <a href=../../paid/master/io_2/ class=md-nav__link> 10 | I/Oä¼˜åŒ–ï¼ˆä¸­ï¼‰ï¼šä¸åŒI/Oæ–¹å¼çš„ä½¿ç”¨åœºæ™¯æ˜¯ä»€ä¹ˆï¼Ÿ </a> </li> <li class=md-nav__item> <a href=../../paid/master/io_3/ class=md-nav__link> 11 | I/Oä¼˜åŒ–ï¼ˆä¸‹ï¼‰ï¼šå¦‚ä½•ç›‘æ§çº¿ä¸ŠI/Oæ“ä½œï¼Ÿ </a> </li> <li class=md-nav__item> <a href=../../paid/master/storage_1/ class=md-nav__link> 12 | å­˜å‚¨ä¼˜åŒ–ï¼ˆä¸Šï¼‰ï¼šå¸¸è§çš„æ•°æ®å­˜å‚¨æ–¹æ³•æœ‰å“ªäº›ï¼Ÿ </a> </li> <li class=md-nav__item> <a href=../../paid/master/storage_2/ class=md-nav__link> 13 | å­˜å‚¨ä¼˜åŒ–ï¼ˆä¸­ï¼‰ï¼šå¦‚ä½•ä¼˜åŒ–æ•°æ®å­˜å‚¨ï¼Ÿ </a> </li> <li class=md-nav__item> <a href=../../paid/master/storage_3/ class=md-nav__link> 14 | å­˜å‚¨ä¼˜åŒ–ï¼ˆä¸‹ï¼‰ï¼šæ•°æ®åº“SQLiteçš„ä½¿ç”¨å’Œä¼˜åŒ– </a> </li> <li class=md-nav__item> <a href=../../paid/master/network_1/ class=md-nav__link> 15 | ç½‘ç»œä¼˜åŒ–ï¼ˆä¸Šï¼‰ï¼šç§»åŠ¨å¼€å‘å·¥ç¨‹å¸ˆå¿…å¤‡çš„ç½‘ç»œä¼˜åŒ–çŸ¥è¯† </a> </li> <li class=md-nav__item> <a href=../../paid/master/network_2/ class=md-nav__link> 16 | ç½‘ç»œä¼˜åŒ–ï¼ˆä¸­ï¼‰ï¼šå¤æ‚å¤šå˜çš„ç§»åŠ¨ç½‘ç»œè¯¥å¦‚ä½•ä¼˜åŒ–ï¼Ÿ </a> </li> <li class=md-nav__item> <a href=../../paid/master/network_3/ class=md-nav__link> 17 | ç½‘ç»œä¼˜åŒ–ï¼ˆä¸‹ï¼‰ï¼šå¤§æ•°æ®ä¸‹ç½‘ç»œè¯¥å¦‚ä½•ç›‘æ§ï¼Ÿ </a> </li> <li class=md-nav__item> <a href=../../paid/master/battery_1/ class=md-nav__link> 18 | è€—ç”µä¼˜åŒ–ï¼ˆä¸Šï¼‰ï¼šä»ç”µé‡ä¼˜åŒ–çš„æ¼”è¿›çœ‹è€—ç”µåˆ†æ </a> </li> <li class=md-nav__item> <a href=../../paid/master/battery_2/ class=md-nav__link> 19 | è€—ç”µä¼˜åŒ–ï¼ˆä¸‹ï¼‰ï¼šè€—ç”µçš„ä¼˜åŒ–æ–¹æ³•ä¸çº¿ä¸Šç›‘æ§ </a> </li> <li class=md-nav__item> <a href=../../paid/master/ui_1/ class=md-nav__link> 20 | UI ä¼˜åŒ–ï¼ˆä¸Šï¼‰ï¼šUI æ¸²æŸ“çš„å‡ ä¸ªå…³é”®æ¦‚å¿µ </a> </li> <li class=md-nav__item> <a href=../../paid/master/ui_2/ class=md-nav__link> 21 | UI ä¼˜åŒ–ï¼ˆä¸‹ï¼‰ï¼šå¦‚ä½•ä¼˜åŒ– UI æ¸²æŸ“ï¼Ÿ </a> </li> <li class=md-nav__item> <a href=../../paid/master/package_1/ class=md-nav__link> 22 | åŒ…ä½“ç§¯ä¼˜åŒ–ï¼ˆä¸Šï¼‰ï¼šå¦‚ä½•å‡å°‘å®‰è£…åŒ…å¤§å°ï¼Ÿ </a> </li> <li class=md-nav__item> <a href=../../paid/master/package_2/ class=md-nav__link> 23 | åŒ…ä½“ç§¯ä¼˜åŒ–ï¼ˆä¸‹ï¼‰ï¼šèµ„æºä¼˜åŒ–çš„è¿›é˜¶å®è·µ </a> </li> <li class=md-nav__item> <a href=../../paid/master/compile/ class=md-nav__link> 26 | å…³äºç¼–è¯‘ï¼Œä½ éœ€è¦äº†è§£ä»€ä¹ˆï¼Ÿ </a> </li> <li class=md-nav__item> <a href=../../paid/master/bytecode/ class=md-nav__link> 27 | ç¼–è¯‘æ’æ¡©çš„ä¸‰ç§æ–¹æ³•ï¼šAspectJã€ASMã€ReDex </a> </li> <li class=md-nav__item> <a href=../../paid/master/native_hook/ class=md-nav__link> 35 | Native Hook æŠ€æœ¯ï¼Œå¤©ä½¿è¿˜æ˜¯é­”é¬¼ï¼Ÿ </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_2 type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2> Flutter <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Flutter data-md-level=1> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Flutter </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_1/ class=md-nav__link> å¹´è½»äººçš„ç¬¬ä¸€ä¸ªFlutterç¨‹åº(1) </a> </li> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_2/ class=md-nav__link> å¹´è½»äººçš„ç¬¬ä¸€ä¸ªFlutterç¨‹åº(2) </a> </li> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_3/ class=md-nav__link> å¹´è½»äººçš„ç¬¬ä¸€ä¸ªFlutterç¨‹åº(3) </a> </li> <li class=md-nav__item> <a href=../../../flutter/flutter_first_project_4/ class=md-nav__link> å¹´è½»äººçš„ç¬¬ä¸€ä¸ªFlutterç¨‹åº(4) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3 type=checkbox id=__nav_3> <div class="md-nav__link md-nav__link--index "> <a href=../../../leetcode/ >LeetCode</a> <label for=__nav_3> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label=LeetCode data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> LeetCode </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_1/ class=md-nav__link> æ•°æ®ç»“æ„ã€ç®—æ³•å’Œæ•°æ®æ“ä½œ </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_3/ class=md-nav__link> é«˜è´¨é‡çš„ä»£ç  </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_4/ class=md-nav__link> è§£å†³é—®é¢˜çš„æ€è·¯ </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_5/ class=md-nav__link> ä¼˜åŒ–æ—¶é—´å’Œç©ºé—´æ•ˆç‡ </a> </li> <li class=md-nav__item> <a href=../../../leetcode/code_interviews_6/ class=md-nav__link> é¢è¯•ä¸­çš„å„é¡¹èƒ½åŠ› </a> </li> <li class=md-nav__item> <a href=../../../leetcode/array/ class=md-nav__link> Array </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode1-10/ class=md-nav__link> LeetCode(1-10) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode11-20/ class=md-nav__link> LeetCode(11-20) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode21-30/ class=md-nav__link> LeetCode(21-30) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode31-40/ class=md-nav__link> LeetCode(31-40) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode41-50/ class=md-nav__link> LeetCode(41-50) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode51-60/ class=md-nav__link> LeetCode(51-60) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode61-70/ class=md-nav__link> LeetCode(61-70) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode71-80/ class=md-nav__link> LeetCode(71-80) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode81-90/ class=md-nav__link> LeetCode(81-90) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode91-100/ class=md-nav__link> LeetCode(91-100) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode101-110/ class=md-nav__link> LeetCode(101-110) </a> </li> <li class=md-nav__item> <a href=../../../leetcode/leetcode111-120/ class=md-nav__link> LeetCode(111-120) </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4 type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4> Books <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Books data-md-level=1> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Books </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_1 type=checkbox id=__nav_4_1> <label class=md-nav__link for=__nav_4_1> Design Pattern <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Design Pattern" data-md-level=2> <label class=md-nav__title for=__nav_4_1> <span class="md-nav__icon md-icon"></span> Design Pattern </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../design-pattern/design-pattern/ class=md-nav__link> è®¾è®¡æ¨¡å¼æ¦‚è¿° </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/design-principle/ class=md-nav__link> é¢å‘å¯¹è±¡çš„å…­å¤§åŸåˆ™ </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/singleton/ class=md-nav__link> å•ä¾‹æ¨¡å¼(Singleton) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/builder/ class=md-nav__link> å»ºé€ è€…æ¨¡å¼(Builder) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/prototype/ class=md-nav__link> åŸå‹æ¨¡å¼(Prototype) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/factory-method/ class=md-nav__link> å·¥å‚æ–¹æ³•æ¨¡å¼(Factory method) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/abstract-factory/ class=md-nav__link> æŠ½è±¡å·¥å‚æ¨¡å¼(Abstract factory) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/proxy/ class=md-nav__link> ä»£ç†æ¨¡å¼(Proxy) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/composite/ class=md-nav__link> ç»„åˆæ¨¡å¼(Composite) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/adapter/ class=md-nav__link> é€‚é…å™¨æ¨¡å¼(Adapter) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/decorator/ class=md-nav__link> è£…é¥°æ¨¡å¼(Decorator) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/flyweight/ class=md-nav__link> äº«å…ƒæ¨¡å¼(Flyweight) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/facade/ class=md-nav__link> å¤–è§‚æ¨¡å¼(Facade) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/bridge/ class=md-nav__link> æ¡¥æ¥æ¨¡å¼(Bridge) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/strategy/ class=md-nav__link> ç­–ç•¥æ¨¡å¼(Strategy) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/state/ class=md-nav__link> çŠ¶æ€æ¨¡å¼(State) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/chain-of-responsibility/ class=md-nav__link> è´£ä»»é“¾æ¨¡å¼(Chain of responsibility) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/interpreter/ class=md-nav__link> è§£é‡Šå™¨æ¨¡å¼(Interpreter) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/command/ class=md-nav__link> å‘½ä»¤æ¨¡å¼(Command) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/observer/ class=md-nav__link> è§‚å¯Ÿè€…æ¨¡å¼(Observer) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/memento/ class=md-nav__link> å¤‡å¿˜å½•æ¨¡å¼(Memento) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/iterator/ class=md-nav__link> è¿­ä»£å™¨æ¨¡å¼(Iterator) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/template-method/ class=md-nav__link> æ¨¡ç‰ˆæ–¹æ³•æ¨¡å¼(Template method) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/visitor/ class=md-nav__link> è®¿é—®è€…æ¨¡å¼(Visitor) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/mediator/ class=md-nav__link> ä¸­ä»‹è€…æ¨¡å¼(Mediator) </a> </li> <li class=md-nav__item> <a href=../../../design-pattern/confusing-design-pattern/ class=md-nav__link> æ˜“æ··æ·†çš„è®¾è®¡æ¨¡å¼ </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_2 type=checkbox id=__nav_4_2> <label class=md-nav__link for=__nav_4_2> Effective Java <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Effective Java" data-md-level=2> <label class=md-nav__title for=__nav_4_2> <span class="md-nav__icon md-icon"></span> Effective Java </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../effective-java/effective-java/ class=md-nav__link> Effective Javaæ¦‚è¿° </a> </li> <li class=md-nav__item> <a href=../../../effective-java/chapter1/ class=md-nav__link> åˆ›å»ºå’Œé”€æ¯å¯¹è±¡ </a> </li> <li class=md-nav__item> <a href=../../../effective-java/chapter2/ class=md-nav__link> å¯¹äºæ‰€æœ‰å¯¹è±¡éƒ½é€šç”¨çš„æ–¹æ³• </a> </li> <li class=md-nav__item> <a href=../../../effective-java/chapter3/ class=md-nav__link> ç±»å’Œæ¥å£ </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_3 type=checkbox id=__nav_4_3> <label class=md-nav__link for=__nav_4_3> JVM <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=JVM data-md-level=2> <label class=md-nav__title for=__nav_4_3> <span class="md-nav__icon md-icon"></span> JVM </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../jvm/jvm-content/ class=md-nav__link> æ·±å…¥ç†è§£Javaè™šæ‹Ÿæœº </a> </li> <li class=md-nav__item> <a href=../../../jvm/java-memory-area-oom/ class=md-nav__link> Javaå†…å­˜åŒºåŸŸä¸å†…å­˜æº¢å‡ºå¼‚å¸¸ </a> </li> <li class=md-nav__item> <a href=../../../jvm/java-gc/ class=md-nav__link> åƒåœ¾æ”¶é›†å™¨ä¸å†…å­˜åˆ†é…ç­–ç•¥ </a> </li> <li class=md-nav__item> <a href=../../../jvm/class-struct/ class=md-nav__link> ç±»æ–‡ä»¶ç»“æ„ </a> </li> <li class=md-nav__item> <a href=../../../jvm/load-class/ class=md-nav__link> è™šæ‹Ÿæœºç±»åŠ è½½æœºåˆ¶ </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_4 type=checkbox id=__nav_4_4> <label class=md-nav__link for=__nav_4_4> Java <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Java data-md-level=2> <label class=md-nav__title for=__nav_4_4> <span class="md-nav__icon md-icon"></span> Java </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../java/generics-java-kotlin/ class=md-nav__link> Java&Kotlinåœ¨æ³›å‹æ–¹é¢çš„åŒºåˆ« </a> </li> <li class=md-nav__item> <a href=../../../java/java-collections/ class=md-nav__link> Javaé›†åˆæ€»ç»“ </a> </li> <li class=md-nav__item> <a href=../../../java/java-foundation/ class=md-nav__link> Javaå¸¸è§æ¦‚å¿µ </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4_5 type=checkbox id=__nav_4_5> <label class=md-nav__link for=__nav_4_5> Refactoring <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Refactoring data-md-level=2> <label class=md-nav__title for=__nav_4_5> <span class="md-nav__icon md-icon"></span> Refactoring </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../../refactoring/refactoring/ class=md-nav__link> é‡æ„ï¼šæ”¹å–„æ—¢æœ‰ä»£ç çš„è®¾è®¡ </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <span style=float:right;text-align:right;line-height:18px; id=busuanzi_container_page_pv>æœ¬æ–‡æ€»é˜…è¯»é‡<span id=busuanzi_value_page_pv></span>æ¬¡</span> <h1>Glide v4 æºç è§£æï¼ˆä¸‰ï¼‰</h1> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>æœ¬ç³»åˆ—æ–‡ç« å‚è€ƒ3.7.0ç‰ˆæœ¬çš„<a href=https://blog.csdn.net/sinyu890807/column/info/15318>guolin - Glideæœ€å…¨è§£æ</a>ï¼Œå¹¶æŒ‰æ­¤æ€è·¯ç»“åˆ4.9.0ç‰ˆæœ¬æºç ä»¥åŠä½¿ç”¨æ–‡æ¡£è¿›è¡Œæ›´æ–°ã€‚<br> âŸ <a href=https://github.com/bumptech/glide/tree/v4.9.0>Glide v4.9.0</a><br> âŸ <a href=https://muyangmin.github.io/glide-docs-cn/ >ä¸­æ–‡æ–‡æ¡£</a><br> âŸ <a href=https://bumptech.github.io/glide/ >è‹±æ–‡æ–‡æ¡£</a>ğŸš€ğŸš€ </p> </div> <div class="admonition note"> <p class=admonition-title>Glideç³»åˆ—æ–‡ç« ç›®å½•</p> <ul> <li><a href=/android/3rd-library/glide1/ >Glide1â€”â€”Glide v4 çš„åŸºæœ¬ä½¿ç”¨</a></li> <li><a href=/android/3rd-library/glide2/ >Glide2â€”â€”ä»æºç çš„è§’åº¦ç†è§£Glideä¸‰æ­¥çš„æ‰§è¡Œæµç¨‹</a></li> <li><a href=/android/3rd-library/glide3/ >Glide3â€”â€”æ·±å…¥æ¢ç©¶Glideç¼“å­˜æœºåˆ¶</a></li> <li><a href=/android/3rd-library/glide4/ >Glide4â€”â€”RequestBuilderä¸­é«˜çº§ç‚¹çš„APIä»¥åŠTarget</a></li> <li><a href=/android/3rd-library/glide5/ >Glide5â€”â€”Glideå†…ç½®çš„transformä»¥åŠè‡ªå®šä¹‰BitmapTransformation</a></li> <li><a href=/android/3rd-library/glide6/ >Glide6â€”â€”Glideåˆ©ç”¨AppGlideModuleã€LibraryGlideModuleæ›´æ”¹é»˜è®¤é…ç½®ã€æ‰©å±•GlideåŠŸèƒ½ï¼›GlideAppä¸Glideçš„åŒºåˆ«åœ¨å“ªï¼Ÿ</a></li> <li><a href=/android/3rd-library/glide7/ >Glide7â€”â€”åˆ©ç”¨OkHttpã€è‡ªå®šä¹‰Drawableã€è‡ªå®šä¹‰ViewTargetå®ç°å¸¦è¿›åº¦çš„å›¾ç‰‡åŠ è½½åŠŸèƒ½</a></li> <li><a href=/android/3rd-library/migrate-to-glide/ >æ‚è®°ï¼šä»Picassoè¿ç§»è‡³Glide</a></li> </ul> </div> <hr> <h2 id=1-glide>1. Glideç¼“å­˜æœºåˆ¶<a class=headerlink href=#1-glide title="Anchor link to this section for reference">&para;</a></h2> <p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æ¯”è¾ƒè¯¦ç»†åœ°ä»‹ç»äº†<code>Glide.with(xx).load(xx).into(xx)</code>ä¸­çš„å¾ˆå¤šè¿‡ç¨‹ï¼Œè™½ç„¶çœ‹å®Œä¹‹åç†å¾—ä¸æ˜¯ç‰¹åˆ«æ¸…æ¥šã€‚ä½†æ˜¯æ²¡å…³ç³»ï¼Œè¿™ç¯‡æ–‡ç« å¼€å§‹ä¼šä¸€ä¸ªæ–¹é¢ä¸€ä¸ªæ–¹é¢åœ°è¿›è¡Œæ€»ç»“ã€‚ </p> <p>æœ¬ç¯‡æ–‡ç« ä¸»è¦è®¨è®ºçš„å°±æ˜¯Glideä¸­çš„ç¼“å­˜é—®é¢˜ã€‚Glideç¼“å­˜æœºåˆ¶çš„æµç¨‹å›¾å¦‚ä¸‹ï¼š</p> <figure style="width: 100%" class=align-center> <img src=/assets/images/android/glide-cache-flow-chart.png> <figcaption>Glideç¼“å­˜æµç¨‹å›¾</figcaption> </figure> <p>ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼ŒGlideçš„èµ„æºçŠ¶æ€å¯ä»¥åˆ†ä¸ºå››ç§ï¼š</p> <ol> <li> <p>activeçŠ¶æ€èµ„æº </p> <blockquote> <p><code>Engine.load</code>æ–¹æ³•ä¸Šçš„æ³¨é‡Šå†™åˆ°ï¼šActive resources are those that have been provided to at least one request and have not yet been released. Once all consumers of a resource have released that resource, the resource then goes to cache. If the resource is ever returned to a new consumer from cache, it is re-added to the active resources. If the resource is evicted from the cache, its resources are recycled and re-used if possible and the resource is discarded. There is no strict requirement that consumers release their resources so active resources are held weakly.</p> </blockquote> </li> <li> <p>å†…å­˜ç¼“å­˜</p> </li> <li>dataç£ç›˜ç¼“å­˜ï¼šåŸå§‹çš„æ²¡æœ‰ä¿®æ”¹è¿‡çš„æ•°æ®ç¼“å­˜</li> <li>resourceç£ç›˜èµ„æºï¼šç»è¿‡è§£ç ã€transformedåçš„ç¼“å­˜</li> </ol> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>åœ¨<a href=https://muyangmin.github.io/glide-docs-cn/doc/caching.html>Glideä½¿ç”¨æ–‡æ¡£-ç¼“å­˜éƒ¨åˆ†</a>ä¸­æœ‰å¯¹Glideçš„æ•´ä¸ªç¼“å­˜ä½“ç³»åšå‡ºä¸€ä¸ªæ€»ç»“ï¼Œå‰å¾€äº†è§£ä¸€ä¸‹è¿˜æ˜¯éå¸¸å¥½çš„ã€‚ </p> </div> <p>åœ¨æ–‡æ¡£ä¸­æœ‰Glideçš„ç¼“å­˜ä½“ç³»çš„æ•´ä½“æè¿°ï¼Œæ–‡å­—æ‘˜æŠ„å¦‚ä¸‹ï¼š </p> <blockquote> <p>By default, Glide checks multiple layers of caches before starting a new request for an image:<br> 1. Active resources - Is this image displayed in another View right now? 2. Memory cache - Was this image recently loaded and still in memory? 3. Resource - Has this image been decoded, transformed, and written to the disk cache before? 4. Data - Was the data this image was obtained from written to the disk cache before? </p> <p>The first two steps check to see if the resource is in memory and if so, return the image immediately. The second two steps check to see if the image is on disk and return quickly, but asynchronously. </p> <p>If all four steps fail to find the image, then Glide will go back to the original source to retrieve the data (the original File, Uri, Url etc).<br> <cite><a href=http://bumptech.github.io/glide/doc/caching.html#caching-in-glide>Caching in Glide</a></cite> </p> </blockquote> <p>ä¸‹é¢å¼€å§‹ä¸€è¾¹è¿‡æºç ï¼Œä¸€éå°è¯ä¸Šé¢çš„å›¾å’Œæ¦‚è¦ã€‚</p> <p>Glideçš„memory cacheå’Œdisk cacheåœ¨Glideåˆ›å»ºçš„æ—¶å€™å°±ç¡®å®šäº†ã€‚ä»£ç åœ¨<code>GlideBuilder.build(Context)</code>æ–¹æ³•é‡Œé¢ã€‚å€¼å¾—ä¸€æçš„æ˜¯ï¼ŒGlideæ˜¯å•ä¾‹å®ç°çš„ï¼Œåœ¨ä¸Šä¸€ç«  <a href=/android/3rd-library/glide2/#11-getretrievercontext>1.1èŠ‚ getRetriever(Context)</a> ä¸­æˆ‘ä»¬åˆ†ææ—¶è´´äº†å¯¹åº”çš„ä»£ç ã€‚</p> <p>memory cacheå’Œdisk cacheåœ¨Glideåˆ›å»ºæ—¶ç›¸å…³ä»£ç å¦‚ä¸‹ï¼š</p> <p><strong>GlideBuilder.java</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-0-1 name=__codelineno-0-1></a><a href=#__codelineno-0-1><span class=linenos data-linenos=" 1 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-0-2 name=__codelineno-0-2></a><a href=#__codelineno-0-2><span class=linenos data-linenos=" 2 "></span></a><span class=n>Glide</span> <span class=nf>build</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>Context</span> <span class=n>context</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-0-3 name=__codelineno-0-3></a><a href=#__codelineno-0-3><span class=linenos data-linenos=" 3 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>memoryCache</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-0-4 name=__codelineno-0-4></a><a href=#__codelineno-0-4><span class=linenos data-linenos=" 4 "></span></a>    <span class=n>memoryCache</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LruResourceCache</span><span class=p>(</span><span class=n>memorySizeCalculator</span><span class=p>.</span><span class=na>getMemoryCacheSize</span><span class=p>());</span>
<a id=__codelineno-0-5 name=__codelineno-0-5></a><a href=#__codelineno-0-5><span class=linenos data-linenos=" 5 "></span></a>  <span class=p>}</span>
<a id=__codelineno-0-6 name=__codelineno-0-6></a><a href=#__codelineno-0-6><span class=linenos data-linenos=" 6 "></span></a>
<a id=__codelineno-0-7 name=__codelineno-0-7></a><a href=#__codelineno-0-7><span class=linenos data-linenos=" 7 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>diskCacheFactory</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-0-8 name=__codelineno-0-8></a><a href=#__codelineno-0-8><span class=linenos data-linenos=" 8 "></span></a>    <span class=n>diskCacheFactory</span> <span class=o>=</span> <span class=k>new</span> <span class=n>InternalCacheDiskCacheFactory</span><span class=p>(</span><span class=n>context</span><span class=p>);</span>
<a id=__codelineno-0-9 name=__codelineno-0-9></a><a href=#__codelineno-0-9><span class=linenos data-linenos=" 9 "></span></a>  <span class=p>}</span>
<a id=__codelineno-0-10 name=__codelineno-0-10></a><a href=#__codelineno-0-10><span class=linenos data-linenos="10 "></span></a>
<a id=__codelineno-0-11 name=__codelineno-0-11></a><a href=#__codelineno-0-11><span class=linenos data-linenos="11 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>engine</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-0-12 name=__codelineno-0-12></a><a href=#__codelineno-0-12><span class=linenos data-linenos="12 "></span></a>    <span class=n>engine</span> <span class=o>=</span>
<a id=__codelineno-0-13 name=__codelineno-0-13></a><a href=#__codelineno-0-13><span class=linenos data-linenos="13 "></span></a>        <span class=k>new</span> <span class=n>Engine</span><span class=p>(</span>
<a id=__codelineno-0-14 name=__codelineno-0-14></a><a href=#__codelineno-0-14><span class=linenos data-linenos="14 "></span></a>            <span class=n>memoryCache</span><span class=p>,</span>
<a id=__codelineno-0-15 name=__codelineno-0-15></a><a href=#__codelineno-0-15><span class=linenos data-linenos="15 "></span></a>            <span class=n>diskCacheFactory</span><span class=p>,</span>
<a id=__codelineno-0-16 name=__codelineno-0-16></a><a href=#__codelineno-0-16><span class=linenos data-linenos="16 "></span></a>            <span class=p>...);</span>
<a id=__codelineno-0-17 name=__codelineno-0-17></a><a href=#__codelineno-0-17><span class=linenos data-linenos="17 "></span></a>  <span class=p>}</span>
<a id=__codelineno-0-18 name=__codelineno-0-18></a><a href=#__codelineno-0-18><span class=linenos data-linenos="18 "></span></a>
<a id=__codelineno-0-19 name=__codelineno-0-19></a><a href=#__codelineno-0-19><span class=linenos data-linenos="19 "></span></a>  <span class=k>return</span> <span class=k>new</span> <span class=n>Glide</span><span class=p>(</span>
<a id=__codelineno-0-20 name=__codelineno-0-20></a><a href=#__codelineno-0-20><span class=linenos data-linenos="20 "></span></a>      <span class=p>...</span>
<a id=__codelineno-0-21 name=__codelineno-0-21></a><a href=#__codelineno-0-21><span class=linenos data-linenos="21 "></span></a>      <span class=n>memoryCache</span><span class=p>,</span>
<a id=__codelineno-0-22 name=__codelineno-0-22></a><a href=#__codelineno-0-22><span class=linenos data-linenos="22 "></span></a>      <span class=p>...);</span>
<a id=__codelineno-0-23 name=__codelineno-0-23></a><a href=#__codelineno-0-23><span class=linenos data-linenos="23 "></span></a><span class=p>}</span>
</code></pre></div> <p>memoryCacheå’ŒdiskCacheFactoryå¦‚æœæ²¡æœ‰æ²¡æœ‰åœ¨ä»»ä½•<code>GlideMode</code>ä¸­è¿›è¡Œè®¾ç½®çš„è¯ï¼Œä¼šæœ‰ä¸€ä¸ªé»˜è®¤çš„å®ç°ã€‚å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨è¿™ä¸ªé»˜è®¤å®ç°å°±å¾ˆå¥½äº†ã€‚ </p> <h2 id=2-memorycache>2. memoryCacheä»‹ç»<a class=headerlink href=#2-memorycache title="Anchor link to this section for reference">&para;</a></h2> <p>memoryCacheå‘ç”Ÿå­˜å–æ“ä½œæ˜¯åœ¨Engineä¸­ï¼Œä½†æ˜¯æˆ‘ä»¬çœ‹åˆ°memoryCacheè¿˜è¢«æ”¾å…¥äº†Glideå®ä¾‹ä¸­ã€‚è¿™æ˜¯å› ä¸ºGlideå®ç°äº†<code>ComponentCallbacks2</code>æ¥å£ï¼Œåœ¨Glideåˆ›å»ºå®Œæˆåï¼Œå®ä¾‹å°±æ³¨å†Œäº†è¯¥æ¥å£ã€‚è¿™æ ·åœ¨å†…å­˜ç´§å¼ çš„æ—¶å€™ï¼Œå¯ä»¥é€šçŸ¥memoryCacheé‡Šæ”¾å†…å­˜ã€‚</p> <p><strong>Glide.java</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-1-1 name=__codelineno-1-1></a><a href=#__codelineno-1-1><span class=linenos data-linenos=" 1 "></span></a><span class=nd>@Override</span>
<a id=__codelineno-1-2 name=__codelineno-1-2></a><a href=#__codelineno-1-2><span class=linenos data-linenos=" 2 "></span></a><span class=kd>public</span> <span class=kt>void</span> <span class=nf>onTrimMemory</span><span class=p>(</span><span class=kt>int</span> <span class=n>level</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-1-3 name=__codelineno-1-3></a><a href=#__codelineno-1-3><span class=linenos data-linenos=" 3 "></span></a>  <span class=n>trimMemory</span><span class=p>(</span><span class=n>level</span><span class=p>);</span>
<a id=__codelineno-1-4 name=__codelineno-1-4></a><a href=#__codelineno-1-4><span class=linenos data-linenos=" 4 "></span></a><span class=p>}</span>
<a id=__codelineno-1-5 name=__codelineno-1-5></a><a href=#__codelineno-1-5><span class=linenos data-linenos=" 5 "></span></a>
<a id=__codelineno-1-6 name=__codelineno-1-6></a><a href=#__codelineno-1-6><span class=linenos data-linenos=" 6 "></span></a><span class=kd>public</span> <span class=kt>void</span> <span class=nf>trimMemory</span><span class=p>(</span><span class=kt>int</span> <span class=n>level</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-1-7 name=__codelineno-1-7></a><a href=#__codelineno-1-7><span class=linenos data-linenos=" 7 "></span></a>  <span class=c1>// Engine asserts this anyway when removing resources, fail faster and consistently</span>
<a id=__codelineno-1-8 name=__codelineno-1-8></a><a href=#__codelineno-1-8><span class=linenos data-linenos=" 8 "></span></a>  <span class=n>Util</span><span class=p>.</span><span class=na>assertMainThread</span><span class=p>();</span>
<a id=__codelineno-1-9 name=__codelineno-1-9></a><a href=#__codelineno-1-9><span class=linenos data-linenos=" 9 "></span></a>  <span class=c1>// memory cache needs to be trimmed before bitmap pool to trim re-pooled Bitmaps too. See #687.</span>
<a id=__codelineno-1-10 name=__codelineno-1-10></a><a href=#__codelineno-1-10><span class=linenos data-linenos="10 "></span></a>  <span class=n>memoryCache</span><span class=p>.</span><span class=na>trimMemory</span><span class=p>(</span><span class=n>level</span><span class=p>);</span>
<a id=__codelineno-1-11 name=__codelineno-1-11></a><a href=#__codelineno-1-11><span class=linenos data-linenos="11 "></span></a>  <span class=n>bitmapPool</span><span class=p>.</span><span class=na>trimMemory</span><span class=p>(</span><span class=n>level</span><span class=p>);</span>
<a id=__codelineno-1-12 name=__codelineno-1-12></a><a href=#__codelineno-1-12><span class=linenos data-linenos="12 "></span></a>  <span class=n>arrayPool</span><span class=p>.</span><span class=na>trimMemory</span><span class=p>(</span><span class=n>level</span><span class=p>);</span>
<a id=__codelineno-1-13 name=__codelineno-1-13></a><a href=#__codelineno-1-13><span class=linenos data-linenos="13 "></span></a><span class=p>}</span>
</code></pre></div> <p>memoryCacheæ˜¯ä¸€ä¸ªä½¿ç”¨LRU(least recently used)ç®—æ³•å®ç°çš„å†…å­˜ç¼“å­˜ç±»<code>LruResourceCache</code>ï¼Œç»§æ‰¿è‡³<code>LruCache</code>ç±»ï¼Œå®ç°äº†<code>MemoryCache</code>æ¥å£ã€‚<br> <code>LruCache</code>å®šä¹‰äº†LRUç›¸å…³çš„æ“ä½œï¼Œè€Œ<code>MemoryCache</code>å®šä¹‰çš„æ˜¯å†…å­˜ç¼“å­˜ç›¸å…³çš„æ“ä½œã€‚<code>LruResourceCache</code>å…¶ç›¸å…³ä»£ç å¦‚ä¸‹ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-2-1 name=__codelineno-2-1></a><a href=#__codelineno-2-1><span class=linenos data-linenos=" 1 "></span></a><span class=kd>public</span> <span class=kd>class</span> <span class=nc>LruResourceCache</span> <span class=kd>extends</span> <span class=n>LruCache</span><span class=o>&lt;</span><span class=n>Key</span><span class=p>,</span> <span class=n>Resource</span><span class=o>&lt;?&gt;&gt;</span> <span class=kd>implements</span> <span class=n>MemoryCache</span> <span class=p>{</span>
<a id=__codelineno-2-2 name=__codelineno-2-2></a><a href=#__codelineno-2-2><span class=linenos data-linenos=" 2 "></span></a>  <span class=p>...</span>
<a id=__codelineno-2-3 name=__codelineno-2-3></a><a href=#__codelineno-2-3><span class=linenos data-linenos=" 3 "></span></a>  <span class=nd>@Override</span>
<a id=__codelineno-2-4 name=__codelineno-2-4></a><a href=#__codelineno-2-4><span class=linenos data-linenos=" 4 "></span></a>  <span class=kd>protected</span> <span class=kt>int</span> <span class=nf>getSize</span><span class=p>(</span><span class=nd>@Nullable</span> <span class=n>Resource</span><span class=o>&lt;?&gt;</span> <span class=n>item</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-2-5 name=__codelineno-2-5></a><a href=#__codelineno-2-5><span class=linenos data-linenos=" 5 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>item</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-2-6 name=__codelineno-2-6></a><a href=#__codelineno-2-6><span class=linenos data-linenos=" 6 "></span></a>      <span class=k>return</span> <span class=kd>super</span><span class=p>.</span><span class=na>getSize</span><span class=p>(</span><span class=kc>null</span><span class=p>);</span>
<a id=__codelineno-2-7 name=__codelineno-2-7></a><a href=#__codelineno-2-7><span class=linenos data-linenos=" 7 "></span></a>    <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
<a id=__codelineno-2-8 name=__codelineno-2-8></a><a href=#__codelineno-2-8><span class=linenos data-linenos=" 8 "></span></a>      <span class=k>return</span> <span class=n>item</span><span class=p>.</span><span class=na>getSize</span><span class=p>();</span>
<a id=__codelineno-2-9 name=__codelineno-2-9></a><a href=#__codelineno-2-9><span class=linenos data-linenos=" 9 "></span></a>    <span class=p>}</span>
<a id=__codelineno-2-10 name=__codelineno-2-10></a><a href=#__codelineno-2-10><span class=linenos data-linenos="10 "></span></a>  <span class=p>}</span>
<a id=__codelineno-2-11 name=__codelineno-2-11></a><a href=#__codelineno-2-11><span class=linenos data-linenos="11 "></span></a>
<a id=__codelineno-2-12 name=__codelineno-2-12></a><a href=#__codelineno-2-12><span class=linenos data-linenos="12 "></span></a>  <span class=nd>@SuppressLint</span><span class=p>(</span><span class=s>&quot;InlinedApi&quot;</span><span class=p>)</span>
<a id=__codelineno-2-13 name=__codelineno-2-13></a><a href=#__codelineno-2-13><span class=linenos data-linenos="13 "></span></a>  <span class=nd>@Override</span>
<a id=__codelineno-2-14 name=__codelineno-2-14></a><a href=#__codelineno-2-14><span class=linenos data-linenos="14 "></span></a>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>trimMemory</span><span class=p>(</span><span class=kt>int</span> <span class=n>level</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-2-15 name=__codelineno-2-15></a><a href=#__codelineno-2-15><span class=linenos data-linenos="15 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>level</span> <span class=o>&gt;=</span> <span class=n>android</span><span class=p>.</span><span class=na>content</span><span class=p>.</span><span class=na>ComponentCallbacks2</span><span class=p>.</span><span class=na>TRIM_MEMORY_BACKGROUND</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-2-16 name=__codelineno-2-16></a><a href=#__codelineno-2-16><span class=linenos data-linenos="16 "></span></a>      <span class=c1>// Entering list of cached background apps</span>
<a id=__codelineno-2-17 name=__codelineno-2-17></a><a href=#__codelineno-2-17><span class=linenos data-linenos="17 "></span></a>      <span class=c1>// Evict our entire bitmap cache</span>
<a id=__codelineno-2-18 name=__codelineno-2-18></a><a href=#__codelineno-2-18><span class=linenos data-linenos="18 "></span></a>      <span class=n>clearMemory</span><span class=p>();</span>
<a id=__codelineno-2-19 name=__codelineno-2-19></a><a href=#__codelineno-2-19><span class=linenos data-linenos="19 "></span></a>    <span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>level</span> <span class=o>&gt;=</span> <span class=n>android</span><span class=p>.</span><span class=na>content</span><span class=p>.</span><span class=na>ComponentCallbacks2</span><span class=p>.</span><span class=na>TRIM_MEMORY_UI_HIDDEN</span>
<a id=__codelineno-2-20 name=__codelineno-2-20></a><a href=#__codelineno-2-20><span class=linenos data-linenos="20 "></span></a>        <span class=o>||</span> <span class=n>level</span> <span class=o>==</span> <span class=n>android</span><span class=p>.</span><span class=na>content</span><span class=p>.</span><span class=na>ComponentCallbacks2</span><span class=p>.</span><span class=na>TRIM_MEMORY_RUNNING_CRITICAL</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-2-21 name=__codelineno-2-21></a><a href=#__codelineno-2-21><span class=linenos data-linenos="21 "></span></a>      <span class=c1>// The app&#39;s UI is no longer visible, or app is in the foreground but system is running</span>
<a id=__codelineno-2-22 name=__codelineno-2-22></a><a href=#__codelineno-2-22><span class=linenos data-linenos="22 "></span></a>      <span class=c1>// critically low on memory</span>
<a id=__codelineno-2-23 name=__codelineno-2-23></a><a href=#__codelineno-2-23><span class=linenos data-linenos="23 "></span></a>      <span class=c1>// Evict oldest half of our bitmap cache</span>
<a id=__codelineno-2-24 name=__codelineno-2-24></a><a href=#__codelineno-2-24><span class=linenos data-linenos="24 "></span></a>      <span class=n>trimToSize</span><span class=p>(</span><span class=n>getMaxSize</span><span class=p>()</span> <span class=o>/</span> <span class=mi>2</span><span class=p>);</span>
<a id=__codelineno-2-25 name=__codelineno-2-25></a><a href=#__codelineno-2-25><span class=linenos data-linenos="25 "></span></a>    <span class=p>}</span>
<a id=__codelineno-2-26 name=__codelineno-2-26></a><a href=#__codelineno-2-26><span class=linenos data-linenos="26 "></span></a>  <span class=p>}</span>
<a id=__codelineno-2-27 name=__codelineno-2-27></a><a href=#__codelineno-2-27><span class=linenos data-linenos="27 "></span></a><span class=p>}</span>
</code></pre></div> <p><code>LruCache</code>çš„å®ç°ä¸»è¦é <code>LinkedHashMap</code>çš„ä¸€ä¸ªæ„é€ å‚æ•°ï¼š<code>accessOrder</code>ã€‚<br> å½“è¯¥å‚æ•°ä¸ºtrueæ—¶ï¼Œæ¯æ¬¡è°ƒç”¨<code>LinkedHashMap</code>çš„<code>get(key)</code>æˆ–<code>getOrDefault(key, defaultValue)</code>æ–¹æ³•éƒ½ä¼šè§¦å‘<code>afterNodeAccess(Object)</code>æ–¹æ³•ï¼Œæ­¤æ–¹æ³•ä¼šå°†å¯¹åº”çš„nodeç§»åŠ¨åˆ°é“¾è¡¨çš„æœ«å°¾ã€‚ä¹Ÿå°±æ˜¯è¯´<code>LinkedHashMap</code>æœ«å°¾çš„æ•°æ®æ˜¯æœ€è¿‘â€œæœ€å¤šâ€ä½¿ç”¨çš„ã€‚<br> è€Œ<code>LruCache</code>æ¸…é™¤å†…å­˜æ—¶éƒ½ä¼šè°ƒç”¨<code>trimToSize(size)</code>æ–¹æ³•æ—¶ï¼Œä¼šä»å¤´åˆ°å°¾è¿›è¡Œæ¸…ç†ï¼Œè¿™æ ·LRUçš„ç‰¹ç‚¹å°±ä½“ç°å‡ºæ¥äº†ã€‚ </p> <p>ç›¸å…³ä»£ç å¦‚ä¸‹ï¼š</p> <p><strong>LruCache.java</strong> </p> <div class=highlight><pre><span></span><code><a id=__codelineno-3-1 name=__codelineno-3-1></a><a href=#__codelineno-3-1><span class=linenos data-linenos=" 1 "></span></a><span class=kd>public</span> <span class=kd>class</span> <span class=nc>LruCache</span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span> <span class=n>Y</span><span class=o>&gt;</span> <span class=p>{</span>
<a id=__codelineno-3-2 name=__codelineno-3-2></a><a href=#__codelineno-3-2><span class=linenos data-linenos=" 2 "></span></a>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span> <span class=n>Y</span><span class=o>&gt;</span> <span class=n>cache</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LinkedHashMap</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=mi>100</span><span class=p>,</span> <span class=mf>0.75f</span><span class=p>,</span> <span class=kc>true</span><span class=p>);</span>
<a id=__codelineno-3-3 name=__codelineno-3-3></a><a href=#__codelineno-3-3><span class=linenos data-linenos=" 3 "></span></a>  <span class=p>...</span>
<a id=__codelineno-3-4 name=__codelineno-3-4></a><a href=#__codelineno-3-4><span class=linenos data-linenos=" 4 "></span></a>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>clearMemory</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-3-5 name=__codelineno-3-5></a><a href=#__codelineno-3-5><span class=linenos data-linenos=" 5 "></span></a>    <span class=n>trimToSize</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
<a id=__codelineno-3-6 name=__codelineno-3-6></a><a href=#__codelineno-3-6><span class=linenos data-linenos=" 6 "></span></a>  <span class=p>}</span>
<a id=__codelineno-3-7 name=__codelineno-3-7></a><a href=#__codelineno-3-7><span class=linenos data-linenos=" 7 "></span></a>
<a id=__codelineno-3-8 name=__codelineno-3-8></a><a href=#__codelineno-3-8><span class=linenos data-linenos=" 8 "></span></a>  <span class=kd>protected</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>trimToSize</span><span class=p>(</span><span class=kt>long</span> <span class=n>size</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-3-9 name=__codelineno-3-9></a><a href=#__codelineno-3-9><span class=linenos data-linenos=" 9 "></span></a>    <span class=n>Map</span><span class=p>.</span><span class=na>Entry</span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span> <span class=n>Y</span><span class=o>&gt;</span> <span class=n>last</span><span class=p>;</span>
<a id=__codelineno-3-10 name=__codelineno-3-10></a><a href=#__codelineno-3-10><span class=linenos data-linenos="10 "></span></a>    <span class=n>Iterator</span><span class=o>&lt;</span><span class=n>Map</span><span class=p>.</span><span class=na>Entry</span><span class=o>&lt;</span><span class=n>T</span><span class=p>,</span> <span class=n>Y</span><span class=o>&gt;&gt;</span> <span class=n>cacheIterator</span><span class=p>;</span>
<a id=__codelineno-3-11 name=__codelineno-3-11></a><a href=#__codelineno-3-11><span class=linenos data-linenos="11 "></span></a>    <span class=k>while</span> <span class=p>(</span><span class=n>currentSize</span> <span class=o>&gt;</span> <span class=n>size</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-3-12 name=__codelineno-3-12></a><a href=#__codelineno-3-12><span class=linenos data-linenos="12 "></span></a>      <span class=c1>// ğŸ‘ğŸ‘ğŸ‘ æœç„¶æ˜¯ä»å¤´åˆ°å°¾è¿›è¡Œéå†çš„</span>
<a id=__codelineno-3-13 name=__codelineno-3-13></a><a href=#__codelineno-3-13><span class=linenos data-linenos="13 "></span></a>      <span class=n>cacheIterator</span>  <span class=o>=</span> <span class=n>cache</span><span class=p>.</span><span class=na>entrySet</span><span class=p>().</span><span class=na>iterator</span><span class=p>();</span>
<a id=__codelineno-3-14 name=__codelineno-3-14></a><a href=#__codelineno-3-14><span class=linenos data-linenos="14 "></span></a>      <span class=n>last</span> <span class=o>=</span> <span class=n>cacheIterator</span><span class=p>.</span><span class=na>next</span><span class=p>();</span>
<a id=__codelineno-3-15 name=__codelineno-3-15></a><a href=#__codelineno-3-15><span class=linenos data-linenos="15 "></span></a>      <span class=kd>final</span> <span class=n>Y</span> <span class=n>toRemove</span> <span class=o>=</span> <span class=n>last</span><span class=p>.</span><span class=na>getValue</span><span class=p>();</span>
<a id=__codelineno-3-16 name=__codelineno-3-16></a><a href=#__codelineno-3-16><span class=linenos data-linenos="16 "></span></a>      <span class=n>currentSize</span> <span class=o>-=</span> <span class=n>getSize</span><span class=p>(</span><span class=n>toRemove</span><span class=p>);</span>
<a id=__codelineno-3-17 name=__codelineno-3-17></a><a href=#__codelineno-3-17><span class=linenos data-linenos="17 "></span></a>      <span class=kd>final</span> <span class=n>T</span> <span class=n>key</span> <span class=o>=</span> <span class=n>last</span><span class=p>.</span><span class=na>getKey</span><span class=p>();</span>
<a id=__codelineno-3-18 name=__codelineno-3-18></a><a href=#__codelineno-3-18><span class=linenos data-linenos="18 "></span></a>      <span class=n>cacheIterator</span><span class=p>.</span><span class=na>remove</span><span class=p>();</span>
<a id=__codelineno-3-19 name=__codelineno-3-19></a><a href=#__codelineno-3-19><span class=linenos data-linenos="19 "></span></a>      <span class=n>onItemEvicted</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>toRemove</span><span class=p>);</span>
<a id=__codelineno-3-20 name=__codelineno-3-20></a><a href=#__codelineno-3-20><span class=linenos data-linenos="20 "></span></a>    <span class=p>}</span>
<a id=__codelineno-3-21 name=__codelineno-3-21></a><a href=#__codelineno-3-21><span class=linenos data-linenos="21 "></span></a>  <span class=p>}</span>
<a id=__codelineno-3-22 name=__codelineno-3-22></a><a href=#__codelineno-3-22><span class=linenos data-linenos="22 "></span></a>
<a id=__codelineno-3-23 name=__codelineno-3-23></a><a href=#__codelineno-3-23><span class=linenos data-linenos="23 "></span></a>  <span class=kd>private</span> <span class=kt>void</span> <span class=nf>evict</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-3-24 name=__codelineno-3-24></a><a href=#__codelineno-3-24><span class=linenos data-linenos="24 "></span></a>    <span class=n>trimToSize</span><span class=p>(</span><span class=n>maxSize</span><span class=p>);</span>
<a id=__codelineno-3-25 name=__codelineno-3-25></a><a href=#__codelineno-3-25><span class=linenos data-linenos="25 "></span></a>  <span class=p>}</span>
<a id=__codelineno-3-26 name=__codelineno-3-26></a><a href=#__codelineno-3-26><span class=linenos data-linenos="26 "></span></a><span class=p>}</span>
</code></pre></div> <p><strong>LinkedHashMap.java</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-4-1 name=__codelineno-4-1></a><a href=#__codelineno-4-1><span class=linenos data-linenos=" 1 "></span></a><span class=kd>public</span> <span class=kd>class</span> <span class=nc>LinkedHashMap</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span>
<a id=__codelineno-4-2 name=__codelineno-4-2></a><a href=#__codelineno-4-2><span class=linenos data-linenos=" 2 "></span></a>    <span class=kd>extends</span> <span class=n>HashMap</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span>
<a id=__codelineno-4-3 name=__codelineno-4-3></a><a href=#__codelineno-4-3><span class=linenos data-linenos=" 3 "></span></a>    <span class=kd>implements</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span>
<a id=__codelineno-4-4 name=__codelineno-4-4></a><a href=#__codelineno-4-4><span class=linenos data-linenos=" 4 "></span></a><span class=p>{</span>
<a id=__codelineno-4-5 name=__codelineno-4-5></a><a href=#__codelineno-4-5><span class=linenos data-linenos=" 5 "></span></a>    <span class=kd>public</span> <span class=nf>LinkedHashMap</span><span class=p>(</span><span class=kt>int</span> <span class=n>initialCapacity</span><span class=p>,</span>
<a id=__codelineno-4-6 name=__codelineno-4-6></a><a href=#__codelineno-4-6><span class=linenos data-linenos=" 6 "></span></a>                         <span class=kt>float</span> <span class=n>loadFactor</span><span class=p>,</span>
<a id=__codelineno-4-7 name=__codelineno-4-7></a><a href=#__codelineno-4-7><span class=linenos data-linenos=" 7 "></span></a>                         <span class=kt>boolean</span> <span class=n>accessOrder</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-4-8 name=__codelineno-4-8></a><a href=#__codelineno-4-8><span class=linenos data-linenos=" 8 "></span></a>        <span class=kd>super</span><span class=p>(</span><span class=n>initialCapacity</span><span class=p>,</span> <span class=n>loadFactor</span><span class=p>);</span>
<a id=__codelineno-4-9 name=__codelineno-4-9></a><a href=#__codelineno-4-9><span class=linenos data-linenos=" 9 "></span></a>        <span class=k>this</span><span class=p>.</span><span class=na>accessOrder</span> <span class=o>=</span> <span class=n>accessOrder</span><span class=p>;</span>
<a id=__codelineno-4-10 name=__codelineno-4-10></a><a href=#__codelineno-4-10><span class=linenos data-linenos="10 "></span></a>    <span class=p>}</span>
<a id=__codelineno-4-11 name=__codelineno-4-11></a><a href=#__codelineno-4-11><span class=linenos data-linenos="11 "></span></a>
<a id=__codelineno-4-12 name=__codelineno-4-12></a><a href=#__codelineno-4-12><span class=linenos data-linenos="12 "></span></a>    <span class=kd>public</span> <span class=n>V</span> <span class=nf>get</span><span class=p>(</span><span class=n>Object</span> <span class=n>key</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-4-13 name=__codelineno-4-13></a><a href=#__codelineno-4-13><span class=linenos data-linenos="13 "></span></a>        <span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=n>e</span><span class=p>;</span>
<a id=__codelineno-4-14 name=__codelineno-4-14></a><a href=#__codelineno-4-14><span class=linenos data-linenos="14 "></span></a>        <span class=k>if</span> <span class=p>((</span><span class=n>e</span> <span class=o>=</span> <span class=n>getNode</span><span class=p>(</span><span class=n>hash</span><span class=p>(</span><span class=n>key</span><span class=p>),</span> <span class=n>key</span><span class=p>))</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span>
<a id=__codelineno-4-15 name=__codelineno-4-15></a><a href=#__codelineno-4-15><span class=linenos data-linenos="15 "></span></a>            <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-4-16 name=__codelineno-4-16></a><a href=#__codelineno-4-16><span class=linenos data-linenos="16 "></span></a>        <span class=k>if</span> <span class=p>(</span><span class=n>accessOrder</span><span class=p>)</span>
<a id=__codelineno-4-17 name=__codelineno-4-17></a><a href=#__codelineno-4-17><span class=linenos data-linenos="17 "></span></a>            <span class=n>afterNodeAccess</span><span class=p>(</span><span class=n>e</span><span class=p>);</span>
<a id=__codelineno-4-18 name=__codelineno-4-18></a><a href=#__codelineno-4-18><span class=linenos data-linenos="18 "></span></a>        <span class=k>return</span> <span class=n>e</span><span class=p>.</span><span class=na>value</span><span class=p>;</span>
<a id=__codelineno-4-19 name=__codelineno-4-19></a><a href=#__codelineno-4-19><span class=linenos data-linenos="19 "></span></a>    <span class=p>}</span>
<a id=__codelineno-4-20 name=__codelineno-4-20></a><a href=#__codelineno-4-20><span class=linenos data-linenos="20 "></span></a>
<a id=__codelineno-4-21 name=__codelineno-4-21></a><a href=#__codelineno-4-21><span class=linenos data-linenos="21 "></span></a>    <span class=cm>/**</span>
<a id=__codelineno-4-22 name=__codelineno-4-22></a><a href=#__codelineno-4-22><span class=linenos data-linenos="22 "></span></a><span class=cm>     * {@inheritDoc}</span>
<a id=__codelineno-4-23 name=__codelineno-4-23></a><a href=#__codelineno-4-23><span class=linenos data-linenos="23 "></span></a><span class=cm>     */</span>
<a id=__codelineno-4-24 name=__codelineno-4-24></a><a href=#__codelineno-4-24><span class=linenos data-linenos="24 "></span></a>    <span class=kd>public</span> <span class=n>V</span> <span class=nf>getOrDefault</span><span class=p>(</span><span class=n>Object</span> <span class=n>key</span><span class=p>,</span> <span class=n>V</span> <span class=n>defaultValue</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-4-25 name=__codelineno-4-25></a><a href=#__codelineno-4-25><span class=linenos data-linenos="25 "></span></a>       <span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=n>e</span><span class=p>;</span>
<a id=__codelineno-4-26 name=__codelineno-4-26></a><a href=#__codelineno-4-26><span class=linenos data-linenos="26 "></span></a>       <span class=k>if</span> <span class=p>((</span><span class=n>e</span> <span class=o>=</span> <span class=n>getNode</span><span class=p>(</span><span class=n>hash</span><span class=p>(</span><span class=n>key</span><span class=p>),</span> <span class=n>key</span><span class=p>))</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span>
<a id=__codelineno-4-27 name=__codelineno-4-27></a><a href=#__codelineno-4-27><span class=linenos data-linenos="27 "></span></a>           <span class=k>return</span> <span class=n>defaultValue</span><span class=p>;</span>
<a id=__codelineno-4-28 name=__codelineno-4-28></a><a href=#__codelineno-4-28><span class=linenos data-linenos="28 "></span></a>       <span class=k>if</span> <span class=p>(</span><span class=n>accessOrder</span><span class=p>)</span>
<a id=__codelineno-4-29 name=__codelineno-4-29></a><a href=#__codelineno-4-29><span class=linenos data-linenos="29 "></span></a>           <span class=n>afterNodeAccess</span><span class=p>(</span><span class=n>e</span><span class=p>);</span>
<a id=__codelineno-4-30 name=__codelineno-4-30></a><a href=#__codelineno-4-30><span class=linenos data-linenos="30 "></span></a>       <span class=k>return</span> <span class=n>e</span><span class=p>.</span><span class=na>value</span><span class=p>;</span>
<a id=__codelineno-4-31 name=__codelineno-4-31></a><a href=#__codelineno-4-31><span class=linenos data-linenos="31 "></span></a>    <span class=p>}</span>
<a id=__codelineno-4-32 name=__codelineno-4-32></a><a href=#__codelineno-4-32><span class=linenos data-linenos="32 "></span></a>
<a id=__codelineno-4-33 name=__codelineno-4-33></a><a href=#__codelineno-4-33><span class=linenos data-linenos="33 "></span></a>    <span class=kt>void</span> <span class=nf>afterNodeAccess</span><span class=p>(</span><span class=n>Node</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span> <span class=c1>// move node to last</span>
<a id=__codelineno-4-34 name=__codelineno-4-34></a><a href=#__codelineno-4-34><span class=linenos data-linenos="34 "></span></a>        <span class=n>LinkedHashMapEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=n>last</span><span class=p>;</span>
<a id=__codelineno-4-35 name=__codelineno-4-35></a><a href=#__codelineno-4-35><span class=linenos data-linenos="35 "></span></a>        <span class=k>if</span> <span class=p>(</span><span class=n>accessOrder</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>last</span> <span class=o>=</span> <span class=n>tail</span><span class=p>)</span> <span class=o>!=</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-4-36 name=__codelineno-4-36></a><a href=#__codelineno-4-36><span class=linenos data-linenos="36 "></span></a>            <span class=n>LinkedHashMapEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span> <span class=n>p</span> <span class=o>=</span>
<a id=__codelineno-4-37 name=__codelineno-4-37></a><a href=#__codelineno-4-37><span class=linenos data-linenos="37 "></span></a>                <span class=p>(</span><span class=n>LinkedHashMapEntry</span><span class=o>&lt;</span><span class=n>K</span><span class=p>,</span><span class=n>V</span><span class=o>&gt;</span><span class=p>)</span><span class=n>e</span><span class=p>,</span> <span class=n>b</span> <span class=o>=</span> <span class=n>p</span><span class=p>.</span><span class=na>before</span><span class=p>,</span> <span class=n>a</span> <span class=o>=</span> <span class=n>p</span><span class=p>.</span><span class=na>after</span><span class=p>;</span>
<a id=__codelineno-4-38 name=__codelineno-4-38></a><a href=#__codelineno-4-38><span class=linenos data-linenos="38 "></span></a>            <span class=n>p</span><span class=p>.</span><span class=na>after</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-4-39 name=__codelineno-4-39></a><a href=#__codelineno-4-39><span class=linenos data-linenos="39 "></span></a>            <span class=k>if</span> <span class=p>(</span><span class=n>b</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span>
<a id=__codelineno-4-40 name=__codelineno-4-40></a><a href=#__codelineno-4-40><span class=linenos data-linenos="40 "></span></a>                <span class=n>head</span> <span class=o>=</span> <span class=n>a</span><span class=p>;</span>
<a id=__codelineno-4-41 name=__codelineno-4-41></a><a href=#__codelineno-4-41><span class=linenos data-linenos="41 "></span></a>            <span class=k>else</span>
<a id=__codelineno-4-42 name=__codelineno-4-42></a><a href=#__codelineno-4-42><span class=linenos data-linenos="42 "></span></a>                <span class=n>b</span><span class=p>.</span><span class=na>after</span> <span class=o>=</span> <span class=n>a</span><span class=p>;</span>
<a id=__codelineno-4-43 name=__codelineno-4-43></a><a href=#__codelineno-4-43><span class=linenos data-linenos="43 "></span></a>            <span class=k>if</span> <span class=p>(</span><span class=n>a</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span>
<a id=__codelineno-4-44 name=__codelineno-4-44></a><a href=#__codelineno-4-44><span class=linenos data-linenos="44 "></span></a>                <span class=n>a</span><span class=p>.</span><span class=na>before</span> <span class=o>=</span> <span class=n>b</span><span class=p>;</span>
<a id=__codelineno-4-45 name=__codelineno-4-45></a><a href=#__codelineno-4-45><span class=linenos data-linenos="45 "></span></a>            <span class=k>else</span>
<a id=__codelineno-4-46 name=__codelineno-4-46></a><a href=#__codelineno-4-46><span class=linenos data-linenos="46 "></span></a>                <span class=n>last</span> <span class=o>=</span> <span class=n>b</span><span class=p>;</span>
<a id=__codelineno-4-47 name=__codelineno-4-47></a><a href=#__codelineno-4-47><span class=linenos data-linenos="47 "></span></a>            <span class=k>if</span> <span class=p>(</span><span class=n>last</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span>
<a id=__codelineno-4-48 name=__codelineno-4-48></a><a href=#__codelineno-4-48><span class=linenos data-linenos="48 "></span></a>                <span class=n>head</span> <span class=o>=</span> <span class=n>p</span><span class=p>;</span>
<a id=__codelineno-4-49 name=__codelineno-4-49></a><a href=#__codelineno-4-49><span class=linenos data-linenos="49 "></span></a>            <span class=k>else</span> <span class=p>{</span>
<a id=__codelineno-4-50 name=__codelineno-4-50></a><a href=#__codelineno-4-50><span class=linenos data-linenos="50 "></span></a>                <span class=n>p</span><span class=p>.</span><span class=na>before</span> <span class=o>=</span> <span class=n>last</span><span class=p>;</span>
<a id=__codelineno-4-51 name=__codelineno-4-51></a><a href=#__codelineno-4-51><span class=linenos data-linenos="51 "></span></a>                <span class=n>last</span><span class=p>.</span><span class=na>after</span> <span class=o>=</span> <span class=n>p</span><span class=p>;</span>
<a id=__codelineno-4-52 name=__codelineno-4-52></a><a href=#__codelineno-4-52><span class=linenos data-linenos="52 "></span></a>            <span class=p>}</span>
<a id=__codelineno-4-53 name=__codelineno-4-53></a><a href=#__codelineno-4-53><span class=linenos data-linenos="53 "></span></a>            <span class=n>tail</span> <span class=o>=</span> <span class=n>p</span><span class=p>;</span>
<a id=__codelineno-4-54 name=__codelineno-4-54></a><a href=#__codelineno-4-54><span class=linenos data-linenos="54 "></span></a>            <span class=o>++</span><span class=n>modCount</span><span class=p>;</span>
<a id=__codelineno-4-55 name=__codelineno-4-55></a><a href=#__codelineno-4-55><span class=linenos data-linenos="55 "></span></a>        <span class=p>}</span>
<a id=__codelineno-4-56 name=__codelineno-4-56></a><a href=#__codelineno-4-56><span class=linenos data-linenos="56 "></span></a>    <span class=p>}</span>
<a id=__codelineno-4-57 name=__codelineno-4-57></a><a href=#__codelineno-4-57><span class=linenos data-linenos="57 "></span></a><span class=p>}</span>
</code></pre></div> <h2 id=3-diskcachefactory>3. diskCacheFactoryä»‹ç»<a class=headerlink href=#3-diskcachefactory title="Anchor link to this section for reference">&para;</a></h2> <p>diskCacheFactoryé¡¾åæ€ä¹‰å°±æ˜¯åˆ›å»ºDiskCacheçš„Factoryï¼Œè¯¥æ¥å£çš„å®šä¹‰å¦‚ä¸‹ï¼š</p> <p><strong>DiskCache.java</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-5-1 name=__codelineno-5-1></a><a href=#__codelineno-5-1><span class=linenos data-linenos=" 1 "></span></a><span class=kd>public</span> <span class=kd>interface</span> <span class=nc>DiskCache</span> <span class=p>{</span>
<a id=__codelineno-5-2 name=__codelineno-5-2></a><a href=#__codelineno-5-2><span class=linenos data-linenos=" 2 "></span></a>
<a id=__codelineno-5-3 name=__codelineno-5-3></a><a href=#__codelineno-5-3><span class=linenos data-linenos=" 3 "></span></a>  <span class=kd>interface</span> <span class=nc>Factory</span> <span class=p>{</span>
<a id=__codelineno-5-4 name=__codelineno-5-4></a><a href=#__codelineno-5-4><span class=linenos data-linenos=" 4 "></span></a>    <span class=cm>/** 250 MB of cache. */</span>
<a id=__codelineno-5-5 name=__codelineno-5-5></a><a href=#__codelineno-5-5><span class=linenos data-linenos=" 5 "></span></a>    <span class=kt>int</span> <span class=n>DEFAULT_DISK_CACHE_SIZE</span> <span class=o>=</span> <span class=mi>250</span> <span class=o>*</span> <span class=mi>1024</span> <span class=o>*</span> <span class=mi>1024</span><span class=p>;</span>
<a id=__codelineno-5-6 name=__codelineno-5-6></a><a href=#__codelineno-5-6><span class=linenos data-linenos=" 6 "></span></a>    <span class=n>String</span> <span class=n>DEFAULT_DISK_CACHE_DIR</span> <span class=o>=</span> <span class=s>&quot;image_manager_disk_cache&quot;</span><span class=p>;</span>
<a id=__codelineno-5-7 name=__codelineno-5-7></a><a href=#__codelineno-5-7><span class=linenos data-linenos=" 7 "></span></a>
<a id=__codelineno-5-8 name=__codelineno-5-8></a><a href=#__codelineno-5-8><span class=linenos data-linenos=" 8 "></span></a>    <span class=n>DiskCache</span> <span class=nf>build</span><span class=p>();</span>
<a id=__codelineno-5-9 name=__codelineno-5-9></a><a href=#__codelineno-5-9><span class=linenos data-linenos=" 9 "></span></a>  <span class=p>}</span>
<a id=__codelineno-5-10 name=__codelineno-5-10></a><a href=#__codelineno-5-10><span class=linenos data-linenos="10 "></span></a>
<a id=__codelineno-5-11 name=__codelineno-5-11></a><a href=#__codelineno-5-11><span class=linenos data-linenos="11 "></span></a>  <span class=kd>interface</span> <span class=nc>Writer</span> <span class=p>{</span>
<a id=__codelineno-5-12 name=__codelineno-5-12></a><a href=#__codelineno-5-12><span class=linenos data-linenos="12 "></span></a>    <span class=kt>boolean</span> <span class=nf>write</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>File</span> <span class=n>file</span><span class=p>);</span>
<a id=__codelineno-5-13 name=__codelineno-5-13></a><a href=#__codelineno-5-13><span class=linenos data-linenos="13 "></span></a>  <span class=p>}</span>
<a id=__codelineno-5-14 name=__codelineno-5-14></a><a href=#__codelineno-5-14><span class=linenos data-linenos="14 "></span></a>
<a id=__codelineno-5-15 name=__codelineno-5-15></a><a href=#__codelineno-5-15><span class=linenos data-linenos="15 "></span></a>  <span class=n>File</span> <span class=nf>get</span><span class=p>(</span><span class=n>Key</span> <span class=n>key</span><span class=p>);</span>
<a id=__codelineno-5-16 name=__codelineno-5-16></a><a href=#__codelineno-5-16><span class=linenos data-linenos="16 "></span></a>
<a id=__codelineno-5-17 name=__codelineno-5-17></a><a href=#__codelineno-5-17><span class=linenos data-linenos="17 "></span></a>  <span class=kt>void</span> <span class=nf>put</span><span class=p>(</span><span class=n>Key</span> <span class=n>key</span><span class=p>,</span> <span class=n>Writer</span> <span class=n>writer</span><span class=p>);</span>
<a id=__codelineno-5-18 name=__codelineno-5-18></a><a href=#__codelineno-5-18><span class=linenos data-linenos="18 "></span></a>
<a id=__codelineno-5-19 name=__codelineno-5-19></a><a href=#__codelineno-5-19><span class=linenos data-linenos="19 "></span></a>  <span class=kt>void</span> <span class=nf>delete</span><span class=p>(</span><span class=n>Key</span> <span class=n>key</span><span class=p>);</span>
<a id=__codelineno-5-20 name=__codelineno-5-20></a><a href=#__codelineno-5-20><span class=linenos data-linenos="20 "></span></a>
<a id=__codelineno-5-21 name=__codelineno-5-21></a><a href=#__codelineno-5-21><span class=linenos data-linenos="21 "></span></a>  <span class=kt>void</span> <span class=nf>clear</span><span class=p>();</span>
<a id=__codelineno-5-22 name=__codelineno-5-22></a><a href=#__codelineno-5-22><span class=linenos data-linenos="22 "></span></a><span class=p>}</span>
</code></pre></div> <p>å¯ä»¥çœ‹å‡º<code>DiskCache.Factory</code>çš„<code>build()</code>æ–¹æ³•ä¼šåˆ›å»ºå‡ºä¸€ä¸ªæˆ‘ä»¬éœ€è¦çš„<code>DiskCache</code>ã€‚<br> æ‰€ä»¥ï¼Œæˆ‘ä»¬è·Ÿç€Glideé»˜è®¤å®ç°çš„<code>InternalCacheDiskCacheFactory</code>ç±»çœ‹ä¸€ä¸‹åˆ›å»ºå‡ºäº†ä»€ä¹ˆæ ·çš„<code>DiskCache</code>ï¼š</p> <p><strong>InternalCacheDiskCacheFactory.java</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-6-1 name=__codelineno-6-1></a><a href=#__codelineno-6-1><span class=linenos data-linenos=" 1 "></span></a><span class=kd>public</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>InternalCacheDiskCacheFactory</span> <span class=kd>extends</span> <span class=n>DiskLruCacheFactory</span> <span class=p>{</span>
<a id=__codelineno-6-2 name=__codelineno-6-2></a><a href=#__codelineno-6-2><span class=linenos data-linenos=" 2 "></span></a>
<a id=__codelineno-6-3 name=__codelineno-6-3></a><a href=#__codelineno-6-3><span class=linenos data-linenos=" 3 "></span></a>  <span class=kd>public</span> <span class=nf>InternalCacheDiskCacheFactory</span><span class=p>(</span><span class=n>Context</span> <span class=n>context</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-6-4 name=__codelineno-6-4></a><a href=#__codelineno-6-4><span class=linenos data-linenos=" 4 "></span></a>    <span class=k>this</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>DiskCache</span><span class=p>.</span><span class=na>Factory</span><span class=p>.</span><span class=na>DEFAULT_DISK_CACHE_DIR</span><span class=p>,</span>
<a id=__codelineno-6-5 name=__codelineno-6-5></a><a href=#__codelineno-6-5><span class=linenos data-linenos=" 5 "></span></a>        <span class=n>DiskCache</span><span class=p>.</span><span class=na>Factory</span><span class=p>.</span><span class=na>DEFAULT_DISK_CACHE_SIZE</span><span class=p>);</span>
<a id=__codelineno-6-6 name=__codelineno-6-6></a><a href=#__codelineno-6-6><span class=linenos data-linenos=" 6 "></span></a>  <span class=p>}</span>
<a id=__codelineno-6-7 name=__codelineno-6-7></a><a href=#__codelineno-6-7><span class=linenos data-linenos=" 7 "></span></a>
<a id=__codelineno-6-8 name=__codelineno-6-8></a><a href=#__codelineno-6-8><span class=linenos data-linenos=" 8 "></span></a>  <span class=kd>public</span> <span class=nf>InternalCacheDiskCacheFactory</span><span class=p>(</span><span class=n>Context</span> <span class=n>context</span><span class=p>,</span> <span class=kt>long</span> <span class=n>diskCacheSize</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-6-9 name=__codelineno-6-9></a><a href=#__codelineno-6-9><span class=linenos data-linenos=" 9 "></span></a>    <span class=k>this</span><span class=p>(</span><span class=n>context</span><span class=p>,</span> <span class=n>DiskCache</span><span class=p>.</span><span class=na>Factory</span><span class=p>.</span><span class=na>DEFAULT_DISK_CACHE_DIR</span><span class=p>,</span> <span class=n>diskCacheSize</span><span class=p>);</span>
<a id=__codelineno-6-10 name=__codelineno-6-10></a><a href=#__codelineno-6-10><span class=linenos data-linenos="10 "></span></a>  <span class=p>}</span>
<a id=__codelineno-6-11 name=__codelineno-6-11></a><a href=#__codelineno-6-11><span class=linenos data-linenos="11 "></span></a>
<a id=__codelineno-6-12 name=__codelineno-6-12></a><a href=#__codelineno-6-12><span class=linenos data-linenos="12 "></span></a>  <span class=kd>public</span> <span class=nf>InternalCacheDiskCacheFactory</span><span class=p>(</span><span class=kd>final</span> <span class=n>Context</span> <span class=n>context</span><span class=p>,</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>diskCacheName</span><span class=p>,</span>
<a id=__codelineno-6-13 name=__codelineno-6-13></a><a href=#__codelineno-6-13><span class=linenos data-linenos="13 "></span></a>                                       <span class=kt>long</span> <span class=n>diskCacheSize</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-6-14 name=__codelineno-6-14></a><a href=#__codelineno-6-14><span class=linenos data-linenos="14 "></span></a>    <span class=kd>super</span><span class=p>(</span><span class=k>new</span> <span class=n>CacheDirectoryGetter</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-6-15 name=__codelineno-6-15></a><a href=#__codelineno-6-15><span class=linenos data-linenos="15 "></span></a>      <span class=nd>@Override</span>
<a id=__codelineno-6-16 name=__codelineno-6-16></a><a href=#__codelineno-6-16><span class=linenos data-linenos="16 "></span></a>      <span class=kd>public</span> <span class=n>File</span> <span class=nf>getCacheDirectory</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-6-17 name=__codelineno-6-17></a><a href=#__codelineno-6-17><span class=linenos data-linenos="17 "></span></a>        <span class=n>File</span> <span class=n>cacheDirectory</span> <span class=o>=</span> <span class=n>context</span><span class=p>.</span><span class=na>getCacheDir</span><span class=p>();</span>
<a id=__codelineno-6-18 name=__codelineno-6-18></a><a href=#__codelineno-6-18><span class=linenos data-linenos="18 "></span></a>        <span class=k>if</span> <span class=p>(</span><span class=n>cacheDirectory</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-6-19 name=__codelineno-6-19></a><a href=#__codelineno-6-19><span class=linenos data-linenos="19 "></span></a>          <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-6-20 name=__codelineno-6-20></a><a href=#__codelineno-6-20><span class=linenos data-linenos="20 "></span></a>        <span class=p>}</span>
<a id=__codelineno-6-21 name=__codelineno-6-21></a><a href=#__codelineno-6-21><span class=linenos data-linenos="21 "></span></a>        <span class=k>if</span> <span class=p>(</span><span class=n>diskCacheName</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-6-22 name=__codelineno-6-22></a><a href=#__codelineno-6-22><span class=linenos data-linenos="22 "></span></a>          <span class=k>return</span> <span class=k>new</span> <span class=n>File</span><span class=p>(</span><span class=n>cacheDirectory</span><span class=p>,</span> <span class=n>diskCacheName</span><span class=p>);</span>
<a id=__codelineno-6-23 name=__codelineno-6-23></a><a href=#__codelineno-6-23><span class=linenos data-linenos="23 "></span></a>        <span class=p>}</span>
<a id=__codelineno-6-24 name=__codelineno-6-24></a><a href=#__codelineno-6-24><span class=linenos data-linenos="24 "></span></a>        <span class=k>return</span> <span class=n>cacheDirectory</span><span class=p>;</span>
<a id=__codelineno-6-25 name=__codelineno-6-25></a><a href=#__codelineno-6-25><span class=linenos data-linenos="25 "></span></a>      <span class=p>}</span>
<a id=__codelineno-6-26 name=__codelineno-6-26></a><a href=#__codelineno-6-26><span class=linenos data-linenos="26 "></span></a>    <span class=p>},</span> <span class=n>diskCacheSize</span><span class=p>);</span>
<a id=__codelineno-6-27 name=__codelineno-6-27></a><a href=#__codelineno-6-27><span class=linenos data-linenos="27 "></span></a>  <span class=p>}</span>
<a id=__codelineno-6-28 name=__codelineno-6-28></a><a href=#__codelineno-6-28><span class=linenos data-linenos="28 "></span></a><span class=p>}</span>
</code></pre></div> <p>æ˜¾ç„¶ï¼Œæ ¹æ®ä¸Šé¢æ¥å£ä¸­çš„å®šä¹‰ä»¥åŠæ­¤å¤„ç¬¬ä¸‰ä¸ªæ„é€ å™¨ä¸­çš„ä»£ç å¯ä»¥çœ‹å‡ºï¼Œé»˜è®¤ä¼šåˆ›å»ºä¸€ä¸ªä½äº250Må¤§å°çš„è·¯å¾„ä¸º<code>/data/data/{package}/cache/image_manager_disk_cache/</code>çš„ç¼“å­˜ç›®å½•ã€‚</p> <p>ä¸‹é¢æ¥ç€<code>InternalCacheDiskCacheFactory</code>çš„çˆ¶ç±»<code>DiskLruCacheFactory</code>çš„ç›¸å…³ä»£ç ï¼š</p> <p><strong>DiskLruCacheFactory.java</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-7-1 name=__codelineno-7-1></a><a href=#__codelineno-7-1><span class=linenos data-linenos=" 1 "></span></a><span class=kd>public</span> <span class=kd>class</span> <span class=nc>DiskLruCacheFactory</span> <span class=kd>implements</span> <span class=n>DiskCache</span><span class=p>.</span><span class=na>Factory</span> <span class=p>{</span>
<a id=__codelineno-7-2 name=__codelineno-7-2></a><a href=#__codelineno-7-2><span class=linenos data-linenos=" 2 "></span></a>  <span class=kd>private</span> <span class=kd>final</span> <span class=kt>long</span> <span class=n>diskCacheSize</span><span class=p>;</span>
<a id=__codelineno-7-3 name=__codelineno-7-3></a><a href=#__codelineno-7-3><span class=linenos data-linenos=" 3 "></span></a>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>CacheDirectoryGetter</span> <span class=n>cacheDirectoryGetter</span><span class=p>;</span>
<a id=__codelineno-7-4 name=__codelineno-7-4></a><a href=#__codelineno-7-4><span class=linenos data-linenos=" 4 "></span></a>
<a id=__codelineno-7-5 name=__codelineno-7-5></a><a href=#__codelineno-7-5><span class=linenos data-linenos=" 5 "></span></a>  <span class=cm>/**</span>
<a id=__codelineno-7-6 name=__codelineno-7-6></a><a href=#__codelineno-7-6><span class=linenos data-linenos=" 6 "></span></a><span class=cm>   * Interface called out of UI thread to get the cache folder.</span>
<a id=__codelineno-7-7 name=__codelineno-7-7></a><a href=#__codelineno-7-7><span class=linenos data-linenos=" 7 "></span></a><span class=cm>   */</span>
<a id=__codelineno-7-8 name=__codelineno-7-8></a><a href=#__codelineno-7-8><span class=linenos data-linenos=" 8 "></span></a>  <span class=kd>public</span> <span class=kd>interface</span> <span class=nc>CacheDirectoryGetter</span> <span class=p>{</span>
<a id=__codelineno-7-9 name=__codelineno-7-9></a><a href=#__codelineno-7-9><span class=linenos data-linenos=" 9 "></span></a>    <span class=n>File</span> <span class=nf>getCacheDirectory</span><span class=p>();</span>
<a id=__codelineno-7-10 name=__codelineno-7-10></a><a href=#__codelineno-7-10><span class=linenos data-linenos="10 "></span></a>  <span class=p>}</span>
<a id=__codelineno-7-11 name=__codelineno-7-11></a><a href=#__codelineno-7-11><span class=linenos data-linenos="11 "></span></a>  <span class=p>...</span>
<a id=__codelineno-7-12 name=__codelineno-7-12></a><a href=#__codelineno-7-12><span class=linenos data-linenos="12 "></span></a>  <span class=kd>public</span> <span class=nf>DiskLruCacheFactory</span><span class=p>(</span><span class=n>CacheDirectoryGetter</span> <span class=n>cacheDirectoryGetter</span><span class=p>,</span> <span class=kt>long</span> <span class=n>diskCacheSize</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-7-13 name=__codelineno-7-13></a><a href=#__codelineno-7-13><span class=linenos data-linenos="13 "></span></a>    <span class=k>this</span><span class=p>.</span><span class=na>diskCacheSize</span> <span class=o>=</span> <span class=n>diskCacheSize</span><span class=p>;</span>
<a id=__codelineno-7-14 name=__codelineno-7-14></a><a href=#__codelineno-7-14><span class=linenos data-linenos="14 "></span></a>    <span class=k>this</span><span class=p>.</span><span class=na>cacheDirectoryGetter</span> <span class=o>=</span> <span class=n>cacheDirectoryGetter</span><span class=p>;</span>
<a id=__codelineno-7-15 name=__codelineno-7-15></a><a href=#__codelineno-7-15><span class=linenos data-linenos="15 "></span></a>  <span class=p>}</span>
<a id=__codelineno-7-16 name=__codelineno-7-16></a><a href=#__codelineno-7-16><span class=linenos data-linenos="16 "></span></a>
<a id=__codelineno-7-17 name=__codelineno-7-17></a><a href=#__codelineno-7-17><span class=linenos data-linenos="17 "></span></a>  <span class=nd>@Override</span>
<a id=__codelineno-7-18 name=__codelineno-7-18></a><a href=#__codelineno-7-18><span class=linenos data-linenos="18 "></span></a>  <span class=kd>public</span> <span class=n>DiskCache</span> <span class=nf>build</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-7-19 name=__codelineno-7-19></a><a href=#__codelineno-7-19><span class=linenos data-linenos="19 "></span></a>    <span class=n>File</span> <span class=n>cacheDir</span> <span class=o>=</span> <span class=n>cacheDirectoryGetter</span><span class=p>.</span><span class=na>getCacheDirectory</span><span class=p>();</span>
<a id=__codelineno-7-20 name=__codelineno-7-20></a><a href=#__codelineno-7-20><span class=linenos data-linenos="20 "></span></a>
<a id=__codelineno-7-21 name=__codelineno-7-21></a><a href=#__codelineno-7-21><span class=linenos data-linenos="21 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>cacheDir</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-7-22 name=__codelineno-7-22></a><a href=#__codelineno-7-22><span class=linenos data-linenos="22 "></span></a>      <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-7-23 name=__codelineno-7-23></a><a href=#__codelineno-7-23><span class=linenos data-linenos="23 "></span></a>    <span class=p>}</span>
<a id=__codelineno-7-24 name=__codelineno-7-24></a><a href=#__codelineno-7-24><span class=linenos data-linenos="24 "></span></a>
<a id=__codelineno-7-25 name=__codelineno-7-25></a><a href=#__codelineno-7-25><span class=linenos data-linenos="25 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>cacheDir</span><span class=p>.</span><span class=na>mkdirs</span><span class=p>()</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=o>!</span><span class=n>cacheDir</span><span class=p>.</span><span class=na>exists</span><span class=p>()</span> <span class=o>||</span> <span class=o>!</span><span class=n>cacheDir</span><span class=p>.</span><span class=na>isDirectory</span><span class=p>()))</span> <span class=p>{</span>
<a id=__codelineno-7-26 name=__codelineno-7-26></a><a href=#__codelineno-7-26><span class=linenos data-linenos="26 "></span></a>      <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-7-27 name=__codelineno-7-27></a><a href=#__codelineno-7-27><span class=linenos data-linenos="27 "></span></a>    <span class=p>}</span>
<a id=__codelineno-7-28 name=__codelineno-7-28></a><a href=#__codelineno-7-28><span class=linenos data-linenos="28 "></span></a>
<a id=__codelineno-7-29 name=__codelineno-7-29></a><a href=#__codelineno-7-29><span class=linenos data-linenos="29 "></span></a>    <span class=k>return</span> <span class=n>DiskLruCacheWrapper</span><span class=p>.</span><span class=na>create</span><span class=p>(</span><span class=n>cacheDir</span><span class=p>,</span> <span class=n>diskCacheSize</span><span class=p>);</span>
<a id=__codelineno-7-30 name=__codelineno-7-30></a><a href=#__codelineno-7-30><span class=linenos data-linenos="30 "></span></a>  <span class=p>}</span>
<a id=__codelineno-7-31 name=__codelineno-7-31></a><a href=#__codelineno-7-31><span class=linenos data-linenos="31 "></span></a><span class=p>}</span>
</code></pre></div> <p><code>DiskLruCacheFactory.build()</code>æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ª<code>DiskLruCacheWrapper</code>ç±»çš„å®ä¾‹ï¼Œä»å‘½åæ¥çœ‹ç£ç›˜ç¼“å­˜ä¹Ÿç¡®å®æ˜¯LRUç®—æ³•çš„ã€‚æˆ‘ä»¬çœ¼è§ä¸ºå®ï¼š</p> <p><strong>DiskLruCacheWrapper.java</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-8-1 name=__codelineno-8-1></a><a href=#__codelineno-8-1><span class=linenos data-linenos=" 1 "></span></a><span class=kd>public</span> <span class=kd>class</span> <span class=nc>DiskLruCacheWrapper</span> <span class=kd>implements</span> <span class=n>DiskCache</span> <span class=p>{</span>
<a id=__codelineno-8-2 name=__codelineno-8-2></a><a href=#__codelineno-8-2><span class=linenos data-linenos=" 2 "></span></a>  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>TAG</span> <span class=o>=</span> <span class=s>&quot;DiskLruCacheWrapper&quot;</span><span class=p>;</span>
<a id=__codelineno-8-3 name=__codelineno-8-3></a><a href=#__codelineno-8-3><span class=linenos data-linenos=" 3 "></span></a>
<a id=__codelineno-8-4 name=__codelineno-8-4></a><a href=#__codelineno-8-4><span class=linenos data-linenos=" 4 "></span></a>  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>APP_VERSION</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
<a id=__codelineno-8-5 name=__codelineno-8-5></a><a href=#__codelineno-8-5><span class=linenos data-linenos=" 5 "></span></a>  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>int</span> <span class=n>VALUE_COUNT</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
<a id=__codelineno-8-6 name=__codelineno-8-6></a><a href=#__codelineno-8-6><span class=linenos data-linenos=" 6 "></span></a>  <span class=kd>private</span> <span class=kd>static</span> <span class=n>DiskLruCacheWrapper</span> <span class=n>wrapper</span><span class=p>;</span>
<a id=__codelineno-8-7 name=__codelineno-8-7></a><a href=#__codelineno-8-7><span class=linenos data-linenos=" 7 "></span></a>
<a id=__codelineno-8-8 name=__codelineno-8-8></a><a href=#__codelineno-8-8><span class=linenos data-linenos=" 8 "></span></a>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>SafeKeyGenerator</span> <span class=n>safeKeyGenerator</span><span class=p>;</span>
<a id=__codelineno-8-9 name=__codelineno-8-9></a><a href=#__codelineno-8-9><span class=linenos data-linenos=" 9 "></span></a>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>File</span> <span class=n>directory</span><span class=p>;</span>
<a id=__codelineno-8-10 name=__codelineno-8-10></a><a href=#__codelineno-8-10><span class=linenos data-linenos="10 "></span></a>  <span class=kd>private</span> <span class=kd>final</span> <span class=kt>long</span> <span class=n>maxSize</span><span class=p>;</span>
<a id=__codelineno-8-11 name=__codelineno-8-11></a><a href=#__codelineno-8-11><span class=linenos data-linenos="11 "></span></a>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>DiskCacheWriteLocker</span> <span class=n>writeLocker</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DiskCacheWriteLocker</span><span class=p>();</span>
<a id=__codelineno-8-12 name=__codelineno-8-12></a><a href=#__codelineno-8-12><span class=linenos data-linenos="12 "></span></a>  <span class=kd>private</span> <span class=n>DiskLruCache</span> <span class=n>diskLruCache</span><span class=p>;</span>
<a id=__codelineno-8-13 name=__codelineno-8-13></a><a href=#__codelineno-8-13><span class=linenos data-linenos="13 "></span></a>
<a id=__codelineno-8-14 name=__codelineno-8-14></a><a href=#__codelineno-8-14><span class=linenos data-linenos="14 "></span></a>  <span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;deprecation&quot;</span><span class=p>)</span>
<a id=__codelineno-8-15 name=__codelineno-8-15></a><a href=#__codelineno-8-15><span class=linenos data-linenos="15 "></span></a>  <span class=kd>public</span> <span class=kd>static</span> <span class=n>DiskCache</span> <span class=nf>create</span><span class=p>(</span><span class=n>File</span> <span class=n>directory</span><span class=p>,</span> <span class=kt>long</span> <span class=n>maxSize</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-8-16 name=__codelineno-8-16></a><a href=#__codelineno-8-16><span class=linenos data-linenos="16 "></span></a>    <span class=k>return</span> <span class=k>new</span> <span class=n>DiskLruCacheWrapper</span><span class=p>(</span><span class=n>directory</span><span class=p>,</span> <span class=n>maxSize</span><span class=p>);</span>
<a id=__codelineno-8-17 name=__codelineno-8-17></a><a href=#__codelineno-8-17><span class=linenos data-linenos="17 "></span></a>  <span class=p>}</span>
<a id=__codelineno-8-18 name=__codelineno-8-18></a><a href=#__codelineno-8-18><span class=linenos data-linenos="18 "></span></a>
<a id=__codelineno-8-19 name=__codelineno-8-19></a><a href=#__codelineno-8-19><span class=linenos data-linenos="19 "></span></a>  <span class=nd>@Deprecated</span>
<a id=__codelineno-8-20 name=__codelineno-8-20></a><a href=#__codelineno-8-20><span class=linenos data-linenos="20 "></span></a>  <span class=nd>@SuppressWarnings</span><span class=p>({</span><span class=s>&quot;WeakerAccess&quot;</span><span class=p>,</span> <span class=s>&quot;DeprecatedIsStillUsed&quot;</span><span class=p>})</span>
<a id=__codelineno-8-21 name=__codelineno-8-21></a><a href=#__codelineno-8-21><span class=linenos data-linenos="21 "></span></a>  <span class=kd>protected</span> <span class=nf>DiskLruCacheWrapper</span><span class=p>(</span><span class=n>File</span> <span class=n>directory</span><span class=p>,</span> <span class=kt>long</span> <span class=n>maxSize</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-8-22 name=__codelineno-8-22></a><a href=#__codelineno-8-22><span class=linenos data-linenos="22 "></span></a>    <span class=k>this</span><span class=p>.</span><span class=na>directory</span> <span class=o>=</span> <span class=n>directory</span><span class=p>;</span>
<a id=__codelineno-8-23 name=__codelineno-8-23></a><a href=#__codelineno-8-23><span class=linenos data-linenos="23 "></span></a>    <span class=k>this</span><span class=p>.</span><span class=na>maxSize</span> <span class=o>=</span> <span class=n>maxSize</span><span class=p>;</span>
<a id=__codelineno-8-24 name=__codelineno-8-24></a><a href=#__codelineno-8-24><span class=linenos data-linenos="24 "></span></a>    <span class=k>this</span><span class=p>.</span><span class=na>safeKeyGenerator</span> <span class=o>=</span> <span class=k>new</span> <span class=n>SafeKeyGenerator</span><span class=p>();</span>
<a id=__codelineno-8-25 name=__codelineno-8-25></a><a href=#__codelineno-8-25><span class=linenos data-linenos="25 "></span></a>  <span class=p>}</span>
<a id=__codelineno-8-26 name=__codelineno-8-26></a><a href=#__codelineno-8-26><span class=linenos data-linenos="26 "></span></a>
<a id=__codelineno-8-27 name=__codelineno-8-27></a><a href=#__codelineno-8-27><span class=linenos data-linenos="27 "></span></a>  <span class=kd>private</span> <span class=kd>synchronized</span> <span class=n>DiskLruCache</span> <span class=nf>getDiskCache</span><span class=p>()</span> <span class=kd>throws</span> <span class=n>IOException</span> <span class=p>{</span>
<a id=__codelineno-8-28 name=__codelineno-8-28></a><a href=#__codelineno-8-28><span class=linenos data-linenos="28 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>diskLruCache</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-8-29 name=__codelineno-8-29></a><a href=#__codelineno-8-29><span class=linenos data-linenos="29 "></span></a>      <span class=n>diskLruCache</span> <span class=o>=</span> <span class=n>DiskLruCache</span><span class=p>.</span><span class=na>open</span><span class=p>(</span><span class=n>directory</span><span class=p>,</span> <span class=n>APP_VERSION</span><span class=p>,</span> <span class=n>VALUE_COUNT</span><span class=p>,</span> <span class=n>maxSize</span><span class=p>);</span>
<a id=__codelineno-8-30 name=__codelineno-8-30></a><a href=#__codelineno-8-30><span class=linenos data-linenos="30 "></span></a>    <span class=p>}</span>
<a id=__codelineno-8-31 name=__codelineno-8-31></a><a href=#__codelineno-8-31><span class=linenos data-linenos="31 "></span></a>    <span class=k>return</span> <span class=n>diskLruCache</span><span class=p>;</span>
<a id=__codelineno-8-32 name=__codelineno-8-32></a><a href=#__codelineno-8-32><span class=linenos data-linenos="32 "></span></a>  <span class=p>}</span>
<a id=__codelineno-8-33 name=__codelineno-8-33></a><a href=#__codelineno-8-33><span class=linenos data-linenos="33 "></span></a>
<a id=__codelineno-8-34 name=__codelineno-8-34></a><a href=#__codelineno-8-34><span class=linenos data-linenos="34 "></span></a>  <span class=nd>@Override</span>
<a id=__codelineno-8-35 name=__codelineno-8-35></a><a href=#__codelineno-8-35><span class=linenos data-linenos="35 "></span></a>  <span class=kd>public</span> <span class=n>File</span> <span class=nf>get</span><span class=p>(</span><span class=n>Key</span> <span class=n>key</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-8-36 name=__codelineno-8-36></a><a href=#__codelineno-8-36><span class=linenos data-linenos="36 "></span></a>    <span class=n>String</span> <span class=n>safeKey</span> <span class=o>=</span> <span class=n>safeKeyGenerator</span><span class=p>.</span><span class=na>getSafeKey</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
<a id=__codelineno-8-37 name=__codelineno-8-37></a><a href=#__codelineno-8-37><span class=linenos data-linenos="37 "></span></a>    <span class=n>File</span> <span class=n>result</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-8-38 name=__codelineno-8-38></a><a href=#__codelineno-8-38><span class=linenos data-linenos="38 "></span></a>    <span class=k>try</span> <span class=p>{</span>
<a id=__codelineno-8-39 name=__codelineno-8-39></a><a href=#__codelineno-8-39><span class=linenos data-linenos="39 "></span></a>      <span class=kd>final</span> <span class=n>DiskLruCache</span><span class=p>.</span><span class=na>Value</span> <span class=n>value</span> <span class=o>=</span> <span class=n>getDiskCache</span><span class=p>().</span><span class=na>get</span><span class=p>(</span><span class=n>safeKey</span><span class=p>);</span>
<a id=__codelineno-8-40 name=__codelineno-8-40></a><a href=#__codelineno-8-40><span class=linenos data-linenos="40 "></span></a>      <span class=k>if</span> <span class=p>(</span><span class=n>value</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-8-41 name=__codelineno-8-41></a><a href=#__codelineno-8-41><span class=linenos data-linenos="41 "></span></a>        <span class=n>result</span> <span class=o>=</span> <span class=n>value</span><span class=p>.</span><span class=na>getFile</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
<a id=__codelineno-8-42 name=__codelineno-8-42></a><a href=#__codelineno-8-42><span class=linenos data-linenos="42 "></span></a>      <span class=p>}</span>
<a id=__codelineno-8-43 name=__codelineno-8-43></a><a href=#__codelineno-8-43><span class=linenos data-linenos="43 "></span></a>    <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>IOException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-8-44 name=__codelineno-8-44></a><a href=#__codelineno-8-44><span class=linenos data-linenos="44 "></span></a>      <span class=p>...</span>
<a id=__codelineno-8-45 name=__codelineno-8-45></a><a href=#__codelineno-8-45><span class=linenos data-linenos="45 "></span></a>    <span class=p>}</span>
<a id=__codelineno-8-46 name=__codelineno-8-46></a><a href=#__codelineno-8-46><span class=linenos data-linenos="46 "></span></a>    <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
<a id=__codelineno-8-47 name=__codelineno-8-47></a><a href=#__codelineno-8-47><span class=linenos data-linenos="47 "></span></a>  <span class=p>}</span>
<a id=__codelineno-8-48 name=__codelineno-8-48></a><a href=#__codelineno-8-48><span class=linenos data-linenos="48 "></span></a>  <span class=p>...</span>
<a id=__codelineno-8-49 name=__codelineno-8-49></a><a href=#__codelineno-8-49><span class=linenos data-linenos="49 "></span></a><span class=p>}</span>
</code></pre></div> <p>é‡Œé¢æœç„¶wrapäº†ä¸€ä¸ª<code>DiskLruCache</code>ï¼Œè¯¥ç±»ä¸»è¦æ˜¯ä¸º<code>DiskLruCache</code>æä¾›äº†ä¸€ä¸ªæ ¹æ®<code>Key</code>ç”Ÿæˆkeyçš„<code>SafeKeyGenerator</code>ä»¥åŠå†™é”<code>DiskCacheWriteLocker</code>ã€‚ </p> <p>!!!! warning <strong>æ³¨æ„</strong>ï¼šGlideä¸­ä½¿ç”¨çš„LruCacheä¸<a href=/android/framework/Bitmap%E7%9A%84%E7%BC%93%E5%AD%98%E4%B8%8E%E5%8A%A0%E8%BD%BD/#21-lrucache>Bitmapçš„ç¼“å­˜ä¸åŠ è½½</a>ä¸€æ–‡ä¸­æåˆ°çš„ä¸ä¸€æ ·ï¼›Glideä½¿ç”¨çš„DiskLruCacheè™½ç„¶ä¸æ–‡ç« ä¸­æåˆ°çš„DiskLruCacheæœ‰ä¸€å®šçš„æ¸Šæºï¼Œä½†ä¸ç­‰åŒã€‚</p> <p>OKï¼Œç°åœ¨DiskCacheçš„å®ç°éƒ½å‡†å¤‡å¥½äº†ï¼Œç°åœ¨çœ‹çœ‹ä¼šåœ¨å“ªé‡Œè°ƒç”¨factoryçš„<code>build()</code>æ–¹æ³•äº†ã€‚<br> åœ¨æœ¬æ–‡çš„å¼€å¤´ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†<code>diskCacheFactory</code>åªä¼šä¼ å…¥<code>Engine</code>ä¸­ã€‚åœ¨<code>Engine</code>çš„æ„é€ æ–¹æ³•ä¸­ä¼šè¢«åŒ…è£…æˆä¸ºä¸€ä¸ª<code>LazyDiskCacheProvider</code>ï¼Œåœ¨è¢«éœ€è¦çš„æ—¶å€™è°ƒç”¨<code>getDiskCache()</code>æ–¹æ³•ï¼Œè¿™æ ·å°±ä¼šè°ƒç”¨factoryçš„<code>build()</code>æ–¹æ³•è¿”å›ä¸€ä¸ª<code>DiskCache</code>äº†ã€‚</p> <p><strong>Engine.LazyDiskCacheProvider</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-9-1 name=__codelineno-9-1></a><a href=#__codelineno-9-1><span class=linenos data-linenos=" 1 "></span></a><span class=kd>private</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>LazyDiskCacheProvider</span> <span class=kd>implements</span> <span class=n>DecodeJob</span><span class=p>.</span><span class=na>DiskCacheProvider</span> <span class=p>{</span>
<a id=__codelineno-9-2 name=__codelineno-9-2></a><a href=#__codelineno-9-2><span class=linenos data-linenos=" 2 "></span></a>
<a id=__codelineno-9-3 name=__codelineno-9-3></a><a href=#__codelineno-9-3><span class=linenos data-linenos=" 3 "></span></a>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>DiskCache</span><span class=p>.</span><span class=na>Factory</span> <span class=n>factory</span><span class=p>;</span>
<a id=__codelineno-9-4 name=__codelineno-9-4></a><a href=#__codelineno-9-4><span class=linenos data-linenos=" 4 "></span></a>  <span class=kd>private</span> <span class=kd>volatile</span> <span class=n>DiskCache</span> <span class=n>diskCache</span><span class=p>;</span>
<a id=__codelineno-9-5 name=__codelineno-9-5></a><a href=#__codelineno-9-5><span class=linenos data-linenos=" 5 "></span></a>
<a id=__codelineno-9-6 name=__codelineno-9-6></a><a href=#__codelineno-9-6><span class=linenos data-linenos=" 6 "></span></a>  <span class=n>LazyDiskCacheProvider</span><span class=p>(</span><span class=n>DiskCache</span><span class=p>.</span><span class=na>Factory</span> <span class=n>factory</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-9-7 name=__codelineno-9-7></a><a href=#__codelineno-9-7><span class=linenos data-linenos=" 7 "></span></a>    <span class=k>this</span><span class=p>.</span><span class=na>factory</span> <span class=o>=</span> <span class=n>factory</span><span class=p>;</span>
<a id=__codelineno-9-8 name=__codelineno-9-8></a><a href=#__codelineno-9-8><span class=linenos data-linenos=" 8 "></span></a>  <span class=p>}</span>
<a id=__codelineno-9-9 name=__codelineno-9-9></a><a href=#__codelineno-9-9><span class=linenos data-linenos=" 9 "></span></a>  <span class=p>...</span>
<a id=__codelineno-9-10 name=__codelineno-9-10></a><a href=#__codelineno-9-10><span class=linenos data-linenos="10 "></span></a>  <span class=nd>@Override</span>
<a id=__codelineno-9-11 name=__codelineno-9-11></a><a href=#__codelineno-9-11><span class=linenos data-linenos="11 "></span></a>  <span class=kd>public</span> <span class=n>DiskCache</span> <span class=nf>getDiskCache</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-9-12 name=__codelineno-9-12></a><a href=#__codelineno-9-12><span class=linenos data-linenos="12 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>diskCache</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-9-13 name=__codelineno-9-13></a><a href=#__codelineno-9-13><span class=linenos data-linenos="13 "></span></a>      <span class=kd>synchronized</span> <span class=p>(</span><span class=k>this</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-9-14 name=__codelineno-9-14></a><a href=#__codelineno-9-14><span class=linenos data-linenos="14 "></span></a>        <span class=k>if</span> <span class=p>(</span><span class=n>diskCache</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-9-15 name=__codelineno-9-15></a><a href=#__codelineno-9-15><span class=linenos data-linenos="15 "></span></a>          <span class=n>diskCache</span> <span class=o>=</span> <span class=n>factory</span><span class=p>.</span><span class=na>build</span><span class=p>();</span>
<a id=__codelineno-9-16 name=__codelineno-9-16></a><a href=#__codelineno-9-16><span class=linenos data-linenos="16 "></span></a>        <span class=p>}</span>
<a id=__codelineno-9-17 name=__codelineno-9-17></a><a href=#__codelineno-9-17><span class=linenos data-linenos="17 "></span></a>        <span class=k>if</span> <span class=p>(</span><span class=n>diskCache</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-9-18 name=__codelineno-9-18></a><a href=#__codelineno-9-18><span class=linenos data-linenos="18 "></span></a>          <span class=n>diskCache</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DiskCacheAdapter</span><span class=p>();</span>
<a id=__codelineno-9-19 name=__codelineno-9-19></a><a href=#__codelineno-9-19><span class=linenos data-linenos="19 "></span></a>        <span class=p>}</span>
<a id=__codelineno-9-20 name=__codelineno-9-20></a><a href=#__codelineno-9-20><span class=linenos data-linenos="20 "></span></a>      <span class=p>}</span>
<a id=__codelineno-9-21 name=__codelineno-9-21></a><a href=#__codelineno-9-21><span class=linenos data-linenos="21 "></span></a>    <span class=p>}</span>
<a id=__codelineno-9-22 name=__codelineno-9-22></a><a href=#__codelineno-9-22><span class=linenos data-linenos="22 "></span></a>    <span class=k>return</span> <span class=n>diskCache</span><span class=p>;</span>
<a id=__codelineno-9-23 name=__codelineno-9-23></a><a href=#__codelineno-9-23><span class=linenos data-linenos="23 "></span></a>  <span class=p>}</span>
<a id=__codelineno-9-24 name=__codelineno-9-24></a><a href=#__codelineno-9-24><span class=linenos data-linenos="24 "></span></a><span class=p>}</span>
</code></pre></div> <p>è€Œ<code>LazyDiskCacheProvider</code>åˆä¼šåœ¨<code>Engine</code>åé¢çš„åˆå§‹åŒ–æµç¨‹ä¸­ä¼ å…¥<code>DecodeJobFactory</code>ã€‚åœ¨<code>DecodeJobFactory</code>åˆ›å»º<code>DecodeJob</code>æ—¶ä¼šä¼ è¿›å»ã€‚<br> <code>DecodeJob</code>è‡ªèº«ä¼šä¿å­˜èµ·æ¥ï¼Œåœ¨èµ„æºåŠ è½½å®Œæ¯•å¹¶å±•ç¤ºåï¼Œä¼šè¿›è¡Œç¼“å­˜çš„å­˜æ”¾ã€‚åŒæ—¶ï¼Œ<code>DecodeJob</code>ä¹Ÿä¼šåœ¨<code>DecodeHelper</code>åˆå§‹åŒ–æ—¶ï¼Œè®¾ç½®è¿›å»ï¼Œä¾›<code>ResourceCacheGenerator</code>ã€<code>DataCacheGenerator</code>è¯»å–ç¼“å­˜ï¼Œä¾›<code>SourceGenerator</code>å†™å…¥ç¼“å­˜ã€‚</p> <h2 id=4-activeresources>4. ActiveResources<a class=headerlink href=#4-activeresources title="Anchor link to this section for reference">&para;</a></h2> <p>åœ¨æ­£å¼å¼€å§‹è®¨è®ºç¼“å­˜æµç¨‹æ—¶ï¼Œè¿˜æ˜¯è¦å…ˆä»‹ç»ä¸€ä¸‹<code>ActiveResources</code>çš„ä¸€äº›æºç ã€‚<br> <code>ActiveResources</code>åœ¨<code>Engine</code>çš„æ„é€ å™¨ä¸­è¢«åˆ›å»ºã€‚<code>ActiveResources</code>æ„å»ºå®Œæˆåï¼Œä¼šå¯åŠ¨ä¸€ä¸ªåå°ä¼˜å…ˆçº§çº§åˆ«ï¼ˆ<code>THREAD_PRIORITY_BACKGROUND</code>ï¼‰çš„çº¿ç¨‹ï¼Œåœ¨è¯¥çº¿ç¨‹ä¸­ä¼šè°ƒç”¨<code>cleanReferenceQueue()</code>æ–¹æ³•ä¸€ç›´å¾ªç¯æ¸…é™¤ReferenceQueueä¸­çš„å°†è¦è¢«GCçš„Resourceã€‚</p> <p><strong>ActiveResources.java</strong> </p> <div class=highlight><pre><span></span><code><a id=__codelineno-10-1 name=__codelineno-10-1></a><a href=#__codelineno-10-1><span class=linenos data-linenos=" 1 "></span></a><span class=kd>final</span> <span class=kd>class</span> <span class=nc>ActiveResources</span> <span class=p>{</span>
<a id=__codelineno-10-2 name=__codelineno-10-2></a><a href=#__codelineno-10-2><span class=linenos data-linenos=" 2 "></span></a>  <span class=kd>private</span> <span class=kd>final</span> <span class=kt>boolean</span> <span class=n>isActiveResourceRetentionAllowed</span><span class=p>;</span>
<a id=__codelineno-10-3 name=__codelineno-10-3></a><a href=#__codelineno-10-3><span class=linenos data-linenos=" 3 "></span></a>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>Executor</span> <span class=n>monitorClearedResourcesExecutor</span><span class=p>;</span>
<a id=__codelineno-10-4 name=__codelineno-10-4></a><a href=#__codelineno-10-4><span class=linenos data-linenos=" 4 "></span></a>  <span class=nd>@VisibleForTesting</span>
<a id=__codelineno-10-5 name=__codelineno-10-5></a><a href=#__codelineno-10-5><span class=linenos data-linenos=" 5 "></span></a>  <span class=kd>final</span> <span class=n>Map</span><span class=o>&lt;</span><span class=n>Key</span><span class=p>,</span> <span class=n>ResourceWeakReference</span><span class=o>&gt;</span> <span class=n>activeEngineResources</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HashMap</span><span class=o>&lt;&gt;</span><span class=p>();</span>
<a id=__codelineno-10-6 name=__codelineno-10-6></a><a href=#__codelineno-10-6><span class=linenos data-linenos=" 6 "></span></a>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>ReferenceQueue</span><span class=o>&lt;</span><span class=n>EngineResource</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>resourceReferenceQueue</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ReferenceQueue</span><span class=o>&lt;&gt;</span><span class=p>();</span>
<a id=__codelineno-10-7 name=__codelineno-10-7></a><a href=#__codelineno-10-7><span class=linenos data-linenos=" 7 "></span></a>
<a id=__codelineno-10-8 name=__codelineno-10-8></a><a href=#__codelineno-10-8><span class=linenos data-linenos=" 8 "></span></a>  <span class=kd>private</span> <span class=kd>volatile</span> <span class=kt>boolean</span> <span class=n>isShutdown</span><span class=p>;</span>
<a id=__codelineno-10-9 name=__codelineno-10-9></a><a href=#__codelineno-10-9><span class=linenos data-linenos=" 9 "></span></a>
<a id=__codelineno-10-10 name=__codelineno-10-10></a><a href=#__codelineno-10-10><span class=linenos data-linenos="10 "></span></a>  <span class=n>ActiveResources</span><span class=p>(</span><span class=kt>boolean</span> <span class=n>isActiveResourceRetentionAllowed</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-10-11 name=__codelineno-10-11></a><a href=#__codelineno-10-11><span class=linenos data-linenos="11 "></span></a>    <span class=k>this</span><span class=p>(</span>
<a id=__codelineno-10-12 name=__codelineno-10-12></a><a href=#__codelineno-10-12><span class=linenos data-linenos="12 "></span></a>        <span class=n>isActiveResourceRetentionAllowed</span><span class=p>,</span>
<a id=__codelineno-10-13 name=__codelineno-10-13></a><a href=#__codelineno-10-13><span class=linenos data-linenos="13 "></span></a>        <span class=n>java</span><span class=p>.</span><span class=na>util</span><span class=p>.</span><span class=na>concurrent</span><span class=p>.</span><span class=na>Executors</span><span class=p>.</span><span class=na>newSingleThreadExecutor</span><span class=p>(</span>
<a id=__codelineno-10-14 name=__codelineno-10-14></a><a href=#__codelineno-10-14><span class=linenos data-linenos="14 "></span></a>            <span class=k>new</span> <span class=n>ThreadFactory</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-10-15 name=__codelineno-10-15></a><a href=#__codelineno-10-15><span class=linenos data-linenos="15 "></span></a>              <span class=nd>@Override</span>
<a id=__codelineno-10-16 name=__codelineno-10-16></a><a href=#__codelineno-10-16><span class=linenos data-linenos="16 "></span></a>              <span class=kd>public</span> <span class=n>Thread</span> <span class=nf>newThread</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=kd>final</span> <span class=n>Runnable</span> <span class=n>r</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-10-17 name=__codelineno-10-17></a><a href=#__codelineno-10-17><span class=linenos data-linenos="17 "></span></a>                <span class=k>return</span> <span class=k>new</span> <span class=n>Thread</span><span class=p>(</span>
<a id=__codelineno-10-18 name=__codelineno-10-18></a><a href=#__codelineno-10-18><span class=linenos data-linenos="18 "></span></a>                    <span class=k>new</span> <span class=n>Runnable</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-10-19 name=__codelineno-10-19></a><a href=#__codelineno-10-19><span class=linenos data-linenos="19 "></span></a>                      <span class=nd>@Override</span>
<a id=__codelineno-10-20 name=__codelineno-10-20></a><a href=#__codelineno-10-20><span class=linenos data-linenos="20 "></span></a>                      <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-10-21 name=__codelineno-10-21></a><a href=#__codelineno-10-21><span class=linenos data-linenos="21 "></span></a>                        <span class=n>Process</span><span class=p>.</span><span class=na>setThreadPriority</span><span class=p>(</span><span class=n>Process</span><span class=p>.</span><span class=na>THREAD_PRIORITY_BACKGROUND</span><span class=p>);</span>
<a id=__codelineno-10-22 name=__codelineno-10-22></a><a href=#__codelineno-10-22><span class=linenos data-linenos="22 "></span></a>                        <span class=n>r</span><span class=p>.</span><span class=na>run</span><span class=p>();</span>
<a id=__codelineno-10-23 name=__codelineno-10-23></a><a href=#__codelineno-10-23><span class=linenos data-linenos="23 "></span></a>                      <span class=p>}</span>
<a id=__codelineno-10-24 name=__codelineno-10-24></a><a href=#__codelineno-10-24><span class=linenos data-linenos="24 "></span></a>                    <span class=p>},</span>
<a id=__codelineno-10-25 name=__codelineno-10-25></a><a href=#__codelineno-10-25><span class=linenos data-linenos="25 "></span></a>                    <span class=s>&quot;glide-active-resources&quot;</span><span class=p>);</span>
<a id=__codelineno-10-26 name=__codelineno-10-26></a><a href=#__codelineno-10-26><span class=linenos data-linenos="26 "></span></a>              <span class=p>}</span>
<a id=__codelineno-10-27 name=__codelineno-10-27></a><a href=#__codelineno-10-27><span class=linenos data-linenos="27 "></span></a>            <span class=p>}));</span>
<a id=__codelineno-10-28 name=__codelineno-10-28></a><a href=#__codelineno-10-28><span class=linenos data-linenos="28 "></span></a>  <span class=p>}</span>
<a id=__codelineno-10-29 name=__codelineno-10-29></a><a href=#__codelineno-10-29><span class=linenos data-linenos="29 "></span></a>
<a id=__codelineno-10-30 name=__codelineno-10-30></a><a href=#__codelineno-10-30><span class=linenos data-linenos="30 "></span></a>  <span class=nd>@VisibleForTesting</span>
<a id=__codelineno-10-31 name=__codelineno-10-31></a><a href=#__codelineno-10-31><span class=linenos data-linenos="31 "></span></a>  <span class=n>ActiveResources</span><span class=p>(</span>
<a id=__codelineno-10-32 name=__codelineno-10-32></a><a href=#__codelineno-10-32><span class=linenos data-linenos="32 "></span></a>      <span class=kt>boolean</span> <span class=n>isActiveResourceRetentionAllowed</span><span class=p>,</span> <span class=n>Executor</span> <span class=n>monitorClearedResourcesExecutor</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-10-33 name=__codelineno-10-33></a><a href=#__codelineno-10-33><span class=linenos data-linenos="33 "></span></a>    <span class=k>this</span><span class=p>.</span><span class=na>isActiveResourceRetentionAllowed</span> <span class=o>=</span> <span class=n>isActiveResourceRetentionAllowed</span><span class=p>;</span>
<a id=__codelineno-10-34 name=__codelineno-10-34></a><a href=#__codelineno-10-34><span class=linenos data-linenos="34 "></span></a>    <span class=k>this</span><span class=p>.</span><span class=na>monitorClearedResourcesExecutor</span> <span class=o>=</span> <span class=n>monitorClearedResourcesExecutor</span><span class=p>;</span>
<a id=__codelineno-10-35 name=__codelineno-10-35></a><a href=#__codelineno-10-35><span class=linenos data-linenos="35 "></span></a>
<a id=__codelineno-10-36 name=__codelineno-10-36></a><a href=#__codelineno-10-36><span class=linenos data-linenos="36 "></span></a>    <span class=n>monitorClearedResourcesExecutor</span><span class=p>.</span><span class=na>execute</span><span class=p>(</span>
<a id=__codelineno-10-37 name=__codelineno-10-37></a><a href=#__codelineno-10-37><span class=linenos data-linenos="37 "></span></a>        <span class=k>new</span> <span class=n>Runnable</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-10-38 name=__codelineno-10-38></a><a href=#__codelineno-10-38><span class=linenos data-linenos="38 "></span></a>          <span class=nd>@Override</span>
<a id=__codelineno-10-39 name=__codelineno-10-39></a><a href=#__codelineno-10-39><span class=linenos data-linenos="39 "></span></a>          <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-10-40 name=__codelineno-10-40></a><a href=#__codelineno-10-40><span class=linenos data-linenos="40 "></span></a>            <span class=n>cleanReferenceQueue</span><span class=p>();</span>
<a id=__codelineno-10-41 name=__codelineno-10-41></a><a href=#__codelineno-10-41><span class=linenos data-linenos="41 "></span></a>          <span class=p>}</span>
<a id=__codelineno-10-42 name=__codelineno-10-42></a><a href=#__codelineno-10-42><span class=linenos data-linenos="42 "></span></a>        <span class=p>});</span>
<a id=__codelineno-10-43 name=__codelineno-10-43></a><a href=#__codelineno-10-43><span class=linenos data-linenos="43 "></span></a>  <span class=p>}</span>
<a id=__codelineno-10-44 name=__codelineno-10-44></a><a href=#__codelineno-10-44><span class=linenos data-linenos="44 "></span></a>
<a id=__codelineno-10-45 name=__codelineno-10-45></a><a href=#__codelineno-10-45><span class=linenos data-linenos="45 "></span></a>  <span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;WeakerAccess&quot;</span><span class=p>)</span>
<a id=__codelineno-10-46 name=__codelineno-10-46></a><a href=#__codelineno-10-46><span class=linenos data-linenos="46 "></span></a>  <span class=nd>@Synthetic</span> <span class=kt>void</span> <span class=nf>cleanReferenceQueue</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-10-47 name=__codelineno-10-47></a><a href=#__codelineno-10-47><span class=linenos data-linenos="47 "></span></a>    <span class=k>while</span> <span class=p>(</span><span class=o>!</span><span class=n>isShutdown</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-10-48 name=__codelineno-10-48></a><a href=#__codelineno-10-48><span class=linenos data-linenos="48 "></span></a>      <span class=k>try</span> <span class=p>{</span>
<a id=__codelineno-10-49 name=__codelineno-10-49></a><a href=#__codelineno-10-49><span class=linenos data-linenos="49 "></span></a>        <span class=n>ResourceWeakReference</span> <span class=n>ref</span> <span class=o>=</span> <span class=p>(</span><span class=n>ResourceWeakReference</span><span class=p>)</span> <span class=n>resourceReferenceQueue</span><span class=p>.</span><span class=na>remove</span><span class=p>();</span>
<a id=__codelineno-10-50 name=__codelineno-10-50></a><a href=#__codelineno-10-50><span class=linenos data-linenos="50 "></span></a>        <span class=n>cleanupActiveReference</span><span class=p>(</span><span class=n>ref</span><span class=p>);</span>
<a id=__codelineno-10-51 name=__codelineno-10-51></a><a href=#__codelineno-10-51><span class=linenos data-linenos="51 "></span></a>
<a id=__codelineno-10-52 name=__codelineno-10-52></a><a href=#__codelineno-10-52><span class=linenos data-linenos="52 "></span></a>        <span class=c1>// This section for testing only.</span>
<a id=__codelineno-10-53 name=__codelineno-10-53></a><a href=#__codelineno-10-53><span class=linenos data-linenos="53 "></span></a>        <span class=n>DequeuedResourceCallback</span> <span class=n>current</span> <span class=o>=</span> <span class=n>cb</span><span class=p>;</span>
<a id=__codelineno-10-54 name=__codelineno-10-54></a><a href=#__codelineno-10-54><span class=linenos data-linenos="54 "></span></a>        <span class=k>if</span> <span class=p>(</span><span class=n>current</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-10-55 name=__codelineno-10-55></a><a href=#__codelineno-10-55><span class=linenos data-linenos="55 "></span></a>          <span class=n>current</span><span class=p>.</span><span class=na>onResourceDequeued</span><span class=p>();</span>
<a id=__codelineno-10-56 name=__codelineno-10-56></a><a href=#__codelineno-10-56><span class=linenos data-linenos="56 "></span></a>        <span class=p>}</span>
<a id=__codelineno-10-57 name=__codelineno-10-57></a><a href=#__codelineno-10-57><span class=linenos data-linenos="57 "></span></a>        <span class=c1>// End for testing only.</span>
<a id=__codelineno-10-58 name=__codelineno-10-58></a><a href=#__codelineno-10-58><span class=linenos data-linenos="58 "></span></a>      <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-10-59 name=__codelineno-10-59></a><a href=#__codelineno-10-59><span class=linenos data-linenos="59 "></span></a>        <span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>().</span><span class=na>interrupt</span><span class=p>();</span>
<a id=__codelineno-10-60 name=__codelineno-10-60></a><a href=#__codelineno-10-60><span class=linenos data-linenos="60 "></span></a>      <span class=p>}</span>
<a id=__codelineno-10-61 name=__codelineno-10-61></a><a href=#__codelineno-10-61><span class=linenos data-linenos="61 "></span></a>    <span class=p>}</span>
<a id=__codelineno-10-62 name=__codelineno-10-62></a><a href=#__codelineno-10-62><span class=linenos data-linenos="62 "></span></a>  <span class=p>}</span>
<a id=__codelineno-10-63 name=__codelineno-10-63></a><a href=#__codelineno-10-63><span class=linenos data-linenos="63 "></span></a><span class=p>}</span>
</code></pre></div> <p><code>cleanupActiveReference</code>æ–¹æ³•é©¬ä¸Šä¼šè¯´ã€‚ç°åœ¨å…ˆæ¥çœ‹çœ‹<code>ActiveResources</code>çš„ä¿å­˜ã€åˆ é™¤çš„æ–¹æ³•ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•åˆ†åˆ«æ˜¯<code>activate</code>ã€<code>deactivate</code>ã€‚å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•å®ç°éƒ½å¾ˆç®€å•ã€‚<code>activate</code>æ–¹æ³•ä¼šå°†å‚æ•°å°è£…æˆä¸ºä¸€ä¸ª<code>ResourceWeakReference</code>ï¼Œç„¶åæ”¾å…¥mapä¸­ï¼Œå¦‚æœå¯¹åº”çš„keyä¹‹å‰æœ‰å€¼ï¼Œé‚£ä¹ˆè°ƒç”¨ä¹‹å‰å€¼çš„<code>reset</code>æ–¹æ³•è¿›è¡Œæ¸…é™¤ã€‚<code>deactivate</code>æ–¹æ³•å…ˆåœ¨mapä¸­ç§»é™¤ï¼Œç„¶åè°ƒç”¨resourceçš„<code>reset</code>æ–¹æ³•è¿›è¡Œæ¸…é™¤ã€‚</p> <div class=highlight><pre><span></span><code><a id=__codelineno-11-1 name=__codelineno-11-1></a><a href=#__codelineno-11-1><span class=linenos data-linenos=" 1 "></span></a><span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>activate</span><span class=p>(</span><span class=n>Key</span> <span class=n>key</span><span class=p>,</span> <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>resource</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-11-2 name=__codelineno-11-2></a><a href=#__codelineno-11-2><span class=linenos data-linenos=" 2 "></span></a>  <span class=n>ResourceWeakReference</span> <span class=n>toPut</span> <span class=o>=</span>
<a id=__codelineno-11-3 name=__codelineno-11-3></a><a href=#__codelineno-11-3><span class=linenos data-linenos=" 3 "></span></a>      <span class=k>new</span> <span class=n>ResourceWeakReference</span><span class=p>(</span>
<a id=__codelineno-11-4 name=__codelineno-11-4></a><a href=#__codelineno-11-4><span class=linenos data-linenos=" 4 "></span></a>          <span class=n>key</span><span class=p>,</span> <span class=n>resource</span><span class=p>,</span> <span class=n>resourceReferenceQueue</span><span class=p>,</span> <span class=n>isActiveResourceRetentionAllowed</span><span class=p>);</span>
<a id=__codelineno-11-5 name=__codelineno-11-5></a><a href=#__codelineno-11-5><span class=linenos data-linenos=" 5 "></span></a>
<a id=__codelineno-11-6 name=__codelineno-11-6></a><a href=#__codelineno-11-6><span class=linenos data-linenos=" 6 "></span></a>  <span class=n>ResourceWeakReference</span> <span class=n>removed</span> <span class=o>=</span> <span class=n>activeEngineResources</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>toPut</span><span class=p>);</span>
<a id=__codelineno-11-7 name=__codelineno-11-7></a><a href=#__codelineno-11-7><span class=linenos data-linenos=" 7 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>removed</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-11-8 name=__codelineno-11-8></a><a href=#__codelineno-11-8><span class=linenos data-linenos=" 8 "></span></a>    <span class=n>removed</span><span class=p>.</span><span class=na>reset</span><span class=p>();</span>
<a id=__codelineno-11-9 name=__codelineno-11-9></a><a href=#__codelineno-11-9><span class=linenos data-linenos=" 9 "></span></a>  <span class=p>}</span>
<a id=__codelineno-11-10 name=__codelineno-11-10></a><a href=#__codelineno-11-10><span class=linenos data-linenos="10 "></span></a><span class=p>}</span>
<a id=__codelineno-11-11 name=__codelineno-11-11></a><a href=#__codelineno-11-11><span class=linenos data-linenos="11 "></span></a>
<a id=__codelineno-11-12 name=__codelineno-11-12></a><a href=#__codelineno-11-12><span class=linenos data-linenos="12 "></span></a><span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>deactivate</span><span class=p>(</span><span class=n>Key</span> <span class=n>key</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-11-13 name=__codelineno-11-13></a><a href=#__codelineno-11-13><span class=linenos data-linenos="13 "></span></a>  <span class=n>ResourceWeakReference</span> <span class=n>removed</span> <span class=o>=</span> <span class=n>activeEngineResources</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
<a id=__codelineno-11-14 name=__codelineno-11-14></a><a href=#__codelineno-11-14><span class=linenos data-linenos="14 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>removed</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-11-15 name=__codelineno-11-15></a><a href=#__codelineno-11-15><span class=linenos data-linenos="15 "></span></a>    <span class=n>removed</span><span class=p>.</span><span class=na>reset</span><span class=p>();</span>
<a id=__codelineno-11-16 name=__codelineno-11-16></a><a href=#__codelineno-11-16><span class=linenos data-linenos="16 "></span></a>  <span class=p>}</span>
<a id=__codelineno-11-17 name=__codelineno-11-17></a><a href=#__codelineno-11-17><span class=linenos data-linenos="17 "></span></a><span class=p>}</span>
</code></pre></div> <p><code>ResourceWeakReference</code>ç»§æ‰¿è‡³<code>WeakReference</code>ï¼Œåªæ˜¯ä¿å­˜äº†Resourceçš„ä¸€äº›å±æ€§ï¼Œæ­¤å¤–æ·»åŠ äº†ä¸€ä¸ª<code>reset</code>æ–¹æ³•ç”¨æ¥æ¸…ç†èµ„æºï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-12-1 name=__codelineno-12-1></a><a href=#__codelineno-12-1><span class=linenos data-linenos=" 1 "></span></a><span class=nd>@VisibleForTesting</span>
<a id=__codelineno-12-2 name=__codelineno-12-2></a><a href=#__codelineno-12-2><span class=linenos data-linenos=" 2 "></span></a><span class=kd>static</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>ResourceWeakReference</span> <span class=kd>extends</span> <span class=n>WeakReference</span><span class=o>&lt;</span><span class=n>EngineResource</span><span class=o>&lt;?&gt;&gt;</span> <span class=p>{</span>
<a id=__codelineno-12-3 name=__codelineno-12-3></a><a href=#__codelineno-12-3><span class=linenos data-linenos=" 3 "></span></a>  <span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;WeakerAccess&quot;</span><span class=p>)</span> <span class=nd>@Synthetic</span> <span class=kd>final</span> <span class=n>Key</span> <span class=n>key</span><span class=p>;</span>
<a id=__codelineno-12-4 name=__codelineno-12-4></a><a href=#__codelineno-12-4><span class=linenos data-linenos=" 4 "></span></a>  <span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;WeakerAccess&quot;</span><span class=p>)</span> <span class=nd>@Synthetic</span> <span class=kd>final</span> <span class=kt>boolean</span> <span class=n>isCacheable</span><span class=p>;</span>
<a id=__codelineno-12-5 name=__codelineno-12-5></a><a href=#__codelineno-12-5><span class=linenos data-linenos=" 5 "></span></a>
<a id=__codelineno-12-6 name=__codelineno-12-6></a><a href=#__codelineno-12-6><span class=linenos data-linenos=" 6 "></span></a>  <span class=nd>@Nullable</span> <span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;WeakerAccess&quot;</span><span class=p>)</span> <span class=nd>@Synthetic</span> <span class=n>Resource</span><span class=o>&lt;?&gt;</span> <span class=n>resource</span><span class=p>;</span>
<a id=__codelineno-12-7 name=__codelineno-12-7></a><a href=#__codelineno-12-7><span class=linenos data-linenos=" 7 "></span></a>
<a id=__codelineno-12-8 name=__codelineno-12-8></a><a href=#__codelineno-12-8><span class=linenos data-linenos=" 8 "></span></a>  <span class=nd>@Synthetic</span>
<a id=__codelineno-12-9 name=__codelineno-12-9></a><a href=#__codelineno-12-9><span class=linenos data-linenos=" 9 "></span></a>  <span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;WeakerAccess&quot;</span><span class=p>)</span>
<a id=__codelineno-12-10 name=__codelineno-12-10></a><a href=#__codelineno-12-10><span class=linenos data-linenos="10 "></span></a>  <span class=n>ResourceWeakReference</span><span class=p>(</span>
<a id=__codelineno-12-11 name=__codelineno-12-11></a><a href=#__codelineno-12-11><span class=linenos data-linenos="11 "></span></a>      <span class=nd>@NonNull</span> <span class=n>Key</span> <span class=n>key</span><span class=p>,</span>
<a id=__codelineno-12-12 name=__codelineno-12-12></a><a href=#__codelineno-12-12><span class=linenos data-linenos="12 "></span></a>      <span class=nd>@NonNull</span> <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>referent</span><span class=p>,</span>
<a id=__codelineno-12-13 name=__codelineno-12-13></a><a href=#__codelineno-12-13><span class=linenos data-linenos="13 "></span></a>      <span class=nd>@NonNull</span> <span class=n>ReferenceQueue</span><span class=o>&lt;?</span> <span class=kd>super</span> <span class=n>EngineResource</span><span class=o>&lt;?&gt;&gt;</span> <span class=n>queue</span><span class=p>,</span>
<a id=__codelineno-12-14 name=__codelineno-12-14></a><a href=#__codelineno-12-14><span class=linenos data-linenos="14 "></span></a>      <span class=kt>boolean</span> <span class=n>isActiveResourceRetentionAllowed</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-12-15 name=__codelineno-12-15></a><a href=#__codelineno-12-15><span class=linenos data-linenos="15 "></span></a>    <span class=kd>super</span><span class=p>(</span><span class=n>referent</span><span class=p>,</span> <span class=n>queue</span><span class=p>);</span>
<a id=__codelineno-12-16 name=__codelineno-12-16></a><a href=#__codelineno-12-16><span class=linenos data-linenos="16 "></span></a>    <span class=k>this</span><span class=p>.</span><span class=na>key</span> <span class=o>=</span> <span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
<a id=__codelineno-12-17 name=__codelineno-12-17></a><a href=#__codelineno-12-17><span class=linenos data-linenos="17 "></span></a>    <span class=k>this</span><span class=p>.</span><span class=na>resource</span> <span class=o>=</span>
<a id=__codelineno-12-18 name=__codelineno-12-18></a><a href=#__codelineno-12-18><span class=linenos data-linenos="18 "></span></a>        <span class=n>referent</span><span class=p>.</span><span class=na>isCacheable</span><span class=p>()</span> <span class=o>&amp;&amp;</span> <span class=n>isActiveResourceRetentionAllowed</span>
<a id=__codelineno-12-19 name=__codelineno-12-19></a><a href=#__codelineno-12-19><span class=linenos data-linenos="19 "></span></a>            <span class=o>?</span> <span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>referent</span><span class=p>.</span><span class=na>getResource</span><span class=p>())</span> <span class=p>:</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-12-20 name=__codelineno-12-20></a><a href=#__codelineno-12-20><span class=linenos data-linenos="20 "></span></a>    <span class=n>isCacheable</span> <span class=o>=</span> <span class=n>referent</span><span class=p>.</span><span class=na>isCacheable</span><span class=p>();</span>
<a id=__codelineno-12-21 name=__codelineno-12-21></a><a href=#__codelineno-12-21><span class=linenos data-linenos="21 "></span></a>  <span class=p>}</span>
<a id=__codelineno-12-22 name=__codelineno-12-22></a><a href=#__codelineno-12-22><span class=linenos data-linenos="22 "></span></a>
<a id=__codelineno-12-23 name=__codelineno-12-23></a><a href=#__codelineno-12-23><span class=linenos data-linenos="23 "></span></a>  <span class=kt>void</span> <span class=nf>reset</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-12-24 name=__codelineno-12-24></a><a href=#__codelineno-12-24><span class=linenos data-linenos="24 "></span></a>    <span class=n>resource</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-12-25 name=__codelineno-12-25></a><a href=#__codelineno-12-25><span class=linenos data-linenos="25 "></span></a>    <span class=n>clear</span><span class=p>();</span>
<a id=__codelineno-12-26 name=__codelineno-12-26></a><a href=#__codelineno-12-26><span class=linenos data-linenos="26 "></span></a>  <span class=p>}</span>
<a id=__codelineno-12-27 name=__codelineno-12-27></a><a href=#__codelineno-12-27><span class=linenos data-linenos="27 "></span></a><span class=p>}</span>
</code></pre></div> <p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œçš„æ„é€ æ–¹æ³•ä¸­è°ƒç”¨äº†<code>super(referent, queue)</code>ã€‚è¿™æ ·å¦‚æœreferentå°†è¦è¢«GCï¼Œå°±ä¼šè¢«æ”¾å…¥queueä¸­ã€‚è€Œ<code>ActiveResources.cleanReferenceQueue()</code>æ–¹æ³•ä¼šä¸€ç›´å°è¯•ä»queueä¸­è·å–å°†è¦è¢«GCçš„resourceï¼Œç„¶åè°ƒç”¨å…¶<code>cleanupActiveReference</code>æ–¹æ³•ã€‚<br> è¯¥æ–¹æ³•é™¤äº†åœ¨æ­¤æ—¶è¢«è°ƒç”¨å¤–ï¼Œè¿˜åœ¨<code>ActiveResources.get(key)</code>æ–¹æ³•ä¸­ä¹Ÿå¯èƒ½ä¼šå› ä¸ºè·å–åˆ°çš„resourceä¸ºnullè€Œè¢«è°ƒç”¨ã€‚<code>cleanupActiveReference</code>æ–¹æ³•å¦‚ä¸‹ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-13-1 name=__codelineno-13-1></a><a href=#__codelineno-13-1><span class=linenos data-linenos=" 1 "></span></a><span class=nd>@Synthetic</span>
<a id=__codelineno-13-2 name=__codelineno-13-2></a><a href=#__codelineno-13-2><span class=linenos data-linenos=" 2 "></span></a><span class=kt>void</span> <span class=nf>cleanupActiveReference</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>ResourceWeakReference</span> <span class=n>ref</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-13-3 name=__codelineno-13-3></a><a href=#__codelineno-13-3><span class=linenos data-linenos=" 3 "></span></a>  <span class=c1>// Fixes a deadlock where we normally acquire the Engine lock and then the ActiveResources lock</span>
<a id=__codelineno-13-4 name=__codelineno-13-4></a><a href=#__codelineno-13-4><span class=linenos data-linenos=" 4 "></span></a>  <span class=c1>// but reverse that order in this one particular test. This is definitely a bit of a hack...</span>
<a id=__codelineno-13-5 name=__codelineno-13-5></a><a href=#__codelineno-13-5><span class=linenos data-linenos=" 5 "></span></a>  <span class=kd>synchronized</span> <span class=p>(</span><span class=n>listener</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-13-6 name=__codelineno-13-6></a><a href=#__codelineno-13-6><span class=linenos data-linenos=" 6 "></span></a>    <span class=kd>synchronized</span> <span class=p>(</span><span class=k>this</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-13-7 name=__codelineno-13-7></a><a href=#__codelineno-13-7><span class=linenos data-linenos=" 7 "></span></a>      <span class=n>activeEngineResources</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>ref</span><span class=p>.</span><span class=na>key</span><span class=p>);</span>
<a id=__codelineno-13-8 name=__codelineno-13-8></a><a href=#__codelineno-13-8><span class=linenos data-linenos=" 8 "></span></a>      <span class=c1>// å¦‚æœæ˜¯GCåè°ƒç”¨ï¼Œæ­¤æ—¶ref.resourceè‚¯å®šä¸ºnull</span>
<a id=__codelineno-13-9 name=__codelineno-13-9></a><a href=#__codelineno-13-9><span class=linenos data-linenos=" 9 "></span></a>      <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>ref</span><span class=p>.</span><span class=na>isCacheable</span> <span class=o>||</span> <span class=n>ref</span><span class=p>.</span><span class=na>resource</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-13-10 name=__codelineno-13-10></a><a href=#__codelineno-13-10><span class=linenos data-linenos="10 "></span></a>        <span class=k>return</span><span class=p>;</span>
<a id=__codelineno-13-11 name=__codelineno-13-11></a><a href=#__codelineno-13-11><span class=linenos data-linenos="11 "></span></a>      <span class=p>}</span>
<a id=__codelineno-13-12 name=__codelineno-13-12></a><a href=#__codelineno-13-12><span class=linenos data-linenos="12 "></span></a>      <span class=c1>// èµ°åˆ°è¿™ï¼Œè¡¨ç¤ºæ˜¯åœ¨getæ–¹æ³•ä¸­è¢«è°ƒç”¨ï¼Œæ­¤æ—¶ä¼šæ¢å¤åŸæ¥çš„resource</span>
<a id=__codelineno-13-13 name=__codelineno-13-13></a><a href=#__codelineno-13-13><span class=linenos data-linenos="13 "></span></a>      <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>newResource</span> <span class=o>=</span>
<a id=__codelineno-13-14 name=__codelineno-13-14></a><a href=#__codelineno-13-14><span class=linenos data-linenos="14 "></span></a>          <span class=k>new</span> <span class=n>EngineResource</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>ref</span><span class=p>.</span><span class=na>resource</span><span class=p>,</span> <span class=cm>/*isCacheable=*/</span> <span class=kc>true</span><span class=p>,</span> <span class=cm>/*isRecyclable=*/</span> <span class=kc>false</span><span class=p>);</span>
<a id=__codelineno-13-15 name=__codelineno-13-15></a><a href=#__codelineno-13-15><span class=linenos data-linenos="15 "></span></a>      <span class=n>newResource</span><span class=p>.</span><span class=na>setResourceListener</span><span class=p>(</span><span class=n>ref</span><span class=p>.</span><span class=na>key</span><span class=p>,</span> <span class=n>listener</span><span class=p>);</span>
<a id=__codelineno-13-16 name=__codelineno-13-16></a><a href=#__codelineno-13-16><span class=linenos data-linenos="16 "></span></a>      <span class=c1>// å›è°ƒEngineçš„onResourceReleasedæ–¹æ³•</span>
<a id=__codelineno-13-17 name=__codelineno-13-17></a><a href=#__codelineno-13-17><span class=linenos data-linenos="17 "></span></a>      <span class=c1>// è¿™ä¼šå¯¼è‡´æ­¤èµ„æºä»activeå˜æˆmemory cacheçŠ¶æ€</span>
<a id=__codelineno-13-18 name=__codelineno-13-18></a><a href=#__codelineno-13-18><span class=linenos data-linenos="18 "></span></a>      <span class=n>listener</span><span class=p>.</span><span class=na>onResourceReleased</span><span class=p>(</span><span class=n>ref</span><span class=p>.</span><span class=na>key</span><span class=p>,</span> <span class=n>newResource</span><span class=p>);</span>
<a id=__codelineno-13-19 name=__codelineno-13-19></a><a href=#__codelineno-13-19><span class=linenos data-linenos="19 "></span></a>    <span class=p>}</span>
<a id=__codelineno-13-20 name=__codelineno-13-20></a><a href=#__codelineno-13-20><span class=linenos data-linenos="20 "></span></a>  <span class=p>}</span>
<a id=__codelineno-13-21 name=__codelineno-13-21></a><a href=#__codelineno-13-21><span class=linenos data-linenos="21 "></span></a><span class=p>}</span>
</code></pre></div> <h2 id=5>5. ç¼“å­˜åŠ è½½ã€å­˜æ”¾è¿‡ç¨‹<a class=headerlink href=#5 title="Anchor link to this section for reference">&para;</a></h2> <p>åœ¨äº†è§£å®Œä¸Šé¢ä¸‰ç§ç¼“å­˜çŠ¶æ€èµ„æºå¯¹åº”çš„ç±»åï¼Œæˆ‘ä»¬ç°åœ¨çœ‹ä¸€ä¸‹ç¼“å­˜åŠ è½½ã€å­˜æ”¾çš„è¿‡ç¨‹ã€‚ç”±äºç¼“å­˜ç­–ç•¥é»˜è®¤ä¸º<code>DiskCacheStrategy.AUTOMATIC</code>ï¼Œæ‰€ä»¥åŠ è½½æŸä¸€ç§æ ¼å¼çš„å›¾ç‰‡ä¸è¶³ä»¥è¦†ç›–æ‰€æœ‰çš„æƒ…å†µï¼Œä¸‹é¢ä¼šä»¥ç½‘ç»œå›¾ç‰‡URLä»¥åŠæœ¬åœ°å›¾ç‰‡Fileè¿™ä¸¤ç§å¸¸ç”¨çš„æ–¹å¼æ¥è®²è§£ç¼“å­˜çš„åŠ è½½ã€å­˜æ”¾è¿‡ç¨‹ã€‚</p> <p>é¦–å…ˆï¼Œæ•´ä¸ªåŠ è½½çš„è¿‡ç¨‹ä½“ç°åœ¨<code>Engine.load</code>æ–¹æ³•ä¸­ï¼Œè¯¥æ–¹æ³•æ³¨é‡Šå’Œä»£ç ç‰‡æ®µå¦‚ä¸‹ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-14-1 name=__codelineno-14-1></a><a href=#__codelineno-14-1><span class=linenos data-linenos=" 1 "></span></a><span class=cm>/**</span>
<a id=__codelineno-14-2 name=__codelineno-14-2></a><a href=#__codelineno-14-2><span class=linenos data-linenos=" 2 "></span></a><span class=cm>  * Starts a load for the given arguments.</span>
<a id=__codelineno-14-3 name=__codelineno-14-3></a><a href=#__codelineno-14-3><span class=linenos data-linenos=" 3 "></span></a><span class=cm>  *</span>
<a id=__codelineno-14-4 name=__codelineno-14-4></a><a href=#__codelineno-14-4><span class=linenos data-linenos=" 4 "></span></a><span class=cm>  * &lt;p&gt;Must be called on the main thread.</span>
<a id=__codelineno-14-5 name=__codelineno-14-5></a><a href=#__codelineno-14-5><span class=linenos data-linenos=" 5 "></span></a><span class=cm>  *</span>
<a id=__codelineno-14-6 name=__codelineno-14-6></a><a href=#__codelineno-14-6><span class=linenos data-linenos=" 6 "></span></a><span class=cm>  * &lt;p&gt;The flow for any request is as follows:</span>
<a id=__codelineno-14-7 name=__codelineno-14-7></a><a href=#__codelineno-14-7><span class=linenos data-linenos=" 7 "></span></a><span class=cm>  *</span>
<a id=__codelineno-14-8 name=__codelineno-14-8></a><a href=#__codelineno-14-8><span class=linenos data-linenos=" 8 "></span></a><span class=cm>  * &lt;ul&gt;</span>
<a id=__codelineno-14-9 name=__codelineno-14-9></a><a href=#__codelineno-14-9><span class=linenos data-linenos=" 9 "></span></a><span class=cm>  *   &lt;li&gt;Check the current set of actively used resources, return the active resource if present,</span>
<a id=__codelineno-14-10 name=__codelineno-14-10></a><a href=#__codelineno-14-10><span class=linenos data-linenos="10 "></span></a><span class=cm>  *       and move any newly inactive resources into the memory cache.</span>
<a id=__codelineno-14-11 name=__codelineno-14-11></a><a href=#__codelineno-14-11><span class=linenos data-linenos="11 "></span></a><span class=cm>  *   &lt;li&gt;Check the memory cache and provide the cached resource if present.</span>
<a id=__codelineno-14-12 name=__codelineno-14-12></a><a href=#__codelineno-14-12><span class=linenos data-linenos="12 "></span></a><span class=cm>  *   &lt;li&gt;Check the current set of in progress loads and add the cb to the in progress load if one</span>
<a id=__codelineno-14-13 name=__codelineno-14-13></a><a href=#__codelineno-14-13><span class=linenos data-linenos="13 "></span></a><span class=cm>  *       is present.</span>
<a id=__codelineno-14-14 name=__codelineno-14-14></a><a href=#__codelineno-14-14><span class=linenos data-linenos="14 "></span></a><span class=cm>  *   &lt;li&gt;Start a new load.</span>
<a id=__codelineno-14-15 name=__codelineno-14-15></a><a href=#__codelineno-14-15><span class=linenos data-linenos="15 "></span></a><span class=cm>  * &lt;/ul&gt;</span>
<a id=__codelineno-14-16 name=__codelineno-14-16></a><a href=#__codelineno-14-16><span class=linenos data-linenos="16 "></span></a><span class=cm>  *</span>
<a id=__codelineno-14-17 name=__codelineno-14-17></a><a href=#__codelineno-14-17><span class=linenos data-linenos="17 "></span></a><span class=cm>  * &lt;p&gt;Active resources are those that have been provided to at least one request and have not yet</span>
<a id=__codelineno-14-18 name=__codelineno-14-18></a><a href=#__codelineno-14-18><span class=linenos data-linenos="18 "></span></a><span class=cm>  * been released. Once all consumers of a resource have released that resource, the resource then</span>
<a id=__codelineno-14-19 name=__codelineno-14-19></a><a href=#__codelineno-14-19><span class=linenos data-linenos="19 "></span></a><span class=cm>  * goes to cache. If the resource is ever returned to a new consumer from cache, it is re-added to</span>
<a id=__codelineno-14-20 name=__codelineno-14-20></a><a href=#__codelineno-14-20><span class=linenos data-linenos="20 "></span></a><span class=cm>  * the active resources. If the resource is evicted from the cache, its resources are recycled and</span>
<a id=__codelineno-14-21 name=__codelineno-14-21></a><a href=#__codelineno-14-21><span class=linenos data-linenos="21 "></span></a><span class=cm>  * re-used if possible and the resource is discarded. There is no strict requirement that</span>
<a id=__codelineno-14-22 name=__codelineno-14-22></a><a href=#__codelineno-14-22><span class=linenos data-linenos="22 "></span></a><span class=cm>  * consumers release their resources so active resources are held weakly.</span>
<a id=__codelineno-14-23 name=__codelineno-14-23></a><a href=#__codelineno-14-23><span class=linenos data-linenos="23 "></span></a><span class=cm>  *</span>
<a id=__codelineno-14-24 name=__codelineno-14-24></a><a href=#__codelineno-14-24><span class=linenos data-linenos="24 "></span></a><span class=cm>  * @param width The target width in pixels of the desired resource.</span>
<a id=__codelineno-14-25 name=__codelineno-14-25></a><a href=#__codelineno-14-25><span class=linenos data-linenos="25 "></span></a><span class=cm>  * @param height The target height in pixels of the desired resource.</span>
<a id=__codelineno-14-26 name=__codelineno-14-26></a><a href=#__codelineno-14-26><span class=linenos data-linenos="26 "></span></a><span class=cm>  * @param cb The callback that will be called when the load completes.</span>
<a id=__codelineno-14-27 name=__codelineno-14-27></a><a href=#__codelineno-14-27><span class=linenos data-linenos="27 "></span></a><span class=cm>  */</span>
<a id=__codelineno-14-28 name=__codelineno-14-28></a><a href=#__codelineno-14-28><span class=linenos data-linenos="28 "></span></a><span class=kd>public</span> <span class=kd>synchronized</span> <span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>LoadStatus</span> <span class=nf>load</span><span class=p>(...)</span> <span class=p>{</span>
<a id=__codelineno-14-29 name=__codelineno-14-29></a><a href=#__codelineno-14-29><span class=linenos data-linenos="29 "></span></a>  <span class=n>EngineKey</span> <span class=n>key</span> <span class=o>=</span> <span class=n>keyFactory</span><span class=p>.</span><span class=na>buildKey</span><span class=p>(</span><span class=n>model</span><span class=p>,</span> <span class=n>signature</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>,</span> <span class=n>transformations</span><span class=p>,</span>
<a id=__codelineno-14-30 name=__codelineno-14-30></a><a href=#__codelineno-14-30><span class=linenos data-linenos="30 "></span></a>      <span class=n>resourceClass</span><span class=p>,</span> <span class=n>transcodeClass</span><span class=p>,</span> <span class=n>options</span><span class=p>);</span>
<a id=__codelineno-14-31 name=__codelineno-14-31></a><a href=#__codelineno-14-31><span class=linenos data-linenos="31 "></span></a>
<a id=__codelineno-14-32 name=__codelineno-14-32></a><a href=#__codelineno-14-32><span class=linenos data-linenos="32 "></span></a>  <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>active</span> <span class=o>=</span> <span class=n>loadFromActiveResources</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>isMemoryCacheable</span><span class=p>);</span>
<a id=__codelineno-14-33 name=__codelineno-14-33></a><a href=#__codelineno-14-33><span class=linenos data-linenos="33 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>active</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-14-34 name=__codelineno-14-34></a><a href=#__codelineno-14-34><span class=linenos data-linenos="34 "></span></a>    <span class=n>cb</span><span class=p>.</span><span class=na>onResourceReady</span><span class=p>(</span><span class=n>active</span><span class=p>,</span> <span class=n>DataSource</span><span class=p>.</span><span class=na>MEMORY_CACHE</span><span class=p>);</span>
<a id=__codelineno-14-35 name=__codelineno-14-35></a><a href=#__codelineno-14-35><span class=linenos data-linenos="35 "></span></a>    <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-14-36 name=__codelineno-14-36></a><a href=#__codelineno-14-36><span class=linenos data-linenos="36 "></span></a>  <span class=p>}</span>
<a id=__codelineno-14-37 name=__codelineno-14-37></a><a href=#__codelineno-14-37><span class=linenos data-linenos="37 "></span></a>
<a id=__codelineno-14-38 name=__codelineno-14-38></a><a href=#__codelineno-14-38><span class=linenos data-linenos="38 "></span></a>  <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>cached</span> <span class=o>=</span> <span class=n>loadFromCache</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>isMemoryCacheable</span><span class=p>);</span>
<a id=__codelineno-14-39 name=__codelineno-14-39></a><a href=#__codelineno-14-39><span class=linenos data-linenos="39 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>cached</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-14-40 name=__codelineno-14-40></a><a href=#__codelineno-14-40><span class=linenos data-linenos="40 "></span></a>    <span class=n>cb</span><span class=p>.</span><span class=na>onResourceReady</span><span class=p>(</span><span class=n>cached</span><span class=p>,</span> <span class=n>DataSource</span><span class=p>.</span><span class=na>MEMORY_CACHE</span><span class=p>);</span>
<a id=__codelineno-14-41 name=__codelineno-14-41></a><a href=#__codelineno-14-41><span class=linenos data-linenos="41 "></span></a>    <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-14-42 name=__codelineno-14-42></a><a href=#__codelineno-14-42><span class=linenos data-linenos="42 "></span></a>  <span class=p>}</span>
<a id=__codelineno-14-43 name=__codelineno-14-43></a><a href=#__codelineno-14-43><span class=linenos data-linenos="43 "></span></a>
<a id=__codelineno-14-44 name=__codelineno-14-44></a><a href=#__codelineno-14-44><span class=linenos data-linenos="44 "></span></a>  <span class=n>EngineJob</span><span class=o>&lt;?&gt;</span> <span class=n>current</span> <span class=o>=</span> <span class=n>jobs</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>onlyRetrieveFromCache</span><span class=p>);</span>
<a id=__codelineno-14-45 name=__codelineno-14-45></a><a href=#__codelineno-14-45><span class=linenos data-linenos="45 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>current</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-14-46 name=__codelineno-14-46></a><a href=#__codelineno-14-46><span class=linenos data-linenos="46 "></span></a>    <span class=n>current</span><span class=p>.</span><span class=na>addCallback</span><span class=p>(</span><span class=n>cb</span><span class=p>,</span> <span class=n>callbackExecutor</span><span class=p>);</span>
<a id=__codelineno-14-47 name=__codelineno-14-47></a><a href=#__codelineno-14-47><span class=linenos data-linenos="47 "></span></a>    <span class=k>return</span> <span class=k>new</span> <span class=n>LoadStatus</span><span class=p>(</span><span class=n>cb</span><span class=p>,</span> <span class=n>current</span><span class=p>);</span>
<a id=__codelineno-14-48 name=__codelineno-14-48></a><a href=#__codelineno-14-48><span class=linenos data-linenos="48 "></span></a>  <span class=p>}</span>
<a id=__codelineno-14-49 name=__codelineno-14-49></a><a href=#__codelineno-14-49><span class=linenos data-linenos="49 "></span></a>
<a id=__codelineno-14-50 name=__codelineno-14-50></a><a href=#__codelineno-14-50><span class=linenos data-linenos="50 "></span></a>  <span class=n>EngineJob</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>engineJob</span> <span class=o>=</span>
<a id=__codelineno-14-51 name=__codelineno-14-51></a><a href=#__codelineno-14-51><span class=linenos data-linenos="51 "></span></a>      <span class=n>engineJobFactory</span><span class=p>.</span><span class=na>build</span><span class=p>(...);</span>
<a id=__codelineno-14-52 name=__codelineno-14-52></a><a href=#__codelineno-14-52><span class=linenos data-linenos="52 "></span></a>
<a id=__codelineno-14-53 name=__codelineno-14-53></a><a href=#__codelineno-14-53><span class=linenos data-linenos="53 "></span></a>  <span class=n>DecodeJob</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>decodeJob</span> <span class=o>=</span>
<a id=__codelineno-14-54 name=__codelineno-14-54></a><a href=#__codelineno-14-54><span class=linenos data-linenos="54 "></span></a>      <span class=n>decodeJobFactory</span><span class=p>.</span><span class=na>build</span><span class=p>(...);</span>
<a id=__codelineno-14-55 name=__codelineno-14-55></a><a href=#__codelineno-14-55><span class=linenos data-linenos="55 "></span></a>
<a id=__codelineno-14-56 name=__codelineno-14-56></a><a href=#__codelineno-14-56><span class=linenos data-linenos="56 "></span></a>  <span class=n>jobs</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>engineJob</span><span class=p>);</span>
<a id=__codelineno-14-57 name=__codelineno-14-57></a><a href=#__codelineno-14-57><span class=linenos data-linenos="57 "></span></a>
<a id=__codelineno-14-58 name=__codelineno-14-58></a><a href=#__codelineno-14-58><span class=linenos data-linenos="58 "></span></a>  <span class=n>engineJob</span><span class=p>.</span><span class=na>addCallback</span><span class=p>(</span><span class=n>cb</span><span class=p>,</span> <span class=n>callbackExecutor</span><span class=p>);</span>
<a id=__codelineno-14-59 name=__codelineno-14-59></a><a href=#__codelineno-14-59><span class=linenos data-linenos="59 "></span></a>  <span class=n>engineJob</span><span class=p>.</span><span class=na>start</span><span class=p>(</span><span class=n>decodeJob</span><span class=p>);</span>
<a id=__codelineno-14-60 name=__codelineno-14-60></a><a href=#__codelineno-14-60><span class=linenos data-linenos="60 "></span></a>
<a id=__codelineno-14-61 name=__codelineno-14-61></a><a href=#__codelineno-14-61><span class=linenos data-linenos="61 "></span></a>  <span class=k>return</span> <span class=k>new</span> <span class=n>LoadStatus</span><span class=p>(</span><span class=n>cb</span><span class=p>,</span> <span class=n>engineJob</span><span class=p>);</span>
<a id=__codelineno-14-62 name=__codelineno-14-62></a><a href=#__codelineno-14-62><span class=linenos data-linenos="62 "></span></a><span class=p>}</span>
</code></pre></div> <p>ä¸Šé¢è¿™ä¸ªæ–¹æ³•æˆ‘ä»¬åœ¨å‰ä¸€ç¯‡æ–‡ç« è®²è§£æ•´ä½“æµç¨‹æ—¶è°ˆåˆ°è¿‡ï¼Œé“¾æ¥å¦‚ä¸‹<a href=/android/3rd-library/glide2/#33-engineload>Glide2-3.3-Engine.load</a>ã€‚<br> ä»æ³¨é‡Šå’Œä»£ç ä¸­æˆ‘ä»¬çŸ¥é“äº†ç¼“å­˜é¦–å…ˆä¼šåˆ¤æ–­activeçŠ¶æ€çš„resourceï¼Œç„¶åæ˜¯memory cacheï¼Œæœ€åå°±äº¤ç»™äº†jobã€‚é‚£ä¹ˆæ¯«æ— ç–‘é—®ï¼Œjobä¸­ä¼šè¿›è¡Œdisk cacheçš„è¯»æ“ä½œã€‚ </p> <p>åªè¦æ˜¯ç¼“å­˜ï¼Œå°±ç¦»ä¸å¼€Keyï¼Œæ‰€ä»¥å…ˆçœ‹çœ‹ä»active resourceå’Œmemory cacheä¸­å–ç¼“å­˜æ—¶çš„Keyâ€”â€”<code>EngineKey</code>çš„ç»„æˆæˆåˆ†ï¼š</p> <p><strong>EngineKey.java</strong></p> <figcaption>EngineKeyçš„ç»„æˆ</figcaption> <table> <thead> <tr> <th>ç»„æˆ</th> <th>æ³¨é‡Š</th> </tr> </thead> <tbody> <tr> <td>model</td> <td>loadçš„å‚æ•°</td> </tr> <tr> <td>signature</td> <td><code>BaseRequestOptions</code>çš„æˆå‘˜å˜é‡ï¼Œé»˜è®¤ä¼šæ˜¯<code>EmptySignature.obtain()</code><br>åœ¨åŠ è½½æœ¬åœ°resourceèµ„æºæ—¶ä¼šå˜æˆ<code>ApplicationVersionSignature.obtain(context)</code></td> </tr> <tr> <td>width<br>height</td> <td>å¦‚æœæ²¡æœ‰æŒ‡å®š<code>override(int size)</code>ï¼Œé‚£ä¹ˆå°†å¾—åˆ°viewçš„size</td> </tr> <tr> <td>transformations</td> <td>é»˜è®¤ä¼šåŸºäº<code>ImageView</code>çš„scaleTypeè®¾ç½®å¯¹åº”çš„å››ä¸ª<code>Transformation</code>ï¼›<br>å¦‚æœæŒ‡å®šäº†<code>transform</code>ï¼Œé‚£ä¹ˆå°±åŸºäºè¯¥å€¼è¿›è¡Œè®¾ç½®ï¼›<br>è¯¦è§<code>BaseRequestOptions.transform(Transformation, boolean)</code></td> </tr> <tr> <td>resourceClass</td> <td>è§£ç åçš„èµ„æºï¼Œå¦‚æœæ²¡æœ‰<code>asBitmap</code>ã€<code>asGif</code>ï¼Œä¸€èˆ¬ä¼šæ˜¯<code>Object</code></td> </tr> <tr> <td>transcodeClass</td> <td>æœ€ç»ˆè¦è½¬æ¢æˆçš„æ•°æ®ç±»å‹ï¼Œæ ¹æ®<code>as</code>æ–¹æ³•ç¡®å®šï¼ŒåŠ è½½æœ¬åœ°resæˆ–è€…ç½‘ç»œURLï¼Œéƒ½ä¼šè°ƒç”¨<code>asDrawable</code>ï¼Œæ‰€ä»¥ä¸º<code>Drawable</code></td> </tr> <tr> <td>options</td> <td>å¦‚æœæ²¡æœ‰è®¾ç½®è¿‡<code>transform</code>ï¼Œæ­¤å¤„ä¼šæ ¹æ®ImageViewçš„scaleTypeé»˜è®¤æŒ‡å®šä¸€ä¸ªKVï¼Œè¯¦è§ä¸Šä¸€æ–‡2.2èŠ‚</td> </tr> </tbody> </table> <p>æ˜¾ç„¶ï¼Œåœ¨å¤šæ¬¡åŠ è½½åŒä¸€ä¸ªmodelçš„è¿‡ç¨‹ä¸­ï¼Œå³ä½¿æœ‰ç¨è®¸æ”¹åŠ¨ï¼ˆæ¯”å¦‚Viewå®½é«˜ç­‰ï¼‰ï¼ŒGlideéƒ½ä¸ä¼šè®¤ä¸ºè¿™æ˜¯åŒä¸€ä¸ªKeyã€‚æ­¤å¤–ï¼Œå€¼å¾—ä¸€æçš„æ˜¯ï¼Œæ­¤Keyä»¥åŠå…¶ä»–çš„Keyè¦†ç›–<code>equals</code>ã€<code>hashCode()</code>ã€<code>toString()</code>æ–¹æ³•çš„å†™æ³•éå¸¸è§„èŒƒï¼Œè¯¦ç»†å¯è§<a href=/effective-java/chapter2/ >Effective-Java-ç¬¬8ã€9ã€10æ¡</a>ã€‚</p> <p>å›åˆ°<code>Engine.load</code>æ–¹æ³•ä¸­ï¼ŒactiveçŠ¶æ€çš„resourceå’Œmemory cacheçŠ¶æ€çš„èµ„æºå…¶å®éƒ½æ˜¯<code>DataSource.MEMORY_CACHE</code>çŠ¶æ€ï¼Œä»ç¼“å­˜åŠ è½½æˆåŠŸåçš„å›è°ƒä¸­å¯ä»¥çœ‹åˆ°ã€‚è€Œä¸”ï¼ŒåŠ è½½å‡ºæ¥çš„èµ„æºéƒ½æ˜¯<code>EngineResource</code>å¯¹è±¡ï¼Œè¯¥å¯¹è±¡çš„ç®¡ç†ç­–ç•¥é‡‡ç”¨äº†<a href=/jvm/java-gc/#321>å¼•ç”¨è®¡æ•°ç®—æ³•</a>ã€‚è¯¥ç®—æ³•çš„ç‰¹ç‚¹æ˜¯å®ç°ç®€å•ï¼Œåˆ¤å®šæ•ˆç‡ä¹Ÿå¾ˆé«˜ã€‚</p> <p><code>EngineResource</code>ç±»çš„å…³é”®ä»£ç å¦‚ä¸‹ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-15-1 name=__codelineno-15-1></a><a href=#__codelineno-15-1><span class=linenos data-linenos=" 1 "></span></a><span class=kd>class</span> <span class=nc>EngineResource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=kd>implements</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=p>{</span>
<a id=__codelineno-15-2 name=__codelineno-15-2></a><a href=#__codelineno-15-2><span class=linenos data-linenos=" 2 "></span></a>  <span class=kd>private</span> <span class=kd>final</span> <span class=kt>boolean</span> <span class=n>isCacheable</span><span class=p>;</span>
<a id=__codelineno-15-3 name=__codelineno-15-3></a><a href=#__codelineno-15-3><span class=linenos data-linenos=" 3 "></span></a>  <span class=kd>private</span> <span class=kd>final</span> <span class=kt>boolean</span> <span class=n>isRecyclable</span><span class=p>;</span>
<a id=__codelineno-15-4 name=__codelineno-15-4></a><a href=#__codelineno-15-4><span class=linenos data-linenos=" 4 "></span></a>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>resource</span><span class=p>;</span>
<a id=__codelineno-15-5 name=__codelineno-15-5></a><a href=#__codelineno-15-5><span class=linenos data-linenos=" 5 "></span></a>
<a id=__codelineno-15-6 name=__codelineno-15-6></a><a href=#__codelineno-15-6><span class=linenos data-linenos=" 6 "></span></a>  <span class=kd>private</span> <span class=n>ResourceListener</span> <span class=n>listener</span><span class=p>;</span>
<a id=__codelineno-15-7 name=__codelineno-15-7></a><a href=#__codelineno-15-7><span class=linenos data-linenos=" 7 "></span></a>  <span class=kd>private</span> <span class=n>Key</span> <span class=n>key</span><span class=p>;</span>
<a id=__codelineno-15-8 name=__codelineno-15-8></a><a href=#__codelineno-15-8><span class=linenos data-linenos=" 8 "></span></a>  <span class=kd>private</span> <span class=kt>int</span> <span class=n>acquired</span><span class=p>;</span>
<a id=__codelineno-15-9 name=__codelineno-15-9></a><a href=#__codelineno-15-9><span class=linenos data-linenos=" 9 "></span></a>  <span class=kd>private</span> <span class=kt>boolean</span> <span class=n>isRecycled</span><span class=p>;</span>
<a id=__codelineno-15-10 name=__codelineno-15-10></a><a href=#__codelineno-15-10><span class=linenos data-linenos="10 "></span></a>
<a id=__codelineno-15-11 name=__codelineno-15-11></a><a href=#__codelineno-15-11><span class=linenos data-linenos="11 "></span></a>  <span class=kd>interface</span> <span class=nc>ResourceListener</span> <span class=p>{</span>
<a id=__codelineno-15-12 name=__codelineno-15-12></a><a href=#__codelineno-15-12><span class=linenos data-linenos="12 "></span></a>    <span class=kt>void</span> <span class=nf>onResourceReleased</span><span class=p>(</span><span class=n>Key</span> <span class=n>key</span><span class=p>,</span> <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>resource</span><span class=p>);</span>
<a id=__codelineno-15-13 name=__codelineno-15-13></a><a href=#__codelineno-15-13><span class=linenos data-linenos="13 "></span></a>  <span class=p>}</span>
<a id=__codelineno-15-14 name=__codelineno-15-14></a><a href=#__codelineno-15-14><span class=linenos data-linenos="14 "></span></a>
<a id=__codelineno-15-15 name=__codelineno-15-15></a><a href=#__codelineno-15-15><span class=linenos data-linenos="15 "></span></a>  <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>setResourceListener</span><span class=p>(</span><span class=n>Key</span> <span class=n>key</span><span class=p>,</span> <span class=n>ResourceListener</span> <span class=n>listener</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-15-16 name=__codelineno-15-16></a><a href=#__codelineno-15-16><span class=linenos data-linenos="16 "></span></a>    <span class=k>this</span><span class=p>.</span><span class=na>key</span> <span class=o>=</span> <span class=n>key</span><span class=p>;</span>
<a id=__codelineno-15-17 name=__codelineno-15-17></a><a href=#__codelineno-15-17><span class=linenos data-linenos="17 "></span></a>    <span class=k>this</span><span class=p>.</span><span class=na>listener</span> <span class=o>=</span> <span class=n>listener</span><span class=p>;</span>
<a id=__codelineno-15-18 name=__codelineno-15-18></a><a href=#__codelineno-15-18><span class=linenos data-linenos="18 "></span></a>  <span class=p>}</span>
<a id=__codelineno-15-19 name=__codelineno-15-19></a><a href=#__codelineno-15-19><span class=linenos data-linenos="19 "></span></a>  <span class=p>...</span>
<a id=__codelineno-15-20 name=__codelineno-15-20></a><a href=#__codelineno-15-20><span class=linenos data-linenos="20 "></span></a>  <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>acquire</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-15-21 name=__codelineno-15-21></a><a href=#__codelineno-15-21><span class=linenos data-linenos="21 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>isRecycled</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-15-22 name=__codelineno-15-22></a><a href=#__codelineno-15-22><span class=linenos data-linenos="22 "></span></a>      <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&quot;Cannot acquire a recycled resource&quot;</span><span class=p>);</span>
<a id=__codelineno-15-23 name=__codelineno-15-23></a><a href=#__codelineno-15-23><span class=linenos data-linenos="23 "></span></a>    <span class=p>}</span>
<a id=__codelineno-15-24 name=__codelineno-15-24></a><a href=#__codelineno-15-24><span class=linenos data-linenos="24 "></span></a>    <span class=o>++</span><span class=n>acquired</span><span class=p>;</span>
<a id=__codelineno-15-25 name=__codelineno-15-25></a><a href=#__codelineno-15-25><span class=linenos data-linenos="25 "></span></a>  <span class=p>}</span>
<a id=__codelineno-15-26 name=__codelineno-15-26></a><a href=#__codelineno-15-26><span class=linenos data-linenos="26 "></span></a>
<a id=__codelineno-15-27 name=__codelineno-15-27></a><a href=#__codelineno-15-27><span class=linenos data-linenos="27 "></span></a>  <span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;SynchronizeOnNonFinalField&quot;</span><span class=p>)</span>
<a id=__codelineno-15-28 name=__codelineno-15-28></a><a href=#__codelineno-15-28><span class=linenos data-linenos="28 "></span></a>  <span class=kt>void</span> <span class=nf>release</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-15-29 name=__codelineno-15-29></a><a href=#__codelineno-15-29><span class=linenos data-linenos="29 "></span></a>    <span class=kd>synchronized</span> <span class=p>(</span><span class=n>listener</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-15-30 name=__codelineno-15-30></a><a href=#__codelineno-15-30><span class=linenos data-linenos="30 "></span></a>      <span class=kd>synchronized</span> <span class=p>(</span><span class=k>this</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-15-31 name=__codelineno-15-31></a><a href=#__codelineno-15-31><span class=linenos data-linenos="31 "></span></a>        <span class=k>if</span> <span class=p>(</span><span class=n>acquired</span> <span class=o>&lt;=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-15-32 name=__codelineno-15-32></a><a href=#__codelineno-15-32><span class=linenos data-linenos="32 "></span></a>          <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&quot;Cannot release a recycled or not yet acquired resource&quot;</span><span class=p>);</span>
<a id=__codelineno-15-33 name=__codelineno-15-33></a><a href=#__codelineno-15-33><span class=linenos data-linenos="33 "></span></a>        <span class=p>}</span>
<a id=__codelineno-15-34 name=__codelineno-15-34></a><a href=#__codelineno-15-34><span class=linenos data-linenos="34 "></span></a>        <span class=k>if</span> <span class=p>(</span><span class=o>--</span><span class=n>acquired</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-15-35 name=__codelineno-15-35></a><a href=#__codelineno-15-35><span class=linenos data-linenos="35 "></span></a>          <span class=n>listener</span><span class=p>.</span><span class=na>onResourceReleased</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=k>this</span><span class=p>);</span>
<a id=__codelineno-15-36 name=__codelineno-15-36></a><a href=#__codelineno-15-36><span class=linenos data-linenos="36 "></span></a>        <span class=p>}</span>
<a id=__codelineno-15-37 name=__codelineno-15-37></a><a href=#__codelineno-15-37><span class=linenos data-linenos="37 "></span></a>      <span class=p>}</span>
<a id=__codelineno-15-38 name=__codelineno-15-38></a><a href=#__codelineno-15-38><span class=linenos data-linenos="38 "></span></a>    <span class=p>}</span>
<a id=__codelineno-15-39 name=__codelineno-15-39></a><a href=#__codelineno-15-39><span class=linenos data-linenos="39 "></span></a>  <span class=p>}</span>
<a id=__codelineno-15-40 name=__codelineno-15-40></a><a href=#__codelineno-15-40><span class=linenos data-linenos="40 "></span></a>  <span class=p>...</span>
<a id=__codelineno-15-41 name=__codelineno-15-41></a><a href=#__codelineno-15-41><span class=linenos data-linenos="41 "></span></a><span class=p>}</span>
</code></pre></div> <p>åœ¨<code>release</code>åï¼Œå¦‚æœå¼•ç”¨è®¡æ•°ä¸º0ï¼Œé‚£ä¹ˆä¼šè°ƒç”¨<code>listener.onResourceReleased(key, this)</code>æ–¹æ³•é€šçŸ¥å¤–ç•Œæ­¤èµ„æºå·²ç»é‡Šæ”¾äº†ã€‚å®é™…ä¸Šï¼Œæ‰€æœ‰çš„listeneréƒ½æ˜¯<code>Engine</code>å¯¹è±¡ï¼Œåœ¨<code>Engine.onResourceReleased</code>æ–¹æ³•ä¸­ä¼šå°†æ­¤èµ„æºæ”¾å…¥memory cacheä¸­ï¼Œå¦‚æœå¯ä»¥è¢«ç¼“å­˜çš„è¯ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-16-1 name=__codelineno-16-1></a><a href=#__codelineno-16-1><span class=linenos data-linenos="1 "></span></a><span class=nd>@Override</span>
<a id=__codelineno-16-2 name=__codelineno-16-2></a><a href=#__codelineno-16-2><span class=linenos data-linenos="2 "></span></a><span class=kd>public</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>onResourceReleased</span><span class=p>(</span><span class=n>Key</span> <span class=n>cacheKey</span><span class=p>,</span> <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>resource</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-16-3 name=__codelineno-16-3></a><a href=#__codelineno-16-3><span class=linenos data-linenos="3 "></span></a>  <span class=n>activeResources</span><span class=p>.</span><span class=na>deactivate</span><span class=p>(</span><span class=n>cacheKey</span><span class=p>);</span>
<a id=__codelineno-16-4 name=__codelineno-16-4></a><a href=#__codelineno-16-4><span class=linenos data-linenos="4 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>resource</span><span class=p>.</span><span class=na>isCacheable</span><span class=p>())</span> <span class=p>{</span>
<a id=__codelineno-16-5 name=__codelineno-16-5></a><a href=#__codelineno-16-5><span class=linenos data-linenos="5 "></span></a>    <span class=n>cache</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>cacheKey</span><span class=p>,</span> <span class=n>resource</span><span class=p>);</span>
<a id=__codelineno-16-6 name=__codelineno-16-6></a><a href=#__codelineno-16-6><span class=linenos data-linenos="6 "></span></a>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
<a id=__codelineno-16-7 name=__codelineno-16-7></a><a href=#__codelineno-16-7><span class=linenos data-linenos="7 "></span></a>    <span class=n>resourceRecycler</span><span class=p>.</span><span class=na>recycle</span><span class=p>(</span><span class=n>resource</span><span class=p>);</span>
<a id=__codelineno-16-8 name=__codelineno-16-8></a><a href=#__codelineno-16-8><span class=linenos data-linenos="8 "></span></a>  <span class=p>}</span>
<a id=__codelineno-16-9 name=__codelineno-16-9></a><a href=#__codelineno-16-9><span class=linenos data-linenos="9 "></span></a><span class=p>}</span>
</code></pre></div> <p>äº†è§£äº†<code>EngineResource</code>ä¹‹åï¼Œåœ¨å›åˆ°<code>Engine.load</code>æ–¹æ³•ä¸­å¼€å§‹åˆ†æã€‚é¦–å…ˆæ˜¯ä»active resourceå’Œmemory cacheä¸­è¿›è¡ŒåŠ è½½çš„æ–¹æ³•ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-17-1 name=__codelineno-17-1></a><a href=#__codelineno-17-1><span class=linenos data-linenos=" 1 "></span></a><span class=nd>@Nullable</span>
<a id=__codelineno-17-2 name=__codelineno-17-2></a><a href=#__codelineno-17-2><span class=linenos data-linenos=" 2 "></span></a><span class=kd>private</span> <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>loadFromActiveResources</span><span class=p>(</span><span class=n>Key</span> <span class=n>key</span><span class=p>,</span> <span class=kt>boolean</span> <span class=n>isMemoryCacheable</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-17-3 name=__codelineno-17-3></a><a href=#__codelineno-17-3><span class=linenos data-linenos=" 3 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>isMemoryCacheable</span><span class=p>)</span> <span class=p>{</span>  <span class=c1>// âš ï¸</span>
<a id=__codelineno-17-4 name=__codelineno-17-4></a><a href=#__codelineno-17-4><span class=linenos data-linenos=" 4 "></span></a>    <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-17-5 name=__codelineno-17-5></a><a href=#__codelineno-17-5><span class=linenos data-linenos=" 5 "></span></a>  <span class=p>}</span>
<a id=__codelineno-17-6 name=__codelineno-17-6></a><a href=#__codelineno-17-6><span class=linenos data-linenos=" 6 "></span></a>  <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>active</span> <span class=o>=</span> <span class=n>activeResources</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
<a id=__codelineno-17-7 name=__codelineno-17-7></a><a href=#__codelineno-17-7><span class=linenos data-linenos=" 7 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>active</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-17-8 name=__codelineno-17-8></a><a href=#__codelineno-17-8><span class=linenos data-linenos=" 8 "></span></a>    <span class=n>active</span><span class=p>.</span><span class=na>acquire</span><span class=p>();</span>
<a id=__codelineno-17-9 name=__codelineno-17-9></a><a href=#__codelineno-17-9><span class=linenos data-linenos=" 9 "></span></a>  <span class=p>}</span>
<a id=__codelineno-17-10 name=__codelineno-17-10></a><a href=#__codelineno-17-10><span class=linenos data-linenos="10 "></span></a>
<a id=__codelineno-17-11 name=__codelineno-17-11></a><a href=#__codelineno-17-11><span class=linenos data-linenos="11 "></span></a>  <span class=k>return</span> <span class=n>active</span><span class=p>;</span>
<a id=__codelineno-17-12 name=__codelineno-17-12></a><a href=#__codelineno-17-12><span class=linenos data-linenos="12 "></span></a><span class=p>}</span>
<a id=__codelineno-17-13 name=__codelineno-17-13></a><a href=#__codelineno-17-13><span class=linenos data-linenos="13 "></span></a>
<a id=__codelineno-17-14 name=__codelineno-17-14></a><a href=#__codelineno-17-14><span class=linenos data-linenos="14 "></span></a><span class=kd>private</span> <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>loadFromCache</span><span class=p>(</span><span class=n>Key</span> <span class=n>key</span><span class=p>,</span> <span class=kt>boolean</span> <span class=n>isMemoryCacheable</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-17-15 name=__codelineno-17-15></a><a href=#__codelineno-17-15><span class=linenos data-linenos="15 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>isMemoryCacheable</span><span class=p>)</span> <span class=p>{</span>  <span class=c1>// âš ï¸</span>
<a id=__codelineno-17-16 name=__codelineno-17-16></a><a href=#__codelineno-17-16><span class=linenos data-linenos="16 "></span></a>    <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-17-17 name=__codelineno-17-17></a><a href=#__codelineno-17-17><span class=linenos data-linenos="17 "></span></a>  <span class=p>}</span>
<a id=__codelineno-17-18 name=__codelineno-17-18></a><a href=#__codelineno-17-18><span class=linenos data-linenos="18 "></span></a>
<a id=__codelineno-17-19 name=__codelineno-17-19></a><a href=#__codelineno-17-19><span class=linenos data-linenos="19 "></span></a>  <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>cached</span> <span class=o>=</span> <span class=n>getEngineResourceFromCache</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
<a id=__codelineno-17-20 name=__codelineno-17-20></a><a href=#__codelineno-17-20><span class=linenos data-linenos="20 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>cached</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-17-21 name=__codelineno-17-21></a><a href=#__codelineno-17-21><span class=linenos data-linenos="21 "></span></a>    <span class=n>cached</span><span class=p>.</span><span class=na>acquire</span><span class=p>();</span>
<a id=__codelineno-17-22 name=__codelineno-17-22></a><a href=#__codelineno-17-22><span class=linenos data-linenos="22 "></span></a>    <span class=n>activeResources</span><span class=p>.</span><span class=na>activate</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>cached</span><span class=p>);</span>
<a id=__codelineno-17-23 name=__codelineno-17-23></a><a href=#__codelineno-17-23><span class=linenos data-linenos="23 "></span></a>  <span class=p>}</span>
<a id=__codelineno-17-24 name=__codelineno-17-24></a><a href=#__codelineno-17-24><span class=linenos data-linenos="24 "></span></a>  <span class=k>return</span> <span class=n>cached</span><span class=p>;</span>
<a id=__codelineno-17-25 name=__codelineno-17-25></a><a href=#__codelineno-17-25><span class=linenos data-linenos="25 "></span></a><span class=p>}</span>
</code></pre></div> <p>è¿™é‡Œä¼šé¦–å…ˆåˆ¤æ–­<code>skipMemoryCache(true)</code>æ˜¯å¦è¿›è¡Œè¿‡è®¾ç½®ã€‚å¦‚æœè®¾ç½®è¿‡ï¼Œé‚£ä¹ˆä¸Šé¢çš„<code>isMemoryCacheable</code>å¯¹åº”å°±ä¼šä¸ºfalseï¼Œè¿›è€Œè¿™ä¸¤ä¸ªæ–¹æ³•ç›´æ¥ä¼šè¿”å›nullã€‚å¦åˆ™ï¼Œä¼šä»ç¼“å­˜ä¸­å°è¯•è¿›è¡ŒåŠ è½½ã€‚<br> åªè¦å‘½ä¸­äº†ç¼“å­˜ï¼Œé‚£ä¹ˆè¯¥èµ„æºçš„å¼•ç”¨è®¡æ•°å°±ä¼šåŠ ä¸€ã€‚è€Œä¸”ï¼Œå¦‚æœå‘½ä¸­çš„æ˜¯memory cacheï¼Œé‚£ä¹ˆæ­¤èµ„æºä¼šè¢«æé«˜åˆ°activeçŠ¶æ€ä¸­ã€‚<br> æ˜¾ç„¶ï¼Œç¬¬ä¸€æ¬¡è¿è¡Œçš„æ—¶å€™æ˜¯æ²¡æœ‰ä»»ä½•å†…å­˜ç¼“å­˜çš„ï¼Œç°åœ¨æ¥åˆ°äº†<code>DecodeJob</code>å’Œ<code>EngineJob</code>è¿™é‡Œã€‚è¿˜æ˜¯åœ¨å‰ä¸€ç¯‡æ–‡ç« ä¸­æåˆ°è¿‡ï¼Œ<code>DecoceJob</code>å®ç°äº†<code>Runnable</code>æ¥å£ï¼Œç„¶åä¼šè¢«<code>EngineJob.start</code>æ–¹æ³•æäº¤åˆ°å¯¹åº”çš„çº¿ç¨‹æ± ä¸­å»æ‰§è¡Œã€‚ </p> <p>æ‰€ä»¥ï¼Œç›´æ¥çœ‹<code>DecodeJob.run</code>æ–¹æ³•å’¯ï¼Œè¯¥æ–¹æ³•çœŸæ­£å®ç°æ˜¯<code>runWrapped</code>æ–¹æ³•ã€‚åœ¨æ­¤æ–¹æ³•ä¸­ï¼Œç”±äº<code>runReason</code>æ­¤æ—¶åˆå§‹åŒ–äº†ä¸ºäº†<code>RunReason.INITIALIZE</code>ï¼ŒåˆdiskCacheStrategyä¸ºé»˜è®¤ä¸º<code>DiskCacheStrategy.AUTOMATIC</code>ï¼Œä¸”æ²¡æœ‰è®¾ç½®è¿‡<code>onlyRetrieveFromCache(true)</code>ã€‚æ‰€ä»¥ï¼Œdecode dataçš„çŠ¶æ€ä¾æ¬¡ä¸º<code>INITIALIZE</code> -&gt; <code>RESOURCE_CACHE</code> -&gt; <code>DATA_CACHE</code> -&gt; <code>SOURCE</code> -&gt; <code>FINISHED</code>ã€‚å¯¹åº”çš„<code>DataFectcherGenerator</code>çš„listä¾æ¬¡ä¸º<code>ResourceCacheGenerator</code> -&gt; <code>DataCacheGenerator</code> -&gt; <code>SourceGenerator</code>ã€‚</p> <p><strong>DecodeJob.java</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-18-1 name=__codelineno-18-1></a><a href=#__codelineno-18-1><span class=linenos data-linenos=" 1 "></span></a><span class=kd>private</span> <span class=n>Stage</span> <span class=nf>getNextStage</span><span class=p>(</span><span class=n>Stage</span> <span class=n>current</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-18-2 name=__codelineno-18-2></a><a href=#__codelineno-18-2><span class=linenos data-linenos=" 2 "></span></a>  <span class=k>switch</span> <span class=p>(</span><span class=n>current</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-18-3 name=__codelineno-18-3></a><a href=#__codelineno-18-3><span class=linenos data-linenos=" 3 "></span></a>    <span class=k>case</span> <span class=n>INITIALIZE</span><span class=p>:</span>
<a id=__codelineno-18-4 name=__codelineno-18-4></a><a href=#__codelineno-18-4><span class=linenos data-linenos=" 4 "></span></a>      <span class=k>return</span> <span class=n>diskCacheStrategy</span><span class=p>.</span><span class=na>decodeCachedResource</span><span class=p>()</span>
<a id=__codelineno-18-5 name=__codelineno-18-5></a><a href=#__codelineno-18-5><span class=linenos data-linenos=" 5 "></span></a>          <span class=o>?</span> <span class=n>Stage</span><span class=p>.</span><span class=na>RESOURCE_CACHE</span> <span class=p>:</span> <span class=n>getNextStage</span><span class=p>(</span><span class=n>Stage</span><span class=p>.</span><span class=na>RESOURCE_CACHE</span><span class=p>);</span>
<a id=__codelineno-18-6 name=__codelineno-18-6></a><a href=#__codelineno-18-6><span class=linenos data-linenos=" 6 "></span></a>    <span class=k>case</span> <span class=n>RESOURCE_CACHE</span><span class=p>:</span>
<a id=__codelineno-18-7 name=__codelineno-18-7></a><a href=#__codelineno-18-7><span class=linenos data-linenos=" 7 "></span></a>      <span class=k>return</span> <span class=n>diskCacheStrategy</span><span class=p>.</span><span class=na>decodeCachedData</span><span class=p>()</span>
<a id=__codelineno-18-8 name=__codelineno-18-8></a><a href=#__codelineno-18-8><span class=linenos data-linenos=" 8 "></span></a>          <span class=o>?</span> <span class=n>Stage</span><span class=p>.</span><span class=na>DATA_CACHE</span> <span class=p>:</span> <span class=n>getNextStage</span><span class=p>(</span><span class=n>Stage</span><span class=p>.</span><span class=na>DATA_CACHE</span><span class=p>);</span>
<a id=__codelineno-18-9 name=__codelineno-18-9></a><a href=#__codelineno-18-9><span class=linenos data-linenos=" 9 "></span></a>    <span class=k>case</span> <span class=n>DATA_CACHE</span><span class=p>:</span>
<a id=__codelineno-18-10 name=__codelineno-18-10></a><a href=#__codelineno-18-10><span class=linenos data-linenos="10 "></span></a>      <span class=c1>// Skip loading from source if the user opted to only retrieve the resource from cache.</span>
<a id=__codelineno-18-11 name=__codelineno-18-11></a><a href=#__codelineno-18-11><span class=linenos data-linenos="11 "></span></a>      <span class=k>return</span> <span class=n>onlyRetrieveFromCache</span> <span class=o>?</span> <span class=n>Stage</span><span class=p>.</span><span class=na>FINISHED</span> <span class=p>:</span> <span class=n>Stage</span><span class=p>.</span><span class=na>SOURCE</span><span class=p>;</span>
<a id=__codelineno-18-12 name=__codelineno-18-12></a><a href=#__codelineno-18-12><span class=linenos data-linenos="12 "></span></a>    <span class=k>case</span> <span class=n>SOURCE</span><span class=p>:</span>
<a id=__codelineno-18-13 name=__codelineno-18-13></a><a href=#__codelineno-18-13><span class=linenos data-linenos="13 "></span></a>    <span class=k>case</span> <span class=n>FINISHED</span><span class=p>:</span>
<a id=__codelineno-18-14 name=__codelineno-18-14></a><a href=#__codelineno-18-14><span class=linenos data-linenos="14 "></span></a>      <span class=k>return</span> <span class=n>Stage</span><span class=p>.</span><span class=na>FINISHED</span><span class=p>;</span>
<a id=__codelineno-18-15 name=__codelineno-18-15></a><a href=#__codelineno-18-15><span class=linenos data-linenos="15 "></span></a>    <span class=k>default</span><span class=p>:</span>
<a id=__codelineno-18-16 name=__codelineno-18-16></a><a href=#__codelineno-18-16><span class=linenos data-linenos="16 "></span></a>      <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&quot;Unrecognized stage: &quot;</span> <span class=o>+</span> <span class=n>current</span><span class=p>);</span>
<a id=__codelineno-18-17 name=__codelineno-18-17></a><a href=#__codelineno-18-17><span class=linenos data-linenos="17 "></span></a>  <span class=p>}</span>
<a id=__codelineno-18-18 name=__codelineno-18-18></a><a href=#__codelineno-18-18><span class=linenos data-linenos="18 "></span></a><span class=p>}</span>
<a id=__codelineno-18-19 name=__codelineno-18-19></a><a href=#__codelineno-18-19><span class=linenos data-linenos="19 "></span></a>
<a id=__codelineno-18-20 name=__codelineno-18-20></a><a href=#__codelineno-18-20><span class=linenos data-linenos="20 "></span></a><span class=kd>private</span> <span class=n>DataFetcherGenerator</span> <span class=nf>getNextGenerator</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-18-21 name=__codelineno-18-21></a><a href=#__codelineno-18-21><span class=linenos data-linenos="21 "></span></a>  <span class=k>switch</span> <span class=p>(</span><span class=n>stage</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-18-22 name=__codelineno-18-22></a><a href=#__codelineno-18-22><span class=linenos data-linenos="22 "></span></a>    <span class=k>case</span> <span class=n>RESOURCE_CACHE</span><span class=p>:</span>
<a id=__codelineno-18-23 name=__codelineno-18-23></a><a href=#__codelineno-18-23><span class=linenos data-linenos="23 "></span></a>      <span class=k>return</span> <span class=k>new</span> <span class=n>ResourceCacheGenerator</span><span class=p>(</span><span class=n>decodeHelper</span><span class=p>,</span> <span class=k>this</span><span class=p>);</span>
<a id=__codelineno-18-24 name=__codelineno-18-24></a><a href=#__codelineno-18-24><span class=linenos data-linenos="24 "></span></a>    <span class=k>case</span> <span class=n>DATA_CACHE</span><span class=p>:</span>
<a id=__codelineno-18-25 name=__codelineno-18-25></a><a href=#__codelineno-18-25><span class=linenos data-linenos="25 "></span></a>      <span class=k>return</span> <span class=k>new</span> <span class=n>DataCacheGenerator</span><span class=p>(</span><span class=n>decodeHelper</span><span class=p>,</span> <span class=k>this</span><span class=p>);</span>
<a id=__codelineno-18-26 name=__codelineno-18-26></a><a href=#__codelineno-18-26><span class=linenos data-linenos="26 "></span></a>    <span class=k>case</span> <span class=n>SOURCE</span><span class=p>:</span>
<a id=__codelineno-18-27 name=__codelineno-18-27></a><a href=#__codelineno-18-27><span class=linenos data-linenos="27 "></span></a>      <span class=k>return</span> <span class=k>new</span> <span class=n>SourceGenerator</span><span class=p>(</span><span class=n>decodeHelper</span><span class=p>,</span> <span class=k>this</span><span class=p>);</span>
<a id=__codelineno-18-28 name=__codelineno-18-28></a><a href=#__codelineno-18-28><span class=linenos data-linenos="28 "></span></a>    <span class=k>case</span> <span class=n>FINISHED</span><span class=p>:</span>
<a id=__codelineno-18-29 name=__codelineno-18-29></a><a href=#__codelineno-18-29><span class=linenos data-linenos="29 "></span></a>      <span class=k>return</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-18-30 name=__codelineno-18-30></a><a href=#__codelineno-18-30><span class=linenos data-linenos="30 "></span></a>    <span class=k>default</span><span class=p>:</span>
<a id=__codelineno-18-31 name=__codelineno-18-31></a><a href=#__codelineno-18-31><span class=linenos data-linenos="31 "></span></a>      <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalStateException</span><span class=p>(</span><span class=s>&quot;Unrecognized stage: &quot;</span> <span class=o>+</span> <span class=n>stage</span><span class=p>);</span>
<a id=__codelineno-18-32 name=__codelineno-18-32></a><a href=#__codelineno-18-32><span class=linenos data-linenos="32 "></span></a>  <span class=p>}</span>
<a id=__codelineno-18-33 name=__codelineno-18-33></a><a href=#__codelineno-18-33><span class=linenos data-linenos="33 "></span></a><span class=p>}</span>
<a id=__codelineno-18-34 name=__codelineno-18-34></a><a href=#__codelineno-18-34><span class=linenos data-linenos="34 "></span></a>
<a id=__codelineno-18-35 name=__codelineno-18-35></a><a href=#__codelineno-18-35><span class=linenos data-linenos="35 "></span></a><span class=kd>private</span> <span class=kt>void</span> <span class=nf>runGenerators</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-18-36 name=__codelineno-18-36></a><a href=#__codelineno-18-36><span class=linenos data-linenos="36 "></span></a>  <span class=n>currentThread</span> <span class=o>=</span> <span class=n>Thread</span><span class=p>.</span><span class=na>currentThread</span><span class=p>();</span>
<a id=__codelineno-18-37 name=__codelineno-18-37></a><a href=#__codelineno-18-37><span class=linenos data-linenos="37 "></span></a>  <span class=n>startFetchTime</span> <span class=o>=</span> <span class=n>LogTime</span><span class=p>.</span><span class=na>getLogTime</span><span class=p>();</span>
<a id=__codelineno-18-38 name=__codelineno-18-38></a><a href=#__codelineno-18-38><span class=linenos data-linenos="38 "></span></a>  <span class=kt>boolean</span> <span class=n>isStarted</span> <span class=o>=</span> <span class=kc>false</span><span class=p>;</span>
<a id=__codelineno-18-39 name=__codelineno-18-39></a><a href=#__codelineno-18-39><span class=linenos data-linenos="39 "></span></a>  <span class=k>while</span> <span class=p>(</span><span class=o>!</span><span class=n>isCancelled</span> <span class=o>&amp;&amp;</span> <span class=n>currentGenerator</span> <span class=o>!=</span> <span class=kc>null</span>
<a id=__codelineno-18-40 name=__codelineno-18-40></a><a href=#__codelineno-18-40><span class=linenos data-linenos="40 "></span></a>      <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=p>(</span><span class=n>isStarted</span> <span class=o>=</span> <span class=n>currentGenerator</span><span class=p>.</span><span class=na>startNext</span><span class=p>()))</span> <span class=p>{</span>
<a id=__codelineno-18-41 name=__codelineno-18-41></a><a href=#__codelineno-18-41><span class=linenos data-linenos="41 "></span></a>    <span class=n>stage</span> <span class=o>=</span> <span class=n>getNextStage</span><span class=p>(</span><span class=n>stage</span><span class=p>);</span>
<a id=__codelineno-18-42 name=__codelineno-18-42></a><a href=#__codelineno-18-42><span class=linenos data-linenos="42 "></span></a>    <span class=n>currentGenerator</span> <span class=o>=</span> <span class=n>getNextGenerator</span><span class=p>();</span>
<a id=__codelineno-18-43 name=__codelineno-18-43></a><a href=#__codelineno-18-43><span class=linenos data-linenos="43 "></span></a>
<a id=__codelineno-18-44 name=__codelineno-18-44></a><a href=#__codelineno-18-44><span class=linenos data-linenos="44 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>stage</span> <span class=o>==</span> <span class=n>Stage</span><span class=p>.</span><span class=na>SOURCE</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-18-45 name=__codelineno-18-45></a><a href=#__codelineno-18-45><span class=linenos data-linenos="45 "></span></a>      <span class=n>reschedule</span><span class=p>();</span>
<a id=__codelineno-18-46 name=__codelineno-18-46></a><a href=#__codelineno-18-46><span class=linenos data-linenos="46 "></span></a>      <span class=k>return</span><span class=p>;</span>
<a id=__codelineno-18-47 name=__codelineno-18-47></a><a href=#__codelineno-18-47><span class=linenos data-linenos="47 "></span></a>    <span class=p>}</span>
<a id=__codelineno-18-48 name=__codelineno-18-48></a><a href=#__codelineno-18-48><span class=linenos data-linenos="48 "></span></a>  <span class=p>}</span>
<a id=__codelineno-18-49 name=__codelineno-18-49></a><a href=#__codelineno-18-49><span class=linenos data-linenos="49 "></span></a>  <span class=c1>// We&#39;ve run out of stages and generators, give up.</span>
<a id=__codelineno-18-50 name=__codelineno-18-50></a><a href=#__codelineno-18-50><span class=linenos data-linenos="50 "></span></a>  <span class=k>if</span> <span class=p>((</span><span class=n>stage</span> <span class=o>==</span> <span class=n>Stage</span><span class=p>.</span><span class=na>FINISHED</span> <span class=o>||</span> <span class=n>isCancelled</span><span class=p>)</span> <span class=o>&amp;&amp;</span> <span class=o>!</span><span class=n>isStarted</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-18-51 name=__codelineno-18-51></a><a href=#__codelineno-18-51><span class=linenos data-linenos="51 "></span></a>    <span class=n>notifyFailed</span><span class=p>();</span>
<a id=__codelineno-18-52 name=__codelineno-18-52></a><a href=#__codelineno-18-52><span class=linenos data-linenos="52 "></span></a>  <span class=p>}</span>
<a id=__codelineno-18-53 name=__codelineno-18-53></a><a href=#__codelineno-18-53><span class=linenos data-linenos="53 "></span></a>
<a id=__codelineno-18-54 name=__codelineno-18-54></a><a href=#__codelineno-18-54><span class=linenos data-linenos="54 "></span></a>  <span class=c1>// Otherwise a generator started a new load and we expect to be called back in</span>
<a id=__codelineno-18-55 name=__codelineno-18-55></a><a href=#__codelineno-18-55><span class=linenos data-linenos="55 "></span></a>  <span class=c1>// onDataFetcherReady.</span>
<a id=__codelineno-18-56 name=__codelineno-18-56></a><a href=#__codelineno-18-56><span class=linenos data-linenos="56 "></span></a><span class=p>}</span>
</code></pre></div> <p>åœ¨å‰æ–‡ä¸­æˆ‘ä»¬çœ‹åˆ°è¿‡<code>ResourceCacheGenerator</code>å’Œ<code>DataCacheGenerator</code>çš„æºç ï¼ŒçŸ¥é“äº†å‰è€…è´Ÿè´£åœ¨cacheä¸­æŸ¥æ‰¾resourceèµ„æºï¼Œè€Œåè€…è´Ÿè´£dataèµ„æºã€‚<br> å½“åœ¨ä¸¤ä¸ªcache generatorä¸­éƒ½æ‰¾ä¸åˆ°æ—¶ï¼Œä¼šäº¤ç»™<code>SourceGenerator</code>ä»sourceä¸­è¿›è¡ŒåŠ è½½ã€‚æ­¤æ—¶ï¼Œå¯¹äºä¸€ä¸ªç½‘ç»œå›¾ç‰‡èµ„æºæ¥è¯´ï¼Œå°±æ˜¯åŠ è½½ç½‘ç»œå›¾ç‰‡ï¼›å¯¹äºæœ¬åœ°èµ„æºæ¥è¯´ï¼Œå°±æ˜¯åŠ è½½æœ¬åœ°èµ„æºã€‚</p> <p>é‚£ä¹ˆï¼Œresourceèµ„æºå’Œdataèµ„æºéƒ½æ˜¯ç£ç›˜ç¼“å­˜ä¸­çš„èµ„æºï¼Œå…¶åŒºåˆ«åœ¨å¼€å¤´çš„é‚£æ®µå®˜æ–¹æ–‡æ¡£ä¸­æœ‰è¯´åˆ°ï¼Œåœ¨ä¸‹é¢çš„åˆ†æä¸­æˆ‘ä»¬ä¼šçœ‹åˆ°çš„ã€‚</p> <p>å…ˆçœ‹çœ‹<code>ResourceCacheGenerator</code>ä¸­æŸ¥æ‰¾ç¼“å­˜æ—¶keyçš„ç»„æˆéƒ¨åˆ†ï¼š</p> <p><strong>ResourceCacheGenerator.java</strong> </p> <div class=highlight><pre><span></span><code><a id=__codelineno-19-1 name=__codelineno-19-1></a><a href=#__codelineno-19-1><span class=linenos data-linenos=" 1 "></span></a><span class=n>currentKey</span> <span class=o>=</span>
<a id=__codelineno-19-2 name=__codelineno-19-2></a><a href=#__codelineno-19-2><span class=linenos data-linenos=" 2 "></span></a>    <span class=k>new</span> <span class=n>ResourceCacheKey</span><span class=p>(</span>
<a id=__codelineno-19-3 name=__codelineno-19-3></a><a href=#__codelineno-19-3><span class=linenos data-linenos=" 3 "></span></a>        <span class=n>helper</span><span class=p>.</span><span class=na>getArrayPool</span><span class=p>(),</span>
<a id=__codelineno-19-4 name=__codelineno-19-4></a><a href=#__codelineno-19-4><span class=linenos data-linenos=" 4 "></span></a>        <span class=n>sourceId</span><span class=p>,</span>
<a id=__codelineno-19-5 name=__codelineno-19-5></a><a href=#__codelineno-19-5><span class=linenos data-linenos=" 5 "></span></a>        <span class=n>helper</span><span class=p>.</span><span class=na>getSignature</span><span class=p>(),</span>
<a id=__codelineno-19-6 name=__codelineno-19-6></a><a href=#__codelineno-19-6><span class=linenos data-linenos=" 6 "></span></a>        <span class=n>helper</span><span class=p>.</span><span class=na>getWidth</span><span class=p>(),</span>
<a id=__codelineno-19-7 name=__codelineno-19-7></a><a href=#__codelineno-19-7><span class=linenos data-linenos=" 7 "></span></a>        <span class=n>helper</span><span class=p>.</span><span class=na>getHeight</span><span class=p>(),</span>
<a id=__codelineno-19-8 name=__codelineno-19-8></a><a href=#__codelineno-19-8><span class=linenos data-linenos=" 8 "></span></a>        <span class=n>transformation</span><span class=p>,</span>
<a id=__codelineno-19-9 name=__codelineno-19-9></a><a href=#__codelineno-19-9><span class=linenos data-linenos=" 9 "></span></a>        <span class=n>resourceClass</span><span class=p>,</span>
<a id=__codelineno-19-10 name=__codelineno-19-10></a><a href=#__codelineno-19-10><span class=linenos data-linenos="10 "></span></a>        <span class=n>helper</span><span class=p>.</span><span class=na>getOptions</span><span class=p>());</span>
</code></pre></div> <figcaption>ResourceCacheGeneratorä¸­keyçš„ç»„æˆ</figcaption> <table> <thead> <tr> <th>ç»„æˆ</th> <th>æ³¨é‡Š</th> </tr> </thead> <tbody> <tr> <td>helper.getArrayPool()</td> <td><code>GlideBuilder.build</code>æ—¶åˆå§‹åŒ–ï¼Œé»˜è®¤ä¸º<code>LruArrayPool</code>ï¼›<em>ä½†ä¸å‚ä¸keyçš„<code>equals</code>æ–¹æ³•</em></td> </tr> <tr> <td>sourceId</td> <td>å¦‚æœè¯·æ±‚çš„æ˜¯URLï¼Œé‚£ä¹ˆæ­¤å¤„ä¼šæ˜¯ä¸€ä¸ª<code>GlideUrl</code></td> </tr> <tr> <td>helper.getSignature()</td> <td><code>BaseRequestOptions</code>çš„æˆå‘˜å˜é‡ï¼Œé»˜è®¤ä¼šæ˜¯<code>EmptySignature.obtain()</code><br>åœ¨åŠ è½½æœ¬åœ°resourceèµ„æºæ—¶ä¼šå˜æˆ<code>ApplicationVersionSignature.obtain(context)</code></td> </tr> <tr> <td>helper.getWidth()<br>helper.getHeight()</td> <td>å¦‚æœæ²¡æœ‰æŒ‡å®š<code>override(int size)</code>ï¼Œé‚£ä¹ˆå°†å¾—åˆ°viewçš„size</td> </tr> <tr> <td>transformation</td> <td>é»˜è®¤ä¼šæ ¹æ®<code>ImageView</code>çš„scaleTypeè®¾ç½®å¯¹åº”çš„<code>BitmapTransformation</code>ï¼›<br>å¦‚æœæŒ‡å®šäº†<code>transform</code>ï¼Œé‚£ä¹ˆå°±ä¼šæ˜¯æŒ‡å®šçš„å€¼</td> </tr> <tr> <td>resourceClass</td> <td>å¯ä»¥è¢«ç¼–ç æˆçš„èµ„æºç±»å‹ï¼Œæ¯”å¦‚<code>BitmapDrawable</code>ç­‰</td> </tr> <tr> <td>helper.getOptions()</td> <td>å¦‚æœæ²¡æœ‰è®¾ç½®è¿‡<code>transform</code>ï¼Œæ­¤å¤„ä¼šæ ¹æ®ImageViewçš„scaleTypeé»˜è®¤æŒ‡å®šä¸€ä¸ªKVï¼Œè¯¦è§ä¸Šä¸€æ–‡2.2èŠ‚</td> </tr> </tbody> </table> <p>åœ¨<code>ResourceCacheKey</code>ä¸­ï¼Œ<code>arrayPool</code>å¹¶æ²¡æœ‰å‚ä¸<code>equals</code>æ–¹æ³•ï¼Œæ‰€ä»¥åˆ¤æ–­ä¸¤ä¸ª<code>ResourceCacheKey</code>æ˜¯å¦ç›¸ç­‰åªéœ€è¦å…¶ä»–7ä¸ªå‚æ•°ã€‚</p> <p>ç„¶åçœ‹çœ‹<code>DataCacheGenerator</code>ä¸­Keyçš„ç»„æˆéƒ¨åˆ†ï¼š</p> <p><strong>DataCacheGenerator.java</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-20-1 name=__codelineno-20-1></a><a href=#__codelineno-20-1><span class=linenos data-linenos="1 "></span></a><span class=n>Key</span> <span class=n>originalKey</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DataCacheKey</span><span class=p>(</span><span class=n>sourceId</span><span class=p>,</span> <span class=n>helper</span><span class=p>.</span><span class=na>getSignature</span><span class=p>());</span>
</code></pre></div> <figcaption>DataCacheGeneratorä¸­keyçš„ç»„æˆ</figcaption> <table> <thead> <tr> <th>ç»„æˆ</th> <th>æ³¨é‡Š</th> </tr> </thead> <tbody> <tr> <td>sourceId</td> <td>å¦‚æœè¯·æ±‚çš„æ˜¯URLï¼Œé‚£ä¹ˆæ­¤å¤„ä¼šæ˜¯ä¸€ä¸ª<code>GlideUrl</code></td> </tr> <tr> <td>helper.getSignature()</td> <td><code>BaseRequestOptions</code>çš„æˆå‘˜å˜é‡ï¼Œé»˜è®¤ä¼šæ˜¯<code>EmptySignature.obtain()</code><br>åœ¨åŠ è½½æœ¬åœ°resourceèµ„æºæ—¶ä¼šå˜æˆ<code>ApplicationVersionSignature.obtain(context)</code></td> </tr> </tbody> </table> <p>åœ¨<code>DataCacheKey</code>ä¸­ï¼Œä»…æœ‰çš„ä¸¤ä¸ªå˜é‡éƒ½å‚ä¸äº†<code>equals</code>æ–¹æ³•ã€‚è¿™ä¸¤ä¸ªå˜é‡å°±æ˜¯ä¸Šé¢<code>ResourceCacheKey</code>ä¸­çš„ä¸¤ä¸ªå˜é‡ã€‚ </p> <p>æ˜¾ç„¶ï¼Œdata cacheå°±æ˜¯æ¯”è¾ƒåŸå§‹çš„æ•°æ®æ„æˆçš„ç¼“å­˜ï¼Œè€Œresource cacheæ˜¯è¢«è§£ç ã€è½¬æ¢åçš„data cacheï¼Œè¿™å°±å°è¯äº†æ–‡ç« å¼€å¤´çš„é‚£æ®µæ–‡æ¡£ã€‚ </p> <p>æ­¤å¤–ï¼Œæ–‡æ¡£ä¸­ç¼“å­˜ç¯‡è¿˜æœ‰å¾ˆå¤šå†…å®¹ï¼Œä¸‹é¢åœ¨ä¸Šä¸€ä»½å…³äºç¼“å­˜Keyçš„æè¿°ï¼Œè¿™å¯¹åº”æˆ‘ä»¬åœ¨ä¸Šé¢åˆ—è¿‡è¡¨æ ¼çš„<code>EngineKey</code>ã€<code>ResourceCacheKey</code>ä»¥åŠ<code>DataCacheKey</code>ã€‚</p> <blockquote> <p>In Glide 4, all cache keys contain at least two elements:<br> 1. The model the load is requested for (File, Uri, Url). If you are using a custom model, it needs to correctly implements hashCode() and equals() 2. An optional Signature </p> <p>In fact, the cache keys for steps 1-3 (Active resources, memory cache, resource disk cache) also include a number of other pieces of data including: 1. The width and height 2. The optional Transformation 3. Any added Options 4. The requested data type (Bitmap, GIF, etc)</p> <p>The keys used for active resources and the memory cache also differ slightly from those used from the resource disk cache to accomodate in memory Options like those that affect the configuration of the Bitmap or other decode time only parameters.<br> To generate the name of disk cache keys on disk, the individual elements of the keys are hashed to create a single String key, which is then used as the file name in the disk cache.<br> <cite><a href=http://bumptech.github.io/glide/doc/caching.html#cache-keys>Cache Keys</a></cite> </p> </blockquote> <p>çœ‹å®Œäº†ï¼Œå›åˆ°<code>ResourceCacheGenerator</code>ä¸­ï¼Œè¿™é‡Œä¼šç”¨<code>ResourceCacheKey</code>åœ¨ç£ç›˜ç¼“å­˜ä¸­è¿›è¡ŒæŸ¥æ‰¾ã€‚éš¾é“æˆ‘ä»¬ç”¨<code>ResourceCacheKey</code>çš„<code>toString()</code>æ–¹æ³•ä½œä¸ºkeyå—ï¼Ÿè‚¯å®šä¸æ˜¯ï¼Œå› ä¸ºè¿™æ ·ä¸å¤ŸSafeï¼Œæ‰€ä»¥æˆ‘ä»¬çœ‹çœ‹æºç ä¸­çš„SafeKeyæ˜¯å¦‚ä½•ç”Ÿæˆçš„ã€‚ä»£ç åœ¨<code>DiskLruCacheWrapper</code>ä¸­ï¼Œå°†åŸå§‹çš„Keyè½¬æ¢ä¸ºSafeKeyæ˜¯è¿™ä¸ªwrapperç±»çš„é‡è¦ä½œç”¨ä¹‹ä¸€ã€‚</p> <p><strong>DiskLruCacheWrapper.java</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-21-1 name=__codelineno-21-1></a><a href=#__codelineno-21-1><span class=linenos data-linenos=" 1 "></span></a><span class=nd>@Override</span>
<a id=__codelineno-21-2 name=__codelineno-21-2></a><a href=#__codelineno-21-2><span class=linenos data-linenos=" 2 "></span></a><span class=kd>public</span> <span class=n>File</span> <span class=nf>get</span><span class=p>(</span><span class=n>Key</span> <span class=n>key</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-21-3 name=__codelineno-21-3></a><a href=#__codelineno-21-3><span class=linenos data-linenos=" 3 "></span></a>  <span class=n>String</span> <span class=n>safeKey</span> <span class=o>=</span> <span class=n>safeKeyGenerator</span><span class=p>.</span><span class=na>getSafeKey</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
<a id=__codelineno-21-4 name=__codelineno-21-4></a><a href=#__codelineno-21-4><span class=linenos data-linenos=" 4 "></span></a>  <span class=p>...</span>
<a id=__codelineno-21-5 name=__codelineno-21-5></a><a href=#__codelineno-21-5><span class=linenos data-linenos=" 5 "></span></a>  <span class=n>File</span> <span class=n>result</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-21-6 name=__codelineno-21-6></a><a href=#__codelineno-21-6><span class=linenos data-linenos=" 6 "></span></a>  <span class=k>try</span> <span class=p>{</span>
<a id=__codelineno-21-7 name=__codelineno-21-7></a><a href=#__codelineno-21-7><span class=linenos data-linenos=" 7 "></span></a>    <span class=c1>// It is possible that the there will be a put in between these two gets. If so that shouldn&#39;t</span>
<a id=__codelineno-21-8 name=__codelineno-21-8></a><a href=#__codelineno-21-8><span class=linenos data-linenos=" 8 "></span></a>    <span class=c1>// be a problem because we will always put the same value at the same key so our input streams</span>
<a id=__codelineno-21-9 name=__codelineno-21-9></a><a href=#__codelineno-21-9><span class=linenos data-linenos=" 9 "></span></a>    <span class=c1>// will still represent the same data.</span>
<a id=__codelineno-21-10 name=__codelineno-21-10></a><a href=#__codelineno-21-10><span class=linenos data-linenos="10 "></span></a>    <span class=kd>final</span> <span class=n>DiskLruCache</span><span class=p>.</span><span class=na>Value</span> <span class=n>value</span> <span class=o>=</span> <span class=n>getDiskCache</span><span class=p>().</span><span class=na>get</span><span class=p>(</span><span class=n>safeKey</span><span class=p>);</span>
<a id=__codelineno-21-11 name=__codelineno-21-11></a><a href=#__codelineno-21-11><span class=linenos data-linenos="11 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>value</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-21-12 name=__codelineno-21-12></a><a href=#__codelineno-21-12><span class=linenos data-linenos="12 "></span></a>      <span class=n>result</span> <span class=o>=</span> <span class=n>value</span><span class=p>.</span><span class=na>getFile</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
<a id=__codelineno-21-13 name=__codelineno-21-13></a><a href=#__codelineno-21-13><span class=linenos data-linenos="13 "></span></a>    <span class=p>}</span>
<a id=__codelineno-21-14 name=__codelineno-21-14></a><a href=#__codelineno-21-14><span class=linenos data-linenos="14 "></span></a>  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>IOException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-21-15 name=__codelineno-21-15></a><a href=#__codelineno-21-15><span class=linenos data-linenos="15 "></span></a>    <span class=p>...</span>
<a id=__codelineno-21-16 name=__codelineno-21-16></a><a href=#__codelineno-21-16><span class=linenos data-linenos="16 "></span></a>  <span class=p>}</span>
<a id=__codelineno-21-17 name=__codelineno-21-17></a><a href=#__codelineno-21-17><span class=linenos data-linenos="17 "></span></a>  <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
<a id=__codelineno-21-18 name=__codelineno-21-18></a><a href=#__codelineno-21-18><span class=linenos data-linenos="18 "></span></a><span class=p>}</span>
</code></pre></div> <p>è¿™é‡Œè°ƒç”¨<code>SafeKeyGenerator</code>ç”Ÿæˆäº†ä¸€ä¸ªStringç±»å‹çš„SafeKeyï¼Œå®é™…ä¸Šå°±æ˜¯å¯¹åŸå§‹keyä¸­æ¯ä¸ªå­—æ®µéƒ½ä½¿ç”¨SHA-256åŠ å¯†ï¼Œç„¶åå°†å¾—åˆ°çš„å­—èŠ‚æ•°ç»„è½¬æ¢ä¸º16è¿›åˆ¶çš„å­—ç¬¦ä¸²ã€‚<code>SafeKeyGenerator</code>çš„ä»£ç å¾ˆç®€å•ï¼Œä¸ºäº†æ•ˆç‡è¿˜æ˜¯ä½¿ç”¨äº†ç¼“å­˜ä»¥åŠå¯¹è±¡æ± ğŸ‘ğŸ‘ğŸ‘ã€‚</p> <p><strong>SafeKeyGenerator.java</strong> </p> <div class=highlight><pre><span></span><code><a id=__codelineno-22-1 name=__codelineno-22-1></a><a href=#__codelineno-22-1><span class=linenos data-linenos=" 1 "></span></a><span class=kd>public</span> <span class=kd>class</span> <span class=nc>SafeKeyGenerator</span> <span class=p>{</span>
<a id=__codelineno-22-2 name=__codelineno-22-2></a><a href=#__codelineno-22-2><span class=linenos data-linenos=" 2 "></span></a>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>LruCache</span><span class=o>&lt;</span><span class=n>Key</span><span class=p>,</span> <span class=n>String</span><span class=o>&gt;</span> <span class=n>loadIdToSafeHash</span> <span class=o>=</span> <span class=k>new</span> <span class=n>LruCache</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=mi>1000</span><span class=p>);</span>
<a id=__codelineno-22-3 name=__codelineno-22-3></a><a href=#__codelineno-22-3><span class=linenos data-linenos=" 3 "></span></a>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>Pools</span><span class=p>.</span><span class=na>Pool</span><span class=o>&lt;</span><span class=n>PoolableDigestContainer</span><span class=o>&gt;</span> <span class=n>digestPool</span> <span class=o>=</span> <span class=n>FactoryPools</span><span class=p>.</span><span class=na>threadSafe</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span>
<a id=__codelineno-22-4 name=__codelineno-22-4></a><a href=#__codelineno-22-4><span class=linenos data-linenos=" 4 "></span></a>      <span class=k>new</span> <span class=n>FactoryPools</span><span class=p>.</span><span class=na>Factory</span><span class=o>&lt;</span><span class=n>PoolableDigestContainer</span><span class=o>&gt;</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-22-5 name=__codelineno-22-5></a><a href=#__codelineno-22-5><span class=linenos data-linenos=" 5 "></span></a>        <span class=nd>@Override</span>
<a id=__codelineno-22-6 name=__codelineno-22-6></a><a href=#__codelineno-22-6><span class=linenos data-linenos=" 6 "></span></a>        <span class=kd>public</span> <span class=n>PoolableDigestContainer</span> <span class=nf>create</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-22-7 name=__codelineno-22-7></a><a href=#__codelineno-22-7><span class=linenos data-linenos=" 7 "></span></a>          <span class=k>try</span> <span class=p>{</span>
<a id=__codelineno-22-8 name=__codelineno-22-8></a><a href=#__codelineno-22-8><span class=linenos data-linenos=" 8 "></span></a>            <span class=k>return</span> <span class=k>new</span> <span class=n>PoolableDigestContainer</span><span class=p>(</span><span class=n>MessageDigest</span><span class=p>.</span><span class=na>getInstance</span><span class=p>(</span><span class=s>&quot;SHA-256&quot;</span><span class=p>));</span>
<a id=__codelineno-22-9 name=__codelineno-22-9></a><a href=#__codelineno-22-9><span class=linenos data-linenos=" 9 "></span></a>          <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=n>NoSuchAlgorithmException</span> <span class=n>e</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-22-10 name=__codelineno-22-10></a><a href=#__codelineno-22-10><span class=linenos data-linenos="10 "></span></a>            <span class=k>throw</span> <span class=k>new</span> <span class=n>RuntimeException</span><span class=p>(</span><span class=n>e</span><span class=p>);</span>
<a id=__codelineno-22-11 name=__codelineno-22-11></a><a href=#__codelineno-22-11><span class=linenos data-linenos="11 "></span></a>          <span class=p>}</span>
<a id=__codelineno-22-12 name=__codelineno-22-12></a><a href=#__codelineno-22-12><span class=linenos data-linenos="12 "></span></a>        <span class=p>}</span>
<a id=__codelineno-22-13 name=__codelineno-22-13></a><a href=#__codelineno-22-13><span class=linenos data-linenos="13 "></span></a>      <span class=p>});</span>
<a id=__codelineno-22-14 name=__codelineno-22-14></a><a href=#__codelineno-22-14><span class=linenos data-linenos="14 "></span></a>
<a id=__codelineno-22-15 name=__codelineno-22-15></a><a href=#__codelineno-22-15><span class=linenos data-linenos="15 "></span></a>  <span class=kd>public</span> <span class=n>String</span> <span class=nf>getSafeKey</span><span class=p>(</span><span class=n>Key</span> <span class=n>key</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-22-16 name=__codelineno-22-16></a><a href=#__codelineno-22-16><span class=linenos data-linenos="16 "></span></a>    <span class=n>String</span> <span class=n>safeKey</span><span class=p>;</span>
<a id=__codelineno-22-17 name=__codelineno-22-17></a><a href=#__codelineno-22-17><span class=linenos data-linenos="17 "></span></a>    <span class=kd>synchronized</span> <span class=p>(</span><span class=n>loadIdToSafeHash</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-22-18 name=__codelineno-22-18></a><a href=#__codelineno-22-18><span class=linenos data-linenos="18 "></span></a>      <span class=n>safeKey</span> <span class=o>=</span> <span class=n>loadIdToSafeHash</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
<a id=__codelineno-22-19 name=__codelineno-22-19></a><a href=#__codelineno-22-19><span class=linenos data-linenos="19 "></span></a>    <span class=p>}</span>
<a id=__codelineno-22-20 name=__codelineno-22-20></a><a href=#__codelineno-22-20><span class=linenos data-linenos="20 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>safeKey</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-22-21 name=__codelineno-22-21></a><a href=#__codelineno-22-21><span class=linenos data-linenos="21 "></span></a>      <span class=n>safeKey</span> <span class=o>=</span> <span class=n>calculateHexStringDigest</span><span class=p>(</span><span class=n>key</span><span class=p>);</span>
<a id=__codelineno-22-22 name=__codelineno-22-22></a><a href=#__codelineno-22-22><span class=linenos data-linenos="22 "></span></a>    <span class=p>}</span>
<a id=__codelineno-22-23 name=__codelineno-22-23></a><a href=#__codelineno-22-23><span class=linenos data-linenos="23 "></span></a>    <span class=kd>synchronized</span> <span class=p>(</span><span class=n>loadIdToSafeHash</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-22-24 name=__codelineno-22-24></a><a href=#__codelineno-22-24><span class=linenos data-linenos="24 "></span></a>      <span class=n>loadIdToSafeHash</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>safeKey</span><span class=p>);</span>
<a id=__codelineno-22-25 name=__codelineno-22-25></a><a href=#__codelineno-22-25><span class=linenos data-linenos="25 "></span></a>    <span class=p>}</span>
<a id=__codelineno-22-26 name=__codelineno-22-26></a><a href=#__codelineno-22-26><span class=linenos data-linenos="26 "></span></a>    <span class=k>return</span> <span class=n>safeKey</span><span class=p>;</span>
<a id=__codelineno-22-27 name=__codelineno-22-27></a><a href=#__codelineno-22-27><span class=linenos data-linenos="27 "></span></a>  <span class=p>}</span>
<a id=__codelineno-22-28 name=__codelineno-22-28></a><a href=#__codelineno-22-28><span class=linenos data-linenos="28 "></span></a>
<a id=__codelineno-22-29 name=__codelineno-22-29></a><a href=#__codelineno-22-29><span class=linenos data-linenos="29 "></span></a>  <span class=kd>private</span> <span class=n>String</span> <span class=nf>calculateHexStringDigest</span><span class=p>(</span><span class=n>Key</span> <span class=n>key</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-22-30 name=__codelineno-22-30></a><a href=#__codelineno-22-30><span class=linenos data-linenos="30 "></span></a>    <span class=n>PoolableDigestContainer</span> <span class=n>container</span> <span class=o>=</span> <span class=n>Preconditions</span><span class=p>.</span><span class=na>checkNotNull</span><span class=p>(</span><span class=n>digestPool</span><span class=p>.</span><span class=na>acquire</span><span class=p>());</span>
<a id=__codelineno-22-31 name=__codelineno-22-31></a><a href=#__codelineno-22-31><span class=linenos data-linenos="31 "></span></a>    <span class=k>try</span> <span class=p>{</span>
<a id=__codelineno-22-32 name=__codelineno-22-32></a><a href=#__codelineno-22-32><span class=linenos data-linenos="32 "></span></a>      <span class=n>key</span><span class=p>.</span><span class=na>updateDiskCacheKey</span><span class=p>(</span><span class=n>container</span><span class=p>.</span><span class=na>messageDigest</span><span class=p>);</span>
<a id=__codelineno-22-33 name=__codelineno-22-33></a><a href=#__codelineno-22-33><span class=linenos data-linenos="33 "></span></a>      <span class=c1>// calling digest() will automatically reset()</span>
<a id=__codelineno-22-34 name=__codelineno-22-34></a><a href=#__codelineno-22-34><span class=linenos data-linenos="34 "></span></a>      <span class=k>return</span> <span class=n>Util</span><span class=p>.</span><span class=na>sha256BytesToHex</span><span class=p>(</span><span class=n>container</span><span class=p>.</span><span class=na>messageDigest</span><span class=p>.</span><span class=na>digest</span><span class=p>());</span>
<a id=__codelineno-22-35 name=__codelineno-22-35></a><a href=#__codelineno-22-35><span class=linenos data-linenos="35 "></span></a>    <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
<a id=__codelineno-22-36 name=__codelineno-22-36></a><a href=#__codelineno-22-36><span class=linenos data-linenos="36 "></span></a>      <span class=n>digestPool</span><span class=p>.</span><span class=na>release</span><span class=p>(</span><span class=n>container</span><span class=p>);</span>
<a id=__codelineno-22-37 name=__codelineno-22-37></a><a href=#__codelineno-22-37><span class=linenos data-linenos="37 "></span></a>    <span class=p>}</span>
<a id=__codelineno-22-38 name=__codelineno-22-38></a><a href=#__codelineno-22-38><span class=linenos data-linenos="38 "></span></a>  <span class=p>}</span>
<a id=__codelineno-22-39 name=__codelineno-22-39></a><a href=#__codelineno-22-39><span class=linenos data-linenos="39 "></span></a>
<a id=__codelineno-22-40 name=__codelineno-22-40></a><a href=#__codelineno-22-40><span class=linenos data-linenos="40 "></span></a>  <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>PoolableDigestContainer</span> <span class=kd>implements</span> <span class=n>FactoryPools</span><span class=p>.</span><span class=na>Poolable</span> <span class=p>{</span>
<a id=__codelineno-22-41 name=__codelineno-22-41></a><a href=#__codelineno-22-41><span class=linenos data-linenos="41 "></span></a>
<a id=__codelineno-22-42 name=__codelineno-22-42></a><a href=#__codelineno-22-42><span class=linenos data-linenos="42 "></span></a>    <span class=nd>@Synthetic</span> <span class=kd>final</span> <span class=n>MessageDigest</span> <span class=n>messageDigest</span><span class=p>;</span>
<a id=__codelineno-22-43 name=__codelineno-22-43></a><a href=#__codelineno-22-43><span class=linenos data-linenos="43 "></span></a>    <span class=kd>private</span> <span class=kd>final</span> <span class=n>StateVerifier</span> <span class=n>stateVerifier</span> <span class=o>=</span> <span class=n>StateVerifier</span><span class=p>.</span><span class=na>newInstance</span><span class=p>();</span>
<a id=__codelineno-22-44 name=__codelineno-22-44></a><a href=#__codelineno-22-44><span class=linenos data-linenos="44 "></span></a>
<a id=__codelineno-22-45 name=__codelineno-22-45></a><a href=#__codelineno-22-45><span class=linenos data-linenos="45 "></span></a>    <span class=n>PoolableDigestContainer</span><span class=p>(</span><span class=n>MessageDigest</span> <span class=n>messageDigest</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-22-46 name=__codelineno-22-46></a><a href=#__codelineno-22-46><span class=linenos data-linenos="46 "></span></a>      <span class=k>this</span><span class=p>.</span><span class=na>messageDigest</span> <span class=o>=</span> <span class=n>messageDigest</span><span class=p>;</span>
<a id=__codelineno-22-47 name=__codelineno-22-47></a><a href=#__codelineno-22-47><span class=linenos data-linenos="47 "></span></a>    <span class=p>}</span>
<a id=__codelineno-22-48 name=__codelineno-22-48></a><a href=#__codelineno-22-48><span class=linenos data-linenos="48 "></span></a>
<a id=__codelineno-22-49 name=__codelineno-22-49></a><a href=#__codelineno-22-49><span class=linenos data-linenos="49 "></span></a>    <span class=nd>@NonNull</span>
<a id=__codelineno-22-50 name=__codelineno-22-50></a><a href=#__codelineno-22-50><span class=linenos data-linenos="50 "></span></a>    <span class=nd>@Override</span>
<a id=__codelineno-22-51 name=__codelineno-22-51></a><a href=#__codelineno-22-51><span class=linenos data-linenos="51 "></span></a>    <span class=kd>public</span> <span class=n>StateVerifier</span> <span class=nf>getVerifier</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-22-52 name=__codelineno-22-52></a><a href=#__codelineno-22-52><span class=linenos data-linenos="52 "></span></a>      <span class=k>return</span> <span class=n>stateVerifier</span><span class=p>;</span>
<a id=__codelineno-22-53 name=__codelineno-22-53></a><a href=#__codelineno-22-53><span class=linenos data-linenos="53 "></span></a>    <span class=p>}</span>
<a id=__codelineno-22-54 name=__codelineno-22-54></a><a href=#__codelineno-22-54><span class=linenos data-linenos="54 "></span></a>  <span class=p>}</span>
<a id=__codelineno-22-55 name=__codelineno-22-55></a><a href=#__codelineno-22-55><span class=linenos data-linenos="55 "></span></a><span class=p>}</span>
</code></pre></div> <p>å¯ä»¥çœ‹åˆ°ï¼Œè¯¥ç±»çš„ä¸»è¦åŠŸèƒ½è½åœ¨äº†<code>calculateHexStringDigest</code>æ–¹æ³•ä¸Šï¼Œé¦–å…ˆä»å¯¹è±¡æ± ä¸­è·å–ä¸€ä¸ªæ¶ˆæ¯æ‘˜è¦å®¹å™¨<code>PoolableDigestContainer</code>ï¼Œç„¶åè°ƒç”¨<code>Key.updateDiskCacheKey(MessageDigest)</code>ç”Ÿæˆæ¶ˆæ¯æ‘˜è¦ï¼Œæœ€åè°ƒç”¨<code>Util.sha256BytesToHex</code>å°†å°†å¾—åˆ°çš„å­—èŠ‚æ•°ç»„è½¬æ¢ä¸º16è¿›åˆ¶çš„å­—ç¬¦ä¸²ã€‚ </p> <p>è¿™é‡Œæˆ‘ä»¬çœ‹ä¸€ä¸‹<code>ResourceCacheKey</code>çš„æ¶ˆæ¯æ‘˜è¦ç”Ÿæˆè¿‡ç¨‹ï¼Œå…¶ä¸­å…·ä½“å†…å®¹ä¸å±•å¼€äº†ï¼š</p> <p><strong>ResourceCacheKey.java</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-23-1 name=__codelineno-23-1></a><a href=#__codelineno-23-1><span class=linenos data-linenos=" 1 "></span></a><span class=nd>@Override</span>
<a id=__codelineno-23-2 name=__codelineno-23-2></a><a href=#__codelineno-23-2><span class=linenos data-linenos=" 2 "></span></a>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>updateDiskCacheKey</span><span class=p>(</span><span class=nd>@NonNull</span> <span class=n>MessageDigest</span> <span class=n>messageDigest</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-23-3 name=__codelineno-23-3></a><a href=#__codelineno-23-3><span class=linenos data-linenos=" 3 "></span></a>    <span class=kt>byte</span><span class=o>[]</span> <span class=n>dimensions</span> <span class=o>=</span> <span class=n>arrayPool</span><span class=p>.</span><span class=na>getExact</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=kt>byte</span><span class=o>[]</span><span class=p>.</span><span class=na>class</span><span class=p>);</span>
<a id=__codelineno-23-4 name=__codelineno-23-4></a><a href=#__codelineno-23-4><span class=linenos data-linenos=" 4 "></span></a>    <span class=n>ByteBuffer</span><span class=p>.</span><span class=na>wrap</span><span class=p>(</span><span class=n>dimensions</span><span class=p>).</span><span class=na>putInt</span><span class=p>(</span><span class=n>width</span><span class=p>).</span><span class=na>putInt</span><span class=p>(</span><span class=n>height</span><span class=p>).</span><span class=na>array</span><span class=p>();</span>
<a id=__codelineno-23-5 name=__codelineno-23-5></a><a href=#__codelineno-23-5><span class=linenos data-linenos=" 5 "></span></a>    <span class=n>signature</span><span class=p>.</span><span class=na>updateDiskCacheKey</span><span class=p>(</span><span class=n>messageDigest</span><span class=p>);</span>
<a id=__codelineno-23-6 name=__codelineno-23-6></a><a href=#__codelineno-23-6><span class=linenos data-linenos=" 6 "></span></a>    <span class=n>sourceKey</span><span class=p>.</span><span class=na>updateDiskCacheKey</span><span class=p>(</span><span class=n>messageDigest</span><span class=p>);</span>
<a id=__codelineno-23-7 name=__codelineno-23-7></a><a href=#__codelineno-23-7><span class=linenos data-linenos=" 7 "></span></a>    <span class=n>messageDigest</span><span class=p>.</span><span class=na>update</span><span class=p>(</span><span class=n>dimensions</span><span class=p>);</span>
<a id=__codelineno-23-8 name=__codelineno-23-8></a><a href=#__codelineno-23-8><span class=linenos data-linenos=" 8 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>transformation</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-23-9 name=__codelineno-23-9></a><a href=#__codelineno-23-9><span class=linenos data-linenos=" 9 "></span></a>      <span class=n>transformation</span><span class=p>.</span><span class=na>updateDiskCacheKey</span><span class=p>(</span><span class=n>messageDigest</span><span class=p>);</span>
<a id=__codelineno-23-10 name=__codelineno-23-10></a><a href=#__codelineno-23-10><span class=linenos data-linenos="10 "></span></a>    <span class=p>}</span>
<a id=__codelineno-23-11 name=__codelineno-23-11></a><a href=#__codelineno-23-11><span class=linenos data-linenos="11 "></span></a>    <span class=n>options</span><span class=p>.</span><span class=na>updateDiskCacheKey</span><span class=p>(</span><span class=n>messageDigest</span><span class=p>);</span>
<a id=__codelineno-23-12 name=__codelineno-23-12></a><a href=#__codelineno-23-12><span class=linenos data-linenos="12 "></span></a>    <span class=n>messageDigest</span><span class=p>.</span><span class=na>update</span><span class=p>(</span><span class=n>getResourceClassBytes</span><span class=p>());</span>
<a id=__codelineno-23-13 name=__codelineno-23-13></a><a href=#__codelineno-23-13><span class=linenos data-linenos="13 "></span></a>    <span class=n>arrayPool</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>dimensions</span><span class=p>);</span>
<a id=__codelineno-23-14 name=__codelineno-23-14></a><a href=#__codelineno-23-14><span class=linenos data-linenos="14 "></span></a>  <span class=p>}</span>
</code></pre></div> <p>å›æƒ³ä¸€ä¸‹è¡¨æ ¼------<em>ResourceCacheGeneratorä¸­keyçš„ç»„æˆ</em>ï¼Œè¡¨æ ¼ä¸­çš„å‚ä¸<code>equals</code>è¿ç®—çš„7ä¸ªéƒ¨åˆ†éƒ½å‚ä¸äº†æ¶ˆæ¯æ‘˜è¦çš„ç”Ÿæˆã€‚</p> <p>åœ¨è¿›ä¸€æ­¥å¤„ç†åï¼Œå¾—åˆ°äº†ä»¥æ¶ˆæ¯æ‘˜è¦çš„å­—ç¬¦ä¸²ä½œä¸ºkeyçš„SafeKeyï¼Œå¹¶ä»¥æ­¤åœ¨Disk Cacheä¸­è¿›è¡ŒæŸ¥è¯¢ï¼Œå¹¶å°†æŸ¥è¯¢ç»“æœä»¥<code>Value</code>å®ä½“è¿”å›å‡ºæ¥ï¼Œæœ€åä»<code>Value</code>ä¸­è·å–å¯¹åº”æ–‡ä»¶ï¼ŒDisk Cacheçš„getæ“ä½œå°±æ˜¯è¿™ä¹ˆä¸€ä¸ªæµç¨‹ã€‚</p> <p>å›åˆ°<code>ResourceCacheGenerator</code>ä¸­ï¼Œå¦‚æœç¡®å®æœ‰ç¼“å­˜ï¼Œé‚£ä¹ˆä¼šåŠ è½½è¯¥ç¼“å­˜æ–‡ä»¶ã€‚åœ¨å‰æ–‡çš„åˆ†æä¸­ï¼Œæˆ‘ä»¬çŸ¥é“å¯¹äºURLæ¥è¯´ï¼Œè°ƒç”¨äº†<code>ByteBufferFetcher</code>è¿›è¡Œç¼“å­˜æ–‡ä»¶çš„åŠ è½½ï¼ŒåŠ è½½æˆåŠŸäº†è¿”å›äº†ä¸€ä¸ª<code>ByteBuffer</code>ï¼Œå¹¶è°ƒç”¨äº†callbackä¹Ÿå°±æ˜¯<code>ResourceCacheGenerator</code>çš„<code>onDataReady</code>æ–¹æ³•ã€‚ç„¶å<code>ResourceCacheGenerator</code>åˆä¼šå›è°ƒ<code>DecodeJob</code>çš„<code>onDataFetcherReady</code>æ–¹æ³•è¿›è¡Œåç»­çš„è§£ç æ“ä½œã€‚</p> <p><strong>ResourceCacheGenerator.java</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-24-1 name=__codelineno-24-1></a><a href=#__codelineno-24-1><span class=linenos data-linenos="1 "></span></a><span class=nd>@Override</span>
<a id=__codelineno-24-2 name=__codelineno-24-2></a><a href=#__codelineno-24-2><span class=linenos data-linenos="2 "></span></a><span class=kd>public</span> <span class=kt>void</span> <span class=nf>onDataReady</span><span class=p>(</span><span class=n>Object</span> <span class=n>data</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-24-3 name=__codelineno-24-3></a><a href=#__codelineno-24-3><span class=linenos data-linenos="3 "></span></a>  <span class=n>cb</span><span class=p>.</span><span class=na>onDataFetcherReady</span><span class=p>(</span><span class=n>sourceKey</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>,</span> <span class=n>DataSource</span><span class=p>.</span><span class=na>RESOURCE_DISK_CACHE</span><span class=p>,</span>
<a id=__codelineno-24-4 name=__codelineno-24-4></a><a href=#__codelineno-24-4><span class=linenos data-linenos="4 "></span></a>      <span class=n>currentKey</span><span class=p>);</span>
<a id=__codelineno-24-5 name=__codelineno-24-5></a><a href=#__codelineno-24-5><span class=linenos data-linenos="5 "></span></a><span class=p>}</span>
</code></pre></div> <p>è¿™é‡Œå…ˆæŒ‰ä¸‹ä¸è¡¨ï¼Œå› ä¸ºåé¢<code>DataCacheGenerator</code>å’Œ<code>SourceGenerator</code>çš„æˆåŠŸå›è°ƒéƒ½ä¼šåˆ°è¿™é‡Œæ¥ã€‚æˆ‘ä»¬æš‚æ—¶åªéœ€è¦çœ‹ä¸€ä¸‹ä¸Šé¢å›è°ƒæ–¹æ³•çš„ä¸€äº›å‚æ•°å³å¯ã€‚</p> <p>å¦‚æœ<code>ResourceCacheGenerator</code>æ²¡æœ‰æ‰¾åˆ°ç¼“å­˜ï¼Œé‚£ä¹ˆå°±ä¼šäº¤ç»™<code>DataCacheGenerator</code>äº†ã€‚è¯¥ç±»å¤§ä½“æµç¨‹å’Œ<code>ResourceCacheGenerator</code>ä¸€æ ·ï¼Œæœ‰ç‚¹ä¸åŒçš„æ˜¯ï¼Œ<code>DataCacheGenerator</code>çš„æ„é€ å™¨æœ‰ä¸¤ä¸ªæ„é€ å™¨ï¼Œå…¶ä¸­çš„<code>DataCacheGenerator(List&lt;Key&gt;, DecodeHelper&lt;?&gt;, FetcherReadyCallback)</code>æ„é€ å™¨æ˜¯ç»™<code>SourceGenerator</code>å‡†å¤‡çš„ã€‚å› ä¸ºå¦‚æœæ²¡æœ‰ç£ç›˜ç¼“å­˜ï¼Œé‚£ä¹ˆä»æºå¤´åŠ è½½åï¼Œè‚¯å®šéœ€è¦è¿›è¡Œç£ç›˜ç¼“å­˜æ“ä½œçš„ã€‚æ‰€ä»¥ï¼Œ<code>SourceGenerator</code>ä¼šå°†åŠ è½½åçš„èµ„æºä¿å­˜åˆ°ç£ç›˜ä¸­ï¼Œç„¶åè½¬äº¤ç»™<code>DataCacheGenerator</code>ä»ç£ç›˜ä¸­å–å‡ºæ¥ã€‚ </p> <p><strong>DataCacheGenerator.java</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-25-1 name=__codelineno-25-1></a><a href=#__codelineno-25-1><span class=linenos data-linenos="1 "></span></a><span class=n>cb</span><span class=p>.</span><span class=na>onDataFetcherReady</span><span class=p>(</span><span class=n>sourceKey</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>,</span> <span class=n>DataSource</span><span class=p>.</span><span class=na>DATA_DISK_CACHE</span><span class=p>,</span> <span class=n>sourceKey</span><span class=p>);</span>
</code></pre></div> <p>å¦‚æœ<code>DataCacheGenerator</code>æ²¡æœ‰å–åˆ°ç¼“å­˜ï¼Œé‚£ä¹ˆä¼šäº¤ç»™<code>SourceGenerator</code>ä»æºå¤´åŠ è½½ã€‚åŠ è½½çš„è¿‡ç¨‹åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ä¹Ÿè¯´åˆ°è¿‡ï¼Œæˆ‘ä»¬ç›´æ¥ç•¥è¿‡ã€‚ç°åœ¨æ¥åˆ°äº†æˆåŠŸå›è°ƒ<code>onDataReady()</code>æ–¹æ³•ï¼š</p> <p><strong>SourceGenerator.java</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-26-1 name=__codelineno-26-1></a><a href=#__codelineno-26-1><span class=linenos data-linenos=" 1 "></span></a><span class=nd>@Override</span>
<a id=__codelineno-26-2 name=__codelineno-26-2></a><a href=#__codelineno-26-2><span class=linenos data-linenos=" 2 "></span></a><span class=kd>public</span> <span class=kt>void</span> <span class=nf>onDataReady</span><span class=p>(</span><span class=n>Object</span> <span class=n>data</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-26-3 name=__codelineno-26-3></a><a href=#__codelineno-26-3><span class=linenos data-linenos=" 3 "></span></a>  <span class=n>DiskCacheStrategy</span> <span class=n>diskCacheStrategy</span> <span class=o>=</span> <span class=n>helper</span><span class=p>.</span><span class=na>getDiskCacheStrategy</span><span class=p>();</span>
<a id=__codelineno-26-4 name=__codelineno-26-4></a><a href=#__codelineno-26-4><span class=linenos data-linenos=" 4 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>data</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>diskCacheStrategy</span><span class=p>.</span><span class=na>isDataCacheable</span><span class=p>(</span><span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>getDataSource</span><span class=p>()))</span> <span class=p>{</span>
<a id=__codelineno-26-5 name=__codelineno-26-5></a><a href=#__codelineno-26-5><span class=linenos data-linenos=" 5 "></span></a>    <span class=n>dataToCache</span> <span class=o>=</span> <span class=n>data</span><span class=p>;</span>
<a id=__codelineno-26-6 name=__codelineno-26-6></a><a href=#__codelineno-26-6><span class=linenos data-linenos=" 6 "></span></a>    <span class=c1>// We might be being called back on someone else&#39;s thread. Before doing anything, we should</span>
<a id=__codelineno-26-7 name=__codelineno-26-7></a><a href=#__codelineno-26-7><span class=linenos data-linenos=" 7 "></span></a>    <span class=c1>// reschedule to get back onto Glide&#39;s thread.</span>
<a id=__codelineno-26-8 name=__codelineno-26-8></a><a href=#__codelineno-26-8><span class=linenos data-linenos=" 8 "></span></a>    <span class=n>cb</span><span class=p>.</span><span class=na>reschedule</span><span class=p>();</span>
<a id=__codelineno-26-9 name=__codelineno-26-9></a><a href=#__codelineno-26-9><span class=linenos data-linenos=" 9 "></span></a>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
<a id=__codelineno-26-10 name=__codelineno-26-10></a><a href=#__codelineno-26-10><span class=linenos data-linenos="10 "></span></a>    <span class=n>cb</span><span class=p>.</span><span class=na>onDataFetcherReady</span><span class=p>(</span><span class=n>loadData</span><span class=p>.</span><span class=na>sourceKey</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>,</span>
<a id=__codelineno-26-11 name=__codelineno-26-11></a><a href=#__codelineno-26-11><span class=linenos data-linenos="11 "></span></a>        <span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>getDataSource</span><span class=p>(),</span> <span class=n>originalKey</span><span class=p>);</span>
<a id=__codelineno-26-12 name=__codelineno-26-12></a><a href=#__codelineno-26-12><span class=linenos data-linenos="12 "></span></a>  <span class=p>}</span>
<a id=__codelineno-26-13 name=__codelineno-26-13></a><a href=#__codelineno-26-13><span class=linenos data-linenos="13 "></span></a><span class=p>}</span>
</code></pre></div> <p>è¿™é‡Œé¦–å…ˆçœ‹ä¼šè·å–åˆ°çš„æ•°æ®æ˜¯å¦éœ€è¦è¿›è¡Œç£ç›˜ç¼“å­˜ï¼šå¦‚æœéœ€è¦ç£ç›˜ç¼“å­˜ï¼Œåˆ™ç»è¿‡<code>DecodeJob</code>ã€<code>EngineJob</code>çš„è°ƒåº¦ï¼Œé‡æ–°è°ƒç”¨<code>SourceGenerator.startNext</code>æ–¹æ³•ï¼Œè¿›è¡Œç£ç›˜ç¼“å­˜çš„å†™å…¥ï¼Œå¹¶è½¬äº¤ç»™<code>DataCacheGenerator</code>å®Œæˆåç»­çš„å¤„ç†ï¼›å¦åˆ™å°±é€šçŸ¥<code>DecodeJob</code>å·²ç»åŠ è½½æˆåŠŸäº†ã€‚ä¸¤ä¸ªè·¯å¾„è¿”å›ç»™<code>DecodeJob</code>çš„å›è°ƒä¸­ï¼ŒdataSourceéƒ½æ˜¯ç»Ÿä¸€çš„ï¼Œéƒ½æ˜¯æºå¤´çš„dataSourceã€‚</p> <p>ä¸¤ç§ä¸åŒè·¯å¾„çš„å›è°ƒå¦‚ä¸‹ï¼š</p> <p><strong>SourceGenerator.java</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-27-1 name=__codelineno-27-1></a><a href=#__codelineno-27-1><span class=linenos data-linenos=" 1 "></span></a><span class=c1>// ä¸éœ€è¦ç£ç›˜ç¼“å­˜çš„è·¯å¾„</span>
<a id=__codelineno-27-2 name=__codelineno-27-2></a><a href=#__codelineno-27-2><span class=linenos data-linenos=" 2 "></span></a><span class=nd>@Override</span>
<a id=__codelineno-27-3 name=__codelineno-27-3></a><a href=#__codelineno-27-3><span class=linenos data-linenos=" 3 "></span></a><span class=kd>public</span> <span class=kt>void</span> <span class=nf>onDataReady</span><span class=p>(</span><span class=n>Object</span> <span class=n>data</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-27-4 name=__codelineno-27-4></a><a href=#__codelineno-27-4><span class=linenos data-linenos=" 4 "></span></a>  <span class=p>...</span>
<a id=__codelineno-27-5 name=__codelineno-27-5></a><a href=#__codelineno-27-5><span class=linenos data-linenos=" 5 "></span></a>  <span class=k>if</span> <span class=p>(...)</span> <span class=p>{</span>
<a id=__codelineno-27-6 name=__codelineno-27-6></a><a href=#__codelineno-27-6><span class=linenos data-linenos=" 6 "></span></a>    <span class=p>...</span>
<a id=__codelineno-27-7 name=__codelineno-27-7></a><a href=#__codelineno-27-7><span class=linenos data-linenos=" 7 "></span></a>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
<a id=__codelineno-27-8 name=__codelineno-27-8></a><a href=#__codelineno-27-8><span class=linenos data-linenos=" 8 "></span></a>    <span class=n>cb</span><span class=p>.</span><span class=na>onDataFetcherReady</span><span class=p>(</span><span class=n>loadData</span><span class=p>.</span><span class=na>sourceKey</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>,</span>
<a id=__codelineno-27-9 name=__codelineno-27-9></a><a href=#__codelineno-27-9><span class=linenos data-linenos=" 9 "></span></a>        <span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>getDataSource</span><span class=p>(),</span> <span class=n>originalKey</span><span class=p>);</span>
<a id=__codelineno-27-10 name=__codelineno-27-10></a><a href=#__codelineno-27-10><span class=linenos data-linenos="10 "></span></a>  <span class=p>}</span>
<a id=__codelineno-27-11 name=__codelineno-27-11></a><a href=#__codelineno-27-11><span class=linenos data-linenos="11 "></span></a><span class=p>}</span>
<a id=__codelineno-27-12 name=__codelineno-27-12></a><a href=#__codelineno-27-12><span class=linenos data-linenos="12 "></span></a>
<a id=__codelineno-27-13 name=__codelineno-27-13></a><a href=#__codelineno-27-13><span class=linenos data-linenos="13 "></span></a><span class=c1>// éœ€è¦ç£ç›˜ç¼“å­˜çš„è·¯å¾„</span>
<a id=__codelineno-27-14 name=__codelineno-27-14></a><a href=#__codelineno-27-14><span class=linenos data-linenos="14 "></span></a><span class=nd>@Override</span>
<a id=__codelineno-27-15 name=__codelineno-27-15></a><a href=#__codelineno-27-15><span class=linenos data-linenos="15 "></span></a><span class=kd>public</span> <span class=kt>void</span> <span class=nf>onDataFetcherReady</span><span class=p>(</span><span class=n>Key</span> <span class=n>sourceKey</span><span class=p>,</span> <span class=n>Object</span> <span class=n>data</span><span class=p>,</span> <span class=n>DataFetcher</span><span class=o>&lt;?&gt;</span> <span class=n>fetcher</span><span class=p>,</span>
<a id=__codelineno-27-16 name=__codelineno-27-16></a><a href=#__codelineno-27-16><span class=linenos data-linenos="16 "></span></a>    <span class=n>DataSource</span> <span class=n>dataSource</span><span class=p>,</span> <span class=n>Key</span> <span class=n>attemptedKey</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-27-17 name=__codelineno-27-17></a><a href=#__codelineno-27-17><span class=linenos data-linenos="17 "></span></a>  <span class=c1>// This data fetcher will be loading from a File and provide the wrong data source, so override</span>
<a id=__codelineno-27-18 name=__codelineno-27-18></a><a href=#__codelineno-27-18><span class=linenos data-linenos="18 "></span></a>  <span class=c1>// with the data source of the original fetcher</span>
<a id=__codelineno-27-19 name=__codelineno-27-19></a><a href=#__codelineno-27-19><span class=linenos data-linenos="19 "></span></a>  <span class=n>cb</span><span class=p>.</span><span class=na>onDataFetcherReady</span><span class=p>(</span><span class=n>sourceKey</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>fetcher</span><span class=p>,</span> <span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>getDataSource</span><span class=p>(),</span> <span class=n>sourceKey</span><span class=p>);</span>
<a id=__codelineno-27-20 name=__codelineno-27-20></a><a href=#__codelineno-27-20><span class=linenos data-linenos="20 "></span></a><span class=p>}</span>
</code></pre></div> <p>ç£ç›˜ç¼“å­˜ç­–ç•¥é»˜è®¤æ˜¯<code>DiskCacheStrategy.AUTOMATIC</code>ï¼Œå…¶dataèµ„æºç¼“å­˜ç­–ç•¥åªç¼“å­˜è¿œç¨‹èµ„æºï¼Œä¹Ÿå°±æ˜¯URLè¿™ç§ï¼š</p> <p><strong>DiskCacheStrategy.AUTOMATIC</strong> <div class=highlight><pre><span></span><code><a id=__codelineno-28-1 name=__codelineno-28-1></a><a href=#__codelineno-28-1><span class=linenos data-linenos="1 "></span></a><span class=nd>@Override</span>
<a id=__codelineno-28-2 name=__codelineno-28-2></a><a href=#__codelineno-28-2><span class=linenos data-linenos="2 "></span></a><span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>isDataCacheable</span><span class=p>(</span><span class=n>DataSource</span> <span class=n>dataSource</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-28-3 name=__codelineno-28-3></a><a href=#__codelineno-28-3><span class=linenos data-linenos="3 "></span></a>  <span class=k>return</span> <span class=n>dataSource</span> <span class=o>==</span> <span class=n>DataSource</span><span class=p>.</span><span class=na>REMOTE</span><span class=p>;</span>
<a id=__codelineno-28-4 name=__codelineno-28-4></a><a href=#__codelineno-28-4><span class=linenos data-linenos="4 "></span></a><span class=p>}</span>
</code></pre></div></p> <p>åœ¨åŠ è½½çš„å°±æ˜¯URLçš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ç£ç›˜ç¼“å­˜å†™å…¥è¿‡ç¨‹çš„æµç¨‹ã€‚<br> é¦–å…ˆç»è¿‡<code>DecodeJob.reschedule()</code>è¿›è¡Œçº¿ç¨‹çš„è°ƒæ•´åï¼Œåˆå¼€å§‹äº†<code>startNext()</code>æ–¹æ³•ã€‚ç”±äºdataToCacheä¿å­˜äº†è·å–çš„åŸå§‹æ•°æ®ï¼Œæ‰€ä»¥ä¼šè°ƒç”¨<code>cacheData</code>æ–¹æ³•è¿›è¡Œç¼“å­˜ã€‚<code>cacheData</code>æ–¹æ³•å…ˆæ„å»ºäº†ä¸€ä¸ª<code>DataCacheKey</code>å°†dataå†™å…¥äº†ç£ç›˜ï¼Œç„¶ånewäº†ä¸€ä¸ª<code>DataCacheGenerator</code>ã€‚å›åˆ°<code>startNext()</code>æ–¹æ³•ï¼Œæ­¤æ—¶sourceCacheGeneratorä¸ä¸ºç©ºï¼Œå°±è°ƒç”¨å…¶<code>startNext()</code>æ–¹æ³•ä»çƒ­ä¹çš„ç£ç›˜ç¼“å­˜ä¸­è¿›è¡ŒåŠ è½½ï¼Œå¹¶è¿”å›äº†trueè®©<code>DecodeJob</code>åœæ­¢å°è¯•ã€‚</p> <p><strong>SourceGenerator.java</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-29-1 name=__codelineno-29-1></a><a href=#__codelineno-29-1><span class=linenos data-linenos=" 1 "></span></a><span class=nd>@Override</span>
<a id=__codelineno-29-2 name=__codelineno-29-2></a><a href=#__codelineno-29-2><span class=linenos data-linenos=" 2 "></span></a><span class=kd>public</span> <span class=kt>void</span> <span class=nf>onDataReady</span><span class=p>(</span><span class=n>Object</span> <span class=n>data</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-29-3 name=__codelineno-29-3></a><a href=#__codelineno-29-3><span class=linenos data-linenos=" 3 "></span></a>  <span class=n>DiskCacheStrategy</span> <span class=n>diskCacheStrategy</span> <span class=o>=</span> <span class=n>helper</span><span class=p>.</span><span class=na>getDiskCacheStrategy</span><span class=p>();</span>
<a id=__codelineno-29-4 name=__codelineno-29-4></a><a href=#__codelineno-29-4><span class=linenos data-linenos=" 4 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>data</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>diskCacheStrategy</span><span class=p>.</span><span class=na>isDataCacheable</span><span class=p>(</span><span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>getDataSource</span><span class=p>()))</span> <span class=p>{</span>
<a id=__codelineno-29-5 name=__codelineno-29-5></a><a href=#__codelineno-29-5><span class=linenos data-linenos=" 5 "></span></a>    <span class=n>dataToCache</span> <span class=o>=</span> <span class=n>data</span><span class=p>;</span>
<a id=__codelineno-29-6 name=__codelineno-29-6></a><a href=#__codelineno-29-6><span class=linenos data-linenos=" 6 "></span></a>    <span class=c1>// We might be being called back on someone else&#39;s thread. Before doing anything, we should</span>
<a id=__codelineno-29-7 name=__codelineno-29-7></a><a href=#__codelineno-29-7><span class=linenos data-linenos=" 7 "></span></a>    <span class=c1>// reschedule to get back onto Glide&#39;s thread.</span>
<a id=__codelineno-29-8 name=__codelineno-29-8></a><a href=#__codelineno-29-8><span class=linenos data-linenos=" 8 "></span></a>    <span class=n>cb</span><span class=p>.</span><span class=na>reschedule</span><span class=p>();</span>
<a id=__codelineno-29-9 name=__codelineno-29-9></a><a href=#__codelineno-29-9><span class=linenos data-linenos=" 9 "></span></a>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
<a id=__codelineno-29-10 name=__codelineno-29-10></a><a href=#__codelineno-29-10><span class=linenos data-linenos="10 "></span></a>    <span class=p>...</span>
<a id=__codelineno-29-11 name=__codelineno-29-11></a><a href=#__codelineno-29-11><span class=linenos data-linenos="11 "></span></a>  <span class=p>}</span>
<a id=__codelineno-29-12 name=__codelineno-29-12></a><a href=#__codelineno-29-12><span class=linenos data-linenos="12 "></span></a><span class=p>}</span>
<a id=__codelineno-29-13 name=__codelineno-29-13></a><a href=#__codelineno-29-13><span class=linenos data-linenos="13 "></span></a>
<a id=__codelineno-29-14 name=__codelineno-29-14></a><a href=#__codelineno-29-14><span class=linenos data-linenos="14 "></span></a><span class=nd>@Override</span>
<a id=__codelineno-29-15 name=__codelineno-29-15></a><a href=#__codelineno-29-15><span class=linenos data-linenos="15 "></span></a><span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>startNext</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-29-16 name=__codelineno-29-16></a><a href=#__codelineno-29-16><span class=linenos data-linenos="16 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>dataToCache</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-29-17 name=__codelineno-29-17></a><a href=#__codelineno-29-17><span class=linenos data-linenos="17 "></span></a>    <span class=n>Object</span> <span class=n>data</span> <span class=o>=</span> <span class=n>dataToCache</span><span class=p>;</span>
<a id=__codelineno-29-18 name=__codelineno-29-18></a><a href=#__codelineno-29-18><span class=linenos data-linenos="18 "></span></a>    <span class=n>dataToCache</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-29-19 name=__codelineno-29-19></a><a href=#__codelineno-29-19><span class=linenos data-linenos="19 "></span></a>    <span class=n>cacheData</span><span class=p>(</span><span class=n>data</span><span class=p>);</span>
<a id=__codelineno-29-20 name=__codelineno-29-20></a><a href=#__codelineno-29-20><span class=linenos data-linenos="20 "></span></a>  <span class=p>}</span>
<a id=__codelineno-29-21 name=__codelineno-29-21></a><a href=#__codelineno-29-21><span class=linenos data-linenos="21 "></span></a>
<a id=__codelineno-29-22 name=__codelineno-29-22></a><a href=#__codelineno-29-22><span class=linenos data-linenos="22 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>sourceCacheGenerator</span> <span class=o>!=</span> <span class=kc>null</span> <span class=o>&amp;&amp;</span> <span class=n>sourceCacheGenerator</span><span class=p>.</span><span class=na>startNext</span><span class=p>())</span> <span class=p>{</span>
<a id=__codelineno-29-23 name=__codelineno-29-23></a><a href=#__codelineno-29-23><span class=linenos data-linenos="23 "></span></a>    <span class=k>return</span> <span class=kc>true</span><span class=p>;</span>
<a id=__codelineno-29-24 name=__codelineno-29-24></a><a href=#__codelineno-29-24><span class=linenos data-linenos="24 "></span></a>  <span class=p>}</span>
<a id=__codelineno-29-25 name=__codelineno-29-25></a><a href=#__codelineno-29-25><span class=linenos data-linenos="25 "></span></a>  <span class=p>...</span>
<a id=__codelineno-29-26 name=__codelineno-29-26></a><a href=#__codelineno-29-26><span class=linenos data-linenos="26 "></span></a><span class=p>}</span>
<a id=__codelineno-29-27 name=__codelineno-29-27></a><a href=#__codelineno-29-27><span class=linenos data-linenos="27 "></span></a>
<a id=__codelineno-29-28 name=__codelineno-29-28></a><a href=#__codelineno-29-28><span class=linenos data-linenos="28 "></span></a><span class=kd>private</span> <span class=kt>void</span> <span class=nf>cacheData</span><span class=p>(</span><span class=n>Object</span> <span class=n>dataToCache</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-29-29 name=__codelineno-29-29></a><a href=#__codelineno-29-29><span class=linenos data-linenos="29 "></span></a>  <span class=k>try</span> <span class=p>{</span>
<a id=__codelineno-29-30 name=__codelineno-29-30></a><a href=#__codelineno-29-30><span class=linenos data-linenos="30 "></span></a>    <span class=n>Encoder</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>encoder</span> <span class=o>=</span> <span class=n>helper</span><span class=p>.</span><span class=na>getSourceEncoder</span><span class=p>(</span><span class=n>dataToCache</span><span class=p>);</span>
<a id=__codelineno-29-31 name=__codelineno-29-31></a><a href=#__codelineno-29-31><span class=linenos data-linenos="31 "></span></a>    <span class=n>DataCacheWriter</span><span class=o>&lt;</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>writer</span> <span class=o>=</span>
<a id=__codelineno-29-32 name=__codelineno-29-32></a><a href=#__codelineno-29-32><span class=linenos data-linenos="32 "></span></a>        <span class=k>new</span> <span class=n>DataCacheWriter</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>encoder</span><span class=p>,</span> <span class=n>dataToCache</span><span class=p>,</span> <span class=n>helper</span><span class=p>.</span><span class=na>getOptions</span><span class=p>());</span>
<a id=__codelineno-29-33 name=__codelineno-29-33></a><a href=#__codelineno-29-33><span class=linenos data-linenos="33 "></span></a>    <span class=n>originalKey</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DataCacheKey</span><span class=p>(</span><span class=n>loadData</span><span class=p>.</span><span class=na>sourceKey</span><span class=p>,</span> <span class=n>helper</span><span class=p>.</span><span class=na>getSignature</span><span class=p>());</span>
<a id=__codelineno-29-34 name=__codelineno-29-34></a><a href=#__codelineno-29-34><span class=linenos data-linenos="34 "></span></a>    <span class=n>helper</span><span class=p>.</span><span class=na>getDiskCache</span><span class=p>().</span><span class=na>put</span><span class=p>(</span><span class=n>originalKey</span><span class=p>,</span> <span class=n>writer</span><span class=p>);</span>
<a id=__codelineno-29-35 name=__codelineno-29-35></a><a href=#__codelineno-29-35><span class=linenos data-linenos="35 "></span></a>  <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
<a id=__codelineno-29-36 name=__codelineno-29-36></a><a href=#__codelineno-29-36><span class=linenos data-linenos="36 "></span></a>    <span class=n>loadData</span><span class=p>.</span><span class=na>fetcher</span><span class=p>.</span><span class=na>cleanup</span><span class=p>();</span>
<a id=__codelineno-29-37 name=__codelineno-29-37></a><a href=#__codelineno-29-37><span class=linenos data-linenos="37 "></span></a>  <span class=p>}</span>
<a id=__codelineno-29-38 name=__codelineno-29-38></a><a href=#__codelineno-29-38><span class=linenos data-linenos="38 "></span></a>
<a id=__codelineno-29-39 name=__codelineno-29-39></a><a href=#__codelineno-29-39><span class=linenos data-linenos="39 "></span></a>  <span class=n>sourceCacheGenerator</span> <span class=o>=</span>
<a id=__codelineno-29-40 name=__codelineno-29-40></a><a href=#__codelineno-29-40><span class=linenos data-linenos="40 "></span></a>      <span class=k>new</span> <span class=n>DataCacheGenerator</span><span class=p>(</span><span class=n>Collections</span><span class=p>.</span><span class=na>singletonList</span><span class=p>(</span><span class=n>loadData</span><span class=p>.</span><span class=na>sourceKey</span><span class=p>),</span> <span class=n>helper</span><span class=p>,</span> <span class=k>this</span><span class=p>);</span>
<a id=__codelineno-29-41 name=__codelineno-29-41></a><a href=#__codelineno-29-41><span class=linenos data-linenos="41 "></span></a><span class=p>}</span>
</code></pre></div> <p>æ— è®ºä¸Šé¢ä¸‰ä¸ª<code>DataFetcherGenerator</code>ä¹‹é—´æ€ä¹ˆæŠ˜è…¾ï¼Œç°åœ¨ç»ˆäºæˆåŠŸåŠ è½½åˆ°äº†æ•°æ®ã€‚æ‰€æœ‰ç¼“å­˜çš„è¯»ç¼“å­˜æ“ä½œä¹Ÿå·²ç»å®Œæˆï¼Œå‰©ä¸‹çš„éƒ½æ˜¯å†™ç¼“å­˜äº†ã€‚ </p> <p>ç»“ä¸‹æ¥è¡¨è¡¨ä¸Šé¢æŒ‰ä¸‹ä¸è¡¨çš„å†…å®¹ï¼Œå³<code>DecodeJob.onDataFetcherReady</code>æ–¹æ³•ã€‚è¯¥æ–¹æ³•å®Œæˆä¸¤ä¸ªäº‹æƒ…ï¼š</p> <ol> <li>å°†æ¯”è¾ƒåŸå§‹çš„dataæ•°æ®è½¬å˜ä¸ºå¯ä»¥ä¾›ImageViewæ˜¾ç¤ºçš„resourceæ•°æ®</li> <li>å°†resourceæ•°æ®æ˜¾ç¤ºå‡ºæ¥</li> </ol> <p>è¿™é‡Œé¢çš„æ¯è¡Œä»£ç çš„åˆ†æéƒ½åœ¨<a href=/android/3rd-library/glide2/#39-decodejobfetcherreadycallback>Glide2-3.9-DecodeJob.FetcherReadyCallback</a>ä¸­ï¼Œè¿™é‡Œåªè¯´ä¸€ä¸‹æ¶‰åŠåˆ°ç¼“å­˜çš„ä½ç½®ã€‚<br> åœ¨è¿‡ç¨‹1ä¸­ï¼Œå°†åŸå§‹data encodeæˆresourceæ•°æ®åï¼Œä¼šè°ƒç”¨<code>DecodeJob.onResourceDecoded</code>å¯¹resourceæ•°æ®è¿›è¡Œè¿›ä¸€æ­¥çš„å¤„ç†ã€‚<code>DecodeJob.onResourceDecoded</code>é¦–å…ˆä¼šå¯¹resourceè¿›è¡Œtransformï¼Œç„¶åå¯èƒ½ä¼šè¿›è¡Œç£ç›˜ç¼“å­˜ã€‚</p> <p><strong>DecodeJob.java</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-30-1 name=__codelineno-30-1></a><a href=#__codelineno-30-1><span class=linenos data-linenos=" 1 "></span></a><span class=nd>@Synthetic</span>
<a id=__codelineno-30-2 name=__codelineno-30-2></a><a href=#__codelineno-30-2><span class=linenos data-linenos=" 2 "></span></a><span class=nd>@NonNull</span>
<a id=__codelineno-30-3 name=__codelineno-30-3></a><a href=#__codelineno-30-3><span class=linenos data-linenos=" 3 "></span></a><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=nf>onResourceDecoded</span><span class=p>(</span><span class=n>DataSource</span> <span class=n>dataSource</span><span class=p>,</span>
<a id=__codelineno-30-4 name=__codelineno-30-4></a><a href=#__codelineno-30-4><span class=linenos data-linenos=" 4 "></span></a>    <span class=nd>@NonNull</span> <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>decoded</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-30-5 name=__codelineno-30-5></a><a href=#__codelineno-30-5><span class=linenos data-linenos=" 5 "></span></a>  <span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;unchecked&quot;</span><span class=p>)</span>
<a id=__codelineno-30-6 name=__codelineno-30-6></a><a href=#__codelineno-30-6><span class=linenos data-linenos=" 6 "></span></a>  <span class=n>Class</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>resourceSubClass</span> <span class=o>=</span> <span class=p>(</span><span class=n>Class</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span><span class=p>)</span> <span class=n>decoded</span><span class=p>.</span><span class=na>get</span><span class=p>().</span><span class=na>getClass</span><span class=p>();</span>
<a id=__codelineno-30-7 name=__codelineno-30-7></a><a href=#__codelineno-30-7><span class=linenos data-linenos=" 7 "></span></a>  <span class=n>Transformation</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>appliedTransformation</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-30-8 name=__codelineno-30-8></a><a href=#__codelineno-30-8><span class=linenos data-linenos=" 8 "></span></a>  <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>transformed</span> <span class=o>=</span> <span class=n>decoded</span><span class=p>;</span>
<a id=__codelineno-30-9 name=__codelineno-30-9></a><a href=#__codelineno-30-9><span class=linenos data-linenos=" 9 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>dataSource</span> <span class=o>!=</span> <span class=n>DataSource</span><span class=p>.</span><span class=na>RESOURCE_DISK_CACHE</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-30-10 name=__codelineno-30-10></a><a href=#__codelineno-30-10><span class=linenos data-linenos="10 "></span></a>    <span class=n>appliedTransformation</span> <span class=o>=</span> <span class=n>decodeHelper</span><span class=p>.</span><span class=na>getTransformation</span><span class=p>(</span><span class=n>resourceSubClass</span><span class=p>);</span>
<a id=__codelineno-30-11 name=__codelineno-30-11></a><a href=#__codelineno-30-11><span class=linenos data-linenos="11 "></span></a>    <span class=n>transformed</span> <span class=o>=</span> <span class=n>appliedTransformation</span><span class=p>.</span><span class=na>transform</span><span class=p>(</span><span class=n>glideContext</span><span class=p>,</span> <span class=n>decoded</span><span class=p>,</span> <span class=n>width</span><span class=p>,</span> <span class=n>height</span><span class=p>);</span>
<a id=__codelineno-30-12 name=__codelineno-30-12></a><a href=#__codelineno-30-12><span class=linenos data-linenos="12 "></span></a>  <span class=p>}</span>
<a id=__codelineno-30-13 name=__codelineno-30-13></a><a href=#__codelineno-30-13><span class=linenos data-linenos="13 "></span></a>  <span class=c1>// TODO: Make this the responsibility of the Transformation.</span>
<a id=__codelineno-30-14 name=__codelineno-30-14></a><a href=#__codelineno-30-14><span class=linenos data-linenos="14 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>decoded</span><span class=p>.</span><span class=na>equals</span><span class=p>(</span><span class=n>transformed</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-30-15 name=__codelineno-30-15></a><a href=#__codelineno-30-15><span class=linenos data-linenos="15 "></span></a>    <span class=n>decoded</span><span class=p>.</span><span class=na>recycle</span><span class=p>();</span>
<a id=__codelineno-30-16 name=__codelineno-30-16></a><a href=#__codelineno-30-16><span class=linenos data-linenos="16 "></span></a>  <span class=p>}</span>
<a id=__codelineno-30-17 name=__codelineno-30-17></a><a href=#__codelineno-30-17><span class=linenos data-linenos="17 "></span></a>
<a id=__codelineno-30-18 name=__codelineno-30-18></a><a href=#__codelineno-30-18><span class=linenos data-linenos="18 "></span></a>  <span class=kd>final</span> <span class=n>EncodeStrategy</span> <span class=n>encodeStrategy</span><span class=p>;</span>
<a id=__codelineno-30-19 name=__codelineno-30-19></a><a href=#__codelineno-30-19><span class=linenos data-linenos="19 "></span></a>  <span class=kd>final</span> <span class=n>ResourceEncoder</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>encoder</span><span class=p>;</span>
<a id=__codelineno-30-20 name=__codelineno-30-20></a><a href=#__codelineno-30-20><span class=linenos data-linenos="20 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>decodeHelper</span><span class=p>.</span><span class=na>isResourceEncoderAvailable</span><span class=p>(</span><span class=n>transformed</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-30-21 name=__codelineno-30-21></a><a href=#__codelineno-30-21><span class=linenos data-linenos="21 "></span></a>    <span class=n>encoder</span> <span class=o>=</span> <span class=n>decodeHelper</span><span class=p>.</span><span class=na>getResultEncoder</span><span class=p>(</span><span class=n>transformed</span><span class=p>);</span>
<a id=__codelineno-30-22 name=__codelineno-30-22></a><a href=#__codelineno-30-22><span class=linenos data-linenos="22 "></span></a>    <span class=n>encodeStrategy</span> <span class=o>=</span> <span class=n>encoder</span><span class=p>.</span><span class=na>getEncodeStrategy</span><span class=p>(</span><span class=n>options</span><span class=p>);</span>
<a id=__codelineno-30-23 name=__codelineno-30-23></a><a href=#__codelineno-30-23><span class=linenos data-linenos="23 "></span></a>  <span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
<a id=__codelineno-30-24 name=__codelineno-30-24></a><a href=#__codelineno-30-24><span class=linenos data-linenos="24 "></span></a>    <span class=n>encoder</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-30-25 name=__codelineno-30-25></a><a href=#__codelineno-30-25><span class=linenos data-linenos="25 "></span></a>    <span class=n>encodeStrategy</span> <span class=o>=</span> <span class=n>EncodeStrategy</span><span class=p>.</span><span class=na>NONE</span><span class=p>;</span>
<a id=__codelineno-30-26 name=__codelineno-30-26></a><a href=#__codelineno-30-26><span class=linenos data-linenos="26 "></span></a>  <span class=p>}</span>
<a id=__codelineno-30-27 name=__codelineno-30-27></a><a href=#__codelineno-30-27><span class=linenos data-linenos="27 "></span></a>
<a id=__codelineno-30-28 name=__codelineno-30-28></a><a href=#__codelineno-30-28><span class=linenos data-linenos="28 "></span></a>  <span class=n>Resource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=n>transformed</span><span class=p>;</span>
<a id=__codelineno-30-29 name=__codelineno-30-29></a><a href=#__codelineno-30-29><span class=linenos data-linenos="29 "></span></a>  <span class=kt>boolean</span> <span class=n>isFromAlternateCacheKey</span> <span class=o>=</span> <span class=o>!</span><span class=n>decodeHelper</span><span class=p>.</span><span class=na>isSourceKey</span><span class=p>(</span><span class=n>currentSourceKey</span><span class=p>);</span>
<a id=__codelineno-30-30 name=__codelineno-30-30></a><a href=#__codelineno-30-30><span class=linenos data-linenos="30 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>diskCacheStrategy</span><span class=p>.</span><span class=na>isResourceCacheable</span><span class=p>(</span><span class=n>isFromAlternateCacheKey</span><span class=p>,</span> <span class=n>dataSource</span><span class=p>,</span>
<a id=__codelineno-30-31 name=__codelineno-30-31></a><a href=#__codelineno-30-31><span class=linenos data-linenos="31 "></span></a>      <span class=n>encodeStrategy</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-30-32 name=__codelineno-30-32></a><a href=#__codelineno-30-32><span class=linenos data-linenos="32 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>encoder</span> <span class=o>==</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-30-33 name=__codelineno-30-33></a><a href=#__codelineno-30-33><span class=linenos data-linenos="33 "></span></a>      <span class=k>throw</span> <span class=k>new</span> <span class=n>Registry</span><span class=p>.</span><span class=na>NoResultEncoderAvailableException</span><span class=p>(</span><span class=n>transformed</span><span class=p>.</span><span class=na>get</span><span class=p>().</span><span class=na>getClass</span><span class=p>());</span>
<a id=__codelineno-30-34 name=__codelineno-30-34></a><a href=#__codelineno-30-34><span class=linenos data-linenos="34 "></span></a>    <span class=p>}</span>
<a id=__codelineno-30-35 name=__codelineno-30-35></a><a href=#__codelineno-30-35><span class=linenos data-linenos="35 "></span></a>    <span class=kd>final</span> <span class=n>Key</span> <span class=n>key</span><span class=p>;</span>
<a id=__codelineno-30-36 name=__codelineno-30-36></a><a href=#__codelineno-30-36><span class=linenos data-linenos="36 "></span></a>    <span class=k>switch</span> <span class=p>(</span><span class=n>encodeStrategy</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-30-37 name=__codelineno-30-37></a><a href=#__codelineno-30-37><span class=linenos data-linenos="37 "></span></a>      <span class=k>case</span> <span class=n>SOURCE</span><span class=p>:</span>
<a id=__codelineno-30-38 name=__codelineno-30-38></a><a href=#__codelineno-30-38><span class=linenos data-linenos="38 "></span></a>        <span class=n>key</span> <span class=o>=</span> <span class=k>new</span> <span class=n>DataCacheKey</span><span class=p>(</span><span class=n>currentSourceKey</span><span class=p>,</span> <span class=n>signature</span><span class=p>);</span>
<a id=__codelineno-30-39 name=__codelineno-30-39></a><a href=#__codelineno-30-39><span class=linenos data-linenos="39 "></span></a>        <span class=k>break</span><span class=p>;</span>
<a id=__codelineno-30-40 name=__codelineno-30-40></a><a href=#__codelineno-30-40><span class=linenos data-linenos="40 "></span></a>      <span class=k>case</span> <span class=n>TRANSFORMED</span><span class=p>:</span>
<a id=__codelineno-30-41 name=__codelineno-30-41></a><a href=#__codelineno-30-41><span class=linenos data-linenos="41 "></span></a>        <span class=n>key</span> <span class=o>=</span>
<a id=__codelineno-30-42 name=__codelineno-30-42></a><a href=#__codelineno-30-42><span class=linenos data-linenos="42 "></span></a>            <span class=k>new</span> <span class=n>ResourceCacheKey</span><span class=p>(</span>
<a id=__codelineno-30-43 name=__codelineno-30-43></a><a href=#__codelineno-30-43><span class=linenos data-linenos="43 "></span></a>                <span class=n>decodeHelper</span><span class=p>.</span><span class=na>getArrayPool</span><span class=p>(),</span>
<a id=__codelineno-30-44 name=__codelineno-30-44></a><a href=#__codelineno-30-44><span class=linenos data-linenos="44 "></span></a>                <span class=n>currentSourceKey</span><span class=p>,</span>
<a id=__codelineno-30-45 name=__codelineno-30-45></a><a href=#__codelineno-30-45><span class=linenos data-linenos="45 "></span></a>                <span class=n>signature</span><span class=p>,</span>
<a id=__codelineno-30-46 name=__codelineno-30-46></a><a href=#__codelineno-30-46><span class=linenos data-linenos="46 "></span></a>                <span class=n>width</span><span class=p>,</span>
<a id=__codelineno-30-47 name=__codelineno-30-47></a><a href=#__codelineno-30-47><span class=linenos data-linenos="47 "></span></a>                <span class=n>height</span><span class=p>,</span>
<a id=__codelineno-30-48 name=__codelineno-30-48></a><a href=#__codelineno-30-48><span class=linenos data-linenos="48 "></span></a>                <span class=n>appliedTransformation</span><span class=p>,</span>
<a id=__codelineno-30-49 name=__codelineno-30-49></a><a href=#__codelineno-30-49><span class=linenos data-linenos="49 "></span></a>                <span class=n>resourceSubClass</span><span class=p>,</span>
<a id=__codelineno-30-50 name=__codelineno-30-50></a><a href=#__codelineno-30-50><span class=linenos data-linenos="50 "></span></a>                <span class=n>options</span><span class=p>);</span>
<a id=__codelineno-30-51 name=__codelineno-30-51></a><a href=#__codelineno-30-51><span class=linenos data-linenos="51 "></span></a>        <span class=k>break</span><span class=p>;</span>
<a id=__codelineno-30-52 name=__codelineno-30-52></a><a href=#__codelineno-30-52><span class=linenos data-linenos="52 "></span></a>      <span class=k>default</span><span class=p>:</span>
<a id=__codelineno-30-53 name=__codelineno-30-53></a><a href=#__codelineno-30-53><span class=linenos data-linenos="53 "></span></a>        <span class=k>throw</span> <span class=k>new</span> <span class=n>IllegalArgumentException</span><span class=p>(</span><span class=s>&quot;Unknown strategy: &quot;</span> <span class=o>+</span> <span class=n>encodeStrategy</span><span class=p>);</span>
<a id=__codelineno-30-54 name=__codelineno-30-54></a><a href=#__codelineno-30-54><span class=linenos data-linenos="54 "></span></a>    <span class=p>}</span>
<a id=__codelineno-30-55 name=__codelineno-30-55></a><a href=#__codelineno-30-55><span class=linenos data-linenos="55 "></span></a>
<a id=__codelineno-30-56 name=__codelineno-30-56></a><a href=#__codelineno-30-56><span class=linenos data-linenos="56 "></span></a>    <span class=n>LockedResource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>lockedResult</span> <span class=o>=</span> <span class=n>LockedResource</span><span class=p>.</span><span class=na>obtain</span><span class=p>(</span><span class=n>transformed</span><span class=p>);</span>
<a id=__codelineno-30-57 name=__codelineno-30-57></a><a href=#__codelineno-30-57><span class=linenos data-linenos="57 "></span></a>    <span class=n>deferredEncodeManager</span><span class=p>.</span><span class=na>init</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>encoder</span><span class=p>,</span> <span class=n>lockedResult</span><span class=p>);</span>
<a id=__codelineno-30-58 name=__codelineno-30-58></a><a href=#__codelineno-30-58><span class=linenos data-linenos="58 "></span></a>    <span class=n>result</span> <span class=o>=</span> <span class=n>lockedResult</span><span class=p>;</span>
<a id=__codelineno-30-59 name=__codelineno-30-59></a><a href=#__codelineno-30-59><span class=linenos data-linenos="59 "></span></a>  <span class=p>}</span>
<a id=__codelineno-30-60 name=__codelineno-30-60></a><a href=#__codelineno-30-60><span class=linenos data-linenos="60 "></span></a>  <span class=k>return</span> <span class=n>result</span><span class=p>;</span>
<a id=__codelineno-30-61 name=__codelineno-30-61></a><a href=#__codelineno-30-61><span class=linenos data-linenos="61 "></span></a><span class=p>}</span>
</code></pre></div> <p>ä»ä¸Šé¢çš„æºç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œå½“<code>dataSource != DataSource.RESOURCE_DISK_CACHE</code>æ—¶ä¼šè¿›è¡Œtransformã€‚å“¦ï½ï¼Œè¿™æ˜¯å› ä¸ºresource cacheè‚¯å®šå·²ç»ç»å†è¿‡transformäº†ï¼Œæ‰€ä»¥å°±ä¸ç”¨é‡æ–°æ¥ä¸€éäº†ã€‚ </p> <p>ç„¶åæ˜¯æ­¤è¿‡ç¨‹ä¸­çš„ç£ç›˜ç¼“å­˜è¿‡ç¨‹ï¼Œå½±å“çš„å› ç´ æœ‰<code>encodeStrategy</code>ã€<code>DiskCacheStrategy.isResourceCacheable</code>ï¼š</p> <ol> <li>encodeStrategy<br> æ ¹æ®resourceæ•°æ®çš„ç±»å‹æ¥åˆ¤æ–­ï¼Œå¦‚æœæ˜¯<code>Bitmap</code>æˆ–<code>BitmapDrawable</code>ï¼Œé‚£ä¹ˆå°±æ˜¯<code>TRANSFORMED</code>ï¼›<br> å¦‚æœæ˜¯<code>GifDrawable</code>ï¼Œé‚£ä¹ˆå°±æ˜¯<code>SOURCE</code>ã€‚<br> è¯¦ç»†è¯·çœ‹<code>BitmapEncoder</code>ã€<code>BitmapDrawableEncoder</code>å’Œ<code>GifDrawableEncoder</code>ç±»</li> <li>DiskCacheStrategy.isResourceCacheable<br> <code>isFromAlternateCacheKey</code>æœäº†ä¸€éæºç ï¼Œåªæœ‰ä¸€ä¸ªæ²¡æœ‰ä½¿ç”¨è¿‡çš„ç±»<code>BaseGlideUrlLoader</code>ä¸­å‘ç°äº†ç—•è¿¹ï¼Œè¿˜æ˜¯ä¸€ä¸ªç©ºé›†åˆå®ç°ï¼Œæ²¡æœ‰å…¶ä»–ä»»ä½•ä½ç½®åœ¨ä½¿ç”¨ï¼Œæ‰€ä»¥æ­¤å¤„å¯ä»¥ç®€å•ç†è§£çš„è¯¥å‚æ•°ä¸€ç›´ä¸ºfalseã€‚<br> ä¹Ÿå°±æ˜¯è¯´ï¼Œåªæœ‰dataSourceä¸º<code>DataSource.LOCAL</code>ä¸”encodeStrategyä¸º<code>EncodeStrategy.TRANSFORMED</code>æ—¶ï¼Œæ‰å…è®¸ç¼“å­˜ã€‚æ¢å¥è¯è¯´ï¼Œåªæœ‰æœ¬åœ°çš„resourceæ•°æ®ä¸º<code>Bitmap</code>æˆ–<code>BitmapDrawable</code>çš„èµ„æºæ‰å¯ä»¥ç¼“å­˜ã€‚ <div class=highlight><pre><span></span><code><a id=__codelineno-31-1 name=__codelineno-31-1></a><a href=#__codelineno-31-1><span class=linenos data-linenos="1 "></span></a> <span class=nd>@Override</span>
<a id=__codelineno-31-2 name=__codelineno-31-2></a><a href=#__codelineno-31-2><span class=linenos data-linenos="2 "></span></a> <span class=kd>public</span> <span class=kt>boolean</span> <span class=nf>isResourceCacheable</span><span class=p>(</span><span class=kt>boolean</span> <span class=n>isFromAlternateCacheKey</span><span class=p>,</span> <span class=n>DataSource</span> <span class=n>dataSource</span><span class=p>,</span>
<a id=__codelineno-31-3 name=__codelineno-31-3></a><a href=#__codelineno-31-3><span class=linenos data-linenos="3 "></span></a>     <span class=n>EncodeStrategy</span> <span class=n>encodeStrategy</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-31-4 name=__codelineno-31-4></a><a href=#__codelineno-31-4><span class=linenos data-linenos="4 "></span></a>   <span class=k>return</span> <span class=p>((</span><span class=n>isFromAlternateCacheKey</span> <span class=o>&amp;&amp;</span> <span class=n>dataSource</span> <span class=o>==</span> <span class=n>DataSource</span><span class=p>.</span><span class=na>DATA_DISK_CACHE</span><span class=p>)</span>
<a id=__codelineno-31-5 name=__codelineno-31-5></a><a href=#__codelineno-31-5><span class=linenos data-linenos="5 "></span></a>       <span class=o>||</span> <span class=n>dataSource</span> <span class=o>==</span> <span class=n>DataSource</span><span class=p>.</span><span class=na>LOCAL</span><span class=p>)</span>
<a id=__codelineno-31-6 name=__codelineno-31-6></a><a href=#__codelineno-31-6><span class=linenos data-linenos="6 "></span></a>       <span class=o>&amp;&amp;</span> <span class=n>encodeStrategy</span> <span class=o>==</span> <span class=n>EncodeStrategy</span><span class=p>.</span><span class=na>TRANSFORMED</span><span class=p>;</span>
<a id=__codelineno-31-7 name=__codelineno-31-7></a><a href=#__codelineno-31-7><span class=linenos data-linenos="7 "></span></a> <span class=p>}</span>
</code></pre></div></li> </ol> <p>æœ€åï¼Œå¦‚æœå¯ä»¥ç¼“å­˜ï¼Œä¼šåˆå§‹åŒ–ä¸€ä¸ª<code>deferredEncodeManager</code>ï¼Œåœ¨å±•ç¤ºresourceèµ„æºåä¼šè°ƒç”¨æ­¤å¯¹è±¡è¿›è¡Œç£ç›˜ç¼“å­˜çš„å†™å…¥ã€‚å†™å…¥çš„ä»£ç å¦‚ä¸‹ï¼š</p> <div class=highlight><pre><span></span><code><a id=__codelineno-32-1 name=__codelineno-32-1></a><a href=#__codelineno-32-1><span class=linenos data-linenos=" 1 "></span></a><span class=c1>// DecodeJob.java</span>
<a id=__codelineno-32-2 name=__codelineno-32-2></a><a href=#__codelineno-32-2><span class=linenos data-linenos=" 2 "></span></a><span class=c1>//</span>
<a id=__codelineno-32-3 name=__codelineno-32-3></a><a href=#__codelineno-32-3><span class=linenos data-linenos=" 3 "></span></a><span class=c1>// deferredEncodeManager.init(key, encoder, LockedResource.obtain(transformed));</span>
<a id=__codelineno-32-4 name=__codelineno-32-4></a><a href=#__codelineno-32-4><span class=linenos data-linenos=" 4 "></span></a><span class=kd>private</span> <span class=kt>void</span> <span class=nf>notifyEncodeAndRelease</span><span class=p>(</span><span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>resource</span><span class=p>,</span> <span class=n>DataSource</span> <span class=n>dataSource</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-32-5 name=__codelineno-32-5></a><a href=#__codelineno-32-5><span class=linenos data-linenos=" 5 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>resource</span> <span class=k>instanceof</span> <span class=n>Initializable</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-32-6 name=__codelineno-32-6></a><a href=#__codelineno-32-6><span class=linenos data-linenos=" 6 "></span></a>    <span class=p>((</span><span class=n>Initializable</span><span class=p>)</span> <span class=n>resource</span><span class=p>).</span><span class=na>initialize</span><span class=p>();</span>
<a id=__codelineno-32-7 name=__codelineno-32-7></a><a href=#__codelineno-32-7><span class=linenos data-linenos=" 7 "></span></a>  <span class=p>}</span>
<a id=__codelineno-32-8 name=__codelineno-32-8></a><a href=#__codelineno-32-8><span class=linenos data-linenos=" 8 "></span></a>
<a id=__codelineno-32-9 name=__codelineno-32-9></a><a href=#__codelineno-32-9><span class=linenos data-linenos=" 9 "></span></a>  <span class=n>Resource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>result</span> <span class=o>=</span> <span class=n>resource</span><span class=p>;</span>
<a id=__codelineno-32-10 name=__codelineno-32-10></a><a href=#__codelineno-32-10><span class=linenos data-linenos="10 "></span></a>  <span class=n>LockedResource</span><span class=o>&lt;</span><span class=n>R</span><span class=o>&gt;</span> <span class=n>lockedResource</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-32-11 name=__codelineno-32-11></a><a href=#__codelineno-32-11><span class=linenos data-linenos="11 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>deferredEncodeManager</span><span class=p>.</span><span class=na>hasResourceToEncode</span><span class=p>())</span> <span class=p>{</span>
<a id=__codelineno-32-12 name=__codelineno-32-12></a><a href=#__codelineno-32-12><span class=linenos data-linenos="12 "></span></a>    <span class=n>lockedResource</span> <span class=o>=</span> <span class=n>LockedResource</span><span class=p>.</span><span class=na>obtain</span><span class=p>(</span><span class=n>resource</span><span class=p>);</span>
<a id=__codelineno-32-13 name=__codelineno-32-13></a><a href=#__codelineno-32-13><span class=linenos data-linenos="13 "></span></a>    <span class=n>result</span> <span class=o>=</span> <span class=n>lockedResource</span><span class=p>;</span>
<a id=__codelineno-32-14 name=__codelineno-32-14></a><a href=#__codelineno-32-14><span class=linenos data-linenos="14 "></span></a>  <span class=p>}</span>
<a id=__codelineno-32-15 name=__codelineno-32-15></a><a href=#__codelineno-32-15><span class=linenos data-linenos="15 "></span></a>
<a id=__codelineno-32-16 name=__codelineno-32-16></a><a href=#__codelineno-32-16><span class=linenos data-linenos="16 "></span></a>  <span class=n>notifyComplete</span><span class=p>(</span><span class=n>result</span><span class=p>,</span> <span class=n>dataSource</span><span class=p>);</span>
<a id=__codelineno-32-17 name=__codelineno-32-17></a><a href=#__codelineno-32-17><span class=linenos data-linenos="17 "></span></a>
<a id=__codelineno-32-18 name=__codelineno-32-18></a><a href=#__codelineno-32-18><span class=linenos data-linenos="18 "></span></a>  <span class=n>stage</span> <span class=o>=</span> <span class=n>Stage</span><span class=p>.</span><span class=na>ENCODE</span><span class=p>;</span>
<a id=__codelineno-32-19 name=__codelineno-32-19></a><a href=#__codelineno-32-19><span class=linenos data-linenos="19 "></span></a>  <span class=k>try</span> <span class=p>{</span>
<a id=__codelineno-32-20 name=__codelineno-32-20></a><a href=#__codelineno-32-20><span class=linenos data-linenos="20 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>deferredEncodeManager</span><span class=p>.</span><span class=na>hasResourceToEncode</span><span class=p>())</span> <span class=p>{</span>
<a id=__codelineno-32-21 name=__codelineno-32-21></a><a href=#__codelineno-32-21><span class=linenos data-linenos="21 "></span></a>      <span class=n>deferredEncodeManager</span><span class=p>.</span><span class=na>encode</span><span class=p>(</span><span class=n>diskCacheProvider</span><span class=p>,</span> <span class=n>options</span><span class=p>);</span>
<a id=__codelineno-32-22 name=__codelineno-32-22></a><a href=#__codelineno-32-22><span class=linenos data-linenos="22 "></span></a>    <span class=p>}</span>
<a id=__codelineno-32-23 name=__codelineno-32-23></a><a href=#__codelineno-32-23><span class=linenos data-linenos="23 "></span></a>  <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
<a id=__codelineno-32-24 name=__codelineno-32-24></a><a href=#__codelineno-32-24><span class=linenos data-linenos="24 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>lockedResource</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-32-25 name=__codelineno-32-25></a><a href=#__codelineno-32-25><span class=linenos data-linenos="25 "></span></a>      <span class=n>lockedResource</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span>
<a id=__codelineno-32-26 name=__codelineno-32-26></a><a href=#__codelineno-32-26><span class=linenos data-linenos="26 "></span></a>    <span class=p>}</span>
<a id=__codelineno-32-27 name=__codelineno-32-27></a><a href=#__codelineno-32-27><span class=linenos data-linenos="27 "></span></a>  <span class=p>}</span>
<a id=__codelineno-32-28 name=__codelineno-32-28></a><a href=#__codelineno-32-28><span class=linenos data-linenos="28 "></span></a>  <span class=c1>// Call onEncodeComplete outside the finally block so that it&#39;s not called if the encode process</span>
<a id=__codelineno-32-29 name=__codelineno-32-29></a><a href=#__codelineno-32-29><span class=linenos data-linenos="29 "></span></a>  <span class=c1>// throws.</span>
<a id=__codelineno-32-30 name=__codelineno-32-30></a><a href=#__codelineno-32-30><span class=linenos data-linenos="30 "></span></a>  <span class=n>onEncodeComplete</span><span class=p>();</span>
<a id=__codelineno-32-31 name=__codelineno-32-31></a><a href=#__codelineno-32-31><span class=linenos data-linenos="31 "></span></a><span class=p>}</span>
<a id=__codelineno-32-32 name=__codelineno-32-32></a><a href=#__codelineno-32-32><span class=linenos data-linenos="32 "></span></a>
<a id=__codelineno-32-33 name=__codelineno-32-33></a><a href=#__codelineno-32-33><span class=linenos data-linenos="33 "></span></a><span class=c1>// DecodeJob#DeferredEncodeManager</span>
<a id=__codelineno-32-34 name=__codelineno-32-34></a><a href=#__codelineno-32-34><span class=linenos data-linenos="34 "></span></a><span class=kd>private</span> <span class=kd>static</span> <span class=kd>class</span> <span class=nc>DeferredEncodeManager</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=p>{</span>
<a id=__codelineno-32-35 name=__codelineno-32-35></a><a href=#__codelineno-32-35><span class=linenos data-linenos="35 "></span></a>  <span class=kd>private</span> <span class=n>Key</span> <span class=n>key</span><span class=p>;</span>
<a id=__codelineno-32-36 name=__codelineno-32-36></a><a href=#__codelineno-32-36><span class=linenos data-linenos="36 "></span></a>  <span class=kd>private</span> <span class=n>ResourceEncoder</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>encoder</span><span class=p>;</span>
<a id=__codelineno-32-37 name=__codelineno-32-37></a><a href=#__codelineno-32-37><span class=linenos data-linenos="37 "></span></a>  <span class=kd>private</span> <span class=n>LockedResource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span> <span class=n>toEncode</span><span class=p>;</span>
<a id=__codelineno-32-38 name=__codelineno-32-38></a><a href=#__codelineno-32-38><span class=linenos data-linenos="38 "></span></a>
<a id=__codelineno-32-39 name=__codelineno-32-39></a><a href=#__codelineno-32-39><span class=linenos data-linenos="39 "></span></a>  <span class=nd>@Synthetic</span>
<a id=__codelineno-32-40 name=__codelineno-32-40></a><a href=#__codelineno-32-40><span class=linenos data-linenos="40 "></span></a>  <span class=n>DeferredEncodeManager</span><span class=p>()</span> <span class=p>{</span> <span class=p>}</span>
<a id=__codelineno-32-41 name=__codelineno-32-41></a><a href=#__codelineno-32-41><span class=linenos data-linenos="41 "></span></a>
<a id=__codelineno-32-42 name=__codelineno-32-42></a><a href=#__codelineno-32-42><span class=linenos data-linenos="42 "></span></a>  <span class=c1>// We just need the encoder and resource type to match, which this will enforce.</span>
<a id=__codelineno-32-43 name=__codelineno-32-43></a><a href=#__codelineno-32-43><span class=linenos data-linenos="43 "></span></a>  <span class=nd>@SuppressWarnings</span><span class=p>(</span><span class=s>&quot;unchecked&quot;</span><span class=p>)</span>
<a id=__codelineno-32-44 name=__codelineno-32-44></a><a href=#__codelineno-32-44><span class=linenos data-linenos="44 "></span></a>  <span class=o>&lt;</span><span class=n>X</span><span class=o>&gt;</span> <span class=kt>void</span> <span class=nf>init</span><span class=p>(</span><span class=n>Key</span> <span class=n>key</span><span class=p>,</span> <span class=n>ResourceEncoder</span><span class=o>&lt;</span><span class=n>X</span><span class=o>&gt;</span> <span class=n>encoder</span><span class=p>,</span> <span class=n>LockedResource</span><span class=o>&lt;</span><span class=n>X</span><span class=o>&gt;</span> <span class=n>toEncode</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-32-45 name=__codelineno-32-45></a><a href=#__codelineno-32-45><span class=linenos data-linenos="45 "></span></a>    <span class=k>this</span><span class=p>.</span><span class=na>key</span> <span class=o>=</span> <span class=n>key</span><span class=p>;</span>
<a id=__codelineno-32-46 name=__codelineno-32-46></a><a href=#__codelineno-32-46><span class=linenos data-linenos="46 "></span></a>    <span class=k>this</span><span class=p>.</span><span class=na>encoder</span> <span class=o>=</span> <span class=p>(</span><span class=n>ResourceEncoder</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span><span class=p>)</span> <span class=n>encoder</span><span class=p>;</span>
<a id=__codelineno-32-47 name=__codelineno-32-47></a><a href=#__codelineno-32-47><span class=linenos data-linenos="47 "></span></a>    <span class=k>this</span><span class=p>.</span><span class=na>toEncode</span> <span class=o>=</span> <span class=p>(</span><span class=n>LockedResource</span><span class=o>&lt;</span><span class=n>Z</span><span class=o>&gt;</span><span class=p>)</span> <span class=n>toEncode</span><span class=p>;</span>
<a id=__codelineno-32-48 name=__codelineno-32-48></a><a href=#__codelineno-32-48><span class=linenos data-linenos="48 "></span></a>  <span class=p>}</span>
<a id=__codelineno-32-49 name=__codelineno-32-49></a><a href=#__codelineno-32-49><span class=linenos data-linenos="49 "></span></a>
<a id=__codelineno-32-50 name=__codelineno-32-50></a><a href=#__codelineno-32-50><span class=linenos data-linenos="50 "></span></a>  <span class=kt>void</span> <span class=nf>encode</span><span class=p>(</span><span class=n>DiskCacheProvider</span> <span class=n>diskCacheProvider</span><span class=p>,</span> <span class=n>Options</span> <span class=n>options</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-32-51 name=__codelineno-32-51></a><a href=#__codelineno-32-51><span class=linenos data-linenos="51 "></span></a>    <span class=n>GlideTrace</span><span class=p>.</span><span class=na>beginSection</span><span class=p>(</span><span class=s>&quot;DecodeJob.encode&quot;</span><span class=p>);</span>
<a id=__codelineno-32-52 name=__codelineno-32-52></a><a href=#__codelineno-32-52><span class=linenos data-linenos="52 "></span></a>    <span class=k>try</span> <span class=p>{</span>
<a id=__codelineno-32-53 name=__codelineno-32-53></a><a href=#__codelineno-32-53><span class=linenos data-linenos="53 "></span></a>      <span class=n>diskCacheProvider</span><span class=p>.</span><span class=na>getDiskCache</span><span class=p>().</span><span class=na>put</span><span class=p>(</span><span class=n>key</span><span class=p>,</span>
<a id=__codelineno-32-54 name=__codelineno-32-54></a><a href=#__codelineno-32-54><span class=linenos data-linenos="54 "></span></a>          <span class=k>new</span> <span class=n>DataCacheWriter</span><span class=o>&lt;&gt;</span><span class=p>(</span><span class=n>encoder</span><span class=p>,</span> <span class=n>toEncode</span><span class=p>,</span> <span class=n>options</span><span class=p>));</span>
<a id=__codelineno-32-55 name=__codelineno-32-55></a><a href=#__codelineno-32-55><span class=linenos data-linenos="55 "></span></a>    <span class=p>}</span> <span class=k>finally</span> <span class=p>{</span>
<a id=__codelineno-32-56 name=__codelineno-32-56></a><a href=#__codelineno-32-56><span class=linenos data-linenos="56 "></span></a>      <span class=n>toEncode</span><span class=p>.</span><span class=na>unlock</span><span class=p>();</span>
<a id=__codelineno-32-57 name=__codelineno-32-57></a><a href=#__codelineno-32-57><span class=linenos data-linenos="57 "></span></a>      <span class=n>GlideTrace</span><span class=p>.</span><span class=na>endSection</span><span class=p>();</span>
<a id=__codelineno-32-58 name=__codelineno-32-58></a><a href=#__codelineno-32-58><span class=linenos data-linenos="58 "></span></a>    <span class=p>}</span>
<a id=__codelineno-32-59 name=__codelineno-32-59></a><a href=#__codelineno-32-59><span class=linenos data-linenos="59 "></span></a>  <span class=p>}</span>
<a id=__codelineno-32-60 name=__codelineno-32-60></a><a href=#__codelineno-32-60><span class=linenos data-linenos="60 "></span></a>
<a id=__codelineno-32-61 name=__codelineno-32-61></a><a href=#__codelineno-32-61><span class=linenos data-linenos="61 "></span></a>  <span class=kt>boolean</span> <span class=nf>hasResourceToEncode</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-32-62 name=__codelineno-32-62></a><a href=#__codelineno-32-62><span class=linenos data-linenos="62 "></span></a>    <span class=k>return</span> <span class=n>toEncode</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-32-63 name=__codelineno-32-63></a><a href=#__codelineno-32-63><span class=linenos data-linenos="63 "></span></a>  <span class=p>}</span>
<a id=__codelineno-32-64 name=__codelineno-32-64></a><a href=#__codelineno-32-64><span class=linenos data-linenos="64 "></span></a>
<a id=__codelineno-32-65 name=__codelineno-32-65></a><a href=#__codelineno-32-65><span class=linenos data-linenos="65 "></span></a>  <span class=kt>void</span> <span class=nf>clear</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-32-66 name=__codelineno-32-66></a><a href=#__codelineno-32-66><span class=linenos data-linenos="66 "></span></a>    <span class=n>key</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-32-67 name=__codelineno-32-67></a><a href=#__codelineno-32-67><span class=linenos data-linenos="67 "></span></a>    <span class=n>encoder</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-32-68 name=__codelineno-32-68></a><a href=#__codelineno-32-68><span class=linenos data-linenos="68 "></span></a>    <span class=n>toEncode</span> <span class=o>=</span> <span class=kc>null</span><span class=p>;</span>
<a id=__codelineno-32-69 name=__codelineno-32-69></a><a href=#__codelineno-32-69><span class=linenos data-linenos="69 "></span></a>  <span class=p>}</span>
<a id=__codelineno-32-70 name=__codelineno-32-70></a><a href=#__codelineno-32-70><span class=linenos data-linenos="70 "></span></a><span class=p>}</span>
</code></pre></div> <p><code>DiskLruCacheWrapper</code>åœ¨å†™å…¥çš„æ—¶å€™ä¼šä½¿ç”¨åˆ°å†™é”<code>DiskCacheWriteLocker</code>ï¼Œé”å¯¹è±¡ç”±å¯¹è±¡æ± åˆ›å»ºï¼ˆGlideä¸­å¯¹è±¡æ± å’Œç¼“å­˜çœŸçš„æ˜¯æ— æ‰€ä¸åœ¨ğŸ‘ğŸ‘ğŸ‘ï¼‰ï¼Œå†™é”<code>WriteLock</code>å®ç°æ˜¯ä¸€ä¸ªé‡å…¥é”<code>ReentrantLock</code>ï¼Œè¯¥é”é»˜è®¤æ˜¯ä¸€ä¸ªä¸å…¬å¹³é”ã€‚<br> åœ¨ç¼“å­˜å†™å…¥å‰ï¼Œä¼šåˆ¤æ–­keyå¯¹åº”çš„valueå­˜ä¸å­˜åœ¨ï¼Œè‹¥å­˜åœ¨åˆ™æ”¾å¼ƒå†™å…¥ã€‚ç¼“å­˜çš„çœŸæ­£å†™å…¥ä¼šç”±<code>DataCacheWriter</code>äº¤ç»™<code>ByteBufferEncoder</code>å’Œ<code>StreamEncoder</code>ä¸¤ä¸ªå…·ä½“ç±»æ¥å†™å…¥ï¼Œå‰è€…è´Ÿè´£å°†ByteBufferå†™å…¥åˆ°æ–‡ä»¶ï¼Œåè€…è´Ÿè´£å°†InputStreamå†™å…¥åˆ°æ–‡ä»¶ã€‚</p> <p>è‡³æ­¤ï¼Œç£ç›˜ç¼“å­˜çš„è¯»å†™éƒ½å·²ç»å®Œæ¯•ï¼Œå‰©ä¸‹çš„å°±æ˜¯å†…å­˜ç¼“å­˜çš„ä¸¤ä¸ªå±‚æ¬¡äº†ã€‚æˆ‘ä»¬å›åˆ°<code>DecodeJob.notifyEncodeAndRelease</code>æ–¹æ³•ä¸­ï¼Œç»è¿‡<code>notifyComplete</code>ã€<code>EngineJob.onResourceReady</code>ã€<code>notifyCallbacksOfResult</code>æ–¹æ³•ä¸­ã€‚<br> åœ¨è¯¥æ–¹æ³•ä¸­ä¸€æ–¹é¢ä¼šå°†åŸå§‹çš„resourceåŒ…è£…æˆä¸€ä¸ª<code>EngineResource</code>ï¼Œç„¶åé€šè¿‡å›è°ƒä¼ ç»™<code>Engine.onEngineJobComplete</code>ï¼Œåœ¨è¿™é‡Œä¼šå°†èµ„æºä¿æŒåœ¨active resourceä¸­ï¼š</p> <p><strong>Engine.java</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-33-1 name=__codelineno-33-1></a><a href=#__codelineno-33-1><span class=linenos data-linenos=" 1 "></span></a><span class=nd>@Override</span>
<a id=__codelineno-33-2 name=__codelineno-33-2></a><a href=#__codelineno-33-2><span class=linenos data-linenos=" 2 "></span></a><span class=kd>public</span> <span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>onEngineJobComplete</span><span class=p>(</span>
<a id=__codelineno-33-3 name=__codelineno-33-3></a><a href=#__codelineno-33-3><span class=linenos data-linenos=" 3 "></span></a>    <span class=n>EngineJob</span><span class=o>&lt;?&gt;</span> <span class=n>engineJob</span><span class=p>,</span> <span class=n>Key</span> <span class=n>key</span><span class=p>,</span> <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>resource</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-33-4 name=__codelineno-33-4></a><a href=#__codelineno-33-4><span class=linenos data-linenos=" 4 "></span></a>  <span class=c1>// A null resource indicates that the load failed, usually due to an exception.</span>
<a id=__codelineno-33-5 name=__codelineno-33-5></a><a href=#__codelineno-33-5><span class=linenos data-linenos=" 5 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>resource</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-33-6 name=__codelineno-33-6></a><a href=#__codelineno-33-6><span class=linenos data-linenos=" 6 "></span></a>    <span class=n>resource</span><span class=p>.</span><span class=na>setResourceListener</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=k>this</span><span class=p>);</span>
<a id=__codelineno-33-7 name=__codelineno-33-7></a><a href=#__codelineno-33-7><span class=linenos data-linenos=" 7 "></span></a>
<a id=__codelineno-33-8 name=__codelineno-33-8></a><a href=#__codelineno-33-8><span class=linenos data-linenos=" 8 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>resource</span><span class=p>.</span><span class=na>isCacheable</span><span class=p>())</span> <span class=p>{</span>
<a id=__codelineno-33-9 name=__codelineno-33-9></a><a href=#__codelineno-33-9><span class=linenos data-linenos=" 9 "></span></a>      <span class=n>activeResources</span><span class=p>.</span><span class=na>activate</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>resource</span><span class=p>);</span>
<a id=__codelineno-33-10 name=__codelineno-33-10></a><a href=#__codelineno-33-10><span class=linenos data-linenos="10 "></span></a>    <span class=p>}</span>
<a id=__codelineno-33-11 name=__codelineno-33-11></a><a href=#__codelineno-33-11><span class=linenos data-linenos="11 "></span></a>  <span class=p>}</span>
<a id=__codelineno-33-12 name=__codelineno-33-12></a><a href=#__codelineno-33-12><span class=linenos data-linenos="12 "></span></a>
<a id=__codelineno-33-13 name=__codelineno-33-13></a><a href=#__codelineno-33-13><span class=linenos data-linenos="13 "></span></a>  <span class=n>jobs</span><span class=p>.</span><span class=na>removeIfCurrent</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>engineJob</span><span class=p>);</span>
<a id=__codelineno-33-14 name=__codelineno-33-14></a><a href=#__codelineno-33-14><span class=linenos data-linenos="14 "></span></a><span class=p>}</span>
</code></pre></div> <p>å¦ä¸€æ–¹é¢ä¼šä½¿ç”¨<code>Executors.mainThreadExecutor()</code>è°ƒç”¨<code>SingleRequest.onResourceReady</code>å›è°ƒè¿›è¡Œèµ„æºçš„æ˜¾ç¤ºã€‚<br> åœ¨è§¦å‘å›è°ƒå‰åå„æœ‰ä¸€ä¸ªåœ°æ–¹ä¼šå¯¹<code>engineResource</code>è¿›è¡Œ<code>acquire()</code>å’Œ<code>release()</code>æ“ä½œã€‚è¯¥è¿‡ç¨‹å‘ç”Ÿåœ¨<code>notifyCallbacksOfResult()</code>æ–¹æ³•çš„<code>incrementPendingCallbacks</code>ã€<code>decrementPendingCallbacks()</code>è°ƒç”¨ä¸­ã€‚è¿™ä¸€é¡¿æ“ä½œä¸‹æ¥ï¼ŒengineResourceçš„å¼•ç”¨è®¡æ•°åº”è¯¥æ˜¯1ï¼š</p> <p><strong>EngineJob.java</strong></p> <div class=highlight><pre><span></span><code><a id=__codelineno-34-1 name=__codelineno-34-1></a><a href=#__codelineno-34-1><span class=linenos data-linenos=" 1 "></span></a><span class=nd>@Synthetic</span>
<a id=__codelineno-34-2 name=__codelineno-34-2></a><a href=#__codelineno-34-2><span class=linenos data-linenos=" 2 "></span></a><span class=kt>void</span> <span class=nf>notifyCallbacksOfResult</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-34-3 name=__codelineno-34-3></a><a href=#__codelineno-34-3><span class=linenos data-linenos=" 3 "></span></a>  <span class=n>ResourceCallbacksAndExecutors</span> <span class=n>copy</span><span class=p>;</span>
<a id=__codelineno-34-4 name=__codelineno-34-4></a><a href=#__codelineno-34-4><span class=linenos data-linenos=" 4 "></span></a>  <span class=n>Key</span> <span class=n>localKey</span><span class=p>;</span>
<a id=__codelineno-34-5 name=__codelineno-34-5></a><a href=#__codelineno-34-5><span class=linenos data-linenos=" 5 "></span></a>  <span class=n>EngineResource</span><span class=o>&lt;?&gt;</span> <span class=n>localResource</span><span class=p>;</span>
<a id=__codelineno-34-6 name=__codelineno-34-6></a><a href=#__codelineno-34-6><span class=linenos data-linenos=" 6 "></span></a>  <span class=kd>synchronized</span> <span class=p>(</span><span class=k>this</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-34-7 name=__codelineno-34-7></a><a href=#__codelineno-34-7><span class=linenos data-linenos=" 7 "></span></a>    <span class=p>...</span>
<a id=__codelineno-34-8 name=__codelineno-34-8></a><a href=#__codelineno-34-8><span class=linenos data-linenos=" 8 "></span></a>    <span class=n>engineResource</span> <span class=o>=</span> <span class=n>engineResourceFactory</span><span class=p>.</span><span class=na>build</span><span class=p>(</span><span class=n>resource</span><span class=p>,</span> <span class=n>isCacheable</span><span class=p>);</span>
<a id=__codelineno-34-9 name=__codelineno-34-9></a><a href=#__codelineno-34-9><span class=linenos data-linenos=" 9 "></span></a>    <span class=c1>// Hold on to resource for duration of our callbacks below so we don&#39;t recycle it in the</span>
<a id=__codelineno-34-10 name=__codelineno-34-10></a><a href=#__codelineno-34-10><span class=linenos data-linenos="10 "></span></a>    <span class=c1>// middle of notifying if it synchronously released by one of the callbacks. Acquire it under</span>
<a id=__codelineno-34-11 name=__codelineno-34-11></a><a href=#__codelineno-34-11><span class=linenos data-linenos="11 "></span></a>    <span class=c1>// a lock here so that any newly added callback that executes before the next locked section</span>
<a id=__codelineno-34-12 name=__codelineno-34-12></a><a href=#__codelineno-34-12><span class=linenos data-linenos="12 "></span></a>    <span class=c1>// below can&#39;t recycle the resource before we call the callbacks.</span>
<a id=__codelineno-34-13 name=__codelineno-34-13></a><a href=#__codelineno-34-13><span class=linenos data-linenos="13 "></span></a>    <span class=n>hasResource</span> <span class=o>=</span> <span class=kc>true</span><span class=p>;</span>
<a id=__codelineno-34-14 name=__codelineno-34-14></a><a href=#__codelineno-34-14><span class=linenos data-linenos="14 "></span></a>    <span class=n>copy</span> <span class=o>=</span> <span class=n>cbs</span><span class=p>.</span><span class=na>copy</span><span class=p>();</span>
<a id=__codelineno-34-15 name=__codelineno-34-15></a><a href=#__codelineno-34-15><span class=linenos data-linenos="15 "></span></a>    <span class=n>incrementPendingCallbacks</span><span class=p>(</span><span class=n>copy</span><span class=p>.</span><span class=na>size</span><span class=p>()</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
<a id=__codelineno-34-16 name=__codelineno-34-16></a><a href=#__codelineno-34-16><span class=linenos data-linenos="16 "></span></a>
<a id=__codelineno-34-17 name=__codelineno-34-17></a><a href=#__codelineno-34-17><span class=linenos data-linenos="17 "></span></a>    <span class=n>localKey</span> <span class=o>=</span> <span class=n>key</span><span class=p>;</span>
<a id=__codelineno-34-18 name=__codelineno-34-18></a><a href=#__codelineno-34-18><span class=linenos data-linenos="18 "></span></a>    <span class=n>localResource</span> <span class=o>=</span> <span class=n>engineResource</span><span class=p>;</span>
<a id=__codelineno-34-19 name=__codelineno-34-19></a><a href=#__codelineno-34-19><span class=linenos data-linenos="19 "></span></a>  <span class=p>}</span>
<a id=__codelineno-34-20 name=__codelineno-34-20></a><a href=#__codelineno-34-20><span class=linenos data-linenos="20 "></span></a>
<a id=__codelineno-34-21 name=__codelineno-34-21></a><a href=#__codelineno-34-21><span class=linenos data-linenos="21 "></span></a>  <span class=n>listener</span><span class=p>.</span><span class=na>onEngineJobComplete</span><span class=p>(</span><span class=k>this</span><span class=p>,</span> <span class=n>localKey</span><span class=p>,</span> <span class=n>localResource</span><span class=p>);</span>
<a id=__codelineno-34-22 name=__codelineno-34-22></a><a href=#__codelineno-34-22><span class=linenos data-linenos="22 "></span></a>
<a id=__codelineno-34-23 name=__codelineno-34-23></a><a href=#__codelineno-34-23><span class=linenos data-linenos="23 "></span></a>  <span class=k>for</span> <span class=p>(</span><span class=kd>final</span> <span class=n>ResourceCallbackAndExecutor</span> <span class=n>entry</span> <span class=p>:</span> <span class=n>copy</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-34-24 name=__codelineno-34-24></a><a href=#__codelineno-34-24><span class=linenos data-linenos="24 "></span></a>    <span class=n>entry</span><span class=p>.</span><span class=na>executor</span><span class=p>.</span><span class=na>execute</span><span class=p>(</span><span class=k>new</span> <span class=n>CallResourceReady</span><span class=p>(</span><span class=n>entry</span><span class=p>.</span><span class=na>cb</span><span class=p>));</span>
<a id=__codelineno-34-25 name=__codelineno-34-25></a><a href=#__codelineno-34-25><span class=linenos data-linenos="25 "></span></a>  <span class=p>}</span>
<a id=__codelineno-34-26 name=__codelineno-34-26></a><a href=#__codelineno-34-26><span class=linenos data-linenos="26 "></span></a>  <span class=n>decrementPendingCallbacks</span><span class=p>();</span>
<a id=__codelineno-34-27 name=__codelineno-34-27></a><a href=#__codelineno-34-27><span class=linenos data-linenos="27 "></span></a><span class=p>}</span>
<a id=__codelineno-34-28 name=__codelineno-34-28></a><a href=#__codelineno-34-28><span class=linenos data-linenos="28 "></span></a>
<a id=__codelineno-34-29 name=__codelineno-34-29></a><a href=#__codelineno-34-29><span class=linenos data-linenos="29 "></span></a><span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>incrementPendingCallbacks</span><span class=p>(</span><span class=kt>int</span> <span class=n>count</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-34-30 name=__codelineno-34-30></a><a href=#__codelineno-34-30><span class=linenos data-linenos="30 "></span></a>  <span class=p>...</span>
<a id=__codelineno-34-31 name=__codelineno-34-31></a><a href=#__codelineno-34-31><span class=linenos data-linenos="31 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>pendingCallbacks</span><span class=p>.</span><span class=na>getAndAdd</span><span class=p>(</span><span class=n>count</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=o>&amp;&amp;</span> <span class=n>engineResource</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-34-32 name=__codelineno-34-32></a><a href=#__codelineno-34-32><span class=linenos data-linenos="32 "></span></a>    <span class=n>engineResource</span><span class=p>.</span><span class=na>acquire</span><span class=p>();</span>
<a id=__codelineno-34-33 name=__codelineno-34-33></a><a href=#__codelineno-34-33><span class=linenos data-linenos="33 "></span></a>  <span class=p>}</span>
<a id=__codelineno-34-34 name=__codelineno-34-34></a><a href=#__codelineno-34-34><span class=linenos data-linenos="34 "></span></a><span class=p>}</span>
<a id=__codelineno-34-35 name=__codelineno-34-35></a><a href=#__codelineno-34-35><span class=linenos data-linenos="35 "></span></a>
<a id=__codelineno-34-36 name=__codelineno-34-36></a><a href=#__codelineno-34-36><span class=linenos data-linenos="36 "></span></a><span class=kd>synchronized</span> <span class=kt>void</span> <span class=nf>decrementPendingCallbacks</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-34-37 name=__codelineno-34-37></a><a href=#__codelineno-34-37><span class=linenos data-linenos="37 "></span></a>  <span class=p>...</span>
<a id=__codelineno-34-38 name=__codelineno-34-38></a><a href=#__codelineno-34-38><span class=linenos data-linenos="38 "></span></a>  <span class=kt>int</span> <span class=n>decremented</span> <span class=o>=</span> <span class=n>pendingCallbacks</span><span class=p>.</span><span class=na>decrementAndGet</span><span class=p>();</span>
<a id=__codelineno-34-39 name=__codelineno-34-39></a><a href=#__codelineno-34-39><span class=linenos data-linenos="39 "></span></a>  <span class=k>if</span> <span class=p>(</span><span class=n>decremented</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-34-40 name=__codelineno-34-40></a><a href=#__codelineno-34-40><span class=linenos data-linenos="40 "></span></a>    <span class=k>if</span> <span class=p>(</span><span class=n>engineResource</span> <span class=o>!=</span> <span class=kc>null</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-34-41 name=__codelineno-34-41></a><a href=#__codelineno-34-41><span class=linenos data-linenos="41 "></span></a>      <span class=n>engineResource</span><span class=p>.</span><span class=na>release</span><span class=p>();</span>
<a id=__codelineno-34-42 name=__codelineno-34-42></a><a href=#__codelineno-34-42><span class=linenos data-linenos="42 "></span></a>    <span class=p>}</span>
<a id=__codelineno-34-43 name=__codelineno-34-43></a><a href=#__codelineno-34-43><span class=linenos data-linenos="43 "></span></a>
<a id=__codelineno-34-44 name=__codelineno-34-44></a><a href=#__codelineno-34-44><span class=linenos data-linenos="44 "></span></a>    <span class=n>release</span><span class=p>();</span>
<a id=__codelineno-34-45 name=__codelineno-34-45></a><a href=#__codelineno-34-45><span class=linenos data-linenos="45 "></span></a>  <span class=p>}</span>
<a id=__codelineno-34-46 name=__codelineno-34-46></a><a href=#__codelineno-34-46><span class=linenos data-linenos="46 "></span></a><span class=p>}</span>
<a id=__codelineno-34-47 name=__codelineno-34-47></a><a href=#__codelineno-34-47><span class=linenos data-linenos="47 "></span></a>
<a id=__codelineno-34-48 name=__codelineno-34-48></a><a href=#__codelineno-34-48><span class=linenos data-linenos="48 "></span></a><span class=kd>private</span> <span class=kd>class</span> <span class=nc>CallResourceReady</span> <span class=kd>implements</span> <span class=n>Runnable</span> <span class=p>{</span>
<a id=__codelineno-34-49 name=__codelineno-34-49></a><a href=#__codelineno-34-49><span class=linenos data-linenos="49 "></span></a>
<a id=__codelineno-34-50 name=__codelineno-34-50></a><a href=#__codelineno-34-50><span class=linenos data-linenos="50 "></span></a>  <span class=kd>private</span> <span class=kd>final</span> <span class=n>ResourceCallback</span> <span class=n>cb</span><span class=p>;</span>
<a id=__codelineno-34-51 name=__codelineno-34-51></a><a href=#__codelineno-34-51><span class=linenos data-linenos="51 "></span></a>
<a id=__codelineno-34-52 name=__codelineno-34-52></a><a href=#__codelineno-34-52><span class=linenos data-linenos="52 "></span></a>  <span class=n>CallResourceReady</span><span class=p>(</span><span class=n>ResourceCallback</span> <span class=n>cb</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-34-53 name=__codelineno-34-53></a><a href=#__codelineno-34-53><span class=linenos data-linenos="53 "></span></a>    <span class=k>this</span><span class=p>.</span><span class=na>cb</span> <span class=o>=</span> <span class=n>cb</span><span class=p>;</span>
<a id=__codelineno-34-54 name=__codelineno-34-54></a><a href=#__codelineno-34-54><span class=linenos data-linenos="54 "></span></a>  <span class=p>}</span>
<a id=__codelineno-34-55 name=__codelineno-34-55></a><a href=#__codelineno-34-55><span class=linenos data-linenos="55 "></span></a>
<a id=__codelineno-34-56 name=__codelineno-34-56></a><a href=#__codelineno-34-56><span class=linenos data-linenos="56 "></span></a>  <span class=nd>@Override</span>
<a id=__codelineno-34-57 name=__codelineno-34-57></a><a href=#__codelineno-34-57><span class=linenos data-linenos="57 "></span></a>  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=p>()</span> <span class=p>{</span>
<a id=__codelineno-34-58 name=__codelineno-34-58></a><a href=#__codelineno-34-58><span class=linenos data-linenos="58 "></span></a>    <span class=kd>synchronized</span> <span class=p>(</span><span class=n>EngineJob</span><span class=p>.</span><span class=na>this</span><span class=p>)</span> <span class=p>{</span>
<a id=__codelineno-34-59 name=__codelineno-34-59></a><a href=#__codelineno-34-59><span class=linenos data-linenos="59 "></span></a>      <span class=k>if</span> <span class=p>(</span><span class=n>cbs</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=n>cb</span><span class=p>))</span> <span class=p>{</span>
<a id=__codelineno-34-60 name=__codelineno-34-60></a><a href=#__codelineno-34-60><span class=linenos data-linenos="60 "></span></a>        <span class=c1>// Acquire for this particular callback.</span>
<a id=__codelineno-34-61 name=__codelineno-34-61></a><a href=#__codelineno-34-61><span class=linenos data-linenos="61 "></span></a>        <span class=n>engineResource</span><span class=p>.</span><span class=na>acquire</span><span class=p>();</span>
<a id=__codelineno-34-62 name=__codelineno-34-62></a><a href=#__codelineno-34-62><span class=linenos data-linenos="62 "></span></a>        <span class=n>callCallbackOnResourceReady</span><span class=p>(</span><span class=n>cb</span><span class=p>);</span>
<a id=__codelineno-34-63 name=__codelineno-34-63></a><a href=#__codelineno-34-63><span class=linenos data-linenos="63 "></span></a>        <span class=n>removeCallback</span><span class=p>(</span><span class=n>cb</span><span class=p>);</span>
<a id=__codelineno-34-64 name=__codelineno-34-64></a><a href=#__codelineno-34-64><span class=linenos data-linenos="64 "></span></a>      <span class=p>}</span>
<a id=__codelineno-34-65 name=__codelineno-34-65></a><a href=#__codelineno-34-65><span class=linenos data-linenos="65 "></span></a>      <span class=n>decrementPendingCallbacks</span><span class=p>();</span>
<a id=__codelineno-34-66 name=__codelineno-34-66></a><a href=#__codelineno-34-66><span class=linenos data-linenos="66 "></span></a>    <span class=p>}</span>
<a id=__codelineno-34-67 name=__codelineno-34-67></a><a href=#__codelineno-34-67><span class=linenos data-linenos="67 "></span></a>  <span class=p>}</span>
<a id=__codelineno-34-68 name=__codelineno-34-68></a><a href=#__codelineno-34-68><span class=linenos data-linenos="68 "></span></a><span class=p>}</span>
</code></pre></div> <p>engineResourceçš„å¼•ç”¨è®¡æ•°ä¼šåœ¨<code>RequestManager.onDestory</code>æ–¹æ³•ä¸­ç»è¿‡<code>clear</code>ã€<code>untrackOrDelegate</code>ã€<code>untrack</code>ã€<code>RequestTracker.clearRemoveAndRecycle</code>ã€<code>clearRemoveAndMaybeRecycle</code>æ–¹æ³•ï¼Œè°ƒç”¨<code>SingleRequest.clear()</code>æ–¹æ³•ç»è¿‡<code>releaseResource()</code>ã€<code>Engine.release</code>ï¼Œè¿›è¡Œé‡Šæ”¾ã€‚è¿™æ ·å¼•ç”¨è®¡æ•°å°±ä¸º0äº†ã€‚</p> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>Tips: å¯ä»¥åœ¨æ‰“æ–­ç‚¹çš„æ—¶å€™åœ¨<code>Evaluate Expression</code>åŠŸèƒ½ä¸­è°ƒç”¨<code>Log.x(String, String, Throwable)</code>æ–¹æ³•æ‰“å°å‡ºè°ƒç”¨æ ˆ</p> </div> <p>å‰é¢åœ¨çœ‹<code>EngineResource</code>çš„ä»£ç æ—¶æˆ‘ä»¬çŸ¥é“ï¼Œä¸€æ—¦å¼•ç”¨è®¡æ•°ä¸º0ï¼Œå°±ä¼šé€šçŸ¥<code>Engine</code>å°†æ­¤èµ„æºä»activeçŠ¶æ€å˜æˆmemory cacheçŠ¶æ€ã€‚å¦‚æœæˆ‘ä»¬å†æ¬¡åŠ è½½èµ„æºæ—¶å¯ä»¥ä»memory cacheä¸­åŠ è½½ï¼Œé‚£ä¹ˆèµ„æºåˆä¼šä»memory cacheçŠ¶æ€å˜æˆactiveçŠ¶æ€ã€‚</p> <p>ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨èµ„æºç¬¬ä¸€æ¬¡æ˜¾ç¤ºåï¼Œæˆ‘ä»¬å…³é—­é¡µé¢ï¼Œèµ„æºä¼šç”±activeå˜æˆmemory cacheï¼›ç„¶åæˆ‘ä»¬å†æ¬¡è¿›å…¥é¡µé¢ï¼ŒåŠ è½½æ—¶ä¼šå‘½ä¸­memory cacheï¼Œä»è€Œåˆå˜æˆactiveçŠ¶æ€ã€‚</p> <p>æœ¬ç« Glideç¼“å­˜æœºåˆ¶çš„æºç å†…å®¹åˆ°æ­¤ä¸ºæ­¢äº†ï¼Œç°åœ¨çœ‹çœ‹æ–‡ç« æœ€å¼€å§‹çš„æµç¨‹å›¾ï¼Œæ˜¯ä¸æ˜¯æœ‰ä¸€ç‚¹ç‚¹ç†Ÿæ‚‰çš„å‘³é“ã€‚</p> <p>æœ€åï¼Œæ‘˜æŠ„ä¸€ä¸‹Glideå®˜æ–¹æ–‡æ¡£å¯¹äºç¼“å­˜æ›´æ–°çš„è¯´æ˜ï¼š</p> <blockquote> <p>Because disk cache are hashed keys, there is no good way to simply delete all of the cached files on disk that correspond to a particular url or file path. The problem would be simpler if you were only ever allowed to load or cache the original image, but since Glide also caches thumbnails and provides various transformations, each of which will result in a new File in the cache, tracking down and deleting every cached version of an image is difficult. </p> <p>In practice, the best way to invalidate a cache file is to change your identifier when the content changes (url, uri, file path etc) when possible. </p> <p>Since itâ€™s often difficult or impossible to change identifiers, Glide also offers the <code>signature()</code> API to mix in additional data that you control into your cache key. Signatures work well for media store content, as well as any content you can maintain some versioning metadata for.<br> - Media store content - For media store content, you can use Glideâ€™s <code>MediaStoreSignature</code> class as your signature. MediaStoreSignature allows you to mix the date modified time, mime type, and orientation of a media store item into the cache key. These three attributes reliably catch edits and updates allowing you to cache media store thumbs. - Files - You can use <code>ObjectKey</code> to mix in the Fileâ€™s date modified time. - Urls - Although the best way to invalidate urls is to make sure the server changes the url and updates the client when the content at the url changes, you can also use <code>ObjectKey</code> to mix in arbitrary metadata (such as a version number) instead. </p> <p>If all else fails and you can neither change your identifier nor keep track of any reasonable version metadata, you can also disable disk caching entirely using <code>diskCacheStrategy()</code> and <code>DiskCacheStrategy.NONE</code>.<br> <cite><a href=http://bumptech.github.io/glide/doc/caching.html#cache-invalidation>Cache Invalidation</a></cite></p> </blockquote> <hr> <div class=md-source-file> <small> Last update: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">February 14, 2022</span> </small> </div> <!-- Giscus --> <h2 id=__comments>Comments</h2> <script src=https://giscus.app/client.js data-repo=wzasd/wzasd.github.io data-repo-id="MDEwOlJlcG9zaXRvcnk2NTQ0MDY0OA==" data-category=General data-category-id=DIC_kwDOA-aLiM4CA5Qt data-mapping=pathname data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=dark data-lang=zh-CN crossorigin=anonymous async>
</script> <!-- Replace with generated snippet --> <!-- Reload on palette change --> <script>
    var palette = __md_get("__palette")
    if (palette && typeof palette.color === "object")
      if (palette.color.scheme === "slate") {
        var giscus = document.querySelector("script[src*=giscus]")
        giscus.setAttribute("data-theme", "dark") // (1)!
      }

    /* Register event handlers after documented loaded */
    document.addEventListener("DOMContentLoaded", function() {
      var ref = document.querySelector("[data-md-component=palette]")
      ref.addEventListener("change", function() {
        var palette = __md_get("__palette")
        if (palette && typeof palette.color === "object") {
          var theme = palette.color.scheme === "slate" ? "dark" : "light"

          /* Instruct Giscus to change theme */
          var frame = document.querySelector(".giscus-frame")
          frame.contentWindow.postMessage(
            { giscus: { setConfig: { theme } } },
            "https://giscus.app"
          )
        }
      })
    })
  </script> <span id=busuanzi_container_site_uv>æœ¬ç«™è®¿å®¢æ•°<span id=busuanzi_value_site_uv></span>äººæ¬¡</span> </article> </div> </div> <a href=# class="md-top md-icon" data-md-component=top data-md-state=hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"/></svg> Back to top </a> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../glide2/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Glide v4 æºç è§£æï¼ˆäºŒï¼‰" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> Glide v4 æºç è§£æï¼ˆäºŒï¼‰ </div> </div> </a> <a href=../glide4/ class="md-footer__link md-footer__link--next" aria-label="Next: Glide v4 æºç è§£æï¼ˆå››ï¼‰" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Next </span> Glide v4 æºç è§£æï¼ˆå››ï¼‰ </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2015 - 2021 wzasd </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/wzasd target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33.85 0 1.71.11 2.5.33 1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2z"/></svg> </a> <a href=jeffrey@outlook.com target=_blank rel=noopener title class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m20 8-8 5-8-5V6l8 5 8-5m0-2H4c-1.11 0-2 .89-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../../..", "features": ["navigation.instant", "navigation.tracking", "navigation.tabs", "navigation.indexes", "navigation.top", "toc.integrate", "search.suggest", "search.highlight"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../../assets/javascripts/workers/search.092fa1f6.min.js"}</script> <script src=../../../assets/javascripts/bundle.5a9542cf.min.js></script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script> <script src=../../../assets/js/busuanzi.pure.mini.js></script> </body> </html>